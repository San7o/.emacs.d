;; -*- coding: utf-8-emacs; -*-
(setq nnrss-group-data '((60 (26634 38675 784145 785000) "https://blogsystem5.substack.com/p/netbsd-build-system" "Revisiting the NetBSD build system" "Julio Merino" "Sat, 28 Dec 2024 08:01:16 +0000" "<p>I recently picked up an embedded project in which I needed to build a highly customized full system image with minimal boot times. As I explored my options, I came to the conclusion that NetBSD, the often-forgotten BSD variant, was the best viable choice for my project.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":403124,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>One reason for this choice is NetBSD’s build system. Once you look and get past the fact that it feels frozen in time since 2002, you realize it is still one of the most advanced build systems you can find for an OS. And it shows: the NetBSD build system allows you to build the full OS from scratch, on pretty much any host POSIX platform, while targeting any hardware architecture supported by NetBSD. All without root privileges.</p><p>Another reason for this choice is that NetBSD was my daily workhorse for many years and I’m quite familiar with its internals, which is useful knowledge to quickly achieve the goals I have in mind. In fact, I was a NetBSD Developer with capital D: I had commit access to the project from about 2002 through 2012 or so, and I have just revived my account in service of this project. <code>jmmv@</code> is back!</p><p>So, strap onto your seats and let’s see how today’s NetBSD build system looks like and what makes it special. I’ll add my own critique at the end, because it ain’t perfect, but overall it continues to deliver on its design goals set in the late 1990s.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The basics</strong></h1><p>The NetBSD build system is powerful and featureful, but it’s also arcane as it’s based on a combination of the BSD variant of make and shell scripts. Just peek through the files under <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/src/share/mk\">src/share/mk/</a>, the directory that contains the bulk of the infrastructure, to see what I mean.</p><p>As a user of the build system, however, you rarely interact with make directly. Instead, you use the <code>build.sh</code> script located at the top of the source tree. This script provides a user-friendly interface to most operations you may want to do, and abstracts away the intricacies of the targets that coordinate the build of the system and the configuration that controls it.</p><p>The structure of the command is to pass high-level “goals” to <code>build.sh</code> as arguments, which indicate the operations to perform. In its most simple form, all you need to do to build a full system distribution targeting the architecture of the host is:</p><pre><code><code>./build.sh tools release</code></code></pre><p>But hey, I promised you can trivially cross-build too, right? Sure, let’s compile the system for a Raspberry Pi with a 64-bit chip, produce the USB image that we can write to an SD card, and do everything as an unprivileged user:</p><pre><code><code>./build.sh -U -a aarch64 -m evbarm tools release disk-image</code></code></pre><p>That’s it, really. That’s all it takes.</p><p>We must dig deeper though, so let’s look at some of those “goals” to see what <code>tools</code> means and understand how a release is put together without root privileges.</p><h1><strong>The toolchain</strong></h1><p>The very first step of any <code>build.sh</code> invocation is to generate the toolchain used to build the rest of the system. This is true of any build, including those that target the host machine, because this ensures that the build is independent of the host’s state. In particular, this avoids the situation where you might have to upgrade certain components before building, which was/is common in other BSDs.</p><p>And you have seen this prerequisite step in the previous section, by the way: all sample <code>build.sh</code> invocations I showed you included <code>tools</code> as the first goal. Now, you don’t <em>have</em> to provide <code>tools</code> to <em>every</em> invocation of the script: as soon as you have built a toolchain, you can reuse it in subsequent invocations.</p><p>Building a toolchain with <code>build.sh</code> is incredibly handy on its own, as you can produce cross-build toolchains and use them for other purposes outside of building NetBSD itself. Zig’s build system has often been praised for this reason, but NetBSD’s has nothing to envy. For example, if we do this:</p><pre><code><code>./build.sh -a aarch64 -m evbarm -T ~/tools tools</code></code></pre><p>We end up with a cross-build C and C++ toolchain under <code>~/tools/</code> that targets NetBSD running on ARM 64 bits. And what goes into the toolchain, you ask?</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":95814,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Directory listing of tools as produced by the command above and its bin subdirectory.</figcaption></figure></div><p>In this listing, you can see a bunch of binaries prefixed with <code>aarch64--netbsd-</code>. These are all part of the C and C++ toolchain. The rest of the tools, prefixed with <code>nb</code>, are NetBSD-specific tools required during the build. These are programs that are part of a normal NetBSD installation and would be available without the <code>nb</code> prefix if we were building on a NetBSD host, but remember, the build system supports <em>any</em> POSIX host OS. Take <code>nbsed</code> as an example: yes, all POSIX hosts provide a <code>sed</code> tool, but its syntax varies among systems so the NetBSD build system isolates itself from those differences by compiling <code>sed</code> as a host tool and using that throughout.</p><p>One special tool from this listing is <code>nbmake-evbarm</code>. This is not the binary for make (which is itself stored as <code>nbmake</code>). This is a shell script that captures all settings provided to <code>build.sh</code> and then invokes <code>nbmake</code> with those, and this script is useful when you want to manually rebuild portions of the tree. Not something you would want to use as an “end user” of the build, but something you definitely will want to use as a NetBSD developer.</p><h1><strong>Build structure</strong></h1><p>Let’s explore the source tree a bit, which is the prime example of a monorepo in an open source project:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":77279,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Directory listing of the source tree, its bin and bin/ls subdirectories, and the content of bin/ls/Makefile.</figcaption></figure></div><p>In this picture, you can see first the content of the top-level directory of the source tree. It all looks pretty simple: there are various subdirectories, such as <code>bin</code>, <code>lib</code>, or <code>usr.bin</code>, that roughly track the structure of the installed system; there is the <code>build.sh</code> script that I previously described; and there is a <code>Makefile</code> as well. Looking into one subdirectory, like <code>bin</code>, we see another <code>Makefile</code> and many more subdirectories, one per tool installed onto <code>/bin/</code>.</p><p>Knowing this directory-based structure, we can use the <code>nbmake-evbarm</code> wrapper script I mentioned earlier to operate on just a portion of the monorepo. Focusing on the <code>ls</code> example shown in the screenshot, we could build and upgrade this piece of the system on its own by doing:</p><pre><code><code>$ cd ~/src/bin/ls
$ ~/tools/bin/nbmake-evbarm all
... console noise ...
$ sudo ~/tools/bin/nbmake-evbarm install
... console noise ...
$ █</code></code></pre><p>Another extra detail to highlight from the screenshot is that NetBSD’s <code>Makefile</code>s are mostly declarative. Each <code>Makefile</code> defines a bunch of variables to specify what is being built and, at the end, includes one of the many <code>bsd.*.mk</code> files that pull in the build logic. Among these, we have <code>bsd.prog.mk</code> to build one program, <code>bsd.lib.mk</code> to build one static/shared library, and <code>bsd.subdir.mk</code> to recurse into subdirectories. Importantly, the general design is to build just <em>one</em> item per directory—although I myself broke this rule when I added <code>bsd.tests.mk</code> to build tests because splitting them into subdirectories would have added too much noise to the tree.</p><p>This declarative design is interesting because it maps well to the foundations of modern build systems like Bazel. In fact, the design of the NetBSD build system is what fueled my interest in build systems, influenced the design of <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my own Buildtool</a>, and made me like <s>Bazel</s> Blaze as soon as I first saw it in 2008.</p><h1><strong>The destdir</strong></h1><p>In order to produce the structure of the final installation, the build system uses the “destdir” concept. A destdir is a staging location where built files are installed, but paths to this staging location are <em>not</em> used within the artifacts produced by the build. This idea <a href=\"https://www.gnu.org/software/automake/manual/html_node/DESTDIR.html\">exists in other build systems such as GNU Automake</a> and is pretty much a necessity to build multiple pieces of software together before installing them or to package software without root privileges.</p><p>Imagine that you want to build a library, say <code>libm</code> (the math library), and a tool that uses it, say <code>bc</code> (the calculator). <code>libm</code> typically goes into <code>/lib/</code> so we cannot just build and install it in place: for one, we may “break” the existing system if the new version happens to be backwards-incompatible; for another, we may be targeting a different architecture so we cannot just replace <code>/lib/libm.so</code> with an incompatible version.</p><p>The destdir comes to the rescue. We first build <code>libm</code> as if it would be installed into <code>/lib/</code>. However, during <em>installation</em>, we prefix all file copy operations with the destdir. In this way, we build a separate “system root”, say <code>/tmp/destdir/lib/</code>, that contains the newly-built <code>libm.so</code>. After that, we build <code>bc</code> and point it to the <code>libm</code> that’s in <code>/tmp/destdir/lib/</code>, but… we have a problem: we can’t allow the <code>/tmp/destdir/</code> path to appear anywhere inside the <code>bc</code> binary because this directory is transient. To fix this, we must separate build paths from runtime paths during the build: when we build <code>bc</code>, we tell the linker to look for libraries under <code>/tmp/destdir/lib/</code> via the <code>-L</code> flag, and we also tell the linker that, at <em>runtime</em>, libraries will be available in <code>/lib/</code> via the <code>--rpath</code> flag (which stands for runtime path).</p><p>As you can imagine, the NetBSD build system heavily relies on this idea and, after a <code>distribution</code> build (implied by the <code>release</code> goal I showed earlier):</p><pre><code><code>./build.sh -D /tmp/testdir/ distribution</code></code></pre><p>we end up with a destdir that contains all system files laid out exactly as they need to be installed.</p><p>In fact, if you run the build as root and target the host system (where the host is NetBSD), the destdir can serve as the target of a chroot. So, if you do:</p><pre><code><code>chroot /tmp/destdir</code></code></pre><p>you essentially can enter the freshly-built system. This may or may not work, however: the newly-built binaries might require new kernel features, which is likely true if you are building a more modern NetBSD release from an older release or if you are tracking NetBSD-current. And this obviously won’t work if you are cross-building.</p><h1><strong>Distribution media</strong></h1><p>The destdir serves as a staging area but it does not represent the final artifacts of the build. To put the destdir to use, we either have to “copy” the staging area onto the host to perform an in-place upgrade, or we need to build distribution media.</p><p>The former case of an in-place upgrade is tricky because it requires issuing manual post-installation steps, so I’m not going to describe it here. But the latter case of producing distribution media is trivial. For example, we can do:</p><pre><code><code>./build.sh release</code></code></pre><p>to produce the release “sets” for the system from the contents of the destdir, or we can do:</p><pre><code><code>./build.sh iso-image install-image live-image</code></code></pre><p>to create various types of installation media (a bootable CD, a bootable USB image, a live system image…) from the contents of the destdir as well.</p><p>The release sets are an interesting thing to discuss because they form the core of a NetBSD distribution. You see: NetBSD ships as a collection of tarballs, and installing NetBSD amounts to simply unpacking those tarballs onto a file system and performing a few post-installation configuration steps.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" width=\"833\" height=\"730\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":730,\"width\":833,\"resizeWidth\":null,\"bytes\":139363,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Content of the binary/sets directory of the NetBSD/amd64 distribution.</figcaption></figure></div><p>Now, the way these tarballs are produced from the destdir is by leveraging <code>mtree</code>, a really cool tool that is not known in Linux land. The purpose of this tool is to compare a textual “golden” representation of a directory against the actual contents of the directory, and highlight where they might differ.</p><p>BSD systems use <code>mtree</code> to describe how the installed system looks like and, as you can imagine, NetBSD is no exception. The NetBSD build system uses <code>mtree</code> files to ensure the destdir contents match expectations, and also uses the <code>mtree</code> “manifests” to “bucketize” the files from the destdir into the individual release sets. You can find these golden manifests in the <code>src/distrib/sets/lists/</code> directory.</p><h1><strong>Unprivileged builds</strong></h1><p>These <code>mtree</code> files are also critical for another very important feature: namely, the ability to build the whole NetBSD system as an unprivileged user. This, to me, is one of the most impressive features of this build system: you can produce the full build, including disk images, without ever running <code>sudo</code> or using weird intercept tools like Debian’s <code>fakeroot</code>.</p><p>Here is how this works. When building in unprivileged mode (enabled via the <code>-U</code> flag to <code>build.sh</code>), the build system produces a <code>METALOG</code> file under the destdir. This file looks like this:</p><pre><code><code>$ grep '^\\./sbin' ~/destdir/METALOG | head -n 5
./sbin type=dir uname=root gname=wheel mode=0755
./sbin/amrctl type=file uname=root gname=wheel mode=0555 size=72120 time=1735119460.0 sha256=d6f474441dc98648a4e8ec633dd76fc3349c85a0af9830ce8eb6566e94291fdb
./sbin/apmlabel type=file uname=root gname=wheel mode=0555 size=72360 time=1735119460.0 sha256=731cf433328bd14c6d3f322ef60fa92eb9eaa2725baa0cb52253b50743d9d324
./sbin/atactl type=file uname=root gname=wheel mode=0555 size=73512 time=1735119461.0 sha256=74a15335c8715513ac50f615a8e906319df79f76dad601bc688ae214b3e41673
./sbin/badsect type=file uname=root gname=wheel mode=0555 size=72328 time=1735119461.0 sha256=76e34649bf100fe490befb2a4ec58455a7710a665dd59bcbbd8c672a6086bde8
$ █</code></code></pre><p>Every line of this file maps a file system entry (a directory, a file, a device…) stored in the destdir to its properties, including ownership information and permissions. These entries are generated from metadata encoded in the <code>Makefile</code>s whenever the build system places a new file under the destdir via the <code>install</code> command (another nice tool often unknown to Linux users). The <code>METALOG</code> is the key that allows building media images without root privileges.</p><p>If you think about it, media images are simply files with an internal structure that represents disk partitions, file systems, and metadata. Because they are simply files, there is no need to have root access nor to make the host’s <code>passwd</code> file contain all users represented by entries in these file systems. Traditionally, OS builds have needed root because it’s easier to leverage the kernel’s virtual devices and file system implementations, but there is not inherent reason for that to be the only choice. All the work can be done in user space, and that’s precisely what NetBSD does.</p><p>Now, go back and revisit the screenshot above that showed the toolchain contents. You’ll notice tools like <code>nbmakefs</code> (the tool to format a file system) and <code>nbgpt</code> (the tool to create a GPT partitioning scheme). These tools are part of the toolchain because they are needed to generate installation media, and these tools know how to read the <code>METALOG</code> in order to embed the right permissions and special file modes into the built images. All without ever becoming root.</p><h1><strong>sysbuild</strong></h1><p>Now, as simple and powerful as <code>build.sh</code> might be, I find it cumbersome for day to day use if you want to customize any of its default settings. It is not uncommon to end up running <code>build.sh</code> with invocations like:</p><pre><code><code>./build.sh -O ../obj -T ../tools -U -u -V MKDEBUG=no -V MKGCC=no distribution</code></code></pre><p>which the official documentation describes as “golden invocations” and I have no desire to type or even remember.</p><p>This is what drove me to <a href=\"https://jmmv.dev/software/sysbuild.html\">write sysbuild</a>: a layer of abstraction over <code>build.sh</code> <em>and</em> <code>cvs</code> that coordinates updating the source tree and building it. The tool even integrates with <code>cron</code> trivially, providing a mechanism to keep NetBSD-current installations up-to-date.</p><p>sysbuild is driven by configuration “profiles” which allow you to customize the paths and settings of a build in just one place and then puts them to use with a trivial command. For example, with a configuration file like the following stored in <code>~/.sysbuild/rpi.conf</code>:</p><pre><code><code>BUILD_ROOT=\"${HOME}/netbsd\"
BUILD_TARGETS=\"tools sets disk-image\"
CVSROOT=:ext:anoncvs@cvs.NetBSD.org:/cvsroot
MACHINES=amd64
RELEASEDIR=\"${BUILD_ROOT}/release\"
SRCDIR=\"${BUILD_ROOT}/src\"
UPDATE_SOURCES=no</code></code></pre><p>We can simply run:</p><pre><code><code>sysbuild -c rpi build</code></code></pre><p>to update the NetBSD source tree to the latest version, ensure that the tools are up-to-date, and produce the USB disk images for a Raspberry Pi.</p><h1><strong>Deficiencies</strong></h1><p>Not everything about the NetBSD build system is rosy though.</p><p><em>The</em> thing that differentiates a good build system from a “meh” one for me personally is the behavior of incremental builds and, in particular, two aspects of these:</p><ul><li><p>First, incremental builds need to do minimal work, especially when there is “nothing to do”. The NetBSD build system is a recursive make one (which comes with its own <a href=\"https://accu.org/journals/overload/14/71/miller_2004/\">set of problems</a>), so it does <em>not</em> do minimal work. On my 72-core machine, it takes about 3 minutes to run through a <code>build.sh release</code> invocation that does nothing. This is OK for end users looking to upgrade their running machine, but it is painful because it makes iterating on system changes difficult. As a developer, you end up needing to know how to surgically rebuild individual subdirectories using the <code>nbmake-<arch></code> wrappers I described earlier, and manually track dependencies across those.</p></li><li><p>Second, incremental builds must <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html\">always deliver correct results</a> <em>without</em> having to do a <code>make clean</code> in between. But that’s generally not true for make-based build systems—and NetBSD’s is no exception. Generally, an incremental build after a <code>git pull</code> (sorry, a <code>cvs update</code>) will work fine, but sometimes it won’t. And if you start playing with build-time switches (things like <code>MKDEBUG</code>), then you are out of luck and must resort to a <code>make clean</code> to “switch configurations”.</p></li></ul><p>And there are other problems. Running a parallel build on a system with many cores sometimes leads to spurious build failures because the interdependencies between components are not always precisely specified (it’s <em>really</em> difficult to be correct with make). And the build is inefficient: of those 3 minutes I mentioned earlier, you can see that <em>most of the time</em> is wasted by make recursing through directories and discovering there is nothing to do, whereas other times, make “chokes” on way too many C++ compiles at once that lead to out of memory situations.</p><p>It has been <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">my dream since the publication of Bazel</a> as open source to have a Bazel-based build of NetBSD. I think Bazel is the perfect build system for such a project because it’d deliver correct and efficient incremental builds to NetBSD’s monorepo, and it would save tons of resources when running on many-core machines. Except for the fact that it’s written in Java, so it’d be a really odd choice for such project. Maybe Buck 2 would be suitable. Anyway, one can only dream…</p><h1><strong>But why?</strong></h1><p>Why I’m looking at this at all again, after years of not touching NetBSD? I said it in the opening: I’m working on a new embedded project for which NetBSD is the greatest fit. I could tell you what it is about but it’s easier to just show you:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"091ac30d-6b0b-46d9-af1b-df099485a01b\",\"duration\":null}\"></div><p>OK, fine, in words: I am building a minimal system that boots straight into EndBASIC with quick build times and low overhead. You’ll have to wait a bit more to get your hands on this though, as I’m still ironing out various details and want to end up providing a pre-built “box” with the right hardware and software combination.</p><p>I’m also becoming <em>super</em> tempted to migrate NetBSD’s build to Bazel to make my own life easier in this journey. This is a monumental task… but I’m not sure that it’d be crazy to tackle the minimum subset of NetBSD that I need for this minimal disk image and port only those portions to Bazel. The results might impress some and then want to help the effort. Right?</p><p>In the meantime, I encourage you to read through the comprehensive <a href=\"https://www.netbsd.org/docs/guide/en/part-compile.html\">Building the system</a> portion of <a href=\"https://www.netbsd.org/docs/guide/en/index.html\">The NetBSD guide</a>, and to play with building a NetBSD image straight from your Linux machine. You may like it.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "0.0" "image/jpeg") nil "fd6fc8783cdd672c383fe6364714498f") (59 (26634 38675 781521 38000) "https://blogsystem5.substack.com/p/synology-ds923-vs-freebsd" "Synology DS923+ vs. FreeBSD w/ZFS" "Julio Merino" "Fri, 13 Dec 2024 17:10:52 +0000" "<p>My interest in storage is longstanding—I loved playing with different file systems in my early Unix days and then I worked on Google’s and Microsoft’s distributed storage solutions—and, about four years ago, I started running a home-grown NAS leveraging FreeBSD and its excellent ZFS support. I first hosted the server on a PowerMac G5 and then upgraded it to an overkill 72-core ThinkStation that I snapped second-hand for a great price.</p><p>But as stable and low maintenance as FreeBSD is, running day-to-day services myself is not my idea of “fun”. This drove me to replace this machine’s routing functionality with a dedicated pfSense box a year ago and, for similar reasons, I have been curious about dedicated NAS solutions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":251556,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Synology DS923+ on top of its shipping box right after unboxing it.</figcaption></figure></div><p>I was pretty close to buying a second-hand NAS from the work classifieds channel when a Synology marketing person (hi Kyle!) contacted me to offer a partnership: they’d ship me <a href=\"https://sy.to/hekgh\">one of their devices</a> for free in exchange for me publishing a few articles about it. Given my interest to drive-test one of these appliances without committing to buying one (they ain’t cheap and I wasn’t convinced I wanted to get rid of my FreeBSD-based solution), I was game.</p><p>And you guessed right: this article is one of those I promised to write but, before you stop reading, the answer is no. This post is <em>not</em> sponsored by Synology and has not been reviewed nor approved by them. The content here, including any opinions, are purely my own. And what I want do do here is compare how the Synology appliance stacks against my home-built FreeBSD server.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The hardware</strong></h1><p>Here are the two contenders in my comparison:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":329916,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Synology D923+ next to my ThinkStation P710 on top of a dusty LackRack in the garage.</figcaption></figure></div><ul><li><p><strong>My home-built NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3DaBQze\">ThinkStation P710</a> equipped with 2x Intel Xeon E5-2697 v4 processors (18c/36t) at 2.30GHz, 64GB of RAM, 2x <a href=\"https://amzn.to/3ZvimN7\">Seagate 4TB Enterprise Capacity 7200 RPM</a> drives and a <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB.</p></li><li><p><strong>Operating system:</strong> FreeBSD 14.</p></li><li><p><strong>Storage configuration:</strong> ZFS with the two HDD drives in mirror mode and with the SSD set up as the L2ARC plus ZIL log for the drive pool.</p></li></ul></li><li><p><strong>The Synology NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3ZL7sUI\">Synology DS923+</a> equipped with 3x <a href=\"https://amzn.to/4g73s6S\">Synology Plus Series 4TB 5400 RPM</a> drives and the same <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB that I moved from one machine to the other. The box is equipped with a 4-core AMD Ryzen Embedded R1600 and 4GB of RAM.</p></li><li><p><strong>Operating system:</strong> Synology’s own DiskStation Manager (DSM).</p></li><li><p><strong>Storage configuration:</strong> btrfs with the three HDD drives set up in RAID 5 mode and with the SSD set up to act as the cache for the drive pool.</p></li></ul></li></ul><p>The two configurations are quite different—after all, I am comparing a workstation machine with lots of spare CPU and RAM to a dedicated machine specifically crafted for file sharing—so it’s going to be difficult to be “fair” in any comparison. In any case, here are a few things to contrast:</p><ul><li><p><strong>IOPS:</strong> The P710 runs with 2 7200 RPM drives in mirror mode whereas the DS923+ runs with 3 5400 RPM drives in RAID 5 mode. The number of total IOPS from each is going to differ but… for all purposes, the 1Gbit NIC that each machine has is the limiting factor in performance so I haven’t bothered to run any performance tests. Both can saturate the network, so there is that.</p></li><li><p><strong>Quality:</strong> Both the P710 and the DS923+ are impressive machines—maybe not PowerMac G5 impressive levels, but pretty, pretty close. I love the ThinkStation’s outer design and the interior shows great cable management and airflow. As for the NAS, I love the lightweight and small form factor that allows placing it pretty much anywhere. Both are tool-less enclosures.</p></li><li><p><strong>Noise:</strong> When idle, both machines are equally quiet. The ThinkStation gets really, really loud under heavy load though, and it is also uncomfortably loud even at idle when the room temperature is warm (around or over 25C). The DS923+, however, seems quiet throughout. The Synology Plus Series HDDs are also quieter than the ones I had in the ThinkStation, and that’s partly because they are slower 5400 RPM drives. In any case, these two machines stay in my garage so I don’t care about their noise.</p></li><li><p><strong>Power consumption:</strong> I unfortunately do not own a tool to measure it, but it’d be neat to compare how these two stack up. I’m sure I’ve thrown money away by keeping the ThinkStation online 24x7 and having those drives never rest (ZFS doesn’t let them spin down) but it’s hard to care about it because my power bill is dominated by heating almost year-round.</p></li></ul><h1><strong>FreeBSD and ZFS</strong></h1><p>FreeBSD is my current favorite system for servers. FreeBSD remains close to its Unix roots and maintains rational and orthogonal tooling (unlike Linux), is quick and trivial to maintain (I could run through the 13 to 14 upgrade in… 15 minutes?), and bundles modern technology like ZFS and bhyve (unlike NetBSD, sadly, which used to be my BSD of choice).</p><p>It is true that FreeBSD gave me some headaches when I ran it on the PowerMac G5, but that’s expected due to the machine being 20 years old and <a href=\"https://www.freebsd.org/platforms/ppc/\">FreeBSD’s PowerPC support</a> being a Tier 2 platform. The thing is that I never intended to run a NAS on the G5; it just so happened to be the only machine I had available for it. In any case, I have had <em>zero</em> problems on the ThinkStation. Mind you: when I bought this machine, both Windows and Fedora experienced occasional freezes with their default installations (before pulling upgrades from the network) and FreeBSD never has shown any signs of instability.</p><p>As for ZFS, it is hard to convey the feeling of “power” you experience when you type <code>zpool</code> and <code>zfs</code> commands and see the machine coordinate multiple disks to offer you a dependable storage solution. Creating file systems on a pool, creating raw volumes for VMs or iSCSI targets, taking snapshots, replicating snapshots over the network or to backup USB drives, scrubbing the drives to verify data integrity… all are trivial commands away.</p><p>ZFS feels slow though. I grew up thinking of file systems as contiguous portions of a disk and tinkering with their partitioning scheme to keep groups of data unfragmented for speedy access. Due to the way ZFS operates, however, none of this archaic knowledge applies (and to be honest, I do not know how ZFS works in detail internally). That said, a hard drive’s seek time is around 10ms and has been like that for decades, which combined with the fact that we are now spoiled by having SSDs everywhere, exacerbates how slow an HDD-based solution feels no matter the file system.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" width=\"1440\" height=\"800\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":800,\"width\":1440,\"resizeWidth\":null,\"bytes\":45551,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Did I just mention disk fragmentation? Yeah I did, and I could not resist including this screenshot of MS-DOS 6.22's DEFRAG.EXE here. Just because.</figcaption></figure></div><p>Regarding network connectivity, FreeBSD offers all sorts of networked file systems and services. The base system provides NFSv3, NFSv4, FTP, and iSCSI targets. The ports (packages) system offers whatever else you may need, including SMB, DLNA, and even ancient protocols like AppleTalk or distributed protocols like Ceph. All configuration is done by hand over SSH in the traditional Unix way of editing configuration files—aka messing around with different, inconsistent text formats.</p><h1><strong>Synology’s DSM and btrfs</strong></h1><p>The DS923+ runs Synology’s own operating system: the <a href=\"https://www.synology.com/en-us/dsm\">DiskStation Manager (DSM)</a>. The DSM is a headless-first system designed to be accessed over the network, which is no surprise. What <em>is</em> surprising is the choice of the interface: while most networked devices offer some sort of a web-based tabbed UI, the DSM offers a desktop environment—with overlapping windows no less. This feels like a gimmick to me, and a quite neat one, but overkill nonetheless.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":384169,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The DSM desktop with the Control Panel and the File Station apps open to demonstrate the appearance of the web-based windowing system.</figcaption></figure></div><p>If we peek under the covers, which we can do by logging into the machine over SSH, we find that the DSM is a Linux system. No surprises here after seeing that its choice of file system is btrfs. But what kind of Linux is it? A weird one, let me tell you. Luckily, you do not have to interact with it at all if you don’t want to, but hey, I’m curious so I did look.</p><p>The DSM seems to be some sort of Debian derivative based on the fact that <code>dpkg</code> is installed, but otherwise I cannot find any other obvious remains of what might have been a Debian installation; even <code>dpkg -l</code> shows nothing. What I can tell is that the btrfs file systems are mounted under <code>/volume1</code> and, in there, we can find one directory per shared folder that we create in the UI. We can also find various directories prefixed with <code>@</code>, which is a… weird choice for Unix file names, and I understand are managed by the DSM. These include things like <code>@appdata</code> or <code>@userpreference</code>, which carry strong Windows vibes.</p><p>Considering that the DS923+ is almost a PC and runs Linux, I did look to see if it was possible to run FreeBSD instead. It turns out some people have tried this, and FreeBSD does run, but it lacks drivers to control power to the drives so it cannot actually leverage the storage devices. From what I understood, the DS923+ seems to have dedicated hardware to control power the drive pool, and this hardware logic is controlled via GPIO.</p><p>Which got me even more curious: if the DSM explicitly controls power to the drive pool, how does it boot and how does it remain responsive even after shutting down the drives? I guessed that the device comes with a tiny drive to hold the DSM and boots off of it, and upon inspecting the <code>dmesg</code> and looking for non-obvious stuff, I found this:</p><pre><code><code>sd 7:0:0:0: Attached scsi generic sg3 type 0
sd 7:0:0:0: [synoboot] 245760 512-byte logical blocks: (126 MB/120 MiB)
sd 7:0:0:0: [synoboot] Write Protect is off
sd 7:0:0:0: [synoboot] Mode Sense: 23 00 00 00
sd 7:0:0:0: [synoboot] No Caching mode page found
sd 7:0:0:0: [synoboot] Assuming drive cache: write through
sd 7:0:0:0: [synoboot] Attached SCSI disk</code></code></pre><p>Ah-ha. A small 120MB (flash?) drive that acts as the system device. However… this separation of system vs. drive pool comes with a price: the drive pool often shuts off, and powering it back on is <em>slow</em> (10–15 seconds are not unusual). When you try to reach the NAS over the network and the pool is off, it can feel as if the NAS is unreachable / down, which has already confused me a few times and caused me to started diagnosing network issues. Quite annoying to be honest, but obviously this can be configured in the <em>Hardware & Power</em> menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":413086,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The list of available options under the Hardware & Power menu.</figcaption></figure></div><p>Regarding network connectivity, the DSM offers multiple networked file systems and services out of the box, namely: SMB, NFS v3, NFS v4, AFP, FTP, and rsync. I’m actually surprised to see AFP, AppleTalk’s “replacement”, in the default set of supported file systems in this day and age, but there it is. Additionally, the DSM provides its own package management system to install a limited set of additional services and utilities, which I used to add DLNA support.</p><h1><strong>Seeding the NAS</strong></h1><p>Anyhow, let’s change topics and talk about the DS923+ itself.</p><p>The first thing I had to do after getting the device was to seed it with data. I needed to copy about 1TB of photos and documents from the FreeBSD machine to the DS923+, which is not a lot, but is large enough that different copy mechanisms can make a huge difference in the time the copy takes. In particular, the choice of <em>protocol</em> matters for a quick copy: both SMB and NFS are OK with large files, but transferring many small files with them is painful. Fortunately, the DSM allows rsync over SSH and I used that to do the initial seeding.</p><p>Now, using rsync came with two “problems”. The first is that I had to know the <em>path</em> to the shared folders in the file system to specify the rsync targets. This is not clearly exposed through the UI, so I had to rely on SSH to log into the machine and figure out that the shared folders are at <code>/volume1/<shared_folder>/</code> as I briefly mentioned in the previous section.</p><p>Which led to the second problem or, rather, surprise: even though I had set up 2FA for the user accounts I created in the DSM UI, 2FA was meaningless when accessing the machine over SSH. I understand why that may be, but then I question what the point of enabling 2FA really is if one can gain access to the machine without it. The same is true of SMB by the way: you just need an account’s password, not the 2FA. So, unless you disable all networked file systems and only allow web access to the NAS, all the 2FA does is give you a false sense of security.</p><h1><strong>Peace of mind</strong></h1><p>When comparing my custom FreeBSD server to the newer DS923+, the main difference I can notice is an increase in “peace of mind”. Yes, FreeBSD is very stable and ZFS is great… but I wasn’t running the ThinkStation as a dedicated NAS: I was mixing the machine’s NAS responsibilities with those of a host for development tasks. I always felt uncomfortable about the health of the system and I wasn’t convinced that my maintenance was “good enough” to safeguard my data.</p><p>As you can imagine, being uncomfortable about your data is not something you want to feel: trust is <em>The Thing</em> you most want in a storage solution, and there are a few things that stand out during the setup of the system that gave me warm feelings on this topic.</p><p>The first and obvious one is that the DSM offers to encrypt the pool right from the beginning, which is something you should always do in this day and age: encryption is cheap in CPU terms, the data you own is precious, and the devices that store it tend to be small and light so they are at risk of theft. But beware: the key is stored on the device to allow auto-mounting by default, which means a knowledgeable thief could still gain access. Thus, this level of encryption is only useful to facilitate the disposal of drives. That said, you can configure additional encryption on each shared folder if you want per-user password-protected encryption.</p><p>The second thing is that, nowhere in the setup process I was asked to create a Synology account for the NAS to be fully functional. You might think that this is a given, but seeing the state of other hardware or software products these days… it’s not. So this sent a very welcome message. I ended up needing to create an account for certain features that required it, but these were completely optional.</p><p>The third thing, which is actually one of those features that required creating a Synology account, is the ability to send email notifications for system alerts. Email-based alerts are terrible in large organizations (and of course the DSM offers better alternatives, like ActiveInsight), but for my personal use case, emails are perfect and make a huge difference with my previous FreeBSD setup. I can rest assured that I’ll be told about anything unusual with the DS932+ in a way that I will notice. With my custom build, I had certain monitoring features in place like weekly disk scrubs and periodic online backups… but no way to properly notify me of problems with either: if anything went wrong, I would not have known on time, and that was very unsettling.</p><p>The fourth and final thing is that the DSM has been built throughout the years by people that deal with storage all the time, and it’s fair to assume that they know a thing or two about running a NAS. I have reasonable confidence that the configuration of the system and the storage pool is going to be “correct” over time, particularly across upgrades, whereas I was never quite sure of it with my manual FreeBSD setup. One such example is with the NFS configuration: setting up the NFSv4 server in the DSM was pretty much knob-free—so <a href=\"https://blogsystem5.substack.com/p/demystifying-secure-nfs\">when things didn’t work with the clients</a>, I could assume that the issue was almost certainly with the clients themselves.</p><h1><strong>Additional apps</strong></h1><p>As I mentioned earlier, the DS923+ is pretty much a PC with Linux in a tiny box, so in principle it can host any kind of software you like. The way this works is via DSM’s own “marketplace” where you can find new services to add to the machine.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":365681,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The DSM desktop showing the Package Center application.</figcaption></figure></div><p>I did add the optional DLNA service so that I could play videos from my Xbox, and also toyed with with the Domain Server (and later gave up due to the sheer complexity of setting up a domain just for home use). But there are other interesting optional features. For example, you can create virtual machines on the DS923+ which, despite the limited CPU and RAM of the machine, can come in handy from time to time. I suppose with a more powerful box from Synology, the story here would be quite different.</p><p>One thing to highlight is that these extra pieces of software are <em>curated</em>: you aren’t just installing an extra service to the underlying Linux machine. You are installing an extension to the DSM, which comes with new configuration panels in the UI and full integration with the system. You never have to know that Linux is there if you don’t want to.</p><h1><strong>Backup solutions</strong></h1><p>Having a dedicated NAS with a storage pool that protects against corruption is great, but a singly-homed box like this is still subject to massive data loss due to ransomware, physical damage caused by fire or flooding, and correlated disk failures. Backups are critically important.</p><p>With the FreeBSD setup, my backup strategy involved using <code>zfs send</code> and <code>zfs receive</code> to back up snapshots into two USB drives: one kept in a fire safe and one kept offsite. This worked but I had to figure out the syntax of these commands over and over again, which didn’t make me feel confident about these actions. I did also back up irreplaceable data to a OneDrive account using <code>rclone</code>, which was good but… manual and ad-hoc as well. Needless to say, while the backups existed, they were often stale and they were a pain to manage.</p><p>Backing up a NAS is difficult though. For one, a NAS is designed to store <em>lots</em> of data, which means the backup targets have to be large capacity-wise too. And for another, given the DS923+ reduced physical size, it is likely to end up placed in a location that isn’t super convenient to access, which will make attaching temporary USB drives and the like an annoying experience.</p><p>For now, what I have tried is the optional <em>Cloud Sync</em> package that allows replicating to many cloud services, including OneDrive. And it’s a joy to use. I could trivially install the package, log into my Microsoft account, and configure the two specific folders I care about backing up. I could even respect the previous file layout of my OneDrive account so I did not have to re-upload anything. And the tool supports encryption too, which you may want if you really don’t like those cloud providers from training their AI systems with your data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":779628,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Sample configuration of cloud syncing to OneDrive.</figcaption></figure></div><p>There is more though. Synology offers a variety of products for remote and physical backup. The one that does interest me the most is <a href=\"https://www.synology.com/en-global/dsm/feature/snapshot_replication\">Snapshot Replication</a>, which provides something similar to what I was doing with <code>zfs send</code> and <code>zfs receive</code>, but unfortunately requires a second Synology system offsite that I don’t have. The other solutions are <a href=\"https://sy.to/hf5yf\">Active Backup for Business</a> and <a href=\"https://sy.to/tntsi\">Hyper Backup</a>, which I still would like to evaluate but haven’t had a chance to look into.</p><h1><strong>Future</strong></h1><p>To conclude this brief review and comparison, let me say that I’m happy with the DS923+ experience so far. I don’t think I <em>need</em> it because my FreeBSD solution worked well enough, but considering that I like to use the ThinkStation as the host for my VMs and as my primary development machine—aka, a fun toy—I feel more at peace with a dedicated appliance that stores my precious data.</p><p>For more details, you can visit Synology’s product pages for the <a href=\"https://sy.to/hekgh\">DS923+</a> and the <a href=\"https://sy.to/drkom\">Plus Series HDDs</a>. And if you want to roll your own FreeBSD-based solution, <a href=\"https://docs.freebsd.org/en/books/handbook/zfs/\">Chapter 22 of the FreeBSD handbook on ZFS</a> is a good place to start.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "0.0" "image/jpeg") nil "8c8afe9f78aed743133f395ffd45daa1") (58 (26634 38675 775857 428000) "https://blogsystem5.substack.com/p/bazelcon-2024-recap" "BazelCon 2024 recap" "Julio Merino" "Tue, 22 Oct 2024 15:01:01 +0000" "<p>Just like that, BazelCon 2024 came and went. And just like that, Blog System/5 is about to turn 1 year old as the very first post of this newsletter was the <a href=\"https://blogsystem5.substack.com/p/bazelcon-2023-et-al-trip-report\">recap of BazelCon 2023</a>. Since then, this newsletter has amassed 1200+ subscribers and I have surpassed <a href=\"https://blogsystem5.substack.com/p/20-years-of-blogging\">20 years of blogging</a>—so, thank you for your support, everyone!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" width=\"1456\" height=\"1048\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1048,\"width\":1456,\"resizeWidth\":null,\"bytes\":362903,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>To celebrate this milestone, it’s obviously time to summarize the two events of last week: BazelCon 2024 and the adjacent Build Meetup. There is <em>A LOT</em> of ground to cover. I could probably write a separate article for each of the sections below, but folks coming for a summary of the conference will want to see everything in one place… so you get this massive piece instead.</p><p>Overall, this is a 40-minute read… but let’s face it: getting 3 days worth of content in less than an hour sounds like a good deal, doesn’t it? Feel free to pick and choose sections though; each stands on its own and each paragraph represents a thought I captured from some presentation or discussion.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">No LLMs were involved in this work, thus you can only imagine how much effort it went into putting this together. So, subscribe to support Blog System/5 and… enjoy!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Schedule and logistics</h1><p>BazelCon 2024 was hosted at the Computer History Museum in Mountain View, CA, on October 14th and 15h. The conference had a <a href=\"https://bazelcon2024.sched.com/\">single track of talks</a> and an overlapping track of BoF sessions. I attended most of the talks but just one BoF—the IDE one. The conference was followed by evening socials hosted by BuildBuddy and JetBrains/EngFlow.</p><p>The Build Meetup followed BazelCon 2024 on October 16th, and this time around it was cohosted by Meta and EngFlow in Menlo Park, CA. The meetup had three tracks: one for Bazel, one for Buck 2, and one for remote execution. I helped facilitate the Bazel track, including taking notes for the afternoon unconference (notes at the very end), and gave a 15-minute talk on Bazel at Snowflake. Facilitating the track was fun, but unfortunately this made me miss the Buck track and I’m still wanting to learn more about it.</p><p>The notes I gathered from the talks and discussions are grouped in the following topics:</p><ul><li><p>Community and adoption</p></li><li><p>Remote Execution</p></li><li><p>IDE support</p></li><li><p>Inner loop development</p></li><li><p>Toolchains</p></li><li><p>Sandboxing</p></li><li><p>Monorepo issues</p></li><li><p>blzmod and external dependencies</p></li><li><p>Secure and auditable builds</p></li><li><p>Symbolic macros</p></li><li><p>Queries</p></li><li><p>Linting</p></li><li><p>Testing</p></li><li><p>Missing tooling around Bazel</p></li><li><p>The end</p></li></ul><h1>Community and adoption</h1><p>The conference opened with the usual briefing and SOTU, which included information on the conference itself and the latest news in the Bazel project. These were followed by talks that touched upon the community and current adoption trends, and these are the thoughts I gathered:</p><ul><li><p><strong>Conference ownership:</strong> This was the first BazelCon <em>not</em> run by Google. The conference is now owned by the Linux Foundation and Google was a sponsor at the same level of BuildBuddy and EngFlow. The Linux Foundation has run the conference excellently thanks to the dedicated team of professionals that they have for the task.</p></li><li><p><strong>Conference history:</strong> Looking back, you should know that the Bazel team was (and still is) distributed across two sites: Google NYC and Google Munich. To mitigate the difficulties that arise from geographical distribution, the team held internal-only summits every 6 months. It wasn’t until 2017 that this internal conference became BazelCon and, after that, the team alternated between an internal event and an external event. Last year, BazelCon had 250 attendees with a waitlist that contained 200 extra folks, and this is the second year that the program committee contains non-Google folks (myself included).</p></li><li><p><strong>Google’s investment in Bazel:</strong> Does this shift to the Linux Foundation change <a href=\"https://bazel.build/contribute/policy\">Bazel’s governance</a> to make it more community-driven? Not yet, but it’s a step in that direction! Google still owns Bazel and continues to invest in it because they can leverage contributions from strong non-Google engineers and because Google maintains a bunch of open-source projects that rely on Bazel. But Google also wants to have a more open community to guarantee that Bazel continues to thrive even if company-internal priorities change.</p></li><li><p><strong>The <a href=\"https://github.com/bazel-contrib\">bazel-contrib organization</a>:</strong> To support these changes, a few folks have created a new GitHub organization and have gotten Google to donate many repos to this new org. The organization creators have a desire to start a new foundation to support and direct these projects and are looking for about 5 companies to join.</p></li><li><p><strong>Bazel adoption stickiness:</strong> The REBELs research group at the <a href=\"https://rebels.cs.uwaterloo.ca/\">Univesity of Waterloo</a> conducted a study over <a href=\"https://is.gd/WorldOfCode/\">35,000 significant GitHub projects</a> to see why, from the 1.5% of projects that adopted Bazel, 11% of those abandoned the migration at roughly the 2-year mark.</p><ul><li><p><strong>Abandonment reasons:</strong> The reasons cited for abandoning Bazel were varied, but can be summarized as encountering technical challenges, issues with team coordination and onboarding, and seeing community trends (like Kubernetes deciding to move off of Bazel).</p></li><li><p><strong>If not Bazel, then what?:</strong> These projects primarily decided to move to language-specific tools, especially for languages with strong native tooling like Go and Swift. However, a significant proportion also decided to move back to “inferior” tools like CMake or even GNU Make. These projects acknowledged that these tools are less feature rich and don’t support integration with other languages, but they are conventional and easier to understand by the community.</p></li><li><p><strong>If Bazel, then why?:</strong> On the plus side, for the cases where Bazel stuck, we can find the reasons we expect: dependency management, faster builds, and even the influence of other projects shine as reasons for making Bazel a good choice.</p></li></ul></li><li><p><strong>Adoption suggestions:</strong> The CTO of Ergatta spoke on how his small company has been able to successfully leverage Bazel without massive investments in infrastructure. His suggestions were to keep things simple (e.g. by using the GCS-backed cache despite its flaws, or by doing the trivial <code>bazel test ...</code> on CI); to expedite solutions even if not perfect (e.g. by wrapping foreign builds in Bazel); to look for champions and leverage them for adoption; to focus on “good enough” results; to write documentation for your successors; and, surprisingly, to do frequent and incremental changes to workflows instead of big-bang “improvements”.</p></li></ul><h1>Remote Execution</h1><p>As you know, remote execution is Bazel’s raison d’etre. Consequently, the SOTU covered various updates on this topic and many talks included related thoughts:</p><ul><li><p><strong>SOTU updates:</strong> The remote output service is now available and bb-clientd offers an implementation. The execution log is now 100x smaller than before and only has a 3% runtime overhead, which is useful to debug cache hits. Upcoming changes include concurrent uploads to the cache in the background without blocking action completion, GCing of local caches (disk cache, install cache, etc.), and BwoB improvements to decrease incremental build times when Skymeld is in use.</p></li><li><p><strong>Remote persistent workers:</strong> AirBnB observed 2x slower builds when not using remote persistent workers. They use dedicated pools for Java and Kotlin and route all actions into these pools, and reminded us that tagging targets comes with pitfalls because targets can spawn multiple actions and just one of them needs the worker.</p></li><li><p><strong>Queuing control:</strong> Remote execution environments typically have different worker pools to support different build environments or to optimize cost. But note: the goal shouldn’t always be to tolerate all possible load all the time: it is reasonable to put limits on the worker pools like AirBnB does so that you can dedicate a pool for interactive builds and prioritize low latency, but also create a separate pool for CI builds where you put hard caps and tolerate queuing.</p></li><li><p><strong>Target size matters:</strong> Dealing with tons of individual small files is costly. In some cases, you may be better off tarring them up and declaring a single input to an action and making the action unpack the tar during execution. This came up during the talk on high performance builds for web monorepos, and I found this interesting because this goes in the opposite direction of tree artifacts which have often been problematic.</p></li><li><p><strong>Action deduplication:</strong> Any remote execution service worth its money can coalesce in-flight actions to save on cost. This shines in CI with builds that have long-running actions, and Canva reports that they see 500k dedups per day on about 3 webpack builds. One consideration is that flaky test passes/failures are amplified by action coalescing: without this feature, flakes will show up as random failures over time, whereas with this feature, failures will be clustered. Extracting a signal around flakiness becomes harder.</p></li><li><p><strong>Determinism checks:</strong> While not necessarily an issue with remote execution, having remote execution exacerbates the problem of non-deterministic actions in a build. Spend the time to set up a CI job to <a href=\"https://www.youtube.com/watch?v=XItY0LmdiFA\">look for non-determinism</a> and alert on it. Specific problems that often arise are timestamps in JARs (<code>rules_antrl</code> is impacted), absolute paths (<code>rules_kotlin</code> is impacted), or diagnostics information (Scala <code>sdeps</code> file is problematic).</p></li><li><p><strong>Postmortems and learnings:</strong> Ulf Adams gave a talk reflecting on four different incidents that EngFlow’s remote execution service suffered. Personally, seeing companies introspect their failures makes <em>me</em> trust them <em>more</em> than not, but YMMV. In any case, I do not necessarily want to go over the incidents per se, but I do want to go over the recommendations:</p><ul><li><p><strong>Avoid RPC cycles and set timeouts:</strong> The call graph between services must not have cycles, which is hard to enforce because these may show up organically over time. Also make sure to have timeouts on all RPCs, although the RE protocol makes this difficult because it has long-running RPCs.</p></li><li><p><strong>Make sure <a href=\"https://grpc.io/docs/guides/flow-control/\">flow control</a> is configured:</strong> This is a feature of gRPC that allows a server to keep memory consumption in check and is achieved by “slowing down” incoming traffic (thus “controlling the flow”). When proxying traffic in a server, special care must be taken to connect the flow control logic of the input and output streams of the proxy. Otherwise, a slow client can have ripple effects through the system and cause OOMs.</p></li><li><p><strong>Auto-scaling is tricky to get right:</strong> From a cost-savings perspective, you want to downsize servers as quickly as possible and increase them slowly. But if you do this and there is queuing, it’s possible that auto-scaling will make queuing worse.</p></li><li><p><strong>Guardrails build trust:</strong> You might say that user-induced problems are not service problems: after all, if, for example, they cause compile actions to time out after 20 minutes, it’s “their fault” for doing the wrong thing. However, if this happens, there obviously is something wrong—and it’d be nice for the service provider to notice and have prevention features in place just like your water provider can detect leaks. (And yet… AWS <em>still</em> doesn’t have a way to put a limit on spend.)</p></li></ul></li></ul><h1>IDE support</h1><p>If you have had to support any developers converting from “legacy” build systems to Bazel, you may have realized that… the IDE features they are used to don’t quite work after the migration. Things have gotten better in the IDE space for Bazel but aren’t great yet. Fortunately, there are a few news that give hope:</p><ul><li><p><strong><a href=\"https://jb.gg/new-bazel-plugin\">New JetBrains plugin for IntelliJ</a>:</strong> Released to the marketplace during the conference, this new plugin provides tighter integration between IntelliJ and Bazel through the BSP abstraction layer. This new plugin can represent the Bazel build graph in the IDE, offers syntax highlighting for <code>bazelrc</code> files (and, feature request: could offer docs on hover), supports inserting breakpoints in Starlark evaluation, implements “fast build” correctly, and optimizes the sync process. There are some gaps compared to the old plugin, but I’m super-excited by what’s coming because the old Google-owned plugin is… underwhelming. See the <a href=\"https://jb.gg/new-bazel-feature\">feature list</a> and the <a href=\"https://jb.gg/new-bazel-roadmap\">roadmap</a> for more details.</p></li><li><p><strong>Build Server Protocol (BSP):</strong> The BSP is a new protocol that aims to achieve the same thing that the Language Server Protocol (LSP) did: namely, solve the M:N problem between IDEs and build systems. The idea is to have an intermediate abstraction for the build system so that M IDEs can talk to N build systems by means of an intermediary process that converts the BSP to build actions. The BSP is still young though and, right now, it’s pretty rigid because it has deep knowledge of the languages it supports. In particular, there is no support for custom rules yet, so get involved if you want to see this happen.</p></li><li><p><strong>Old plugin for JetBrains:</strong> The old plugin will be fully supported until mid-2025 (although I predict they’ll have to backpedal on this and extend this date). This plugin has many shortcomings because it originates from Android Studio and contains assumptions about Android and about Google’s own infrastructure. That said, there is a new feature called “query sync” that optimizes the sync process massively… at the expense of having to manually “enable analyze” for any files where deep IDE integration is desired. The problem is: you <em>have</em> to enable analysis to get insights on generated files, and generated files tend to be everywhere thanks to protobuf, so… you’ll likely find yourself “enabling analyze” all the time. Shrug.</p></li><li><p><strong>Good IDE support is critical:</strong> Having a good IDE experience is crucial for developers, but the irony is that the people that often work on build migrations or the IDE are <em>experts</em> and know how to tolerate imperfect IDE support. This is not the case for most developers, particularly those that must get up to speed… so keep that in mind. Running user interviews, surveys, etc. is a necessity to understand what people truly perceive as problems.</p></li><li><p><strong>Compilation database:</strong> JetBrains is not the only contender in the IDE space. There are many more (wink, wink, Emacs) and BSP will make offering a Bazel experience within them possible. Until that’s ready, though, you may need to manually deal with a “compilation database”, especially if you want to integrate with VSCode. A compilation database is, simply put, a JSON file that contains the commands to compile each and every translation unit in a project. There are various options to generate one of these with Bazel, all with different trade-offs:</p><ul><li><p><strong>Intercept builds:</strong> Use <code>bear</code> as a wrapper to run the full clean build. This works with some build systems, but unfortunately, Bazel’s client/server model doesn’t allow <code>bear</code> to intercept the actions it spawns.</p></li><li><p><strong>Extra actions:</strong> Add a “listener” extra action that listens for <code>CppCompile</code>. This also requires a full clean build and is deprecated by aspects, but is the approach that <code>kythe</code> uses.</p></li><li><p><strong>Action graph query:</strong> Does not require a full build, just a warmed up analysis cache. However, this does not support tree artifacts. Examples: <code>bazel-compile-commands-extractor</code>, <code>bazel-compile-commands</code> (two forks).</p></li><li><p><strong>Aspect:</strong> Does not require a full build, but the generated commands may not be identical to the ones that are actually used. For example: if you have a code generator that produces a tree artifact and then is fed as an input to a <code>cc_library</code>, then the tree artifact is represented as a <code>CppCompileActionTemplate</code> that is only expanded to a specific command line at runtime.</p></li></ul></li><li><p><strong>Non-blocking queries:</strong> The Bazel server has a global lock that prevents it from running more than one command at a time. This is a problem because the IDE needs to issue Bazel queries all the time, but those queries conflict with other user actions like builds and tests. There are various solutions to this problem, which we discussed in the unconference:</p><ul><li><p><strong>Separate output bases:</strong> This <em>works</em> but it’s heavy-handed because you end up with two full separate builds and two separate Bazel server processes.</p></li><li><p><strong>Simpler tools:</strong> Many operations on build files do not require the full weight of Bazel. Google has implemented simpler tools that operate on those precisely to bypass the overhead of calling ito Bazel. These tools include <code>buildifier</code>, <code>buildozer</code>, or the “fast builds” feature of the IntelliJ plugin.</p></li><li><p><strong>Parallel Skyframe evaluation:</strong> Skyframe’s inherent design is to be purely functional, so in principle it should be possible to perform multiple operations on the graph in parallel. Unfortunately, there is a lot of mutable state outside of Skyframe in Bazel and, while theoretically possible, fixing this is <em>a lot</em> of work.</p></li><li><p><strong>Implementing a depserver:</strong> Instead of running a separate Bazel on the same machine to answer queries, you could push this responsibility to an external service. Such a service is easy to build (you can imagine running <code>bazel query ...</code> on each commit) but the problem arises when you want to issue queries against this service from modified source trees.</p></li></ul></li></ul><h1>Inner loop development</h1><p>Bazel is <em>the</em> tool that glues together the <em>inner loop</em> of the development process. As a reminder, the inner loop refers to the the edit, build, and test cycle, and Bazel has tentacles on these three stages. Various talks gave thoughts on this topic:</p><ul><li><p><strong>Avoid Bazel in the inner loop:</strong> AirBnB reported that they noticed significant overhead and lack of incrementality in certain operations when trying to hook up Bazel into the IDE. They have the equivalent of “fast builds” in their own IDE plugin and have reduced incremental builds from 30 seconds to 1 second. This is a <em>big deal</em> for interactive builds. Personally, I think that having to side-step Bazel is ridiculous: Bazel is designed to be optimal and has perfect knowledge of the state of the world, yet it’s too slow for quick operations.</p></li><li><p><strong>Integrate with native tooling:</strong> Bazel works across many ecosystems, but as such, it’s friend to none. For example: Go developers want to work with the (super-fast) Go tooling so, if it’s feasible, it’s interesting to allow using such tooling directly. The folks at LinkedIn created a rule that generates an <code>.envrc</code> file to expose the native Go tools and relies on <a href=\"https://direnv.net/\">direnv</a> to make this work transparently for users.</p></li><li><p><strong>macOS as a client is common:</strong> Even for shops where all software runs on Linux, developers tend to have Macs and want to work locally. You may or may not agree, but if you <em>have</em> to support inner-loop development on the Mac, there are various things to consider. One is that cross-platform caching for machine-independent actions like Java may not work, doubling cache requirements; for this, you may consider using “universal binaries” (aka shell scripts that wrap multiple binaries and choose the right one at runtime). And you should really set up non-determinism checks.</p></li><li><p><strong>No build files:</strong> To my dismay, tons of people seem to really want to <em>not</em> have build files. This makes me sad because manually-curated build files serve as <em>documentation</em> for the <em>conceptual architecture</em> of a project and allow, at PR review time, to see changes to the interactions between components. You might say that <code>#include</code>s or package <code>import</code>s in the source are sufficient for this—but they really aren’t: they are too fine-grained and “innocent-looking”. I think I’ll need to write a follow-up article on this point.</p></li></ul><h1>Toolchains</h1><p>Bazel supports targeting multiple architectures and systems, and at the core of this support lie toolchains. There were various talks that touched on them:</p><ul><li><p><strong>Toolchains 101:</strong> In Bazel, rules convert providers to action templates, and toolchains help convert those templates to actions by replacing two things in the templates: the paths to the tools required by the action, and the arguments to pass to those tools. Simple, right? But defining toolchains has always been a black art.</p></li><li><p><strong>Simplified toolchains:</strong> Google brings a new way to define toolchains that’s much easier than the original one. The new mechanism relies on build rules: a toolchain rule declares a toolchain, and the toolchain depends on a “tool map” rule, which is a flat map of tool names (strategically specified as labels for typo- and type-checking, not flat strings) to binaries (also specified as labels). These tools are also connected to argument rules that define the sequence of arguments to apply to each tool. The support for “features” in core Bazel can potentially be removed in favor of this.</p></li><li><p><strong>Default toolchain no more:</strong> Following on the previous, Google said that there is a desire to remove the concept of a default C++ toolchain in favor of explicitly defining a hermetic toolchain like almost all other rules do. This was met with cheering from the audience.</p></li><li><p><strong>Debugging:</strong> It’s funny how, despite the complexity of toolchains and how we should make things easier for users… <code>--toolchain_resolution_debug</code>’s help claims that the flag is only for experts. <a href=\"https://github.com/bazelbuild/bazel/pull/19926\">PR 19926</a> made the debugging messages much clearer, but you should still understand the toolchain resolution algorithm to make sense of issues, and the talk on “Creating C++ toolchains easily” explained that.</p></li><li><p><strong>Universal binaries:</strong> Bazel doesn’t like sharing artifacts across different architectures. This is generally the right thing to do but, for platform-agnostic languages like Java, this has the potential of doubling remote execution and caching costs. There is an <a href=\"https://github.com/bazelbuild/bazel/discussions/18378\">ongoing discussion upstream</a> on what to do with this issue and various partial implementations in the code (like the <code>--experimental_platform_in_output_dir</code> flag), but no great solution yet. In the meantime, the alternative is to implement “universal binaries”. The idea is to create a shell script that wraps a binary tool built for various systems and selects, at runtime, which one to run.</p></li><li><p><strong>C++ shows up everywhere:</strong> Even if your build doesn’t seem to require C++ anywhere, the requirement to have this toolchain installed shows up pretty much everywhere because of… protobuf. bzlmod has the potential to fix this because the protobuf bzlmod packages ship with prebuilt binaries.</p></li></ul><h1>Sandboxing</h1><p>In order to offer reproducible builds, Bazel offers sandboxing features at the action level to ensure that actions can only do what they are supposed to do. I used to work in this space while on the Bazel team, so all talks on this topic were really interesting. Here are the notes:</p><ul><li><p><strong>macOS sandboxing is slow:</strong> Ah, the issue that never dies and that came up again in the unconference. While it might be true that macOS handles symlinks poorly, I’m still not convinced that there is anything that makes macOS sandboxing inherently slow. Yes, it will be less sandbox-y than what you get on Linux, but performance-wise it should be OK. All of my testing years ago didn’t show <code>sandbox-exec</code> as a performance bottleneck, and the sandbox doesn’t kill Bazel’s own build performance so… something <em>else</em> is at play here. Which brings us to the next point.</p></li><li><p><strong>Persistent state:</strong> Some compilers like Objective C’s build a module cache as they run. This cache is intended to be shared across invocations of the compiler. However, when the sandbox is in effect, sharing of this cache becomes impossible, which in turn makes builds incredibly slow. It may <em>seem</em> as if the sandbox itself is slow, but the real problem here is the lack of state sharing across actions and I suspect this is why people remain convinced that macOS sandboxing is slow. And, by the way, this impacts more than just Objective C.</p></li><li><p><strong>Sandboxing scenarios:</strong> Is it really necessary to sandbox <em>all</em> rules? <code>genrule</code>s, sure, but if we can reason about the behavior of specific rules, we can probably disable sandboxing for them and remain correct, which would decrease build-time overheads. (Remember that the sandbox was never about security.)</p></li><li><p><strong>File monitoring:</strong> An alternative to sandboxing is to monitor the activity of build actions and validate, post-build, that they didn’t access things they were not supposed to. This is much faster than sandboxing as it avoids the need to construct on-disk sandboxes… but fails when tools decide to read directories. So… this approach isn’t really feasible. JavaScript tooling loves to expand globs.</p></li><li><p><strong>Hermetic sandboxing:</strong> The traditional Bazel sandbox does not restrict reading system-wide paths so it cannot guarantee that an action doesn’t access certain system headers or arbitrary tools in <code>/bin</code>. There is a “new” hermetic sandbox for Linux that fixes these issues—but, obviously, is hard to put in practice. See <code>--experimental_use_hermetic_linux_sandbox</code>.</p></li><li><p><strong>Base POSIX system:</strong> With a hermetic sandbox, it becomes very tempting to model the host system’s base libraries and tools (bash and the like) as a toolchain. <a href=\"https://github.com/tweag/rules_sh\">rules_sh</a> from Tweag can help here.</p></li><li><p><strong>Local remote execution:</strong> A different mechanism to achieve sandboxing would be to use remote execution against a local service. This service could run on a VM or similar and offer a mechanism to cross-compile against weird architectures. This wouldn’t be quite the same as the Docker strategy.</p></li><li><p><strong>Separation of responsibilities:</strong> Somebody mentioned that it’d be neat to separate the sandboxing logic into its own thing that isn’t in Bazel’s core. I agree. The <code>linux-sandbox</code> binary that Bazel contains is somewhat akin to this, and I previously implemented something similar in <a href=\"https://github.com/jmmv/sandboxctl\">sandboxctl</a> (for very different reasons). In any case, this would need to be multi-platform and written in a decent, safe language (<em>cough</em> Rust <em>cough</em>).</p></li></ul><h1>Monorepo issues</h1><p>With scale come problems, and large monorepos tend to exacerbate issues that have always existed in small repos but that go unnoticed otherwise. Here are some of the issues that talks mentioned:</p><ul><li><p><strong>Glob handling:</strong> Globs are expensive to handle in Bazel, especially when running on networked file systems. Globs are parsed and then expressed as a DAG of functions within Skyframe. Right now, due to limitations in Java’s concurrency model, globs are evaluated twice, but Java 21’s green threads may alleviate this. Related, I was chatting about this with one of the Buck 2 authors and he said that they take a very different approach and don’t find the issues that Google described: basically, they traverse the file system once and then apply the glob as an in-memory only operation.</p></li><li><p><strong>Monolithic targets:</strong> Any large piece of code that has grown without a build system that enforces boundaries across components will grow at least one component that has thousands of source files in it with cyclic dependencies among them. These are harmful to the organization as they tend to reflect the “broken windows” culture of the team. Tinder explained how they tackle this problem, with basically boils down to: ensuring there are tests, ensuring that leadership is onboard with the cleanup, creating automation to extract files from the monolith (most of the work is repetitive), and then creating visualization tools to graph the problem and identify subsets of files that can be easily extracted.</p></li><li><p><strong>Gradual rollout of library updates:</strong> During the unconference, we discussed how to deal with version upgrades of a single library in a world that favors the “One version policy”.</p><ul><li><p><strong>Prerequisites:</strong> We agreed that, to succeed at upgrading a library, it’s critical to have tests in place and leverage tooling like <code>buildifier</code> to perform the upgrades automatically where possible.</p></li><li><p><strong>Big bang upgrade:</strong> One approach to the problem is to do the version upgrade in one go. This is sometimes really hard to do, and can also be risky because any problem anywhere in the repo would imply a rollback for everyone.</p></li><li><p><strong>Treat it as an exception:</strong> Another approach is to get an exception from the “One version policy” and temporarily allow two versions of the library in the repo. You can leverage the <code>alias</code> rule to introduce an indirection to the version in use, and then slowly migrate packages. This can work but diamond conflicting dependencies can be a real problem.</p></li><li><p><strong>Parallel build:</strong> Yet another approach is to create a parallel build and test infrastructure for the new version. Maybe use a build flag to select the version to use; maybe duplicate the targets and rename them. The goal with this approach is to keep the “new version” on the side until it all works, and then submit a trivial “3-line PR” that flips the default. For this scenario, “project files” would be useful to group the new set of targets and automatically set the right configuration for them; Buck 2 has something similar in its <code>PACKAGE</code> construct.</p></li><li><p><strong>Different package names:</strong> And another approach is to do what Java tends to do, which is to <em>rename</em> the libraries on major version upgrades so that they do not conflict at all. This is something that the upstream library maintainers have to do, not you. The problem with this approach is that semantic version is not always accurate and upstream maintainers tend to do breaking changes during minor version upgrades without realizing it.</p></li></ul></li><li><p><strong>git pain:</strong> Bazel and large monorepos go hand in hand, but Git—the most popular version control system—doesn’t like large repos very much: some operations scale with the size of the history (<code>git clone</code>) while others scale with the size of the repo (<code>git status</code>) instead of scaling with the size of the change.</p><ul><li><p><strong>Mitigation tools:</strong> There are various options that can mitigate the problem, including the <a href=\"https://git-scm.com/docs/git-fsmonitor--daemon\">FSMonitor</a>, the “untracked cache”, keeping <code>.gitignore</code> small, and using sparse checkouts.</p></li><li><p><strong>Materializing a portion of the tree:</strong> Uber previously tried using a Bazel query to find all files required for a build and then using the result of the query to just check those files out from Git. While this can work, it led to confusing error messages when there were missing files. And also, this poses the question: where do you run the query given that the query needs access to the full repo?</p></li><li><p><strong>git archives:</strong> Git is a very chatty protocol. Mark Zeren from Broadcom reports that, while Perforce can easily saturate the network, Git can rarely do so on a similar repo. The slowdown is even visible when using the loopback network interface. Prebuilding <code>git-archive</code>s periodically and using those to build the initial state of a Git clone can significantly improve performance. He mentioned that it’d be good to build a service to automate this, and offered help in doing so.</p></li><li><p><strong>Delegating file accesses:</strong> There is an open feature request in <a href=\"https://github.com/bazelbuild/bazel/issues/16380\">#16380</a> asking for a way to delegate file accesses to another tool. This, to me, sounds like FUSE. Someone brought up that FUSE doesn’t work well on macOS anymore and that NFS can be used as an alternative, and Meta’s EdenFS or Buildbarn’s bb-clientd’s do that just fine. Another option is to implement a custom VFS instance within Bazel to directly talk to a remote file system.</p></li></ul></li><li><p><strong>Resource consumption:</strong> Bazel’s memory usage is… troublesome. First, because Bazel uses a lot of memory, and second because of the JVM’s heap limits. Newer Bazel versions were able to reduce <em>retained</em> heap memory by 95% after a build and 25-30% overall during a build… but that’s not very useful because <em>peak</em> memory consumption is what matters in many cases. The team is looking at various alternate solutions to tackle this problem:</p><ul><li><p><strong>Skyfocus:</strong> Bazel 8 contains a new feature called Skyfocus, in experimental state. The idea is to perform GC based on a user-defined working set. This is useful in large monorepos where users want to only work on a small portion of the tree, but there are questions about the usability aspects and UX of this solution.</p></li><li><p><strong>Skeletal analysis:</strong> The goal of this work is to try to change the evaluation model to reduce peak memory by 20%. The idea is to trade memory usage for wall time, which means this will be useful for CI but could be harmful for interactive builds.</p></li><li><p><strong>(Remote) Analysis caching:</strong> The loss of the Bazel analysis cache across reconfigurations or server restarts has always been a problem and a major usability annoyance, so this is finally being looked at. The goal is to be able to cache configured targets, aspects, action execution results, and other Bazel-internal state, possibly storing this information in the “standard” remote cache by using a special key. This could also help with a ~70% heap and runtime reduction for analysis phases from cold start, and it could be used to prune entire subgraphs during the execution phase. This would be a massive improvement for IDE interactions, as IDEs primarily rely on analysis-time operations only.</p></li><li><p><strong>Distributed analysis:</strong> The idea is to shard analysis across Bazel workers. This sounds… OK for gigantic monorepos like Google’s but I’m not sure I see the use case outside of that environment. Still in very early stages of discussion.</p></li></ul></li></ul><h1>blzmod and external dependencies</h1><p>The <code>WORKSPACE</code> in Bazel has always been a wart: Google did <em>not</em> have this feature in Blaze but the need to support out-of-tree third-party dependencies became glaringly obvious when they open-sourced Bazel. The <code>WORKSPACE</code> was then bolted on and we have been suffering from its deficiencies for years. bzlmod promises to fix them all, and of course there were talks (and a BoF) on it:</p><ul><li><p><strong>SOTU dependency updates:</strong> bzlmod now provides a vendor mode to download all dependencies of a target or all targets, which is very useful for CI/CD offline builds (e.g. to exercise disaster recovery). <code>MODULE.bazel</code> now has include support and <code>use_repo_rule</code> for easier migration. The lock file format has been revamped to minimize merge conflicts. The <code>WORKSPACE</code> is disabled by default in Bazel 8 and won’t be available in Bazel 9. As for future plans, the repo cache will be shared across workspaces and will include the results of evaluation, not just downloads.</p></li><li><p><strong>SOTU rule updates:</strong> The Python, Android, Java, and shell rules have all moved to Starlark. Protobuf and Android support have moved as well, and this comes with new things like “mobile install v3”. The goal for next year is to complete the Starlarkification effort (with possible new extension points to call into Bazel from the Build API).</p></li><li><p><strong>SOTU Starlark and the Build API:</strong> All struct providers are gone; aspects can propagate to target toolchains; and there are now dormant dependencies for tests. As for upcoming changes: symbolic macros in Bazel 8 (more later); rule finalizers; and types for Starlark (which are compatible with Python 3 but <em>not</em> with Buck).</p></li><li><p><strong>Handling internal artifacts:</strong> It is common for vendors to provide binary blobs that don’t integrate with Bazel. Azul’s JDK is an example. For these, it is interesting to consume them into the build via a workspace repository, but the question then becomes how to do this with bzlmod. The answer is to “layer multiple registries”: you’d have a company-internal registry that exposes these binaries, and then fall back to the BCR for everything else.</p></li><li><p><strong>Disabling the BCR:</strong> For companies that want to have tight control on what they access during the build, it’s perfectly possible to bypass the BCR, either by pointing Bazel to an internal registry or by vendoring sources. The <code>bazel vendor</code> subcommand, which I didn’t know about, can come in handy.</p></li><li><p><strong>Missing packages:</strong> There are some glaring omissions from the BCR right now, which include googleapis, gRPC, and <code>rules_scala</code>. The maintainers of the former are not very cooperative, but progress is being made. As for gRPC, there is a desire to avoid pulling in support for all languages all the time, which makes this technically harder.</p></li></ul><h1>Secure and auditable builds</h1><p>Maintaining the integrity of the software provenance chain is difficult and “recent” events like the <a href=\"https://en.wikipedia.org/wiki/XZ_Utils_backdoor\">XZ Utils Backdoor</a> have shown the criticality of, at least, having an audit trail of what goes into software builds. This is where SBOM and other techniques come into play, and Bazel-based builds are perfectly positioned to provide these assurances:</p><ul><li><p><strong>SBOMs:</strong> There are many different formats to produce a <a href=\"https://www.ntia.gov/page/software-bill-materials\">Software bill of materials (SBOM)</a>, and a few of them like CycloneDX and SPDX are standardized. It’s important that these files are “merge-able” so that, when you import a third-party dependency, you can assemble their own SBOM.</p></li><li><p><strong>Types of targets:</strong> It’s tricky to generate the SBOM, and not all rules to generate one did or do the right thing. For example: do all deps belong in the SBOM? What about deps that say <code>neverlink=1</code>? What about build-time only deps like compilers?</p></li><li><p><strong>Rules:</strong> Bazel has had a <code>licenses</code> package-level function for a long time, but it is insufficient to generate an SBOM. The newer <a href=\"https://github.com/bazelbuild/rules_license\">rules_license</a> offers a much more complete solution to tracking licenses and generating SBOMs.</p></li><li><p><strong>Build assurance:</strong> Other than declaring licenses, it’s important to be able to verify <em>where</em> builds came from. <a href=\"https://slsa.dev/\">SLSA</a> defines various levels that capture different requirements. At the very least, you should target SLSA 2, which requires builds to be produced from trusted environments and to prevent arbitrary users from tampering with those builds (e.g. only allowing uploads to the Action Cache by CI). SLSA 3 is even more strict but RE doesn’t yet provide a mechanism to implement it; there are some talks to support it in V3 and maybe backport it to V2, but no concrete plans yet.</p></li></ul><h1>Symbolic macros</h1><p>Macros are problematic: they tend to cause targets to require public visibility; they tend to pollute the list of available targets in a package (the output of <code>bazel query</code> is unusable); and they have the potential of bloating the build graph massively. There was a full talk from Google on a new feature that’ll make these less of an issue:</p><ul><li><p><strong>New feature:</strong> Bazel 8 ships with <em>symbolic macros</em>, which are first-class citizens of the build graph. Symbolic macros are declared similarly to rules: instead of specifying <code>rule()</code>, you specify <code>macro()</code> and provide a set of attributes and an implementation function. The names of the targets and outputs that these macros produce are constrained to a set of well-defined patterns.</p></li><li><p><strong>Limitations:</strong> One known deficiency is that <code>**kwargs</code> doesn’t work as it used to because there is no way to specify this in an attribute list. The way to mitigate this and make it easier to wrap rules will be attribute inheritance. Similarly, while symbolic macros can lead to lazy expansion, this is not yet implemented. Both of these limitations will be addressed later in the 8.x series.</p></li><li><p><strong>Epilogs:</strong> Legacy macros used to call <code>native.existing_rules()</code> and lead to the “epilog macro” idiom that can be found in large monorepos. These macros are expected to appear at the end of a build file… but there is no way to enforce this. With symbolic macros, this idiom is now a supported feature via the <code>finalizer=True</code> attribute, which then makes these macros be expanded <em>after</em> the full build file has been processed irrespective of any other targets.</p></li><li><p><strong>Downsides:</strong> Symbolic macros were well-received by conference attendees but have received some pushback inside of Google. The reason is that, because these macros will allow lazy evaluation, it’s possible that they’ll encourage even larger packages that only become problematic in some (critical) scenarios.</p></li><li><p><strong>Legacy macros:</strong> There are no plans to remove legacy macros right now—and even if there were, it’d take years to eliminate them due to the need to remain backwards-compatible for multiple releases.</p></li></ul><h1>Queries</h1><p>For people coming from other build systems, the ability to query a build graph may sound like an alien concept. But Bazel has first-class features to do just this, and they can come in handy when writing automation to modify the source tree or to select tests for execution.</p><p>There was a full 30-minute talk dedicated to queries. I do not intend to repeat everything that was said because everything is in <a href=\"https://bazel.build/query/language\">the query documentation</a>… but I did learn a bunch of stuff:</p><ul><li><p><strong>Target provenance:</strong> <code>bazel query --output=build ...</code> shows “fictitious” attributes like <code>generator_{name,function,location}</code> which indicate what produced a target. Useful to understand what macros and globs are doing. These attributes can also be used in filters.</p></li><li><p><strong>Variables:</strong> Queries can have variables in them to avoid repeating complex parts. For example: <code>let v = foo/... in allpaths($v, //common) intersect $v</code>.</p></li><li><p><strong>Removing implicit dependencies:</strong> These often pollute query results with noise and can be removed with <code>--noimplicit_deps</code>. Arguably, this flag should be the default.</p></li><li><p><strong>Graphing:</strong> It is possible to generate a Graphviz file by using <code>--output=graph</code> and then graphing it with <code>dot -Tsvg -o graph.svg</code>. It is important to filter the query or otherwise the resulting graph is overwhelming—aka useless.</p></li><li><p><strong>Running code on the graph:</strong> The <code>cquery</code> command supports <code>--output=starlark --starlark:expr=...</code> which allows running a piece of Starlark code on every target selected by the query. The current target is bound to the <code>target</code> variable. This is useful to, for example, query transitive runtime JARs. And because Starlark is almost Python, you can explore the API by using the <code>dir</code> function with expressions like <code>dir(target)</code> or <code>dir(target.actions)</code>.</p></li><li><p><strong>Action queries:</strong> The <code>aquery</code> command is a different beast from the other queries and allows inspecting the action graph. Something like <code>bazel aquery 'mnemonic(CppCompiler, //...)'</code> shows all inputs, outputs, and command lines for every action. This can be particularly useful to understand toolchain configuration changes.</p></li><li><p><strong>Filtering by file:</strong> The <code>outputs</code> and <code>inputs</code> filters can be used to filter actions by paths: e.g. you can find actions that produce a particular file with <code>outputs(\".*path/to/h\", deps(//...)))</code>. (Beware that the path filter is an anchored regexp.)</p></li><li><p><strong>Performance:</strong> Running many queries in a loop doesn’t scale. Consider building a bigger query if possible and then do post-processing (the opposite advice of when talking to a database server), or using an aspect to dump all info in a single run.</p></li></ul><h1>Linting</h1><p>Back at Google, Jin and I hosted an intern circa 2017 to work on “autolint”: an innovative tool that was supposed to automate running arbitrary lint checks on arbitrary codebases. The project never materialized… but Aspect.dev just announced <a href=\"https://github.com/aspect-build/rules_lint\">rules_lint</a> which basically does the same thing and integrates with Bazel neatly.</p><p>To summarize the talk, <code>rules_lint</code> provides two disjoint features in one:</p><ul><li><p><strong>Formatting:</strong> The goal of formatting is to change a codebase to adhere to predefined standards and stop the bitchering about white space. A quote from the talk I liked was “because while your code might be art… it isn’t ASCII art”.</p><ul><li><p><strong>Broad support:</strong> Supporting formatters is easy, and there are formatters for almost all languages, so a goal here is to try to support as many as possible.</p></li><li><p><strong>Speed:</strong> Formatting must be deterministic and fast so that it can be hooked into the IDE and/or in pre-commit hooks.</p></li><li><p><strong>Not part of the build graph:</strong> It’s tempting to try to hook formatting as an action, but formatting requires unconstrained access to the workspace to modify source files, and many source files that you’d like to lint don’t necessarily have build rules (e.g. Markdown documentation).</p></li><li><p><strong>Implementation:</strong> Formatting relies on <code>rules_multitool</code> which automates the process of downloading a bunch of tools and <code>rules_multirun</code> which allows running multiple tools in parallel.</p></li><li><p><strong>Git blame:</strong> When applying formatting changes, don’t forget to register the commits that did so in <code>.git-blame-ignore-revs</code>. This will prevent your name from showing up in <code>git blame</code> operations as the author of all files.</p></li></ul></li><li><p><strong>Linting:</strong> The goal of linting is to detect potential problems in the code, but the constraints are different: the problems aren’t always conclusive, the solutions aren’t always unique nor safe to apply automatically, and analyzing a file may require analyzing more than one at once.</p><ul><li><p><strong>Speed:</strong> Linting is slow because it often requires using tools akin to compilers. As such, it should never be added to pre-commit hooks and should instead be plumbed through in CI.</p></li><li><p><strong>Implementation:</strong> The desire is to have a uniform interface for linting all languages and don’t want to have extra rules nor modify build files. The obvious answer to this is to use an aspect which then augments existing rules with reports and patches to fix up the source tree. Validation actions were not an option because using them requires modifying the rulesets, and a premise of this work was to <em>not</em> do that.</p></li><li><p><strong>Interface:</strong> Invoking an aspect and handling the resulting patch files is complicated, so Aspect.dev has augmented the Bazel client (the CLI) with an additional <code>lint</code> subcommand that automates this process. Interesting, and I suppose this could be turned into a pluggable mechanism by making Bazel look for <code>bazel-<command></code> binaries at a well-known location (like the <code>git</code> dispatcher does). This reminded me of Twitter’s <a href=\"https://v1.pantsbuild.org/\">Pants</a> build system, which is much more than just for building.</p></li></ul></li></ul><h1>Testing</h1><p>Bazel is often sold as a “build tool” but its secret sauce is that it really is a “test tool”. The true benefits of using Bazel come from realizing that not all tests have to run all the time, and that their results can be safely cached. Various talks touched upon how to do testing effectively:</p><ul><li><p><strong>Profiling data:</strong> Collecting profiling details of tests <em>by default</em>, and exposing these details as test outputs, is very useful because developers can then use this information to understand how to optimize long tests on their own. AirBnB reported that they do this.</p></li><li><p><strong>Test granularity:</strong> We like to think that each test deserves its own test target… but that’s not necessarily how users think or how they interact with tests. Many times, developers end up running certain groups of tests in unison, and if they always do that, combining those tests under a single target will save build and execution time at the expense of a less “pure” dependency graph.</p></li><li><p><strong>Tests in the build:</strong> In certain scenarios, users would like to depend on test outputs as part of the build process. One example that Luminar Technologies provided was the need to generate a detailed report of test results and code coverage for industry compliance reasons. The report generation should be an action that depends on the test outputs, but that’s not doable. As a compromise, they made the tests run as part of the build by replacing <code>cc_test</code> with a macro that spawns a non-test action with a custom runner (but only on CI).</p></li><li><p><strong>Smoke tests:</strong> Related to the previous and during the unconference, Luminar Technologies also brought up the desire to gate parts of the build and test process on “smoke tests”. In other words: once issuing the build/test operation, if we detect that a simple test fails, we shouldn’t continue the build or run any of the more expensive tests. The audience seemed to agree that this belonged into a separate tool. Ulf reminded us that there should still be a flag called <code>--test_keep_going</code>, which can be set to false to stop execution as soon as one test fails.</p></li><li><p><strong>Test selection:</strong> When folks adopt Bazel, their initial approach to CI is to simply do <code>bazel test ...</code> in a job. This works well… until it doesn’t, because even in the presence of test caching, processing the whole monorepo becomes expensive. Uber explains how even an <code>rdeps</code> query becomes expensive and they’ve had to find other solutions. A key insight is that 71% of changes to their monorepo only change source files and only 15% change at least one build file. This means that the majority of changes do not modify the build graph structure significantly, so there is room for reusing state from previous builds (e.g. keeping the Bazel server alive) to compute newly-affected targets.</p></li><li><p><strong>Flaky test granularity:</strong> Bazel detects flakes at the test target level… but a test target can contain tens or hundreds of individual test cases. Which means that if a single test case is flaky and we conclude that its target is flaky, subsequent builds could skip lots of valid test cases. By implementing custom flaky test case detection via <code>junit.xml</code> report files, Uber was able to surface 3500 additional tests that would have been skipped by the naive target-based approach and could re-add those to the build.</p></li><li><p><strong>Profile-guided test execution:</strong> In large test invocations, it’s common for one test to be the long pole. If by lack of luck this test ends up running last, it ends dragging the critical path of the test run and lengthening the p99 of test executions. It’d be nice if Bazel supported “profile-guided execution” so that such long poles could be scheduled earlier. Jin reported that this has been looked at but one problem is that there hasn’t been a good place to store this information across invocations. Ulf mentioned that when we have async action execution (which Java 21 makes possible), we should be able to improve action scheduling and implement this.</p></li><li><p><strong>Actions per test:</strong> One interesting detail that Ulf shared is that test targets generate three actions, possibly more: one to execute the test itself, another to generate the <code>junit.xml</code> file if the test failed to do so, and another to perform coverage post-processing. If retries, sharding, or <code>--runs_per_test</code> are involved, there can be even more actions. So, if it becomes necessary, there is precedent to add more actions to perform other types of post-processing.</p></li><li><p><strong>CI runners:</strong> A topic that came up during the unconference was that starting Bazel on CI runners is very painful because of the need to download repos, repopulate the local disk cache, and rebuild the analysis graph. The general advice is to prevent discarding CI runners across builds, but that’s not always possible (e.g. security might not like to share runners across different jobs). For Kubernetes, stateful sets provide a mechanism to preserve the disk cache even during auto-scaling.</p></li></ul><h1>Missing tooling around Bazel</h1><p>A fun topic that arose in the unconference was: “what support tools do you wish Google had open sourced when they published Bazel, or that the community had built?” There were many ideas from the audience:</p><ul><li><p><strong>Scripting language for use in genrules:</strong> Writing genrules that work across systems is difficult because they invoke the shell, and the tools that are often called do not always support the same syntax (<a href=\"https://jmmv.dev/2021/08/useless-use-of-gnu.html\">thanks GNU</a>). It’d be nice to have a language that allowed writing genrules in a platform-agnostic way. WASM was brought up as well as having a Starlark interpreter with file system access.</p></li><li><p><strong>Affected target determination:</strong> The goal of this tool would be to answer the question of which targets are impacted by a change to the source tree. <a href=\"https://github.com/Tinder/bazel-diff\">bazel-diff</a> more or less does this. An <code>rdeps</code> query sounds like the right solution, but in practice it is tricky because changes to a toolchain aren’t visible in a query; they do show up in <code>cquery</code> though, but then you have to be aware of all possible configurations to do the determination correctly.</p></li><li><p><strong>Build queuing:</strong> The goal here is to have a service that can queue entire builds and not just actions. This might exist in some CI systems already.</p></li><li><p><strong>Unifying bazelisk with bazel:</strong> Users are confused with the fact that <code>sudo apt install bazel</code> is available but generally does the wrong thing, and that it’d be good if <code>bazelisk</code>’s features existed within Bazel. I explained that we built something similar to <code>bazelisk</code> at Snowflake but for arbitrary tools as a way to hijack command line executions and redirect them to checked-in tools; maybe we should open-source it.</p></li><li><p><strong>buildozer for bzl files:</strong> Automating edits to <code>bzl</code> files would be handy, although this is a hard problem. Maybe it could be scoped down to e.g. automatically clean up old repository rules that aren’t referenced.</p></li><li><p><strong>Java library to programmatically edit build and </strong><code>bzl</code><strong> files:</strong>. The current Starlark library isn’t useful because it’s not standalone and it doesn’t preserve the original file structure. A workaround is to extract the AST from Python because these files remain syntactically valid from Python’s perspective.</p></li><li><p><strong>Documentation website for all the rules:</strong> The BCR could fulfill this, but it currently does not have links to documentation.</p></li></ul><h1>The end</h1><p>And finally, here are the few leftover toughts that I did not know how to fit in any of the sections above:</p><ul><li><p><strong>Nix:</strong> There were many talks about Nix on the original submissions, but only a couple made it to the final schedule. The folks at Modus Crate described how they use <code>rules_nixpkgs</code> to build external dependencies and how they stage those in an NFS-shared <code>/nix/store/</code> tree. Because Bazel invokes Nix and stages the dependencies during its external repository phase, the execution phase and the remote workers can assume that the Nix packages are in the right locations and things just work.</p></li><li><p><strong>RPM integration:</strong> In a similar spirit to using Nix to install packages and/or build containers, we also have <a href=\"https://github.com/rmohr/bazeldnf\">bazeldnf</a>. This ruleset provides the <code>rpm</code> repository rule to import RPM packages and the <code>rpmtree</code> build rule to combine one or more RPM into a tarball that can later be fed to other rules like <code>container_layer</code>. In this context, you might also be interested in the <a href=\"https://github.com/NixOS/patchelf\">patchelf</a> ruleset.</p></li><li><p><strong>Migrations:</strong> Migration talks are getting old, but there were some good insights from MongoDB’s talk. One such insight was that, as in any software rewrite, the “old” build system doesn’t stay still during a migration, and the set of features to migrate grows over time. Another such insight was that, if you can couple the new build system to the old one (by making one rely on the other for increasing portions of the code), you can minimize the time in which new features get added to the old build and not the new one. The downside is that you’ll be building throwaway work, but overall it will pay off.</p></li><li><p><strong>My talk about Snowflake:</strong> I gave a 15-minute “migration” talk about what we are doing with Bazel at Snowflake. Because of what I said just above, I skipped over all of the migration topics and instead focused on explaining 5 different technical challenges that we faced and how we fixed them. I was met with lots of questions after the talk, which was really nice, but which means that we owe a full migration post when we are done (very soon now!).</p></li></ul><p>I hear you want the raw notes? Are you sure? I really don’t recommend that you look… but if you must, here they are: <a href=\"https://jmmv.dev/notes/2024-10-14-bazelcon.md\">BazelCon day 1 notes</a>, <a href=\"https://jmmv.dev/notes/2024-10-15-bazelcon.md\">BazelCon day 2 notes</a>, and the <a href=\"https://jmmv.dev/notes/2024-10-16-build-meetup.md\">Build Meetup’s notes</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">I hope that you enjoyed this 4o-minute long summary of 3 long conference days. The way to “pay back” is, simply, to hit subscribe! And yes, it’s free.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "0.0" "image/jpeg") nil "893bb333321d714498d96a9262d4873d") (57 (26634 38675 764322 377000) "https://blogsystem5.substack.com/p/kyua-graduates" "Kyua graduates" "Julio Merino" "Fri, 02 Aug 2024 15:45:08 +0000" "<p>After years of inactivity, the Kyua project has graduated as an open source citizen and has <a href=\"https://github.com/freebsd/kyua/\">a new home</a> under the FreeBSD umbrella!</p><p>But uh… wait, what is Kyua and why is this exciting? To resolve confusion and celebrate this milestone, I’d like to revisit what Kyua is, how it came to be, why I stopped working on it for a while, why that was a problem for FreeBSD—and, indirectly, NetBSD—and how Kyua being free software has helped keep it alive.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":367311,\"alt\":\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\",\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" title=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><h1>The birth of ATF</h1><p>Let’s begin by talking about Kyua’s predecessor: the Automated Testing Framework (ATF).</p><p>In 2005, I was <a href=\"https://jmmv.dev/2005/06/soc-accepted.html\">one of the lucky pioneers</a> of the Google Summer of Code (GSoC) program. During that summer, I wrote <a href=\"http://web.archive.org/web/20071214080206/http://netbsd-soc.sourceforge.net/projects/tmpfs/\">the tmpfs file system for NetBSD</a> and my development process went something like this on an iBook G3:</p><ol><li><p>Modify the kernel.</p></li><li><p>Build and install the updated kernel.</p></li><li><p>Reboot the laptop.</p></li><li><p><strong>Mount the file system.</strong></p></li><li><p><strong>Manually validate new functionality and bug fixes.</strong></p></li><li><p>Witness the machine crash.</p></li><li><p>Force-reboot.</p></li><li><p>Rinse and repeat.</p></li></ol><p>Needless to say, this was a painful process. Using kernel modules lowered the pain a tiny little when the changes I made didn’t crash but, in general, they <em>did</em> crash. Documentation was scarce and I didn’t know what I was doing!</p><p>In an attempt to make the validation step less painful and to ensure that each change I made was a “net positive” instead of regressing functionality, I got what-I-think-was my first real exposure to automated testing. I <em>had</em> to automate steps 4 and 5 in the flow above, and so I wrote ad-hoc scripts to do so.</p><p>My GSoC mentors, Luke Mewburn and Bill Studenmund, pointed me at the <code>src/tests</code> directory of the NetBSD source tree which contained a bunch of tests for the system. Some of these were for user space tools and others exercised portions of the kernel. The existing machinery could probably be reused to automate my manual regression testing steps, so I had to try to integrate with it.</p><p><em>Machinery</em> is… a strong word given how rudimentary <code>src/tests</code> was. The main issue with this infrastructure was that the tests didn’t have a real runner: they were all small programs with unique command-line interfaces glued together by a collection of <code>Makefile</code>s. There was no guarantee that these tests built nor that running a <code>make test</code> would run them all because many tests were known to be broken. And what’s worse: some of the existing tests <em>crashed</em> the kernel due to known bugs.</p><p>I started envisioning the need for a principled test framework and wanted to create one, but I needed the time to do so and school didn’t give me much of that. So, in 2006, I applied once again to GSoC but, while I got in, I chose to take a detour and help write the beginnings of the Boost.Process library. The reason for this choice was primarily to learn Win32 internals but a good side-effect was that I got to experience a more advanced test framework.</p><p>And then, in 2007, I wanted to create this automation project as my bachelor’s degree graduation project… but I couldn’t find a professor that would back the idea. (A pity because I believe it would have been a great fit for the operating systems group.) So I did what I knew how to do: I applied and got into GSoC once again—this time <a href=\"http://web.archive.org/web/20071225031924/http://netbsd-soc.sourceforge.net/projects/atf/\">to develop a testing framework for NetBSD</a>.</p><p>The idea was to create libraries to write tests with a unified CLI interface in either C, C++, or shell, and then provide a unified runner that would execute these tests in an isolated manner <em>and</em> without access to the source tree. And thus the <em>Automated Testing Framework (ATF)</em> was born.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Being sponsored to work on open source projects by GSoC was truly inspiring. Those times are long gone, but you can now support me by subscribing and choosing a paid option!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Problems with ATF</h1><p>ATF was fine for a while. We got a large portion of the old tests in NetBSD resurrected, fixed, and hooked into the ATF infrastructure. A major contribution was Andreas Gustafsson’s <a href=\"https://www.gson.org/netbsd/anita/\">Anita</a>: an automation system to create a VM, install NetBSD on it via the interactive installer, and run the whole battery of tests inside of it.</p><p>Anita and ATF were the beginnings of something akin to a CI system for a full operating system in the open source world. As far as I know, Linux did <em>not</em> have anything similar—and it <em>couldn’t</em> have had anything similar due to the distributed nature of its development—nor did the other BSDs. Windows <em>did</em> have this, of course, as I could glance from the many articles in <a href=\"https://devblogs.microsoft.com/oldnewthing/\">The Old New Thing</a> describing backwards compatibility testing.</p><p>This was great but, over time, ATF showed signs of suboptimal design. It had at least two problems that were really hard to fix, namely:</p><ul><li><p>Its design (remember running <code>atf-run | atf-report</code>?) prevented the execution of tests in parallel, and concurrent test execution is crucial for performance. The Anita test runs took just too long for a good CI turnaround.</p></li><li><p>ATF expected tests to be written using the <code>atf-c</code>, <code>atf-c++</code>, and <code>atf-sh</code> libraries—but developers wanted to implement and reuse tests without porting them to these libraries. In particular, people wanted to create simpler test programs and wanted to support programs that emitted the more-widespread <a href=\"https://testanything.org/\">Test Anything Protocol (TAP)</a> popularized by Perl test harnesses.</p></li></ul><p>Aside from these problems, ATF also lacked a critical feature that Anita had to supply on its own: a data store to track historical test reports and an interface to browse through them. This feature was a necessity for a CI system so, ideally, it had to live within ATF to not be stuck inside a web server. (“Web apps everywhere” was not a thing pre-2010.) To compound the problem, I got an internship at Google in 2008 and joined full-time in 2009, which let me experience <a href=\"https://bazel.build/\">Blaze</a> and its ecosystem for test results tracking and reporting first-hand—and I wanted those features for NetBSD.</p><p>I concluded, <a href=\"https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/\">maybe wrongly</a>, that ATF needed a rewrite.</p><h1>Kyua arrives</h1><p>So, in 2010, I set to create a brand new execution engine. At that point, the target was to rewrite just the portion of ATF that executed tests: that is, the <code>atf-run | atf-report</code> pipeline. I did not want to recreate the ATF <em>libraries</em>. The idea was to:</p><ul><li><p>Create a generic test runner that could integrate multiple test protocols, with the ATF-based tests being the first use case. The unwritten goal was to let the ATF libraries dwindle at some point in the future in favor of better libraries (like <a href=\"https://github.com/google/googletest\">GoogleTest</a> for C++ tests or my own <a href=\"https://jmmv.dev/2023/10/unit-testing-with-shtk.html\">shtk for shell tests</a>).</p></li><li><p>Support a “tests database” to store the results of all test executions. This database was going to allow generating reports in multiple formats and permit running queries to look at historical trends.</p></li><li><p>Support parallel test execution via a more modular runner design. (If you know the history behind Kyua, you’ll notice that this feature only appeared very late in the game. It was a mistake to delay it and I’m not sure why I did that.)</p></li></ul><p>Thus, in November of 2010, Kyua was born as a “testing framework for infrastructure software”. It took some work to get to the point where Kyua could run most of the NetBSD test suite unmodified, but by July 2011, I reached this milestone and launched Kyua 0.1.</p><p>Which led to frustration: ATF was deeply ingrained in NetBSD and Kyua wasn’t well-received for various reasons. One was that Kyua was a larger C++ project than ATF and C++ was (and still is) frowned upon in that community. Another was the fact that Kyua’s reports were harder to manage and required significantly more disk space, and Andreas wasn’t ready to bubble up his CI hardware costs. There were other concerns, all pretty reasonable.</p><p>I kept working on Kyua to try to resolve most of the concerns raised and I believe I addressed all of those that could be addressed. Unfortunately, this took time, and I had grown demotivated to pursue another “sell” of the project. But then…</p><h1>Kyua meets FreeBSD</h1><p>The FreeBSD community had been paying attention. They needed to improve their CI story as well, and they did have much more interest in building a test suite due to the needs of a few corporate-backed projects. I’m not exactly sure who I talked to other than Enji Cooper, George N. Neville, and Ed Maste, but by 2013, I had <a href=\"https://jmmv.dev/2013/11/joining-freebsd-committer-ranks.html\">gotten a FreeBSD commit bit</a> and I was set to integrate Kyua—not ATF!—into FreeBSD.</p><p>One thing I remember was how the FreeBSD project offered me three dedicated beast machines in a colo so that I could set them up for CI runs. This felt very different from the NetBSD approach: FreeBSD had resources—understandably so, as NetBSD has always been underrated—and they were ready to invest them into the shiny-new thing. I took the bait and worked on that for a while. (Fun fact: I used a PowerMac G5 for this work.)</p><p>By December of 2013, I shipped <a href=\"https://jmmv.dev/2013/12/introducing-freebsd-test-suite.html\">the initial CI system</a> for FreeBSD. This was a really exciting moment because all efforts I had put behind Kyua finally paid off: Kyua was <em>the</em> driver for what I think is the most important operating system project in the open source community outside the Linux monoculture.</p><p>The future of the project was tainted though: I was still employed by Google… which made me keep experiencing Blaze and its ecosystem day after day. You see: Blaze is often touted as a <em>build</em> system, but its secret sauce lies in it being a <em>test</em> system. Blaze is a test runner that knows how to precisely build and run <em>the minimum set of tests impacted by a code change</em>. And this matters.</p><p>Precise test selection doesn’t make a big difference for the run-off-the-mill projects you see in GitHub, but for monorepo-style projects—and the BSDs are such projects—this becomes a requirement to run a CI system with quick turnaround times. By this point, I saw Kyua as a “local maximum” because I did not see how to make this possible in combination with the native BSDs’ build systems.</p><h1>Stagnation</h1><p>No matter what I secretly thought, FreeBSD was bought into ATF and Kyua, and they—Enji in particular—had larger plans for the system. The FreeBSD developers really wanted to integrate TAP-style tests, needed to set up a full CI system with many more configurations and architectures than I had set up, and needed better reporting capabilities for failures.</p><p>The problem was that I owned the critical software pieces of this infrastructure, and this was a problem for various reasons: I was too busy with work and two little kids; I had stopped using any BSD on a daily basis; I did not see a bright future for Kyua as it was designed nor implemented; and to make things worse, contributing to Kyua required signing the Google CLA because I still worked for Google (which never made any sense to me but I didn’t have a say in the matter).</p><p>So, for years, Kyua went pretty much unmaintained. FreeBSD kept building local patches and occasionally sent PRs to my upstream project, but I dreaded dealing with them. Maintaining open source projects is stressful if only because of this guilt that you end up with when you don’t have the time to deal with contributions in a timely manner. The more time the situation lasts, the worse it gets.</p><p>It took until 2020 to convince myself that ATF and Kyua needed attention and that I was not fit to support them. I had to let go off these projects and I needed to clear my mind <a href=\"https://www.endbasic.dev/2020/04/hello-endbasic.html\">for other cool stuff</a>. So… I emailed the FreeBSD project owners and offered them to take ownership. If they forked the project and owned it, any FreeBSD committer could easily gain access to the project to do what was best for FreeBSD. And if they owned the fork, they wouldn’t have to worry about the CLA part of the situation because I wouldn’t be involved any longer.</p><p>Things didn’t make the progress I desired though. The FreeBSD project owners had concerns about officially forking these projects into FreeBSD because it cloud give the wrong impression and alienate other consumers like NetBSD. Kyua and ATF were not FreeBSD-only projects so it was probably better for them to stand alone. The discussions died off and stayed like that…</p><h1>Rebirth</h1><p>… until the end of 2023 when Li-Wen Hsu resurrected the email thread I had started. Kyua had become a critical piece of the FreeBSD quality infrastructure and it being almost-abandoned was starting to be problematic. He asked if we could move forward with the project ownership transfer idea—and I was at the ready.</p><p>And so that’s what happened!</p><p>On January 17th, 2024, the right buttons were pushed and… <a href=\"https://github.com/freebsd/kyua/\">Kyua</a> (along with <a href=\"https://github.com/freebsd/atf/\">ATF</a> and <a href=\"https://github.com/freebsd/lutok/\">Lutok</a>) all became owned by the <a href=\"https://github.com/freebsd/\">FreeBSD GitHub organization</a>. Since then, I’ve seen a flurry of PRs reviewed and merged into the project, which makes me happy, really, because the people that care now have the chance to do what’s best for the project.</p><p>Plus, you know what? Even if Kyua has some “design flaws” because it was not designed to be exactly like Blaze, it does have some <em>other</em> interesting ideas that make it a good-enough fit for FreeBSD. In particular, one design principle behind ATF and Kyua was to allow running a test suite <em>without</em> having access to the source code.</p><p>Actually, I think this was a killer idea in the original design of ATF. The motivation for “running tests without the source” was to allow installing a system from scratch and then let <em>the end user</em> run the tests to verify that the system worked correctly <em>on their specific software/hardware combination</em>. The BSDs have limited resources and cannot do the sorts of testing that e.g. Microsoft does with Windows so, by pushing the tests “to the edge”, users could fill that gap.</p><p>And to illustrate this novel-at-the-time idea, let’s take a tour.</p><h1>Kyua in FreeBSD 14</h1><p>Kyua is part of the FreeBSD base system and, as such, it is installed under <code>/usr/bin/kyua</code> and is available out of the box.</p><p>Similarly, the test suite is available under <code>/usr/tests</code> if you choose to unpack <code>tests.txz</code> during the system installation. Peeking under it, we find:</p><pre><code><code>/usr/tests$ ls -F
Kyuafile     conftest.py  lib/         sys/
README       etc/         libexec/     usr.bin/
__init__.py  examples/    local@       usr.sbin/
atf_python/  games/       sbin/
bin/         gnu/         secure/
cddl/        include/     share/
/usr/tests$ █</code></code></pre><p>We can use <code>kyua list</code> to see what kind of test coverage we have. This command prints one test case name per line in its default output format, so we can easily count how many tests there are:</p><pre><code><code>/usr/tests$ kyua list | wc -l
8246
/usr/tests$ █</code></code></pre><p>8000+ tests. Not bad! Let’s peek into a tiny sample by focusing on the tests for <code>dd(1)</code>:</p><pre><code><code>/usr/tests$ kyua list bin/dd
bin/dd/dd2_test:max_seek
bin/dd/dd2_test:seek_overflow
bin/dd/dd2_test:sigint_open
bin/dd/dd2_test:sigint_read
bin/dd/dd_test:io
bin/dd/dd_test:length
bin/dd/dd_test:seek
/usr/tests$ █</code></code></pre><p>And let’s run those!</p><pre><code><code>/usr/tests$ time kyua -v parallelism=$(nproc) test bin/dd
bin/dd/dd2_test:seek_overflow  ->  passed  [0.042s]
bin/dd/dd2_test:max_seek  ->  skipped: tmpfs can't create arbitrarily large sparse files  [0.044s]
bin/dd/dd_test:length  ->  skipped: fdescfs is not mounted on /dev/fd  [0.024s]
bin/dd/dd_test:seek  ->  passed  [0.048s]
bin/dd/dd_test:io  ->  passed  [0.071s]
bin/dd/dd2_test:sigint_read  ->  passed  [3.077s]
bin/dd/dd2_test:sigint_open  ->  passed  [3.079s]
Results file id is usr_tests.20240728-161942-793100
Results saved to /home/jmmv/.kyua/store/results.usr_tests.20240728-161942-793100.db
7/7 passed (0 failed)
kyua -v parallelism=$(nproc) test bin/dd  0.17s user 0.33s system 15% cpu 3.198 total
/usr/tests$ █</code></code></pre><p>Easy peasy. We can run tests for any part of the system right from the <code>/usr/tests</code> hierarchy without having had to build anything nor needing access to the source tree. As mentioned earlier, you can use this feature to validate that FreeBSD works on your specific machine given that device drivers are of varying quality (something that’s true on <em>any</em> operating system) and may result in different behavior. And you can use this feature to validate that the system <em>continues to work</em> as you perform upgrades over time.</p><p>Outside of your machine, though, we can also look at the CI system based on Jenkins. For that, head to <a href=\"https://ci.freebsd.org/\">https://ci.freebsd.org/</a> and peek around. Notice the tens of different jobs configured to build and test FreeBSD under various architectures, releases, and build settings.</p><p>As an example, look at the recent <a href=\"https://ci.freebsd.org/job/FreeBSD-main-amd64-test/25361/testReport/\">run 25361 of FreeBSD-main-amd64-test</a>, and notice how we can inspect the same test results we saw on the command line. Do so by clicking on <code>bin.dd</code> and finding the results for the same tests we ran earlier. This showcases Kyua’s ability to generate a <code>junit.xml</code> test report—an output format that was precisely written to integrate with Jenkins for the FreeBSD CI system.</p><div><hr></div><p>And that’s it.</p><p>The morale of the story is two-fold. First, free software can remain alive and kicking even if the original authors lose interest. And second… do you see how powerful it is to have a CI system for <em>a whole OS</em>? This is something Linux can only dream of because of its inherent distributed development nature. Yes, there is the <a href=\"https://github.com/linux-test-project/ltp\">Linux Test Project</a>, but because Linux is “just a kernel”, this is what this project can test. There is nothing that can validate that the kernel works in combination with all other pieces that form a Linux distribution in a uniform and cohesive manner.</p><p>In any case, congrats grads. Kyua has a bright future ahead.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "0.0" "image/jpeg") nil "7b237098dda2268a79644b271d07f7a3") (56 (26633 14283 93255 546000) "https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11" "Hands-on graphics without X11" "Julio Merino" "Fri, 17 Jan 2025 17:45:51 +0000" "<p>Look at these two consoles:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" width=\"1200\" height=\"508.65671641791045\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\",\"srcNoWatermark\":null,\"fullscreen\":false,\"imageSize\":\"large\",\"height\":568,\"width\":1340,\"resizeWidth\":1200,\"bytes\":25232,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-large\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Side-by-side comparison of the NetBSD console right after boot vs. the EndBASIC console.</figcaption></figure></div><p>Same colors, (almost) same font, same… everything? Other than for the actual text they display, they look identical, don’t they? But the one on the right can do things that the one on the left cannot. Witness this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1de4af8-dba8-4d87-913c-c5b14e11ea92\",\"duration\":null}\"></div><p>A square? OK, meh, we had those in the DOS days with <a href=\"https://en.wikipedia.org/wiki/Box-drawing_characters\">box-drawing characters</a>. But a circle?! That’s only possible because the console on the right is a hybrid console that supports mixing the usual textual grid of a terminal with overlapping graphics.</p><p>Now, if you have been following the development of <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, this is not surprising. The defining characteristic of the EndBASIC console is that it’s hybrid as the video shows. What’s newsworthy, however, is that the EndBASIC console can now run directly on a framebuffer exposed by the kernel. No X11 nor Wayland in the picture (pun intended).</p><p>But how? The answer lies in NetBSD’s flexible wscons framework, and this article dives into what it takes to render graphics on a standard Unix system. I’ve found this exercise exciting because, in the old days, graphics were trivial (<a href=\"https://en.wikipedia.org/wiki/Mode_13h\">mode 13h</a>, anyone?) and, for many years now, computers use framebuffer-backed textual consoles. The kernel is obviously rendering “graphics” by drawing individual letters; so why can’t you, a user of the system, do so too?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Your subscription to Blog System/5 fuels me to write comprehensive articles like this, and this one was particularly painful to put together. Click the button for more goodies. It’s free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>wscons overview</strong></h1><p><a href=\"https://man.netbsd.org/wscons.4\">wscons(4)</a>, or Workstation Console in its full form, is NetBSD’s framework to access the physical console attached to a computer.</p><p>wscons abstracts the details of the hardware display and input devices so that the kernel and the user-space configuration tools can treat them all uniformly across the tens of platforms that NetBSD supports. If you use <a href=\"https://man.netbsd.org/wsconsctl.8\">wsconsctl(8)</a> on a modern amd64 laptop to control its display, you use wsconsctl on an ancient vax box to control its display too.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" width=\"1456\" height=\"1001\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1001,\"width\":1456,\"resizeWidth\":null,\"bytes\":436643,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Layered architecture of wsdisplay and its backing devices.</figcaption></figure></div><p>The output architecture of wscons is composed of multiple devices, layered like this:</p><ol><li><p><a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> sits at the top of the stack and implements the console in hardware-independent terms. The functionality at this level includes handling of VT100-like sequences, cursor positioning logic, text wrapping, scrolling decisions, etc.</p></li><li><p>Under wsdisplay sit the drivers that know how to access specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/vga.4\">vga(4)</a>, which does not do graphics at all; <a href=\"https://man.netbsd.org/genfb.4\">genfb(4)</a>, which is a generic framebuffer driver that talks to the “native” framebuffer of the system (e.g. the one configured by the EFI); and <a href=\"https://man.netbsd.org/radeonfb.4\">radeonfb(4)</a>, which implements an accelerated console on AMD cards. These drivers know how to initialize and interact with the hardware.</p></li><li><p>Under the graphical drivers sits <a href=\"https://man.netbsd.org/vcons.4\">vcons(4)</a>, the driver that implements one or more graphical consoles in terms of a grid of pixels. vcons is parameterized on “raster operations” (rasops), a set of virtual methods to perform low-level operations. An example is the <code>moverows</code> method, which is used by wsdisplay to implement scrolling in the most efficient way provided by the hardware. vcons provides default (inefficient) implementations of these methods, but the upper drivers like radeonfb can provide hardware-accelerated specializations when instantiating vcons. vcons also interacts with <a href=\"https://man.netbsd.org/wsfont.4\">wsfont(4)</a> to render text to the console.</p></li></ol><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" width=\"1456\" height=\"637\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8368000-8d05-4451-beec-27f355c41828_1920x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":637,\"width\":1456,\"resizeWidth\":null,\"bytes\":76696,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Layered architecture of wskbd and its backing devices, including the optional wsmux wrapper.</figcaption></figure></div><p>The input architecture of wscons is similar in terms of layering of devices, albeit somewhat simpler:</p><ol><li><p><a href=\"https://man.netbsd.org/wsmux.4\">wsmux(4)</a> is an optional component that multiplexes multiple input devices under a single virtual device for event extraction.</p></li><li><p><a href=\"https://man.netbsd.org/wsbkd.4\">wskbd(4)</a> sits at the top of the stack (not accounting for wsmux) and implements generic keyboard handling. The functionality at this level includes translating keycodes to layouts, handling key input repetition, and more. wskbd exposes a stream of wsevents to user-space so that user-space can process state changes (e.g. key presses).</p></li><li><p>Under wskbd sit the device drivers that know how to deal with specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/ukbd.4\">ukbd(4)</a> for USB keyboard input and <a href=\"https://man.netbsd.org/pckbd.4\">pckbd(4)</a> for PC/AT keyboard input. These drivers wait for hardware input, generate events, and provide a map of keycodes to key symbols to the upper layer so that wskbd can operate in generic terms.</p></li></ol><p>The input architecture can handle other types of devices like mice and touch panels (both via <a href=\"https://man.netbsd.org/wsmouse.4\">wsmouse(4)</a>), but I’m not going to cover those here. Just know that they sit under wsmux at the equivalent level of wskbd and produce a set of wsevents in the exact same manner as wskbd.</p><h1><strong>Querying framebuffer properties</strong></h1><p>As you can sense from the overview, the whole architecture under wsdisplay is geared towards video devices… if it wasn’t for the vga driver: in the common case, wsdisplay is backed by a graphical framebuffer managed by vcons for text rendering, yet the user only sees a textual console. But if the kernel has direct access to the framebuffer, so should user-space too.</p><p>The details on how to do this click if you read through the operations described in the wsdisplay manual page. In particular, you may notice the <code>WSDISPLAYIO_GET_FBINFO</code> call which retrieves extended information about, you guessed it, a framebuffer display.</p><p>Let’s try it: I wrote a trivial program to open the display device (named <code>/dev/ttyE0</code> for reasons that escape me), call this function, and store the results in an <code>fbinfo</code> structure:</p><pre><code>// wsdisplay-fbinfo.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-fbinfo.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
close(fd);
exit(EXIT_SUCCESS);
}</code></pre><p>Hmm, but this program does not have any visible output, right? The code just queries the framebuffer information and does nothing with it. The reason is that the content of the <code>wsdisplayio_fbinfo</code> structure is large and I didn’t want to pretty-print it myself. I thought it’d be fun to show you how to use GDB to inspect large data structures and how to script the process. Here, look:</p><pre><code>gdb -q \\
-ex 'set print pretty on' \\
-ex 'break exit' \\
-ex 'run' \\
-ex 'frame 1' \\
-ex 'print fbinfo' \\
-ex 'cont' \\
-ex 'quit' \\
./wsdisplay-fbinfo</code></pre><p>This call to GDB starts the sample program shown above and automates various GDB commands to set a breakpoint, step through the program, and pretty-print the <code>fbinfo</code> structure right before exiting. When we execute this command as root (which is important to get access to the <code>/dev/ttyE0</code> device), we get this:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" width=\"1013\" height=\"872\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":872,\"width\":1013,\"resizeWidth\":null,\"bytes\":96166,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Content of the fbinfo structure as grabbed by the sample wsdisplay-fbinfo program and printed by GDB.</figcaption></figure></div><p>Neat. We get sensible stuff from the kernel! <code>fbi_width</code> is 640 and <code>fbi_height</code> is 480, which matches the 640x480 resolution I have configured in my test VM.</p><h1><strong>Drawing to the framebuffer</strong></h1><p>But note these other fields in the structure printed above:</p><pre><code>struct wsdisplayio_fbinfo {
uint64_t fbi_fbsize;
uint64_t fbi_fboffset;
// ... more fields ...
}</code></pre><p>The <code>fbi_fbsize</code> and <code>fbi_fboffset</code> fields are <em>begging</em> us to use <code>mmap</code> to memory-map the area of the device starting at <code>fbi_fboffset</code> and spanning <code>fbi_fbsize</code> bytes. Presumably we can write to the framebuffer if we do this, but beforehand, we have to switch the console to “framebuffer mode” by using the <code>WSDISPLAYIO_SMODE</code> (“set mode”) call. This call accepts an integer to indicate which mode to set:</p><ul><li><p><code>WSDISPLAYIO_MODE_EMUL</code>: Set the display to emulating (text) mode. This is the default operation mode of wsdisplay and configures the console to “emulate” a text terminal.</p></li><li><p><code>WSDISPLAYIO_MODE_MAPPED</code>: Set the display to mapped (graphics) mode. This allows access to the framebuffer and allows the <code>mmap</code> operation to succeed.</p></li><li><p><code>WSDISPLAYIO_MODE_DUMBFB</code>: Set the display to mapped (framebuffer) mode. This is similar to <code>WSDISPLAYIO_MODE_MAPPED</code> and, for our purposes in the demo below, works the same. I haven’t found a concise description of how these two differ, but from my reading of the code, the “mapped” mode offers access to the framebuffer as well as device-specific control registers, whereas “dumb framebuffer” just exposes the framebuffer memory.</p></li></ul><p>In any case. Once we know that we have to switch the console device to a graphical mode before mapping the framebuffer, and having access to the pixel format described in the <code>fbinfo</code> structure… drawing something fun is just a few byte manipulation operations away:</p><pre><code>// wsdisplay-draw.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-draw.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
// Ensure the framebuffer aligns with the expectations of our demo
// code below.
if (fbinfo.fbi_bitsperpixel != 32)
errx(1, \"bitsperpixel not supported by this demo\");
if (fbinfo.fbi_pixeltype != WSFB_RGB)
errx(1, \"pixeltype not supported by this demo\");
// Configure the wsdisplay to enter \"dumb framebuffer\" mode.
unsigned int mode = WSDISPLAYIO_MODE_DUMBFB;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1)
err(1, \"ioctl failed\");
// Map the framebuffer memory.  Must come after the SMODE ioctl.
uint32_t *ptr = (uint32_t*)mmap(
0, fbinfo.fbi_fbsize, PROT_READ | PROT_WRITE, MAP_SHARED,
fd, fbinfo.fbi_fboffset);
if (ptr == MAP_FAILED)
err(1, \"mmap failed\");
// Fill the screen multiple times with pixels of different
// colors to render a simple animation.
size_t pixels = fbinfo.fbi_fbsize / sizeof(uint32_t);
int off = 0;
for (int i = 0; i < 100; i++) {
int r = off; int g = off; int b = off;
for (size_t i = 0; i < pixels; i++) {
r = (r + 1) % 255; g = (g + 2) % 255; b = (b + 3) % 255;
ptr[i] = 0
| (r << fbinfo.fbi_subtype.fbi_rgbmasks.red_offset)
| (g << fbinfo.fbi_subtype.fbi_rgbmasks.green_offset)
| (b << fbinfo.fbi_subtype.fbi_rgbmasks.blue_offset);
}
off += 10;
usleep(1);
}
// Configure the wsdisplay to enter \"console emulation\" mode.
// In other words: return to the console.
mode = WSDISPLAYIO_MODE_EMUL;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1) {
err(1, \"ioctl failed\");
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"26c68357-8900-4c06-a98e-3456d2792a08\",\"duration\":null}\"></div><p>Voila. We’ve got graphics without paying the X11 startup tax. Switching from the console to graphics is instantaneous, like in the good old mode 13h days.</p><h1><strong>Handling keyboard input</strong></h1><p>Rendering graphics is just half of the puzzle when writing an interactive application though. The other half is handling input. And, for that, we have to turn to the wskbd device.</p><p>After we switch the console to mapped mode, keystrokes don’t go to <code>stdin</code> anymore. We have to write code to explicitly read from an attached keyboard, and we can do this via the <code>/dev/wskbd0</code> device representing the first attached keyboard.</p><p>Once we open the keyboard device for reading, wscons sends us its own representation of events known as wsevents. We can write a trivial program to read one key press:</p><pre><code>// wskbd-trivial.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-trivial.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Wait for one key down press only.
for (;;) {
struct wscons_event ev;
int ret = read(fd, &ev, sizeof(ev));
if (ret == -1)
err(1, \"read failed\");
if (ev.type == WSCONS_EVENT_KEY_DOWN) {
printf(\"value: %d, char '%c'\\n\", ev.value, (char)ev.value);
break;
}
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>But… if we try to run it and press a key, say <code>k</code>, we might get:</p><pre><code># ./wskbd-trivial
value: 37, char '%'
# █</code></pre><p>Huh. We pressed <code>k</code> but the character we got is <code>%</code>. Not what we expected! Well, as it turns out, the “value” that wsevents report for key presses (37 in this case) is the raw keycode of the key. This is hardware-specific and needs to be translated to an actual symbol via a keymap.</p><p>One feature of wskbd is that it exposes the keymap as configured in the kernel so there is a single source of truth for the machine. We can query a portion of it with another program:</p><pre><code>// wskbd-map.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-map.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <dev/wscons/wsksymdef.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Allocate space for the biggest possible keymap.
struct wscons_keymap map[WSKBDIO_MAXMAPLEN];
memset(map, 0, sizeof(struct wscons_keymap) * WSKBDIO_MAXMAPLEN);
// Get the keymap from the device.
struct wskbd_map_data data;
data.maplen = WSKBDIO_MAXMAPLEN;
data.map = map;
if (ioctl(fd, WSKBDIO_GETMAP, &data) == -1)
err(1, \"ioctl failed\");
// Dump keymap entries.
printf(\"Keymap length: %u entries\\n\", data.maplen);
for (size_t i = 0; i < data.maplen; i++) {
// Skip printing entries that are not for letters.
if (map[i].command != KS_voidSymbol)
continue;
char normal = map[i].group1[0];
char shifted = map[i].group1[1];
if (normal < 'a' || normal > 'z')
continue;
printf(\"Keycode %zd: '%c', '%c'\\n\", i, normal, shifted);
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run it, we might get:</p><pre><code># ./wskbd-map
Keymap length: 222 entries
Keycode 16: 'q', 'Q'
Keycode 17: 'w', 'W'
Keycode 18: 'e', 'E'
Keycode 19: 'r', 'R'
Keycode 20: 't', 'T'
Keycode 21: 'y', 'Y'
Keycode 22: 'u', 'U'
Keycode 23: 'i', 'I'
Keycode 24: 'o', 'O'
Keycode 25: 'p', 'P'
Keycode 30: 'a', 'A'
Keycode 31: 's', 'S'
Keycode 32: 'd', 'D'
Keycode 33: 'f', 'F'
Keycode 34: 'g', 'G'
Keycode 35: 'h', 'H'
Keycode 36: 'j', 'J'
Keycode 37: 'k', 'K'
Keycode 38: 'l', 'L'
Keycode 44: 'z', 'Z'
Keycode 45: 'x', 'X'
Keycode 46: 'c', 'C'
Keycode 47: 'v', 'V'
Keycode 48: 'b', 'B'
Keycode 49: 'n', 'N'
Keycode 50: 'm', 'M'
# █</code></pre><p>This dump is telling us how keycodes map to symbols, both in “normal” and in shifted form. If we look up keycode 37, we indeed find the letter <code>k</code>. With this, it’s just an <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">SMOP</a> to come up with a program that parses the keymap as exposed by wskbd and converts keycodes to something useful.</p><p>This is all good and dandy, but what happens if the keyboard is not connected when you try to open <code>/dev/wskbd0</code>? (Spoiler: the <code>open</code> call fails.) Or what happens if your computer has more than one keyboard attached? (Spoiler: you can only read events from one.) This is where wsmux comes to the rescue—a device driver that multiplexes multiple input devices into one.</p><p>By default, the system reserves <code>/dev/wsmux0</code> as the multiplexer for all attached mice and <code>/dev/wsmux1</code> as the multiplexer for all attached keyboards. We can define our own too via the <a href=\"https://man.netbsd.org/wsmuxctl.8\">wsmuxctl(8)</a> command line utility.</p><p>wsmux then supports “hot plugging”. You can then open a <code>/dev/wsmuxN</code> device even when there is no physical hardware attached, and whenever a peripheral is connected, it automatically becomes part of the mux. So, if we modify the program above to open <code>/dev/wsmux1</code> instead of <code>/dev/wskbd0</code>, the program will be resilient to missing keyboards and it’ll recognize multiple keyboards. Easy peasy!</p><h1><strong>What will you build?</strong></h1><p>You are now equipped with the basics to write graphical applications on a NetBSD system (and maybe OpenBSD too) without running X11. I know NetBSD may not be your jam, but it is a good choice for embedded projects due to its console architecture and other features like <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">its build system</a>.</p><p>If the code above still seems mysterious, you can read the source code for the <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-video-wsfb/\">xf86-video-wsfb</a> and <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-input-ws/\">xf86-input-ws</a> drivers for X.org. The code is easy enough to read, although it is longer because it has to support all the bells and whistles of wsdisplay and wskbd. (I took shortcuts above by making various assumptions on pixel formats and the like.)</p><p>And, guess what, I am indeed working on an embedded project! A little dev box that can boot straight into EndBASIC with super-fast boot times and for which I couldn’t afford the X11 startup penalty.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"d3e4a900-0eb8-4548-91af-41244b377297\",\"duration\":null}\"></div><p>Stay tuned. In the meantime, what will <em>YOU</em> build? For those of us in the U.S., there is a 3-day weekend ahead and this can be a good distraction. Have fun!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you enjoyed this walk-through, don’t hesitate to subscribe to Blog System/5. It’s free and you’ll receive more articles like this one.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "0.0" "image/jpeg") nil "dfd086d3d3a62968e01f7690880eae42") (55 (26633 14283 75697 138000) "https://blogsystem5.substack.com/p/glibc-versions-runtime" "Picking glibc versions at runtime" "Julio Merino" "Sun, 11 Aug 2024 08:15:13 +0000" "<p>In a recent work discussion, I came across an argument that didn’t sound quite right. The claim was that we needed to set up containers in our developer machines in order to run tests against a modern glibc. The justifications were that using <code>LD_LIBRARY_PATH</code> to load a different glibc didn’t work and statically linking glibc wasn’t possible either.</p><p>But… running a program against a version of glibc that’s different from the one installed on the system seems like a pretty standard requirement, doesn’t it? Consider this: how do the developers of glibc test their changes? glibc has existed for much longer than containers have. And before containers existed, they surely weren’t testing glibc changes by installing modified versions of the library over the system-wide one and YOLOing it.</p><p>So. What options do we really have? To answer this question, we need to look at how dynamic binaries work and what glibc is.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Static binaries</h1><p>Static binaries are binaries whose program code is all contained in one executable. Such binaries can access system services via system calls—or else their utility would be minimal because they wouldn’t be able to interact with the OS—but their binary code is, in a sense, “complete”: what you see in the executable is exactly what gets laid out in memory for execution.</p><p>Here is how a sample static binary looks like. This is for a “hello world” program written in Go, which was the easiest thing to put together because Go is designed to bypass the C library <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">almost everywhere</a>:</p><pre><code><code>$ file hello_go
hello_go: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=2H_kXH_UFAOR5K6ibAke/aj_2VBvakhN2KujNxtMN/K5TtKP8HHiX65VdbA19s/KxdoZHQEiOxCEbwRE346, with debug_info, not stripped
$ █</code></code></pre><p>In the above, note that <code>file</code> claims that our sample <code>hello_go</code> program is <em>statically linked</em>.</p><p>When we ask the shell to run this <code>hello_go</code> binary, the shell forks a new process and uses the <code>exec(2)</code> family of system calls to replace the running image of the process with the content of <code>hello_go</code>. And because <code>hello_go</code> is statically linked, the text segment of the binary is loaded verbatim into the process.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" width=\"761\" height=\"261\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/edd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":261,\"width\":761,\"resizeWidth\":null,\"bytes\":9791,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of how a static binary is directly mapped into a process when executed.</figcaption></figure></div><h1>Dynamic binaries</h1><p>Let’s compare the above to a dynamically-linked binary by looking at the same “hello world” program written in C and linked against glibc:</p><pre><code><code>$ file hello_c
hello_c: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=feeb95b014ef8151780e23fc7ca15de0599f05df, for GNU/Linux 3.2.0, not stripped
$ █</code></code></pre><p>Note that <code>file</code> now claims that our sample <code>hello_c</code> program is <em>dynamically linked</em> and, indeed, if we look at its libraries—quick reminder: <a href=\"https://jmmv.dev/2023/07/ldd-untrusted-binaries.html\">don’t use ldd on untrusted executables</a>!—we see that glibc (<code>libc.so.6</code>) is there:</p><pre><code><code>$ ldd hello_c
linux-vdso.so.1 (0x00007f54f25aa000)
libc.so.6 => /lib64/libc.so.6 (0x00007f54f239b000)
/lib64/ld-linux-x86-64.so.2 (0x00007f54f25ac000)
$ █</code></code></pre><p>But wait a second. There is more than just <code>libc.so.6</code> in the output of <code>ldd</code>. In particular, there is this other <code>/lib64/ld-linux-x86-64.so.2</code> “library” and, if you pay close attention to the earlier output of <code>file</code>, you’ll note that it claims that this is an <em>interpreter</em>. Why is there an “interpreter” if we are running machine code?! Did they lie to us when they said C was a compiled language?</p><p>Not so fast, no. “Interpreter” in this case should be read as “loader”, but the “interpreter” word comes from the nomenclature of the ELF headers stored in the program:</p><pre><code><code>$ readelf -l hello_c
Elf file type is EXEC (Executable file)
Entry point 0x401040
There are 13 program headers, starting at offset 64
Program Headers:
Type           Offset             VirtAddr           PhysAddr
FileSiz            MemSiz              Flags  Align
...
INTERP         0x0000000000000318 0x0000000000400318 0x0000000000400318
0x000000000000001c 0x000000000000001c  R      0x1
[Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
...
$ █</code></code></pre><p>To understand what this interpreter thing is all about, we need to look at what a dynamically-linked executable is. In essence, the program code in the binary is not <em>complete</em>: the code contains “gaps” in it that need to be filled with references to portions of code supplied by other libraries before it can begin executing. We can peek into what these “gaps” are:</p><pre><code><code>$ readelf -r hello_c
Relocation section '.rela.dyn' at offset 0x4c0 contains 2 entries:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000403fd8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 __libc_start_main@GLIBC_2.34 + 0
000000403fe0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0
Relocation section '.rela.plt' at offset 0x4f0 contains 1 entry:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000404000  000200000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
$ █</code></code></pre><p><code>readelf</code> tells us that the <code>hello_c</code> binary has three different “relocations”: in other words, it has three different “gaps” that need to be patched at runtime with the address of the code that supplies those symbols. The program <em>cannot run</em> without those being filled in first. So if it cannot begin executing before those references are resolved, how does the program run?</p><p>You might think that the kernel is somehow responsible for dealing with dynamic libraries, but that’s not the case. Dynamic libraries are a user-space concept and this is precisely where the interpreter comes into play.</p><p>When we ask the kernel to <code>exec(2)</code> a dynamically-linked ELF binary, the kernel loads the <em>interpreter</em> into the process image, <em>not</em> the code of the binary, and passes the path of the binary to the interpreter.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" width=\"761\" height=\"521\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":521,\"width\":761,\"resizeWidth\":null,\"bytes\":36593,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of how a dynamic binary is loaded into memory with the help of the dynamic linker, along with glibc and the fixup of a relocation.</figcaption></figure></div><p>The interpreter, <a href=\"https://man7.org/linux/man-pages/man8/ld.so.8.html\">ld-linux.so</a> in our case, is then in charge of setting up the remaining of the process by loading all required shared libraries into the process and then resolving relocations (“filling the gaps”) among them. In particular, the dynamic linker is the one that loads glibc into the process.</p><p>We can see that this is the case by asking the dynamic linker to print its own file accesses by setting <code>LD_DEBUG=files</code>:</p><pre><code><code>$ LD_DEBUG=files /lib64/ld-linux-x86-64.so.2 ./hello_c
75369:     file=./hello_c [0];  generating link map
75369:       dynamic: 0x0000000000403e08  base: 0x0000000000000000   size: 0x0000000000004010
75369:         entry: 0x0000000000401040  phdr: 0x0000000000400040  phnum:                 13
75369:
75369:
75369:     file=libc.so.6 [0];  needed by ./hello_c [0]
75369:     file=libc.so.6 [0];  generating link map
75369:       dynamic: 0x00007f9aad868960  base: 0x00007f9aad682000   size: 0x00000000001f0b70
75369:         entry: 0x00007f9aad6ac260  phdr: 0x00007f9aad682040  phnum:                 14
75369:
75369:
75369:     calling init: /lib64/ld-linux-x86-64.so.2
75369:
75369:
75369:     calling init: /lib64/libc.so.6
75369:
75369:
75369:     initialize program: ./hello_c
75369:
75369:
75369:     transferring control: ./hello_c
75369:
Hello, world!
75369:
75369:     calling fini:  [0]
75369:
75369:
75369:     calling fini: /lib64/libc.so.6 [0]
75369:
75369:
75369:     calling fini: /lib64/ld-linux-x86-64.so.2 [0]
75369:
$ █</code></code></pre><p>As a final note, see how I chose to invoke the dynamic linker <em>explicitly</em>—just as the kernel would do when asked to launch a dynamically-linked binary—instead of directly running <code>hello_c</code>.</p><h1>Playing with glibc</h1><p>OK, now that we know how a dynamically-linked ELF executable is loaded into memory, let’s play with glibc.</p><p>First, we download glibc, build and install it into a temporary directory like <code>/tmp/sysroot/</code>:</p><pre><code><code>$ git clone https://sourceware.org/git/glibc.git
$ cd glibc
glibc$ git checkout release/2.40/master
glibc$ mkdir build
glibc/build$ ../configure --prefix=/tmp/sysroot
glibc/build$ make -j $(nproc)
glibc/build$ make -j $(nproc) install
glibc/build$ █</code></code></pre><p>With that done, we should be able to use the new glibc. But…</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib ./hello_c
Floating point exception (core dumped)
$ █</code></code></pre><p>Kaboom.</p><p>Indeed, as my coworker claimed, it doesn’t seem to be possible to load a different glibc at runtime than the one provided by the system. (YMMV. I got this to work on another system.) Looking at the stack trace of the core dump, we see:</p><pre><code><code>Stack trace of thread 75841:
#0  0x00007f227d93903b n/a (/tmp/sysroot/lib/libc.so.6 + 0x15403b)
#1  0x00007f227d9f19f6 _dl_sysdep_start (ld-linux-x86-64.so.2 + 0x1c9f6)
#2  0x00007f227d9f335e _dl_start_final (ld-linux-x86-64.so.2 + 0x1e35e)
#3  0x00007f227d9f2048 _start (ld-linux-x86-64.so.2 + 0x1d048)</code></code></pre><p>Our process is crashing within glibc as soon as it is loaded by <code>ld-linux.so</code>. The details of the crash are not interesting for our purposes, but can we do anything about them?</p><h1>Playing with the dynamic linker</h1><p>What’s more interesting is to peek into what’s shipped by glibc. We can do this by looking under the <code>/tmp/sysroot/</code> hierarchy that we generated earlier and finding:</p><pre><code><code>$ ls /tmp/sysroot/lib/
...
ld-linux-x86-64.so.2
...
libc.so
libc.so.6
...
$ █</code></code></pre><p>There is <em>a ton</em> more stuff in there. But what’s important to notice is that <em>the dynamic linker ships with glibc</em>. The two are closely coupled, and using one without the other can lead to the kinds of crashes shown earlier.</p><p>And remember: as we saw above, it is possible to manually launch the dynamic linker. So if we do the following:</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We don’t get a crash anymore. What’s even better is that we also <em>seem</em> to get what we expect without even setting <code>LD_LIBRARY_PATH</code>:</p><pre><code><code>$ /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We should confirm that the previous invocation of <code>hello_c</code> is actually using our own glibc version and not the system-supplied one. To do that, we can <code>strace</code> the dynamic linker; it’s just a program after all:</p><pre><code><code>$ strace /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Indeed, <code>hello_c</code> did use the newly-built glibc by “just” asking the newly-built dynamic loader to execute the binary.</p><p>To summarize, glibc ships both the <code>ld-linux.so</code> dynamic linker and the <code>libc.so.6</code> shared library. The two are closely coupled. Running a binary against the C library without also using a matching dynamic linker can lead to crashes. But running a binary directly with a specific dynamic linker ensures that the binary picks up the matching C library.</p><h1>Putting this to use</h1><p>Alright, now that we know that it is actually possible to run a binary against a version of glibc that’s <em>not</em> the one provided by the system, we can try to solve the original problem we faced: running tests against a modern glibc.</p><p>One possibility is to modify the commands used to run the tests to prefix them by <code>.../lib/ld-linux-x86-64.so.2</code>. This could work but I posit is difficult to integrate with a test execution environment because we don’t necessarily control the commands that end up executing the test binaries.</p><p>Another possibility is to modify the way the tests programs are being built by supplying additional linker arguments—say, via the traditional <code>LDFLAGS</code>—to point the linker at a different interpreter with the <code>--Wl,--dynamic-linker</code> flag:</p><pre><code><code>$ cc -o hello_c -Wl,--dynamic-linker=/tmp/sysroot/lib/ld-linux-x86-64.so.2 hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Better. Now the built binary “knows” which glibc to use without us having to specify it explicitly every time we attempt to launch the program.</p><p>What if we aren’t <em>building</em> the binaries? What if we are just reusing a binary that already exists? <code>patchelf</code> to the rescue:</p><pre><code><code>$ cc -o hello_c hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/lib64/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ patchelf --set-interpreter /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Voila. We have modified an existing executable to use whichever glibc we desire.</p><h1>Versioning glibc</h1><p>But hold on a second. Can we use <em>whichever</em> glibc really? Is it actually true that glibc versions are completely interchangeable? Unfortunately not.</p><p>A binary built against an old version of glibc is guaranteed to run against a newer version of glibc without recompilation. But the counterpart is not true: a binary built against a new glibc may not run against an older glibc.</p><p>This poses a problem: how can we upgrade glibc across separate production and development environments? If we upgrade production first, binaries built in development environments will continue to work properly but developers may not be able to reproduce bugs found in production. And if we upgrade development environments first, the binaries they produce may be incompatible with production, leading to random crashes later on.</p><p>Here is an idea I’ve seen work in the past: let’s extend the sysroot concept presented above and version it!</p><p>We start with <code>/usr/sysroot/v1/</code> which contains the first version of the core system libraries we have to support. All binaries that we build for production deployment are explicitly linked against the <code>ld-linux.so</code> of this directory, so they are always validated against <code>v1</code> of the sysroot. <code>v1</code> remains immutable, which means new builds of the binaries will continue to work as tested in the past.</p><p>Whenever we want to upgrade glibc, we create a <em>new</em> sysroot, <code>/usr/sysroot/v2/</code>. This new <code>v2</code> is deployed to all environments (development and production) that may need to use the new glibc. This deployment step is risk-free because nothing is yet dependent on <code>v2</code>. After that, we proceed to rebuild all binaries that we want to test and run, this time pointing at the <code>ld-linux.so</code> within <code>v2</code>. Deploying these new binaries causes them to use the new version.</p><p>As long as the <code>/usr/sysroot/</code> subdirectories remain immutable and synchronized across all environments in which binaries run, we are guaranteed to always get a deterministic version of glibc for a given binary.</p><p>That’s just a design sketch though. It may or it may not work for you. As I mentioned earlier, I’ve seen this work well in a large corporate environment before, but it introduces some extra complexity that you need to take care of.</p><div><hr></div><p>What’s the moral of the story? Containers are, usually, not the best solution to a systems problem. While they might be coerced to deliver the desired results, they come with a heavy cost. Unix has been around for a long time and there exist alternate solutions to problems that don’t require full replicas of a functioning system. A ton of the bloat we face today in development tools and deployments comes from the abuse of heavyweight containers. So, every time you think “containers!”, pause to explore alternatives—you may find cheaper, more portable, and simpler solutions.</p><p>If you want to learn more about this and related topics, I’d recommend grabbing a copy of the classic <a href=\"https://www.amazon.com/Linkers-Kaufmann-Software-Engineering-Programming/dp/1558604960?&linkCode=ll1&tag=blogsystem5-20&linkId=421e6bc20c93925de6766b135a24239a&language=en_US&ref_=as_li_ss_tl\">“Linkers and Loaders” book</a>. It’s old, but it’s still very relevant.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "0.0" "image/jpeg") nil "c8846fad66c8098adee823ad1599a271") (54 (26633 14283 68427 36000) "https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an" "Porting the EndBASIC console to an LCD" "Julio Merino" "Fri, 26 Apr 2024 20:31:02 +0000" "<p>Hello again Blog System/5 and sorry for the radio silence for the last couple of months. I had been writing too much in here and neglecting my side projects so I <em>needed</em> to get back to them. And now that I’ve made significant progress on cool new features for <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, it’s time to write about them a little!</p><p>One of the defining characteristics of EndBASIC is its hybrid console: what looks like a simple text terminal at first glance can actually render overlapping graphics and text <em>at the same time</em>. This is a feature that I believe is critical to simplify learning and it first appeared with <a href=\"https://jmmv.dev/2021/11/endbasic-0.8.html\">the 0.8 release</a> back in 2021.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" width=\"852\" height=\"452\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":452,\"width\":852,\"resizeWidth\":null,\"bytes\":45704,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">EndBASIC's hybrid console running in the web browser, rendering text and overlapping graphics at once, all controlled from the built-in command prompt.</figcaption></figure></div><p>A few months before that, I had added support for simple GPIO manipulation in <a href=\"https://jmmv.dev/2021/02/endbasic-0.6.html\">the 0.6 release</a> and, around that same time, I impulse-bought a tiny LCD for the Raspberry Pi with the hope of making the console work on it. But life happened and I lost momentum on the project… until recently.</p><p>In this post, I’ll guide you through the process of porting the EndBASIC hybrid console to the ST7735s 1.44\" LCD shown below, which sports a resolution of 128x128 pixels, a D-pad, and 3 other buttons. I will cover the prerequisite work to make the port possible, dig into the GPIO and SPI interface of an LCD, outline the design for a fast rendering engine, and conclude with pointers for you to build your own “developer kit”. Let’s go!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":838133,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The <a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">ST7735s 1.44\" LCD</a>. Photo from back when I first unboxed this little device... on February 7th, 2021.</figcaption></figure></div><h1>Previous implementation</h1><p>Even though I had plans to support graphics in the EndBASIC console from the very beginning, the first versions of the product did <em>not</em> support graphics. That fact didn’t prevent me from defining a <code>Console</code> abstraction anyway because I needed to support various operating systems and, more importantly, write <a href=\"https://jmmv.dev/2020/12/unit-testing-a-console-app.html\">unit tests for the console</a>. Such abstraction was a straightforward trait representing text-only operations, like this:</p><pre><code><code>trait Console {
fn clear(&mut self, how: ClearType) -> io::Result<()>;
fn color(&self) -> (Option<u8>, Option<u8>);
fn print(&mut self, text: &str) -> io::Result<()>;
// ... and more text operations ...
}</code></code></pre><p>Later on, when the time came to add graphics support, I extended the <code>Console</code> trait with additional rendering primitives, like this:</p><pre><code><code>trait Console {
// ... same as previous ...

fn draw_circle(&mut self, _center: PixelsXY, _radius: u16)
-> io::Result<()>
{
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}

fn draw_pixel(&mut self, _xy: PixelsXY) -> io::Result<()> {
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}
// ... and more graphics operations ...
}</code></code></pre><p>What constitutes a primitive or not depends on the graphics device. In the snippet above, it’s fairly easy to understand why <code>draw_pixel</code> exists. But why is <code>draw_circle</code> there? SDL2, for example, does not provide a circle drawing primitive and forces you to implement your own algorithm on top of individual pixel plotting. However, the HTML <code>canvas</code> element <em>does</em> provide such a primitive and thus it is important to expose access to it for performance reasons.</p><p>A reasonable design, right?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to support my writing and my work in projects like EndBASIC. It’s free but donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Not quite. The problem is that mixing the textual and graphical operations under just one abstraction bundles two concepts together. Take, for example, the innocent-looking <code>print</code> function: writing text to the console requires knowing the current cursor position, writing text at that location, wrapping long lines, and then updating the cursor position and moving its glyph. This sequence of operations is given to us “for free” when the <code>Console</code> is backed by a terminal—the kernel or terminal emulator handle all details—but none of this exists when you stare at a blank graphical canvas.</p><p>As a result, the SDL2 and the HTML canvas console implementations had to supply their own code to represent a textual console on top of their backing graphical canvases. But due to tight timelines—I wanted to release graphics support <a href=\"https://vimeo.com/641791002\">in time for a conference</a>—I ended up with <em>a lot</em> of copy/pasted code between the two. Unfortunately, it wasn’t just copy/pasted code. Oh no. It was copy/pasted code with minor variations throughout. For example: SDL2 coordinates are <code>i32</code> whereas HTML canvas coordinates are <code>float</code>s.</p><p>This duplication with minor differences required unification before attempting to write a console driver for the LCD because I could not afford to introduce yet another duplicate of the same code.</p><h1>Past NetBSD experience to the rescue</h1><p>The first step to resolving this conundrum was to unify the implementation of the two graphical consoles as much as possible. Having worked on <a href=\"https://www.netbsd.org/docs/guide/en/chap-cons.html\">NetBSD’s wscons console framework</a> eons ago, I knew how this had to be done.</p><p>The idea was to separate the text console manipulation from the underlying graphics primitives. As you can imagine, the way to do this was via a new abstraction, <code>RasterOps</code>, providing direct access to the “raster operations” of the graphics device. Take a look:</p><pre><code><code>trait RasterOps {
fn draw_circle(&mut self, center: PixelsXY, radius: u16)
-> io::Result<()>;
fn draw_pixel(&mut self, xy: PixelsXY) -> io::Result<()>;
fn move_pixels(&mut self, x1y1: PixelsXY, x2y2: PixelsXY,
size: SizeInPixels) -> io::Result<()>;
fn write_text(&mut self, xy: PixelsXY, text: &str)
-> io::Result<()>;
// ... and more operations ...
}</code></code></pre><p>As you can see in this snippet, the earlier operations <code>draw_circle</code> and <code>draw_pixel</code> exist as raster operations because some devices may provide them as primitives. But we now see other functions like <code>move_pixels</code> and <code>write_text</code> (which differs from <code>print</code> because it writes text at a specific pixel location, not at the “current cursor position”) and these are meant to expose other primitives of the device.</p><p>Having done this, I added a new <code>GraphicsConsole</code> type that encapsulates the logic to implement a terminal backed by an arbitrary graphical display, and then relies on a specific implementation of the <code>RasterOps</code> trait to do the screen manipulation:</p><pre><code><code>impl<RO> Console for GraphicsConsole<RO>
where
RO: RasterOps,
{
// ... implement Console in terms of RasterOps ...
}</code></code></pre><p>Most details of this refactor are uninteresting at this point, except for the fact that it eliminated all of the tricky duplicate code between the SDL2 and HTML canvas variants. A side-effect was that these changes increased my confidence in the HTML canvas variant because most code was now unit-tested indirectly via the SDL2 implementation. Here is how the simplification looked like:</p><pre><code><code>$ wc -l {before,after}/sdl/src/host.rs {before,after}/web/src/canvas.rs
1245 before/sdl/src/host.rs
887 after/sdl/src/host.rs     # 358 fewer lines
760 before/web/src/canvas.rs
444 after/web/src/canvas.rs   # 320 fewer lines</code></code></pre><p>I was now ready to reuse the <code>GraphicsConsole</code> to quickly provide a new backend on top of the LCD.</p><h1>Playing with the C interface</h1><p>With the foundational abstractions in place, it was time to prove that my idea of rendering the EndBASIC console on the tiny LCD was <s>feasible</s> cool enough to pursue. But I knew absolutely nothing about the LCD so, before diving right into the “correct” implementation, I had to create a prototype to get used to its API.</p><p>Fortunately, I found an “SDK”—and I put it in quotes because SDK is quite an overstatement—for the LCD somewhere online. The SDK consists of a pair of C and Python libraries that provide basic graphics drawing primitives, text rendering, and access to the D-pad and the buttons. This was a “perfect” finding because the code was simple enough to understand, functional enough to build a prototype, and allowed me to skip reading through the data sheet.</p><p>So I chose to do the easiest thing: I folded the C library into EndBASIC using Rust’s C FFI and quickly implemented a <code>RasterOps</code> on it. With that, I could instantiate a <code>GraphicsConsole</code> backed by the LCD and demonstrate, in just a couple of hours before the crack of dawn, that the idea was feasible. And it was more than feasible: it was super-exciting! Here, witness the very first results:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"413e7dc0-ef87-4c65-acb9-ebe4475e2128\",\"duration\":null}\"></div><p><em>(Caption: First prototype of the EndBASIC console on the ST7735s LCD display, reusing the vendor-provided C library from Rust with lots of hacks.)</em></p><p>But performance was also awful. Using the C library was enough to show that this idea was cool and worth pursuing, but it was not the best path forward. On the one hand, the code in the C library was rather crappy and fragile to integrate into Rust via <code>build.rs</code>; and, on the other hand, I needed precise control of the hardware primitives to achieve good rendering performance levels.</p><h1>The LCD hardware interface</h1><p>Before diving into the solution, let’s take a quick peek at the hardware interface of the LCD. Note that this is just a very simplified picture of what the LCD offers and is derived from my reverse-engineering of the code in the SDK. I’m sure there is more to it, but I do not have the drive to go through the aforementioned data sheet.</p><p>The LCD is a matrix of pixels where each position contains an integer representing the color of the pixel. The representation of each color value depends on the selected pixel format, but what the SDK uses by default is RGB565: a 16-bit value decomposed into two 5-bit quantities for red and blue and one 6-bit quantity for green.</p><p>This is pretty standard stuff for a framebuffer-style device but the mechanism to write to the LCD is different. Unlike most framebuffer devices backed by video cards, the LCD matrix is not memory-mapped: we have to issue specific reads and writes via the GPIO and SPI busses. The GPIO bus is used to control hardware registers and the SPI bus is used to transfer large data sequences.</p><p>Simplifying, the LCD offers just two primitives. The first is a “set window” operation to define the window for rendering. This tells the LCD what rectangular region to update with new pixel values on the <em>subsequent</em> “set data” operation. Executing this operation requires a GPIO write to select the operation followed by an SPI write to set the window position and dimensions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":37047,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set window\" operation.</figcaption></figure></div><p>The second is a “set data” primitive to set the contents of the previously-defined window. This primitive just sends a stream of pixel color values that will be written on the window, top-left to bottom-right. Executing this operation requires a GPIO write to select the operation followed by a “very large” SPI write to write the pixel data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":35405,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set data\" operation.</figcaption></figure></div><p>By default, SPI writes on Linux are limited to 4KB in size and the full LCD content is 128x128 pixels * 2 bytes per pixel = 32KB, which means drawing the whole LCD requires 8 separate SPI writes. (It is possible to raise the default via a kernel setting, which I did too, but let’s ignore that for now.)</p><p>Understanding that the LCD hardware interface is as simple and constrained as this is super-important to devise an efficient higher-level API, which is what we are going to do next.</p><h1>Double-buffering</h1><p>Having figured out the native interface, I faced two problems.</p><p>The first one was performance. Issuing individual “set window” and “set data” commands works great to draw on large portions of the LCD, but sending these commands on a pixel basis as would be necessary to render letters or shapes like circles would be prohibitively slow.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1cb62fe-e6b1-40e8-86b6-43c2a43855db\",\"duration\":null}\"></div><p><em>(Caption: An EndBASIC demo program bouncing a bunch of rectangles on the screen running with the prototype console driver that relied on the C library without double-buffering or damage tracking.)</em></p><p>The second one was the inability to <em>read</em> the contents of the LCD. Certain operations of the console, like moving the cursor or entering/exiting the builtin editor, require saving portions of the screen aside for later restoration. The LCD does not offer an interface to read what it currently displays. (Actually I don’t know because I did not read the data sheet… but even if it does, the reads would involve slow SPI bus traffic which we should avoid.)</p><p>To address these two problems, I decided to implement double-buffering for the LCD: the console driver reserves a portion of main memory to track the content of the LCD and all operations that update the LCD first write to this buffer. This allows the code to decide <em>when</em> to send the buffer to the LCD, allowing it to compose complex patterns in memory—e.g. plotting letters pixel by pixel—before ever touching the GPIO and SPI busses. And this also allows trivially reading portions of the LCD.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":43655,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of the double-buffering and damage tracking techniques.</figcaption></figure></div><p>Which brings me to the next point. Part of this solution required adding damage tracking as well. Flushing the full in-memory buffer to the LCD is expensive—remember, with the default SPI configuration, we need to issue 8 separate writes to flush 32KB of data—and many times, like when moving the cursor around in the editor, this is not necessary. Therefore, it is important to keep track of the portion of the display that has been “damaged” by drawing operations and then only flush that portion of the buffer to the LCD. This maps perfectly well to the hardware primitives offered by the LCD.</p><p>With that in mind, and after a bit of iteration, I ended up splitting the implementation of the LCD <code>RasterOps</code> into two pieces. One is the <code>Lcd</code> trait, which exposes the basic “set window” and “set data” primitives of an LCD as a single <code>set_data</code> operation:</p><pre><code><code>trait Lcd {
fn set_data(&mut self, x1y1: LcdXY, x2y2: LcdXY, data: &[u8])
-> io::Result<()>;

// ... some more stuff ...
}</code></code></pre><p>The other is the <code>BufferedLcd</code> type, which implements the general idea of buffering and damage tracking on top of a generic <code>Lcd</code>:</p><pre><code><code>impl<L> RasterOps for BufferedLcd<L>
where
L: Lcd,
{
// ... implementation of RasterOps in terms of an Lcd ...
}</code></code></pre><p>This design keeps all of the complex logic in one place and, as was the case with the <code>Console</code> abstraction, allowed me to unit-test the tricky corner cases of the double-buffering and damage tracking by supplying a test-only <code>Lcd</code> implementation. This was critical during development because I wrote most of this code while I was on a trip without access to the device, and when I came back home, the “real thing” worked on the first try.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"0ccbf21e-29b2-408b-925c-8bf44056a91b\",\"duration\":null}\"></div><p><em>(Caption: Same EndBASIC demo program as before but running with the improved console that implements double-buffering and damage tracking. No more flickering.)</em></p><p>Invest in Rust and exhaustive unit testing! They really are worth it to deliver working software quickly. But I digress…</p><h1>Font rendering</h1><p>The last interesting part of the puzzle was rendering text. You see: for the previous graphical consoles I wrote based on SDL2 and the HTML <code>canvas</code> element, I was able to use <a href=\"https://www.ibm.com/plex/\">a nice TTF font</a>. But with the LCD… well, the LCD has no builtin mechanism to render text and the very restrictive 128x128 resolution means that most fonts would render poorly at small sizes anyway.</p><p>To solve this problem, I had to implement my own text rendering code, which sounds scary at first but isn’t as hard as it sounds. One issue was coming up with the font data, but the SDK for the LCD came with a free reusable 5x8 font that I took over. Another issue was coming up with a mechanism to efficiently render the letters because plotting them pixel by pixel on the LCD would be unfeasible, but this was solved by the previous buffering and damage tracking techniques.</p><p>Having my own font rendering code is interesting. If you used a BASIC machine back in the 1980s, the computer-supplied manual would show you the glyphs used by the machine like this page demonstrates:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" width=\"600\" height=\"840\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":840,\"width\":600,\"resizeWidth\":null,\"bytes\":240982,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Page 9 of Chapter 7 of the Amstrad CPC 6128 user manual showing the glyphs corresponding to characters 32–48.</figcaption></figure></div><p>In some machines like the Amstrad CPC 6128, you could use the <code>SYMBOL</code> command to define your own glyphs. And in some others, you could <code>POKE</code> the memory locations where the glyphs were stored to (re)define them. So I’m thinking that… maybe I should forget about the TTF font and instead expose a custom bitmap font in all EndBASIC consoles to allow for these neat tricks.</p><h1>Putting it all together</h1><p>And that’s all folks! Having gone through all the pieces involved in providing support for the LCD, we can now connect them all. Here is how the code on the <code>main</code> branch looks like with additional inline commentary:</p><pre><code><code>// Instantiate access to the GPIO bus, required to control the LCD and
// to read the status of the D-pad and buttons.
let mut gpio = Gpio::new().map_err(gpio_error_to_io_error)?;
// Build the struct used to interface with the LCD.
let lcd = ST7735SLcd::new(&mut gpio)?;
// Wrap the low-level LCD with the double-buffering and damage tracking
// features for high speed.
let lcd = BufferedLcd::new(lcd);
// Instantiate the input controller. I haven't covered this in the post
// because it's uninteresting.
let input = ST7735SInput::new(&mut gpio, signals_tx)?;
// Wrap the display and the buttons with the generic graphical console
// logic -- the same one used by the SDL2 and HTML canvas variants.
let inner = GraphicsConsole::new(input, lcd)?;</code></code></pre><p>Even though this looks complex, this composition of three different types keeps the responsibilities of each layer separate. The layers help make the logic simpler to understand, allow the possibility of supporting more LCDs with ease, and make unit-testing a reality. And thanks to Rust’s static dispatch, the overhead of the separate types is minimal.</p><p>Witness the finished result:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"67579827-636e-4903-9d43-307ffdba5dcb\",\"duration\":null}\"></div><p><em>(Caption: EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.)</em></p><h1>Build your own Developer Kit</h1><p>Does the above sound cool? Do you want to play with it? Here are the parts you’ll need to build you own:</p><ul><li><p><strong><a href=\"https://www.amazon.com/ELEMENT-Element14-Raspberry-Pi-Motherboard/dp/B07BDR5PDW?&linkCode=ll1&tag=blogsystem5-20&linkId=cab45a45b3e43934d489486d416be7a0&language=en_US&ref_=as_li_ss_tl\">Raspberry Pi 3 B+</a>:</strong> I suppose a newer model will work but I don’t have one to try it out; let me know if it does! I also have my eyes on the <a href=\"https://www.amazon.com/gp/product/B074P6BNGZ?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=1f5bdad0f78d4512685cda89db5c6d87&language=en_US&ref_=as_li_ss_tl\">Libre Computer Board - Le Potato</a>, but if you go this route, know that it will <em>definitely</em> require extra work in EndBASIC to be functional. Hardware donations welcome if you want me to give it a try 😉.</p></li><li><p><strong><a href=\"https://www.amazon.com/CanaKit-Raspberry-Supply-Adapter-Listed/dp/B00MARDJZ4?&linkCode=ll1&tag=blogsystem5-20&linkId=ef82e298644b68298cd9bf5559b74aaa&language=en_US&ref_=as_li_ss_tl\">CanaKit 5V 2.5A Power Supply</a>:</strong> Yes, the Raspberry Pi is USB-powered but you need a lot of power for it to run properly—particularly if you are going to attach any USB devices like hard disks. Don’t skimp on the power supply. This is the one I have and works well.</p></li><li><p><strong><a href=\"https://www.amazon.com/PNY-Elite-microSDHC-Memory-P-SDU32GU185GW-GE/dp/B07R8GVGN9?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=33a25c49f236d8bd6e8f2259a6c57148&language=en_US&ref_=as_li_ss_tl\">PNY 32GB microSD card</a>:</strong> Buy any microSD card you like. The SD bay is incredibly slow no matter what and 32GB should be plenty for experimentation.</p></li><li><p><strong><a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">waveshare 1.44inch LCD Display HAT 128x128</a>:</strong> The star product of this whole article! You may find other LCD hats and I’m sure they can be made to work, but they’ll require code changes. Hopefully the abstractions I implemented make it easy to support other hats, but I can’t tell yet. Again, hardware donations welcome if you want to keep me busy 😉.</p></li></ul><p>Once you have those pieces, get either Raspbian or Ubuntu, flash the image to the microSD, and boot the machine. After that, you have to build and run EndBASIC from unreleased sources until I release 0.11:</p><pre><code><code>$ cargo install --git=https://github.com/endbasic/endbasic.git --features=rpi
$ ~/.cargo/bin/endbasic --console=st7735s</code></code></pre><p>I know, I know, this is all quite convoluted. You have to manually go through the process of setting up Linux, then installing Rust, and then building EndBASIC from source. All of this is super-slow too.</p><p>Which means… what I want to do next is to build a complete “Developer Kit”, including a lightweight prebuilt SD image that gives you access to EndBASIC out of the box in just a few seconds. Right now I’m playing with downsizing a NetBSD/evbarm build so that the machine can boot quickly and, once I have that ready, I’ll have to port EndBASIC’s hardware-specific features to work on it. I don’t think I’ll postpone 0.11 until this is done, but we’ll see.</p><p>Interested in any of this? Please leave a note! And if you have tried the above at all with your own hardware, post your story too!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for reading and please take a little moment to subscribe to Blog System/5.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "0.0" "image/jpeg") nil "dd80ade8ea1ebb4528008af9544bb613") (53 (26631 55474 553186 335000) "https://blogsystem5.substack.com/p/how-new-type-helps-avoid-production" "How \"new type\" helps avoid production outages" "Julio Merino" "Sat, 09 Mar 2024 18:00:20 +0000" "<p>My <a href=\"https://blogsystem5.substack.com/p/links-january-2024-edition\">January links recap</a> included the <a href=\"https://experimentalworks.net/posts/2024-01-22-simple-phantom-types/\">“Phantom Types”</a> article by David Soria Parra. In it, the author briefly touches upon the “new type” idiom, its typical implementation in Rust, and then proceeds to propose a better alternative. But the question arises: why should you care?</p><p>To answer why this idiom is useful, I want to present you with a real production problem we faced in the Storage Infrastructure team at Google circa 2010. That issue made me a convert and I’ve kept it in mind when designing APIs since then.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":552435,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><h1>What is “new type” anyway?</h1><p>The <a href=\"https://rust-unofficial.github.io/patterns/patterns/behavioural/newtype.html\">“new type” idiom</a> is a programming pattern whereby you define domain-specific types to wrap native types. Then, you use those types in your code and only “lower” them to their underlying types when passing the values to any external APIs.</p><p>More specifically, your public interfaces—but also private methods and functions—should never receive primitive types like integers or strings. A function like <code>allow_write(username: String, size: usize)</code> should not exist in your code base.</p><p>Instead, what you’d do is define two new types, <code>Username</code> and <code>Size</code>, that wrap the string and integer values. These types are trivial wrappers over the native types (e.g. <code>struct Username(String)</code> and <code>struct Size(usize)</code>) with the goal of making them zero-cost abstractions.</p><p>However, as David’s article describes, this simplistic way to implement the pattern lends itself to code duplication for every type. And, as you know, code duplication leads to slight inconsistencies over time, which may increase maintenance costs.</p><p>But this is not relevant now. “New type” is “new type” no matter how you implement it and no matter which language you choose. What I want to showcase here is <em>why</em> adopting this pattern helps at all. And, for that, it’s time to dive into the story.</p><h1>Quota management outage</h1><p>Back in the early days of the Storage Infrastructure at Google, we the SRE team managed tens of shared file system deployments (aka <em>cells</em>). Those file systems were multi-user and had support for quotas—like pretty much any file system worthy of consideration.</p><p>Storage quotas are typically expressed as two quantities: a <em>bytes quota</em>, which says how much disk space a user can use; and a <em>files quota</em>, which says how many files a user can store. Tracking byte usage limits disk usage and tracking file usage limits metadata overhead.</p><p>Now, even with the replicated and zonal system that Google had, it was convenient to <em>manage</em> user quotas in a centralized way. So that’s what we also had: the equivalent of a MySQL database tracking how much quota each user had allocated in which cell, world-wide.</p><p>So far so good. But how do you keep the decentralized storage cells decoupled from the quota database? Easy! Via a cron job that reads the quotas and pushes them to cluster-local “configuration” files so that each cell doesn’t need to know about the central database.</p><p>Of course, this cron job is code. And code has bugs. So here is what happened: there was some function somewhere that looked like this: <code>set_quota(user: String, bytes: usize, files: usize)</code>. And, for whatever reason, a caller invoked it as <code>set_quota(user, files, bytes)</code>.</p><p>Notice the problem? The caller swapped the arguments but the language did not flag this issue and… the tests didn’t catch it either! It’s unfortunately too common for people to write the same sentinel values (<code>set_quota(\"foo\", 100, 100)</code>) for different test arguments.</p><p>Soon after this change was checked in, the code rolled out to production and… of course, the moment it touched the first canary deployment, things went south. Users started receiving out of quota alerts even when they should have had, in theory, plenty of available quota.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to not miss out on any future stories. It’s completely free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The aftermath</h1><p>The fix to the above was trivial: swap the arguments in the problematic caller and call it a day. But that’s a naïve fix. It just corrects the immediate problem but does not minimize the chances of it happening again. That is: this change is a <em>mitigation</em>, not a <em>fix</em>.</p><p>In good SRE fashion, the team went a bit further to prevent this issue from ever recurring. They adopted the “new type” pattern, created two separate types—<code>BytesQuota</code> and <code>FilesQuota</code>—and plumbed them through the whole program. And note: Rust wasn’t really a thing in 2010.</p><p>Furthermore, the team contributed an entry to the <a href=\"https://testing.googleblog.com/2007/01/introducing-testing-on-toilet.html\">Testing on the Toilet blog</a>, describing the issue and how this same problem had <em>just</em> bitten a major financial company and had made them lose millions of dollars.</p><p>And that’s the simple story of the day. Please adopt the new type pattern! Future-you will be happy that you did when the compiler or language interpreter yells at you about something that’s obviously wrong.</p><p><em>(<a href=\"https://twitter.com/jmmv/status/1766522609314017598\">Originally published as a Twitter thread.</a>)</em></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "0.0" "image/jpeg") nil "d0e4f229561181e1222cd5218630e29e") (52 (26631 11919 434047 610000) "https://blogsystem5.substack.com/p/bazel-next-generation" "The next generation of Bazel builds" "Julio Merino" "Mon, 24 Mar 2025 15:03:25 +0000" "<p>Today marks the 10th anniversary of <a href=\"https://blog.engflow.com/2024/10/01/birth-of-the-bazel/\">Bazel’s public announcement</a> so this is the perfect moment to reflect on what the next generation of build systems in the Bazel ecosystem may look like.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/b2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":525451,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159682182?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>I write this with the inspiration that comes from attending <a href=\"https://www.linkedin.com/feed/update/urn:li:activity:7295871444343734272/\">the first ever conference on Buildbarn</a>, one of the many remote execution systems for Bazel. In the conference, Ed Schouten, the creator of <a href=\"https://github.com/buildbarn\">Buildbarn</a>, presented Bonanza: a skunkworks reimagination of Bazel for truly large builds.</p><p>In this article, I want to dive into what Bonanza is and what similar projects to “replace Bazel” have existed. To get there though, we need to start first with a critique of the current implementation of Bazel.</p><h1><strong>Problems scaling up</strong></h1><p>The predecessor to Bazel, Blaze, is a build system designed at Google for Google’s monorepo scale. Blaze grew over the years assuming:</p><ul><li><p>that every engineer had a beefy workstation under their desk;</p></li><li><p>that remote execution was expected to be used by default;</p></li><li><p>that the remote execution cluster was reachable through a fast and low latency network; and</p></li><li><p>that each office had physical hardware hosting a local cache of remote build artifacts.</p></li></ul><p>These assumptions allowed Blaze to “scale up” to the very large codebase that Google builds, but they came with some downsides.</p><p>One consequence of these assumptions is that the Bazel process—confusingly named the “Bazel server”—that runs on your machine is very resource hungry. The reason is that this process has to scan the source tree to understand the dependency graph and has to coordinate thousands of RPCs against a remote cluster—two operations that aren’t cheap. What’s worse is that the Bazel server process is stateful: at start up, Bazel goes through the expensive steps of computing the analysis graph from disk and, to prevent redoing this work in every build, Bazel keeps this graph in its in-memory “analysis cache”.</p><p><a href=\"https://bazel.build/advanced/performance/iteration-speed\">The analysis cache is fragile.</a> The Bazel server process may auto-restart, and certain flags used to control the build cause the cache to be discarded. These are not rare flags, no: these include basic flags like <code>-c</code> to change the compilation mode from debug to release, among many others. Cache discards are very intrusive to user workflows because an iterative build that would have taken a second now takes maybe thirty, for example.</p><p>This user experience degradation makes Bazel’s front-page claim of being fast hard to believe. Bazel is really fast at running gigantic builds from scratch and it is really efficient when executing incremental builds. But the problem is that “truly incremental builds” are a rarity, so you end up paying the re-analysis cost many more times than is necessary. If you run Bazel in a CI environment, you know that these costs are far from negligible because every single Bazel process invocation on a fresh CI node can take <em>minutes</em> to “warm up”.</p><h1><strong>Problems scaling down</strong></h1><p>There is also the other side of the coin, which is that Bazel does not scale <em>down</em> very well. This was one of my <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">original critiques</a> when Bazel went open source in 2015: at that time, I really wished for a declarative build system like Bazel to replace the mess that was and is Make plus the GNU Autotools, but the fact that Bazel was written in Java meant that it would never do this (mostly for non-technical reasons).</p><p>Regardless, <a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">I </a><em><a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">did</a></em><a href=\"https://jmmv.dev/2016/01/joining-blaze-team.html\"> join the Blaze team</a> after that, and I spent most of my time coercing Blaze and Bazel to run nicely on “small” laptop computers. I succeded in some areas, but it was a losing battle: Java had certain deficiencies that prevent implementing <em>lean</em> software. <a href=\"https://wiki.openjdk.org/display/loom/Main\">Project Loom</a> and <a href=\"https://en.wikipedia.org/wiki/Project_Valhalla_(Java_language)\">Project Valhalla</a> promise to bring the necessary features to Java, but these features aren’t quite there yet—and even when they are, retrofitting these into Bazel will be a very hard feat.</p><p>In any case. Bazel works, and it works nicely for many use cases, but it lives in this limbo state where it isn’t awesome for very large builds and it isn’t awesome for very small builds either. So, let’s look at the former: how do we make Bazel awesome for humongous builds? By lifting it in its entirety to the cloud.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Enjoying this article? If so, please subscribe to Blog System/5 to show your support. It’s free and you’ll appreciate future content!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Enter Bonanza</strong></h1><p>Bonanza is Ed’s playground for a new build system: a build system that takes remote execution to the limit. Where Bazel is only capable of shipping individual build actions to the cloud, Bonanza uses the cloud for <em>everything</em>, including external dependency handling, build graph construction and iteration, and more.</p><p>To understand what Bonanza brings to the table in the context of hugely scalable builds, let’s distill the salient points that Ed highlighted in his <a href=\"https://docs.google.com/presentation/d/1uh6CxvvziQunw55e_bs1Juz3jfaiE-QJVs2DCfeMeTw/edit#slide=id.g339c289dd60_1_29\">“Bonanza in a nutshell”</a> slide from his conference presentation (recording coming soon):</p><ul><li><p><strong>Bonanza can only execute build actions remotely.</strong> There is no support for local execution, which makes the build driver (the process that runs on your machine) simpler and eliminates all sorts of inconsistencies that show up when mixing local and remote execution. Bazel’s <a href=\"https://jmmv.dev/2019/12/bazel-strategies.html\">execution strategies</a> tend to enforce hermeticity, but they don’t always succeed because of sandboxing limitations.</p></li><li><p><strong>Bonanza performs analysis remotely.</strong> When traditional Bazel is configured to execute all actions remotely, the Bazel server process is essentially a driver that constructs and walks a graph of nodes. This <em>in-memory</em> graph is known as <a href=\"https://bazel.build/reference/skyframe\">Skyframe</a> and is used to represent <em>and execute</em> a Bazel build. Bonanza lifts the same graph theory from the Bazel server process, puts it into a remote cluster, and relies on a distributed persistent cache to store the graph’s nodes. The consequence of storing the graph in a distributed storage system is that, all of a sudden, <em>all</em> builds become incremental. There is no more “cold build” effect like the one you see with Bazel when you lose the analysis cache.</p></li><li><p><strong>Bonanza runs repo rules remotely.</strong> Repo rules are what Bazel uses to interact with out-of-tree dependencies, and they can do things like download Git repositories, toolchain binaries, or detect what compiler exists in the system. What you should know is that Blaze <em>did not</em> and <em>does not</em> have repo rules nor support for workspaces because Google uses a strict monorepo. Both the repo rules and the workspace were bolted-on additions to Blaze when it was open-sourced as Bazel, and it shows: these features do not integrate cleanly with the rest of Bazel’s build model, and they have been clunky for years. Bonanza fixes these issues with a cleaner design.</p></li><li><p><strong>Bonanza encrypts data in transit and at rest.</strong> Bonanza brings to life some of the features discussed for the Remote Execution v3 protocol, which never saw the light of day, and encryption is one of them. By encrypting all data that flows through the system, Bonanza can enforce provenance guarantees if you control the action executors. This is important because it allows security-conscious companies to easily trust using <a href=\"https://bazel.build/community/remote-execution-services\">remote build service providers</a>.</p></li><li><p><strong>Bonanza only supports rules written in Starlark.</strong> When Bazel launched, it included support for <a href=\"https://github.com/bazelbuild/starlark\">Starlark</a>: a new extensibility language with which to write build logic in. Unfortunately, for historical reasons, Bazel’s core still included Java-native implementations of the most important and complex rules: namely, C++, Java and protobuf. Google has been chasing the dream of externalizing all rule implementations into Starlark for the last 10 years, and only in Bazel 8 they <em>mostly</em> have achieved this goal. Bonanza starts with a clean design that requires build logic to be written in Starlark, and it pushes this to the limit: <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/builtins_core/exports.bzl\">almost everything</a>, including <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/bazel_tools/command_line_option/BUILD.bazel\">flags</a>, is Starlark.</p></li><li><p><strong>Bonanza aims to be Bazel compatible.</strong> Of the modern build systems that use a functional evaluation model like Bazel, only Bazel has been able to grow a significant community around it. This means that the ecosystem of tools and rules, as well as critical features like good IDE support, is thriving in Bazel whereas this cannot be said of other systems. Bonanza makes the right choice of being Bazel compatible so that it can reuse this huge ecosystem. Anyone willing to evaluate Bonanza will be able to do so with relative ease.</p></li></ul><p>When you combine all of these points, you have a build system where the client process on your development machine or on CI is thin: all the client has to do is upload the project state to the remote execution cluster, which in the common case will involve <em>just</em> uploading modified source files. From there, the remote cluster computes the delta of what you uploaded versus any previously-built artifacts and reevaluates the minimum set of graph nodes to produce the desired results.</p><p>Are your hopes up yet? Hopefully so! But beware that Bonanza is <em>just</em> a proof of concept for now. The <a href=\"https://github.com/buildbarn/bonanza\">current implementation</a> shows that all of the ideas above are feasible and it can fully evaluate the complex <a href=\"https://github.com/buildbarn/bb-storage\">bb-storage project</a> from scratch—but it doesn’t yet provide the necessary features to <em>execute</em> the build. Ed appreciates PRs though!</p><h1><strong>Meanwhile, at Google</strong></h1><p>My time at Google is now long behind as I left almost five years ago, but back then there were two distinct efforts that attempted to tackle the scalability issues described in this article. (I can’t name names because they were never public, but if you probe ChatGPT to see if it knows about these efforts, it somehow knows specific details.)</p><p>One such effort was to make Blaze “scale up” to handle even larger builds by treating them all as incremental. The idea was to persist the analysis graph in a distributed storage system so that Blaze would never have to recompute it from scratch. This design still kept a relatively fat Blaze process on the client machine, but it is quite similar to what Bonanza does. Google had advantages over Bonanza in terms of simplicity because, as I mentioned earlier, Blaze works in a pure monorepo and does <em>not</em> have to worry about repo rules.</p><p>The other such effort was to make Blaze “scale down” by exploring a rewrite in Go. This rewrite was carefully crafted to optimize memory layouts, avoiding unnecessary pointer chasing (which was impossible to avoid in Java). The results of this experiment proved that Blaze could be made to analyze large portions of Google’s build graph in just a fraction of the time, without any sort of analysis caching or significant startup penalties. Unfortunately, this rewrite was way ahead of its time: the important rulesets required to build Google’s codebase were still implemented inside of Blaze as Java code, so this experimental build system couldn’t do anything useful outside of Go builds.</p><h1><strong>Meanwhile, at Meta</strong></h1><p>My knowledge of Meta’s build system is limited, but almost two years ago, Meta released <a href=\"https://buck2.build/\">Buck 2</a>, a complete reimplementation of their original Bazel-inspired build system. This reimplementation <a href=\"https://buck2.build/docs/about/why/\">checked most of the boxes</a> for what I thought a “Bazel done right” would look like:</p><ul><li><p><strong>Buck 2 is written in a real systems language (Rust).</strong> As explained earlier, I had originally criticised Java’s choice as one of Bazel’s weaknesses. It turns out Meta realized this same thing because Buck 1 had also been written in Java and they chose to go the risky full-rewrite route to fix it. (To be fair, you need to understand that Java had been a reasonable choice back then: when both Blaze and Buck 1 were originally designed, C++11—possibly the only reasonable edition of C++—didn’t even exist.)</p></li><li><p><strong>Buck 2 is completely language agnostic.</strong> Its core build engine does not have any knowledge of the languages it can build, and all language support is provided via Starlark extensions. This stems from learning about earlier design mistakes of both Blaze and Buck 1. Meta chose to address this as part of the Rust rewrite, whereas Google has been addressing it incrementally.</p></li><li><p><strong>Buck 2 has first-class support for virtual file systems</strong>. These are a necessity when supporting very large codebases and when integrating with remote build systems, but are also completely optional. Blaze also had support for these, but not Bazel.</p></li></ul><p>At launch, I was excited and eager to give Buck 2 a try, but then the disappointment came in: as much as it walks and quacks like Bazel due to its use of Starlark… the API that Buck 2 exports to define rules is <em>not compatible</em> with Bazel’s. This means that Buck 2 cannot be used in existing Bazel codebases, so the ability to evaluate its merits in a real codebase is… insurmountable. In my mind, this made Buck 2 dead on arrival, and it’s yet to be seen if Meta will be able to grow a significant public ecosystem around it.</p><p>In any case, I do not have any experience with Buck 2 because of the previous, so I cannot speak to its ability to scale either up or down. And this is why I wrote this section: to highlight that being Bazel-compatible is critical in this day and age if you want to have a chance at replacing a modern system like Bazel. Bonanza <em>is</em> Bazel-compatible so it has a chance of demonstrating its value with ease.</p><h1><strong>What lies ahead</strong></h1><p>If you ask me, it seems impossible to come up with a single build system that can satisfy the wishes of tiny open-source projects that long for a lean and clean build system and that can satisfy the versatility and scale requirements of vast corporate codebases.</p><p>Bazel-the-implementation tries to appeal to both and falls short, yet Bazel-the-ecosystem provides the lingua franca of what those implementations need to support.</p><p>My personal belief is that <em>we need two build systems</em> that speak the same protocol (Starlark and Bazel’s build API) so that users can interchangeably choose whichever one works best for their use case:</p><ul><li><p>On the one hand, we need a massively scalable build system that does all of the work in the cloud. This is to support building monorepos, to support super-efficient CI runs, and to support “headless” builds like those offered by hosted VSCode instances. Bonanza seems to have the right ideas and the right people behind it to fulfill this niche.</p></li><li><p>On the other hand, we need a tiny build system that does all of the work locally and that can be used by the myriad of open-source projects that the industry relies on. This system has to be written in Rust (oops, I said it) with minimal dependencies and be kept lean and fast so that IDEs can communicate with it quickly. This is a niche that is not fulfilled by anyone right now and that my mind keeps coming to; it’d be fun to create this project given <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my last failed attempt</a>.</p></li></ul><p>The time for these next-generation Bazel-compatible build systems is <em>now</em>. Google has spent the last 10 years Starlark-ifying Bazel, making the core execution engine replaceable. We are reaching a point where the vast majority of the build logic can be written in Starlark as Bonanza proves, and thus we should be able to have different build <em>tools</em> that implement the same build <em>system</em> for different use cases.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "0.0" "image/jpeg") nil "c6fbbbba85d2830615ea235b3fde8f3f") (51 (26631 11919 416614 467000) "https://blogsystem5.substack.com/p/x86-64-programming-models" "The costs of the i386 to x86-64 upgrade" "Julio Merino" "Mon, 07 Oct 2024 16:03:08 +0000" "<p>If you read my previous article on <a href=\"https://blogsystem5.substack.com/p/dos-memory-models\">DOS memory models</a>, you may have dismissed everything I wrote as “legacy cruft from the 1990s that nobody cares about any longer”. After all, computers have evolved from sporting 8-bit processors to 64-bit processors and, on the way, the amount of memory that these computers can leverage has grown orders of magnitude: the 8086, a 16-bit machine with a 20-bit address space, could only use 1MB of memory while today’s 64-bit machines can theoretically access 16EB.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":992004,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>All of this growth has been in service of ever-growing programs. But… even if programs are now more sophisticated than they were before, do they all <em>really</em> require access to a 64-bit address space? Has the growth from 8 to 64 bits been a net positive in performance terms?</p><p>Let’s try to answer those questions to find some very surprising answers. But first, some theory.</p><h1>Code density</h1><p>An often overlooked property of machine code is <em>code density</em>, a loose metric that quantifies how many instructions are required to execute a given “action”. I double-quote action because an “action” in this context is a subjective operation that captures a programmer-defined outcome.</p><p>Suppose, for example, that you want to increment the value of a variable that resides in main memory, like so:</p><pre><code><code>static int a;
// ...
a = a + 1;</code></code></pre><p>On a processor with an ISA that provides complex instructions and addressing modes, you can potentially do so in just one machine instruction:</p><pre><code><code>; Take the 32-bit quantity at the address indicated by the
; 00001234h immediate, increment it by one, and store it in the
; same memory location.
add dword [1234h], 1</code></code></pre><p>In contrast, on a processor with an ISA that strictly separates memory accesses from other operations, you’d need more steps:</p><pre><code><code>li  r8, 1234h   ; Load the address of the variable into r8.
lm  r1, r8      ; Load the content of the address into r1.
li  r2, 1       ; Load the immediate value 1 into r2.
add r3, r1, r2  ; r3 = r1 + r2
sm  r8, r3      ; Store the result in r3 into the address in r8.</code></code></pre><p>Which ISA is better, you ask? Well, as usual, there are pros and cons to each approach:</p><ul><li><p>The former type of ISA offers a denser representation of the operation so it can fit more instructions in less memory. But, because of the semantic complexity of each individual instruction, the processor has to do more work to execute them (possibly requiring more transistors and drawing more power). This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Complex_instruction_set_computer\">CISC</a>.</p></li><li><p>The latter type of ISA offers a much more verbose representation of the operation but the instructions that the processor executes are simpler and can likely be executed faster. This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Reduced_instruction_set_computer\">RISC</a>.</p></li></ul><p>This is the eternal debate between CISC and RISC but note that the distinction between the two is not crystal clear: some RISC architectures support <em>more</em> instructions that CISC architectures, and contemporary Intel processors translate their CISC-style instructions into internal RISC-style <a href=\"https://en.wikipedia.org/wiki/Intel_microcode\">micro-operations</a> immediately after decoding the former.</p><h1>It’s the bytes that matter</h1><p>Code density is not about instruction <em>count</em> though. Code density is about the <em>aggregate size</em>, in bytes, of the instructions required to accomplish a specific outcome.</p><p>In the example I presented above, the single CISC-style <code>mov</code> x86 instruction is encoded using anywhere from 2 to 8 bytes depending on its arguments, whereas the fictitious RISC-style instructions typically take 4 bytes each. Therefore, the CISC-style snippet would take 8 bytes total whereas the RISC-style snippet would take 20 bytes total, while achieving the same conceptual result.</p><p>Is that increase in encoded bytes bad? Not necessarily because “bad” is subjective and we are talking about trade-offs here, but it’s definitely an important consideration due to its impact in various dimensions:</p><ul><li><p><strong>Memory usage</strong>: Larger programs take more memory. You might say that memory is plentiful these days, and that’s true, but it wasn’t always the case: when computers could only address 1 MB of RAM or less, the size of a program’s binary mattered a lot. Furthermore, even today, memory <em>bandwidth</em> is limited, and this is an often-overlooked property of a system.</p></li><li><p><strong>Disk space</strong>: Larger programs take more disk space. You might say that disk space is plentiful these days too and that program code takes a tiny proportion of the overall disk: most space goes towards storing media anyway. And that’s true, but I/O bandwidth is not as unlimited as disk space, and loading these programs from disk isn’t cheap. Have you noticed how utterly slow is it to open an Electron-based app?</p></li><li><p><strong>L1 thrashing</strong>: Larger or more instructions mean that you can fit fewer of them in the L1 instruction cache. Proper utilization of this cache is critical to achieve reasonable levels of computing performance, and even though main memory size can now be measured in terabytes, the L1 cache is still measured in kilobytes.</p></li></ul><p>We could beat the dead horse over CISC vs. RISC further but that’s not what I want to focus on. What I want to focus on is one very specific dimension of the instruction encoding that affects code density in all cases. And that’s the <em>size of the addresses</em> (pointers) required to reference program code or data.</p><p>Simply put, the larger the size of the addresses in the program’s code, the lower the code density. The lower the code density, the more memory and disk space we need. And the more memory code takes, the more L1 thrashing we will see.</p><p>So, for good performance, we probably want to optimize the way we represent addresses in the code and take advantage of surrounding context. For example: if we have a tight loop like this:</p><pre><code><code>static int a;
...
for (int i = 0; i < 100; i++) {
a = a + 1;
}</code></code></pre><p>The corresponding assembly code may be similar to this:</p><pre><code><code>        mov ecx, 0             ; i = 0.
repeat: cmp ecx, 100           ; i < 100?
je  out                ; If i == 100, jump to out.
add dword [01234h], 1  ; Increment a.
add ecx, 1             ; i++.
jmp repeat             ; Jump back to repeat.
out:</code></code></pre><p>Now the questions are:</p><ul><li><p>Given that <code>repeat</code> and <code>out</code> are labels for memory addresses, how do we encode the <code>je</code> (jump if equal) and <code>jmp</code> (unconditional jump) instructions as bytes? On a 32-bit machine, do we encode the full 32-bit addresses (4 bytes each) in each instruction, or do we use 1-byte relative short pointers because the jump targets are within a 127-byte distance on either side of the jump instruction?</p></li><li><p>How do we represent the address of the <code>a</code> variable? Do we express it as an absolute address or as a relative one? Do we store <code>1234h</code> as a 32-bit quantity or do we use fewer bytes because this specific number is small?</p></li><li><p>How big should <code>int</code> be? The <code>dword</code> above implies 32 bits but… that’s just an assumption I made when writing the snippet. <code>int</code> could have been 16 bits, or 64 bits, or anything else you can imagine (which is a design mistake in C, if you ask me).</p></li></ul><p>The answers to the questions above are <em>choices</em>: we can decide whichever encoding we want for code and data addresses, and these choices have consequences on code density. This was true many years ago during the DOS days, which is why we had short, near, and far pointer types, and <a href=\"https://web.eece.maine.edu/~vweaver/papers/iccd09/iccd09_density.pdf\">is still true today</a> as we shall see.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Are you finding this interesting? If so, subscribe to Blog System/5 to receive more goodness in your inbox. It’s free, but paid donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The switch to 32 bits</h1><p>It is no secret that programming 16-bit machines was limiting, and we can identify at least two reasons to back this claim.</p><p>First, 16-bit machines usually had limited address spaces. It’s important to understand that a processor’s native register size has no direct connection to the size of the addresses the processor can reference. In theory, these machines could have leveraged larger chunks of memory and, in fact, the 16-bit 8086 proved this to be true with its 20-bit address space. But the point is that, <em>in the era</em> of 16-bit machines, 1 MB of RAM was considered “a lot” and so machines didn’t have much memory.</p><p>Second, 16-bit machines can only operate on 16-bit quantities at a time, and 16 bits only allow representing integers with limited ranges: a signed number between -32K and +32K isn’t… particularly large. Like before, it’s important to clarify that the processor’s native register size does not impose restrictions on the size of the numbers the processor can manipulate, but it does add limitations on how <em>fast</em> it can do so: operating 32-bit numbers on 16-bit machines requires at least twice the number of instructions for each operation.</p><p>So, when 32-bit processors entered the scene, it was pretty much a no-brainer that programs had to become 32-bit by default: all memory addresses and default integer types grew to 32 bits. This allowed programmers to not worry about memory limits for a while: 32 bits can address 4GB of memory, which was a huge amount back then and should <em>still</em> be huge if it wasn’t due to bloated software. Also, this upgrade allowed programmers to efficiently manipulate integers with large-enough ranges for most operations.</p><p>In technical mumbo-jumbo, what happened here was that C adopted the ILP32 programming model: integers (I), longs (L), and pointers (P) all became 32 bits, whereas chars and shorts remained 8-bit and 16-bit respectively.</p><p>It didn’t have to be this way though: if we look at the model for 16-bit programming, shorts and integers were 16-bit whereas longs were 32-bit, so why did integers change size but longs remained the same as integers? I do not have an answer for this, but if longs had become 64 bits back then, maybe we wouldn’t be in the situation today where <a href=\"https://en.wikipedia.org/wiki/Year_2038_problem\">2038 will bring mayhem to Unix systems</a>.</p><h1>Evolving towards x86-64</h1><p>4GB of RAM were a lot when 32-bit processors launched but slowly became insufficient as software kept growing. To support those needs, there were crutches like <a href=\"https://en.wikipedia.org/wiki/Physical_Address_Extension\">Intel’s PAE</a>, which allowed manipulating up to 64GB of RAM on 32-bit machines without changing the programming model, but they were just that: hacks.</p><p>The thing is: it’s not only software that grew. It’s the <em>kinds of things</em> that people wanted to do with software that changed: people wanted to edit high-resolution photos and video as well as play more-realistic games, and writing code to achieve those goals on a limited 4GB address space was possible but not <em>convenient</em>. With 64-bit processors, <code>mmap</code>ing huge files made those programs easier to write, and using native 64-bit integers made them faster too. So 64-bit machines became mainstream sometime around the introduction of the Athlon 64 processor and the Power Mac G5, both in 2003.</p><p>So what happened to the programming model? ILP32 was a no-brainer for 32-bit machines, but were LP64 or ILP64 no-brainers for 64-bit machines? These 64-bit models were definitely tempting because they allowed the programmer to leverage the machine’s resources freely. Larger pointers allowed addressing “unlimited” memory transparently, and a larger long type naturally bumped file offsets (<code>ino_t</code>), timestamps (<code>time_t</code>), array lengths (<code>size_t</code>), and more to 64 bits as well. Without a lot of work from programmers, programs could “just do more” by simply recompiling them.</p><p>But there was a downside to that choice. According to the theory I presented earlier, LP64 would make programs bigger and would decrease code density when compared to ILP32. And lower code density could lead to L1 instruction cache thrashing, which is an important consideration to this day because a modern Intel Core i7-14700K from 2023 has just 80 KB of L1 cache and an Apple Silicon M3 from 2023 has less than 200KB. (These numbers are… <em>not big</em> when you stack them up against the multi-GB binaries that comprise modern programs, are they?)</p><p>We now know that LP64 was the preferred choice and that it became the default programming model for 64-bit operating systems, which means we can compare its impact against ILP32. So what are the consequences? Let’s take a look.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" width=\"1363\" height=\"844\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":844,\"width\":1363,\"resizeWidth\":null,\"bytes\":37898,\"alt\":\"Comparison of ISO image sizes for various operating systems\",\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"Comparison of ISO image sizes for various operating systems\" title=\"Comparison of ISO image sizes for various operating systems\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>Wait, what? The FreeBSD x86-64 installation image is definitely larger than the i386 one… but all other images are <em>smaller</em>? What’s going on here? This contradicts everything I said above!</p><h1>Down the rabbit hole</h1><p>I was genuinely surprised by this and I had to dig a bit. Cracking open the FreeBSD bootonly image revealed some differences in the kernel (slightly bigger binaries, but different sets of modules) which made it difficult to compare the two. But looking into the Debian netinst images, I did find that almost all i386 binaries were larger than their x86-64 counterparts.</p><p>To try to understand why that was, the first thing I did was compile a simple hello-world program on my x86-64 Debian VM, targeting both 64-bit and 32-bit binaries:</p><pre><code><code>$ gcc-14 -o hello64 hello.c
$ i686-linux-gnu-gcc-14 -o hello32 hello.c
$ file hello32 hello64
hello32: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, not stripped
hello64: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f1bf851d7f1d56ae5d50eb136793066f67607e06, for GNU/Linux 3.2.0, not stripped
$ ls -l hello32 hello64
-rwxrwxr-x 1 jmmv jmmv 15040 Oct  4 17:45 hello32
-rwxrwxr-x 1 jmmv jmmv 15952 Oct  4 17:45 hello64
$ █</code></code></pre><p>Based on this, it <em>looks</em> as if 32-bit binaries are indeed smaller than 64-bit binaries. But a “hello world” program is trivial and not worth 15kb of code: those 15kb shown above are definitely <em>not</em> code. They are probably mostly ELF overhead. Indeed, if we look at just the text portion of the binaries:</p><pre><code><code>$ objdump -h hello32 | grep text
14 .text         00000169  00001060  00001060  00001060  2**4
$ objdump -h hello64 | grep text
14 .text         00000103  0000000000001050  0000000000001050  00001050  2**4
$ █</code></code></pre><p>… we find that <code>hello32</code>’s text is 169h bytes whereas <code>hello64</code>’s text is 103h bytes. And if we disassemble the two:</p><pre><code><code>$ objdump --disassemble=main hello32
...
00001189 <main>:
1189:       8d 4c 24 04             lea    0x4(%esp),%ecx
118d:       83 e4 f0                and    $0xfffffff0,%esp
1190:       ff 71 fc                push   -0x4(%ecx)
1193:       55                      push   %ebp
1194:       89 e5                   mov    %esp,%ebp
1196:       53                      push   %ebx
1197:       51                      push   %ecx
1198:       e8 28 00 00 00          call   11c5 <__x86.get_pc_thunk.ax>
119d:       05 57 2e 00 00          add    $0x2e57,%eax
11a2:       83 ec 0c                sub    $0xc,%esp
11a5:       8d 90 14 e0 ff ff       lea    -0x1fec(%eax),%edx
11ab:       52                      push   %edx
11ac:       89 c3                   mov    %eax,%ebx
11ae:       e8 8d fe ff ff          call   1040 <puts@plt>
11b3:       83 c4 10                add    $0x10,%esp
11b6:       b8 00 00 00 00          mov    $0x0,%eax
11bb:       8d 65 f8                lea    -0x8(%ebp),%esp
11be:       59                      pop    %ecx
11bf:       5b                      pop    %ebx
11c0:       5d                      pop    %ebp
11c1:       8d 61 fc                lea    -0x4(%ecx),%esp
11c4:       c3                      ret
...
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ █</code></code></pre><p>We observe massive differences in the machine code generated for the trivial <code>main</code> function. The 64-bit code is definitely <em>smaller</em> than the 32-bit code, contrary to my expectations. But the code is also <em>very</em> different; so different, in fact, that ILP32 vs. LP64 doesn’t explain it.</p><p>The first difference we can observe is around calling conventions. The i386 architecture has a limited number of registers, favors passing arguments via the stack, and only 3 registers can be clobbered within a function. x86-64, on the other hand, prefers passing arguments through registers as much as possible and defines 7 registers as volatile.</p><p>The second difference is that we don’t see 64-bit addresses anywhere in the code above. Jump addresses are encoded using near pointers, and data addresses are specified as offsets over a 64-bit base previously stored in a register. I found it smart that those addresses are relative to the program counter (the RIP register).</p><p>There may be more differences, but these two alone seem to be the reason why 64-bit binaries end up being more compact than 32-bit ones. <em>On Intel x86</em>, that is. You see: Intel x86’s instruction set is so versatile that the compiler and the ABI can play tricks to hide the cost of 64-bit pointers.</p><p>Is that true of more RISC-y 64-bit architectures though? I installed the PowerPC 32-bit and 64-bit toolchains and ran the same test. And guess what? The PowerPC 64-bit binary was indeed larger than the 32-bit one, so <em>maybe</em> it’s true. Unfortunately, running a broader comparison than this is difficult: there is no full operating system I can find that ships both builds any longer, and ARM images can’t easily be compared.</p><h1>It’s all about the data</h1><p>OK, fine, we’ve settled that 64-bit <em>code</em> isn’t necessarily larger than 32-bit code, at least on Intel, and thus any adverse impact on the L1 instruction cache is probably negligible. But… what about <em>data density</em>?</p><p>Pointers don’t only exist in instructions or as jump targets. They also exist within the most modest of data types: lists, trees, graphs… all contain pointers in them. And in those, unless the programmer explicitly plays complex <a href=\"https://v8.dev/blog/pointer-compression\">tricks to compress pointers</a>, we’ll usually end up with larger data structures by simply jumping to LP64. The same applies to the innocent-looking <code>long</code> type by the way, which appears throughout codebases and also grows with this model.</p><p>And <em>this</em>—a decrease in data density—is where the real performance penalty comes from: it’s not so much about the code size but about the data size.</p><p>Let’s take a look. I wrote a simple program that creates a linked list of integers with 10 million nodes and then iterates over them in sequence. Each node is 8 bytes in 32-bit mode (4 bytes for the <code>int</code> and 4 bytes for the <code>next</code> pointer), whereas it is 16 bytes in 64-bit mode (4 bytes for the <code>int</code>, <em>4 bytes of padding</em>, and 8 bytes for the <code>next</code> pointer). I then compiled that program in 32-bit and 64-bit mode, measured it, and ran it:</p><pre><code><code>$ gcc -o list64 list.c
$ i686-linux-gnu-gcc-14 -o list32 list.c
$ objdump -h list32 | grep text
13 .text         000001f6  00001070  00001070  00001070  2**4
$ objdump -h list64 | grep text
14 .text         000001b0  0000000000001060  0000000000001060  00001060  2**4
$ hyperfine --warmup 1 ./list32 ./list64
Benchmark 1: ./list32
Time (mean ± σ):     394.2 ms ±   2.1 ms    [User: 311.4 ms, System: 83.1 ms]
Range (min … max):   392.1 ms … 398.2 ms    10 runs
Benchmark 2: ./list64
Time (mean ± σ):     502.4 ms ±   4.5 ms    [User: 334.9 ms, System: 167.8 ms]
Range (min … max):   494.9 ms … 509.5 ms    10 runs
Summary
./list32 ran
1.27 ± 0.01 times faster than ./list64
$ █</code></code></pre><p>As before with the hello-world comparison, this simple microbenchmark’s 32-bit code continues to be slightly larger than its 64-bit counterpart (1F6h bytes vs 1B0h). However, its runtime is <em>27% faster</em>, and it is no wonder because the doubling of the linked list node size implies doubling the memory usage and thus the halving of cache hits. We can confirm the impact of this using the <code>perf</code> tool:</p><pre><code><code>$ perf stat -B -e cache-misses ./list32 2>&1 | grep cpu_core
2,400,339      cpu_core/cache-misses:u/      (99.33%)
$ perf stat -B -e cache-misses ./list64 2>&1 | grep cpu_core
4,687,156      cpu_core/cache-misses:u/      (99.34%)
$ █</code></code></pre><p>The 64-bit build of this microbenchmark incurs almost double the cache misses than the 32-bit build.</p><p>Of course, this is just a microbenchmark, and tweaking it slightly will make it show very different results and make it say whatever we want. I tried to add jitter to the memory allocations so that the nodes didn’t end up as consecutive in memory, and then the 64-bit version executed faster. I suspect this is due to the memory allocator having a harder time handling memory when the address space is limited.</p><p>The impact on real world applications is harder to quantify. It is difficult to find the same program built in 32-bit and 64-bit mode and to run it on the same kernel. It is even more difficult to find one such program where the difference matters. But at the end of the day, the differences exist, and I bet they are more meaningful than we might think in terms of bloat—but I did not intend to write a research paper here, so I’ll leave that investigation to someone else… or another day.</p><h1>The x32 ABI</h1><p>There is one last thing to discuss before we depart. While we find ourselves using the LP64 programming model on x86-64 processors, remember that this was a choice and there were and are other options on the table.</p><p>Consider this: we could have made the operating system kernel leverage 64 bits to gain access to a humongous address space, but we could have kept the user-space programming model as it was before—that is, we could have kept ILP32. And we could have gone even further and optimized the calling conventions to reduce the binary code size by leveraging the additional general-purpose registers that x86-64 provides.</p><p>And in fact, this exists and is known as <a href=\"https://en.wikipedia.org/wiki/X32_ABI\">x32</a>.</p><p>We can install the x32 toolchain and see that it effectively works as we’d imagine:</p><pre><code><code>$ gcc -o hello64 hello.c
$ x86_64-linux-gnux32-gcc-14 -o hellox32 hello.c
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ objdump --disassemble=main hellox32
...
00401126 <main>:
401126:       55                      push   %rbp
401127:       89 e5                   mov    %esp,%ebp
401129:       b8 04 20 40 00          mov    $0x402004,%eax
40112e:       89 c0                   mov    %eax,%eax
401130:       48 89 c7                mov    %rax,%rdi
401133:       e8 f8 fe ff ff          call   401030 <puts@plt>
401138:       b8 00 00 00 00          mov    $0x0,%eax
40113d:       5d                      pop    %rbp
40113e:       c3                      ret
...
$ █</code></code></pre><p>Now, the <code>main</code> method of our hello-world program is really similar between the 64-bit and 32-bit builds, but pay close attention to the x32 version: it uses the same calling conventions as x86-64, but it contains a mixture of 32-bit and 64-bit registers, delivering a more compact binary size.</p><p>Unfortunately:</p><pre><code><code>$ ./hellox32
zsh: exec format error: ./hellox32
$ █</code></code></pre><p>We can’t run the resulting binary. x32 is an ABI that impacts the kernel interface too, so these binaries cannot be executed on a regular x86-64 kernel. Sadly, and as far as I can tell, x32 is pretty much abandonware today. Gentoo claims to support it but there are no official builds of any distribution I can find that are built in x32 mode.</p><div><hr></div><p>In the end, even though LP64 <a href=\"https://unix.org/version2/whatsnew/lp64_wp.html\">wasn’t the obvious choice</a> for x86-64, it’s the compilation mode that won and stuck.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Phew, that was a lot! And you know what? Writing this took a really long time too. Subscribe now to show your support!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "0.0" "image/jpeg") nil "cd1d24fbf3b9084db0848fe73e123c30") (50 (26630 29053 704911 618000) "https://blogsystem5.substack.com/p/make-help" "Self-documenting Makefiles" "Julio Merino" "Fri, 10 Jan 2025 17:02:01 +0000" "<p>Make, as arcane as a build tool can be, may still be a good first fit for certain scenarios. “Heresy!”, you say, as you hear a so-called “Bazel expert” utter these words.</p><p>The specific problem I’m facing is that I need to glue together <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">the NetBSD build system</a>, <a href=\"https://jmmv.dev/2013/11/patch-management-with-quilt.html\">a quilt patch set</a>, EndBASIC’s Cargo-based Rust build, and a couple of QEMU invocations to produce a Frankenstein disk image for a Raspberry Pi. And the thing is: Make allows doing this sort of stitching with relative ease. Sure, Make is not the best option because the overall build performance is “meh” and because incremental builds are almost-impossible to get right… but adopting Bazel for this project would be an almost-infinite time sink.</p><p>Anyway. When using Make in this manner, you often end up with what’s essentially a “command dispatcher” and, over time, the number of commands grows and it’s hard to make sense of which one to use for what. Sure, you can write a <code>README.md</code> with instructions, but I guarantee you that the text will get out of sync faster than you can read this article. There is a better way, though.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" width=\"1068\" height=\"850\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/99723364-983d-414c-b099-6fe054113db9_1068x850.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":850,\"width\":1068,\"resizeWidth\":null,\"bytes\":110230,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Sample output of the make help command that we will implement in this article.</figcaption></figure></div><p>What if we could provide a <code>make help</code> command that showed an overview of the project’s “build interface”? And what if we could embed such information inside the <code>Makefile</code>s themselves, close to the entities that they document? This idea is neither new nor mine, and it has been written about before by different people. However, I bet that most of you haven’t heard about it before so it’s worth for me to repeat it. And I think that my solution is a bit more comprehensive than others I’ve found. So here you go.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Targets</strong></h1><p>As I mentioned in the introduction, Make is often used as a command dispatcher: with very little code, you can write what essentially are multiple shell scripts with automatic chaining, all wrapped in one single interface. It’s all pretty terrible, but people are used to this pattern due to Make’s ubiquity and somehow expect it when they face a Make-based project.</p><p>To implement this command dispatcher idea, each user-facing action is exposed via a <em>target</em>. These targets tend to be marked as “phony”—i.e. they are targets that produce no outputs of their own. Take a look at this <code>Makefile</code>:</p><pre><code><code>.PHONY: build
build: target/debug/program
target/debug/program: src/main.rs src/lib.rs
	cargo build

.PHONY: test
test: build
	cargo test</code></code></pre><p>In the snippet above, the <code>target/debug/program</code> target represents a built <em>file</em>. This target depends on a list of sources and specifies what command to run to generate the output when it is missing or out of date (according to file modification times, <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html#file-modification-times\">yikes</a>). When you type <code>make target/debug/program</code>, you expect the file <code>target/debug/program</code> to exist on disk after the command completes.</p><p>But the snippet also shows two phony targets: <code>build</code> and <code>test</code>. When you type <code>make build</code> or <code>make test</code>, you do not expect neither a <code>build</code> nor a <code>test</code> file to be created, no. What you expect is that the project is built and tested. And for this, Make evaluates the dependencies of the phony targets (if any are specified, as is the case for <code>build</code>) and then unconditionally executes any commands in the phony targets (as is the case for <code>test</code>).</p><p>With this in mind, the first thing we want to do in our <code>make help</code> command is to document these “special” targets that represent user-facing actions. To do this, we’ll leverage one not-well-known aspect of Make’s syntax: the list of dependencies of a target is <em>cumulative</em> across multiple target definitions of the same name. Basically, these target definitions are equivalent:</p><pre><code><code># All dependencies in one line.
target/debug/program: src/main.rs src/lib.rs
# Dependencies spread over multiple lines.
target/debug/program: src/main.rs
target/debug/program: src/lib.rs</code></code></pre><p>Knowing this, we can add “extra” lines for a target and use one of those to document the target so that we do not end up with super-long lines. For example, we can do:</p><pre><code><code>target/debug/program: # Builds the program.
target/debug/program: src/main.rs src/lib.rs</code></code></pre><p>And then we are just one <code>grep</code> away from extracting the targets and their documentation:</p><pre><code><code>sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>OK fine. It’s a bit more complicated than just <code>grep</code> because we have to reformat the lines a bit and we need to create a nicely formatted table. Also, I know the <code>sed</code> syntax is awful, but I really don’t want to call into Perl or Python as other guides tell you just for this silly string manipulation. There are native Unix tools that can help us here, and they are much lighter-weight.</p><h1><strong>Variables</strong></h1><p>All other “self-documenting <code>Makefile</code>” tutorials I found out there focus exclusively on documenting targets. But <code>Makefile</code>s often expose another dimension of their API, and this is the collection of user-settable configuration variables that they accept.</p><p>Many <code>Makefile</code>s do things like:</p><pre><code><code>CFLAGS ?= -O2</code></code></pre><p>… to indicate that <code>CFLAGS</code> is set to <code>-O2</code>. But note: the <code>?=</code> operator invites users to override the variable’s value if they choose to. For example, if the user wanted to build the project in debug mode, they could probably do the following and get the code to build without optimizations and with debug symbols:</p><pre><code><code>$ make CFLAGS=\"-O0 -g\" build</code></code></pre><p>Given that these variables are user-facing, we should document them as well as part of the <code>make help</code> output.</p><p>To document variables, we don’t have the luxury of splitting their definition into multiple lines like we did with targets to prevent super-long lines. That said, we can still add comments at the end of the line, like shown below, and those comments won't be part of the variable's default value. It is important, however, to not leave any space between the default value and the comment, or else the spaces become part of the variable's value.</p><pre><code><code>DEVELOPER ?= 0# Set to 1 to enable developer builds.</code></code></pre><p>Like with targets, we are also just one <code>grep</code> away from extracting the variables and their documentation:</p><pre><code><code>sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>Again, more complicated than just a <code>grep</code>, but you get the idea.</p><h1><strong>Putting it all together</strong></h1><p>Alright. So now we know how to extract a table documenting targets and a table documenting variables, but these two lists may still be too obscure on their own. Which targets are important? Which variables might the user want to look into first?</p><p>To address this deficiency, we can preface those tables with some prose that explains, at a very high level, what to do when interacting with the project for the first time. To implement this, we can write the instructions in a separate file (like a <code>README.md</code>) next to the <code>Makefile</code>, and then have our <code>make help</code> command print out the text file’s contents.</p><p>And so without further ado, here is how we can tie everything together:</p><pre><code><code>.PHONY: help
help: # Shows interactive help.
	@cat README.md
	@echo
	@echo \"make variables:\"
	@echo
	@sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort
	@echo
	@echo \"make targets:\"
	@echo
	@sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>If you copy/paste this text, beware that there are embedded tabs in it. The ones at the beginning of the line are obvious, but the ones in the <code>[ ]</code> character classes are not. The latter are supposed to be <code>[ <tab>]</code>.</p><p>Now, have fun with this, but please don’t use Make for new projects if you can avoid it!</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "0.0" "image/jpeg") nil "6fbd341d28ad476549ea911f0fd2b2b6") (49 (26630 29053 678342 856000) "https://blogsystem5.substack.com/p/20-years-of-blogging" "20 years of blogging" "Julio Merino" "Sat, 22 Jun 2024 16:01:01 +0000" "<p><a href=\"https://blogsystem5.substack.com/\">Blog System/5</a> hasn’t always been called this way and it hasn’t been my first experience with blogging either. In fact, today marks the 20th anniversary of this publication in its various incarnations so it’s time for a bit of reflection.</p><p>Just to set context for when 20 years ago was: Windows XP was almost 3 years old, Ubuntu had just debuted, Apple computers were still PowerPC-based, Half Life 2 was about to launch, and Slashdot was the place to be instead of the yet-to-be-created Hacker News. As for myself, I was still in college, had copious amounts of free time, and was a really active contributor to NetBSD.</p><p>So let’s start with a trip down memory lane before getting into the retrospective and the analysis of how <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">my Substack experiment</a>, which started late last year, has turned out. Beware that because this is an introspection post, all of the generalizations that follow are backed by feelings, not hard data, so take them with a grain of salt.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Before continuing, take a moment and consider subscribing. It’s completely free but knowing that you care is what makes this publication exist!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>History: Episode one</h1><p>Looking back at <a href=\"https://jmmv.dev/2004/06/welcome-to-my-new-journal.html\">my very first post from June 22nd, 2004</a>—oh wow, my English was <em>bad</em>—I had an earlier experiment of a blog a few months prior that didn’t last more than three entries. But the newer iteration, started during college finals of course, did stick. I originally chose the LiveJournal platform because it had more features than Blogger, and thus “jmmv’s weblog” was born. Why “weblog” and not “blog”? Because the “blog” term wasn’t yet the popular one.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":140932,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Earliest image available of the \"jmmv's weblog\" site on LiveJournal via the Wayback Machine. <a href=\"https://web.archive.org/web/20041126220647/http://www.livejournal.com:80/users/jmmv/\">Scraped on November 26th, 2004.</a></figcaption></figure></div><p>My choice of LiveJournal didn’t last very long though. I migrated to Blogger on <a href=\"https://jmmv.dev/2005/10/blog-migrated-to-blogger-welcome.html\">October 22nd, 2005</a> because it had improved significantly by then and it was growing in popularity. As part of that transition, I renamed the blog to “The Julipedia”—a nickname that a friend gave me because I usually had answers to all of his Linux-related questions. And yes, Wikipedia was a pretty new thing back then too, having just launched in 2001 and still being mocked as “the thing that will never compete with real encyclopaedias”. Ha, ha.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/dc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":170754,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Earliest image available of \"The Julipedia\" site on Blogger via the Wayback Machine. <a href=\"https://web.archive.org/web/20060412020801/http://julipedia.blogspot.com/\">Scraped on April 12th, 2006.</a></figcaption></figure></div><p>Blogger was just fine for a long time… until Google+ messed things up in 2011 or so. During that era, Google was shoehorning their social platform everywhere, and part of that process was optionally injecting the commenting system of Google+ into Blogger. I took the bait and adopted the new commenting experience—which, in other words, meant that I killed engagement overnight.</p><p>In any case, I continued to hold onto Blogger until about 2015. At that point, Medium was the new hot thing and, having grown disillusioned with Blogger’s staleness—the platform didn’t receive any love because all development and product resources had gone into the dwindling Google+—<a href=\"https://jmmv.dev/2015/05/hello-medium.html\">I gave it a try</a>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":90465,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Earliest image available of my Medium publication via the Wayback Machine. <a href=\"https://web.archive.org/web/20160701041554/https://medium.com/@jmmv\">Scraped on July 1st, 2016.</a></figcaption></figure></div><p>Medium was great: its UI was <em>neat</em> and their value proposition was that their network would help me increase the reach of my articles while offering a delightful publishing experience. But things went downhill pretty quickly too: the desire to monetize Medium made it gain aggressive subscription popups and paywalls everywhere, and it started filling up with “Top N things to XYZ” spam. AI-generated garbage? Not yet, but close. Yikes SEO.</p><h1>History: Episode two</h1><p>My Medium experiment <a href=\"https://jmmv.dev/2016/01/medium-experiment-wrapup.html\">didn’t last very long</a>. I published 8 posts over the course of 5 months but I knew I had to move elsewhere. Part of this move involved exporting those 8 posts and reimporting them into Blogger, which was easier said than done. Medium offered an “export” feature indeed, which sold me in the first place to try it out, but the <em>content</em> of the export was <em>unusable</em>. It took a lot of effort to clean up the tainted HTML that the platform produced to reimport it anywhere else. And this is when it hit me: I was not in control of my content, which was validated by seeing that Blogger’s export suffered from the same issues.</p><p>Which drove me to static hosting. <a href=\"https://jmmv.dev/2016/05/homepage-v3.html\">I extended the trivial homepage I already had</a> on the web with a blog section, built with Jekyll first and <a href=\"https://jmmv.dev/2018/02/from-jekyll-to-hugo.html\">then with Hugo</a>, and managed my blog in there for about 8 years. I dabbled with going back to a CMS a few times because the authoring experience in Markdown+Git+Hugo isn’t particularly… amenable to posting. But every time I prototyped an alternative, I ended up hitting the same roadblocks around content ownership. I wanted to own the originals in a future-proof format.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":113718,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Earliest image available of my static blog via the Wayback Machine. <a href=\"https://web.archive.org/web/20161224052720/http://julio.meroh.net/\">Scraped on December 24th, 2016.</a></figcaption></figure></div><p>But wait… you are reading this in Substack, aren’t you? “WTH!” you must be thinking. How can I reconcile what I just said with publishing on this platform? Well… over the 8 years of static hosting, it was almost impossible for me to grow my blog’s readership. I tried various things to grow a subscribers base, but nothing worked. And Substack seemed to be the new cool kid on the block where various folks I follow post content, so I had to try it out. This experiment is <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">what brought you Blog System/5 in the first place</a>. And you know what? It has been pretty cool.</p><p>The key difference between the Substack experiment and the Medium experiment is that I’m authoring the content in Markdown first, using the exact same platform I had previously set up for my static blog. Only when the posts are ready to publish, I literally copy/paste them into Substack and then set up a redirect in my static blog to point to Substack. It’s painful indeed, but I feel at peace because I can pull the rug at any time and be back in my happy static blog.</p><h1>Evolution: Writing approach</h1><p>Anyhow, enough talk about the history of the blog. Let’s talk about how its content has changed form over the years and <em>why</em> it has had to change. And to talk about content changes, we must talk about the evolution of audience behaviors: if you care about being read at all, you must consider who you are writing for.</p><p>With that in mind, the obvious question is: do people care about blogs these days? I’d say no, not really. Proof of this is when you hear people say “so and so wrote a blog” (cringe) when they actually mean “a blog <em>post</em>”. The concept of a blog as a personal publication seems to have been lost in favor of individual posts. I’m sure you can think of some recent popular articles that came your way, but, question: can you remember <em>where</em> you read them or <em>who</em> the author was? I bet not.</p><p>As a consequence, the type of content for a long-running blog like this one has had to evolve. Take a moment to skim <a href=\"https://jmmv.dev/archive.html\">through the archives</a> and look for patterns. You might notice that, back when I started blogging, my usual article was about 350 words long and not very polished. This was pretty common in the blogosphere: most blogs had similar short articles, often just describing the author’s “daily doings”.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":23243,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Median words per post by year for all articles that I've written in this blog and other publications.</figcaption></figure></div><p>Fast-forward to today and you can clearly see a change in the shape of the articles you read here and elsewhere: they are <em>much</em> longer now, even if attention spans are infinitesimally small. One reason is that we used to use blogs like a social network, to publish our “daily doings” for our committed followers to see. Contrast that to today: there is almost zero chance anyone will come across a bunch of short articles frequently enough for them to become an avid reader. The other reason, closely related to this one, is that it’s easier for long-form posts to “go viral”—and while you might not care about reach, some of us do.</p><p>Writing longer-form posts has had a direct inverse consequence on the frequency of the posts though, for obvious reasons:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":22058,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Total number of posts per year in this blog, but also including occasional articles in other publications.</figcaption></figure></div><p>Having to dedicate many, <em>many</em>, <em><strong>many</strong></em> hours to every long-form post necessarily means that the frequency of the articles has to decrease. For this blog, you can clearly see that I started strong with a post about every two or three days and now I consider myself lucky if I am able to average two posts per month per year. I also have much less free time available, so whenever I write an article, I want it to be of higher quality than before.</p><p>Fewer articles is not a bad metric per se though. Investing time to write long-form prose is beneficial. Long articles require much more work to put together indeed, but I find that spending such time helps me understand each topic in a better way. Furthermore, one only gets better at writing by, surprise, writing: if you skim through the oldest articles, you’ll notice that they were, ehem, mediocre—yet I made the conscious decision to blog and to do so in English. As a result, I think that my contemporary copy is pretty decent, and this has helped me immensely in my professional environment. I couldn’t have gotten here without going through this long journey.</p><p>The other big difference in how the content has evolved is the presence of pictures:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":26460,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Evolution of the number of posts that include images over time.</figcaption></figure></div><p>In the past, I rarely included pictures in any article: these were not necessary because the articles were shorter and because resharing articles in social media didn’t require pictures to fight for the small chance of being seen. These days, however, you must have pictures in order to make articles stand out when they are shared. And just due to the nature of the longer text, it’s useful to include pictures, diagrams or code snippets to break the wall of text and make the copy easier to digest. Shout out to <a href=\"https://draw.io/\">draw.io</a>, which has been awesome to create diagrams in some recent posts.</p><h1>Evolution: Consumption and audience</h1><p>Shifting gears a little bit, blogs were the true decentralized platform. Any individual could easily start a blog in the service of their choice, possibly self-hosting it if they didn’t want to use a commercial service, and anyone could trivially subscribe to those blogs via one of many RSS aggregators. And, yes, I know, this is true today as well: you can <em>still</em> create a blog and you can <em>still</em> subscribe to (most) blogs via RSS; however, the way blogs are “consumed” has changed.</p><p>One thing that was useful in the past were the so-called “Planets”: websites that acted as curated aggregators of blogs by topic. Some of these still exist, such as <a href=\"https://planet.kde.org\">Planet KDE</a> or <a href=\"http://fedoraplanet.org/\">Planet Fedora</a>, but they don’t <em>feel</em> like they used to. The longer posts and the (ab)use of images has made Planets unwieldy: their front pages are extremely long and contain lots of irregularly-formatted pictures, offering little content cohesion. Years ago, because articles were shorter, more fit in one page, and because Planets were popular, authors often replied to each other’s <s>controversial</s> interesting thoughts by posting on <em>their</em> platform and seeing their articles bubble up through the Planets. Much like a social media timeline these days but without a central authority.</p><p>So, without RSS aggregators or Planets, how do people find blogs now and <em>stay engaged</em>? Well… they don’t for the most part? Organic traffic is pretty much useless at building any kind of following: people come in, read the very few words they were looking for, and vanish right away. Gathering traffic from self-promotion in social media is almost a futile experiment. So the best bet is to have articles turn into “one-off hits” on sites like Hacker News. But even then, the majority of the traffic from those sources ends up being noise as well because it doesn’t lead to conversions into frequent readers. Getting content seen by a reasonable number of people is a fight with every single post.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" width=\"1071\" height=\"515\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":515,\"width\":1071,\"resizeWidth\":null,\"bytes\":89738,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Traffic to my blog during the second half of 2022 as captured by <a href=\"https://endtracker.azurewebsites.net/\">my own analytics platform</a>. I selected this period to avoid conflating the data with the creation of Blog System/5 and to avoid a humongous traffic spike driven by the <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">Fast machines, slow machines</a> post that made the other lines impossible to read. Note how there is no growth: the peaks are driven purely by Hacker News and the like.</figcaption></figure></div><p>What am I basing this on? Well, for starters, my blog has had email subscriptions for more than 10 years, first powered by FeedBurner and then by <a href=\"https://jmmv.dev/2023/06/in-house-email-subscriptions.html\">my own mechanism</a>. In that period of time, I only saw the subscribers count rise to about 170, which feels pretty pathetic to be honest. I resisted the urge to add “on-your-face” subscription popups, but the lack of those, the fact that some people are “invisible” because of RSS aggregators, and the fact that readers had to subscribe to the blog via obscure platforms… well, there have few incentives to opt into potential email spam.</p><p>Now compare this past multi-year effort of a self-hosted blog with custom email subscriptions to what I’ve experienced on Substack since the launch of Blog System/5:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" width=\"742\" height=\"453\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":453,\"width\":742,\"resizeWidth\":null,\"bytes\":20197,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Subscribers growth during the first 6 months of Blog System/5's existence. I pretty much paused publishing in March to focus on other side projects and thus haven't seen any major growth since.</figcaption></figure></div><p>I created Blog System/5 in late October 2023 and by March 2024 I had already amassed 700+ subscribers. It’s also true that I was lucky to have a few articles spread through Hacker News and other sites, and that I put a lot more effort in crafting these than what I wrote in the past, but still: using a platform that people know, that is focused on writing, and in which <em>readers already have accounts</em> helps with growth. Yes, I’m sure there is a lot of fake accounts in there given that the typical “open count” for any article hovers around 50%, but that feels impressive regardless compared to what I was able to achieve in the past.</p><h1>Evolution: Monetization</h1><p>And before parting, let’s talk about the taboo topic, should we? Every hobby has to become a side hustle these days, right, but God forbid you try to charge for it.</p><p>I have to confess that I’ve dabbled with monetizing my writing and done some experiments. These included: <a href=\"https://jmmv.dev/2009/06/trying-adsense.html\">enabling Google AdSense</a> back when I used Blogger and then <a href=\"https://jmmv.dev/2010/05/ads-gone.html\">running away from it</a>; writing paid-for <a href=\"https://jmmv.dev/2019/10/onlamp-articles.html\">articles for OnLamp</a>, which weren’t really part of this blog originally but were written in the same “spirit”; enabling optional paid subscriptions in Substack, which has generated a handful of leads; and using Amazon affiliate links for certain product-focused articles, which has also generated some sales.</p><p>None of these have generated any meaningful amount of income, but that doesn’t mean it isn’t exciting to see pennies flow in! In any case, I still struggle with the thought of pursuing monetization. It’d feel great to be paid for the effort I put in writing, but in the grand scheme of things, I would not be able to make it my primary income—and I’d probably not want it to be either—without putting in <em>a ton more</em> effort. Plus I like my content to reach as far as possible, which paywalls would prevent.</p><p>Does that mean I will <em>never</em> try to more aggressively monetize this type of content? Never say never, but I have no plans for now. That said, I will still gladly take and infinitely appreciate any donations you might send; don’t be shy!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><h1>From blogging to… newslettering?</h1><p>Why do I keep writing a blog after 20 years? Because I enjoy the <em>process</em> and the reward of seeing a complete piece be appreciated by many. I know, “views” are a vanity metric, but they do translate into tangible real-world benefits. I’m convinced that I had the chance to land a Google internship in 2008 <em>because</em> of what I wrote in my blog; I’m also pretty certain that my recent job changes have been aided by my writing; and during the last few months, I’ve met some folks I hadn’t seen for a long time and several have exclaimed “hey, I enjoy your blog!” which, let’s be honest, is flattering to hear.</p><p>Are blogs truly dead? The answer sounds like “yes”. But what if I asked you if newsletters are truly dead? The answer sounds like “of course not”, right? And, to me, these two look like essentially the same thing. Maybe the differences lie in the fact that blogs <em>used to</em> be made of much shorter posts and used to be part of a larger community, whereas newsletters focus on longer pieces distributed primarily via email… but considering how blogging itself has evolved for some (including me), the two are identical.</p><p>Which brings me to the final thought of the day: is “Blog System/5” the same as the “jmmv’s weblog” that launched 20 years ago? No, not really. They are quite different beasts at this point, but they still come from the same—even if older—person, they still scratch the same itch, and they are still my main window to showcase ideas and projects to the outside world. So, to me, they are indeed the same.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "0.0" "image/jpeg") nil "0e4f2034da716d462d18d0c470a090ab") (48 (26629 57989 832990 227000) "https://blogsystem5.substack.com/p/dos-memory-models" "Revisiting the DOS memory models" "Julio Merino" "Mon, 30 Sep 2024 15:02:25 +0000" "<p>At the beginning of the year, I wrote a <a href=\"https://blogsystem5.substack.com/p/from-0-to-1-mb-in-dos\">bunch</a> <a href=\"https://blogsystem5.substack.com/p/beyond-the-1-mb-barrier-in-dos\">of</a> <a href=\"https://blogsystem5.substack.com/p/running-gnu-on-dos-with-djgpp\">articles</a> on the various tricks DOS played to overcome the tight memory limits of x86’s real mode. There was one question that came up and remained unanswered: what were the various “models” that the compilers of the day offered? Take a look at Borland Turbo C++’s code generation menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":140059,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Borland Turbo C++ showing its Code Generation menu, which displays the list of models we cover in this article.</figcaption></figure></div><p>Tiny, small, medium, compact, large, huge… What did these options mean? What were their effects? And, more importantly… is any of that legacy relevant today in the world of 64-bit machines and gigabytes of RAM? To answer those questions, we must start with a brief review of the 8086 architecture and the binary formats supported by DOS.</p><h1>8086 segmentation</h1><p>In the 8086 architecture, which is the architecture that DOS targeted, memory references are composed of two parts: a <strong>2-byte segment</strong> “identifier” and a <strong>2-byte offset</strong> within the segment. These pairs are often expressed as <code>segment:offset</code>.</p><p>Segments are contiguous 64KB chunks of memory and are identified by their base address. To be able to address the full 1MB of memory that the 8086 supports, segments are offset from each other by 16 bytes. As you can deduce from this, segments overlap, which means that a specific physical memory position can be referenced by many segment/offset pairs.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" width=\"1456\" height=\"590\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":590,\"width\":1456,\"resizeWidth\":null,\"bytes\":64437,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of two consecutive 8086 segments and how a single physical memory address can be expressed as different segment/offset pairs.</figcaption></figure></div><p>As an example, the segmented address <code>B800h:0032h</code> corresponds to the physical address <code>B8032h</code> computed via <code>B800h * 10h + 0032h</code>. While this pair is human-readable, that’s not how the machine-level instructions encode it. Instead, instructions rely on <strong>segment registers</strong> to specify the segment to access, and the 8086 supports four of these: CS (code segment), DS (data segment), ES (extra data segment), and SS (stack segment). Knowing this, accessing this sample memory position requires first loading <code>B800h</code> into <code>DS</code> and then referencing <code>DS:0032h</code>.</p><p>One of the reasons instructions rely on segment registers instead of segment identifiers on every memory access is efficiency: encoding the segment register to use requires only 2 bits (we have 4 segment registers in total) vs. the 2 bytes that would be necessary to store the segment base. More on this later.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">More means “the next article” because there is a lot of ground to cover to explain how this connects to today’s 64-bit world. Subscribe to Blog System/5 to not miss it!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>COM files</h1><p><a href=\"https://en.wikipedia.org/wiki/COM_file\">COM files</a> are the most trivial executable format you can think of: they contain raw machine code that can be placed at pretty much any memory location and executed without any sort of post-processing. There are no relocations, no shared libraries, no nothing to worry about: you can just blit the binary into memory and run it.</p><p>The way this works is by leveraging the 8086 segmented architecture: the COM image is loaded into <em>any</em> segment and always at offset 100h within that segment. All memory addresses within the COM image must be relative to this offset (which explains the <code>ORG 100h</code> you might have seen in the past), but the image doesn’t need to know which segment it is loaded into: the loader (DOS in our case, but COM files come from CP/M actually) sets CS, DS, ES, and SS to the exact same segment and transfers control to <code>CS:100h</code>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" width=\"1456\" height=\"809\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":809,\"width\":1456,\"resizeWidth\":null,\"bytes\":160575,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">At the top, representation of a COM file as it is stored on disk. At the bottom, an explanation of how DOS proceeds to load this COM file into two different segments.</figcaption></figure></div><p>Magic! COM files are essentially PIE (<a href=\"https://en.wikipedia.org/wiki/Position-independent_code\">Position Independent Executables</a>) without requiring any sort of MMU or fancy memory management by the kernel.</p><p>Unfortunately, not everything is rosy. The problem with COM files is that they are limited in size: because they are loaded into one segment and segments are 64KB-long at most, the largest a COM file can be is 64KB (minus the 256 bytes reserved for the PSP at the front). This includes code <em>and</em> data, and 64KB isn’t much of either. Obviously, when the COM program is running, it has free reign over the processor and can access any memory outside of its single segment by resetting CS, DS, ES, and/or SS, but all memory management is left to the programmer.</p><h1>EXE files</h1><p>To resolve the limitations of COM files in DOS, Microsoft came up with a different executable format for DOS: the <a href=\"https://en.wikipedia.org/wiki/DOS_MZ_executable\">EXE file</a>, also known as an MZ executable.</p><p>Compared to COM files, EXE files have some internal structure and are not bound by the 64KB limit: they can contain larger code and data blocks in them. But… how is that possible given that 8086 segments are still 64KB-long at most? The answer is simple: EXE files contain <em>multiple</em> segments and spread code and data over them.</p><p>To support multiple segments at runtime, EXE files contain relocation information in their header. Conceptually, relocations tell the loader which positions in the binary image contain “incomplete” pointers that need to be fixed up with the segment base addresses of the segments after they are loaded in memory. DOS, acting as the loader, is responsible for doing this patching.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" width=\"1456\" height=\"451\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":451,\"width\":1456,\"resizeWidth\":null,\"bytes\":107229,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of an EXE file and the content of one of its code segments. Within the code, we can see a near pointer and two far pointers that will require patching at runtime to point to the other segments in the binary.</figcaption></figure></div><p>How many segments go into the EXE though? Well, it depends, because not all programs have the same needs. Some programs are tiny overall and could fit in a COM file. Other programs contain large portions of data but little code. Another set of programs contain a lot of code and data. Etc.</p><p>So then the question becomes: how can the one-size-fits-all EXE format support these options in an efficient manner? This is where memory models become important, but to talk about those, we must do another detour through pointer types.</p><h1>Pointer types</h1><p><a href=\"https://en.wikipedia.org/wiki/Locality_of_reference\">The locality principle</a> says that “a processor tends to access the same set of memory locations repetitively over a short period of time”. This is easy to reason about: code normally runs almost-sequentially and data is often packed in consecutive chunks of memory like arrays or structs.</p><p>Because of this, expressing <em>all</em> memory addresses as 4-byte <code>segment:offset</code> pairs would be wasteful, and this is where 8086’s segmentation plays in our favor again. We can first load a segment register with the base address of “all of our data” and then all we need to do is record addresses as offsets within that segment. The fewer times we have to reload segment registers, the better because the less information we have to carry around in every instruction and in every memory reference.</p><p>But we can’t just always use offsets within a single segment because we may be dealing with more than one segment. And offsets come in various sizes so using a unique size for them all would be wasteful too. Which means memory addresses, or <em>pointers</em>, need to have different shapes and forms, each best suited for a specific use case.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":32700,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of two short pointers: one addressing a higher memory address (possibly a forward jump to skip a conditional branch) and one addressing a lower memory address (probably a backwards jump to return to the beginning of a loop).</figcaption></figure></div><p><strong>Short pointers</strong> take just 1 byte and express a <em>relative</em> address from the instruction being executed. These are specially useful in jump instructions to keep their binary representation compact: jumps appear in every conditional or loop, and in many cases, conditional branches and loop bodies are so short that minimizing the amount of code required to express these branch points is worthwhile.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":28003,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of a near pointer.</figcaption></figure></div><p><strong>Near pointers</strong> can reference addresses within the 64KB segment implied “by context” and are 2-byte long. For example, an instruction like <code>JMP 12829h</code> does not usually need to carry information about the segment this address references because code jumps are almost-always within the same CS of the code issuing the jump. Similarly, an instruction like <code>MOV AX, [5610h]</code> assumes that the given address references the currently-selected DS so that it doesn’t have to express the segment every time. The offset encoded by the near pointer can be relative or absolute.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" width=\"1456\" height=\"485\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":485,\"width\":1456,\"resizeWidth\":null,\"bytes\":48837,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of a far pointer referencing an address in another segment.</figcaption></figure></div><p><strong>Far pointers</strong> can reference any memory address by encoding a segment and an offset. They are 4-byte long. When used in pointer arithmetic, the segment stays fixed and only the offset varies. This is relevant, for example, when iterating over arrays as we can load the base address into DS or ES just once and then manipulate the offset within the segment. However, this means that such iteration has a maximum range of 64KB.</p><p><strong>Huge pointers</strong> are like far pointers in that they are also 4-byte long and can reference any memory address, but they eliminate the 64KB limitations around pointer arithmetic. They do so by recomputing the segment and offset portions on every memory access (remember that segments are overlapping so we can come up with multiple segment/offset pairs for any physical address). As you can imagine, this requires extra code on every memory access and thus huge pointers impose a noticeable tax on run time.</p><h1>Memory models</h1><p>And now that we know about 8086 segmentation, EXE files, and pointer types… we can finally tie all of these concepts together to demystify the memory models we used to see in old compilers for DOS.</p><p>Here is the breakdown:</p><ul><li><p><strong>Tiny</strong>: This is the memory model of COM images. The whole program fits in one 64KB segment and all segment registers are set to this one segment at startup. This means that all pointers within the program are short or near because they always reference this same 64KB segment.</p></li><li><p><strong>Small</strong>: Uses near pointers everywhere, but the data and stack segments are different from the code segment. This means that these programs have 64KB for code and 64KB for data.</p></li><li><p><strong>Compact</strong>: Uses short pointers for the code but far pointers for the data. This means that these programs can use the full 1 MB memory space for data and, as such, it was particularly useful for games where the code would be as tight as possible while being able to load and reference all assets in memory.</p></li><li><p><strong>Medium</strong>: The opposite from compact. Uses far pointers for code and short pointers for data. This model is weird because, if you had a program with a lot of code, it was probably the kind of program that handled a lot of data too.</p></li><li><p><strong>Large</strong>: Uses far pointers everywhere so both code and data can reference the full 1 MB address space. However, because of what far pointers are, all memory <em>offsets</em> are 64 KB at most which means data structures and arrays are limited in size.</p></li><li><p><strong>Huge</strong>: Uses huge pointers everywhere. This overcomes the limitations of the large model by emitting code to compute the absolute addresses of every memory access and allows structs and arrays that span over 64 KB of memory. Obviously, this comes at a cost: the program code is now larger and the runtime cost is much bigger.</p></li></ul><p>And that’s it!</p><p>It is worth highlighting that these models were all <em>conventions</em> that a vintage C compiler used to emit code. If you were writing assembly by hand, you could mix-and-match pointer types to do whatever you wanted given that these concepts had no special meaning to the OS.</p><h1>Evolving to today’s world</h1><p>Everything I have told you about until now is legacy stuff that you could easily dismiss as useless knowledge. Or could you?</p><p>One thing I did <em>not</em> touch upon is the concept of <strong>code density</strong> and how it relates to performance. The way we choose to express pointers in the code has a direct impact on code density, so when we evolve computing from 16-bit machines like the 8086 to contemporary 64-bit machines, pointer representations grow by <em>a lot</em> and we face some hard choices.</p><p>But to explain all of this and answer the performance questions, you’ll have to wait for the next article. So subscribe now to not miss out on that one!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "0.0" "image/jpeg") nil "b135f753e1bbac7822818575d8a4bb2a") (47 (26628 41924 622965 528000) "https://blogsystem5.substack.com/p/bazel-at-snowflake-two-years-in" "Bazel at Snowflake two years in" "Julio Merino" "Sat, 15 Mar 2025 01:00:58 +0000" "<p>Two and a half years ago, I <a href=\"https://jmmv.dev/2022/10/bye-microsoft-hi-snowflake.html\">joined Snowflake</a> to help their mission of migrating to Bazel. I spent the first year of this period as an Individual Contributor (IC) diving deep into the migration tasks, and then I took over the Tech Lead (TL) role of the team to see the project through completion.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":792369,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>This week, we publicly announced that we completed our migration to Bazel for the largest part of our codebase and we provided details on our journey. I did not publish that article here for obvious reasons, so… today’s entry is going to be a light one: all I want to do is point you at our announcement as well as the various <em>other</em> related articles that came before it.</p><p>Don’t despair though: those articles, including the announcement, are all full of technical details—just like the kind of content you expect to receive from Blog System/5. So, even if this piece is light, you have enough reading material for the weekend via the links below.</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\">“Addressing Bazel OOMs”</a></strong><br><em>March 16th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\" width=\"1456\" height=\"972\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":972,\"width\":1456,\"resizeWidth\":null,\"bytes\":1420523,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\",\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"></picture><div></div></div></a></figure></div><p>This was the very first article that we in the Engineering Systems organization—previously known as Developer Productivity Engineering—wrote publicly about our work. Me writing it was no coincidence as I was the one advocating for more openness about the cool stuff we were doing. Yes, I missed blogging about Bazel <a href=\"https://jmmv.dev/tags/bazel/index.html\">as I had done in the years prior</a>.</p><p>In this article about Out-Of-Memory (OOM) conditions, I covered the very interesting problem of trying to fit Bazel builds into limited laptop resources. This was déjà-vu for me: back when I was in the Blaze team at Google, I owned the same problem of making Blaze, a tool that had grown assuming massive workstations, run decently on machines with limited resources.</p><p>The problems were technically challenging and worth talking about, hence this article. In it, I covered three issues: preventing Bazel from spawning too many memory-hungry compilers and linkers at once; making nested builds behave nicely; and tuning Bazel to drive a large number of remote tasks with limited memory resources.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\">“Analyzing OOMs in IntelliJ with Bazel”</a></strong><br><em>October 6th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\" width=\"1300\" height=\"550\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":550,\"width\":1300,\"resizeWidth\":null,\"bytes\":143457,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>Our saga dealing with OOMs was arduous and long, which you can tell by the time gap between the previous article and this one.</p><p>In this piece, I looked at how IntelliJ itself was running into memory limits, which resulted in the IDE and its container VM freezing during normal operation. The result of this work was careful tuning of the Bazel project settings to make it fit within reasonable limits, but the interesting part—and the one described here—was the process to arrive to those findings.</p><p>Not too long after I wrote this, we pivoted away from constrained laptop builds to cloud-based workstations, which made all OOM conditions vanish at the expense of using much more RAM (maybe <em>too much</em> RAM, but alas… it’s cheap). Stay tuned for an upcoming article (not from me this time!) on this topic.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\">“Build farm visualizations”</a></strong><br><em>October 20th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\" width=\"1456\" height=\"561\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":561,\"width\":1456,\"resizeWidth\":null,\"bytes\":895757,\"alt\":\"\",\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/build-farm-visualizations.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>As part of our migration to Bazel, we didn’t just convert our build from one tool to another. We also decided to deploy our own remote execution cluster from the get go based on <a href=\"https://github.com/buildbarn\">Buildbarn</a> which… gave us its own set of problems. Buildbarn’s architecture is straightforward in paper, but there are a ton of knobs to control how it runs. Making it scale to the huge volume of traffic we experience was not an easy feat.</p><p>One specific problem we faced was overall poor performance of our cluster, which was eventually root-caused to our remote execution workers using slow local storage volumes. This issue had escaped us for a while, and it wasn’t until I wrote a tool to <em>visualize</em> the cluster behavior that it didn’t become obvious. From there, the solution was easy.</p><p>Wanna know more? We are hosting a 1-day conference <em>next week</em> on Buildbarn specifically. <a href=\"https://docs.google.com/forms/d/e/1FAIpQLSeG4We59b6labcH77JOiblk7F3MRi8LH6SbjIrFTNCBYXeJnA/viewform\">See the schedule and sign up</a> if you can make it!</p><div><hr></div><p><strong><a href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\">“Fast and Reliable Builds at Snowflake with Bazel”</a></strong><br><em>March 13th, 2025</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\" width=\"1200\" height=\"514\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":514,\"width\":1200,\"resizeWidth\":null,\"bytes\":172503,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>And finally, the crown jewel. This is the official article published just yesterday where I present the 2-year journey of our migration. In it, I explain the challanges that we faced with our C++ and Java codebases specifically, the choices behind our use of remote execution, and the path we took to production. I conclude with a glimpse on what lies ahead of us.</p><div><hr></div><p>That’s all for today. I promised it would be short :)</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "0.0" "image/jpeg") nil "08634f5e810c10b815d773ae7bac4760") (46 (26628 41924 621378 245000) "https://blogsystem5.substack.com/p/hardware-autoconfiguration" "Hardware discovery: ACPI & Device Tree" "Julio Merino" "Sat, 01 Mar 2025 00:10:54 +0000" "<p>If you grew up in the PC scene during the 1980s or early 1990s, you know how painful it was to get hardware to work. And if you did not witness that (lucky you) here is how it went: every piece of hardware in your PC—say a sound card or a network card—had physical switches or jumpers in it. These switches configured the card’s I/O address space, interrupts, and DMA ports, and you had to be careful to select values that did not overlap with other cards.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" width=\"663\" height=\"448\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":448,\"width\":663,\"resizeWidth\":null,\"bytes\":89630,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Portion of a Sound Blaster Pro ISA card focusing on the jumpers to configure its I/O settings.</figcaption></figure></div><p>But that wasn’t all. Once you had configured the physical switches, you had to tell the operating system and/or software <em>which</em> specific cards you had and how you had configured them. Remember <code>SET BLASTER=A220 I5 D1 H5</code>? This DOS environment variable told programs which specific Sound Blaster you had installed and which I/O settings you had selected via its jumpers.</p><p>Not really fun. It was common to have hardware conflicts that yielded random lock-ups, and thus <a href=\"https://wiki.osdev.org/ISA\">ISA “Plug and Play”</a>, or PnP for short, was born in the early 1990s—a protocol for the legacy ISA bus to enumerate its devices and to configure their settings via software. Fast-forward to today’s scene where we just attach devices to external USB connectors and things “magically work”.</p><p>But how? How does the kernel know which physical devices exist and how does it know which of the many device drivers it contains can handle each device? Enter the world of hardware discovery.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If this sounds interesting, please consider subscribing to Blog System/5! It’s completely free but you can also choose to donate to keep me writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Hardware topology</strong></h1><p>When you learn about the <a href=\"https://en.wikipedia.org/wiki/Von_Neumann_architecture\">Von Neumann architecture</a> in school, you are typically told that there is a CPU, a chunk of memory, and… “I/O devices”. The CPU and memory portions are where all the focus is put and the I/O devices portion is always “left to the reader”. However, there is <em>a lot</em> of stuff happening in that nebulous cloud.</p><p>The first question that arises is: what’s in that I/O cloud? Well, take a look:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" width=\"785\" height=\"576\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":576,\"width\":785,\"resizeWidth\":null,\"bytes\":93266,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The Windows 2000 Device Manager showing the devices by their connection, not by their type. I've chosen to show you this configuration of a virtual machine instead of what a current Windows 11 system shows because the older view is simpler to digest.</figcaption></figure></div><p>Whoa, that’s a lot of stuff, but we can classify the items in the “nebulous cloud of I/O devices” into two categories:</p><ul><li><p>The devices themselves, obviously.</p></li><li><p>The busses that connect those devices to the CPU.</p></li></ul><p>Both are important: you might have a fancy keyboard with extra keys that requires a special driver, and this keyboard might come in PS/2 and USB versions. The driver for the keyboard may be the same for each version, but the “glue” that attaches this keyboard to either bus is different, and the way the kernel can tell whether the keyboard is attached to one port or another also differs.</p><p>So how does the kernel know how to find hardware without tons of repeated code for every bus, you ask? It does so via its knowledge of the hardware topology. Just above, I showed you Windows’ view of this, but for the rest of this article, I’ll use the BSD internals (and NetBSD specifically) because that’s what I know best. Don’t let that put you off though: all kernels have to do something similar and the differences among them are likely not meaningful.</p><p>Here is a little snippet of the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/amd64/conf/GENERIC\">default NetBSD kernel configuration file for the amd64 platform</a>. This snippet lays out the topology of serial ports in the PC and the busses in which they may appear:</p><pre><code><code>pci*    at mainbus? bus ?
pcib*   at pci? dev ? function ?
puc*    at pci? dev ? function ?
com*    at puc? port ?
isa0    at mainbus?
isa0    at pcib?
com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3
acpi0   at mainbus0
com*    at acpi?</code></code></pre><p>Daunting if you have never seen anything like this, I know, but let me translate this to a diagram:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" width=\"1456\" height=\"922\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/e1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":922,\"width\":1456,\"resizeWidth\":null,\"bytes\":85835,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Representation of how the com device is expected to appear under various busses according to the kernel configuration file.</figcaption></figure></div><p>Much clearer in picture form, right? What this chunk of configuration does is tell the kernel the places where the <code>com</code> driver can find serial ports. We have a chunk that says that <code>com0</code> and <code>com1</code> can appear on the ISA bus at <em>specific</em> I/O addresses and interrupts, and in turn that the ISA bus may be a directly-addressable physical bus (<code>isa0 at mainbus?</code>) and/or an ISA bus exposed via a PCI bridge (<code>isa0 at pcib?</code>). Then, we have additional entries telling us that the serial ports can also be configured via ACPI (<code>com* at acpi?</code>), and that the serial ports may exist on expansion cards (<code>com* at puc?</code>) providing communication ports via the PCI bus (<code>puc* at pci?</code>).</p><p>The problem is: the kernel configuration tells us <em>what may exist</em>, not <em>what actually exists</em> on a machine. In a sense, the configuration file “wires” the code of the device drivers like <code>com</code> so that they can find devices that appear under the <code>isa</code>, <code>pci</code>, or <code>acpi</code> busses. But the kernel must still, at runtime, check and see where the devices actually are. How does that happen?</p><h1><strong>Hardware auto-configuration</strong></h1><p>To answer the question of how the kernel discovers which hardware is present and where it is, let’s dissect NetBSD’s <a href=\"https://man.netbsd.org/autoconf.9\">autoconf(9)</a> manual page:</p><blockquote><p>Autoconfiguration is the process of matching hardware devices with an appropriate device driver. In its most basic form, autoconfiguration consists of the recursive process of finding and attaching all devices on a bus, including other busses.</p></blockquote><p>From this paragraph, we can extract the following: the kernel contains a collection of device drivers (like the <code>com</code> presented earlier). Device drivers are just code that knows how to interact with specific devices, but the “location” of these devices in the hardware topology may vary (the “bindings” to <code>isa</code>, <code>puc</code>, and <code>acpi</code> in the earlier example). Moving on:</p><blockquote><p>The autoconfiguration framework supports direct configuration where the bus driver can determine the devices present. The autoconfiguration framework also supports indirect configuration where the drivers must probe the bus looking for the presence of a device. Direct configuration is preferred since it can find hardware regardless of the presence of proper drivers.</p></blockquote><p>Direct and indirect configuration. Hmm. This sounds like the PnP story, and it kinda does. See, pay close attention to these two lines from the earlier snippet:</p><pre><code><code>com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3</code></code></pre><p>These are the BSD equivalent of the <code>SET BLASTER=A220 I5 D1 H5</code> command for DOS I mentioned in the introduction: they tell the kernel which precise addresses and interrupts to use for the two standard PC serial ports <em>if an ISA bus is present</em>.</p><p>But what about <code>com* at puc?</code> and <code>com* at acpi?</code>? These lines are neat because they do <em>not</em> tell us, in advance, where to find the serial ports: we expect the kernel to discover those details at runtime so that we don’t have to recompile the kernel when the hardware changes. But even if these two look similar, they are quite different: the <code>com* at puc?</code> is an indirect configuration entry: the <code>puc</code> driver will have to probe the PCI bus for the presence of a communications card and, if one exists, tell the <code>com</code> driver that it can attach to it. On the other hand, the <code>com* at acpi?</code> entry is direct: the kernel will read the ACPI configuration (a static table) to know where the ports are and then use those details to configure the <code>com</code> driver.</p><p>Alright, so this raises <em>another</em> question. What <em>is</em> ACPI?</p><h1><strong>ACPI</strong></h1><p>ACPI, despite being declared with <code>acpi0 at mainbus0</code> in a form similar to <code>isa0 at mainbus?</code>, is <em>not</em> a bus: ACPI does not physically connect devices to one another. To understand what ACPI does, we can start by realizing that it stands for <a href=\"https://en.wikipedia.org/wiki/ACPI\">Advanced Configuration and Power Interface</a> and then, quoting the Wikipedia article:</p><blockquote><p>Advanced Configuration and Power Interface (ACPI) is an open standard that operating systems can use to discover and configure computer hardware components, to perform power management (e.g. putting unused hardware components to sleep), auto configuration (e.g. Plug and Play and hot swapping), and status monitoring.</p></blockquote><p>ACPI is about configuration, and the kernel uses the ACPI tables, present in any modern PC, to find where devices are. To illustrate how this works, let’s look at the <code>com* at acpi?</code> line. This line says that the serial port can be configured via ACPI if ACPI happens to have an entry for it. And you know, we can peek into the ACPI tables of a running machine to see what that might be:</p><pre><code><code># acpidump -dt | grep -A15 COM1
Device (COM1)
{
Name (_HID, EisaId (\"PNP0501\") /* 16550A-compatible COM Serial Port */)  // _HID: Hardware ID
Name (_UID, One)  // _UID: Unique ID
Name (_CRS, ResourceTemplate ()  // _CRS: Current Resource Settings
{
IO (Decode16,
0x03F8,             // Range Minimum
0x03F8,             // Range Maximum
0x01,               // Alignment
0x08,               // Length
)
IRQNoFlags ()
{4}
})
}
# █</code></code></pre><p><em>(Pro-tip: you can use </em><code>acpidump</code><em> to extract the Windows license key bound to your machine, if any. I’ve needed to do this in the past to install Windows in a VM after replacing the host OS with FreeBSD.)</em></p><p>Voila. The ACPI tables provided by the system tell us a similar story to what the explicit <code>com0 at isa?</code> entry did (and no surprise here because this is a legacy device): there is a serial port at base address 0x3f8 that uses interrupt 4. But also, this table tells us the hardware identifier for this entry: <code>PNP0501</code>. Grepping through the NetBSD kernel code base for this identifier, we land on the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/dev/acpi/com_acpi.c#L60\">dev/acpi/com_acpi.c</a> file:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
// ...
/* 16550A-compatible COM port */
{ .compat = \"PNP0501\", .value = COM_TYPE_NORMAL },
// ...
};</code></code></pre><p><em>(Another pro-tip: master <a href=\"https://github.com/BurntSushi/ripgrep\">ripgrep</a>. Knowing how to find a needle in the haystack of a large code base will grant you super-powers among your coworkers. Being able to pinpoint where specifically to start an investigation based on a “random-looking” string is invaluable.)</em></p><p>Aha! This <code>com_acpi.c</code> file provides the necessary glue to direct the generic serial port <code>com</code> driver to the hardware via whatever the ACPI tables prescribe. From here, the kernel can proceed to <em>attach</em> the driver to the device and connect the dots between the user-space <code>/dev/ttyS0</code> interface to the physical serial port.</p><h1><strong>Device Tree</strong></h1><p>In the world of embedded devices powered by SOCs—\"<a href=\"https://en.wikipedia.org/wiki/System_on_a_chip\">System on a Chip</a>\", a term that describes single chips that provide all functions to build a computer, ranging from the CPU to sound and network cards—we don’t have ACPI tables. What we used to have instead was explicit code <em>for every board/chip combination</em> that knew how to address the hardware in each SOC. Linux used to be a mess of half-baked and abandoned forks, each supporting a different board without hopes of unification into mainline due to the lack of generic interfaces.</p><p>The <a href=\"https://www.devicetree.org/\">Device Tree</a> specification fixed this issue for the most part for architectures like aarch64. With Device Tree, each hardware or OS vendor provides a static table that describes the layout of a board’s hardware separately from the code of the kernel. Then, the kernel peeks into this table to know which devices exist and where they are in the machine layout, much like it does with ACPI.</p><p>A big difference with ACPI, however, is that the kernel cannot query the Device Tree from the hardware because… well, the Device Tree is external to the hardware. The kernel expects the Device Tree to “exist in memory” either because the kernel image <em>embeds</em> the Device Tree for the target board or because the boot loader loads the Device Tree from disk and passes it to the kernel.</p><p>Once the kernel has the Device Tree though, the hardware discovery process is similar to the one in ACPI: the kernel scans the Device Tree and looks for drivers that can attach to device nodes based on hardware identifiers. From the perspective of the kernel configuration, things look very similar between amd64 and aarch64. See this snippet from the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/evbarm/conf/GENERIC64\">generic kernel of the evbarm port</a>:</p><pre><code><code>armfdt0     at root
simplebus*  at fdt? pass 0
com*        at fdt? pass 4</code></code></pre><p>This configuration snippet tells the aarch64 kernel that a <code>com</code> device may appear on <code>fdt</code>, which stands for “Flat Device Tree”. In turn, <code>armfdt0 at root</code> says that there is a specific driver named <code>armfdt0</code> that provides access to the <code>fdt</code> loaded by the boot loader on an ARM machine.</p><p>We can inspect the Device Tree from the command line as the Device Tree is exposed via the same interface that OpenFirmware used due to its historical roots. For example, to fetch the portion of the Device Tree for the serial port on an aarch64 machine:</p><pre><code><code># ofctl serial1
[Caching 121 nodes and 781 properties]
clocks                  0000000e 00000000 ........ ........   ........
compatible              6272636d 2c62636d 32383335 2d617578   \"brcm,bcm2835-aux
0010:       2d756172 7400.... ........ ........   -uart\"
interrupts              00000001 0000001d ........ ........   ........
name                    73657269 616c00.. ........ ........   \"serial\"
phandle                 0000004c ........ ........ ........   ...L
pinctrl-0               0000000f ........ ........ ........   ....
pinctrl-names           64656661 756c7400 ........ ........   default.
reg                     7e215040 00000040 ........ ........   ~!P@...@
status                  6f6b6179 00...... ........ ........   okay.
# █</code></code></pre><p>A binary dump. OK, fine, we can intuit <em>something</em> out of this, but it isn’t particularly clear. The problem here is that we are looking at the binary encoding of the Device Tree (the DTB). But the DTB is built from a set of corresponding source files (one or more DTS files), and if we look at the common <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/external/gpl2/dts/dist/arch/arm/boot/dts/bcm283x.dtsi#L385\">DTS for Broadcom 283x boards</a>, we find the following more-readable content:</p><pre><code><code>/ {
aliases {
/* ... */
serial1 = \"/soc/serial@7e215040\";
};
soc {
/* ... */
serial@7e215040 {
compatible = \"brcm,bcm2835-aux-uart\";
reg = <0x7e215040 0x40>;
interrupts = <0x01 0x1d>;
clocks = <0x0e 0x00>;
status = \"okay\";
pinctrl-names = \"default\";
pinctrl-0 = <0x0f>;
phandle = <0x4c>;
};
};
};</code></code></pre><p>The detail to highlight here is the <code>brcm,bcm2835-aux-uart</code> identifier. If we search for this in the code base with the ripgrep super-powers you gained earlier, we find the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/arch/arm/broadcom/bcm2835_com.c#L54\">arch/arm/broadcom/bcm2835_com.c</a> file, which contains:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
{ .compat = \"brcm,bcm2835-aux-uart\" },
DEVICE_COMPAT_EOL
};</code></code></pre><p>Once again: we found the glue that connects a generic <code>com</code> driver to a specific hardware device.</p><h1><strong>Loading DTBs at boot time</strong></h1><p>Let’s dig a bit further though. I mentioned earlier that the boot loader is responsible for loading the Device Tree into memory and passing it to the kernel. How is that done? Well, it really depends on the specific machine you are dealing with. In here, I’m just going to <em>very briefly</em> touch upon how the Raspberry Pi does it because that’s the specific non-PC hardware I have access to. And for this, I’ll take you through the investigative journey I took.</p><p>The specific problem I faced was that NetBSD was <em>not</em> able to discover the SPI bus even when I had enabled the right SPI driver in the kernel for my Raspberry Pi 3B. By that point, I was aware that DTBs existed and I suspected that something might be wrong with them, so my first instinct was to check and see what the DTB had to say about the SPI.</p><p>Digging through the FAT partition of the disk image I was using, I found the <code>dtb/broadcom/bcm2837-rpi-3-b.dtb</code> file—the DTB for my specific board. The way the Raspberry Pi boot loader finds this file is by looking for a file matching the board’s own name (<code>bcm2837-rpi-3-b.dtb</code>) in the location specified by the <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html#os_prefix\">os_prefix configuration property</a> in the <code>config.txt</code> placed at the root of the FAT partition.</p><p>Once I found that file and after learning about the <code>dtc</code> tool (the Device Tree Compiler) which transforms DTS files into DTBs and vice versa, I could decompile the DTS:</p><pre><code><code>$ dtc -I dtb -O dts bcm2837-rpi-3-b.dtb -o bcm2837-rpi-3-b.dts
... various warnings ...
$ █</code></code></pre><p>Then, peeking into the decompiled DTS file, I found:</p><pre><code><code>spi@7e204000 {
compatible = \"brcm,bcm2835-spi\";
reg = <0x7e204000 0x200>;
interrupts = <0x02 0x16>;
clocks = <0x06 0x14>;
#address-cells = <0x01>;
#size-cells = <0x00>;
status = \"disabled\";
dmas = <0x0b 0x06 0x0b 0x07>;
dma-names = \"tx\\0rx\";
phandle = <0x49>;
};</code></code></pre><p>I verified that the SPI kernel driver recognized the <code>brcm,bcm2835-spi</code> identifier just as we did earlier on for the serial port. And it did match, so I was puzzled for a moment.</p><p>But then I noticed the innocuous <code>status = \"disabled\"</code> line. Aha! The SPI device was disabled by default. I modified that line with <code>status = \"okay\"</code> following what other entries in the DTS did, recompiled the DTS into the DTB:</p><pre><code><code>$ dtc -I dts -O dtb bcm2837-rpi-3-b.dts -o bcm2837-rpi-3-b.dtb
... various warnings ...
$ █</code></code></pre><p>… rebooted the board and… voila!</p><pre><code><code># dmesg | grep spi
[     1.000003] bcmspi0 at simplebus1: SPI
[     1.000003] bcmspi0: interrupting on icu irq 54
[     1.000003] spi0 at bcmspi0: SPI bus
# █</code></code></pre><p>The kernel successfully attached the SPI driver and the SPI bus started working, which in turn led to a multi-hour debugging session to make the EndBASIC ST7735S driver work—but in the end it did.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"6c85b644-99b2-41ff-bdfd-3baee6e94460\",\"duration\":null}\"></div><p>Yes, there are nicer ways to do what I did here because the DTBs are provided by upstream and you should not be modifying them. What you should do instead is create a DTB overlay, which is a separate small DTB that “patches” the upstream DTB, and then tell the boot loader to process it via the <code>dtoverlay</code> stanza in the <code>config.txt</code> file. Details left to you, reader. Just beware that the Raspberry Pi boot loader is picky about file paths and <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html\">the documentation is your friend</a> here.</p><h1><strong>How do ACPI and Device Tree differ?</strong></h1><p>Based on everything I told you about here, ACPI and Device Tree look oddly similar—and that’s because they are! From the perspective of <em>describing</em> hardware to the kernel, the two technologies are equivalent, but they differ for historical reasons. ACPI has its roots in APM, a PC technology, whereas Device Tree is based on <a href=\"https://en.wikipedia.org/wiki/Open_Firmware\">OpenFirmware</a>, a technology that originated at Sun Microsystems for its SPARC machines and that was later used by Apple on their PowerPC-based Macs.</p><p>One difference between the two, though, is that ACPI does more than just describe hardware. ACPI provides a bunch of hardware-specific routines in a bytecode that the operating system can call into to manipulate the hardware. This is often maligned because ACPI introduces non-free and opaque blobs in the interaction between the operating system kernel and the hardware, but <a href=\"https://mjg59.dreamwidth.org/68350.html\">Matthew Garret has a great essay on why ACPI is necessary</a> and why it is better than all other alternatives, possibly including Device Tree.</p><p>In any case, that’s all for today. I found this exercise of dealing with the Device Tree pretty fun and I thought I could share something interesting with you all. I intentionally omitted many details because the topic of hardware configuration is vast and tricky, but you can continue building your knowledge from the bits above and from the fabulous <a href=\"https://wiki.osdev.org/\">OSDev wiki</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">And as always, if any of this was interesting, subscribe to Blog System/5 now. You’ll receive more content like this and you’ll support my future writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "0.0" "image/jpeg") nil "a0d442c6be8f7b4787bc1375257e4967") (45 (26628 41924 602264 525000) "https://blogsystem5.substack.com/p/windows-nt-vs-unix-design" "Windows NT vs. Unix: A design comparison" "Julio Merino" "Mon, 09 Sep 2024 15:30:16 +0000" "<p>Over the years, I’ve repeatedly heard that Windows NT is a very advanced operating system and, being a Unix person myself, it has bothered me to not know <em>why</em>. I’ve been meaning to answer this question for years and I can do so now, which means I want to present you my findings.</p><p>My desire to know about NT’s internals started in 2006 when I applied to the Google Summer of Code program to develop Boost.Process. I needed such a library for ATF, but I also saw the project as a chance to learn something about the Win32 API. This journey then continued in 2020 with me <a href=\"https://jmmv.dev/2020/10/bye-google-hi-microsoft.html\">choosing to join Microsoft</a> after a long stint at Google and me buying the <a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals</a> 5th edition book in 2021 (which I never fully read due to its incredible detail and length). None of these made me learn what I wanted though: the ways in which NT fundamentally differs from Unix, if at all.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":1049872,\"alt\":\"\",\"title\":\"\",\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>Then, at the end of 2023, the <a href=\"https://blogsystem5.substack.com/p/windows-nt-peeking-into-the-cradle\">Showstopper</a> book sparked this curiosity once again. And soon, a new thought came to mind: the Windows Internals 5th edition book was too obtuse but… what about the first edition? Surely it must have been easier to digest because the system was much simpler back in the early 1990s. So lo and behold, I searched for this edition, found it under the title <a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT</a>, read it cover to cover, and took notes to evaluate NT vs. Unix.</p><p>Which brings me to this article—a collection of thoughts comparing the design of NT (July 1993) against contemporary Unix systems such as 4.4BSD (June 1994) or Linux 1.0 (March 1994). Beware that, due to my background, the text is written from the point of view of a Unix “expert” and an NT “clueless”, so it focuses on describing the things that NT does differently.</p><h1>Mission</h1><p><a href=\"https://en.wikipedia.org/wiki/Unix\">Unix</a>’s history is long—much longer than NT’s. Unix’s development started in 1969 and its primary goal was to be a convenient platform for programmers. Unix was inspired by <a href=\"https://en.wikipedia.org/wiki/Multics\">Multics</a>, but compared to that other system, Unix focused on simplicity which is a trait that let it triumph over Multics. Portability and multitasking were not original goals of the Unix design though: these features were retrofitted in the many “forks” and reinventions of Unix years later.</p><p>On Microsoft’s side, the first release of MS-DOS launched in August 1981 and the first release of “legacy Windows” (the DOS-based editions) launched in November 1985. While MS-DOS was a widespread success, it wasn’t until <a href=\"https://en.wikipedia.org/wiki/Windows_3.0\">Windows 3.0</a> in May 1990 that Windows started to really matter. Windows NT was conceived in 1989 and saw the light with the NT 3.1 release in July 1993.</p><p>This timeline gave Microsoft an edge: the design of NT started 20 years after Unix’s, and Microsoft already had a large user base thanks to MS-DOS and legacy Windows. The team at Microsoft designing NT had the hindsight of these developments, previous experience developing other operating systems, and access to more modern technology, so they could “shoot for the moon” with the creation of NT.</p><p>In particular, NT started with the following design goals as part of its mission, which are in stark contrast to Unix’s:</p><ol><li><p>portability,</p></li><li><p>support for multiprocessing systems (SMP), and</p></li><li><p>compatibility with DOS, legacy Windows, OS/2, and POSIX.</p></li></ol><p>These were not goals to scoff at and meant that NT started with solid design principles from the get go. In other words: these features were all present from day one and not bolted on at a later stage like they were in many Unixes.</p><h1>The kernel</h1><p>Now that we know some of these design goals and constraints, let’s take a look at the specifics of how they are implemented.</p><p>Unix is, with few exceptions like <a href=\"https://www.minix3.org/\">Minix</a> or <a href=\"https://www.gnu.org/software/hurd/\">GNU Hurd</a>, implemented as a monolithic kernel that exposes a collection of system calls to interact with the facilities offered by the operating system. NT, on the other hand, is a hybrid between a monolithic kernel and a microkernel: the privileged component, known as the <em>executive</em>, presents itself as a collection of modular components to user-space <em>subsystems</em>. The user-space subsystems are special processes which “translate” the APIs that the applications consume (be it POSIX, OS/2, etc.) into executive system calls.</p><p>One important piece of the NT executive is the Hardware Abstraction Layer (HAL), a module that provides abstract primitives to access the machine’s hardware and that serves as the foundation for the rest of the kernel. This layer is the key that allows NT to run on various architectures, including i386, Alpha, and PowerPC. To put the importance of the HAL in perspective, contemporary Unixes were coupled to a specific architecture: yes, Unix-the-concept was portable because there existed many different variants for different machines, but the implementation was not. SunOS originally only supported the Motorola 68000; 386BSD was the first port of BSD to the Intel architecture; IRIX was the Unix variant for Silicon Graphic’s MIPS-based workstations; and so on. This explains why NetBSD’s main focus on portability via a minimal shim over the hardware was so interesting at the time: other operating systems, except NT, did <em>not</em> have this internal clean design, and NT had come years before.</p><p>Another important piece of the NT executive is its support for multiprocessing systems and its preemptive kernel. The kernel has various interrupt levels (<a href=\"https://en.wikipedia.org/wiki/Spl_(Unix)\">SPLs</a> in BSD terminology) to determine what can interrupt what else (e.g. a clock interrupt has higher priority than a disk interrupt) but, more importantly, the kernel threads can be preempted by other kernel threads. This is “of course” what every high-performance Unix system does today, but it’s not how many Unixes started: those systems started with a kernel that didn’t support preemption nor multiprocessing; then they added support for user-space multiprocessing; and then they added kernel preemption. The latter is the hardest step of all and explains the <a href=\"https://en.wikipedia.org/wiki/FreeBSD_version_history#FreeBSD_5\">FreeBSD 5.0</a> saga fiasco. So it is interesting to see that NT started with the right foundations from its inception.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you are enjoying this article, please subscribe to Blog System/5! Your recurrent interest is what makes this publication work.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Objects</h1><p>NT is an object-oriented kernel. You might think that Unix is too: after all, processes are defined by a struct and file system implementations deal with vnodes (“virtual nodes”, not to be confused with inodes which are a file system-specific implementation detail). But that’s not quite the same as what NT does: NT forces all of these different objects to have a common representation in the system.</p><p>You can rightfully be skeptical about this because… how can you offer a meaningful abstraction over such disparate things as processes and file handles? You can’t, really, but NT forced all of these to inherit from a common object type and, surprisingly, this results in some nice properties:</p><ul><li><p><strong>Centralized access control:</strong> Objects are exclusively created by the <em>object manager</em>, which means there is a single place in the code to enforce policy. This is powerful because the semantics for, say, permission checks, can be defined in just one location and applied uniformly throughout the system. NetBSD concluded this was a good idea too, but it wasn’t until 2001 that it gained its <a href=\"https://man.netbsd.org/NetBSD-9.3/kauth.9\">Kernel Authorization (kauth)</a> framework.</p></li><li><p><strong>Common identity:</strong> Objects have identities and they are all represented in a single tree. This means that there is a unique namespace for all objects, no matter if we are talking about processes, file handles, or pipes. The objects in the tree are addressable via names (paths) and different portions of the tree can be owned by different subsystems. For example, a portion of the tree can represent a mounted file system, and thus traversing that subtree’s root node will cause the file system to resolve the remainder of the path. This is akin to the VFS layer of a Unix system, with the difference that the VFS is exclusively about file systems whereas the object tree is about <em>every single kernel object</em>. It’s true that Unix has attempted to shoehorn other types of non-file objects into the file system via <code>/proc/</code>, <code>/sys/</code>, and the like—but these feel like afterthoughts compared to what NT offers.</p></li><li><p><strong>Unified event handling:</strong> All object types have a <em>signaled</em> state, whose semantics are specific to each object type. For example, a process object enters the signaled state when the process exits, and a file handle object enters the signaled state when an I/O request completes. This makes it trivial to write event-driven code (ehem, async code) in userspace, as a single wait-style system call can await for a group of objects to change their state—no matter what type they are. Try to wait for I/O and process completion on a Unix system at once; it’s painful.</p></li></ul><p>Objects are an NT-specific construct though, and they don’t generalize well to all of the APIs that NT intended to support. An example of this is the POSIX subsystem: POSIX doesn’t have the same concept of objects as NT does, yet NT has to offer some sort of compatibility with POSIX applications. For this reason, while the POSIX subsystem allocates objects from the executive, this subsystem must keep its own bookkeeping to represent the corresponding POSIX entities and performs the logical translation between the two on the fly. The Win32 subsystem, on the other hand, just hands objects to clients without an intermediary.</p><h1>Processes</h1><p>Processes are a common entity in both NT and Unix but they aren’t quite the same. In Unix, processes are represented in a tree, which means that each process has a parent and a process can have zero or more children. In NT, however, there is no such relationship: processes can “inherit” resources from their creators—any type of object, basically—but they are standalone entities after they are created.</p><p>What wasn’t common back when NT was designed were threads: Mach was the first Unix-like kernel to integrate threads in 1985, which means that other Unixes adopted this concept later on and had to retrofit it into their existing designs. For example, Linux chose to represent threads as processes, each with its own PID, in its 2.0 release in June 1996; and NetBSD didn’t get threads, represented as separate entities from processes, until its 2.0 release in 2004. Contrary to Unix, NT chose to support threads from the very beginning, knowing that they were a necessity for high-performance computing on SMP machines.</p><p>NT doesn’t have signals in the traditional Unix sense. What it does have, however, are <em>alerts</em>, and these can be kernel mode and user mode. User mode alerts must be waited for as any other object and kernel mode alerts are invisible to processes. The POSIX subsystem uses kernel mode alerts to emulate signals. Note that signals have often been called a wart in Unix because of the way they interfere with process execution: handling signals correctly is a really difficult endeavor, so it sounds like NT’s alternative is more elegant.</p><p>An interesting recent development in NT-land has been the introduction of <a href=\"https://www.microsoft.com/en-us/research/project/drawbridge/\">picoprocesses</a>. Up until this feature was added, processes in NT were quite heavyweight: new processes would get a bunch of the NT runtime libraries mapped in their address space at startup time. In a picoprocess, the process has minimal ties to the Windows architecture, and this is used to implement Linux-compatible processes in WSL 1. In a way, picoprocesses are closer to Unix processes than native Windows processes, but they are not used for much anymore—even if they have only existed since August 2016—because of the move to WSL 2.</p><p>Lastly, as much as we like to bash Windows for security problems, NT started with an advanced security design for early Internet standards given that the system works, basically, as a capability-based system. The first user process that starts after logon gets an access token from the kernel representing the privileges of the user session, and the process and its subprocesses must supply this token to the kernel to assert their privileges. This is different from Unix where processes just have identifiers and the kernel needs to keep track of what each process can do in the process table.</p><h1>Compatibility</h1><p>As mentioned in the introduction, a major goal of NT was to be compatible with applications written for legacy Windows, DOS, OS/2 and POSIX. One reason for this was technical, as this forced the system to have an elegant design; the other reason was political, as NT was a joint development with IBM and NT <em>had</em> to support OS/2 applications even if, in the end, NT ended up <em>being</em> Windows.</p><p>This need for compatibility forced NT’s design to be significantly different than Unix’s. In Unix, user-space applications talk to the kernel directly via its system call interface, and this interface <em>is</em> the Unix interface. Oftentimes, <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">but not always</a>, the C library provides the glue to call the kernel and applications never issue system calls themselves—but that’s a minor detail.</p><p>Contrast this to NT where applications do <em>not</em> talk to the executive (the kernel) directly. Instead, each application talks to one specific protected <em>subsystem</em>, and these subsystems are the ones that implement the APIs of the various operating systems that NT wanted to be compatible with. These subsystems are implemented as user-space servers (they are not inside the NT “microkernel”). Support for Windows applications comes from the Win32 server, which is special because it’s the only one that’s directly visible by users: it controls console programs and DOS terminals, and it has certain privileges for performance reasons.</p><p>Compared to traditional Unix, NT’s design is very different because the BSDs and Linux have a monolithic kernel. These kernels expose a system call interface that userspace applications leverage to interact directly with the system. The BSDs, however, have offered support to run alternate <em>binaries</em> for a long time, all within the monolithic kernel: the way this works is by exposing different system call tables to userspace depending on the binary that’s being run, and then translating those “foreign” system calls to whatever the kernel understands. Linux has limited support for this as well via <em><a href=\"https://man7.org/linux/man-pages/man2/personality.2.html\">personalities</a></em>.</p><p>Even though the BSD approach is quite different from how NT handles supporting other systems, WSL 1 is extremely similar and is not a subsystem in the literal terms that subsystems were originally defined. In WSL 1, the NT kernel marks Linux processes as picoprocesses and, from there on, exposes a different system call interface to them. Within the NT kernel, those Linux-specific system calls are translated into NT operations and served within the same kernel—just like BSD’s Linux compatibility does. The only problem is that, NT not being Unix, its “emulation” of Linux is tricky and much slower than what BSD can offer. It’s a pity that <a href=\"https://jmmv.dev/2020/11/wsl-lost-potential.html\">WSL 2 lost the essence of this design</a> and went with a full-on VM design…</p><p>To finish this section, two more interesting details: a goal of NT’s design was to allow seamless I/O redirection between subsystems, all from a single shell; and subsystems are exposed to applications via <em>ports</em> which are, of course, NT objects and are similar to how Mach allows processes and servers to communicate.</p><h1>Virtual memory</h1><p>NT, just as Unix, relies on a Memory Management Unit (MMU) with pagination to offer protection across processes and to offer virtual memory. Paging in user-space processes is a common mechanism to give them a larger address space than the amount of physical memory on a machine. But one thing that put NT ahead of contemporary Unix systems is that the kernel itself can be paged out to disk too. Obviously not the whole kernel—if it all were pageable, you’d run into the situation where a resolving kernel page fault requires code from a file system driver that was paged out—but large portions of it are. This is not particularly interesting these days because kernels are small compared to the typical installed memory on a machine, but it certainly made a big difference in the past where every byte was precious.</p><p>Additionally, while we take the way virtual memory and paging works these days for granted, this was a big area of research back when NT was designed. Older Unix implementations had separate memory caches for the file system and virtual memory, and it wasn’t until 1987 that <a href=\"https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=a36b01c8fd5071f64b981dd3ffc66a6bce56736d\">SunOS implemented a unified virtual memory architecture</a> to reduce the overheads of this old design.</p><p>In contrast, NT started with a unified memory architecture from the beginning. You’d say that this was easy to do because they had the hindsight of the inefficiencies found in Unix and could see the solution that SunOS had implemented before the design of NT started. But regardless, this made NT “more advanced” that many alternate operating systems back then, and it has to be noted that other systems like NetBSD didn’t catch up until 2002 with the implementation of the <a href=\"https://www.usenix.org/legacy/publications/library/proceedings/usenix2000/freenix/full_papers/silvers/silvers.pdf\">Unified Buffer Cache (UBC)</a> in NetBSD 1.6.</p><p>An interesting difference between NT and Unix is how they manage and represent shared memory. In NT, shared memory sections are (surprise) objects and are thus subject to the exact same access validation checks as any other object. Furthermore, they are addressable in the same manner as any other object because they are part of the single object tree. Contrast this to Unix where this feature is bolted on: shared memory objects have a <a href=\"https://man7.org/linux/man-pages/man3/shm_open.3.html\">different namespace</a>, a different API to every other entity, and thus typical permissions don’t apply to them.</p><h1>I/O subsystem</h1><p>Early versions of Unix only supported one file system. For example, it wasn’t until 4.3BSD in 1990 that the BSDs gained the Virtual File System (VFS) abstraction to support more than just UFS. NT, on the other hand, started with a design that allowed multiple file systems.</p><p>In order to support multiple file systems, the kernel has to expose their namespaces in some way. Unix combines the file systems under a single file hierarchy via mount points: the VFS layer provides the mechanisms to identify which nodes correspond to the root of a file system and redirects requests to those file system drivers when traversing a path. NT has a similar design even if, from the standard user interface, file systems appear as disjoint drives: internally, the executive represents file systems as objects in the object tree, and each object is responsible for parsing the remainder of a path. Those file system objects are remapped as DOS drives so that userspace can access them. And, guess what? The DOS drives are also objects under a separate subtree that redirects I/O to the file systems they reference.</p><p>In file system terms, NT ended up shipping with NTFS. NTFS was a really advanced file system for its time even if we like to bash on it for its poor performance (a <a href=\"https://www.youtube.com/watch?v=qbKGw8MQ0i8\">misguided claim</a>). The I/O subsystem of NT, in combination with NTFS, brought 64-bit addressing, journaling, and even Unicode file names. Linux didn’t get 64-bit file support until the late 1990s and didn’t get journaling until ext3 launched in 2001. <a href=\"https://www.usenix.org/conference/1999-usenix-annual-technical-conference/soft-updates-technique-eliminating-most\">Soft updates</a>, an alternate fault tolerance mechanism, didn’t appear in FreeBSD until 1998. And Unix represents <a href=\"https://blogsystem5.substack.com/p/strings-encodings-nuls-and-bazel\">filenames as nul-terminated byte arrays</a>, not Unicode.</p><p>Other features that NT included at launch were disk stripping and mirroring—what we know today as RAID— and device hot plugging. These features were not a novelty given that SunOS did include RAID support since the early 1990s, but what’s interesting is that these were all accounted for as part of the original design.</p><p>At a higher level, <em>the</em> thing that makes the I/O subsystem of NT much more advanced than Unix’s is the fact that its interface is asynchronous in nature and has been like that since the very beginning. To put this in perspective, FreeBSD didn’t see support for <a href=\"https://man7.org/linux/man-pages/man7/aio.7.html\">aio(7)</a> until FreeBSD 3.0 in 1998, and Linux didn’t see this either until Linux 2.5 in 2002. And even if support for asynchronous I/O has existed in Unix systems for more than 20 years now, it’s still not widespread: few people know of these APIs, the vast majority of applications don’t use them, and their performance is poor. Linux’s <a href=\"https://en.wikipedia.org/wiki/Io_uring\">io_uring</a> is a relatively recent addition that improves asynchronous I/O, but it has been a significant source of security vulnerabilities and is not in widespread use.</p><h1>Networking</h1><p>The Internet is everywhere today, but when NT was designed, that was not the case. Looking back at the Microsoft ecosystem, DOS 3.1 (1987) included the foundations for file sharing in the FAT file system, yet the “OS” itself did not provide any networking features: a separate product called Microsoft Networks (MS-NET) did. Windows 3.0 (1990) included support for NetBIOS, which allowed primitive printer and file sharing on local networks, but support for TCP/IP was nowhere to be seen.</p><p>In contrast, Unix <em>was</em> the Internet: all foundational Internet protocols were written for and with it. During the design of NT, it was therefore critical to account for good network support, and indeed NT did launch with networking features. As a result, NT did support both Internet protocols and the traditional LAN protocols used in pre-existing Microsoft environments, which put it ahead of Unix in corporate environments.</p><p>An an example, take NT’s network domains. In Unix, network administrators typically synchronized user accounts across machines by hand; they’d maybe use the X.500 directory protocol (1988) and Kerberos (1980s) for user authentication, which systems like SunOS implemented, but these technologies weren’t particularly simple. Instead, NT offered <em>domains</em> from the get go, which integrated directory and authentication features, and it seems to me that these “won the day” in corporate networks because they were much easier to set up and were built into the system.</p><p>The goal of synchronized user accounts is to share resources across machines, primarily files, and when doing so, the way to represent permissions matters. For the longest time, Unix only offered the simplistic read/write/execute permission sets for each file. NT, on the other hand, came with advanced ACLs from the get go—something that’s still a sore spot on Unix. Even though Linux and the BSDs now have ACLs too, their interfaces are inconsistent across systems and they feel like an alien add-on to the design of the system. On NT, ACLs work at the object level, which means they apply consistently throughout all kernel features.</p><p>And speaking of sharing files, we must talk about networked file systems. In Unix, the de facto file system was NFS, whereas on NT it was SMB. SMB was inherited from MS-NET and LAN Manager and is implemented in the kernel via a component called the <em>redirector</em>. In essence, the redirector is “just” one more file system, like NFS is on Unix, that traps file operations and sends them over the network, which brings us to comparing RPC systems.</p><p>Even though protobuf and gRPC may seem like novel ideas due to their widespread use, they are based on old ideas. On Unix, we had Sun RPC from the early 1980s, primarily to support NFS. Similarly, NT shipped with built-in RPC support via its own DSL—known as MIDL to specify interface definitions and to generate code for remote procedures—and its own facility to implement RPC clients and servers.</p><p>Moving down the stack, Unix systems have never been big on supporting arbitrary drivers: remember that Unix systems were typically coupled to specific machines and vendors. NT, on the other hand, intended to be an OS for “any” machine and was sold by a software company, so supporting drivers written by others was critical. As a result, NT came with the Network Driver Interface Specification (NDIS), an abstraction to support network card drivers with ease. To this day, manufacturer-supplied drivers are just not a thing on Linux, which leads to interesting contraptions like the <a href=\"https://ndiswrapper.sourceforge.net/wiki/index.php/Main_Page\">ndiswrapper</a>, a very popular shim in the early 2000s to be able to reuse Windows drivers for WiFi cards on Linux.</p><p>Finally, another difference between NT and Unix lies in their implementation of named pipes. Named pipes are a local construct in Unix: they offer a mechanism for two processes on the same machine to talk to each other with a persistent file name on disk. NT has this same functionality, but its named pipes can operate over the network. By placing a named pipe on a shared file system, two applications on different computers can communicate with each other without having to worry about the networking details.</p><h1>User-space</h1><p>We are getting close to the end, I promise. There are just a few user-space topics to briefly touch on:</p><ul><li><p><strong>Configuration:</strong> NT centralized system and application configuration under a database known as the <em>registry</em>, freeing itself from the old <code>CONFIG.SYS</code>, <code>AUTOEXEC.BAT</code> and the myriad INI files that legacy Windows used. This made some people very angry, but in the end, a unified configuration interface is beneficial to everyone: applications are easier to write because there is a single foundation to support, and users have an easier time tuning their system because there is just one place to look at.</p><p>Unix, on the other hand, is still plagued by dozens of DSLs and inconsistent file locations. Each program that supports a configuration file has its own made-up syntax, and knowing which locations the program reads is difficult and not always well-documented. The Linux ecosystem has pushed for a more NT-like approach via XDG and dconf (previously GConf) but… it’s an uphill battle: while desktop components use these technologies exclusively, the foundational components of the system may never adopt them, leaving an inconsistent mess behind.</p></li><li><p><strong>Internationalization:</strong> Microsoft, being the large company that was already shipping Windows 3.x across the world, understood that localization was important and made NT support such feature from the very beginning. Contrast this to Unix where UTF support didn’t start to show up until the late 1990s, and supporting different languages came via the optional <code>gettext</code> add-on.</p></li><li><p><strong>The C language:</strong> One thing Unix systems like FreeBSD and NetBSD have fantasized about for a while is coming up with their own dialect of C to <a href=\"https://cs.rochester.edu/u/jzhou41/papers/freebsd_checkedc.pdf\">implement the kernel in a safer manner</a>. This has never gone anywhere except, maybe, for Linux relying on GCC-only extensions. Microsoft, on the other hand, had the privilege of owning a C compiler, so they did do this with NT, which is written in Microsoft C. As an example, NT relies on Structured Exception Handling (SEH), a feature that adds try/except clauses to handle software and hardware exceptions. I wouldn’t say this is a big plus, but it’s indeed a difference.</p></li></ul><h1>Conclusion</h1><p>NT was groundbreaking technology when it launched. As I presented above, many of the features we take for granted today in systems design were present in NT since its inception, whereas almost all other Unix systems had to gain those features slowly over time. As a result, such features don’t always integrate seamlessly with Unix philosophies.</p><p>Today, however, it’s not clear to me that NT is truly “more advanced” than, say, Linux or FreeBSD. It is true that NT had more solid design principles at the onset and more features that its contemporary operating systems, but nowadays… the differences are blurry. Yes, NT is advanced, but not significantly more so than modern Unixes.</p><p>What I find disappointing is that, even though NT has all these solid design principles in place… bloat in the UI doesn’t let the design shine through. The sluggishness of the OS even on super-powerful machines is <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">painful to witness</a> and might even lead to the demise of this OS.</p><p>I’ll leave you with the books used to write this article in case you want to go through my learning journey. I had to skip over tons of interesting details, as you can imagine, so these are worth a read:</p><ul><li><p><a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT, 1st edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-4-4-Operating-System/dp/0201549794?crid=289Z6M1NYSR8L&dib=eyJ2IjoiMSJ9.4h3ssrq_vTu9MaMquFvEbw.YxrfgRofVfFKstV74Q_LR-XOseMUlCrcvkehHW6y5Yc&dib_tag=se&keywords=design+and+implementation+of+4.4bsd&qid=1725808321&sprefix=design+and+implementation+of+4.4bsd%2Caps%2C158&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=a0d6cc7fb69bc72b4649609390255bff&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the BSD 4.4 operating system</a>.</p></li></ul><p>And if you want to <em>continue</em> my journey and truly dive deep into how each piece of <em>modern</em> NT and Unix works, the newer editions are a must read:</p><ul><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 1, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-2-7th/dp/0135462401?pd_rd_w=nmV0o&content-id=amzn1.sym.3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_p=3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_r=FHEDS8GZCH0T6TA52GQD&pd_rd_wg=VUb9D&pd_rd_r=9f324aa8-7d91-4b6f-8c48-a8f09f1e8717&pd_rd_i=0135462401&psc=1&linkCode=ll1&tag=blogsystem5-20&linkId=a174f72e73013533f3ee8ca3f2cedd1c&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 2, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-FreeBSD-Operating-System/dp/0321968972?crid=23A95KGH3XOCE&dib=eyJ2IjoiMSJ9.WhRSQ2C6OFnyaT9IERCxYyLspyOoCkFSreJbs2Nia7zcYcNs68qdHuNBiIvERx987eDwl_H7YrMkTIj1575PGQ.orMCRh-1sVoQgFKgV2RtSiAxU3OA5fYRt6oAI3SV-p0&dib_tag=se&keywords=the+design+and+implementation+of+freebsd&qid=1725850081&s=books&sprefix=the+design+and+implementation+of+freebsd%2Cstripbooks%2C136&sr=1-1&linkCode=ll1&tag=blogsystem5-20&linkId=ac0d39d3f598c50cd1d9dc650d2b4dd7&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the FreeBSD operating system, 2nd edition</a>.</p></li></ul><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for making it this far. Don’t forget to subscribe to Blog System/5 to receive new posts and support my work!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "0.0" "image/jpeg") nil "7ba43c8034e75ed13fe4814be46b3c6a") (44 (26627 17952 629742 317000) "https://blogsystem5.substack.com/p/ioctls-rust" "ioctls from Rust" "Julio Merino" "Thu, 13 Feb 2025 17:01:31 +0000" "<p>In Unix-like systems, “everything is a file and a file is defined as a byte stream you can <code>open</code>, <code>read</code> from, <code>write</code> to, and ultimately <code>close</code>”… right? <em>Right?</em> Well, not quite. It’s better to say <em>file descriptors</em> provide access to almost every system that the kernel provides, but not that they can all be manipulated with the same quartet of system calls, nor that they all behave as byte streams.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":440615,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>Because you see: network connections are manipulated via file descriptors indeed, but you don’t <code>open</code> them: you <code>bind</code>, <code>listen</code>/<code>accept</code> and/or <code>connect</code> to them. And then you don’t <code>read</code> from and <code>write</code> to network connections: you somehow <code>send</code> to and <code>recv</code> from them. Device drivers are similar: yes, hardware devices are represented as “virtual files” in the <code>/dev</code> hierarchy and many support <code>read</code> and <code>write</code>… but these two system calls are not sufficient to access the breath of functionality that the hardware drivers provide. No, you need <code>ioctl</code>.</p><p><code>ioctl</code> is the poster child of the system call that breaks Unix’s “everything is a file” paradigm. <code>ioctl</code> is the API that allows out-of-band communication with the kernel side of an open file descriptor. To see cool examples, <a href=\"https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11\">refer back to my previous article</a> where I demonstrated how to drive graphics from the console without X11: in that post, we had to <code>open</code> the console device, but then we had to use <code>ioctl</code> to obtain the properties of the framebuffer, and then we had to <code>mmap</code> the device’s content for direct access: no <code>read</code>s nor <code>write</code>s involved.</p><p>All the code I showed you in that earlier post was written in C to keep the graphics article to-the-point, but the code I’m really working on is part of EndBASIC, and thus it is all Rust. And the thing is, <code>ioctl</code>s are not easy to issue from Rust. In fact, after 7 years of Rust-ing, it’s the first time I’ve had to reach for <code>unsafe</code> code blocks, and there was no good documentation on how to deal with <code>ioctl</code>. So this posts aims to fix that by presenting what ways there are to call <code>ioctl</code>s from Rust… and, of course, diving a bit deeper into what <code>ioctl</code>s actually <em>are</em>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Our target</strong></h1><p>For all examples below, I’ll be using a relatively simple <code>ioctl</code> from NetBSD’s <a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> driver. This API is available via the console device file, typically <code>/dev/ttyE0</code>, and is named <code>WSDISPLAYIO_GINFO</code>. Here is what the manual page has to say:</p><pre><code><code>The following ioctl(2) calls are provided by the wsdisplay driver or by
devices which use it.  Their definitions are found in
<dev/wscons/wsconsio.h>.
...
WSDISPLAYIO_GINFO (struct wsdisplay_fbinfo)
Retrieve basic information about a framebuffer display.
The returned structure is as follows:

struct wsdisplay_fbinfo {
u_int   height;
u_int   width;
u_int   depth;
u_int   cmsize;
};

The height and width members are counted in pixels.  The
depth member indicates the number of bits per pixel, and
cmsize indicates the number of color map entries accessible
through WSDISPLAYIO_GETCMAP and WSDISPLAYIO_PUTCMAP.  This
call is likely to be unavailable on text-only displays.</code></code></pre><p>Calling this API from a C program would be trivial and look like this:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <ioctl.h>
// ... open `/dev/ttyE0` as fd ...
struct wsdisplay_fbinfo fbi;
if (ioctl(fd, WSDISPLAYIO_GINFO, &fbi) == -1) {
// Handle error.
}
// fbi now contains the data returned by the kernel.</code></code></pre><p>The reason I’m picking <code>WSDISPLAYIO_GINFO</code> specifically to talk about <code>ioctl</code>s in this article is three-fold:</p><ul><li><p>it returns a small structure with <a href=\"https://blogsystem5.substack.com/p/x86-64-programming-models\">platform-dependent integers</a>, so the sample code in the article will be relatively short;</p></li><li><p>it relies on platform-specific integer types, so we’ll have to account for that in Rust; and</p></li><li><p>it is “rare enough” (we are talking about NetBSD after all) that it is not going to be supported by any of the common Rust crates like libc or nix, so we’ll have to do extra work to call it.</p></li></ul><h1><strong>What is an ioctl anyway?</strong></h1><p>The manual page helpfully provides us a copy of the data structure returned by the <code>ioctl</code>, and the BSD manual pages are typically <em>awesome</em>, but it’s worth double-checking that the code snippet actually matches the code it documents. Peeking into <code>/usr/include/dev/wscons/wsconsio.h</code> as the manual page directs us, we find:</p><pre><code><code>/* Basic display information.  Not applicable to all display types. */
struct wsdisplay_fbinfo {
u_int   height;             /* height in pixels */
u_int   width;              /* width in pixels */
u_int   depth;              /* bits per pixel */
u_int   cmsize;             /* color map size (entries) */
};
#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>OK, great, the <code>wsdisplay_fbinfo</code> structure perfectly aligns with the manual page contents. But what’s more interesting is the <code>#define</code>, which says that <code>WSDISPLAYIO_GINFO</code> is:</p><ul><li><p>an ioctl that <em>reads</em> from the kernel (<code>_IOR</code>),</p></li><li><p>that invokes function number 65 from the <code>W</code> class (which probably stands for “the <em>W</em>scons device driver”), and</p></li><li><p>that places the returned data into a structure of type <code>wsdisplay_fbinfo</code> (not to be confused with <code>wsdisplayio_fbinfo</code>).</p></li></ul><p>In a way, this is just like any other function or system call, except that it’s not defined as such and is instead funneled through a single API. <code>ioctl</code> is, therefore, “just” a grab bag of arbitrary functionality, and what can be invoked on a given file descriptor depends on what the file descriptor represents.</p><p>The reasons for this design are historical and, of course, there could have been other options.</p><p>For example: you know how regular files have an internal structure, right? The vast majority of file formats out there contain a header, which then specifies various sections within the file, which then contain data. The same could have been done with device drivers: their virtual files could have predefined some internal format such that, e.g. the <code>wsdisplay_fbinfo</code> structure always appeared at offset 0x1000 of the virtual file. <code>read</code> and <code>write</code> would have been sufficient for this design, albeit you’d almost-certainly wanted to combine it with <code>mmap</code> for more efficient access.</p><p>Or another example: device drivers could have used an RPC-like mechanism where each write to the file descriptor is a “message” that requests a specific function, and that the kernel responds to with an answer. <code>read</code> and <code>write</code> would have been sufficient for this design.</p><p>Or yet another example: the requests to the device driver could have been intermixed with the data, such that if the data contained a specific sequence, the kernel would invoke a function instead of processing data. Sounds crazy, right? But that’s what pseudo-terminals do: all those <a href=\"https://en.wikipedia.org/wiki/ANSI_escape_code\">control sequences</a> to change colors and the like are telling the terminal driver to do something special.</p><p>In any case, these are all alternate designs and… I’m sure they all live in some form or another in current systems. There is no consistency in how <code>/dev</code> pseudo-files expose their behavior, and <code>ioctl</code>s are just one of the options we have to deal with. So without further ado, let’s look at three different ways of calling these services from Rust.</p><h1><strong>Option 1: nix</strong></h1><p>The first option to call an <code>ioctl</code> from Rust is to leverage the neat <a href=\"https://docs.rs/nix/\">nix crate</a>, which provides idiomatic access to Unix primitives. This crate is not to be confused with NixOS, with which it has no relation.</p><p>To use nix to invoke <code>ioctl</code>s, we need to do two things.</p><p>First, we need to define the data structure used by the <code>ioctl</code>. In C, we would just <code>#include <dev/wscons/wsconsio.h></code>, but in Rust we don’t have access to the C-style headers. Instead, we have to do extra work to define the same memory layout of the C <code>wsdisplay_fbinfo</code> structure, but in Rust:</p><pre><code><code>use std::ffi::c_uint;
#[repr(C)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}</code></code></pre><p>It is <em>very important</em> to declare the structure as having a C representation so that its memory layout matches what the C compiler produces for the same structure. The kernel expects C semantics in its system call boundary, and we must adhere to that. Additionally, we must ensure that the types of each field match the C definitions. Rust only has fixed-size integer types like <code>i16</code> and <code>u32</code>, but C provides platform-dependent integer types like <code>int</code> or <code>unsigned long</code> and these are sometimes used in public kernel interfaces (a mistake, if you ask me). Fear not, though: the <code>std::ffi</code> module provides aliases for those C types.</p><p>And second, we have to do something unique to the nix crate: we have to define a wrapper function for the <code>ioctl</code> so that we can invoke the <code>ioctl</code> as if it were any other function. nix makes this very easy by providing macros that mimic the syntax of the C <code>#define</code> we saw earlier on:</p><pre><code><code>use nix::ioctl_read;
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);</code></code></pre><p>And with that, we are ready to put everything together in a fully-fledged program:</p><pre><code><code>use std::ffi::c_uint;
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
use nix::fcntl;
use nix::ioctl_read;
use nix::sys::stat;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);
fn main() -> io::Result<()> {
let mut oflag = fcntl::OFlag::empty();
oflag.insert(fcntl::OFlag::O_RDWR);
oflag.insert(fcntl::OFlag::O_NONBLOCK);
oflag.insert(fcntl::OFlag::O_EXCL);
let fd = {
let raw =
fcntl::open(\"/dev/ttyE0\", oflag, stat::Mode::empty())?;
unsafe { OwnedFd::from_raw_fd(raw) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
wsdisplayio_ginfo(fd.as_raw_fd(), &mut fbi).unwrap();
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>There is one surprising detail in this code though: if we went through the hassle of defining a wrapper function for <code>WSDISPLAYIO_GINFO</code> via the idiomatic nix crate, and idiomatic nix usage doesn’t require <code>unsafe</code> blocks… why did we have to wrap the call to <code>wsdisplayio_ginfo</code> in an <code>unsafe</code> block? The reason may be that <code>ioctl</code> can do <em>whatever</em> to the running process and Rust needs to be over-conservative.</p><p>In any case, the above is clean and it works. But… using nix comes with a cost:</p><pre><code><code>$ cargo build
Compiling libc v0.2.169
Compiling cfg_aliases v0.2.1
Compiling bitflags v2.8.0
Compiling cfg-if v1.0.0
Compiling nix v0.29.0
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/os/homepage/static/src/ioctls-rust/nix)
Finished `dev` profile [unoptimized + debuginfo] target(s) in 1.71s
$ █</code></code></pre><p>We have pulled 5 crates into the project just to open a file and invoke an <code>ioctl</code>. Not a huge deal in this day and age but… this contributes to the perception that the Rust ecosystem is a mess of bloated dependencies. Can we do differently?</p><h1><strong>Option 2: libc</strong></h1><p>What if we bypassed nix altogether and invoked libc directly? After all, we can see that nix <em>depends on</em> libc anyway, so we might as well use it at the expense of losing nix’s idiomatic representation of Unix’s interfaces.</p><p>Sure, we can do that: we can invoke the <code>libc::ioctl</code> function directly, which has this prototype:</p><pre><code><code>pub fn ioctl(fd: c_int, request: Ioctl, ...) -> c_int;</code></code></pre><p>Alright then: we need a file descriptor as the first argument, which we have. And then we need an <code>Ioctl</code> as the second argument, which we… wait, what is this <code>Ioctl</code> type? If we look for its definition in the libc source code, we find that <code>Ioctl</code> is an alias for an integer type (<code>unsigned long</code> or <code>int</code> depending on the platform), and this matches the C definition of <code>ioctl</code>. OK, nothing special.</p><p>But then… what do we pass in this second argument? If we were writing C, we would use the <code>WSDISPLAY_GINFO</code> constant, but we don’t have that in Rust because we don’t get access to the C header files. So what <em>is</em> <code>WSDISPLAY_GINFO</code>? Remember that we previously saw that it is defined as such:</p><pre><code><code>#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>… which doesn’t help us much at this point. But we can chase the definition of <code>_IOR</code>, end up in <code>/usr/include/sys/ioccom.h</code>, and see:</p><pre><code><code>#define _IOC(inout, group, num, len) \\
((inout) | (((len) & IOCPARM_MASK) << IOCPARM_SHIFT) | \\
((group) << IOCGROUP_SHIFT) | (num))
#define _IOR(g,n,t)     _IOC(IOC_OUT,   (g), (n), sizeof(t))</code></code></pre><p>Ugh. We are combining the various arguments to <code>_IOR</code> into a number. This is hard to decipher by just reading the code, so we can ask the compiler to tell us the actual value of the constant instead:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <stdio.h>
int main(void) {
printf(\"%x\\n\", WSDISPLAYIO_GINFO);
}</code></code></pre><p>And if we run the program, we get that <code>WSDISPLAYIO_GINFO</code> is <code>0x40105741</code>. Knowing that, it’s <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">an SMOP</a> to call the <code>ioctl</code> using the <a href=\"https://docs.rs/libc/\">libc crate</a> alone:</p><pre><code><code>use std::ffi::{c_char, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
const WSDISPLAYIO_GINFO: u64 = 0x40105741;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
let result = libc::ioctl(
fd.as_raw_fd(),
WSDISPLAYIO_GINFO,
&mut fbi as *mut WsDisplayFbInfo,
);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>As you can see from this code snippet, we <em>also</em> have to define the <code>WsdisplayFbInfo</code> structure to match the kernel’s, so avoiding nix didn’t really make things simpler for us—and in fact, it made them uglier because now we have to deal with libc’s oddities like raw C strings, global <code>errno</code> values, and an opaque constant for the <code>ioctl</code> number. Not great.</p><h1><strong>Option 3: FFI</strong></h1><p>Which makes one wonder… can we avoid replicating the C interfaces in Rust and instead leverage the system-provided header files? Yes we can. Instead of trying to invoke the <code>ioctl</code>s from Rust, we can invoke them via some custom C glue code. Rust is going to call into the system-provided libc <em>anyway</em> when we invoke a system call, so we might as well switch to C a bit “earlier”.</p><p>The idea in this case, as in any other computing problem, is to add a layer of abstraction: instead of dealing with the kernel-defined data structures from Rust, we define <em>our own</em> structures and APIs to detach the Rust world from the C world. Here, look:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <sys/ioctl.h>
struct my_ginfo {
unsigned int height;
unsigned int width;
unsigned int depth;
};
int get_ginfo(int fd, struct my_ginfo* gi) {
struct wsdisplay_fbinfo fbi;
int result = ioctl(fd, WSDISPLAYIO_GINFO, &fbi);
if (result == -1) {
return result;
}
gi->height = fbi.height;
gi->width = fbi.width;
gi->depth = fbi.depth;
return 0;
}</code></code></pre><p>We start by declaring our own version of <code>wsdisplay_ginfo</code>, which I’ve called <code>my_ginfo</code>, that only includes the few fields we want to propagate to Rust. Yes, in this example the indirection is utterly pointless because we go from 4 to 3 fields so we haven’t made our lives easier, but there are <code>ioctl</code>s that return larger structures from which we might only need a few values. Then we define a trivial function to wrap the <code>ioctl</code> and transform its return value into our own structure.</p><p>Then, we go to Rust, re-define our <code>my_ginfo</code> structure as <code>MyGinfo</code> (both of which we fully control so we can easily verify that they match) and we call the wrapping function:</p><pre><code><code>use std::ffi::{c_char, c_int, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct MyGInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
}
extern \"C\" {
fn get_ginfo(fd: c_int, gi: *mut MyGInfo) -> c_int;
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut gi: MyGInfo;
unsafe {
gi = mem::zeroed();
let result = get_ginfo(fd.as_raw_fd(), &mut gi as *mut MyGInfo);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"my_ginfo: {:?}\", gi);
Ok(())
}</code></code></pre><p>The trick now is to link the C code with the Rust code together, and for that, we create a <code>build.rs</code> script. In here, we leverage the <a href=\"https://docs.rs/cc/\">cc crate</a> to put things together, which is an extra dependency that is only used at build time:</p><pre><code><code>fn main() {
println!(\"cargo::rerun-if-changed=src/ffi.c\");
cc::Build::new().file(\"src/ffi.c\").compile(\"ffi\");
}</code></code></pre><p>And with that, we are done.</p><h1><strong>Which option wins?</strong></h1><p>Well, let’s see:</p><pre><code><code>$ cargo build --release
...
Compiling ioctls-rust-ffi v0.1.0 (/home/jmmv/ioctls-rust/ffi)
Compiling ioctls-rust-libc v0.1.0 (/home/jmmv/ioctls-rust/libc)
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/ioctls-rust/nix)
Finished `release` profile [optimized] target(s) in 1.89s
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 464K Feb 12 08:04 target/release/ioctls-rust-nix
$ strip -s target/release/ioctls-rust-*
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 358K Feb 12 08:05 target/release/ioctls-rust-nix
$ █</code></code></pre><p>From a binary size perspective, there are no meaningful differences. As expected, the usage of the nix crate results in slightly more code than the other alternatives because nix has to do extra work to translate global <code>errno</code> values into Rust <code>Result</code> types and the like. But the libc and FFI alternatives seem identical.</p><p>At runtime, however, we should expect the FFI option to perform a teeny tiny bit worse (though good luck measuring that) than the libc option because we have to convert between the kernel structure and our own structure in the happy path… all for dubious benefit.</p><p>All in all, I’ll take option 1. I do not like the fact of having to manually replicate the kernel structures in my own code so, if I had the time, I’d try to upstream the definitions to the well-tested libc crate or write another reusable crate with just those. But, barring that, the idiomatic nix interfaces make calling Unix primitives a breeze.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "0.0" "image/jpeg") nil "3786c9267f29d90e75ac41135db791cd") (43 (26627 17952 607451 81000) "https://blogsystem5.substack.com/p/endbasic-0-11" "EndBASIC 0.11 is here" "Julio Merino" "Sat, 20 Jul 2024 14:01:40 +0000" "<p>Dear readers,</p><p>I hope you don’t mind me reposting an exciting EndBASIC release announcement here. There are at least two good reasons for me to do this, but before covering those, look at this glorious welcome window:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" width=\"880\" height=\"660\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":660,\"width\":880,\"resizeWidth\":null,\"bytes\":94233,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The EndBASIC online interpreter loading a trivial program to welcome you all.</figcaption></figure></div><p>So what are those two reasons you ask? Well…</p><p>The first is that EndBASIC is very much in context for the topic of this blog (right?) and my work on it is a source of ideas for future articles. The backlog has grown quite long so… stay tuned.</p><p>The second is that my free time is really limited and I tend to hyperfocus on individual topics for months in a row. Sometimes I’m in “blog-only mode” like at the beginning of this year when Blog System/5 received lots of attention. Other times I’m in “code-only mode” like during the past five months where I devoted all my time to EndBASIC. And as a consequence, this publication suffered. But I’m still here, and with this release out of the way, this blog should receive more attention throughout the rest of the sumer.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Did you know that subscribing to Blog System/5 is completely free? There are paid options as well though, and any donations go towards supporting my writing <em>and</em> these open source projects.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Without further ado, let’s get into the content of the announcement. You can find the <a href=\"https://www.endbasic.dev/2024/07/endbasic-0.11.html\">original copy in the EndBASIC blog</a>.</p><div><hr></div><p>After a year-and-a-half long hiatus, I am pleased to announce that EndBASIC 0.11.0 is now available! 🥳</p><p>This release marks a significant milestone because it addresses <em><strong>the</strong></em> top feature request from you all, namely the ability to define custom functions and subroutines. But it also includes other goodies such as support for an LCD console, a shiny new disassembler, and a faster execution engine.</p><p>There is a lot to talk about, but before we get to that, here are the must-visit links:</p><ul><li><p><strong><a href=\"https://repl.endbasic.dev/\">Launch the online interpreter</a></strong></p></li><li><p><strong><a href=\"https://github.com/endbasic/endbasic/releases/tag/endbasic-0.11.0\">Read the release notes</a></strong></p></li><li><p><strong><a href=\"https://repl.endbasic.dev/?run=jmmv/life.bas\">Launch a Conway’s Game of Life demo</a></strong></p></li></ul><p>Without further ado, let’s take a peek into the major changes.</p><h1>User-defined functions and subroutines</h1><p>As I mentioned earlier, EndBASIC 0.11 addresses the top feature request of all times: support for user-defined functions and subroutines. <a href=\"https://www.endbasic.dev/2022/12/endbasic-0.10.html\">EndBASIC 0.10</a> addressed some of the pain by adding <code>GOTO</code> and <code>GOSUB</code> but there was still a need for structured callables with parameter passing and local variables.</p><p>Something like the following is finally possible:</p><pre><code><code>DIM SHARED sum_calls AS INTEGER
FUNCTION sum(a, b)
sum = a + b
sum_calls = sum_calls + 1
END FUNCTION
SUB print_sum(prefix AS STRING, a, b)
PRINT prefix; sum(a, b)
END SUB
print_sum \"The sum of 5+7 is:\", 5, 7
print_sum \"The sum of 1+2 is:\", 1, 2
PRINT \"sum has been called\"; sum_calls; \"times\"</code></code></pre><p>Easy peasy, right? Indeed it is! But getting here required redoing a <em>huge</em> portion of the compiler and VM internals.</p><p>One major piece to resolve this puzzle was to implement a declarative arguments parser for the callables. Up until now, every builtin command and function carried hand-crafted code to parse its arguments. This was not a great design choice due to large amounts of code duplication and the risk of inconsistencies between commands and documentation, but it was the simplest way to get something off the ground a few years back.</p><p>I had been meaning to resolve this long-standing “to-do” but, the thing is, <a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">BASIC makes it </a><em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">really</a></em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\"> difficult</a> to come up with a generic arguments parser: every command has its own ad-hoc syntax. I needed a solution though, and after having implemented many commands in the previous 10 releases of EndBASIC, I landed on a handful of generic-enough constructs to serve my purposes… for now.</p><p>With this new release, every command and function specifies the structure of its arguments in a declarative fashion. The compiler then uses the generic parser to translate the arguments into call stack values based on what each callable defines. Then, at runtime, every callable just pops typed values off the call stack assuming that they are correctly parsed. Runtime execution of callables is now more efficient than before.</p><p>But there was another obstacle to resolve to support user-defined functions, and this was converting the expression evaluator to bytecode.</p><h1>Bytecode-based expression evaluation</h1><p>EndBASIC 0.10 shifted the virtual machine from an AST processor to a bytecode evaluator in order to support <code>GOTO</code> and <code>GOSUB</code>. However, the bytecode was really just a trivial lowering of the AST: expressions remained as AST nodes in the bytecode. This was fine for that release, but in order to support calling user-defined functions from within expressions, the expression evaluator needed a way to shift execution from builtin code to interpreted code and viceversa. As other languages call it, addressing “<a href=\"https://blog.bazel.build/2017/03/07/java-sandwich.html\">the sandwich problem</a>”.</p><p>The way to resolve this was to modify the compiler to emit bytecode for expression evaluation as well, thus turning the bytecode into “real bytecode” not polluted by AST elements. This was easy enough to prototype, but performance obviously suffered: what was previously handled in native code now required executing tens of bytecode instructions.</p><p>I had to do significant follow-up work to shift most of the type-checking that happened at runtime to the compiler, thus freeing the VM from complex conditional logic during execution. And the efforts paid off. As a benchmark, I stripped down the Game of Life demo of its UI and made it run 500 iterations on a 200x200 board. EndBASIC 0.10 needs 25 seconds to process this while 0.11 only needs 15 seconds. That’s a 40% improvement, and the optimization work is far from done.</p><p>And after doing all of this, I could not resist adding a disassembler. This is just a gimmick right now because the only thing you can do with the disassembled code is peek into the inner workings of the VM, but hey, that’s didactic on its own so it tracks well with the vision for EndBASIC.</p><p>Here, witness:</p><pre><code><code>Ready
LIST
a = 3
PRINT 5.2 + a
Ready
DISASM
0000    PUSH%       3                           # 1:5
0001    SETV        A
0002    PUSH#       5.2                         # 2:7
0003    LOAD%       A                           # 2:13
0004    %TO#
0005    ADD#                                    # 2:11
0006    PUSH%       2                           # 2:7
0007    CALLB       PRINT, 2                    # 2:1
Ready
█</code></code></pre><h1>LCD console</h1><p>The other big change in EndBASIC has to do with a new backend for its console.</p><p>Two years ago, when I was <a href=\"https://www.endbasic.dev/2021/02/endbasic-0.6.html\">adding GPIO support to EndBASIC</a>, I bought a little LCD for my Raspberry Pi and I envisioned using it to display the EndBASIC console. I did not get to it at the time but, this year, having spent too much time exclusively on Blog System/5, I needed to get back to coding. Working on a driver for the LCD is what sparked my interest to hack EndBASIC again and is what ended up triggering the chain of events that brought you 0.11 today.</p><p>I won’t bore you too much with the details about this because I already published a <a href=\"https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an\">separate blog post</a> that goes into the full story. To recap, let me just show you how this looks like in action:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"ed030d16-5773-4427-ba0e-fc628a219262\",\"duration\":null}\"></div><p><em>EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.</em></p><h1>Known issues</h1><p>There is one big issue that has come up last minute, and it is that the graphics console does <em>not</em> work on macOS anymore. My understanding is that my SDL driver violates fundamental assumptions of macOS (and possibly Windows as well) by driving the SDL interactions from a <em>secondary</em> thread. I suspect something has changed in macOS that makes this break. I’m not sure if my theory is true though, but even proving the theory is not trivial at all—so I have chosen to ship 0.11 “as is” even if this is broken because 0.10 and earlier are broken too. If you happen to use macOS, I’m sorry, you’ll have to fall back to the web interpreter.</p><p>Also, retrofitting bytecode execution into the AST-based evaluator has not been easy and, as a result, the code has accrued significant technical debt. Many things can still be simplified in the codebase and those would yield much faster runtime execution. But once again, I have had to draw a line and call the current implementation “good enough” in order to ship. Rewrites are never a good idea, but I’m at a point where a rewrite of the VM (<em>not</em> anything else!) from scratch would be beneficial.</p><p>And to be honest: I need a little break. I have spent all of my free time during the last 5 months on EndBASIC and I have neglected other things I want to do. In particular, Blog System/5 has suffered quite a bit and there are a bunch of topics I want to blog about. So I have had to force the 0.11 release in order to breathe for a little bit. But don’t worry: I’ll be back for more.</p><p>In any case, EndBASIC 0.11 should be the best EndBASIC to date. Go forth and play!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://repl.endbasic.dev/\",\"text\":\"Launch online interpreter\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://repl.endbasic.dev/\"><span>Launch online interpreter</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "0.0" "image/jpeg") nil "2982f2399a16f974eb052d9bf3f9e167") (42 (26625 60023 702819 862000) "https://blogsystem5.substack.com/p/kyua-graduates" "Kyua graduates" "Julio Merino" "Fri, 02 Aug 2024 15:45:08 +0000" "<p>After years of inactivity, the Kyua project has graduated as an open source citizen and has <a href=\"https://github.com/freebsd/kyua/\">a new home</a> under the FreeBSD umbrella!</p><p>But uh… wait, what is Kyua and why is this exciting? To resolve confusion and celebrate this milestone, I’d like to revisit what Kyua is, how it came to be, why I stopped working on it for a while, why that was a problem for FreeBSD—and, indirectly, NetBSD—and how Kyua being free software has helped keep it alive.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":367311,\"alt\":\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\",\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" title=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><h1>The birth of ATF</h1><p>Let’s begin by talking about Kyua’s predecessor: the Automated Testing Framework (ATF).</p><p>In 2005, I was <a href=\"https://jmmv.dev/2005/06/soc-accepted.html\">one of the lucky pioneers</a> of the Google Summer of Code (GSoC) program. During that summer, I wrote <a href=\"http://web.archive.org/web/20071214080206/http://netbsd-soc.sourceforge.net/projects/tmpfs/\">the tmpfs file system for NetBSD</a> and my development process went something like this on an iBook G3:</p><ol><li><p>Modify the kernel.</p></li><li><p>Build and install the updated kernel.</p></li><li><p>Reboot the laptop.</p></li><li><p><strong>Mount the file system.</strong></p></li><li><p><strong>Manually validate new functionality and bug fixes.</strong></p></li><li><p>Witness the machine crash.</p></li><li><p>Force-reboot.</p></li><li><p>Rinse and repeat.</p></li></ol><p>Needless to say, this was a painful process. Using kernel modules lowered the pain a tiny little when the changes I made didn’t crash but, in general, they <em>did</em> crash. Documentation was scarce and I didn’t know what I was doing!</p><p>In an attempt to make the validation step less painful and to ensure that each change I made was a “net positive” instead of regressing functionality, I got what-I-think-was my first real exposure to automated testing. I <em>had</em> to automate steps 4 and 5 in the flow above, and so I wrote ad-hoc scripts to do so.</p><p>My GSoC mentors, Luke Mewburn and Bill Studenmund, pointed me at the <code>src/tests</code> directory of the NetBSD source tree which contained a bunch of tests for the system. Some of these were for user space tools and others exercised portions of the kernel. The existing machinery could probably be reused to automate my manual regression testing steps, so I had to try to integrate with it.</p><p><em>Machinery</em> is… a strong word given how rudimentary <code>src/tests</code> was. The main issue with this infrastructure was that the tests didn’t have a real runner: they were all small programs with unique command-line interfaces glued together by a collection of <code>Makefile</code>s. There was no guarantee that these tests built nor that running a <code>make test</code> would run them all because many tests were known to be broken. And what’s worse: some of the existing tests <em>crashed</em> the kernel due to known bugs.</p><p>I started envisioning the need for a principled test framework and wanted to create one, but I needed the time to do so and school didn’t give me much of that. So, in 2006, I applied once again to GSoC but, while I got in, I chose to take a detour and help write the beginnings of the Boost.Process library. The reason for this choice was primarily to learn Win32 internals but a good side-effect was that I got to experience a more advanced test framework.</p><p>And then, in 2007, I wanted to create this automation project as my bachelor’s degree graduation project… but I couldn’t find a professor that would back the idea. (A pity because I believe it would have been a great fit for the operating systems group.) So I did what I knew how to do: I applied and got into GSoC once again—this time <a href=\"http://web.archive.org/web/20071225031924/http://netbsd-soc.sourceforge.net/projects/atf/\">to develop a testing framework for NetBSD</a>.</p><p>The idea was to create libraries to write tests with a unified CLI interface in either C, C++, or shell, and then provide a unified runner that would execute these tests in an isolated manner <em>and</em> without access to the source tree. And thus the <em>Automated Testing Framework (ATF)</em> was born.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Being sponsored to work on open source projects by GSoC was truly inspiring. Those times are long gone, but you can now support me by subscribing and choosing a paid option!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Problems with ATF</h1><p>ATF was fine for a while. We got a large portion of the old tests in NetBSD resurrected, fixed, and hooked into the ATF infrastructure. A major contribution was Andreas Gustafsson’s <a href=\"https://www.gson.org/netbsd/anita/\">Anita</a>: an automation system to create a VM, install NetBSD on it via the interactive installer, and run the whole battery of tests inside of it.</p><p>Anita and ATF were the beginnings of something akin to a CI system for a full operating system in the open source world. As far as I know, Linux did <em>not</em> have anything similar—and it <em>couldn’t</em> have had anything similar due to the distributed nature of its development—nor did the other BSDs. Windows <em>did</em> have this, of course, as I could glance from the many articles in <a href=\"https://devblogs.microsoft.com/oldnewthing/\">The Old New Thing</a> describing backwards compatibility testing.</p><p>This was great but, over time, ATF showed signs of suboptimal design. It had at least two problems that were really hard to fix, namely:</p><ul><li><p>Its design (remember running <code>atf-run | atf-report</code>?) prevented the execution of tests in parallel, and concurrent test execution is crucial for performance. The Anita test runs took just too long for a good CI turnaround.</p></li><li><p>ATF expected tests to be written using the <code>atf-c</code>, <code>atf-c++</code>, and <code>atf-sh</code> libraries—but developers wanted to implement and reuse tests without porting them to these libraries. In particular, people wanted to create simpler test programs and wanted to support programs that emitted the more-widespread <a href=\"https://testanything.org/\">Test Anything Protocol (TAP)</a> popularized by Perl test harnesses.</p></li></ul><p>Aside from these problems, ATF also lacked a critical feature that Anita had to supply on its own: a data store to track historical test reports and an interface to browse through them. This feature was a necessity for a CI system so, ideally, it had to live within ATF to not be stuck inside a web server. (“Web apps everywhere” was not a thing pre-2010.) To compound the problem, I got an internship at Google in 2008 and joined full-time in 2009, which let me experience <a href=\"https://bazel.build/\">Blaze</a> and its ecosystem for test results tracking and reporting first-hand—and I wanted those features for NetBSD.</p><p>I concluded, <a href=\"https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/\">maybe wrongly</a>, that ATF needed a rewrite.</p><h1>Kyua arrives</h1><p>So, in 2010, I set to create a brand new execution engine. At that point, the target was to rewrite just the portion of ATF that executed tests: that is, the <code>atf-run | atf-report</code> pipeline. I did not want to recreate the ATF <em>libraries</em>. The idea was to:</p><ul><li><p>Create a generic test runner that could integrate multiple test protocols, with the ATF-based tests being the first use case. The unwritten goal was to let the ATF libraries dwindle at some point in the future in favor of better libraries (like <a href=\"https://github.com/google/googletest\">GoogleTest</a> for C++ tests or my own <a href=\"https://jmmv.dev/2023/10/unit-testing-with-shtk.html\">shtk for shell tests</a>).</p></li><li><p>Support a “tests database” to store the results of all test executions. This database was going to allow generating reports in multiple formats and permit running queries to look at historical trends.</p></li><li><p>Support parallel test execution via a more modular runner design. (If you know the history behind Kyua, you’ll notice that this feature only appeared very late in the game. It was a mistake to delay it and I’m not sure why I did that.)</p></li></ul><p>Thus, in November of 2010, Kyua was born as a “testing framework for infrastructure software”. It took some work to get to the point where Kyua could run most of the NetBSD test suite unmodified, but by July 2011, I reached this milestone and launched Kyua 0.1.</p><p>Which led to frustration: ATF was deeply ingrained in NetBSD and Kyua wasn’t well-received for various reasons. One was that Kyua was a larger C++ project than ATF and C++ was (and still is) frowned upon in that community. Another was the fact that Kyua’s reports were harder to manage and required significantly more disk space, and Andreas wasn’t ready to bubble up his CI hardware costs. There were other concerns, all pretty reasonable.</p><p>I kept working on Kyua to try to resolve most of the concerns raised and I believe I addressed all of those that could be addressed. Unfortunately, this took time, and I had grown demotivated to pursue another “sell” of the project. But then…</p><h1>Kyua meets FreeBSD</h1><p>The FreeBSD community had been paying attention. They needed to improve their CI story as well, and they did have much more interest in building a test suite due to the needs of a few corporate-backed projects. I’m not exactly sure who I talked to other than Enji Cooper, George N. Neville, and Ed Maste, but by 2013, I had <a href=\"https://jmmv.dev/2013/11/joining-freebsd-committer-ranks.html\">gotten a FreeBSD commit bit</a> and I was set to integrate Kyua—not ATF!—into FreeBSD.</p><p>One thing I remember was how the FreeBSD project offered me three dedicated beast machines in a colo so that I could set them up for CI runs. This felt very different from the NetBSD approach: FreeBSD had resources—understandably so, as NetBSD has always been underrated—and they were ready to invest them into the shiny-new thing. I took the bait and worked on that for a while. (Fun fact: I used a PowerMac G5 for this work.)</p><p>By December of 2013, I shipped <a href=\"https://jmmv.dev/2013/12/introducing-freebsd-test-suite.html\">the initial CI system</a> for FreeBSD. This was a really exciting moment because all efforts I had put behind Kyua finally paid off: Kyua was <em>the</em> driver for what I think is the most important operating system project in the open source community outside the Linux monoculture.</p><p>The future of the project was tainted though: I was still employed by Google… which made me keep experiencing Blaze and its ecosystem day after day. You see: Blaze is often touted as a <em>build</em> system, but its secret sauce lies in it being a <em>test</em> system. Blaze is a test runner that knows how to precisely build and run <em>the minimum set of tests impacted by a code change</em>. And this matters.</p><p>Precise test selection doesn’t make a big difference for the run-off-the-mill projects you see in GitHub, but for monorepo-style projects—and the BSDs are such projects—this becomes a requirement to run a CI system with quick turnaround times. By this point, I saw Kyua as a “local maximum” because I did not see how to make this possible in combination with the native BSDs’ build systems.</p><h1>Stagnation</h1><p>No matter what I secretly thought, FreeBSD was bought into ATF and Kyua, and they—Enji in particular—had larger plans for the system. The FreeBSD developers really wanted to integrate TAP-style tests, needed to set up a full CI system with many more configurations and architectures than I had set up, and needed better reporting capabilities for failures.</p><p>The problem was that I owned the critical software pieces of this infrastructure, and this was a problem for various reasons: I was too busy with work and two little kids; I had stopped using any BSD on a daily basis; I did not see a bright future for Kyua as it was designed nor implemented; and to make things worse, contributing to Kyua required signing the Google CLA because I still worked for Google (which never made any sense to me but I didn’t have a say in the matter).</p><p>So, for years, Kyua went pretty much unmaintained. FreeBSD kept building local patches and occasionally sent PRs to my upstream project, but I dreaded dealing with them. Maintaining open source projects is stressful if only because of this guilt that you end up with when you don’t have the time to deal with contributions in a timely manner. The more time the situation lasts, the worse it gets.</p><p>It took until 2020 to convince myself that ATF and Kyua needed attention and that I was not fit to support them. I had to let go off these projects and I needed to clear my mind <a href=\"https://www.endbasic.dev/2020/04/hello-endbasic.html\">for other cool stuff</a>. So… I emailed the FreeBSD project owners and offered them to take ownership. If they forked the project and owned it, any FreeBSD committer could easily gain access to the project to do what was best for FreeBSD. And if they owned the fork, they wouldn’t have to worry about the CLA part of the situation because I wouldn’t be involved any longer.</p><p>Things didn’t make the progress I desired though. The FreeBSD project owners had concerns about officially forking these projects into FreeBSD because it cloud give the wrong impression and alienate other consumers like NetBSD. Kyua and ATF were not FreeBSD-only projects so it was probably better for them to stand alone. The discussions died off and stayed like that…</p><h1>Rebirth</h1><p>… until the end of 2023 when Li-Wen Hsu resurrected the email thread I had started. Kyua had become a critical piece of the FreeBSD quality infrastructure and it being almost-abandoned was starting to be problematic. He asked if we could move forward with the project ownership transfer idea—and I was at the ready.</p><p>And so that’s what happened!</p><p>On January 17th, 2024, the right buttons were pushed and… <a href=\"https://github.com/freebsd/kyua/\">Kyua</a> (along with <a href=\"https://github.com/freebsd/atf/\">ATF</a> and <a href=\"https://github.com/freebsd/lutok/\">Lutok</a>) all became owned by the <a href=\"https://github.com/freebsd/\">FreeBSD GitHub organization</a>. Since then, I’ve seen a flurry of PRs reviewed and merged into the project, which makes me happy, really, because the people that care now have the chance to do what’s best for the project.</p><p>Plus, you know what? Even if Kyua has some “design flaws” because it was not designed to be exactly like Blaze, it does have some <em>other</em> interesting ideas that make it a good-enough fit for FreeBSD. In particular, one design principle behind ATF and Kyua was to allow running a test suite <em>without</em> having access to the source code.</p><p>Actually, I think this was a killer idea in the original design of ATF. The motivation for “running tests without the source” was to allow installing a system from scratch and then let <em>the end user</em> run the tests to verify that the system worked correctly <em>on their specific software/hardware combination</em>. The BSDs have limited resources and cannot do the sorts of testing that e.g. Microsoft does with Windows so, by pushing the tests “to the edge”, users could fill that gap.</p><p>And to illustrate this novel-at-the-time idea, let’s take a tour.</p><h1>Kyua in FreeBSD 14</h1><p>Kyua is part of the FreeBSD base system and, as such, it is installed under <code>/usr/bin/kyua</code> and is available out of the box.</p><p>Similarly, the test suite is available under <code>/usr/tests</code> if you choose to unpack <code>tests.txz</code> during the system installation. Peeking under it, we find:</p><pre><code><code>/usr/tests$ ls -F
Kyuafile     conftest.py  lib/         sys/
README       etc/         libexec/     usr.bin/
__init__.py  examples/    local@       usr.sbin/
atf_python/  games/       sbin/
bin/         gnu/         secure/
cddl/        include/     share/
/usr/tests$ █</code></code></pre><p>We can use <code>kyua list</code> to see what kind of test coverage we have. This command prints one test case name per line in its default output format, so we can easily count how many tests there are:</p><pre><code><code>/usr/tests$ kyua list | wc -l
8246
/usr/tests$ █</code></code></pre><p>8000+ tests. Not bad! Let’s peek into a tiny sample by focusing on the tests for <code>dd(1)</code>:</p><pre><code><code>/usr/tests$ kyua list bin/dd
bin/dd/dd2_test:max_seek
bin/dd/dd2_test:seek_overflow
bin/dd/dd2_test:sigint_open
bin/dd/dd2_test:sigint_read
bin/dd/dd_test:io
bin/dd/dd_test:length
bin/dd/dd_test:seek
/usr/tests$ █</code></code></pre><p>And let’s run those!</p><pre><code><code>/usr/tests$ time kyua -v parallelism=$(nproc) test bin/dd
bin/dd/dd2_test:seek_overflow  ->  passed  [0.042s]
bin/dd/dd2_test:max_seek  ->  skipped: tmpfs can't create arbitrarily large sparse files  [0.044s]
bin/dd/dd_test:length  ->  skipped: fdescfs is not mounted on /dev/fd  [0.024s]
bin/dd/dd_test:seek  ->  passed  [0.048s]
bin/dd/dd_test:io  ->  passed  [0.071s]
bin/dd/dd2_test:sigint_read  ->  passed  [3.077s]
bin/dd/dd2_test:sigint_open  ->  passed  [3.079s]
Results file id is usr_tests.20240728-161942-793100
Results saved to /home/jmmv/.kyua/store/results.usr_tests.20240728-161942-793100.db
7/7 passed (0 failed)
kyua -v parallelism=$(nproc) test bin/dd  0.17s user 0.33s system 15% cpu 3.198 total
/usr/tests$ █</code></code></pre><p>Easy peasy. We can run tests for any part of the system right from the <code>/usr/tests</code> hierarchy without having had to build anything nor needing access to the source tree. As mentioned earlier, you can use this feature to validate that FreeBSD works on your specific machine given that device drivers are of varying quality (something that’s true on <em>any</em> operating system) and may result in different behavior. And you can use this feature to validate that the system <em>continues to work</em> as you perform upgrades over time.</p><p>Outside of your machine, though, we can also look at the CI system based on Jenkins. For that, head to <a href=\"https://ci.freebsd.org/\">https://ci.freebsd.org/</a> and peek around. Notice the tens of different jobs configured to build and test FreeBSD under various architectures, releases, and build settings.</p><p>As an example, look at the recent <a href=\"https://ci.freebsd.org/job/FreeBSD-main-amd64-test/25361/testReport/\">run 25361 of FreeBSD-main-amd64-test</a>, and notice how we can inspect the same test results we saw on the command line. Do so by clicking on <code>bin.dd</code> and finding the results for the same tests we ran earlier. This showcases Kyua’s ability to generate a <code>junit.xml</code> test report—an output format that was precisely written to integrate with Jenkins for the FreeBSD CI system.</p><div><hr></div><p>And that’s it.</p><p>The morale of the story is two-fold. First, free software can remain alive and kicking even if the original authors lose interest. And second… do you see how powerful it is to have a CI system for <em>a whole OS</em>? This is something Linux can only dream of because of its inherent distributed development nature. Yes, there is the <a href=\"https://github.com/linux-test-project/ltp\">Linux Test Project</a>, but because Linux is “just a kernel”, this is what this project can test. There is nothing that can validate that the kernel works in combination with all other pieces that form a Linux distribution in a uniform and cohesive manner.</p><p>In any case, congrats grads. Kyua has a bright future ahead.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "0.0" "image/jpeg") nil "d81888c131aea872d2861c981c3c1249") (41 (26624 38279 262691 117000) "https://blogsystem5.substack.com/p/netbsd-build-system" "Revisiting the NetBSD build system" "Julio Merino" "Sat, 28 Dec 2024 08:01:16 +0000" "<p>I recently picked up an embedded project in which I needed to build a highly customized full system image with minimal boot times. As I explored my options, I came to the conclusion that NetBSD, the often-forgotten BSD variant, was the best viable choice for my project.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":403124,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>One reason for this choice is NetBSD’s build system. Once you look and get past the fact that it feels frozen in time since 2002, you realize it is still one of the most advanced build systems you can find for an OS. And it shows: the NetBSD build system allows you to build the full OS from scratch, on pretty much any host POSIX platform, while targeting any hardware architecture supported by NetBSD. All without root privileges.</p><p>Another reason for this choice is that NetBSD was my daily workhorse for many years and I’m quite familiar with its internals, which is useful knowledge to quickly achieve the goals I have in mind. In fact, I was a NetBSD Developer with capital D: I had commit access to the project from about 2002 through 2012 or so, and I have just revived my account in service of this project. <code>jmmv@</code> is back!</p><p>So, strap onto your seats and let’s see how today’s NetBSD build system looks like and what makes it special. I’ll add my own critique at the end, because it ain’t perfect, but overall it continues to deliver on its design goals set in the late 1990s.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The basics</strong></h1><p>The NetBSD build system is powerful and featureful, but it’s also arcane as it’s based on a combination of the BSD variant of make and shell scripts. Just peek through the files under <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/src/share/mk\">src/share/mk/</a>, the directory that contains the bulk of the infrastructure, to see what I mean.</p><p>As a user of the build system, however, you rarely interact with make directly. Instead, you use the <code>build.sh</code> script located at the top of the source tree. This script provides a user-friendly interface to most operations you may want to do, and abstracts away the intricacies of the targets that coordinate the build of the system and the configuration that controls it.</p><p>The structure of the command is to pass high-level “goals” to <code>build.sh</code> as arguments, which indicate the operations to perform. In its most simple form, all you need to do to build a full system distribution targeting the architecture of the host is:</p><pre><code><code>./build.sh tools release</code></code></pre><p>But hey, I promised you can trivially cross-build too, right? Sure, let’s compile the system for a Raspberry Pi with a 64-bit chip, produce the USB image that we can write to an SD card, and do everything as an unprivileged user:</p><pre><code><code>./build.sh -U -a aarch64 -m evbarm tools release disk-image</code></code></pre><p>That’s it, really. That’s all it takes.</p><p>We must dig deeper though, so let’s look at some of those “goals” to see what <code>tools</code> means and understand how a release is put together without root privileges.</p><h1><strong>The toolchain</strong></h1><p>The very first step of any <code>build.sh</code> invocation is to generate the toolchain used to build the rest of the system. This is true of any build, including those that target the host machine, because this ensures that the build is independent of the host’s state. In particular, this avoids the situation where you might have to upgrade certain components before building, which was/is common in other BSDs.</p><p>And you have seen this prerequisite step in the previous section, by the way: all sample <code>build.sh</code> invocations I showed you included <code>tools</code> as the first goal. Now, you don’t <em>have</em> to provide <code>tools</code> to <em>every</em> invocation of the script: as soon as you have built a toolchain, you can reuse it in subsequent invocations.</p><p>Building a toolchain with <code>build.sh</code> is incredibly handy on its own, as you can produce cross-build toolchains and use them for other purposes outside of building NetBSD itself. Zig’s build system has often been praised for this reason, but NetBSD’s has nothing to envy. For example, if we do this:</p><pre><code><code>./build.sh -a aarch64 -m evbarm -T ~/tools tools</code></code></pre><p>We end up with a cross-build C and C++ toolchain under <code>~/tools/</code> that targets NetBSD running on ARM 64 bits. And what goes into the toolchain, you ask?</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":95814,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Directory listing of tools as produced by the command above and its bin subdirectory.</figcaption></figure></div><p>In this listing, you can see a bunch of binaries prefixed with <code>aarch64--netbsd-</code>. These are all part of the C and C++ toolchain. The rest of the tools, prefixed with <code>nb</code>, are NetBSD-specific tools required during the build. These are programs that are part of a normal NetBSD installation and would be available without the <code>nb</code> prefix if we were building on a NetBSD host, but remember, the build system supports <em>any</em> POSIX host OS. Take <code>nbsed</code> as an example: yes, all POSIX hosts provide a <code>sed</code> tool, but its syntax varies among systems so the NetBSD build system isolates itself from those differences by compiling <code>sed</code> as a host tool and using that throughout.</p><p>One special tool from this listing is <code>nbmake-evbarm</code>. This is not the binary for make (which is itself stored as <code>nbmake</code>). This is a shell script that captures all settings provided to <code>build.sh</code> and then invokes <code>nbmake</code> with those, and this script is useful when you want to manually rebuild portions of the tree. Not something you would want to use as an “end user” of the build, but something you definitely will want to use as a NetBSD developer.</p><h1><strong>Build structure</strong></h1><p>Let’s explore the source tree a bit, which is the prime example of a monorepo in an open source project:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":77279,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Directory listing of the source tree, its bin and bin/ls subdirectories, and the content of bin/ls/Makefile.</figcaption></figure></div><p>In this picture, you can see first the content of the top-level directory of the source tree. It all looks pretty simple: there are various subdirectories, such as <code>bin</code>, <code>lib</code>, or <code>usr.bin</code>, that roughly track the structure of the installed system; there is the <code>build.sh</code> script that I previously described; and there is a <code>Makefile</code> as well. Looking into one subdirectory, like <code>bin</code>, we see another <code>Makefile</code> and many more subdirectories, one per tool installed onto <code>/bin/</code>.</p><p>Knowing this directory-based structure, we can use the <code>nbmake-evbarm</code> wrapper script I mentioned earlier to operate on just a portion of the monorepo. Focusing on the <code>ls</code> example shown in the screenshot, we could build and upgrade this piece of the system on its own by doing:</p><pre><code><code>$ cd ~/src/bin/ls
$ ~/tools/bin/nbmake-evbarm all
... console noise ...
$ sudo ~/tools/bin/nbmake-evbarm install
... console noise ...
$ █</code></code></pre><p>Another extra detail to highlight from the screenshot is that NetBSD’s <code>Makefile</code>s are mostly declarative. Each <code>Makefile</code> defines a bunch of variables to specify what is being built and, at the end, includes one of the many <code>bsd.*.mk</code> files that pull in the build logic. Among these, we have <code>bsd.prog.mk</code> to build one program, <code>bsd.lib.mk</code> to build one static/shared library, and <code>bsd.subdir.mk</code> to recurse into subdirectories. Importantly, the general design is to build just <em>one</em> item per directory—although I myself broke this rule when I added <code>bsd.tests.mk</code> to build tests because splitting them into subdirectories would have added too much noise to the tree.</p><p>This declarative design is interesting because it maps well to the foundations of modern build systems like Bazel. In fact, the design of the NetBSD build system is what fueled my interest in build systems, influenced the design of <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my own Buildtool</a>, and made me like <s>Bazel</s> Blaze as soon as I first saw it in 2008.</p><h1><strong>The destdir</strong></h1><p>In order to produce the structure of the final installation, the build system uses the “destdir” concept. A destdir is a staging location where built files are installed, but paths to this staging location are <em>not</em> used within the artifacts produced by the build. This idea <a href=\"https://www.gnu.org/software/automake/manual/html_node/DESTDIR.html\">exists in other build systems such as GNU Automake</a> and is pretty much a necessity to build multiple pieces of software together before installing them or to package software without root privileges.</p><p>Imagine that you want to build a library, say <code>libm</code> (the math library), and a tool that uses it, say <code>bc</code> (the calculator). <code>libm</code> typically goes into <code>/lib/</code> so we cannot just build and install it in place: for one, we may “break” the existing system if the new version happens to be backwards-incompatible; for another, we may be targeting a different architecture so we cannot just replace <code>/lib/libm.so</code> with an incompatible version.</p><p>The destdir comes to the rescue. We first build <code>libm</code> as if it would be installed into <code>/lib/</code>. However, during <em>installation</em>, we prefix all file copy operations with the destdir. In this way, we build a separate “system root”, say <code>/tmp/destdir/lib/</code>, that contains the newly-built <code>libm.so</code>. After that, we build <code>bc</code> and point it to the <code>libm</code> that’s in <code>/tmp/destdir/lib/</code>, but… we have a problem: we can’t allow the <code>/tmp/destdir/</code> path to appear anywhere inside the <code>bc</code> binary because this directory is transient. To fix this, we must separate build paths from runtime paths during the build: when we build <code>bc</code>, we tell the linker to look for libraries under <code>/tmp/destdir/lib/</code> via the <code>-L</code> flag, and we also tell the linker that, at <em>runtime</em>, libraries will be available in <code>/lib/</code> via the <code>--rpath</code> flag (which stands for runtime path).</p><p>As you can imagine, the NetBSD build system heavily relies on this idea and, after a <code>distribution</code> build (implied by the <code>release</code> goal I showed earlier):</p><pre><code><code>./build.sh -D /tmp/testdir/ distribution</code></code></pre><p>we end up with a destdir that contains all system files laid out exactly as they need to be installed.</p><p>In fact, if you run the build as root and target the host system (where the host is NetBSD), the destdir can serve as the target of a chroot. So, if you do:</p><pre><code><code>chroot /tmp/destdir</code></code></pre><p>you essentially can enter the freshly-built system. This may or may not work, however: the newly-built binaries might require new kernel features, which is likely true if you are building a more modern NetBSD release from an older release or if you are tracking NetBSD-current. And this obviously won’t work if you are cross-building.</p><h1><strong>Distribution media</strong></h1><p>The destdir serves as a staging area but it does not represent the final artifacts of the build. To put the destdir to use, we either have to “copy” the staging area onto the host to perform an in-place upgrade, or we need to build distribution media.</p><p>The former case of an in-place upgrade is tricky because it requires issuing manual post-installation steps, so I’m not going to describe it here. But the latter case of producing distribution media is trivial. For example, we can do:</p><pre><code><code>./build.sh release</code></code></pre><p>to produce the release “sets” for the system from the contents of the destdir, or we can do:</p><pre><code><code>./build.sh iso-image install-image live-image</code></code></pre><p>to create various types of installation media (a bootable CD, a bootable USB image, a live system image…) from the contents of the destdir as well.</p><p>The release sets are an interesting thing to discuss because they form the core of a NetBSD distribution. You see: NetBSD ships as a collection of tarballs, and installing NetBSD amounts to simply unpacking those tarballs onto a file system and performing a few post-installation configuration steps.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" width=\"833\" height=\"730\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":730,\"width\":833,\"resizeWidth\":null,\"bytes\":139363,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Content of the binary/sets directory of the NetBSD/amd64 distribution.</figcaption></figure></div><p>Now, the way these tarballs are produced from the destdir is by leveraging <code>mtree</code>, a really cool tool that is not known in Linux land. The purpose of this tool is to compare a textual “golden” representation of a directory against the actual contents of the directory, and highlight where they might differ.</p><p>BSD systems use <code>mtree</code> to describe how the installed system looks like and, as you can imagine, NetBSD is no exception. The NetBSD build system uses <code>mtree</code> files to ensure the destdir contents match expectations, and also uses the <code>mtree</code> “manifests” to “bucketize” the files from the destdir into the individual release sets. You can find these golden manifests in the <code>src/distrib/sets/lists/</code> directory.</p><h1><strong>Unprivileged builds</strong></h1><p>These <code>mtree</code> files are also critical for another very important feature: namely, the ability to build the whole NetBSD system as an unprivileged user. This, to me, is one of the most impressive features of this build system: you can produce the full build, including disk images, without ever running <code>sudo</code> or using weird intercept tools like Debian’s <code>fakeroot</code>.</p><p>Here is how this works. When building in unprivileged mode (enabled via the <code>-U</code> flag to <code>build.sh</code>), the build system produces a <code>METALOG</code> file under the destdir. This file looks like this:</p><pre><code><code>$ grep '^\\./sbin' ~/destdir/METALOG | head -n 5
./sbin type=dir uname=root gname=wheel mode=0755
./sbin/amrctl type=file uname=root gname=wheel mode=0555 size=72120 time=1735119460.0 sha256=d6f474441dc98648a4e8ec633dd76fc3349c85a0af9830ce8eb6566e94291fdb
./sbin/apmlabel type=file uname=root gname=wheel mode=0555 size=72360 time=1735119460.0 sha256=731cf433328bd14c6d3f322ef60fa92eb9eaa2725baa0cb52253b50743d9d324
./sbin/atactl type=file uname=root gname=wheel mode=0555 size=73512 time=1735119461.0 sha256=74a15335c8715513ac50f615a8e906319df79f76dad601bc688ae214b3e41673
./sbin/badsect type=file uname=root gname=wheel mode=0555 size=72328 time=1735119461.0 sha256=76e34649bf100fe490befb2a4ec58455a7710a665dd59bcbbd8c672a6086bde8
$ █</code></code></pre><p>Every line of this file maps a file system entry (a directory, a file, a device…) stored in the destdir to its properties, including ownership information and permissions. These entries are generated from metadata encoded in the <code>Makefile</code>s whenever the build system places a new file under the destdir via the <code>install</code> command (another nice tool often unknown to Linux users). The <code>METALOG</code> is the key that allows building media images without root privileges.</p><p>If you think about it, media images are simply files with an internal structure that represents disk partitions, file systems, and metadata. Because they are simply files, there is no need to have root access nor to make the host’s <code>passwd</code> file contain all users represented by entries in these file systems. Traditionally, OS builds have needed root because it’s easier to leverage the kernel’s virtual devices and file system implementations, but there is not inherent reason for that to be the only choice. All the work can be done in user space, and that’s precisely what NetBSD does.</p><p>Now, go back and revisit the screenshot above that showed the toolchain contents. You’ll notice tools like <code>nbmakefs</code> (the tool to format a file system) and <code>nbgpt</code> (the tool to create a GPT partitioning scheme). These tools are part of the toolchain because they are needed to generate installation media, and these tools know how to read the <code>METALOG</code> in order to embed the right permissions and special file modes into the built images. All without ever becoming root.</p><h1><strong>sysbuild</strong></h1><p>Now, as simple and powerful as <code>build.sh</code> might be, I find it cumbersome for day to day use if you want to customize any of its default settings. It is not uncommon to end up running <code>build.sh</code> with invocations like:</p><pre><code><code>./build.sh -O ../obj -T ../tools -U -u -V MKDEBUG=no -V MKGCC=no distribution</code></code></pre><p>which the official documentation describes as “golden invocations” and I have no desire to type or even remember.</p><p>This is what drove me to <a href=\"https://jmmv.dev/software/sysbuild.html\">write sysbuild</a>: a layer of abstraction over <code>build.sh</code> <em>and</em> <code>cvs</code> that coordinates updating the source tree and building it. The tool even integrates with <code>cron</code> trivially, providing a mechanism to keep NetBSD-current installations up-to-date.</p><p>sysbuild is driven by configuration “profiles” which allow you to customize the paths and settings of a build in just one place and then puts them to use with a trivial command. For example, with a configuration file like the following stored in <code>~/.sysbuild/rpi.conf</code>:</p><pre><code><code>BUILD_ROOT=\"${HOME}/netbsd\"
BUILD_TARGETS=\"tools sets disk-image\"
CVSROOT=:ext:anoncvs@cvs.NetBSD.org:/cvsroot
MACHINES=amd64
RELEASEDIR=\"${BUILD_ROOT}/release\"
SRCDIR=\"${BUILD_ROOT}/src\"
UPDATE_SOURCES=no</code></code></pre><p>We can simply run:</p><pre><code><code>sysbuild -c rpi build</code></code></pre><p>to update the NetBSD source tree to the latest version, ensure that the tools are up-to-date, and produce the USB disk images for a Raspberry Pi.</p><h1><strong>Deficiencies</strong></h1><p>Not everything about the NetBSD build system is rosy though.</p><p><em>The</em> thing that differentiates a good build system from a “meh” one for me personally is the behavior of incremental builds and, in particular, two aspects of these:</p><ul><li><p>First, incremental builds need to do minimal work, especially when there is “nothing to do”. The NetBSD build system is a recursive make one (which comes with its own <a href=\"https://accu.org/journals/overload/14/71/miller_2004/\">set of problems</a>), so it does <em>not</em> do minimal work. On my 72-core machine, it takes about 3 minutes to run through a <code>build.sh release</code> invocation that does nothing. This is OK for end users looking to upgrade their running machine, but it is painful because it makes iterating on system changes difficult. As a developer, you end up needing to know how to surgically rebuild individual subdirectories using the <code>nbmake-<arch></code> wrappers I described earlier, and manually track dependencies across those.</p></li><li><p>Second, incremental builds must <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html\">always deliver correct results</a> <em>without</em> having to do a <code>make clean</code> in between. But that’s generally not true for make-based build systems—and NetBSD’s is no exception. Generally, an incremental build after a <code>git pull</code> (sorry, a <code>cvs update</code>) will work fine, but sometimes it won’t. And if you start playing with build-time switches (things like <code>MKDEBUG</code>), then you are out of luck and must resort to a <code>make clean</code> to “switch configurations”.</p></li></ul><p>And there are other problems. Running a parallel build on a system with many cores sometimes leads to spurious build failures because the interdependencies between components are not always precisely specified (it’s <em>really</em> difficult to be correct with make). And the build is inefficient: of those 3 minutes I mentioned earlier, you can see that <em>most of the time</em> is wasted by make recursing through directories and discovering there is nothing to do, whereas other times, make “chokes” on way too many C++ compiles at once that lead to out of memory situations.</p><p>It has been <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">my dream since the publication of Bazel</a> as open source to have a Bazel-based build of NetBSD. I think Bazel is the perfect build system for such a project because it’d deliver correct and efficient incremental builds to NetBSD’s monorepo, and it would save tons of resources when running on many-core machines. Except for the fact that it’s written in Java, so it’d be a really odd choice for such project. Maybe Buck 2 would be suitable. Anyway, one can only dream…</p><h1><strong>But why?</strong></h1><p>Why I’m looking at this at all again, after years of not touching NetBSD? I said it in the opening: I’m working on a new embedded project for which NetBSD is the greatest fit. I could tell you what it is about but it’s easier to just show you:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"091ac30d-6b0b-46d9-af1b-df099485a01b\",\"duration\":null}\"></div><p>OK, fine, in words: I am building a minimal system that boots straight into EndBASIC with quick build times and low overhead. You’ll have to wait a bit more to get your hands on this though, as I’m still ironing out various details and want to end up providing a pre-built “box” with the right hardware and software combination.</p><p>I’m also becoming <em>super</em> tempted to migrate NetBSD’s build to Bazel to make my own life easier in this journey. This is a monumental task… but I’m not sure that it’d be crazy to tackle the minimum subset of NetBSD that I need for this minimal disk image and port only those portions to Bazel. The results might impress some and then want to help the effort. Right?</p><p>In the meantime, I encourage you to read through the comprehensive <a href=\"https://www.netbsd.org/docs/guide/en/part-compile.html\">Building the system</a> portion of <a href=\"https://www.netbsd.org/docs/guide/en/index.html\">The NetBSD guide</a>, and to play with building a NetBSD image straight from your Linux machine. You may like it.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "0.0" "image/jpeg") nil "0641dc4ae7daafc7a842d81bac12f0d3") (40 (26624 38279 260502 367000) "https://blogsystem5.substack.com/p/synology-ds923-vs-freebsd" "Synology DS923+ vs. FreeBSD w/ZFS" "Julio Merino" "Fri, 13 Dec 2024 17:10:52 +0000" "<p>My interest in storage is longstanding—I loved playing with different file systems in my early Unix days and then I worked on Google’s and Microsoft’s distributed storage solutions—and, about four years ago, I started running a home-grown NAS leveraging FreeBSD and its excellent ZFS support. I first hosted the server on a PowerMac G5 and then upgraded it to an overkill 72-core ThinkStation that I snapped second-hand for a great price.</p><p>But as stable and low maintenance as FreeBSD is, running day-to-day services myself is not my idea of “fun”. This drove me to replace this machine’s routing functionality with a dedicated pfSense box a year ago and, for similar reasons, I have been curious about dedicated NAS solutions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":251556,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Synology DS923+ on top of its shipping box right after unboxing it.</figcaption></figure></div><p>I was pretty close to buying a second-hand NAS from the work classifieds channel when a Synology marketing person (hi Kyle!) contacted me to offer a partnership: they’d ship me <a href=\"https://sy.to/hekgh\">one of their devices</a> for free in exchange for me publishing a few articles about it. Given my interest to drive-test one of these appliances without committing to buying one (they ain’t cheap and I wasn’t convinced I wanted to get rid of my FreeBSD-based solution), I was game.</p><p>And you guessed right: this article is one of those I promised to write but, before you stop reading, the answer is no. This post is <em>not</em> sponsored by Synology and has not been reviewed nor approved by them. The content here, including any opinions, are purely my own. And what I want do do here is compare how the Synology appliance stacks against my home-built FreeBSD server.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The hardware</strong></h1><p>Here are the two contenders in my comparison:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":329916,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Synology D923+ next to my ThinkStation P710 on top of a dusty LackRack in the garage.</figcaption></figure></div><ul><li><p><strong>My home-built NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3DaBQze\">ThinkStation P710</a> equipped with 2x Intel Xeon E5-2697 v4 processors (18c/36t) at 2.30GHz, 64GB of RAM, 2x <a href=\"https://amzn.to/3ZvimN7\">Seagate 4TB Enterprise Capacity 7200 RPM</a> drives and a <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB.</p></li><li><p><strong>Operating system:</strong> FreeBSD 14.</p></li><li><p><strong>Storage configuration:</strong> ZFS with the two HDD drives in mirror mode and with the SSD set up as the L2ARC plus ZIL log for the drive pool.</p></li></ul></li><li><p><strong>The Synology NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3ZL7sUI\">Synology DS923+</a> equipped with 3x <a href=\"https://amzn.to/4g73s6S\">Synology Plus Series 4TB 5400 RPM</a> drives and the same <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB that I moved from one machine to the other. The box is equipped with a 4-core AMD Ryzen Embedded R1600 and 4GB of RAM.</p></li><li><p><strong>Operating system:</strong> Synology’s own DiskStation Manager (DSM).</p></li><li><p><strong>Storage configuration:</strong> btrfs with the three HDD drives set up in RAID 5 mode and with the SSD set up to act as the cache for the drive pool.</p></li></ul></li></ul><p>The two configurations are quite different—after all, I am comparing a workstation machine with lots of spare CPU and RAM to a dedicated machine specifically crafted for file sharing—so it’s going to be difficult to be “fair” in any comparison. In any case, here are a few things to contrast:</p><ul><li><p><strong>IOPS:</strong> The P710 runs with 2 7200 RPM drives in mirror mode whereas the DS923+ runs with 3 5400 RPM drives in RAID 5 mode. The number of total IOPS from each is going to differ but… for all purposes, the 1Gbit NIC that each machine has is the limiting factor in performance so I haven’t bothered to run any performance tests. Both can saturate the network, so there is that.</p></li><li><p><strong>Quality:</strong> Both the P710 and the DS923+ are impressive machines—maybe not PowerMac G5 impressive levels, but pretty, pretty close. I love the ThinkStation’s outer design and the interior shows great cable management and airflow. As for the NAS, I love the lightweight and small form factor that allows placing it pretty much anywhere. Both are tool-less enclosures.</p></li><li><p><strong>Noise:</strong> When idle, both machines are equally quiet. The ThinkStation gets really, really loud under heavy load though, and it is also uncomfortably loud even at idle when the room temperature is warm (around or over 25C). The DS923+, however, seems quiet throughout. The Synology Plus Series HDDs are also quieter than the ones I had in the ThinkStation, and that’s partly because they are slower 5400 RPM drives. In any case, these two machines stay in my garage so I don’t care about their noise.</p></li><li><p><strong>Power consumption:</strong> I unfortunately do not own a tool to measure it, but it’d be neat to compare how these two stack up. I’m sure I’ve thrown money away by keeping the ThinkStation online 24x7 and having those drives never rest (ZFS doesn’t let them spin down) but it’s hard to care about it because my power bill is dominated by heating almost year-round.</p></li></ul><h1><strong>FreeBSD and ZFS</strong></h1><p>FreeBSD is my current favorite system for servers. FreeBSD remains close to its Unix roots and maintains rational and orthogonal tooling (unlike Linux), is quick and trivial to maintain (I could run through the 13 to 14 upgrade in… 15 minutes?), and bundles modern technology like ZFS and bhyve (unlike NetBSD, sadly, which used to be my BSD of choice).</p><p>It is true that FreeBSD gave me some headaches when I ran it on the PowerMac G5, but that’s expected due to the machine being 20 years old and <a href=\"https://www.freebsd.org/platforms/ppc/\">FreeBSD’s PowerPC support</a> being a Tier 2 platform. The thing is that I never intended to run a NAS on the G5; it just so happened to be the only machine I had available for it. In any case, I have had <em>zero</em> problems on the ThinkStation. Mind you: when I bought this machine, both Windows and Fedora experienced occasional freezes with their default installations (before pulling upgrades from the network) and FreeBSD never has shown any signs of instability.</p><p>As for ZFS, it is hard to convey the feeling of “power” you experience when you type <code>zpool</code> and <code>zfs</code> commands and see the machine coordinate multiple disks to offer you a dependable storage solution. Creating file systems on a pool, creating raw volumes for VMs or iSCSI targets, taking snapshots, replicating snapshots over the network or to backup USB drives, scrubbing the drives to verify data integrity… all are trivial commands away.</p><p>ZFS feels slow though. I grew up thinking of file systems as contiguous portions of a disk and tinkering with their partitioning scheme to keep groups of data unfragmented for speedy access. Due to the way ZFS operates, however, none of this archaic knowledge applies (and to be honest, I do not know how ZFS works in detail internally). That said, a hard drive’s seek time is around 10ms and has been like that for decades, which combined with the fact that we are now spoiled by having SSDs everywhere, exacerbates how slow an HDD-based solution feels no matter the file system.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" width=\"1440\" height=\"800\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":800,\"width\":1440,\"resizeWidth\":null,\"bytes\":45551,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Did I just mention disk fragmentation? Yeah I did, and I could not resist including this screenshot of MS-DOS 6.22's DEFRAG.EXE here. Just because.</figcaption></figure></div><p>Regarding network connectivity, FreeBSD offers all sorts of networked file systems and services. The base system provides NFSv3, NFSv4, FTP, and iSCSI targets. The ports (packages) system offers whatever else you may need, including SMB, DLNA, and even ancient protocols like AppleTalk or distributed protocols like Ceph. All configuration is done by hand over SSH in the traditional Unix way of editing configuration files—aka messing around with different, inconsistent text formats.</p><h1><strong>Synology’s DSM and btrfs</strong></h1><p>The DS923+ runs Synology’s own operating system: the <a href=\"https://www.synology.com/en-us/dsm\">DiskStation Manager (DSM)</a>. The DSM is a headless-first system designed to be accessed over the network, which is no surprise. What <em>is</em> surprising is the choice of the interface: while most networked devices offer some sort of a web-based tabbed UI, the DSM offers a desktop environment—with overlapping windows no less. This feels like a gimmick to me, and a quite neat one, but overkill nonetheless.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":384169,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The DSM desktop with the Control Panel and the File Station apps open to demonstrate the appearance of the web-based windowing system.</figcaption></figure></div><p>If we peek under the covers, which we can do by logging into the machine over SSH, we find that the DSM is a Linux system. No surprises here after seeing that its choice of file system is btrfs. But what kind of Linux is it? A weird one, let me tell you. Luckily, you do not have to interact with it at all if you don’t want to, but hey, I’m curious so I did look.</p><p>The DSM seems to be some sort of Debian derivative based on the fact that <code>dpkg</code> is installed, but otherwise I cannot find any other obvious remains of what might have been a Debian installation; even <code>dpkg -l</code> shows nothing. What I can tell is that the btrfs file systems are mounted under <code>/volume1</code> and, in there, we can find one directory per shared folder that we create in the UI. We can also find various directories prefixed with <code>@</code>, which is a… weird choice for Unix file names, and I understand are managed by the DSM. These include things like <code>@appdata</code> or <code>@userpreference</code>, which carry strong Windows vibes.</p><p>Considering that the DS923+ is almost a PC and runs Linux, I did look to see if it was possible to run FreeBSD instead. It turns out some people have tried this, and FreeBSD does run, but it lacks drivers to control power to the drives so it cannot actually leverage the storage devices. From what I understood, the DS923+ seems to have dedicated hardware to control power the drive pool, and this hardware logic is controlled via GPIO.</p><p>Which got me even more curious: if the DSM explicitly controls power to the drive pool, how does it boot and how does it remain responsive even after shutting down the drives? I guessed that the device comes with a tiny drive to hold the DSM and boots off of it, and upon inspecting the <code>dmesg</code> and looking for non-obvious stuff, I found this:</p><pre><code><code>sd 7:0:0:0: Attached scsi generic sg3 type 0
sd 7:0:0:0: [synoboot] 245760 512-byte logical blocks: (126 MB/120 MiB)
sd 7:0:0:0: [synoboot] Write Protect is off
sd 7:0:0:0: [synoboot] Mode Sense: 23 00 00 00
sd 7:0:0:0: [synoboot] No Caching mode page found
sd 7:0:0:0: [synoboot] Assuming drive cache: write through
sd 7:0:0:0: [synoboot] Attached SCSI disk</code></code></pre><p>Ah-ha. A small 120MB (flash?) drive that acts as the system device. However… this separation of system vs. drive pool comes with a price: the drive pool often shuts off, and powering it back on is <em>slow</em> (10–15 seconds are not unusual). When you try to reach the NAS over the network and the pool is off, it can feel as if the NAS is unreachable / down, which has already confused me a few times and caused me to started diagnosing network issues. Quite annoying to be honest, but obviously this can be configured in the <em>Hardware & Power</em> menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":413086,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The list of available options under the Hardware & Power menu.</figcaption></figure></div><p>Regarding network connectivity, the DSM offers multiple networked file systems and services out of the box, namely: SMB, NFS v3, NFS v4, AFP, FTP, and rsync. I’m actually surprised to see AFP, AppleTalk’s “replacement”, in the default set of supported file systems in this day and age, but there it is. Additionally, the DSM provides its own package management system to install a limited set of additional services and utilities, which I used to add DLNA support.</p><h1><strong>Seeding the NAS</strong></h1><p>Anyhow, let’s change topics and talk about the DS923+ itself.</p><p>The first thing I had to do after getting the device was to seed it with data. I needed to copy about 1TB of photos and documents from the FreeBSD machine to the DS923+, which is not a lot, but is large enough that different copy mechanisms can make a huge difference in the time the copy takes. In particular, the choice of <em>protocol</em> matters for a quick copy: both SMB and NFS are OK with large files, but transferring many small files with them is painful. Fortunately, the DSM allows rsync over SSH and I used that to do the initial seeding.</p><p>Now, using rsync came with two “problems”. The first is that I had to know the <em>path</em> to the shared folders in the file system to specify the rsync targets. This is not clearly exposed through the UI, so I had to rely on SSH to log into the machine and figure out that the shared folders are at <code>/volume1/<shared_folder>/</code> as I briefly mentioned in the previous section.</p><p>Which led to the second problem or, rather, surprise: even though I had set up 2FA for the user accounts I created in the DSM UI, 2FA was meaningless when accessing the machine over SSH. I understand why that may be, but then I question what the point of enabling 2FA really is if one can gain access to the machine without it. The same is true of SMB by the way: you just need an account’s password, not the 2FA. So, unless you disable all networked file systems and only allow web access to the NAS, all the 2FA does is give you a false sense of security.</p><h1><strong>Peace of mind</strong></h1><p>When comparing my custom FreeBSD server to the newer DS923+, the main difference I can notice is an increase in “peace of mind”. Yes, FreeBSD is very stable and ZFS is great… but I wasn’t running the ThinkStation as a dedicated NAS: I was mixing the machine’s NAS responsibilities with those of a host for development tasks. I always felt uncomfortable about the health of the system and I wasn’t convinced that my maintenance was “good enough” to safeguard my data.</p><p>As you can imagine, being uncomfortable about your data is not something you want to feel: trust is <em>The Thing</em> you most want in a storage solution, and there are a few things that stand out during the setup of the system that gave me warm feelings on this topic.</p><p>The first and obvious one is that the DSM offers to encrypt the pool right from the beginning, which is something you should always do in this day and age: encryption is cheap in CPU terms, the data you own is precious, and the devices that store it tend to be small and light so they are at risk of theft. But beware: the key is stored on the device to allow auto-mounting by default, which means a knowledgeable thief could still gain access. Thus, this level of encryption is only useful to facilitate the disposal of drives. That said, you can configure additional encryption on each shared folder if you want per-user password-protected encryption.</p><p>The second thing is that, nowhere in the setup process I was asked to create a Synology account for the NAS to be fully functional. You might think that this is a given, but seeing the state of other hardware or software products these days… it’s not. So this sent a very welcome message. I ended up needing to create an account for certain features that required it, but these were completely optional.</p><p>The third thing, which is actually one of those features that required creating a Synology account, is the ability to send email notifications for system alerts. Email-based alerts are terrible in large organizations (and of course the DSM offers better alternatives, like ActiveInsight), but for my personal use case, emails are perfect and make a huge difference with my previous FreeBSD setup. I can rest assured that I’ll be told about anything unusual with the DS932+ in a way that I will notice. With my custom build, I had certain monitoring features in place like weekly disk scrubs and periodic online backups… but no way to properly notify me of problems with either: if anything went wrong, I would not have known on time, and that was very unsettling.</p><p>The fourth and final thing is that the DSM has been built throughout the years by people that deal with storage all the time, and it’s fair to assume that they know a thing or two about running a NAS. I have reasonable confidence that the configuration of the system and the storage pool is going to be “correct” over time, particularly across upgrades, whereas I was never quite sure of it with my manual FreeBSD setup. One such example is with the NFS configuration: setting up the NFSv4 server in the DSM was pretty much knob-free—so <a href=\"https://blogsystem5.substack.com/p/demystifying-secure-nfs\">when things didn’t work with the clients</a>, I could assume that the issue was almost certainly with the clients themselves.</p><h1><strong>Additional apps</strong></h1><p>As I mentioned earlier, the DS923+ is pretty much a PC with Linux in a tiny box, so in principle it can host any kind of software you like. The way this works is via DSM’s own “marketplace” where you can find new services to add to the machine.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":365681,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The DSM desktop showing the Package Center application.</figcaption></figure></div><p>I did add the optional DLNA service so that I could play videos from my Xbox, and also toyed with with the Domain Server (and later gave up due to the sheer complexity of setting up a domain just for home use). But there are other interesting optional features. For example, you can create virtual machines on the DS923+ which, despite the limited CPU and RAM of the machine, can come in handy from time to time. I suppose with a more powerful box from Synology, the story here would be quite different.</p><p>One thing to highlight is that these extra pieces of software are <em>curated</em>: you aren’t just installing an extra service to the underlying Linux machine. You are installing an extension to the DSM, which comes with new configuration panels in the UI and full integration with the system. You never have to know that Linux is there if you don’t want to.</p><h1><strong>Backup solutions</strong></h1><p>Having a dedicated NAS with a storage pool that protects against corruption is great, but a singly-homed box like this is still subject to massive data loss due to ransomware, physical damage caused by fire or flooding, and correlated disk failures. Backups are critically important.</p><p>With the FreeBSD setup, my backup strategy involved using <code>zfs send</code> and <code>zfs receive</code> to back up snapshots into two USB drives: one kept in a fire safe and one kept offsite. This worked but I had to figure out the syntax of these commands over and over again, which didn’t make me feel confident about these actions. I did also back up irreplaceable data to a OneDrive account using <code>rclone</code>, which was good but… manual and ad-hoc as well. Needless to say, while the backups existed, they were often stale and they were a pain to manage.</p><p>Backing up a NAS is difficult though. For one, a NAS is designed to store <em>lots</em> of data, which means the backup targets have to be large capacity-wise too. And for another, given the DS923+ reduced physical size, it is likely to end up placed in a location that isn’t super convenient to access, which will make attaching temporary USB drives and the like an annoying experience.</p><p>For now, what I have tried is the optional <em>Cloud Sync</em> package that allows replicating to many cloud services, including OneDrive. And it’s a joy to use. I could trivially install the package, log into my Microsoft account, and configure the two specific folders I care about backing up. I could even respect the previous file layout of my OneDrive account so I did not have to re-upload anything. And the tool supports encryption too, which you may want if you really don’t like those cloud providers from training their AI systems with your data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":779628,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Sample configuration of cloud syncing to OneDrive.</figcaption></figure></div><p>There is more though. Synology offers a variety of products for remote and physical backup. The one that does interest me the most is <a href=\"https://www.synology.com/en-global/dsm/feature/snapshot_replication\">Snapshot Replication</a>, which provides something similar to what I was doing with <code>zfs send</code> and <code>zfs receive</code>, but unfortunately requires a second Synology system offsite that I don’t have. The other solutions are <a href=\"https://sy.to/hf5yf\">Active Backup for Business</a> and <a href=\"https://sy.to/tntsi\">Hyper Backup</a>, which I still would like to evaluate but haven’t had a chance to look into.</p><h1><strong>Future</strong></h1><p>To conclude this brief review and comparison, let me say that I’m happy with the DS923+ experience so far. I don’t think I <em>need</em> it because my FreeBSD solution worked well enough, but considering that I like to use the ThinkStation as the host for my VMs and as my primary development machine—aka, a fun toy—I feel more at peace with a dedicated appliance that stores my precious data.</p><p>For more details, you can visit Synology’s product pages for the <a href=\"https://sy.to/hekgh\">DS923+</a> and the <a href=\"https://sy.to/drkom\">Plus Series HDDs</a>. And if you want to roll your own FreeBSD-based solution, <a href=\"https://docs.freebsd.org/en/books/handbook/zfs/\">Chapter 22 of the FreeBSD handbook on ZFS</a> is a good place to start.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "0.0" "image/jpeg") nil "9dd6bbc63f327d457f4f7db5298e48c3") (39 (26624 38279 257829 111000) "https://blogsystem5.substack.com/p/demystifying-secure-nfs" "Demystifying secure NFS" "Julio Merino" "Mon, 04 Nov 2024 00:00:13 +0000" "<p>I recently got a <a href=\"https://sy.to/hekgh\">Synology DS923+</a> for evaluation purposes which led me to setting up NFSv4 with Kerberos. I had done this about a year ago with FreeBSD as the host, and going through this process once again reminded me of how painful it is to secure an NFS connection.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":232646,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><p>You see, Samba is much easier to set up, but because NFS is the native file sharing protocol of Unix systems, I felt compelled to use it instead. However, if you opt for NFSv3 (the “easy default”), you are left with a system that has zero security: traffic travels unencrypted and unsigned, and the server trusts the client when the client asserts who is who. Madness for today’s standards. Yet, when you look around, people say “oh, but NFSv3 is fine if you trust the network!” But seriously, who trusts the network in this day and age?</p><p>You have to turn to NFSv4 <em>and</em> combine it with Kerberos for a secure file sharing option. And let me tell you: the experience of setting these up and getting things to work is horrible, and the documentation out there is terrible. Most documents are operating-system specific so they only tell you what works when a specific server and a specific client talk to each other. Other documents just <em>assume</em>, and thus omit, various important details of the configuration.</p><p>So. This article is my recollection of “lab notes” on how to set this whole thing up along with the necessary background to understand NFSv4 and Kerberos. My specific setup involes the Synology DS923+ as the NFSv4 server; Fedora, Debian, and FreeBSD clients; and the supporting KDC on a pfSense (or FreeBSD) box.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">An upcoming article will compare the Synology NAS against my home-built FreeBSD-based NAS. Subscribe now to get it!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>NFSv3’s insecurity</h1><p>NFSv3, or usually just NFS, is a protocol from the 1980s—and it shows. In broad terms, NFSv3 exposes the <em>inodes</em> of the underlying file system to the network. This became clear to me when I implemented <a href=\"https://jmmv.dev/software/tmpfs.html\">tmpfs for NetBSD</a> in 2005 and realized that a subset of the APIs I had to support were in service of NFS. This was… a mind-blowing realization. <em>“Why would tmpfs, a memory file system, need NFS-specific glue?”</em>, I thought, and then I learned the bad stuff.</p><p>Anyhow. Now that you know that NFSv3 exposes inodes, you may understand why sharing a directory over NFSv3 is an all-or-nothing option for <em>the whole file system</em>. Even if you can configure <code>mountd</code> to export a single directory via <code>/etc/exports</code>, malicious clients can craft NFS RPCs that reference inodes outside of the shared directory. Which means… they get free access to the whole file system and explains why system administrators used to put NFS-exported shares in separate partitions, mounted under <code>/export/</code>, in an attempt to isolate access to subsets of data.</p><p>To make things worse, NFSv3 has no concept of security. A client can simply assert that a request comes from UID 1000 and the server will <em>trust</em> that the client is really operating on behalf of the server’s UID 1000. Which means: a malicious client can pretend to be <em>any</em> user that exists on the server and gain access to <em>any</em> file in the exported file system. Which then explains why the <code>maproot</code> option exists as an attempt to avoid impersonating root… but only root. Crazy talk.</p><p>All in all, NFSv3 may still be OK if you really trust the network, if you compartmentalize the exported file system, and if you are sharing inconsequential stuff. But can <em>you</em> trust the network? Maybe you can if you are using a P2P link, but otherwise… it is really, really risky and I do not want to do that.</p><h1>How is NFSv4 better?</h1><p>NFSv4, despite having the same NFS name as NFSv3, is a completely different protocol. Here are two main differences:</p><ul><li><p><strong>NFSv4 operates on the basis of usernames, not UIDs.</strong> Each request to the server contains a username and the server is responsible for translating that username to a local UID while verifying access permissions.</p></li><li><p><strong>NFSv4 operates at the path level, not the inode level.</strong> Each request to the server contains the path of the file to operate on and thus the server can apply access control based on those.</p></li></ul><p>Take these two differences together and NFSv4 can implement secure access to file systems. Because the server sees usernames and paths, the server can first verify that a user is who they claim to be. And because the server can authenticate users, it can then authorize accesses at the path level.</p><p>That said, if all you have is NFSv4, you only get the <code>AUTH_SYS</code> security level, which is… the same as having no security at all. In this mode, the server trusts the client and assumes that user X on the client maps exactly to user X on the server, which is almost the same as NFSv3 did.</p><p>The real security features of NFSv4 come into play when it’s paired with Kerberos. When Kerberos is in the picture, you get to choose from the following security levels for each network share:</p><ul><li><p><code>krb5</code>: Requires requests to be authenticated by Kerberos, which is good to ensure only trusted users access what they should but offers zero “on-the-wire” security. Traffic flows unsigned and unencrypted, so an attacker could tamper with the data and slurp it before it reaches the client.</p></li><li><p><code>krb5i</code>: Builds on <code>krb5</code> to offer integrity checks on all data. Basically, all packets on the network are signed but not encrypted. This prevents spoofing packets but does not secure the data against prying eyes.</p></li><li><p><code>krb5p</code>: Builds on <code>krb5</code> to offer encrypted data on the wire. This prevents tampering with the network traffic and also avoids anyone from seeing what’s being transferred.</p></li></ul><p>Sounds good? Yeah, but unfortunately, Kerberos and its ecosystem are… complicated.</p><h1>Kerberos 101</h1><p>Kerberos is an authentication broker. Its goal is to detach authentication decisions between a client machine and a service running on a second machine, and move that responsibility to a third machine—the Kerberos Domain Controller (KDC). Consequently, the KDC is a trusted entity between the two machines that try to communicate with each other.</p><p>All the machines that interact with the KDC form a <em>realm</em> (AKA a <em>domain</em>, but not a DNS domain). Each machine needs an <code>/etc/krb5.conf</code> file that describes which realms the machine belongs to and who the KDC for each realm is.</p><p>The actors that exist within the realm are the <em>principals</em>. The KDC maintains the authoritative list of principals and their authentication keys (passwords). These principals represent:</p><ul><li><p><strong>Users</strong>, which have names of the form <code><username>@REALM</code>. There has to be one of these principals for every person (or role) that interacts with the system.</p></li><li><p><strong>Machines</strong>, which have names of the form <code>host/<machine>.<domain>@REALM</code>. There has to be one of these principals for every server, and, depending on the service, the clients may need one too as is the case for NFSv4.</p></li><li><p><strong>Services</strong>, which have names of the form <code><service>/<machine>.<domain>@REALM</code>. Some services like NFSv4 require one of these, in which case <code><service></code> is <code>nfs</code>, but others like SSH do not.</p></li></ul><p>Let’s say Alice wants to log into the Kerberos-protected SSH service running on SshServer from a client called LinuxLaptop, all within the <code>EXAMPLE.ORG</code> Kerberos realm.</p><p><em>(Beware that the description below is not 100% accurate. My goal is for you to understand the main concepts so that you can operate a Kerberos realm.)</em></p><p>First, Alice needs to obtain a Ticket-Granting-Ticket (TGT) if she doesn’t have a valid one yet. This ticket is issued by the KDC after authenticating Alice with her password, and allows Alice to later obtain service-specific tickets without having to provide her password again. For this flow:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/df16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":128347,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Steps involved in obtaining a TGT from the KDC for a user on a client machine.</figcaption></figure></div><ol><li><p>Alice issues a login request to the KDC from the client LinuxLaptop by typing <code>kinit</code> (or using other tools such as a PAM module). This request carries Alice’s password.</p></li><li><p>The KDC validates Alice’s authenticity by checking her password against the KDC’s database and issues a TGT. The TGT is encrypted with the KDC’s key and includes an assertion of who Alice is and how long the ticket is valid for.</p></li><li><p>The client LinuxLaptop stores the TGT on disk. Alice can issue <code>klist</code> to see the ticket:</p></li></ol><pre><code><code>linux-laptop$ klist
Credentials cache: FILE:/tmp/krb5cc_1001
Principal: alice@EXAMPLE.ORG
Issued                Expires               Principal
Oct 26 09:04:57 2024  Oct 26 19:05:01 2024  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG
linux-laptop$ █</code></code></pre><p>The TGT, however, is not sufficient to access a service. When Alice wants to access the Kerberos-protected SSH service running on the SshServer machine, Alice needs a ticket that’s specific to that service. For this flow:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/b64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":146323,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Steps involved in obtaining a service-specific ticket from the KDC for a user on a client machine.</figcaption></figure></div><ol><li><p>Alice sends a request to the Ticket-Granting-Service (KDS) and asks for a ticket to SshServer. This request carries the TGT.</p></li><li><p>The TGS (which lives in the KDC) verifies who the TGT belongs to and verifies that it’s still valid. If so, the TGS generates a ticket for the service. This ticket is encrypted with the service’s secret key and includes details on who Alice is and how long the ticket is valid for.</p></li><li><p>The client LinuxLaptop stores the service ticket on disk. As before, Alice can issue <code>klist</code> to see the ticket:</p></li></ol><pre><code><code>linux-laptop$ klist
Credentials cache: FILE:/tmp/krb5cc_1001
Principal: alice@EXAMPLE.ORG
Issued                Expires               Principal
Oct 26 09:04:57 2024  Oct 26 19:05:01 2024  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG
Oct 26 09:05:11 2024  Oct 26 19:05:01 2024  host/ssh-server.example.org@EXAMPLE.ORG
linux-laptop$ █</code></code></pre><p>At this point, all prerequisite Kerberos flows have taken place. Alice can now initiate the connection to the SSH service:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":151288,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Accessing a remote SSH server using a Kerberos ticket without password authentication.</figcaption></figure></div><ol><li><p>Alice sends the login request from the LinuxLaptop client to the SshServer server and presents the service/host-specific ticket that was granted to her earlier on.</p></li><li><p>The SshServer server decrypts the ticket with its own key, extracts details of who the request is from, and verifies that they are correct. This happens <em>without talking to the KDC</em> and is only possible because SshServer trusts the KDC via a pre-shared key.</p></li><li><p>The SSH service on SshServer decides if Alice has SSH access as requested and, if so, grants such access.</p></li></ol><p>Note these very important details:</p><ul><li><p><strong>The KDC is only involved in the ticket issuance process.</strong> Once the client has a service ticket, all interactions between the client and the server happen <em>without</em> talking to the KDC. This is essential to not make the KDC a bottleneck in the communication.</p></li><li><p><strong>Each host/service and the KDC have unique shared keys that are known by both the host/service and the KDC.</strong> These shared keys are created when registering the host or service principals and are copied to the corresponding machines as part of their initial setup. These keys live in machine-specific <code>/etc/krb5.keytab</code> files.</p></li><li><p><strong>Kerberos does authentication only, not authorization.</strong> The decision to grant Alice access to the SSH service in Think is made by the service itself, not Kerberos, after asserting that Alice is truly Alice.</p></li></ul><p>As you can imagine, the KDC must be protected with the utmost security measures. If an attacker can compromise the KDC’s locally-stored database, they will get access to all shared keys so they can impersonate any user against any Kerberos-protected service in the network. That’s why attackers try to breach into an Active Directory (AD) service as soon as they infiltrate a Microsoft network because… AD <em>is</em> a KDC.</p><h1>Setting up the KDC</h1><p>Enough theory. Let’s get our hands dirty and follow the necessary steps to set up a KDC.</p><p>The KDC’s needs are really modest. Per the discussion above, the KDC isn’t in the hot data path of any service so the number of requests it receives are limited. Those requests are not particularly complex to serve either: at most, there is some CPU time to process cryptographic material but no I/O involved, so for a small network, any machine will do.</p><p>In my particular case, I set up the KDC in my little pfSense box as it is guaranteed to be almost-always online. This is probably not the best of ideas security-wise, but… it’s sufficient for my paranoia levels. Note that most of the steps below will work similarly on a FreeBSD box, but if you are attempting that, please go read <a href=\"https://docs.freebsd.org/en/books/handbook/security/#kerberos5\">FreeBSD’s official docs on the topic</a> instead. Those docs are one of the few decent guides on Kerberos out there.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":359967,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">The pfSense little box that I run the KDC on.</figcaption></figure></div><p>Here are the actors that will appear throughout the rest of this article. I’m using the real names of my setup here because, once again, these are my lab notes:</p><ul><li><p><code>MEROH.NET</code>: The name of the Kerberos realm.</p></li><li><p><code>jmmv</code>: The user on the client machine wanting access to the NFSv4 share. The UID is irrelevant.</p></li><li><p><code>router.meroh.net</code>: The pfSense box running the KDC.</p></li><li><p><code>nas.meroh.net</code>: The Synology DS923+ NAS acting as the NFSv4 server.</p></li><li><p><code>think.meroh.net</code>: A FreeBSD machine that will act as a Kerberized SSH server for testing purposes and an NFSv4 client. (It’s a ThinkStation, hence its name.)</p></li><li><p><code>x1nano.meroh.net</code>: A Linux machine that will act as an NFSv4 client. While in reality this is running Fedora, I’ll use this hostname interchangeably for Fedora and Debian.</p></li></ul><p>Knowing all actors, we can set up the KDC. The first step is to create the <code>krb5.conf</code> for the KDC which tells the system which realm the machine belongs to. You’ll have to open up SSH access to the machine via the web interface to perform these steps.</p><p>Here is the minimum content you need:</p><pre><code><code>[libdefaults]
default_realm = MEROH.NET
[realms]
MEROH.NET = {
kdc = router.meroh.net
admin_server = router.meroh.net
}
[domain_realm]
.meroh.net = MEROH.NET</code></code></pre><p>With that, you should be able to start the <code>kdc</code> service, which is responsible for the KDC. All documentation you find out there will tell you to also start <code>kadmind</code>, but if you don’t plan to do administer the KDC from another machine (why would you?), then you don’t need this service.</p><p>pfSense’s configuration is weird because of the read-only nature of its root partition, so to do this, you have to edit the <code>/cf/conf/config.xml</code> file stored in NVRAM and add this line right before the closing <code></system></code> tag:</p><pre><code><code><shellcmd>service kdc start</shellcmd></code></code></pre><p>If you were to set this up on a FreeBSD host instead of pfSense, you would modify <code>/etc/rc.conf</code> instead and add:</p><pre><code><code>kdc_enable=YES</code></code></pre><p>Then, from the root shell on either case:</p><pre><code><code>kdc# service kdc start
kdc# █</code></code></pre><p>It is now a good time to ensure that every machine involved in the realm has a DNS record and that reverse DNS lookups work. Failure to do this will cause problems later on when attempting to mount the NFSv4 shares, and clearing those errors won’t be trivial because of caching at various levels.</p><h1>Creating principals</h1><p>Once the KDC is running, we must create principals for the hosts, the NFSv4 service, and the users that will be part of the realm. The client host and service principals aren’t always necessary though: SSH doesn’t require them, but NFSv4 does.</p><p>To create the principals, we need access the KDC’s administrative console. Given that the KDC isn’t configured yet, we can only gain such access by running <code>kadmin -l</code> on the KDC machine directly (the pfSense shell), which bypasses the networked <code>kadmind</code> service that we did not start.</p><p>Start <code>kadmin -l</code> and initialize the realm:</p><pre><code><code>kdc# kadmin -l
kadmin> init MEROH.NET
... answer questions with defaults ...
kadmin> █</code></code></pre><p>Next, create principals for the <em>users</em> that will be part of the realm:</p><pre><code><code>kadmin> add jmmv
... answer questions with defaults ...
... but enter the desired user password ...
kadmin> █</code></code></pre><p>Then, create principals for the <em>hosts</em> (server and clients, but not the KDC) and the NFSv4 <em>service</em>:</p><pre><code><code>kadmin> add --random-key host/think.meroh.net
... answer questions with defaults ...
kadmin> add --random-key host/x1nano.meroh.net
... answer questions with defaults ...
kadmin> add --random-key host/nas.meroh.net
... answer questions with defaults ...
kadmin> add --random-key nfs/nas.meroh.net
... answer questions with defaults ...
kadmin> █</code></code></pre><p>And finally, extract the host and service credentials into the machine-specific keytab files. Note that, for the servers, we extract both the host and any service principals they need, but for the client, we just extract the host principal. We do not export any user principals:</p><pre><code><code>kadmin> ext_keytab --keytab=think.keytab host/think.meroh.net
kadmin> ext_keytab --keytab=x1nano.keytab host/x1nano.meroh.net
kadmin> ext_keytab --keytab=nas.keytab host/nas.meroh.net nfs/nas.meroh.net
kadmin> █</code></code></pre><p>You now need to copy each extracted keytab file to the corresponding machine and name it <code>/etc/krb5.keytab</code>. (We’ll do this later on the Synology NAS via its web interface.) This file is what contains the shared key between the KDC and the host and is what allows the host to verify the authenticity of KDC tickets without having to contact the KDC. Make sure to protect it with <code>chmod 400 /etc/krb5.keytab</code> so that nobody other than root can read it.</p><p>If <code>scp</code> is unsuitable or hard to use from the KDC to the client machines (as is my case because I restrict SSH access to the KDC to one specific machine), you can use the <code>base64</code> command to print out a textual representation of the keytab and use the local clipboard to carry it to a shell session on the destination machine.</p><h1>Initial client setup</h1><p>At this point, the realm should be functional but we need to make the clients become part of the realm. We also need to install all necessary tools, like <code>kinit</code>, which aren’t present by default on some systems:</p><ul><li><p>On Debian:</p><ul><li><p>Run <code>apt install krb5-user nfs-common</code>.</p></li><li><p>Follow the prompts that the <code>krb5-user</code> installer shows to configure the realm and the address of the KDC. This will auto-create <code>/etc/krb5.conf</code> with the right contents so you don’t have to do anything else.</p></li></ul></li><li><p>On Fedora:</p><ul><li><p>Run <code>dnf install krb5-workstation</code>.</p></li><li><p>Edit the system-provided <code>/etc/krb5.conf</code> file to register the realm and its settings. Use the file content shown above for the KDC as the template, or simply replace all placeholders for <code>example.org</code> and <code>EXAMPLE.ORG</code> with the name of your DNS domain and realm.</p></li></ul></li><li><p>On FreeBSD:</p><ul><li><p>Create the <code>/etc/krb5.conf</code> file from scratch in the same way we did for the KDC.</p></li></ul></li></ul><p>All set! But… do you trust that you did the right thing everywhere? We could go straight into NFSv4, but due to the many pitfalls in its setup, I’d suggest you verify your configuration using a simpler service like SSH.</p><p>To do this, modify the SSH server’s (aka <code>think</code>’s configuration) <code>/etc/ssh/sshd_config</code> file and add <code>GSSAPIAuthentication yes</code> so that it can leverage Kerberos for authentication. Restart the SSH service and give it a go: run <code>kinit</code> on the client (<code>x1nano</code>) and then see how <code>ssh think</code> works without typing a password anymore.</p><p>But… <code>GSSAPIAuthentication</code>? What’s up with the cryptic name?</p><p>GSS-API stands for <em>Generic Security Services API</em> and is the interface that programs use to communicate with the Kerberos implementation on the machine. GSS-API is not always enabled by default for a service, and the way you enable it is service-dependent. As you saw above, all we had to do for SSH was modify the <code>sshd_config</code> file… but for other services, you may need to take extra steps on the server and/or the client.</p><p>And, guess what, NFSv4 is weird on this topic. Not only we need service-specific principals for NFS, but we also need the <code>gssd</code> <em>daemon</em> to be running on the server <em>and</em> the client machines. This is because NFSv4 is typically implemented inside the kernel, but not Kerberos, so the kernel needs a mechanism to “call into” Kerberos. And the kernel needs to do this to map kernel-level UIDs (a Unix kernel doesn’t know anything about <em>usernames</em>) to Kerberos principals and vice-versa—and that’s precisely what <code>gssd</code> offers. So:</p><ul><li><p>On the Synology NAS:</p><ul><li><p>Do nothing. The system handles <code>gssd</code> by itself.</p></li></ul></li><li><p>On Linux:</p><ul><li><p>You shouldn’t have to do anything if you correctly created the prerequisite <code>/etc/krb5.keytab</code> early enough, but make sure the service is running with <code>systemctl status rpc-gssd.service</code> (and know that this command only shows useful diagnostic logs when run as root).</p></li><li><p>Run <code>systemctl start rpc-gssd.service</code> if the service isn’t running.</p></li></ul></li><li><p>On FreeBSD:</p><ul><li><p>Add <code>gssd_enable=YES</code> to <code>/etc/rc.conf</code>.</p></li><li><p>Run <code>service gssd start</code>.</p></li></ul></li></ul><h1>Exporting NFSv4 services</h1><p>It’s time to deal with NFSv4, so let’s start by configuring the server on the NAS.</p><p>The Synology Disk Station Manager (DSM) interface—the web UI for the NAS—is… interesting. As you might expect, it is a web-based interface but… it pretends to be a desktop environment in the browser, which I find overkill and unnecessary. But it’s rather cool in its own way.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\" width=\"728\" height=\"455\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\",\"srcNoWatermark\":null,\"fullscreen\":false,\"imageSize\":\"normal\",\"height\":910,\"width\":1456,\"resizeWidth\":728,\"bytes\":1000728,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Navigating the Synology DSM menus to configure the NFS file service with Kerberos.</figcaption></figure></div><p>The first step is to enable the NFS service. Roughly follow these steps, which are illustrated in the picture just above:</p><ul><li><p>Open the <strong>File Services</strong> tab of the <strong>Control Panel</strong>.</p></li><li><p>In the <strong>NFS</strong> tab, set NFSv4 as the <strong>Minimum NFS protocol</strong>.</p></li><li><p>Click on <strong>Advanced Settings</strong> and, in the panel that opens, enter the Kerberos realm under the <strong>NFSv4 domain</strong> option.</p></li><li><p>Click on <strong>Kerberos Settings</strong> and, in the panel that opens, select <strong>Import</strong> and then upload the keytab file that we generated earlier on for the NAS. This should populate the <code>host</code> and <code>nfs</code> principals in the list.</p></li><li><p>Finish and save all settings.</p></li></ul><p>That should be all to enable NFSv4 file serving.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\" width=\"1456\" height=\"910\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":910,\"width\":1456,\"resizeWidth\":null,\"bytes\":1307597,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Navigating the Synology DSM menus to configure the properties of a single shared folder over NFS.</figcaption></figure></div><p>Then, we need to expose shared folders over NFSv4, and we have to do this for every folder we want to share. Assuming you want to share the <code>homes</code> folder as shown in the picture just above:</p><ul><li><p>Open the <strong>Shared Folder</strong> tab of the <strong>Control Panel</strong>.</p></li><li><p>Select the folder you want to share (in our case, <code>homes</code>), and click <strong>Edit</strong>.</p></li><li><p>In the <strong>NFS Permissions</strong> tab, click either <strong>Create</strong> or <strong>Edit</strong> to enter the permissions for every host client that should have access to the share.</p></li><li><p>Fill the NFS rule details. In particular, enter the hostname of the client machine, enable the <strong>Allow connections from non-privileged ports</strong> option, and select the <strong>Security</strong> level you desire.</p></li></ul><p>In my case, I want <code>krb5p</code> and <code>krb5p</code> only so that’s the only option I enable. But your risk profile and performance needs may be different, so experiment and see what works best for you.</p><h1>Mounting NFSv4 from Linux</h1><p>Now that the server is ready and we have dealt with the GSS-API prerequisites, we can start mounting NFSv4 on the clients.</p><p>On Linux, things are pretty simple. We can mount the file system with:</p><pre><code><code>x1nano# sudo mount nas:/volume1/homes /shared
x1nano# █</code></code></pre><p>Or persist the entry in <code>/etc/fstab</code> if we want to:</p><pre><code><code>nas:/volume1/homes /shared nfs sec=krb5p 0 0</code></code></pre><p>And then we should be able to list its contents <em>assuming we’ve got a valid TGT for the current user</em> (run <code>kinit</code> if it doesn’t work):</p><pre><code><code>x1nano$ ls -l /shared
total 0K
drwxrwxrwx 1 nobody users 0 Sep 27 21:11 admin
drwxrwxrwx 1 jmmv   users 0 Nov  2 20:41 jmmv
drwxrwxrwx 1 nobody users 0 Oct  8 16:59 manager
x1nano$ █</code></code></pre><p>Easy peasy, right? But wait… why do all directories have <code>777</code> permissions?</p><p>This is rather unfortunate and I’m not sure why the Synology does this. Logging onto the DS923+ via SSH, I inspected the shared directory and realized that it has various ACLs in place to control access to the directories, but somehow, the traditional Unix permissions are all <code>777</code> indeed. Not great.</p><p>I used <code>chmod</code> to fix the permissions for all directories to <code>755</code> and things seem to be OK, but that doesn’t give me a lot of comfort because I do not know if the DSM will ever undo my changes or if I might have broken something.</p><p>There might be one more problem though, which I did not encounter on Debian clients but that showed up later in Fedora and FreeBSD clients:</p><pre><code><code>x1nano$ ls -l /shared
total 0K
drwxr-xr-x 1 nobody nogroup 0 Sep 27 21:11 admin
drwxr-xr-x 1 nobody nogroup 0 Nov  2 20:41 jmmv
drwxr-xr-x 1 nobody nogroup 0 Oct  8 16:59 manager
x1nano$ █</code></code></pre><p>Note how all entries are owned by <code>nobody:nogroup</code> which is… not correct. Yet the right permissions are in effect: accessing the <code>jmmv</code> directory is only possible by the <code>jmmv</code> user as expected. Which means that the user mapping between Kerberos principals and local users is working correctly on the server… but not on the client, where <code>stat</code> isn’t returning the right information.</p><p>I do not yet know why this issue happens, especially because I see no material differences between my Fedora and Debian configurations.</p><h1>Mounting NFSv4 from FreeBSD</h1><p>We now have the Linux clients running just fine so it is time to pivot to FreeBSD. If we try a similar “trivial” mount command, we get an error:</p><pre><code><code>think# mount -t nfs nas:/volume1/homes /shared
mount_nfs: nmount: /shared: Permission denied
think# █</code></code></pre><p>The error is pretty… unspecific. It took me quite a bit of trial and error to realize that I <em>had</em> to specify <code>-t nfsv4</code> for it to attempt a NFSv4 connection and not NFSv3 (unlike Linux, whose <code>mount</code> command attempts the highest possible version first and then falls back to older versions):</p><pre><code><code>think# mount -t nfs -o nfsv4 nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
think# █</code></code></pre><p>OK, progress. Now this complains that the security flavor we request is wrong. Maybe we just need to be explicit and also pass <code>sec=krb5p</code> as an argument:</p><pre><code><code>think# mount -t nfs -o nfsv4,sec=krb5p nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
think# █</code></code></pre><p>Wait, what? The mount operation still fails? This was more puzzling and also took a fair bit of research to figure out because logs on the client and on the server were just insufficient to see the problem.</p><p>The reason for the failure is that we are trying to mount the share as root but… we don’t have a principal for this user so root cannot obtain an NFSv4 service ticket to contact the NAS. So… do we need to create a principal for <code>root</code>? No! We do not need to provide user credentials when mounting an NFSv4 share (unlike what you might be used to with Windows shares).</p><p>What Kerberized NFSv4 needs during the mount operation is a host ticket: the NFSv4 server checks if the client <em>machine</em> is allowed to access the server and, if so, exposes the file system to it. This is done using the client’s host principal. Once the file system is mounted, however, all operations against the share carry the ticket of the <em>user</em> requesting the operation.</p><p>Knowing this, we need to “help” FreeBSD and tell it that it must use the host’s principal when mounting the share. Why this isn’t the default, I don’t know, particularly because non-root users are not allowed to mount file systems in the default configuration. Anyhow. The <code>gssname=host</code> option rescues us:</p><pre><code><code>think# mount -t nfs -o nfsv4,sec=krb5p,gssname=host nas:/volume1/homes /shared
think# █</code></code></pre><p>Which finally allows the mount operation to succeed. We should persist all this knowledge into an <code>/etc/fstab</code> entry like this one:</p><pre><code><code>nas:/volume1/homes /shared nfs rw,nfsv4,gssname=host,sec=krb5p 0 0</code></code></pre><h1>Verifying encryption</h1><p>Color me skeptical, but everything I described above seems convoluted and fragile, so I did not trust that my setup was sound. Consequently, I wanted to verify that the traffic on the network was actually encrypted.</p><p>To verify this, I installed Wireshark and ran a traffic capture against the NAS with <code>host nas</code> as the filter. Then, from the client, I created a text file on the shared folder and then read it. Inspecting the captured packets confirmed that the traffic is indeed flowing in encrypted form. I could not find the raw file content anywhere in the whole trace (but I could when using anything other than <code>krb5p</code>).</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\" width=\"1456\" height=\"960\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":960,\"width\":1456,\"resizeWidth\":null,\"bytes\":459416,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"></div></div></a><figcaption class=\"image-caption\">Content of an NFS reply packet with Kerberos-based encryption. The packet contents are not plain text.</figcaption></figure></div><p>And, as a final test, I tried to mount the network share <em>without</em> <code>krb5p</code> and confirmed that this was not possible:</p><pre><code><code># mount -t nfs -o nfsv4,gssname=host,sec=krb5i nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
# █</code></code></pre><p>All good! I think…</p><h1>Open questions</h1><p>That’s about it. But I still have a bunch of unanswered questions from this setup:</p><ul><li><p>Kerberos claims to be an authentication system only, not an authorization system. However, the protocol I described above separates the TGT from the TGS, and this separation makes it sound like Kerberos could also implement authorization policies. Why doesn’t it do these?</p></li><li><p>The fact that Fedora and FreeBSD show <code>nobody</code> for file ownership even when they seems to do the right thing when talking to the NFSv4 server sound like a bug either in the code or in my configuration. Which is it?</p></li><li><p>Having to type <code>kinit</code> after logging into the machine is annoying. I remember that, back at Google when we used Kerberos and NFS—those are long gone days—the right tickets would be granted after logging in or unlocking a workstation. This must have been done with the Kerberos PAM modules… but I haven’t gotten them to do this yet and I’m not sure why.</p></li><li><p>The fact that the shared directories created by the Synology NAS have 777 permissions seems wrong. Why is it doing that? And does anything break if you manually tighten these permissions?</p></li><li><p>And the most important question of all: <strong>is this all worth it?</strong> I’m tempted to just use password-protected Samba shares and call it a day. I still don't trust that the setup is correct, and I still encounter occasional problems here and there.</p></li></ul><p>If you happen to have answers to any of the above or have further thoughts, please drop a note in the comments section. And…</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you want to see how the DS923+ compares to my home-built FreeBSD NAS with ZFS, subscribe for a future post on that!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Credit and disclaimers: the <a href=\"https://sy.to/hekgh\">DS923+</a> and <a href=\"https://sy.to/drkom\">the 3 drives</a> it contains that I used for throughout this article were provided to me for free by Synology for evaluation purposes in exchange for blogging about the NAS. The content in this article is <em>not</em> endorsed has <em>not</em> been reviewed by them.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg" "0.0" "image/jpeg") nil "614b01796e096d0ca90350ad0e55ce4b") (38 (26624 38279 254839 905000) "https://blogsystem5.substack.com/p/bazelcon-2024-recap" "BazelCon 2024 recap" "Julio Merino" "Tue, 22 Oct 2024 15:01:01 +0000" "<p>Just like that, BazelCon 2024 came and went. And just like that, Blog System/5 is about to turn 1 year old as the very first post of this newsletter was the <a href=\"https://blogsystem5.substack.com/p/bazelcon-2023-et-al-trip-report\">recap of BazelCon 2023</a>. Since then, this newsletter has amassed 1200+ subscribers and I have surpassed <a href=\"https://blogsystem5.substack.com/p/20-years-of-blogging\">20 years of blogging</a>—so, thank you for your support, everyone!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" width=\"1456\" height=\"1048\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1048,\"width\":1456,\"resizeWidth\":null,\"bytes\":362903,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>To celebrate this milestone, it’s obviously time to summarize the two events of last week: BazelCon 2024 and the adjacent Build Meetup. There is <em>A LOT</em> of ground to cover. I could probably write a separate article for each of the sections below, but folks coming for a summary of the conference will want to see everything in one place… so you get this massive piece instead.</p><p>Overall, this is a 40-minute read… but let’s face it: getting 3 days worth of content in less than an hour sounds like a good deal, doesn’t it? Feel free to pick and choose sections though; each stands on its own and each paragraph represents a thought I captured from some presentation or discussion.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">No LLMs were involved in this work, thus you can only imagine how much effort it went into putting this together. So, subscribe to support Blog System/5 and… enjoy!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Schedule and logistics</h1><p>BazelCon 2024 was hosted at the Computer History Museum in Mountain View, CA, on October 14th and 15h. The conference had a <a href=\"https://bazelcon2024.sched.com/\">single track of talks</a> and an overlapping track of BoF sessions. I attended most of the talks but just one BoF—the IDE one. The conference was followed by evening socials hosted by BuildBuddy and JetBrains/EngFlow.</p><p>The Build Meetup followed BazelCon 2024 on October 16th, and this time around it was cohosted by Meta and EngFlow in Menlo Park, CA. The meetup had three tracks: one for Bazel, one for Buck 2, and one for remote execution. I helped facilitate the Bazel track, including taking notes for the afternoon unconference (notes at the very end), and gave a 15-minute talk on Bazel at Snowflake. Facilitating the track was fun, but unfortunately this made me miss the Buck track and I’m still wanting to learn more about it.</p><p>The notes I gathered from the talks and discussions are grouped in the following topics:</p><ul><li><p>Community and adoption</p></li><li><p>Remote Execution</p></li><li><p>IDE support</p></li><li><p>Inner loop development</p></li><li><p>Toolchains</p></li><li><p>Sandboxing</p></li><li><p>Monorepo issues</p></li><li><p>blzmod and external dependencies</p></li><li><p>Secure and auditable builds</p></li><li><p>Symbolic macros</p></li><li><p>Queries</p></li><li><p>Linting</p></li><li><p>Testing</p></li><li><p>Missing tooling around Bazel</p></li><li><p>The end</p></li></ul><h1>Community and adoption</h1><p>The conference opened with the usual briefing and SOTU, which included information on the conference itself and the latest news in the Bazel project. These were followed by talks that touched upon the community and current adoption trends, and these are the thoughts I gathered:</p><ul><li><p><strong>Conference ownership:</strong> This was the first BazelCon <em>not</em> run by Google. The conference is now owned by the Linux Foundation and Google was a sponsor at the same level of BuildBuddy and EngFlow. The Linux Foundation has run the conference excellently thanks to the dedicated team of professionals that they have for the task.</p></li><li><p><strong>Conference history:</strong> Looking back, you should know that the Bazel team was (and still is) distributed across two sites: Google NYC and Google Munich. To mitigate the difficulties that arise from geographical distribution, the team held internal-only summits every 6 months. It wasn’t until 2017 that this internal conference became BazelCon and, after that, the team alternated between an internal event and an external event. Last year, BazelCon had 250 attendees with a waitlist that contained 200 extra folks, and this is the second year that the program committee contains non-Google folks (myself included).</p></li><li><p><strong>Google’s investment in Bazel:</strong> Does this shift to the Linux Foundation change <a href=\"https://bazel.build/contribute/policy\">Bazel’s governance</a> to make it more community-driven? Not yet, but it’s a step in that direction! Google still owns Bazel and continues to invest in it because they can leverage contributions from strong non-Google engineers and because Google maintains a bunch of open-source projects that rely on Bazel. But Google also wants to have a more open community to guarantee that Bazel continues to thrive even if company-internal priorities change.</p></li><li><p><strong>The <a href=\"https://github.com/bazel-contrib\">bazel-contrib organization</a>:</strong> To support these changes, a few folks have created a new GitHub organization and have gotten Google to donate many repos to this new org. The organization creators have a desire to start a new foundation to support and direct these projects and are looking for about 5 companies to join.</p></li><li><p><strong>Bazel adoption stickiness:</strong> The REBELs research group at the <a href=\"https://rebels.cs.uwaterloo.ca/\">Univesity of Waterloo</a> conducted a study over <a href=\"https://is.gd/WorldOfCode/\">35,000 significant GitHub projects</a> to see why, from the 1.5% of projects that adopted Bazel, 11% of those abandoned the migration at roughly the 2-year mark.</p><ul><li><p><strong>Abandonment reasons:</strong> The reasons cited for abandoning Bazel were varied, but can be summarized as encountering technical challenges, issues with team coordination and onboarding, and seeing community trends (like Kubernetes deciding to move off of Bazel).</p></li><li><p><strong>If not Bazel, then what?:</strong> These projects primarily decided to move to language-specific tools, especially for languages with strong native tooling like Go and Swift. However, a significant proportion also decided to move back to “inferior” tools like CMake or even GNU Make. These projects acknowledged that these tools are less feature rich and don’t support integration with other languages, but they are conventional and easier to understand by the community.</p></li><li><p><strong>If Bazel, then why?:</strong> On the plus side, for the cases where Bazel stuck, we can find the reasons we expect: dependency management, faster builds, and even the influence of other projects shine as reasons for making Bazel a good choice.</p></li></ul></li><li><p><strong>Adoption suggestions:</strong> The CTO of Ergatta spoke on how his small company has been able to successfully leverage Bazel without massive investments in infrastructure. His suggestions were to keep things simple (e.g. by using the GCS-backed cache despite its flaws, or by doing the trivial <code>bazel test ...</code> on CI); to expedite solutions even if not perfect (e.g. by wrapping foreign builds in Bazel); to look for champions and leverage them for adoption; to focus on “good enough” results; to write documentation for your successors; and, surprisingly, to do frequent and incremental changes to workflows instead of big-bang “improvements”.</p></li></ul><h1>Remote Execution</h1><p>As you know, remote execution is Bazel’s raison d’etre. Consequently, the SOTU covered various updates on this topic and many talks included related thoughts:</p><ul><li><p><strong>SOTU updates:</strong> The remote output service is now available and bb-clientd offers an implementation. The execution log is now 100x smaller than before and only has a 3% runtime overhead, which is useful to debug cache hits. Upcoming changes include concurrent uploads to the cache in the background without blocking action completion, GCing of local caches (disk cache, install cache, etc.), and BwoB improvements to decrease incremental build times when Skymeld is in use.</p></li><li><p><strong>Remote persistent workers:</strong> AirBnB observed 2x slower builds when not using remote persistent workers. They use dedicated pools for Java and Kotlin and route all actions into these pools, and reminded us that tagging targets comes with pitfalls because targets can spawn multiple actions and just one of them needs the worker.</p></li><li><p><strong>Queuing control:</strong> Remote execution environments typically have different worker pools to support different build environments or to optimize cost. But note: the goal shouldn’t always be to tolerate all possible load all the time: it is reasonable to put limits on the worker pools like AirBnB does so that you can dedicate a pool for interactive builds and prioritize low latency, but also create a separate pool for CI builds where you put hard caps and tolerate queuing.</p></li><li><p><strong>Target size matters:</strong> Dealing with tons of individual small files is costly. In some cases, you may be better off tarring them up and declaring a single input to an action and making the action unpack the tar during execution. This came up during the talk on high performance builds for web monorepos, and I found this interesting because this goes in the opposite direction of tree artifacts which have often been problematic.</p></li><li><p><strong>Action deduplication:</strong> Any remote execution service worth its money can coalesce in-flight actions to save on cost. This shines in CI with builds that have long-running actions, and Canva reports that they see 500k dedups per day on about 3 webpack builds. One consideration is that flaky test passes/failures are amplified by action coalescing: without this feature, flakes will show up as random failures over time, whereas with this feature, failures will be clustered. Extracting a signal around flakiness becomes harder.</p></li><li><p><strong>Determinism checks:</strong> While not necessarily an issue with remote execution, having remote execution exacerbates the problem of non-deterministic actions in a build. Spend the time to set up a CI job to <a href=\"https://www.youtube.com/watch?v=XItY0LmdiFA\">look for non-determinism</a> and alert on it. Specific problems that often arise are timestamps in JARs (<code>rules_antrl</code> is impacted), absolute paths (<code>rules_kotlin</code> is impacted), or diagnostics information (Scala <code>sdeps</code> file is problematic).</p></li><li><p><strong>Postmortems and learnings:</strong> Ulf Adams gave a talk reflecting on four different incidents that EngFlow’s remote execution service suffered. Personally, seeing companies introspect their failures makes <em>me</em> trust them <em>more</em> than not, but YMMV. In any case, I do not necessarily want to go over the incidents per se, but I do want to go over the recommendations:</p><ul><li><p><strong>Avoid RPC cycles and set timeouts:</strong> The call graph between services must not have cycles, which is hard to enforce because these may show up organically over time. Also make sure to have timeouts on all RPCs, although the RE protocol makes this difficult because it has long-running RPCs.</p></li><li><p><strong>Make sure <a href=\"https://grpc.io/docs/guides/flow-control/\">flow control</a> is configured:</strong> This is a feature of gRPC that allows a server to keep memory consumption in check and is achieved by “slowing down” incoming traffic (thus “controlling the flow”). When proxying traffic in a server, special care must be taken to connect the flow control logic of the input and output streams of the proxy. Otherwise, a slow client can have ripple effects through the system and cause OOMs.</p></li><li><p><strong>Auto-scaling is tricky to get right:</strong> From a cost-savings perspective, you want to downsize servers as quickly as possible and increase them slowly. But if you do this and there is queuing, it’s possible that auto-scaling will make queuing worse.</p></li><li><p><strong>Guardrails build trust:</strong> You might say that user-induced problems are not service problems: after all, if, for example, they cause compile actions to time out after 20 minutes, it’s “their fault” for doing the wrong thing. However, if this happens, there obviously is something wrong—and it’d be nice for the service provider to notice and have prevention features in place just like your water provider can detect leaks. (And yet… AWS <em>still</em> doesn’t have a way to put a limit on spend.)</p></li></ul></li></ul><h1>IDE support</h1><p>If you have had to support any developers converting from “legacy” build systems to Bazel, you may have realized that… the IDE features they are used to don’t quite work after the migration. Things have gotten better in the IDE space for Bazel but aren’t great yet. Fortunately, there are a few news that give hope:</p><ul><li><p><strong><a href=\"https://jb.gg/new-bazel-plugin\">New JetBrains plugin for IntelliJ</a>:</strong> Released to the marketplace during the conference, this new plugin provides tighter integration between IntelliJ and Bazel through the BSP abstraction layer. This new plugin can represent the Bazel build graph in the IDE, offers syntax highlighting for <code>bazelrc</code> files (and, feature request: could offer docs on hover), supports inserting breakpoints in Starlark evaluation, implements “fast build” correctly, and optimizes the sync process. There are some gaps compared to the old plugin, but I’m super-excited by what’s coming because the old Google-owned plugin is… underwhelming. See the <a href=\"https://jb.gg/new-bazel-feature\">feature list</a> and the <a href=\"https://jb.gg/new-bazel-roadmap\">roadmap</a> for more details.</p></li><li><p><strong>Build Server Protocol (BSP):</strong> The BSP is a new protocol that aims to achieve the same thing that the Language Server Protocol (LSP) did: namely, solve the M:N problem between IDEs and build systems. The idea is to have an intermediate abstraction for the build system so that M IDEs can talk to N build systems by means of an intermediary process that converts the BSP to build actions. The BSP is still young though and, right now, it’s pretty rigid because it has deep knowledge of the languages it supports. In particular, there is no support for custom rules yet, so get involved if you want to see this happen.</p></li><li><p><strong>Old plugin for JetBrains:</strong> The old plugin will be fully supported until mid-2025 (although I predict they’ll have to backpedal on this and extend this date). This plugin has many shortcomings because it originates from Android Studio and contains assumptions about Android and about Google’s own infrastructure. That said, there is a new feature called “query sync” that optimizes the sync process massively… at the expense of having to manually “enable analyze” for any files where deep IDE integration is desired. The problem is: you <em>have</em> to enable analysis to get insights on generated files, and generated files tend to be everywhere thanks to protobuf, so… you’ll likely find yourself “enabling analyze” all the time. Shrug.</p></li><li><p><strong>Good IDE support is critical:</strong> Having a good IDE experience is crucial for developers, but the irony is that the people that often work on build migrations or the IDE are <em>experts</em> and know how to tolerate imperfect IDE support. This is not the case for most developers, particularly those that must get up to speed… so keep that in mind. Running user interviews, surveys, etc. is a necessity to understand what people truly perceive as problems.</p></li><li><p><strong>Compilation database:</strong> JetBrains is not the only contender in the IDE space. There are many more (wink, wink, Emacs) and BSP will make offering a Bazel experience within them possible. Until that’s ready, though, you may need to manually deal with a “compilation database”, especially if you want to integrate with VSCode. A compilation database is, simply put, a JSON file that contains the commands to compile each and every translation unit in a project. There are various options to generate one of these with Bazel, all with different trade-offs:</p><ul><li><p><strong>Intercept builds:</strong> Use <code>bear</code> as a wrapper to run the full clean build. This works with some build systems, but unfortunately, Bazel’s client/server model doesn’t allow <code>bear</code> to intercept the actions it spawns.</p></li><li><p><strong>Extra actions:</strong> Add a “listener” extra action that listens for <code>CppCompile</code>. This also requires a full clean build and is deprecated by aspects, but is the approach that <code>kythe</code> uses.</p></li><li><p><strong>Action graph query:</strong> Does not require a full build, just a warmed up analysis cache. However, this does not support tree artifacts. Examples: <code>bazel-compile-commands-extractor</code>, <code>bazel-compile-commands</code> (two forks).</p></li><li><p><strong>Aspect:</strong> Does not require a full build, but the generated commands may not be identical to the ones that are actually used. For example: if you have a code generator that produces a tree artifact and then is fed as an input to a <code>cc_library</code>, then the tree artifact is represented as a <code>CppCompileActionTemplate</code> that is only expanded to a specific command line at runtime.</p></li></ul></li><li><p><strong>Non-blocking queries:</strong> The Bazel server has a global lock that prevents it from running more than one command at a time. This is a problem because the IDE needs to issue Bazel queries all the time, but those queries conflict with other user actions like builds and tests. There are various solutions to this problem, which we discussed in the unconference:</p><ul><li><p><strong>Separate output bases:</strong> This <em>works</em> but it’s heavy-handed because you end up with two full separate builds and two separate Bazel server processes.</p></li><li><p><strong>Simpler tools:</strong> Many operations on build files do not require the full weight of Bazel. Google has implemented simpler tools that operate on those precisely to bypass the overhead of calling ito Bazel. These tools include <code>buildifier</code>, <code>buildozer</code>, or the “fast builds” feature of the IntelliJ plugin.</p></li><li><p><strong>Parallel Skyframe evaluation:</strong> Skyframe’s inherent design is to be purely functional, so in principle it should be possible to perform multiple operations on the graph in parallel. Unfortunately, there is a lot of mutable state outside of Skyframe in Bazel and, while theoretically possible, fixing this is <em>a lot</em> of work.</p></li><li><p><strong>Implementing a depserver:</strong> Instead of running a separate Bazel on the same machine to answer queries, you could push this responsibility to an external service. Such a service is easy to build (you can imagine running <code>bazel query ...</code> on each commit) but the problem arises when you want to issue queries against this service from modified source trees.</p></li></ul></li></ul><h1>Inner loop development</h1><p>Bazel is <em>the</em> tool that glues together the <em>inner loop</em> of the development process. As a reminder, the inner loop refers to the the edit, build, and test cycle, and Bazel has tentacles on these three stages. Various talks gave thoughts on this topic:</p><ul><li><p><strong>Avoid Bazel in the inner loop:</strong> AirBnB reported that they noticed significant overhead and lack of incrementality in certain operations when trying to hook up Bazel into the IDE. They have the equivalent of “fast builds” in their own IDE plugin and have reduced incremental builds from 30 seconds to 1 second. This is a <em>big deal</em> for interactive builds. Personally, I think that having to side-step Bazel is ridiculous: Bazel is designed to be optimal and has perfect knowledge of the state of the world, yet it’s too slow for quick operations.</p></li><li><p><strong>Integrate with native tooling:</strong> Bazel works across many ecosystems, but as such, it’s friend to none. For example: Go developers want to work with the (super-fast) Go tooling so, if it’s feasible, it’s interesting to allow using such tooling directly. The folks at LinkedIn created a rule that generates an <code>.envrc</code> file to expose the native Go tools and relies on <a href=\"https://direnv.net/\">direnv</a> to make this work transparently for users.</p></li><li><p><strong>macOS as a client is common:</strong> Even for shops where all software runs on Linux, developers tend to have Macs and want to work locally. You may or may not agree, but if you <em>have</em> to support inner-loop development on the Mac, there are various things to consider. One is that cross-platform caching for machine-independent actions like Java may not work, doubling cache requirements; for this, you may consider using “universal binaries” (aka shell scripts that wrap multiple binaries and choose the right one at runtime). And you should really set up non-determinism checks.</p></li><li><p><strong>No build files:</strong> To my dismay, tons of people seem to really want to <em>not</em> have build files. This makes me sad because manually-curated build files serve as <em>documentation</em> for the <em>conceptual architecture</em> of a project and allow, at PR review time, to see changes to the interactions between components. You might say that <code>#include</code>s or package <code>import</code>s in the source are sufficient for this—but they really aren’t: they are too fine-grained and “innocent-looking”. I think I’ll need to write a follow-up article on this point.</p></li></ul><h1>Toolchains</h1><p>Bazel supports targeting multiple architectures and systems, and at the core of this support lie toolchains. There were various talks that touched on them:</p><ul><li><p><strong>Toolchains 101:</strong> In Bazel, rules convert providers to action templates, and toolchains help convert those templates to actions by replacing two things in the templates: the paths to the tools required by the action, and the arguments to pass to those tools. Simple, right? But defining toolchains has always been a black art.</p></li><li><p><strong>Simplified toolchains:</strong> Google brings a new way to define toolchains that’s much easier than the original one. The new mechanism relies on build rules: a toolchain rule declares a toolchain, and the toolchain depends on a “tool map” rule, which is a flat map of tool names (strategically specified as labels for typo- and type-checking, not flat strings) to binaries (also specified as labels). These tools are also connected to argument rules that define the sequence of arguments to apply to each tool. The support for “features” in core Bazel can potentially be removed in favor of this.</p></li><li><p><strong>Default toolchain no more:</strong> Following on the previous, Google said that there is a desire to remove the concept of a default C++ toolchain in favor of explicitly defining a hermetic toolchain like almost all other rules do. This was met with cheering from the audience.</p></li><li><p><strong>Debugging:</strong> It’s funny how, despite the complexity of toolchains and how we should make things easier for users… <code>--toolchain_resolution_debug</code>’s help claims that the flag is only for experts. <a href=\"https://github.com/bazelbuild/bazel/pull/19926\">PR 19926</a> made the debugging messages much clearer, but you should still understand the toolchain resolution algorithm to make sense of issues, and the talk on “Creating C++ toolchains easily” explained that.</p></li><li><p><strong>Universal binaries:</strong> Bazel doesn’t like sharing artifacts across different architectures. This is generally the right thing to do but, for platform-agnostic languages like Java, this has the potential of doubling remote execution and caching costs. There is an <a href=\"https://github.com/bazelbuild/bazel/discussions/18378\">ongoing discussion upstream</a> on what to do with this issue and various partial implementations in the code (like the <code>--experimental_platform_in_output_dir</code> flag), but no great solution yet. In the meantime, the alternative is to implement “universal binaries”. The idea is to create a shell script that wraps a binary tool built for various systems and selects, at runtime, which one to run.</p></li><li><p><strong>C++ shows up everywhere:</strong> Even if your build doesn’t seem to require C++ anywhere, the requirement to have this toolchain installed shows up pretty much everywhere because of… protobuf. bzlmod has the potential to fix this because the protobuf bzlmod packages ship with prebuilt binaries.</p></li></ul><h1>Sandboxing</h1><p>In order to offer reproducible builds, Bazel offers sandboxing features at the action level to ensure that actions can only do what they are supposed to do. I used to work in this space while on the Bazel team, so all talks on this topic were really interesting. Here are the notes:</p><ul><li><p><strong>macOS sandboxing is slow:</strong> Ah, the issue that never dies and that came up again in the unconference. While it might be true that macOS handles symlinks poorly, I’m still not convinced that there is anything that makes macOS sandboxing inherently slow. Yes, it will be less sandbox-y than what you get on Linux, but performance-wise it should be OK. All of my testing years ago didn’t show <code>sandbox-exec</code> as a performance bottleneck, and the sandbox doesn’t kill Bazel’s own build performance so… something <em>else</em> is at play here. Which brings us to the next point.</p></li><li><p><strong>Persistent state:</strong> Some compilers like Objective C’s build a module cache as they run. This cache is intended to be shared across invocations of the compiler. However, when the sandbox is in effect, sharing of this cache becomes impossible, which in turn makes builds incredibly slow. It may <em>seem</em> as if the sandbox itself is slow, but the real problem here is the lack of state sharing across actions and I suspect this is why people remain convinced that macOS sandboxing is slow. And, by the way, this impacts more than just Objective C.</p></li><li><p><strong>Sandboxing scenarios:</strong> Is it really necessary to sandbox <em>all</em> rules? <code>genrule</code>s, sure, but if we can reason about the behavior of specific rules, we can probably disable sandboxing for them and remain correct, which would decrease build-time overheads. (Remember that the sandbox was never about security.)</p></li><li><p><strong>File monitoring:</strong> An alternative to sandboxing is to monitor the activity of build actions and validate, post-build, that they didn’t access things they were not supposed to. This is much faster than sandboxing as it avoids the need to construct on-disk sandboxes… but fails when tools decide to read directories. So… this approach isn’t really feasible. JavaScript tooling loves to expand globs.</p></li><li><p><strong>Hermetic sandboxing:</strong> The traditional Bazel sandbox does not restrict reading system-wide paths so it cannot guarantee that an action doesn’t access certain system headers or arbitrary tools in <code>/bin</code>. There is a “new” hermetic sandbox for Linux that fixes these issues—but, obviously, is hard to put in practice. See <code>--experimental_use_hermetic_linux_sandbox</code>.</p></li><li><p><strong>Base POSIX system:</strong> With a hermetic sandbox, it becomes very tempting to model the host system’s base libraries and tools (bash and the like) as a toolchain. <a href=\"https://github.com/tweag/rules_sh\">rules_sh</a> from Tweag can help here.</p></li><li><p><strong>Local remote execution:</strong> A different mechanism to achieve sandboxing would be to use remote execution against a local service. This service could run on a VM or similar and offer a mechanism to cross-compile against weird architectures. This wouldn’t be quite the same as the Docker strategy.</p></li><li><p><strong>Separation of responsibilities:</strong> Somebody mentioned that it’d be neat to separate the sandboxing logic into its own thing that isn’t in Bazel’s core. I agree. The <code>linux-sandbox</code> binary that Bazel contains is somewhat akin to this, and I previously implemented something similar in <a href=\"https://github.com/jmmv/sandboxctl\">sandboxctl</a> (for very different reasons). In any case, this would need to be multi-platform and written in a decent, safe language (<em>cough</em> Rust <em>cough</em>).</p></li></ul><h1>Monorepo issues</h1><p>With scale come problems, and large monorepos tend to exacerbate issues that have always existed in small repos but that go unnoticed otherwise. Here are some of the issues that talks mentioned:</p><ul><li><p><strong>Glob handling:</strong> Globs are expensive to handle in Bazel, especially when running on networked file systems. Globs are parsed and then expressed as a DAG of functions within Skyframe. Right now, due to limitations in Java’s concurrency model, globs are evaluated twice, but Java 21’s green threads may alleviate this. Related, I was chatting about this with one of the Buck 2 authors and he said that they take a very different approach and don’t find the issues that Google described: basically, they traverse the file system once and then apply the glob as an in-memory only operation.</p></li><li><p><strong>Monolithic targets:</strong> Any large piece of code that has grown without a build system that enforces boundaries across components will grow at least one component that has thousands of source files in it with cyclic dependencies among them. These are harmful to the organization as they tend to reflect the “broken windows” culture of the team. Tinder explained how they tackle this problem, with basically boils down to: ensuring there are tests, ensuring that leadership is onboard with the cleanup, creating automation to extract files from the monolith (most of the work is repetitive), and then creating visualization tools to graph the problem and identify subsets of files that can be easily extracted.</p></li><li><p><strong>Gradual rollout of library updates:</strong> During the unconference, we discussed how to deal with version upgrades of a single library in a world that favors the “One version policy”.</p><ul><li><p><strong>Prerequisites:</strong> We agreed that, to succeed at upgrading a library, it’s critical to have tests in place and leverage tooling like <code>buildifier</code> to perform the upgrades automatically where possible.</p></li><li><p><strong>Big bang upgrade:</strong> One approach to the problem is to do the version upgrade in one go. This is sometimes really hard to do, and can also be risky because any problem anywhere in the repo would imply a rollback for everyone.</p></li><li><p><strong>Treat it as an exception:</strong> Another approach is to get an exception from the “One version policy” and temporarily allow two versions of the library in the repo. You can leverage the <code>alias</code> rule to introduce an indirection to the version in use, and then slowly migrate packages. This can work but diamond conflicting dependencies can be a real problem.</p></li><li><p><strong>Parallel build:</strong> Yet another approach is to create a parallel build and test infrastructure for the new version. Maybe use a build flag to select the version to use; maybe duplicate the targets and rename them. The goal with this approach is to keep the “new version” on the side until it all works, and then submit a trivial “3-line PR” that flips the default. For this scenario, “project files” would be useful to group the new set of targets and automatically set the right configuration for them; Buck 2 has something similar in its <code>PACKAGE</code> construct.</p></li><li><p><strong>Different package names:</strong> And another approach is to do what Java tends to do, which is to <em>rename</em> the libraries on major version upgrades so that they do not conflict at all. This is something that the upstream library maintainers have to do, not you. The problem with this approach is that semantic version is not always accurate and upstream maintainers tend to do breaking changes during minor version upgrades without realizing it.</p></li></ul></li><li><p><strong>git pain:</strong> Bazel and large monorepos go hand in hand, but Git—the most popular version control system—doesn’t like large repos very much: some operations scale with the size of the history (<code>git clone</code>) while others scale with the size of the repo (<code>git status</code>) instead of scaling with the size of the change.</p><ul><li><p><strong>Mitigation tools:</strong> There are various options that can mitigate the problem, including the <a href=\"https://git-scm.com/docs/git-fsmonitor--daemon\">FSMonitor</a>, the “untracked cache”, keeping <code>.gitignore</code> small, and using sparse checkouts.</p></li><li><p><strong>Materializing a portion of the tree:</strong> Uber previously tried using a Bazel query to find all files required for a build and then using the result of the query to just check those files out from Git. While this can work, it led to confusing error messages when there were missing files. And also, this poses the question: where do you run the query given that the query needs access to the full repo?</p></li><li><p><strong>git archives:</strong> Git is a very chatty protocol. Mark Zeren from Broadcom reports that, while Perforce can easily saturate the network, Git can rarely do so on a similar repo. The slowdown is even visible when using the loopback network interface. Prebuilding <code>git-archive</code>s periodically and using those to build the initial state of a Git clone can significantly improve performance. He mentioned that it’d be good to build a service to automate this, and offered help in doing so.</p></li><li><p><strong>Delegating file accesses:</strong> There is an open feature request in <a href=\"https://github.com/bazelbuild/bazel/issues/16380\">#16380</a> asking for a way to delegate file accesses to another tool. This, to me, sounds like FUSE. Someone brought up that FUSE doesn’t work well on macOS anymore and that NFS can be used as an alternative, and Meta’s EdenFS or Buildbarn’s bb-clientd’s do that just fine. Another option is to implement a custom VFS instance within Bazel to directly talk to a remote file system.</p></li></ul></li><li><p><strong>Resource consumption:</strong> Bazel’s memory usage is… troublesome. First, because Bazel uses a lot of memory, and second because of the JVM’s heap limits. Newer Bazel versions were able to reduce <em>retained</em> heap memory by 95% after a build and 25-30% overall during a build… but that’s not very useful because <em>peak</em> memory consumption is what matters in many cases. The team is looking at various alternate solutions to tackle this problem:</p><ul><li><p><strong>Skyfocus:</strong> Bazel 8 contains a new feature called Skyfocus, in experimental state. The idea is to perform GC based on a user-defined working set. This is useful in large monorepos where users want to only work on a small portion of the tree, but there are questions about the usability aspects and UX of this solution.</p></li><li><p><strong>Skeletal analysis:</strong> The goal of this work is to try to change the evaluation model to reduce peak memory by 20%. The idea is to trade memory usage for wall time, which means this will be useful for CI but could be harmful for interactive builds.</p></li><li><p><strong>(Remote) Analysis caching:</strong> The loss of the Bazel analysis cache across reconfigurations or server restarts has always been a problem and a major usability annoyance, so this is finally being looked at. The goal is to be able to cache configured targets, aspects, action execution results, and other Bazel-internal state, possibly storing this information in the “standard” remote cache by using a special key. This could also help with a ~70% heap and runtime reduction for analysis phases from cold start, and it could be used to prune entire subgraphs during the execution phase. This would be a massive improvement for IDE interactions, as IDEs primarily rely on analysis-time operations only.</p></li><li><p><strong>Distributed analysis:</strong> The idea is to shard analysis across Bazel workers. This sounds… OK for gigantic monorepos like Google’s but I’m not sure I see the use case outside of that environment. Still in very early stages of discussion.</p></li></ul></li></ul><h1>blzmod and external dependencies</h1><p>The <code>WORKSPACE</code> in Bazel has always been a wart: Google did <em>not</em> have this feature in Blaze but the need to support out-of-tree third-party dependencies became glaringly obvious when they open-sourced Bazel. The <code>WORKSPACE</code> was then bolted on and we have been suffering from its deficiencies for years. bzlmod promises to fix them all, and of course there were talks (and a BoF) on it:</p><ul><li><p><strong>SOTU dependency updates:</strong> bzlmod now provides a vendor mode to download all dependencies of a target or all targets, which is very useful for CI/CD offline builds (e.g. to exercise disaster recovery). <code>MODULE.bazel</code> now has include support and <code>use_repo_rule</code> for easier migration. The lock file format has been revamped to minimize merge conflicts. The <code>WORKSPACE</code> is disabled by default in Bazel 8 and won’t be available in Bazel 9. As for future plans, the repo cache will be shared across workspaces and will include the results of evaluation, not just downloads.</p></li><li><p><strong>SOTU rule updates:</strong> The Python, Android, Java, and shell rules have all moved to Starlark. Protobuf and Android support have moved as well, and this comes with new things like “mobile install v3”. The goal for next year is to complete the Starlarkification effort (with possible new extension points to call into Bazel from the Build API).</p></li><li><p><strong>SOTU Starlark and the Build API:</strong> All struct providers are gone; aspects can propagate to target toolchains; and there are now dormant dependencies for tests. As for upcoming changes: symbolic macros in Bazel 8 (more later); rule finalizers; and types for Starlark (which are compatible with Python 3 but <em>not</em> with Buck).</p></li><li><p><strong>Handling internal artifacts:</strong> It is common for vendors to provide binary blobs that don’t integrate with Bazel. Azul’s JDK is an example. For these, it is interesting to consume them into the build via a workspace repository, but the question then becomes how to do this with bzlmod. The answer is to “layer multiple registries”: you’d have a company-internal registry that exposes these binaries, and then fall back to the BCR for everything else.</p></li><li><p><strong>Disabling the BCR:</strong> For companies that want to have tight control on what they access during the build, it’s perfectly possible to bypass the BCR, either by pointing Bazel to an internal registry or by vendoring sources. The <code>bazel vendor</code> subcommand, which I didn’t know about, can come in handy.</p></li><li><p><strong>Missing packages:</strong> There are some glaring omissions from the BCR right now, which include googleapis, gRPC, and <code>rules_scala</code>. The maintainers of the former are not very cooperative, but progress is being made. As for gRPC, there is a desire to avoid pulling in support for all languages all the time, which makes this technically harder.</p></li></ul><h1>Secure and auditable builds</h1><p>Maintaining the integrity of the software provenance chain is difficult and “recent” events like the <a href=\"https://en.wikipedia.org/wiki/XZ_Utils_backdoor\">XZ Utils Backdoor</a> have shown the criticality of, at least, having an audit trail of what goes into software builds. This is where SBOM and other techniques come into play, and Bazel-based builds are perfectly positioned to provide these assurances:</p><ul><li><p><strong>SBOMs:</strong> There are many different formats to produce a <a href=\"https://www.ntia.gov/page/software-bill-materials\">Software bill of materials (SBOM)</a>, and a few of them like CycloneDX and SPDX are standardized. It’s important that these files are “merge-able” so that, when you import a third-party dependency, you can assemble their own SBOM.</p></li><li><p><strong>Types of targets:</strong> It’s tricky to generate the SBOM, and not all rules to generate one did or do the right thing. For example: do all deps belong in the SBOM? What about deps that say <code>neverlink=1</code>? What about build-time only deps like compilers?</p></li><li><p><strong>Rules:</strong> Bazel has had a <code>licenses</code> package-level function for a long time, but it is insufficient to generate an SBOM. The newer <a href=\"https://github.com/bazelbuild/rules_license\">rules_license</a> offers a much more complete solution to tracking licenses and generating SBOMs.</p></li><li><p><strong>Build assurance:</strong> Other than declaring licenses, it’s important to be able to verify <em>where</em> builds came from. <a href=\"https://slsa.dev/\">SLSA</a> defines various levels that capture different requirements. At the very least, you should target SLSA 2, which requires builds to be produced from trusted environments and to prevent arbitrary users from tampering with those builds (e.g. only allowing uploads to the Action Cache by CI). SLSA 3 is even more strict but RE doesn’t yet provide a mechanism to implement it; there are some talks to support it in V3 and maybe backport it to V2, but no concrete plans yet.</p></li></ul><h1>Symbolic macros</h1><p>Macros are problematic: they tend to cause targets to require public visibility; they tend to pollute the list of available targets in a package (the output of <code>bazel query</code> is unusable); and they have the potential of bloating the build graph massively. There was a full talk from Google on a new feature that’ll make these less of an issue:</p><ul><li><p><strong>New feature:</strong> Bazel 8 ships with <em>symbolic macros</em>, which are first-class citizens of the build graph. Symbolic macros are declared similarly to rules: instead of specifying <code>rule()</code>, you specify <code>macro()</code> and provide a set of attributes and an implementation function. The names of the targets and outputs that these macros produce are constrained to a set of well-defined patterns.</p></li><li><p><strong>Limitations:</strong> One known deficiency is that <code>**kwargs</code> doesn’t work as it used to because there is no way to specify this in an attribute list. The way to mitigate this and make it easier to wrap rules will be attribute inheritance. Similarly, while symbolic macros can lead to lazy expansion, this is not yet implemented. Both of these limitations will be addressed later in the 8.x series.</p></li><li><p><strong>Epilogs:</strong> Legacy macros used to call <code>native.existing_rules()</code> and lead to the “epilog macro” idiom that can be found in large monorepos. These macros are expected to appear at the end of a build file… but there is no way to enforce this. With symbolic macros, this idiom is now a supported feature via the <code>finalizer=True</code> attribute, which then makes these macros be expanded <em>after</em> the full build file has been processed irrespective of any other targets.</p></li><li><p><strong>Downsides:</strong> Symbolic macros were well-received by conference attendees but have received some pushback inside of Google. The reason is that, because these macros will allow lazy evaluation, it’s possible that they’ll encourage even larger packages that only become problematic in some (critical) scenarios.</p></li><li><p><strong>Legacy macros:</strong> There are no plans to remove legacy macros right now—and even if there were, it’d take years to eliminate them due to the need to remain backwards-compatible for multiple releases.</p></li></ul><h1>Queries</h1><p>For people coming from other build systems, the ability to query a build graph may sound like an alien concept. But Bazel has first-class features to do just this, and they can come in handy when writing automation to modify the source tree or to select tests for execution.</p><p>There was a full 30-minute talk dedicated to queries. I do not intend to repeat everything that was said because everything is in <a href=\"https://bazel.build/query/language\">the query documentation</a>… but I did learn a bunch of stuff:</p><ul><li><p><strong>Target provenance:</strong> <code>bazel query --output=build ...</code> shows “fictitious” attributes like <code>generator_{name,function,location}</code> which indicate what produced a target. Useful to understand what macros and globs are doing. These attributes can also be used in filters.</p></li><li><p><strong>Variables:</strong> Queries can have variables in them to avoid repeating complex parts. For example: <code>let v = foo/... in allpaths($v, //common) intersect $v</code>.</p></li><li><p><strong>Removing implicit dependencies:</strong> These often pollute query results with noise and can be removed with <code>--noimplicit_deps</code>. Arguably, this flag should be the default.</p></li><li><p><strong>Graphing:</strong> It is possible to generate a Graphviz file by using <code>--output=graph</code> and then graphing it with <code>dot -Tsvg -o graph.svg</code>. It is important to filter the query or otherwise the resulting graph is overwhelming—aka useless.</p></li><li><p><strong>Running code on the graph:</strong> The <code>cquery</code> command supports <code>--output=starlark --starlark:expr=...</code> which allows running a piece of Starlark code on every target selected by the query. The current target is bound to the <code>target</code> variable. This is useful to, for example, query transitive runtime JARs. And because Starlark is almost Python, you can explore the API by using the <code>dir</code> function with expressions like <code>dir(target)</code> or <code>dir(target.actions)</code>.</p></li><li><p><strong>Action queries:</strong> The <code>aquery</code> command is a different beast from the other queries and allows inspecting the action graph. Something like <code>bazel aquery 'mnemonic(CppCompiler, //...)'</code> shows all inputs, outputs, and command lines for every action. This can be particularly useful to understand toolchain configuration changes.</p></li><li><p><strong>Filtering by file:</strong> The <code>outputs</code> and <code>inputs</code> filters can be used to filter actions by paths: e.g. you can find actions that produce a particular file with <code>outputs(\".*path/to/h\", deps(//...)))</code>. (Beware that the path filter is an anchored regexp.)</p></li><li><p><strong>Performance:</strong> Running many queries in a loop doesn’t scale. Consider building a bigger query if possible and then do post-processing (the opposite advice of when talking to a database server), or using an aspect to dump all info in a single run.</p></li></ul><h1>Linting</h1><p>Back at Google, Jin and I hosted an intern circa 2017 to work on “autolint”: an innovative tool that was supposed to automate running arbitrary lint checks on arbitrary codebases. The project never materialized… but Aspect.dev just announced <a href=\"https://github.com/aspect-build/rules_lint\">rules_lint</a> which basically does the same thing and integrates with Bazel neatly.</p><p>To summarize the talk, <code>rules_lint</code> provides two disjoint features in one:</p><ul><li><p><strong>Formatting:</strong> The goal of formatting is to change a codebase to adhere to predefined standards and stop the bitchering about white space. A quote from the talk I liked was “because while your code might be art… it isn’t ASCII art”.</p><ul><li><p><strong>Broad support:</strong> Supporting formatters is easy, and there are formatters for almost all languages, so a goal here is to try to support as many as possible.</p></li><li><p><strong>Speed:</strong> Formatting must be deterministic and fast so that it can be hooked into the IDE and/or in pre-commit hooks.</p></li><li><p><strong>Not part of the build graph:</strong> It’s tempting to try to hook formatting as an action, but formatting requires unconstrained access to the workspace to modify source files, and many source files that you’d like to lint don’t necessarily have build rules (e.g. Markdown documentation).</p></li><li><p><strong>Implementation:</strong> Formatting relies on <code>rules_multitool</code> which automates the process of downloading a bunch of tools and <code>rules_multirun</code> which allows running multiple tools in parallel.</p></li><li><p><strong>Git blame:</strong> When applying formatting changes, don’t forget to register the commits that did so in <code>.git-blame-ignore-revs</code>. This will prevent your name from showing up in <code>git blame</code> operations as the author of all files.</p></li></ul></li><li><p><strong>Linting:</strong> The goal of linting is to detect potential problems in the code, but the constraints are different: the problems aren’t always conclusive, the solutions aren’t always unique nor safe to apply automatically, and analyzing a file may require analyzing more than one at once.</p><ul><li><p><strong>Speed:</strong> Linting is slow because it often requires using tools akin to compilers. As such, it should never be added to pre-commit hooks and should instead be plumbed through in CI.</p></li><li><p><strong>Implementation:</strong> The desire is to have a uniform interface for linting all languages and don’t want to have extra rules nor modify build files. The obvious answer to this is to use an aspect which then augments existing rules with reports and patches to fix up the source tree. Validation actions were not an option because using them requires modifying the rulesets, and a premise of this work was to <em>not</em> do that.</p></li><li><p><strong>Interface:</strong> Invoking an aspect and handling the resulting patch files is complicated, so Aspect.dev has augmented the Bazel client (the CLI) with an additional <code>lint</code> subcommand that automates this process. Interesting, and I suppose this could be turned into a pluggable mechanism by making Bazel look for <code>bazel-<command></code> binaries at a well-known location (like the <code>git</code> dispatcher does). This reminded me of Twitter’s <a href=\"https://v1.pantsbuild.org/\">Pants</a> build system, which is much more than just for building.</p></li></ul></li></ul><h1>Testing</h1><p>Bazel is often sold as a “build tool” but its secret sauce is that it really is a “test tool”. The true benefits of using Bazel come from realizing that not all tests have to run all the time, and that their results can be safely cached. Various talks touched upon how to do testing effectively:</p><ul><li><p><strong>Profiling data:</strong> Collecting profiling details of tests <em>by default</em>, and exposing these details as test outputs, is very useful because developers can then use this information to understand how to optimize long tests on their own. AirBnB reported that they do this.</p></li><li><p><strong>Test granularity:</strong> We like to think that each test deserves its own test target… but that’s not necessarily how users think or how they interact with tests. Many times, developers end up running certain groups of tests in unison, and if they always do that, combining those tests under a single target will save build and execution time at the expense of a less “pure” dependency graph.</p></li><li><p><strong>Tests in the build:</strong> In certain scenarios, users would like to depend on test outputs as part of the build process. One example that Luminar Technologies provided was the need to generate a detailed report of test results and code coverage for industry compliance reasons. The report generation should be an action that depends on the test outputs, but that’s not doable. As a compromise, they made the tests run as part of the build by replacing <code>cc_test</code> with a macro that spawns a non-test action with a custom runner (but only on CI).</p></li><li><p><strong>Smoke tests:</strong> Related to the previous and during the unconference, Luminar Technologies also brought up the desire to gate parts of the build and test process on “smoke tests”. In other words: once issuing the build/test operation, if we detect that a simple test fails, we shouldn’t continue the build or run any of the more expensive tests. The audience seemed to agree that this belonged into a separate tool. Ulf reminded us that there should still be a flag called <code>--test_keep_going</code>, which can be set to false to stop execution as soon as one test fails.</p></li><li><p><strong>Test selection:</strong> When folks adopt Bazel, their initial approach to CI is to simply do <code>bazel test ...</code> in a job. This works well… until it doesn’t, because even in the presence of test caching, processing the whole monorepo becomes expensive. Uber explains how even an <code>rdeps</code> query becomes expensive and they’ve had to find other solutions. A key insight is that 71% of changes to their monorepo only change source files and only 15% change at least one build file. This means that the majority of changes do not modify the build graph structure significantly, so there is room for reusing state from previous builds (e.g. keeping the Bazel server alive) to compute newly-affected targets.</p></li><li><p><strong>Flaky test granularity:</strong> Bazel detects flakes at the test target level… but a test target can contain tens or hundreds of individual test cases. Which means that if a single test case is flaky and we conclude that its target is flaky, subsequent builds could skip lots of valid test cases. By implementing custom flaky test case detection via <code>junit.xml</code> report files, Uber was able to surface 3500 additional tests that would have been skipped by the naive target-based approach and could re-add those to the build.</p></li><li><p><strong>Profile-guided test execution:</strong> In large test invocations, it’s common for one test to be the long pole. If by lack of luck this test ends up running last, it ends dragging the critical path of the test run and lengthening the p99 of test executions. It’d be nice if Bazel supported “profile-guided execution” so that such long poles could be scheduled earlier. Jin reported that this has been looked at but one problem is that there hasn’t been a good place to store this information across invocations. Ulf mentioned that when we have async action execution (which Java 21 makes possible), we should be able to improve action scheduling and implement this.</p></li><li><p><strong>Actions per test:</strong> One interesting detail that Ulf shared is that test targets generate three actions, possibly more: one to execute the test itself, another to generate the <code>junit.xml</code> file if the test failed to do so, and another to perform coverage post-processing. If retries, sharding, or <code>--runs_per_test</code> are involved, there can be even more actions. So, if it becomes necessary, there is precedent to add more actions to perform other types of post-processing.</p></li><li><p><strong>CI runners:</strong> A topic that came up during the unconference was that starting Bazel on CI runners is very painful because of the need to download repos, repopulate the local disk cache, and rebuild the analysis graph. The general advice is to prevent discarding CI runners across builds, but that’s not always possible (e.g. security might not like to share runners across different jobs). For Kubernetes, stateful sets provide a mechanism to preserve the disk cache even during auto-scaling.</p></li></ul><h1>Missing tooling around Bazel</h1><p>A fun topic that arose in the unconference was: “what support tools do you wish Google had open sourced when they published Bazel, or that the community had built?” There were many ideas from the audience:</p><ul><li><p><strong>Scripting language for use in genrules:</strong> Writing genrules that work across systems is difficult because they invoke the shell, and the tools that are often called do not always support the same syntax (<a href=\"https://jmmv.dev/2021/08/useless-use-of-gnu.html\">thanks GNU</a>). It’d be nice to have a language that allowed writing genrules in a platform-agnostic way. WASM was brought up as well as having a Starlark interpreter with file system access.</p></li><li><p><strong>Affected target determination:</strong> The goal of this tool would be to answer the question of which targets are impacted by a change to the source tree. <a href=\"https://github.com/Tinder/bazel-diff\">bazel-diff</a> more or less does this. An <code>rdeps</code> query sounds like the right solution, but in practice it is tricky because changes to a toolchain aren’t visible in a query; they do show up in <code>cquery</code> though, but then you have to be aware of all possible configurations to do the determination correctly.</p></li><li><p><strong>Build queuing:</strong> The goal here is to have a service that can queue entire builds and not just actions. This might exist in some CI systems already.</p></li><li><p><strong>Unifying bazelisk with bazel:</strong> Users are confused with the fact that <code>sudo apt install bazel</code> is available but generally does the wrong thing, and that it’d be good if <code>bazelisk</code>’s features existed within Bazel. I explained that we built something similar to <code>bazelisk</code> at Snowflake but for arbitrary tools as a way to hijack command line executions and redirect them to checked-in tools; maybe we should open-source it.</p></li><li><p><strong>buildozer for bzl files:</strong> Automating edits to <code>bzl</code> files would be handy, although this is a hard problem. Maybe it could be scoped down to e.g. automatically clean up old repository rules that aren’t referenced.</p></li><li><p><strong>Java library to programmatically edit build and </strong><code>bzl</code><strong> files:</strong>. The current Starlark library isn’t useful because it’s not standalone and it doesn’t preserve the original file structure. A workaround is to extract the AST from Python because these files remain syntactically valid from Python’s perspective.</p></li><li><p><strong>Documentation website for all the rules:</strong> The BCR could fulfill this, but it currently does not have links to documentation.</p></li></ul><h1>The end</h1><p>And finally, here are the few leftover toughts that I did not know how to fit in any of the sections above:</p><ul><li><p><strong>Nix:</strong> There were many talks about Nix on the original submissions, but only a couple made it to the final schedule. The folks at Modus Crate described how they use <code>rules_nixpkgs</code> to build external dependencies and how they stage those in an NFS-shared <code>/nix/store/</code> tree. Because Bazel invokes Nix and stages the dependencies during its external repository phase, the execution phase and the remote workers can assume that the Nix packages are in the right locations and things just work.</p></li><li><p><strong>RPM integration:</strong> In a similar spirit to using Nix to install packages and/or build containers, we also have <a href=\"https://github.com/rmohr/bazeldnf\">bazeldnf</a>. This ruleset provides the <code>rpm</code> repository rule to import RPM packages and the <code>rpmtree</code> build rule to combine one or more RPM into a tarball that can later be fed to other rules like <code>container_layer</code>. In this context, you might also be interested in the <a href=\"https://github.com/NixOS/patchelf\">patchelf</a> ruleset.</p></li><li><p><strong>Migrations:</strong> Migration talks are getting old, but there were some good insights from MongoDB’s talk. One such insight was that, as in any software rewrite, the “old” build system doesn’t stay still during a migration, and the set of features to migrate grows over time. Another such insight was that, if you can couple the new build system to the old one (by making one rely on the other for increasing portions of the code), you can minimize the time in which new features get added to the old build and not the new one. The downside is that you’ll be building throwaway work, but overall it will pay off.</p></li><li><p><strong>My talk about Snowflake:</strong> I gave a 15-minute “migration” talk about what we are doing with Bazel at Snowflake. Because of what I said just above, I skipped over all of the migration topics and instead focused on explaining 5 different technical challenges that we faced and how we fixed them. I was met with lots of questions after the talk, which was really nice, but which means that we owe a full migration post when we are done (very soon now!).</p></li></ul><p>I hear you want the raw notes? Are you sure? I really don’t recommend that you look… but if you must, here they are: <a href=\"https://jmmv.dev/notes/2024-10-14-bazelcon.md\">BazelCon day 1 notes</a>, <a href=\"https://jmmv.dev/notes/2024-10-15-bazelcon.md\">BazelCon day 2 notes</a>, and the <a href=\"https://jmmv.dev/notes/2024-10-16-build-meetup.md\">Build Meetup’s notes</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">I hope that you enjoyed this 4o-minute long summary of 3 long conference days. The way to “pay back” is, simply, to hit subscribe! And yes, it’s free.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "0.0" "image/jpeg") nil "69daf7c2d5bb808b2754b809a241a773") (37 (26623 25868 518974 996000) "https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11" "Hands-on graphics without X11" "Julio Merino" "Fri, 17 Jan 2025 17:45:51 +0000" "<p>Look at these two consoles:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" width=\"1200\" height=\"508.65671641791045\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\",\"srcNoWatermark\":null,\"fullscreen\":false,\"imageSize\":\"large\",\"height\":568,\"width\":1340,\"resizeWidth\":1200,\"bytes\":25232,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-large\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Side-by-side comparison of the NetBSD console right after boot vs. the EndBASIC console.</figcaption></figure></div><p>Same colors, (almost) same font, same… everything? Other than for the actual text they display, they look identical, don’t they? But the one on the right can do things that the one on the left cannot. Witness this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1de4af8-dba8-4d87-913c-c5b14e11ea92\",\"duration\":null}\"></div><p>A square? OK, meh, we had those in the DOS days with <a href=\"https://en.wikipedia.org/wiki/Box-drawing_characters\">box-drawing characters</a>. But a circle?! That’s only possible because the console on the right is a hybrid console that supports mixing the usual textual grid of a terminal with overlapping graphics.</p><p>Now, if you have been following the development of <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, this is not surprising. The defining characteristic of the EndBASIC console is that it’s hybrid as the video shows. What’s newsworthy, however, is that the EndBASIC console can now run directly on a framebuffer exposed by the kernel. No X11 nor Wayland in the picture (pun intended).</p><p>But how? The answer lies in NetBSD’s flexible wscons framework, and this article dives into what it takes to render graphics on a standard Unix system. I’ve found this exercise exciting because, in the old days, graphics were trivial (<a href=\"https://en.wikipedia.org/wiki/Mode_13h\">mode 13h</a>, anyone?) and, for many years now, computers use framebuffer-backed textual consoles. The kernel is obviously rendering “graphics” by drawing individual letters; so why can’t you, a user of the system, do so too?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Your subscription to Blog System/5 fuels me to write comprehensive articles like this, and this one was particularly painful to put together. Click the button for more goodies. It’s free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>wscons overview</strong></h1><p><a href=\"https://man.netbsd.org/wscons.4\">wscons(4)</a>, or Workstation Console in its full form, is NetBSD’s framework to access the physical console attached to a computer.</p><p>wscons abstracts the details of the hardware display and input devices so that the kernel and the user-space configuration tools can treat them all uniformly across the tens of platforms that NetBSD supports. If you use <a href=\"https://man.netbsd.org/wsconsctl.8\">wsconsctl(8)</a> on a modern amd64 laptop to control its display, you use wsconsctl on an ancient vax box to control its display too.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" width=\"1456\" height=\"1001\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1001,\"width\":1456,\"resizeWidth\":null,\"bytes\":436643,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Layered architecture of wsdisplay and its backing devices.</figcaption></figure></div><p>The output architecture of wscons is composed of multiple devices, layered like this:</p><ol><li><p><a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> sits at the top of the stack and implements the console in hardware-independent terms. The functionality at this level includes handling of VT100-like sequences, cursor positioning logic, text wrapping, scrolling decisions, etc.</p></li><li><p>Under wsdisplay sit the drivers that know how to access specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/vga.4\">vga(4)</a>, which does not do graphics at all; <a href=\"https://man.netbsd.org/genfb.4\">genfb(4)</a>, which is a generic framebuffer driver that talks to the “native” framebuffer of the system (e.g. the one configured by the EFI); and <a href=\"https://man.netbsd.org/radeonfb.4\">radeonfb(4)</a>, which implements an accelerated console on AMD cards. These drivers know how to initialize and interact with the hardware.</p></li><li><p>Under the graphical drivers sits <a href=\"https://man.netbsd.org/vcons.4\">vcons(4)</a>, the driver that implements one or more graphical consoles in terms of a grid of pixels. vcons is parameterized on “raster operations” (rasops), a set of virtual methods to perform low-level operations. An example is the <code>moverows</code> method, which is used by wsdisplay to implement scrolling in the most efficient way provided by the hardware. vcons provides default (inefficient) implementations of these methods, but the upper drivers like radeonfb can provide hardware-accelerated specializations when instantiating vcons. vcons also interacts with <a href=\"https://man.netbsd.org/wsfont.4\">wsfont(4)</a> to render text to the console.</p></li></ol><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" width=\"1456\" height=\"637\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8368000-8d05-4451-beec-27f355c41828_1920x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":637,\"width\":1456,\"resizeWidth\":null,\"bytes\":76696,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Layered architecture of wskbd and its backing devices, including the optional wsmux wrapper.</figcaption></figure></div><p>The input architecture of wscons is similar in terms of layering of devices, albeit somewhat simpler:</p><ol><li><p><a href=\"https://man.netbsd.org/wsmux.4\">wsmux(4)</a> is an optional component that multiplexes multiple input devices under a single virtual device for event extraction.</p></li><li><p><a href=\"https://man.netbsd.org/wsbkd.4\">wskbd(4)</a> sits at the top of the stack (not accounting for wsmux) and implements generic keyboard handling. The functionality at this level includes translating keycodes to layouts, handling key input repetition, and more. wskbd exposes a stream of wsevents to user-space so that user-space can process state changes (e.g. key presses).</p></li><li><p>Under wskbd sit the device drivers that know how to deal with specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/ukbd.4\">ukbd(4)</a> for USB keyboard input and <a href=\"https://man.netbsd.org/pckbd.4\">pckbd(4)</a> for PC/AT keyboard input. These drivers wait for hardware input, generate events, and provide a map of keycodes to key symbols to the upper layer so that wskbd can operate in generic terms.</p></li></ol><p>The input architecture can handle other types of devices like mice and touch panels (both via <a href=\"https://man.netbsd.org/wsmouse.4\">wsmouse(4)</a>), but I’m not going to cover those here. Just know that they sit under wsmux at the equivalent level of wskbd and produce a set of wsevents in the exact same manner as wskbd.</p><h1><strong>Querying framebuffer properties</strong></h1><p>As you can sense from the overview, the whole architecture under wsdisplay is geared towards video devices… if it wasn’t for the vga driver: in the common case, wsdisplay is backed by a graphical framebuffer managed by vcons for text rendering, yet the user only sees a textual console. But if the kernel has direct access to the framebuffer, so should user-space too.</p><p>The details on how to do this click if you read through the operations described in the wsdisplay manual page. In particular, you may notice the <code>WSDISPLAYIO_GET_FBINFO</code> call which retrieves extended information about, you guessed it, a framebuffer display.</p><p>Let’s try it: I wrote a trivial program to open the display device (named <code>/dev/ttyE0</code> for reasons that escape me), call this function, and store the results in an <code>fbinfo</code> structure:</p><pre><code>// wsdisplay-fbinfo.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-fbinfo.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
close(fd);
exit(EXIT_SUCCESS);
}</code></pre><p>Hmm, but this program does not have any visible output, right? The code just queries the framebuffer information and does nothing with it. The reason is that the content of the <code>wsdisplayio_fbinfo</code> structure is large and I didn’t want to pretty-print it myself. I thought it’d be fun to show you how to use GDB to inspect large data structures and how to script the process. Here, look:</p><pre><code>gdb -q \\
-ex 'set print pretty on' \\
-ex 'break exit' \\
-ex 'run' \\
-ex 'frame 1' \\
-ex 'print fbinfo' \\
-ex 'cont' \\
-ex 'quit' \\
./wsdisplay-fbinfo</code></pre><p>This call to GDB starts the sample program shown above and automates various GDB commands to set a breakpoint, step through the program, and pretty-print the <code>fbinfo</code> structure right before exiting. When we execute this command as root (which is important to get access to the <code>/dev/ttyE0</code> device), we get this:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" width=\"1013\" height=\"872\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":872,\"width\":1013,\"resizeWidth\":null,\"bytes\":96166,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Content of the fbinfo structure as grabbed by the sample wsdisplay-fbinfo program and printed by GDB.</figcaption></figure></div><p>Neat. We get sensible stuff from the kernel! <code>fbi_width</code> is 640 and <code>fbi_height</code> is 480, which matches the 640x480 resolution I have configured in my test VM.</p><h1><strong>Drawing to the framebuffer</strong></h1><p>But note these other fields in the structure printed above:</p><pre><code>struct wsdisplayio_fbinfo {
uint64_t fbi_fbsize;
uint64_t fbi_fboffset;
// ... more fields ...
}</code></pre><p>The <code>fbi_fbsize</code> and <code>fbi_fboffset</code> fields are <em>begging</em> us to use <code>mmap</code> to memory-map the area of the device starting at <code>fbi_fboffset</code> and spanning <code>fbi_fbsize</code> bytes. Presumably we can write to the framebuffer if we do this, but beforehand, we have to switch the console to “framebuffer mode” by using the <code>WSDISPLAYIO_SMODE</code> (“set mode”) call. This call accepts an integer to indicate which mode to set:</p><ul><li><p><code>WSDISPLAYIO_MODE_EMUL</code>: Set the display to emulating (text) mode. This is the default operation mode of wsdisplay and configures the console to “emulate” a text terminal.</p></li><li><p><code>WSDISPLAYIO_MODE_MAPPED</code>: Set the display to mapped (graphics) mode. This allows access to the framebuffer and allows the <code>mmap</code> operation to succeed.</p></li><li><p><code>WSDISPLAYIO_MODE_DUMBFB</code>: Set the display to mapped (framebuffer) mode. This is similar to <code>WSDISPLAYIO_MODE_MAPPED</code> and, for our purposes in the demo below, works the same. I haven’t found a concise description of how these two differ, but from my reading of the code, the “mapped” mode offers access to the framebuffer as well as device-specific control registers, whereas “dumb framebuffer” just exposes the framebuffer memory.</p></li></ul><p>In any case. Once we know that we have to switch the console device to a graphical mode before mapping the framebuffer, and having access to the pixel format described in the <code>fbinfo</code> structure… drawing something fun is just a few byte manipulation operations away:</p><pre><code>// wsdisplay-draw.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-draw.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
// Ensure the framebuffer aligns with the expectations of our demo
// code below.
if (fbinfo.fbi_bitsperpixel != 32)
errx(1, \"bitsperpixel not supported by this demo\");
if (fbinfo.fbi_pixeltype != WSFB_RGB)
errx(1, \"pixeltype not supported by this demo\");
// Configure the wsdisplay to enter \"dumb framebuffer\" mode.
unsigned int mode = WSDISPLAYIO_MODE_DUMBFB;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1)
err(1, \"ioctl failed\");
// Map the framebuffer memory.  Must come after the SMODE ioctl.
uint32_t *ptr = (uint32_t*)mmap(
0, fbinfo.fbi_fbsize, PROT_READ | PROT_WRITE, MAP_SHARED,
fd, fbinfo.fbi_fboffset);
if (ptr == MAP_FAILED)
err(1, \"mmap failed\");
// Fill the screen multiple times with pixels of different
// colors to render a simple animation.
size_t pixels = fbinfo.fbi_fbsize / sizeof(uint32_t);
int off = 0;
for (int i = 0; i < 100; i++) {
int r = off; int g = off; int b = off;
for (size_t i = 0; i < pixels; i++) {
r = (r + 1) % 255; g = (g + 2) % 255; b = (b + 3) % 255;
ptr[i] = 0
| (r << fbinfo.fbi_subtype.fbi_rgbmasks.red_offset)
| (g << fbinfo.fbi_subtype.fbi_rgbmasks.green_offset)
| (b << fbinfo.fbi_subtype.fbi_rgbmasks.blue_offset);
}
off += 10;
usleep(1);
}
// Configure the wsdisplay to enter \"console emulation\" mode.
// In other words: return to the console.
mode = WSDISPLAYIO_MODE_EMUL;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1) {
err(1, \"ioctl failed\");
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"26c68357-8900-4c06-a98e-3456d2792a08\",\"duration\":null}\"></div><p>Voila. We’ve got graphics without paying the X11 startup tax. Switching from the console to graphics is instantaneous, like in the good old mode 13h days.</p><h1><strong>Handling keyboard input</strong></h1><p>Rendering graphics is just half of the puzzle when writing an interactive application though. The other half is handling input. And, for that, we have to turn to the wskbd device.</p><p>After we switch the console to mapped mode, keystrokes don’t go to <code>stdin</code> anymore. We have to write code to explicitly read from an attached keyboard, and we can do this via the <code>/dev/wskbd0</code> device representing the first attached keyboard.</p><p>Once we open the keyboard device for reading, wscons sends us its own representation of events known as wsevents. We can write a trivial program to read one key press:</p><pre><code>// wskbd-trivial.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-trivial.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Wait for one key down press only.
for (;;) {
struct wscons_event ev;
int ret = read(fd, &ev, sizeof(ev));
if (ret == -1)
err(1, \"read failed\");
if (ev.type == WSCONS_EVENT_KEY_DOWN) {
printf(\"value: %d, char '%c'\\n\", ev.value, (char)ev.value);
break;
}
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>But… if we try to run it and press a key, say <code>k</code>, we might get:</p><pre><code># ./wskbd-trivial
value: 37, char '%'
# █</code></pre><p>Huh. We pressed <code>k</code> but the character we got is <code>%</code>. Not what we expected! Well, as it turns out, the “value” that wsevents report for key presses (37 in this case) is the raw keycode of the key. This is hardware-specific and needs to be translated to an actual symbol via a keymap.</p><p>One feature of wskbd is that it exposes the keymap as configured in the kernel so there is a single source of truth for the machine. We can query a portion of it with another program:</p><pre><code>// wskbd-map.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-map.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <dev/wscons/wsksymdef.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Allocate space for the biggest possible keymap.
struct wscons_keymap map[WSKBDIO_MAXMAPLEN];
memset(map, 0, sizeof(struct wscons_keymap) * WSKBDIO_MAXMAPLEN);
// Get the keymap from the device.
struct wskbd_map_data data;
data.maplen = WSKBDIO_MAXMAPLEN;
data.map = map;
if (ioctl(fd, WSKBDIO_GETMAP, &data) == -1)
err(1, \"ioctl failed\");
// Dump keymap entries.
printf(\"Keymap length: %u entries\\n\", data.maplen);
for (size_t i = 0; i < data.maplen; i++) {
// Skip printing entries that are not for letters.
if (map[i].command != KS_voidSymbol)
continue;
char normal = map[i].group1[0];
char shifted = map[i].group1[1];
if (normal < 'a' || normal > 'z')
continue;
printf(\"Keycode %zd: '%c', '%c'\\n\", i, normal, shifted);
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run it, we might get:</p><pre><code># ./wskbd-map
Keymap length: 222 entries
Keycode 16: 'q', 'Q'
Keycode 17: 'w', 'W'
Keycode 18: 'e', 'E'
Keycode 19: 'r', 'R'
Keycode 20: 't', 'T'
Keycode 21: 'y', 'Y'
Keycode 22: 'u', 'U'
Keycode 23: 'i', 'I'
Keycode 24: 'o', 'O'
Keycode 25: 'p', 'P'
Keycode 30: 'a', 'A'
Keycode 31: 's', 'S'
Keycode 32: 'd', 'D'
Keycode 33: 'f', 'F'
Keycode 34: 'g', 'G'
Keycode 35: 'h', 'H'
Keycode 36: 'j', 'J'
Keycode 37: 'k', 'K'
Keycode 38: 'l', 'L'
Keycode 44: 'z', 'Z'
Keycode 45: 'x', 'X'
Keycode 46: 'c', 'C'
Keycode 47: 'v', 'V'
Keycode 48: 'b', 'B'
Keycode 49: 'n', 'N'
Keycode 50: 'm', 'M'
# █</code></pre><p>This dump is telling us how keycodes map to symbols, both in “normal” and in shifted form. If we look up keycode 37, we indeed find the letter <code>k</code>. With this, it’s just an <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">SMOP</a> to come up with a program that parses the keymap as exposed by wskbd and converts keycodes to something useful.</p><p>This is all good and dandy, but what happens if the keyboard is not connected when you try to open <code>/dev/wskbd0</code>? (Spoiler: the <code>open</code> call fails.) Or what happens if your computer has more than one keyboard attached? (Spoiler: you can only read events from one.) This is where wsmux comes to the rescue—a device driver that multiplexes multiple input devices into one.</p><p>By default, the system reserves <code>/dev/wsmux0</code> as the multiplexer for all attached mice and <code>/dev/wsmux1</code> as the multiplexer for all attached keyboards. We can define our own too via the <a href=\"https://man.netbsd.org/wsmuxctl.8\">wsmuxctl(8)</a> command line utility.</p><p>wsmux then supports “hot plugging”. You can then open a <code>/dev/wsmuxN</code> device even when there is no physical hardware attached, and whenever a peripheral is connected, it automatically becomes part of the mux. So, if we modify the program above to open <code>/dev/wsmux1</code> instead of <code>/dev/wskbd0</code>, the program will be resilient to missing keyboards and it’ll recognize multiple keyboards. Easy peasy!</p><h1><strong>What will you build?</strong></h1><p>You are now equipped with the basics to write graphical applications on a NetBSD system (and maybe OpenBSD too) without running X11. I know NetBSD may not be your jam, but it is a good choice for embedded projects due to its console architecture and other features like <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">its build system</a>.</p><p>If the code above still seems mysterious, you can read the source code for the <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-video-wsfb/\">xf86-video-wsfb</a> and <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-input-ws/\">xf86-input-ws</a> drivers for X.org. The code is easy enough to read, although it is longer because it has to support all the bells and whistles of wsdisplay and wskbd. (I took shortcuts above by making various assumptions on pixel formats and the like.)</p><p>And, guess what, I am indeed working on an embedded project! A little dev box that can boot straight into EndBASIC with super-fast boot times and for which I couldn’t afford the X11 startup penalty.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"d3e4a900-0eb8-4548-91af-41244b377297\",\"duration\":null}\"></div><p>Stay tuned. In the meantime, what will <em>YOU</em> build? For those of us in the U.S., there is a 3-day weekend ahead and this can be a good distraction. Have fun!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you enjoyed this walk-through, don’t hesitate to subscribe to Blog System/5. It’s free and you’ll receive more articles like this one.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "0.0" "image/jpeg") nil "55615f8d584644879b2d6b3ac71f61c5") (36 (26623 25868 504941 880000) "https://blogsystem5.substack.com/p/glibc-versions-runtime" "Picking glibc versions at runtime" "Julio Merino" "Sun, 11 Aug 2024 08:15:13 +0000" "<p>In a recent work discussion, I came across an argument that didn’t sound quite right. The claim was that we needed to set up containers in our developer machines in order to run tests against a modern glibc. The justifications were that using <code>LD_LIBRARY_PATH</code> to load a different glibc didn’t work and statically linking glibc wasn’t possible either.</p><p>But… running a program against a version of glibc that’s different from the one installed on the system seems like a pretty standard requirement, doesn’t it? Consider this: how do the developers of glibc test their changes? glibc has existed for much longer than containers have. And before containers existed, they surely weren’t testing glibc changes by installing modified versions of the library over the system-wide one and YOLOing it.</p><p>So. What options do we really have? To answer this question, we need to look at how dynamic binaries work and what glibc is.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Static binaries</h1><p>Static binaries are binaries whose program code is all contained in one executable. Such binaries can access system services via system calls—or else their utility would be minimal because they wouldn’t be able to interact with the OS—but their binary code is, in a sense, “complete”: what you see in the executable is exactly what gets laid out in memory for execution.</p><p>Here is how a sample static binary looks like. This is for a “hello world” program written in Go, which was the easiest thing to put together because Go is designed to bypass the C library <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">almost everywhere</a>:</p><pre><code><code>$ file hello_go
hello_go: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=2H_kXH_UFAOR5K6ibAke/aj_2VBvakhN2KujNxtMN/K5TtKP8HHiX65VdbA19s/KxdoZHQEiOxCEbwRE346, with debug_info, not stripped
$ █</code></code></pre><p>In the above, note that <code>file</code> claims that our sample <code>hello_go</code> program is <em>statically linked</em>.</p><p>When we ask the shell to run this <code>hello_go</code> binary, the shell forks a new process and uses the <code>exec(2)</code> family of system calls to replace the running image of the process with the content of <code>hello_go</code>. And because <code>hello_go</code> is statically linked, the text segment of the binary is loaded verbatim into the process.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" width=\"761\" height=\"261\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/edd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":261,\"width\":761,\"resizeWidth\":null,\"bytes\":9791,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how a static binary is directly mapped into a process when executed.</figcaption></figure></div><h1>Dynamic binaries</h1><p>Let’s compare the above to a dynamically-linked binary by looking at the same “hello world” program written in C and linked against glibc:</p><pre><code><code>$ file hello_c
hello_c: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=feeb95b014ef8151780e23fc7ca15de0599f05df, for GNU/Linux 3.2.0, not stripped
$ █</code></code></pre><p>Note that <code>file</code> now claims that our sample <code>hello_c</code> program is <em>dynamically linked</em> and, indeed, if we look at its libraries—quick reminder: <a href=\"https://jmmv.dev/2023/07/ldd-untrusted-binaries.html\">don’t use ldd on untrusted executables</a>!—we see that glibc (<code>libc.so.6</code>) is there:</p><pre><code><code>$ ldd hello_c
linux-vdso.so.1 (0x00007f54f25aa000)
libc.so.6 => /lib64/libc.so.6 (0x00007f54f239b000)
/lib64/ld-linux-x86-64.so.2 (0x00007f54f25ac000)
$ █</code></code></pre><p>But wait a second. There is more than just <code>libc.so.6</code> in the output of <code>ldd</code>. In particular, there is this other <code>/lib64/ld-linux-x86-64.so.2</code> “library” and, if you pay close attention to the earlier output of <code>file</code>, you’ll note that it claims that this is an <em>interpreter</em>. Why is there an “interpreter” if we are running machine code?! Did they lie to us when they said C was a compiled language?</p><p>Not so fast, no. “Interpreter” in this case should be read as “loader”, but the “interpreter” word comes from the nomenclature of the ELF headers stored in the program:</p><pre><code><code>$ readelf -l hello_c
Elf file type is EXEC (Executable file)
Entry point 0x401040
There are 13 program headers, starting at offset 64
Program Headers:
Type           Offset             VirtAddr           PhysAddr
FileSiz            MemSiz              Flags  Align
...
INTERP         0x0000000000000318 0x0000000000400318 0x0000000000400318
0x000000000000001c 0x000000000000001c  R      0x1
[Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
...
$ █</code></code></pre><p>To understand what this interpreter thing is all about, we need to look at what a dynamically-linked executable is. In essence, the program code in the binary is not <em>complete</em>: the code contains “gaps” in it that need to be filled with references to portions of code supplied by other libraries before it can begin executing. We can peek into what these “gaps” are:</p><pre><code><code>$ readelf -r hello_c
Relocation section '.rela.dyn' at offset 0x4c0 contains 2 entries:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000403fd8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 __libc_start_main@GLIBC_2.34 + 0
000000403fe0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0
Relocation section '.rela.plt' at offset 0x4f0 contains 1 entry:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000404000  000200000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
$ █</code></code></pre><p><code>readelf</code> tells us that the <code>hello_c</code> binary has three different “relocations”: in other words, it has three different “gaps” that need to be patched at runtime with the address of the code that supplies those symbols. The program <em>cannot run</em> without those being filled in first. So if it cannot begin executing before those references are resolved, how does the program run?</p><p>You might think that the kernel is somehow responsible for dealing with dynamic libraries, but that’s not the case. Dynamic libraries are a user-space concept and this is precisely where the interpreter comes into play.</p><p>When we ask the kernel to <code>exec(2)</code> a dynamically-linked ELF binary, the kernel loads the <em>interpreter</em> into the process image, <em>not</em> the code of the binary, and passes the path of the binary to the interpreter.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" width=\"761\" height=\"521\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":521,\"width\":761,\"resizeWidth\":null,\"bytes\":36593,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how a dynamic binary is loaded into memory with the help of the dynamic linker, along with glibc and the fixup of a relocation.</figcaption></figure></div><p>The interpreter, <a href=\"https://man7.org/linux/man-pages/man8/ld.so.8.html\">ld-linux.so</a> in our case, is then in charge of setting up the remaining of the process by loading all required shared libraries into the process and then resolving relocations (“filling the gaps”) among them. In particular, the dynamic linker is the one that loads glibc into the process.</p><p>We can see that this is the case by asking the dynamic linker to print its own file accesses by setting <code>LD_DEBUG=files</code>:</p><pre><code><code>$ LD_DEBUG=files /lib64/ld-linux-x86-64.so.2 ./hello_c
75369:     file=./hello_c [0];  generating link map
75369:       dynamic: 0x0000000000403e08  base: 0x0000000000000000   size: 0x0000000000004010
75369:         entry: 0x0000000000401040  phdr: 0x0000000000400040  phnum:                 13
75369:
75369:
75369:     file=libc.so.6 [0];  needed by ./hello_c [0]
75369:     file=libc.so.6 [0];  generating link map
75369:       dynamic: 0x00007f9aad868960  base: 0x00007f9aad682000   size: 0x00000000001f0b70
75369:         entry: 0x00007f9aad6ac260  phdr: 0x00007f9aad682040  phnum:                 14
75369:
75369:
75369:     calling init: /lib64/ld-linux-x86-64.so.2
75369:
75369:
75369:     calling init: /lib64/libc.so.6
75369:
75369:
75369:     initialize program: ./hello_c
75369:
75369:
75369:     transferring control: ./hello_c
75369:
Hello, world!
75369:
75369:     calling fini:  [0]
75369:
75369:
75369:     calling fini: /lib64/libc.so.6 [0]
75369:
75369:
75369:     calling fini: /lib64/ld-linux-x86-64.so.2 [0]
75369:
$ █</code></code></pre><p>As a final note, see how I chose to invoke the dynamic linker <em>explicitly</em>—just as the kernel would do when asked to launch a dynamically-linked binary—instead of directly running <code>hello_c</code>.</p><h1>Playing with glibc</h1><p>OK, now that we know how a dynamically-linked ELF executable is loaded into memory, let’s play with glibc.</p><p>First, we download glibc, build and install it into a temporary directory like <code>/tmp/sysroot/</code>:</p><pre><code><code>$ git clone https://sourceware.org/git/glibc.git
$ cd glibc
glibc$ git checkout release/2.40/master
glibc$ mkdir build
glibc/build$ ../configure --prefix=/tmp/sysroot
glibc/build$ make -j $(nproc)
glibc/build$ make -j $(nproc) install
glibc/build$ █</code></code></pre><p>With that done, we should be able to use the new glibc. But…</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib ./hello_c
Floating point exception (core dumped)
$ █</code></code></pre><p>Kaboom.</p><p>Indeed, as my coworker claimed, it doesn’t seem to be possible to load a different glibc at runtime than the one provided by the system. (YMMV. I got this to work on another system.) Looking at the stack trace of the core dump, we see:</p><pre><code><code>Stack trace of thread 75841:
#0  0x00007f227d93903b n/a (/tmp/sysroot/lib/libc.so.6 + 0x15403b)
#1  0x00007f227d9f19f6 _dl_sysdep_start (ld-linux-x86-64.so.2 + 0x1c9f6)
#2  0x00007f227d9f335e _dl_start_final (ld-linux-x86-64.so.2 + 0x1e35e)
#3  0x00007f227d9f2048 _start (ld-linux-x86-64.so.2 + 0x1d048)</code></code></pre><p>Our process is crashing within glibc as soon as it is loaded by <code>ld-linux.so</code>. The details of the crash are not interesting for our purposes, but can we do anything about them?</p><h1>Playing with the dynamic linker</h1><p>What’s more interesting is to peek into what’s shipped by glibc. We can do this by looking under the <code>/tmp/sysroot/</code> hierarchy that we generated earlier and finding:</p><pre><code><code>$ ls /tmp/sysroot/lib/
...
ld-linux-x86-64.so.2
...
libc.so
libc.so.6
...
$ █</code></code></pre><p>There is <em>a ton</em> more stuff in there. But what’s important to notice is that <em>the dynamic linker ships with glibc</em>. The two are closely coupled, and using one without the other can lead to the kinds of crashes shown earlier.</p><p>And remember: as we saw above, it is possible to manually launch the dynamic linker. So if we do the following:</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We don’t get a crash anymore. What’s even better is that we also <em>seem</em> to get what we expect without even setting <code>LD_LIBRARY_PATH</code>:</p><pre><code><code>$ /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We should confirm that the previous invocation of <code>hello_c</code> is actually using our own glibc version and not the system-supplied one. To do that, we can <code>strace</code> the dynamic linker; it’s just a program after all:</p><pre><code><code>$ strace /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Indeed, <code>hello_c</code> did use the newly-built glibc by “just” asking the newly-built dynamic loader to execute the binary.</p><p>To summarize, glibc ships both the <code>ld-linux.so</code> dynamic linker and the <code>libc.so.6</code> shared library. The two are closely coupled. Running a binary against the C library without also using a matching dynamic linker can lead to crashes. But running a binary directly with a specific dynamic linker ensures that the binary picks up the matching C library.</p><h1>Putting this to use</h1><p>Alright, now that we know that it is actually possible to run a binary against a version of glibc that’s <em>not</em> the one provided by the system, we can try to solve the original problem we faced: running tests against a modern glibc.</p><p>One possibility is to modify the commands used to run the tests to prefix them by <code>.../lib/ld-linux-x86-64.so.2</code>. This could work but I posit is difficult to integrate with a test execution environment because we don’t necessarily control the commands that end up executing the test binaries.</p><p>Another possibility is to modify the way the tests programs are being built by supplying additional linker arguments—say, via the traditional <code>LDFLAGS</code>—to point the linker at a different interpreter with the <code>--Wl,--dynamic-linker</code> flag:</p><pre><code><code>$ cc -o hello_c -Wl,--dynamic-linker=/tmp/sysroot/lib/ld-linux-x86-64.so.2 hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Better. Now the built binary “knows” which glibc to use without us having to specify it explicitly every time we attempt to launch the program.</p><p>What if we aren’t <em>building</em> the binaries? What if we are just reusing a binary that already exists? <code>patchelf</code> to the rescue:</p><pre><code><code>$ cc -o hello_c hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/lib64/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ patchelf --set-interpreter /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Voila. We have modified an existing executable to use whichever glibc we desire.</p><h1>Versioning glibc</h1><p>But hold on a second. Can we use <em>whichever</em> glibc really? Is it actually true that glibc versions are completely interchangeable? Unfortunately not.</p><p>A binary built against an old version of glibc is guaranteed to run against a newer version of glibc without recompilation. But the counterpart is not true: a binary built against a new glibc may not run against an older glibc.</p><p>This poses a problem: how can we upgrade glibc across separate production and development environments? If we upgrade production first, binaries built in development environments will continue to work properly but developers may not be able to reproduce bugs found in production. And if we upgrade development environments first, the binaries they produce may be incompatible with production, leading to random crashes later on.</p><p>Here is an idea I’ve seen work in the past: let’s extend the sysroot concept presented above and version it!</p><p>We start with <code>/usr/sysroot/v1/</code> which contains the first version of the core system libraries we have to support. All binaries that we build for production deployment are explicitly linked against the <code>ld-linux.so</code> of this directory, so they are always validated against <code>v1</code> of the sysroot. <code>v1</code> remains immutable, which means new builds of the binaries will continue to work as tested in the past.</p><p>Whenever we want to upgrade glibc, we create a <em>new</em> sysroot, <code>/usr/sysroot/v2/</code>. This new <code>v2</code> is deployed to all environments (development and production) that may need to use the new glibc. This deployment step is risk-free because nothing is yet dependent on <code>v2</code>. After that, we proceed to rebuild all binaries that we want to test and run, this time pointing at the <code>ld-linux.so</code> within <code>v2</code>. Deploying these new binaries causes them to use the new version.</p><p>As long as the <code>/usr/sysroot/</code> subdirectories remain immutable and synchronized across all environments in which binaries run, we are guaranteed to always get a deterministic version of glibc for a given binary.</p><p>That’s just a design sketch though. It may or it may not work for you. As I mentioned earlier, I’ve seen this work well in a large corporate environment before, but it introduces some extra complexity that you need to take care of.</p><div><hr></div><p>What’s the moral of the story? Containers are, usually, not the best solution to a systems problem. While they might be coerced to deliver the desired results, they come with a heavy cost. Unix has been around for a long time and there exist alternate solutions to problems that don’t require full replicas of a functioning system. A ton of the bloat we face today in development tools and deployments comes from the abuse of heavyweight containers. So, every time you think “containers!”, pause to explore alternatives—you may find cheaper, more portable, and simpler solutions.</p><p>If you want to learn more about this and related topics, I’d recommend grabbing a copy of the classic <a href=\"https://www.amazon.com/Linkers-Kaufmann-Software-Engineering-Programming/dp/1558604960?&linkCode=ll1&tag=blogsystem5-20&linkId=421e6bc20c93925de6766b135a24239a&language=en_US&ref_=as_li_ss_tl\">“Linkers and Loaders” book</a>. It’s old, but it’s still very relevant.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "0.0" "image/jpeg") nil "77deee49632248ca4e4df20bc49b580e") (35 (26623 25868 502636 207000) "https://blogsystem5.substack.com/p/crowdstrike-and-rust" "Rust doesn't solve the CrowdStrike outage" "Julio Merino" "Tue, 23 Jul 2024 14:10:43 +0000" "<p>Look, I like Rust. I really, really do, and I agree with the premise that memory-unsafe languages like C++ should not be used anymore. But claiming that Rust would have <em>prevented</em> the massive outage that the world went through last Friday is misleading and actively harmful to Rust’s evangelism.</p><p>Having CrowdStrike written in Rust would have <em>minimized</em> the chances of the outage happening, but not resolved the root cause that allowed the outage to happen in the first place. Thus, it irks me to see various folks blanket-claiming that Rust is the answer. It’s not, and pushing this agenda hurts Rust’s adoption more than it helps: C++ experts can understand the root cause and see that this claim is misleading, causing further divide in the systems programming world.</p><p>So, why won’t Rust help? Let me try to answer that question, but while we are at it, let’s also delve deeper into the causes of the outage. In a way, let me put my SRE hat on and write my own version of the postmortem.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":343660,\"alt\":\"\",\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"></div></div></a></figure></div><h1>The outage</h1><p>Here is what <a href=\"https://www.crowdstrike.com/blog/falcon-update-for-windows-hosts-technical-details/\">CrowdStrike’s official “postmortem”</a> has to say about the problem that the industry faced:</p><blockquote><p>On July 19, 2024 at 04:09 UTC, as part of ongoing operations, CrowdStrike released a sensor configuration update to Windows systems. Sensor configuration updates are an ongoing part of the protection mechanisms of the Falcon platform. This configuration update triggered a logic error resulting in a system crash and blue screen (BSOD) on impacted systems.</p><p>The sensor configuration update that caused the system crash was remediated on Friday, July 19, 2024 05:27 UTC.</p></blockquote><p>Paraphrasing:</p><ol><li><p>CrowdStrike (the company) pushed a configuration change.</p></li><li><p>The change tickled a latent bug in “the Falcon platform” (the product).</p></li><li><p>This bug in Falcon resulted in a crash that brought down Windows.</p></li></ol><p>The first two points are not too strange: configuration changes are “business as usual” for any online system and having changes tickle bugs in code is unfortunately common. In fact, the majority of the outages (citation needed) are caused by human-initiated configuration changes.</p><p>Obviously, we should ask why the bug existed and how it could be remediated in order to increase the robustness of the product. But we must also question the third point: why was the bug able to bring down the whole machine? And, much more importantly, why did this bug bring down <em>so many systems</em> across the world?</p><h1>The memory bug</h1><p>Let’s start with the first question: what was the nature of the bug in Falcon?</p><p>Easy: there was a logic bug in the “Channel Files” (aka configuration files) parser that, given some invalid input, made the code try to access an invalid memory position. The details are really not interesting: this could be have been a null pointer dereference, a general protection fault, or whatever. The point is: the crash was triggered by an invalid memory access issue.</p><p>And this is where some Rust enthusiasts will zero in and say “Ah-HAH! We got you, fools. If the code had been written in Rust, this bug would not have existed!” And, you know what, that’s literally true: this specific bug would not have happened.</p><p>But so what? Avoiding this specific type of error would just have delayed this outage until another time when a different class of error that Rust doesn’t protect against happened. (This is the exact same argument I raised in a <a href=\"https://jmmv.dev/2018/07/forbidden-assertions-fallacy.html\">critique of forbidding assertions in Go</a> back in 2018 by the way.) Focusing on the memory bug is missing the forest for the trees because of the nature of what Falcon is.</p><p>OK so, what is Falcon?</p><h1>The kernel crash</h1><p>Falcon is “malware… but for the good guys”. Oops, I mean: Falcon is an endpoint security system. Falcon is a product typically installed on corporate machines so that the security team can detect and mitigate threats in real time (while monitoring the actions of their employees). There <em>is</em> some value in this: most cyberattacks (citation needed again) start by compromising corporate machines, often via social engineering practices.</p><p>This type of product must have control over the machine. It must be able to intercept all user file and network operations to scan their content. And it must be tamper-proof so that “savvy” corporate users don’t disable it when they read sketchy online instructions to fix their broken WiFi in an attempt to (<em>shudder</em>) not have to create IT tickets.</p><p>How can you <em>implement</em> a product like Falcon? The easiest approach, and the approach that Windows encourages, is to write a kernel module. It easily follows that Falcon is a kernel module and, as such, it runs in kernel space. This means that any mess up in Falcon’s code can damage the running kernel and, in turn, bring the whole system down.</p><p>And when I say “any mess up”, I really mean it. The kernel is not only brought down by memory errors, and you don’t have to “crash the kernel” to make a machine unusable. Think of a deadlock preventing the kernel from making forward progress. Think of a logic error in the <code>open(2)</code> system call handler preventing user space from opening any file later on. Think of mistakenly mapping file system code as pageable when it should never be paged out. Think of writing an unbounded recursive algorithm that exhausts the kernel’s stack. Think of… an innocent buggy <code>unwrap()</code> call if the code actually used Rust.</p><p>There are just too many ways to destroy the kernel’s stability, which is why claiming that Rust would have prevented this incident irks me. Rust’s memory-safety only addresses one type of crash. It is true, though, that the focus on correctness in the Rust ecosystem via strong types could minimize the chances of other types of logic bugs. But… as much as we want to reach perfection, we must accept that bugs happen, and asserting that Rust is <em>the only answer</em> to the problem is as negligent as sticking to C++.</p><p>And, you know, there are many more C++ developers that work in kernel space than Rust developers know kernel internals (oops, another citation need). So, naturally, a large portion of C++ developers can smell the rubbish in this claim. Which is unfortunate because this increases animosity between the two communities, which goes against the goal of converting folks to safe languages. Rust folks <em>know</em> that Rust can definitely help make the situation better, but C++ folks cannot get bought into it because the arguments they hear don’t resonate with them.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you are enjoying this article, consider subscribing to Blog System/5. It’s completely free, but paid subscriptions help support my writing and my open source software.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>From kernel space to user space</h1><p>There have <em>also</em> been other claims saying that this would not have happened at all if Falcon was <em>not</em> running in the kernel. OK, that’s a better take, but… it is not crystal-clear that this alone would help either.</p><p>As I mentioned earlier, Falcon needs to be as tamper-proof as possible to prevent malware from interfering with it and compromised users from trying to disable it. And if malware or humans were able to easily do that, then the product would be as useless as nothing.</p><p>Now, the Windows kernel could definitely forbid kernel modules for anything similar to Falcon. Instead, the kernel could expose a bunch of APIs so that user space applications could hook into them to expose similar functionality. And you know what? Microsoft <em><a href=\"https://news.microsoft.com/2009/12/16/microsoft-statement-on-european-commission-decision/\">did</a></em><a href=\"https://news.microsoft.com/2009/12/16/microsoft-statement-on-european-commission-decision/\"> try to move Windows in that direction</a>, but the antivirus mob threatened to sue on antitrust grounds and the whole thing went nowhere. So we are stuck with a less secure system because antivirus companies need to be able to sell their obnoxious products.</p><p>But let’s step aside from that dumpster fire for a moment. Even if Falcon ran in user space and communicated with the kernel via controlled APIs… would that be sufficient to prevent a system malfunction? Note that these APIs would need to be tamper-proof too. Imagine if, say, you wanted this user space driver to validate every binary before it’s executed by the kernel. If you make the kernel <em>require</em> an answer from the user space driver on every execution, and such driver is faulty, the system won’t be able to execute any program anymore. And if you make it <em>optional</em> for the kernel to communicate with the driver so that the kernel can tolerate a crashing driver, then you open up a path for malware to try to crash the driver first and then infiltrate the system.</p><p>Thus it is not obvious that “just moving to user space” is the answer here either. Oh, by the way, Apple has been moving macOS in the direction of disallowing kernel modules for years and providing alternative APIs to implement things like file systems and antivirus-type software without kernel privileges. They also have this kind of security daemon running in user space in the default system which validates process executions, and <a href=\"https://jmmv.dev/2017/10/fighting-execs-sandboxfs-macos.html\">drove me crazy a while back</a>.</p><h1>The bug is in the deployment</h1><p>If we must accept that bugs exist, that memory-related bugs are not the only ones that can kill a system, and that moving the driver to user space isn’t an obvious fix either… are we doomed? Is there nothing we could do to prevent this from happening?</p><p>The above are all things that could (and should!) be done to reduce the chances of a misbehavior happening, but we must accept that the code bug was just <em>the specific trigger this time around</em> and a different trigger could have had similarly nefarious consequences. The root cause behind the outage lies in the <em>process</em> to get the configuration change shipped to the world.</p><p>Now, SRE 101 (or DevOps or whatever you want to call it) says that configuration changes must be staged for slow and controlled deployment, and validated at every step. Those changes should first be validated in a very small scale before being pushed to the world later on, and every push should be incremental.</p><p>I find it quite hard to believe that CrowdStrike has nothing to validate deployments given the criticality of Falcon and the massive impact that a bug can have (and has had). Maybe they don’t have any process whatsoever as the external evidence seems to suggest, which would be incredibly negligent, <s>but let’s give them the benefit of the doubt</s>. (<strong>Update July 24th:</strong> According to CrowdStrike’s <a href=\"https://www.crowdstrike.com/falcon-content-update-remediation-and-guidance-hub/\">updated postmortem</a>, they actually <em>do not</em> have any sort of testing nor canarying. So it is indeed incredibly negligent.)</p><p>Part of why I say this is due to new information from Microsoft with an assessment of how many machines were impacted by the outage. Here is <a href=\"https://blogs.microsoft.com/blog/2024/07/20/helping-our-customers-through-the-crowdstrike-outage/\">what Microsoft has to say</a>:</p><blockquote><p>While software updates may occasionally cause disturbances, significant incidents like the CrowdStrike event are infrequent. We currently estimate that CrowdStrike’s update affected 8.5 million Windows devices, or less than one percent of all Windows machines. While the percentage was small, the broad economic and societal impacts reflect the use of CrowdStrike by enterprises that run many critical services.</p></blockquote><p>Read that: “less than 1% of the machines were impacted”. Does this mean that CrowdStrike <em>does</em> have a staged rollout in which they push configuration changes to just a subset of 1% of the machines worldwide? That doesn’t seem crazy actually and is in line with how many services are deployed, but if that’s their <em>first</em> step in the deployment process, it’s time to reevaluate their approach because this 1% of machines is way too many and has proven to be catastrophic. (This is leaving aside the question of whether 1% refers to the total number of Windows machines in the world or 1% of Windows machines with CrowdStrike on them.)</p><p>The question that remains answering, then, is what sort of testing happened between “the configuration change is done” to “let’s roll it out to 1% of the world”. <em>Did any testing happen at all?</em> That’s where it gets concerning and where we may not get any official information on the matter from CrowdStrike. (<strong>Update July 24th:</strong> We did get <a href=\"https://www.crowdstrike.com/falcon-content-update-remediation-and-guidance-hub/\">an update</a> and it confirms that they actually do not have any sort of rollout progressive deployment.)</p><p>So, yes, CrowdStrike’s deployment practices are definitely to blame for the incident. This outage <em>was a process problem</em>, not <em>a code/technology problem</em>.</p><h1>Downstream companies</h1><p>Before concluding, let’s shift away from CrowdStrike and look at the downstream companies impacted by this bad configuration push. Did you notice how many companies were absolving themselves from problems by pointing out that “due to a third-party IT incident” their service was down? OK, yes, that is literally true once again, but pointing fingers is not helpful.</p><p>The problem in this situation is the monoculture around CrowdStrike. Certain security certifications require “endpoint protection” as a line item and it seems perfectly plausible that most IT departments just deploy Falcon due to aggressive marketing from CrowdStrike’s part and call it a day without putting any more thought into it. It’s just not interesting to them to spend any extra time on the issue.</p><p>But this raises a problem: dependencies are always a liability, and when you choose to take a dependency on another vendor or another piece of code, you must own your choice. You must model how your own system will fail when the dependency fails, and then, if the risk warrants it, engineer a solution around the potential problem.</p><p>I do not know how Falcon works, so I cannot tell if CrowdStrike offered sufficient clarity on how upgrades work to customers or even if their product offers a way to control how the deployment of configuration changes happens within an organization. These are things that will have to be built so that the few customers that care can increase the reliability of their systems.</p><h1>Is there an attack vector?</h1><p>And finally, let’s talk about the last part of CrowdStrike’s official statement:</p><blockquote><p>This issue is not the result of or related to a cyberattack.</p></blockquote><p>Is that true? We may never know. It is unlikely that this <em>is</em> a cyberattack because crashing systems left and right doesn’t seem to serve a clear purpose. I guess you could claim that an attacker may have wanted to hide something <em>else</em> while the world was scrambling, and that might be possible, but… well, you can imagine all sorts of conspiracy theories.</p><p>What <em>is</em> interesting is this part of CrowdStrike’s official postmortem:</p><blockquote><p>Although Channel Files end with the SYS extension, <em>they are not kernel drivers</em>.</p></blockquote><p>Emphasis theirs. Funny, huh? They seem to be wanting to hide the fact that Falcon doesn’t run in the kernel. But it does. Knowing that these files are not drivers is not comforting: the kernel module is reacting to changes to these files and thus these files influence the behavior of the kernel. As a result, it seems plausible that malformed Channel Files could tamper with the kernel in ways that do not result in more subtle ways than just a blatant crash.</p><p>And <em>this</em> situation, my friend, is precisely where Rust would definitely help. Rust’s memory safety would minimize the chances that a malformed configuration file could exploit bugs like buffer overflows to escalate privileges within the kernel, resulting in much more subtle, but dangerous, attacks.</p><p>But that’s not what happened this time around.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg" "0.0" "image/jpeg") nil "0c493f96e84f5d7bd354f29168b477a5") (34 (26623 25868 498998 811000) "https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an" "Porting the EndBASIC console to an LCD" "Julio Merino" "Fri, 26 Apr 2024 20:31:02 +0000" "<p>Hello again Blog System/5 and sorry for the radio silence for the last couple of months. I had been writing too much in here and neglecting my side projects so I <em>needed</em> to get back to them. And now that I’ve made significant progress on cool new features for <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, it’s time to write about them a little!</p><p>One of the defining characteristics of EndBASIC is its hybrid console: what looks like a simple text terminal at first glance can actually render overlapping graphics and text <em>at the same time</em>. This is a feature that I believe is critical to simplify learning and it first appeared with <a href=\"https://jmmv.dev/2021/11/endbasic-0.8.html\">the 0.8 release</a> back in 2021.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" width=\"852\" height=\"452\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":452,\"width\":852,\"resizeWidth\":null,\"bytes\":45704,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">EndBASIC's hybrid console running in the web browser, rendering text and overlapping graphics at once, all controlled from the built-in command prompt.</figcaption></figure></div><p>A few months before that, I had added support for simple GPIO manipulation in <a href=\"https://jmmv.dev/2021/02/endbasic-0.6.html\">the 0.6 release</a> and, around that same time, I impulse-bought a tiny LCD for the Raspberry Pi with the hope of making the console work on it. But life happened and I lost momentum on the project… until recently.</p><p>In this post, I’ll guide you through the process of porting the EndBASIC hybrid console to the ST7735s 1.44\" LCD shown below, which sports a resolution of 128x128 pixels, a D-pad, and 3 other buttons. I will cover the prerequisite work to make the port possible, dig into the GPIO and SPI interface of an LCD, outline the design for a fast rendering engine, and conclude with pointers for you to build your own “developer kit”. Let’s go!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":838133,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The <a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">ST7735s 1.44\" LCD</a>. Photo from back when I first unboxed this little device... on February 7th, 2021.</figcaption></figure></div><h1>Previous implementation</h1><p>Even though I had plans to support graphics in the EndBASIC console from the very beginning, the first versions of the product did <em>not</em> support graphics. That fact didn’t prevent me from defining a <code>Console</code> abstraction anyway because I needed to support various operating systems and, more importantly, write <a href=\"https://jmmv.dev/2020/12/unit-testing-a-console-app.html\">unit tests for the console</a>. Such abstraction was a straightforward trait representing text-only operations, like this:</p><pre><code><code>trait Console {
fn clear(&mut self, how: ClearType) -> io::Result<()>;
fn color(&self) -> (Option<u8>, Option<u8>);
fn print(&mut self, text: &str) -> io::Result<()>;
// ... and more text operations ...
}</code></code></pre><p>Later on, when the time came to add graphics support, I extended the <code>Console</code> trait with additional rendering primitives, like this:</p><pre><code><code>trait Console {
// ... same as previous ...

fn draw_circle(&mut self, _center: PixelsXY, _radius: u16)
-> io::Result<()>
{
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}

fn draw_pixel(&mut self, _xy: PixelsXY) -> io::Result<()> {
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}
// ... and more graphics operations ...
}</code></code></pre><p>What constitutes a primitive or not depends on the graphics device. In the snippet above, it’s fairly easy to understand why <code>draw_pixel</code> exists. But why is <code>draw_circle</code> there? SDL2, for example, does not provide a circle drawing primitive and forces you to implement your own algorithm on top of individual pixel plotting. However, the HTML <code>canvas</code> element <em>does</em> provide such a primitive and thus it is important to expose access to it for performance reasons.</p><p>A reasonable design, right?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to support my writing and my work in projects like EndBASIC. It’s free but donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Not quite. The problem is that mixing the textual and graphical operations under just one abstraction bundles two concepts together. Take, for example, the innocent-looking <code>print</code> function: writing text to the console requires knowing the current cursor position, writing text at that location, wrapping long lines, and then updating the cursor position and moving its glyph. This sequence of operations is given to us “for free” when the <code>Console</code> is backed by a terminal—the kernel or terminal emulator handle all details—but none of this exists when you stare at a blank graphical canvas.</p><p>As a result, the SDL2 and the HTML canvas console implementations had to supply their own code to represent a textual console on top of their backing graphical canvases. But due to tight timelines—I wanted to release graphics support <a href=\"https://vimeo.com/641791002\">in time for a conference</a>—I ended up with <em>a lot</em> of copy/pasted code between the two. Unfortunately, it wasn’t just copy/pasted code. Oh no. It was copy/pasted code with minor variations throughout. For example: SDL2 coordinates are <code>i32</code> whereas HTML canvas coordinates are <code>float</code>s.</p><p>This duplication with minor differences required unification before attempting to write a console driver for the LCD because I could not afford to introduce yet another duplicate of the same code.</p><h1>Past NetBSD experience to the rescue</h1><p>The first step to resolving this conundrum was to unify the implementation of the two graphical consoles as much as possible. Having worked on <a href=\"https://www.netbsd.org/docs/guide/en/chap-cons.html\">NetBSD’s wscons console framework</a> eons ago, I knew how this had to be done.</p><p>The idea was to separate the text console manipulation from the underlying graphics primitives. As you can imagine, the way to do this was via a new abstraction, <code>RasterOps</code>, providing direct access to the “raster operations” of the graphics device. Take a look:</p><pre><code><code>trait RasterOps {
fn draw_circle(&mut self, center: PixelsXY, radius: u16)
-> io::Result<()>;
fn draw_pixel(&mut self, xy: PixelsXY) -> io::Result<()>;
fn move_pixels(&mut self, x1y1: PixelsXY, x2y2: PixelsXY,
size: SizeInPixels) -> io::Result<()>;
fn write_text(&mut self, xy: PixelsXY, text: &str)
-> io::Result<()>;
// ... and more operations ...
}</code></code></pre><p>As you can see in this snippet, the earlier operations <code>draw_circle</code> and <code>draw_pixel</code> exist as raster operations because some devices may provide them as primitives. But we now see other functions like <code>move_pixels</code> and <code>write_text</code> (which differs from <code>print</code> because it writes text at a specific pixel location, not at the “current cursor position”) and these are meant to expose other primitives of the device.</p><p>Having done this, I added a new <code>GraphicsConsole</code> type that encapsulates the logic to implement a terminal backed by an arbitrary graphical display, and then relies on a specific implementation of the <code>RasterOps</code> trait to do the screen manipulation:</p><pre><code><code>impl<RO> Console for GraphicsConsole<RO>
where
RO: RasterOps,
{
// ... implement Console in terms of RasterOps ...
}</code></code></pre><p>Most details of this refactor are uninteresting at this point, except for the fact that it eliminated all of the tricky duplicate code between the SDL2 and HTML canvas variants. A side-effect was that these changes increased my confidence in the HTML canvas variant because most code was now unit-tested indirectly via the SDL2 implementation. Here is how the simplification looked like:</p><pre><code><code>$ wc -l {before,after}/sdl/src/host.rs {before,after}/web/src/canvas.rs
1245 before/sdl/src/host.rs
887 after/sdl/src/host.rs     # 358 fewer lines
760 before/web/src/canvas.rs
444 after/web/src/canvas.rs   # 320 fewer lines</code></code></pre><p>I was now ready to reuse the <code>GraphicsConsole</code> to quickly provide a new backend on top of the LCD.</p><h1>Playing with the C interface</h1><p>With the foundational abstractions in place, it was time to prove that my idea of rendering the EndBASIC console on the tiny LCD was <s>feasible</s> cool enough to pursue. But I knew absolutely nothing about the LCD so, before diving right into the “correct” implementation, I had to create a prototype to get used to its API.</p><p>Fortunately, I found an “SDK”—and I put it in quotes because SDK is quite an overstatement—for the LCD somewhere online. The SDK consists of a pair of C and Python libraries that provide basic graphics drawing primitives, text rendering, and access to the D-pad and the buttons. This was a “perfect” finding because the code was simple enough to understand, functional enough to build a prototype, and allowed me to skip reading through the data sheet.</p><p>So I chose to do the easiest thing: I folded the C library into EndBASIC using Rust’s C FFI and quickly implemented a <code>RasterOps</code> on it. With that, I could instantiate a <code>GraphicsConsole</code> backed by the LCD and demonstrate, in just a couple of hours before the crack of dawn, that the idea was feasible. And it was more than feasible: it was super-exciting! Here, witness the very first results:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"413e7dc0-ef87-4c65-acb9-ebe4475e2128\",\"duration\":null}\"></div><p><em>(Caption: First prototype of the EndBASIC console on the ST7735s LCD display, reusing the vendor-provided C library from Rust with lots of hacks.)</em></p><p>But performance was also awful. Using the C library was enough to show that this idea was cool and worth pursuing, but it was not the best path forward. On the one hand, the code in the C library was rather crappy and fragile to integrate into Rust via <code>build.rs</code>; and, on the other hand, I needed precise control of the hardware primitives to achieve good rendering performance levels.</p><h1>The LCD hardware interface</h1><p>Before diving into the solution, let’s take a quick peek at the hardware interface of the LCD. Note that this is just a very simplified picture of what the LCD offers and is derived from my reverse-engineering of the code in the SDK. I’m sure there is more to it, but I do not have the drive to go through the aforementioned data sheet.</p><p>The LCD is a matrix of pixels where each position contains an integer representing the color of the pixel. The representation of each color value depends on the selected pixel format, but what the SDK uses by default is RGB565: a 16-bit value decomposed into two 5-bit quantities for red and blue and one 6-bit quantity for green.</p><p>This is pretty standard stuff for a framebuffer-style device but the mechanism to write to the LCD is different. Unlike most framebuffer devices backed by video cards, the LCD matrix is not memory-mapped: we have to issue specific reads and writes via the GPIO and SPI busses. The GPIO bus is used to control hardware registers and the SPI bus is used to transfer large data sequences.</p><p>Simplifying, the LCD offers just two primitives. The first is a “set window” operation to define the window for rendering. This tells the LCD what rectangular region to update with new pixel values on the <em>subsequent</em> “set data” operation. Executing this operation requires a GPIO write to select the operation followed by an SPI write to set the window position and dimensions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":37047,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set window\" operation.</figcaption></figure></div><p>The second is a “set data” primitive to set the contents of the previously-defined window. This primitive just sends a stream of pixel color values that will be written on the window, top-left to bottom-right. Executing this operation requires a GPIO write to select the operation followed by a “very large” SPI write to write the pixel data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":35405,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set data\" operation.</figcaption></figure></div><p>By default, SPI writes on Linux are limited to 4KB in size and the full LCD content is 128x128 pixels * 2 bytes per pixel = 32KB, which means drawing the whole LCD requires 8 separate SPI writes. (It is possible to raise the default via a kernel setting, which I did too, but let’s ignore that for now.)</p><p>Understanding that the LCD hardware interface is as simple and constrained as this is super-important to devise an efficient higher-level API, which is what we are going to do next.</p><h1>Double-buffering</h1><p>Having figured out the native interface, I faced two problems.</p><p>The first one was performance. Issuing individual “set window” and “set data” commands works great to draw on large portions of the LCD, but sending these commands on a pixel basis as would be necessary to render letters or shapes like circles would be prohibitively slow.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1cb62fe-e6b1-40e8-86b6-43c2a43855db\",\"duration\":null}\"></div><p><em>(Caption: An EndBASIC demo program bouncing a bunch of rectangles on the screen running with the prototype console driver that relied on the C library without double-buffering or damage tracking.)</em></p><p>The second one was the inability to <em>read</em> the contents of the LCD. Certain operations of the console, like moving the cursor or entering/exiting the builtin editor, require saving portions of the screen aside for later restoration. The LCD does not offer an interface to read what it currently displays. (Actually I don’t know because I did not read the data sheet… but even if it does, the reads would involve slow SPI bus traffic which we should avoid.)</p><p>To address these two problems, I decided to implement double-buffering for the LCD: the console driver reserves a portion of main memory to track the content of the LCD and all operations that update the LCD first write to this buffer. This allows the code to decide <em>when</em> to send the buffer to the LCD, allowing it to compose complex patterns in memory—e.g. plotting letters pixel by pixel—before ever touching the GPIO and SPI busses. And this also allows trivially reading portions of the LCD.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":43655,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of the double-buffering and damage tracking techniques.</figcaption></figure></div><p>Which brings me to the next point. Part of this solution required adding damage tracking as well. Flushing the full in-memory buffer to the LCD is expensive—remember, with the default SPI configuration, we need to issue 8 separate writes to flush 32KB of data—and many times, like when moving the cursor around in the editor, this is not necessary. Therefore, it is important to keep track of the portion of the display that has been “damaged” by drawing operations and then only flush that portion of the buffer to the LCD. This maps perfectly well to the hardware primitives offered by the LCD.</p><p>With that in mind, and after a bit of iteration, I ended up splitting the implementation of the LCD <code>RasterOps</code> into two pieces. One is the <code>Lcd</code> trait, which exposes the basic “set window” and “set data” primitives of an LCD as a single <code>set_data</code> operation:</p><pre><code><code>trait Lcd {
fn set_data(&mut self, x1y1: LcdXY, x2y2: LcdXY, data: &[u8])
-> io::Result<()>;

// ... some more stuff ...
}</code></code></pre><p>The other is the <code>BufferedLcd</code> type, which implements the general idea of buffering and damage tracking on top of a generic <code>Lcd</code>:</p><pre><code><code>impl<L> RasterOps for BufferedLcd<L>
where
L: Lcd,
{
// ... implementation of RasterOps in terms of an Lcd ...
}</code></code></pre><p>This design keeps all of the complex logic in one place and, as was the case with the <code>Console</code> abstraction, allowed me to unit-test the tricky corner cases of the double-buffering and damage tracking by supplying a test-only <code>Lcd</code> implementation. This was critical during development because I wrote most of this code while I was on a trip without access to the device, and when I came back home, the “real thing” worked on the first try.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"0ccbf21e-29b2-408b-925c-8bf44056a91b\",\"duration\":null}\"></div><p><em>(Caption: Same EndBASIC demo program as before but running with the improved console that implements double-buffering and damage tracking. No more flickering.)</em></p><p>Invest in Rust and exhaustive unit testing! They really are worth it to deliver working software quickly. But I digress…</p><h1>Font rendering</h1><p>The last interesting part of the puzzle was rendering text. You see: for the previous graphical consoles I wrote based on SDL2 and the HTML <code>canvas</code> element, I was able to use <a href=\"https://www.ibm.com/plex/\">a nice TTF font</a>. But with the LCD… well, the LCD has no builtin mechanism to render text and the very restrictive 128x128 resolution means that most fonts would render poorly at small sizes anyway.</p><p>To solve this problem, I had to implement my own text rendering code, which sounds scary at first but isn’t as hard as it sounds. One issue was coming up with the font data, but the SDK for the LCD came with a free reusable 5x8 font that I took over. Another issue was coming up with a mechanism to efficiently render the letters because plotting them pixel by pixel on the LCD would be unfeasible, but this was solved by the previous buffering and damage tracking techniques.</p><p>Having my own font rendering code is interesting. If you used a BASIC machine back in the 1980s, the computer-supplied manual would show you the glyphs used by the machine like this page demonstrates:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" width=\"600\" height=\"840\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":840,\"width\":600,\"resizeWidth\":null,\"bytes\":240982,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Page 9 of Chapter 7 of the Amstrad CPC 6128 user manual showing the glyphs corresponding to characters 32–48.</figcaption></figure></div><p>In some machines like the Amstrad CPC 6128, you could use the <code>SYMBOL</code> command to define your own glyphs. And in some others, you could <code>POKE</code> the memory locations where the glyphs were stored to (re)define them. So I’m thinking that… maybe I should forget about the TTF font and instead expose a custom bitmap font in all EndBASIC consoles to allow for these neat tricks.</p><h1>Putting it all together</h1><p>And that’s all folks! Having gone through all the pieces involved in providing support for the LCD, we can now connect them all. Here is how the code on the <code>main</code> branch looks like with additional inline commentary:</p><pre><code><code>// Instantiate access to the GPIO bus, required to control the LCD and
// to read the status of the D-pad and buttons.
let mut gpio = Gpio::new().map_err(gpio_error_to_io_error)?;
// Build the struct used to interface with the LCD.
let lcd = ST7735SLcd::new(&mut gpio)?;
// Wrap the low-level LCD with the double-buffering and damage tracking
// features for high speed.
let lcd = BufferedLcd::new(lcd);
// Instantiate the input controller. I haven't covered this in the post
// because it's uninteresting.
let input = ST7735SInput::new(&mut gpio, signals_tx)?;
// Wrap the display and the buttons with the generic graphical console
// logic -- the same one used by the SDL2 and HTML canvas variants.
let inner = GraphicsConsole::new(input, lcd)?;</code></code></pre><p>Even though this looks complex, this composition of three different types keeps the responsibilities of each layer separate. The layers help make the logic simpler to understand, allow the possibility of supporting more LCDs with ease, and make unit-testing a reality. And thanks to Rust’s static dispatch, the overhead of the separate types is minimal.</p><p>Witness the finished result:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"67579827-636e-4903-9d43-307ffdba5dcb\",\"duration\":null}\"></div><p><em>(Caption: EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.)</em></p><h1>Build your own Developer Kit</h1><p>Does the above sound cool? Do you want to play with it? Here are the parts you’ll need to build you own:</p><ul><li><p><strong><a href=\"https://www.amazon.com/ELEMENT-Element14-Raspberry-Pi-Motherboard/dp/B07BDR5PDW?&linkCode=ll1&tag=blogsystem5-20&linkId=cab45a45b3e43934d489486d416be7a0&language=en_US&ref_=as_li_ss_tl\">Raspberry Pi 3 B+</a>:</strong> I suppose a newer model will work but I don’t have one to try it out; let me know if it does! I also have my eyes on the <a href=\"https://www.amazon.com/gp/product/B074P6BNGZ?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=1f5bdad0f78d4512685cda89db5c6d87&language=en_US&ref_=as_li_ss_tl\">Libre Computer Board - Le Potato</a>, but if you go this route, know that it will <em>definitely</em> require extra work in EndBASIC to be functional. Hardware donations welcome if you want me to give it a try 😉.</p></li><li><p><strong><a href=\"https://www.amazon.com/CanaKit-Raspberry-Supply-Adapter-Listed/dp/B00MARDJZ4?&linkCode=ll1&tag=blogsystem5-20&linkId=ef82e298644b68298cd9bf5559b74aaa&language=en_US&ref_=as_li_ss_tl\">CanaKit 5V 2.5A Power Supply</a>:</strong> Yes, the Raspberry Pi is USB-powered but you need a lot of power for it to run properly—particularly if you are going to attach any USB devices like hard disks. Don’t skimp on the power supply. This is the one I have and works well.</p></li><li><p><strong><a href=\"https://www.amazon.com/PNY-Elite-microSDHC-Memory-P-SDU32GU185GW-GE/dp/B07R8GVGN9?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=33a25c49f236d8bd6e8f2259a6c57148&language=en_US&ref_=as_li_ss_tl\">PNY 32GB microSD card</a>:</strong> Buy any microSD card you like. The SD bay is incredibly slow no matter what and 32GB should be plenty for experimentation.</p></li><li><p><strong><a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">waveshare 1.44inch LCD Display HAT 128x128</a>:</strong> The star product of this whole article! You may find other LCD hats and I’m sure they can be made to work, but they’ll require code changes. Hopefully the abstractions I implemented make it easy to support other hats, but I can’t tell yet. Again, hardware donations welcome if you want to keep me busy 😉.</p></li></ul><p>Once you have those pieces, get either Raspbian or Ubuntu, flash the image to the microSD, and boot the machine. After that, you have to build and run EndBASIC from unreleased sources until I release 0.11:</p><pre><code><code>$ cargo install --git=https://github.com/endbasic/endbasic.git --features=rpi
$ ~/.cargo/bin/endbasic --console=st7735s</code></code></pre><p>I know, I know, this is all quite convoluted. You have to manually go through the process of setting up Linux, then installing Rust, and then building EndBASIC from source. All of this is super-slow too.</p><p>Which means… what I want to do next is to build a complete “Developer Kit”, including a lightweight prebuilt SD image that gives you access to EndBASIC out of the box in just a few seconds. Right now I’m playing with downsizing a NetBSD/evbarm build so that the machine can boot quickly and, once I have that ready, I’ll have to port EndBASIC’s hardware-specific features to work on it. I don’t think I’ll postpone 0.11 until this is done, but we’ll see.</p><p>Interested in any of this? Please leave a note! And if you have tried the above at all with your own hardware, post your story too!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for reading and please take a little moment to subscribe to Blog System/5.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "0.0" "image/jpeg") nil "9f53c4173d7f76b5754d6f461c969a6d") (33 (26623 25868 496665 19000) "https://blogsystem5.substack.com/p/how-new-type-helps-avoid-production" "How \"new type\" helps avoid production outages" "Julio Merino" "Sat, 09 Mar 2024 18:00:20 +0000" "<p>My <a href=\"https://blogsystem5.substack.com/p/links-january-2024-edition\">January links recap</a> included the <a href=\"https://experimentalworks.net/posts/2024-01-22-simple-phantom-types/\">“Phantom Types”</a> article by David Soria Parra. In it, the author briefly touches upon the “new type” idiom, its typical implementation in Rust, and then proceeds to propose a better alternative. But the question arises: why should you care?</p><p>To answer why this idiom is useful, I want to present you with a real production problem we faced in the Storage Infrastructure team at Google circa 2010. That issue made me a convert and I’ve kept it in mind when designing APIs since then.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":552435,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><h1>What is “new type” anyway?</h1><p>The <a href=\"https://rust-unofficial.github.io/patterns/patterns/behavioural/newtype.html\">“new type” idiom</a> is a programming pattern whereby you define domain-specific types to wrap native types. Then, you use those types in your code and only “lower” them to their underlying types when passing the values to any external APIs.</p><p>More specifically, your public interfaces—but also private methods and functions—should never receive primitive types like integers or strings. A function like <code>allow_write(username: String, size: usize)</code> should not exist in your code base.</p><p>Instead, what you’d do is define two new types, <code>Username</code> and <code>Size</code>, that wrap the string and integer values. These types are trivial wrappers over the native types (e.g. <code>struct Username(String)</code> and <code>struct Size(usize)</code>) with the goal of making them zero-cost abstractions.</p><p>However, as David’s article describes, this simplistic way to implement the pattern lends itself to code duplication for every type. And, as you know, code duplication leads to slight inconsistencies over time, which may increase maintenance costs.</p><p>But this is not relevant now. “New type” is “new type” no matter how you implement it and no matter which language you choose. What I want to showcase here is <em>why</em> adopting this pattern helps at all. And, for that, it’s time to dive into the story.</p><h1>Quota management outage</h1><p>Back in the early days of the Storage Infrastructure at Google, we the SRE team managed tens of shared file system deployments (aka <em>cells</em>). Those file systems were multi-user and had support for quotas—like pretty much any file system worthy of consideration.</p><p>Storage quotas are typically expressed as two quantities: a <em>bytes quota</em>, which says how much disk space a user can use; and a <em>files quota</em>, which says how many files a user can store. Tracking byte usage limits disk usage and tracking file usage limits metadata overhead.</p><p>Now, even with the replicated and zonal system that Google had, it was convenient to <em>manage</em> user quotas in a centralized way. So that’s what we also had: the equivalent of a MySQL database tracking how much quota each user had allocated in which cell, world-wide.</p><p>So far so good. But how do you keep the decentralized storage cells decoupled from the quota database? Easy! Via a cron job that reads the quotas and pushes them to cluster-local “configuration” files so that each cell doesn’t need to know about the central database.</p><p>Of course, this cron job is code. And code has bugs. So here is what happened: there was some function somewhere that looked like this: <code>set_quota(user: String, bytes: usize, files: usize)</code>. And, for whatever reason, a caller invoked it as <code>set_quota(user, files, bytes)</code>.</p><p>Notice the problem? The caller swapped the arguments but the language did not flag this issue and… the tests didn’t catch it either! It’s unfortunately too common for people to write the same sentinel values (<code>set_quota(\"foo\", 100, 100)</code>) for different test arguments.</p><p>Soon after this change was checked in, the code rolled out to production and… of course, the moment it touched the first canary deployment, things went south. Users started receiving out of quota alerts even when they should have had, in theory, plenty of available quota.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to not miss out on any future stories. It’s completely free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The aftermath</h1><p>The fix to the above was trivial: swap the arguments in the problematic caller and call it a day. But that’s a naïve fix. It just corrects the immediate problem but does not minimize the chances of it happening again. That is: this change is a <em>mitigation</em>, not a <em>fix</em>.</p><p>In good SRE fashion, the team went a bit further to prevent this issue from ever recurring. They adopted the “new type” pattern, created two separate types—<code>BytesQuota</code> and <code>FilesQuota</code>—and plumbed them through the whole program. And note: Rust wasn’t really a thing in 2010.</p><p>Furthermore, the team contributed an entry to the <a href=\"https://testing.googleblog.com/2007/01/introducing-testing-on-toilet.html\">Testing on the Toilet blog</a>, describing the issue and how this same problem had <em>just</em> bitten a major financial company and had made them lose millions of dollars.</p><p>And that’s the simple story of the day. Please adopt the new type pattern! Future-you will be happy that you did when the compiler or language interpreter yells at you about something that’s obviously wrong.</p><p><em>(<a href=\"https://twitter.com/jmmv/status/1766522609314017598\">Originally published as a Twitter thread.</a>)</em></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "0.0" "image/jpeg") nil "e4015939ecabb3bcc1581d537905857d") (32 (26622 7993 403117 187000) "https://blogsystem5.substack.com/p/bazel-next-generation" "The next generation of Bazel builds" "Julio Merino" "Mon, 24 Mar 2025 15:03:25 +0000" "<p>Today marks the 10th anniversary of <a href=\"https://blog.engflow.com/2024/10/01/birth-of-the-bazel/\">Bazel’s public announcement</a> so this is the perfect moment to reflect on what the next generation of build systems in the Bazel ecosystem may look like.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/b2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":525451,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159682182?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>I write this with the inspiration that comes from attending <a href=\"https://www.linkedin.com/feed/update/urn:li:activity:7295871444343734272/\">the first ever conference on Buildbarn</a>, one of the many remote execution systems for Bazel. In the conference, Ed Schouten, the creator of <a href=\"https://github.com/buildbarn\">Buildbarn</a>, presented Bonanza: a skunkworks reimagination of Bazel for truly large builds.</p><p>In this article, I want to dive into what Bonanza is and what similar projects to “replace Bazel” have existed. To get there though, we need to start first with a critique of the current implementation of Bazel.</p><h1><strong>Problems scaling up</strong></h1><p>The predecessor to Bazel, Blaze, is a build system designed at Google for Google’s monorepo scale. Blaze grew over the years assuming:</p><ul><li><p>that every engineer had a beefy workstation under their desk;</p></li><li><p>that remote execution was expected to be used by default;</p></li><li><p>that the remote execution cluster was reachable through a fast and low latency network; and</p></li><li><p>that each office had physical hardware hosting a local cache of remote build artifacts.</p></li></ul><p>These assumptions allowed Blaze to “scale up” to the very large codebase that Google builds, but they came with some downsides.</p><p>One consequence of these assumptions is that the Bazel process—confusingly named the “Bazel server”—that runs on your machine is very resource hungry. The reason is that this process has to scan the source tree to understand the dependency graph and has to coordinate thousands of RPCs against a remote cluster—two operations that aren’t cheap. What’s worse is that the Bazel server process is stateful: at start up, Bazel goes through the expensive steps of computing the analysis graph from disk and, to prevent redoing this work in every build, Bazel keeps this graph in its in-memory “analysis cache”.</p><p><a href=\"https://bazel.build/advanced/performance/iteration-speed\">The analysis cache is fragile.</a> The Bazel server process may auto-restart, and certain flags used to control the build cause the cache to be discarded. These are not rare flags, no: these include basic flags like <code>-c</code> to change the compilation mode from debug to release, among many others. Cache discards are very intrusive to user workflows because an iterative build that would have taken a second now takes maybe thirty, for example.</p><p>This user experience degradation makes Bazel’s front-page claim of being fast hard to believe. Bazel is really fast at running gigantic builds from scratch and it is really efficient when executing incremental builds. But the problem is that “truly incremental builds” are a rarity, so you end up paying the re-analysis cost many more times than is necessary. If you run Bazel in a CI environment, you know that these costs are far from negligible because every single Bazel process invocation on a fresh CI node can take <em>minutes</em> to “warm up”.</p><h1><strong>Problems scaling down</strong></h1><p>There is also the other side of the coin, which is that Bazel does not scale <em>down</em> very well. This was one of my <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">original critiques</a> when Bazel went open source in 2015: at that time, I really wished for a declarative build system like Bazel to replace the mess that was and is Make plus the GNU Autotools, but the fact that Bazel was written in Java meant that it would never do this (mostly for non-technical reasons).</p><p>Regardless, <a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">I </a><em><a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">did</a></em><a href=\"https://jmmv.dev/2016/01/joining-blaze-team.html\"> join the Blaze team</a> after that, and I spent most of my time coercing Blaze and Bazel to run nicely on “small” laptop computers. I succeded in some areas, but it was a losing battle: Java had certain deficiencies that prevent implementing <em>lean</em> software. <a href=\"https://wiki.openjdk.org/display/loom/Main\">Project Loom</a> and <a href=\"https://en.wikipedia.org/wiki/Project_Valhalla_(Java_language)\">Project Valhalla</a> promise to bring the necessary features to Java, but these features aren’t quite there yet—and even when they are, retrofitting these into Bazel will be a very hard feat.</p><p>In any case. Bazel works, and it works nicely for many use cases, but it lives in this limbo state where it isn’t awesome for very large builds and it isn’t awesome for very small builds either. So, let’s look at the former: how do we make Bazel awesome for humongous builds? By lifting it in its entirety to the cloud.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Enjoying this article? If so, please subscribe to Blog System/5 to show your support. It’s free and you’ll appreciate future content!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Enter Bonanza</strong></h1><p>Bonanza is Ed’s playground for a new build system: a build system that takes remote execution to the limit. Where Bazel is only capable of shipping individual build actions to the cloud, Bonanza uses the cloud for <em>everything</em>, including external dependency handling, build graph construction and iteration, and more.</p><p>To understand what Bonanza brings to the table in the context of hugely scalable builds, let’s distill the salient points that Ed highlighted in his <a href=\"https://docs.google.com/presentation/d/1uh6CxvvziQunw55e_bs1Juz3jfaiE-QJVs2DCfeMeTw/edit#slide=id.g339c289dd60_1_29\">“Bonanza in a nutshell”</a> slide from his conference presentation (recording coming soon):</p><ul><li><p><strong>Bonanza can only execute build actions remotely.</strong> There is no support for local execution, which makes the build driver (the process that runs on your machine) simpler and eliminates all sorts of inconsistencies that show up when mixing local and remote execution. Bazel’s <a href=\"https://jmmv.dev/2019/12/bazel-strategies.html\">execution strategies</a> tend to enforce hermeticity, but they don’t always succeed because of sandboxing limitations.</p></li><li><p><strong>Bonanza performs analysis remotely.</strong> When traditional Bazel is configured to execute all actions remotely, the Bazel server process is essentially a driver that constructs and walks a graph of nodes. This <em>in-memory</em> graph is known as <a href=\"https://bazel.build/reference/skyframe\">Skyframe</a> and is used to represent <em>and execute</em> a Bazel build. Bonanza lifts the same graph theory from the Bazel server process, puts it into a remote cluster, and relies on a distributed persistent cache to store the graph’s nodes. The consequence of storing the graph in a distributed storage system is that, all of a sudden, <em>all</em> builds become incremental. There is no more “cold build” effect like the one you see with Bazel when you lose the analysis cache.</p></li><li><p><strong>Bonanza runs repo rules remotely.</strong> Repo rules are what Bazel uses to interact with out-of-tree dependencies, and they can do things like download Git repositories, toolchain binaries, or detect what compiler exists in the system. What you should know is that Blaze <em>did not</em> and <em>does not</em> have repo rules nor support for workspaces because Google uses a strict monorepo. Both the repo rules and the workspace were bolted-on additions to Blaze when it was open-sourced as Bazel, and it shows: these features do not integrate cleanly with the rest of Bazel’s build model, and they have been clunky for years. Bonanza fixes these issues with a cleaner design.</p></li><li><p><strong>Bonanza encrypts data in transit and at rest.</strong> Bonanza brings to life some of the features discussed for the Remote Execution v3 protocol, which never saw the light of day, and encryption is one of them. By encrypting all data that flows through the system, Bonanza can enforce provenance guarantees if you control the action executors. This is important because it allows security-conscious companies to easily trust using <a href=\"https://bazel.build/community/remote-execution-services\">remote build service providers</a>.</p></li><li><p><strong>Bonanza only supports rules written in Starlark.</strong> When Bazel launched, it included support for <a href=\"https://github.com/bazelbuild/starlark\">Starlark</a>: a new extensibility language with which to write build logic in. Unfortunately, for historical reasons, Bazel’s core still included Java-native implementations of the most important and complex rules: namely, C++, Java and protobuf. Google has been chasing the dream of externalizing all rule implementations into Starlark for the last 10 years, and only in Bazel 8 they <em>mostly</em> have achieved this goal. Bonanza starts with a clean design that requires build logic to be written in Starlark, and it pushes this to the limit: <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/builtins_core/exports.bzl\">almost everything</a>, including <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/bazel_tools/command_line_option/BUILD.bazel\">flags</a>, is Starlark.</p></li><li><p><strong>Bonanza aims to be Bazel compatible.</strong> Of the modern build systems that use a functional evaluation model like Bazel, only Bazel has been able to grow a significant community around it. This means that the ecosystem of tools and rules, as well as critical features like good IDE support, is thriving in Bazel whereas this cannot be said of other systems. Bonanza makes the right choice of being Bazel compatible so that it can reuse this huge ecosystem. Anyone willing to evaluate Bonanza will be able to do so with relative ease.</p></li></ul><p>When you combine all of these points, you have a build system where the client process on your development machine or on CI is thin: all the client has to do is upload the project state to the remote execution cluster, which in the common case will involve <em>just</em> uploading modified source files. From there, the remote cluster computes the delta of what you uploaded versus any previously-built artifacts and reevaluates the minimum set of graph nodes to produce the desired results.</p><p>Are your hopes up yet? Hopefully so! But beware that Bonanza is <em>just</em> a proof of concept for now. The <a href=\"https://github.com/buildbarn/bonanza\">current implementation</a> shows that all of the ideas above are feasible and it can fully evaluate the complex <a href=\"https://github.com/buildbarn/bb-storage\">bb-storage project</a> from scratch—but it doesn’t yet provide the necessary features to <em>execute</em> the build. Ed appreciates PRs though!</p><h1><strong>Meanwhile, at Google</strong></h1><p>My time at Google is now long behind as I left almost five years ago, but back then there were two distinct efforts that attempted to tackle the scalability issues described in this article. (I can’t name names because they were never public, but if you probe ChatGPT to see if it knows about these efforts, it somehow knows specific details.)</p><p>One such effort was to make Blaze “scale up” to handle even larger builds by treating them all as incremental. The idea was to persist the analysis graph in a distributed storage system so that Blaze would never have to recompute it from scratch. This design still kept a relatively fat Blaze process on the client machine, but it is quite similar to what Bonanza does. Google had advantages over Bonanza in terms of simplicity because, as I mentioned earlier, Blaze works in a pure monorepo and does <em>not</em> have to worry about repo rules.</p><p>The other such effort was to make Blaze “scale down” by exploring a rewrite in Go. This rewrite was carefully crafted to optimize memory layouts, avoiding unnecessary pointer chasing (which was impossible to avoid in Java). The results of this experiment proved that Blaze could be made to analyze large portions of Google’s build graph in just a fraction of the time, without any sort of analysis caching or significant startup penalties. Unfortunately, this rewrite was way ahead of its time: the important rulesets required to build Google’s codebase were still implemented inside of Blaze as Java code, so this experimental build system couldn’t do anything useful outside of Go builds.</p><h1><strong>Meanwhile, at Meta</strong></h1><p>My knowledge of Meta’s build system is limited, but almost two years ago, Meta released <a href=\"https://buck2.build/\">Buck 2</a>, a complete reimplementation of their original Bazel-inspired build system. This reimplementation <a href=\"https://buck2.build/docs/about/why/\">checked most of the boxes</a> for what I thought a “Bazel done right” would look like:</p><ul><li><p><strong>Buck 2 is written in a real systems language (Rust).</strong> As explained earlier, I had originally criticised Java’s choice as one of Bazel’s weaknesses. It turns out Meta realized this same thing because Buck 1 had also been written in Java and they chose to go the risky full-rewrite route to fix it. (To be fair, you need to understand that Java had been a reasonable choice back then: when both Blaze and Buck 1 were originally designed, C++11—possibly the only reasonable edition of C++—didn’t even exist.)</p></li><li><p><strong>Buck 2 is completely language agnostic.</strong> Its core build engine does not have any knowledge of the languages it can build, and all language support is provided via Starlark extensions. This stems from learning about earlier design mistakes of both Blaze and Buck 1. Meta chose to address this as part of the Rust rewrite, whereas Google has been addressing it incrementally.</p></li><li><p><strong>Buck 2 has first-class support for virtual file systems</strong>. These are a necessity when supporting very large codebases and when integrating with remote build systems, but are also completely optional. Blaze also had support for these, but not Bazel.</p></li></ul><p>At launch, I was excited and eager to give Buck 2 a try, but then the disappointment came in: as much as it walks and quacks like Bazel due to its use of Starlark… the API that Buck 2 exports to define rules is <em>not compatible</em> with Bazel’s. This means that Buck 2 cannot be used in existing Bazel codebases, so the ability to evaluate its merits in a real codebase is… insurmountable. In my mind, this made Buck 2 dead on arrival, and it’s yet to be seen if Meta will be able to grow a significant public ecosystem around it.</p><p>In any case, I do not have any experience with Buck 2 because of the previous, so I cannot speak to its ability to scale either up or down. And this is why I wrote this section: to highlight that being Bazel-compatible is critical in this day and age if you want to have a chance at replacing a modern system like Bazel. Bonanza <em>is</em> Bazel-compatible so it has a chance of demonstrating its value with ease.</p><h1><strong>What lies ahead</strong></h1><p>If you ask me, it seems impossible to come up with a single build system that can satisfy the wishes of tiny open-source projects that long for a lean and clean build system and that can satisfy the versatility and scale requirements of vast corporate codebases.</p><p>Bazel-the-implementation tries to appeal to both and falls short, yet Bazel-the-ecosystem provides the lingua franca of what those implementations need to support.</p><p>My personal belief is that <em>we need two build systems</em> that speak the same protocol (Starlark and Bazel’s build API) so that users can interchangeably choose whichever one works best for their use case:</p><ul><li><p>On the one hand, we need a massively scalable build system that does all of the work in the cloud. This is to support building monorepos, to support super-efficient CI runs, and to support “headless” builds like those offered by hosted VSCode instances. Bonanza seems to have the right ideas and the right people behind it to fulfill this niche.</p></li><li><p>On the other hand, we need a tiny build system that does all of the work locally and that can be used by the myriad of open-source projects that the industry relies on. This system has to be written in Rust (oops, I said it) with minimal dependencies and be kept lean and fast so that IDEs can communicate with it quickly. This is a niche that is not fulfilled by anyone right now and that my mind keeps coming to; it’d be fun to create this project given <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my last failed attempt</a>.</p></li></ul><p>The time for these next-generation Bazel-compatible build systems is <em>now</em>. Google has spent the last 10 years Starlark-ifying Bazel, making the core execution engine replaceable. We are reaching a point where the vast majority of the build logic can be written in Starlark as Bonanza proves, and thus we should be able to have different build <em>tools</em> that implement the same build <em>system</em> for different use cases.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "0.0" "image/jpeg") nil "5b6415c7b04ff85a44517a829326d481") (31 (26622 7993 389379 819000) "https://blogsystem5.substack.com/p/x86-64-programming-models" "The costs of the i386 to x86-64 upgrade" "Julio Merino" "Mon, 07 Oct 2024 16:03:08 +0000" "<p>If you read my previous article on <a href=\"https://blogsystem5.substack.com/p/dos-memory-models\">DOS memory models</a>, you may have dismissed everything I wrote as “legacy cruft from the 1990s that nobody cares about any longer”. After all, computers have evolved from sporting 8-bit processors to 64-bit processors and, on the way, the amount of memory that these computers can leverage has grown orders of magnitude: the 8086, a 16-bit machine with a 20-bit address space, could only use 1MB of memory while today’s 64-bit machines can theoretically access 16EB.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":992004,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>All of this growth has been in service of ever-growing programs. But… even if programs are now more sophisticated than they were before, do they all <em>really</em> require access to a 64-bit address space? Has the growth from 8 to 64 bits been a net positive in performance terms?</p><p>Let’s try to answer those questions to find some very surprising answers. But first, some theory.</p><h1>Code density</h1><p>An often overlooked property of machine code is <em>code density</em>, a loose metric that quantifies how many instructions are required to execute a given “action”. I double-quote action because an “action” in this context is a subjective operation that captures a programmer-defined outcome.</p><p>Suppose, for example, that you want to increment the value of a variable that resides in main memory, like so:</p><pre><code><code>static int a;
// ...
a = a + 1;</code></code></pre><p>On a processor with an ISA that provides complex instructions and addressing modes, you can potentially do so in just one machine instruction:</p><pre><code><code>; Take the 32-bit quantity at the address indicated by the
; 00001234h immediate, increment it by one, and store it in the
; same memory location.
add dword [1234h], 1</code></code></pre><p>In contrast, on a processor with an ISA that strictly separates memory accesses from other operations, you’d need more steps:</p><pre><code><code>li  r8, 1234h   ; Load the address of the variable into r8.
lm  r1, r8      ; Load the content of the address into r1.
li  r2, 1       ; Load the immediate value 1 into r2.
add r3, r1, r2  ; r3 = r1 + r2
sm  r8, r3      ; Store the result in r3 into the address in r8.</code></code></pre><p>Which ISA is better, you ask? Well, as usual, there are pros and cons to each approach:</p><ul><li><p>The former type of ISA offers a denser representation of the operation so it can fit more instructions in less memory. But, because of the semantic complexity of each individual instruction, the processor has to do more work to execute them (possibly requiring more transistors and drawing more power). This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Complex_instruction_set_computer\">CISC</a>.</p></li><li><p>The latter type of ISA offers a much more verbose representation of the operation but the instructions that the processor executes are simpler and can likely be executed faster. This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Reduced_instruction_set_computer\">RISC</a>.</p></li></ul><p>This is the eternal debate between CISC and RISC but note that the distinction between the two is not crystal clear: some RISC architectures support <em>more</em> instructions that CISC architectures, and contemporary Intel processors translate their CISC-style instructions into internal RISC-style <a href=\"https://en.wikipedia.org/wiki/Intel_microcode\">micro-operations</a> immediately after decoding the former.</p><h1>It’s the bytes that matter</h1><p>Code density is not about instruction <em>count</em> though. Code density is about the <em>aggregate size</em>, in bytes, of the instructions required to accomplish a specific outcome.</p><p>In the example I presented above, the single CISC-style <code>mov</code> x86 instruction is encoded using anywhere from 2 to 8 bytes depending on its arguments, whereas the fictitious RISC-style instructions typically take 4 bytes each. Therefore, the CISC-style snippet would take 8 bytes total whereas the RISC-style snippet would take 20 bytes total, while achieving the same conceptual result.</p><p>Is that increase in encoded bytes bad? Not necessarily because “bad” is subjective and we are talking about trade-offs here, but it’s definitely an important consideration due to its impact in various dimensions:</p><ul><li><p><strong>Memory usage</strong>: Larger programs take more memory. You might say that memory is plentiful these days, and that’s true, but it wasn’t always the case: when computers could only address 1 MB of RAM or less, the size of a program’s binary mattered a lot. Furthermore, even today, memory <em>bandwidth</em> is limited, and this is an often-overlooked property of a system.</p></li><li><p><strong>Disk space</strong>: Larger programs take more disk space. You might say that disk space is plentiful these days too and that program code takes a tiny proportion of the overall disk: most space goes towards storing media anyway. And that’s true, but I/O bandwidth is not as unlimited as disk space, and loading these programs from disk isn’t cheap. Have you noticed how utterly slow is it to open an Electron-based app?</p></li><li><p><strong>L1 thrashing</strong>: Larger or more instructions mean that you can fit fewer of them in the L1 instruction cache. Proper utilization of this cache is critical to achieve reasonable levels of computing performance, and even though main memory size can now be measured in terabytes, the L1 cache is still measured in kilobytes.</p></li></ul><p>We could beat the dead horse over CISC vs. RISC further but that’s not what I want to focus on. What I want to focus on is one very specific dimension of the instruction encoding that affects code density in all cases. And that’s the <em>size of the addresses</em> (pointers) required to reference program code or data.</p><p>Simply put, the larger the size of the addresses in the program’s code, the lower the code density. The lower the code density, the more memory and disk space we need. And the more memory code takes, the more L1 thrashing we will see.</p><p>So, for good performance, we probably want to optimize the way we represent addresses in the code and take advantage of surrounding context. For example: if we have a tight loop like this:</p><pre><code><code>static int a;
...
for (int i = 0; i < 100; i++) {
a = a + 1;
}</code></code></pre><p>The corresponding assembly code may be similar to this:</p><pre><code><code>        mov ecx, 0             ; i = 0.
repeat: cmp ecx, 100           ; i < 100?
je  out                ; If i == 100, jump to out.
add dword [01234h], 1  ; Increment a.
add ecx, 1             ; i++.
jmp repeat             ; Jump back to repeat.
out:</code></code></pre><p>Now the questions are:</p><ul><li><p>Given that <code>repeat</code> and <code>out</code> are labels for memory addresses, how do we encode the <code>je</code> (jump if equal) and <code>jmp</code> (unconditional jump) instructions as bytes? On a 32-bit machine, do we encode the full 32-bit addresses (4 bytes each) in each instruction, or do we use 1-byte relative short pointers because the jump targets are within a 127-byte distance on either side of the jump instruction?</p></li><li><p>How do we represent the address of the <code>a</code> variable? Do we express it as an absolute address or as a relative one? Do we store <code>1234h</code> as a 32-bit quantity or do we use fewer bytes because this specific number is small?</p></li><li><p>How big should <code>int</code> be? The <code>dword</code> above implies 32 bits but… that’s just an assumption I made when writing the snippet. <code>int</code> could have been 16 bits, or 64 bits, or anything else you can imagine (which is a design mistake in C, if you ask me).</p></li></ul><p>The answers to the questions above are <em>choices</em>: we can decide whichever encoding we want for code and data addresses, and these choices have consequences on code density. This was true many years ago during the DOS days, which is why we had short, near, and far pointer types, and <a href=\"https://web.eece.maine.edu/~vweaver/papers/iccd09/iccd09_density.pdf\">is still true today</a> as we shall see.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Are you finding this interesting? If so, subscribe to Blog System/5 to receive more goodness in your inbox. It’s free, but paid donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The switch to 32 bits</h1><p>It is no secret that programming 16-bit machines was limiting, and we can identify at least two reasons to back this claim.</p><p>First, 16-bit machines usually had limited address spaces. It’s important to understand that a processor’s native register size has no direct connection to the size of the addresses the processor can reference. In theory, these machines could have leveraged larger chunks of memory and, in fact, the 16-bit 8086 proved this to be true with its 20-bit address space. But the point is that, <em>in the era</em> of 16-bit machines, 1 MB of RAM was considered “a lot” and so machines didn’t have much memory.</p><p>Second, 16-bit machines can only operate on 16-bit quantities at a time, and 16 bits only allow representing integers with limited ranges: a signed number between -32K and +32K isn’t… particularly large. Like before, it’s important to clarify that the processor’s native register size does not impose restrictions on the size of the numbers the processor can manipulate, but it does add limitations on how <em>fast</em> it can do so: operating 32-bit numbers on 16-bit machines requires at least twice the number of instructions for each operation.</p><p>So, when 32-bit processors entered the scene, it was pretty much a no-brainer that programs had to become 32-bit by default: all memory addresses and default integer types grew to 32 bits. This allowed programmers to not worry about memory limits for a while: 32 bits can address 4GB of memory, which was a huge amount back then and should <em>still</em> be huge if it wasn’t due to bloated software. Also, this upgrade allowed programmers to efficiently manipulate integers with large-enough ranges for most operations.</p><p>In technical mumbo-jumbo, what happened here was that C adopted the ILP32 programming model: integers (I), longs (L), and pointers (P) all became 32 bits, whereas chars and shorts remained 8-bit and 16-bit respectively.</p><p>It didn’t have to be this way though: if we look at the model for 16-bit programming, shorts and integers were 16-bit whereas longs were 32-bit, so why did integers change size but longs remained the same as integers? I do not have an answer for this, but if longs had become 64 bits back then, maybe we wouldn’t be in the situation today where <a href=\"https://en.wikipedia.org/wiki/Year_2038_problem\">2038 will bring mayhem to Unix systems</a>.</p><h1>Evolving towards x86-64</h1><p>4GB of RAM were a lot when 32-bit processors launched but slowly became insufficient as software kept growing. To support those needs, there were crutches like <a href=\"https://en.wikipedia.org/wiki/Physical_Address_Extension\">Intel’s PAE</a>, which allowed manipulating up to 64GB of RAM on 32-bit machines without changing the programming model, but they were just that: hacks.</p><p>The thing is: it’s not only software that grew. It’s the <em>kinds of things</em> that people wanted to do with software that changed: people wanted to edit high-resolution photos and video as well as play more-realistic games, and writing code to achieve those goals on a limited 4GB address space was possible but not <em>convenient</em>. With 64-bit processors, <code>mmap</code>ing huge files made those programs easier to write, and using native 64-bit integers made them faster too. So 64-bit machines became mainstream sometime around the introduction of the Athlon 64 processor and the Power Mac G5, both in 2003.</p><p>So what happened to the programming model? ILP32 was a no-brainer for 32-bit machines, but were LP64 or ILP64 no-brainers for 64-bit machines? These 64-bit models were definitely tempting because they allowed the programmer to leverage the machine’s resources freely. Larger pointers allowed addressing “unlimited” memory transparently, and a larger long type naturally bumped file offsets (<code>ino_t</code>), timestamps (<code>time_t</code>), array lengths (<code>size_t</code>), and more to 64 bits as well. Without a lot of work from programmers, programs could “just do more” by simply recompiling them.</p><p>But there was a downside to that choice. According to the theory I presented earlier, LP64 would make programs bigger and would decrease code density when compared to ILP32. And lower code density could lead to L1 instruction cache thrashing, which is an important consideration to this day because a modern Intel Core i7-14700K from 2023 has just 80 KB of L1 cache and an Apple Silicon M3 from 2023 has less than 200KB. (These numbers are… <em>not big</em> when you stack them up against the multi-GB binaries that comprise modern programs, are they?)</p><p>We now know that LP64 was the preferred choice and that it became the default programming model for 64-bit operating systems, which means we can compare its impact against ILP32. So what are the consequences? Let’s take a look.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" width=\"1363\" height=\"844\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":844,\"width\":1363,\"resizeWidth\":null,\"bytes\":37898,\"alt\":\"Comparison of ISO image sizes for various operating systems\",\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"Comparison of ISO image sizes for various operating systems\" title=\"Comparison of ISO image sizes for various operating systems\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Wait, what? The FreeBSD x86-64 installation image is definitely larger than the i386 one… but all other images are <em>smaller</em>? What’s going on here? This contradicts everything I said above!</p><h1>Down the rabbit hole</h1><p>I was genuinely surprised by this and I had to dig a bit. Cracking open the FreeBSD bootonly image revealed some differences in the kernel (slightly bigger binaries, but different sets of modules) which made it difficult to compare the two. But looking into the Debian netinst images, I did find that almost all i386 binaries were larger than their x86-64 counterparts.</p><p>To try to understand why that was, the first thing I did was compile a simple hello-world program on my x86-64 Debian VM, targeting both 64-bit and 32-bit binaries:</p><pre><code><code>$ gcc-14 -o hello64 hello.c
$ i686-linux-gnu-gcc-14 -o hello32 hello.c
$ file hello32 hello64
hello32: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, not stripped
hello64: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f1bf851d7f1d56ae5d50eb136793066f67607e06, for GNU/Linux 3.2.0, not stripped
$ ls -l hello32 hello64
-rwxrwxr-x 1 jmmv jmmv 15040 Oct  4 17:45 hello32
-rwxrwxr-x 1 jmmv jmmv 15952 Oct  4 17:45 hello64
$ █</code></code></pre><p>Based on this, it <em>looks</em> as if 32-bit binaries are indeed smaller than 64-bit binaries. But a “hello world” program is trivial and not worth 15kb of code: those 15kb shown above are definitely <em>not</em> code. They are probably mostly ELF overhead. Indeed, if we look at just the text portion of the binaries:</p><pre><code><code>$ objdump -h hello32 | grep text
14 .text         00000169  00001060  00001060  00001060  2**4
$ objdump -h hello64 | grep text
14 .text         00000103  0000000000001050  0000000000001050  00001050  2**4
$ █</code></code></pre><p>… we find that <code>hello32</code>’s text is 169h bytes whereas <code>hello64</code>’s text is 103h bytes. And if we disassemble the two:</p><pre><code><code>$ objdump --disassemble=main hello32
...
00001189 <main>:
1189:       8d 4c 24 04             lea    0x4(%esp),%ecx
118d:       83 e4 f0                and    $0xfffffff0,%esp
1190:       ff 71 fc                push   -0x4(%ecx)
1193:       55                      push   %ebp
1194:       89 e5                   mov    %esp,%ebp
1196:       53                      push   %ebx
1197:       51                      push   %ecx
1198:       e8 28 00 00 00          call   11c5 <__x86.get_pc_thunk.ax>
119d:       05 57 2e 00 00          add    $0x2e57,%eax
11a2:       83 ec 0c                sub    $0xc,%esp
11a5:       8d 90 14 e0 ff ff       lea    -0x1fec(%eax),%edx
11ab:       52                      push   %edx
11ac:       89 c3                   mov    %eax,%ebx
11ae:       e8 8d fe ff ff          call   1040 <puts@plt>
11b3:       83 c4 10                add    $0x10,%esp
11b6:       b8 00 00 00 00          mov    $0x0,%eax
11bb:       8d 65 f8                lea    -0x8(%ebp),%esp
11be:       59                      pop    %ecx
11bf:       5b                      pop    %ebx
11c0:       5d                      pop    %ebp
11c1:       8d 61 fc                lea    -0x4(%ecx),%esp
11c4:       c3                      ret
...
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ █</code></code></pre><p>We observe massive differences in the machine code generated for the trivial <code>main</code> function. The 64-bit code is definitely <em>smaller</em> than the 32-bit code, contrary to my expectations. But the code is also <em>very</em> different; so different, in fact, that ILP32 vs. LP64 doesn’t explain it.</p><p>The first difference we can observe is around calling conventions. The i386 architecture has a limited number of registers, favors passing arguments via the stack, and only 3 registers can be clobbered within a function. x86-64, on the other hand, prefers passing arguments through registers as much as possible and defines 7 registers as volatile.</p><p>The second difference is that we don’t see 64-bit addresses anywhere in the code above. Jump addresses are encoded using near pointers, and data addresses are specified as offsets over a 64-bit base previously stored in a register. I found it smart that those addresses are relative to the program counter (the RIP register).</p><p>There may be more differences, but these two alone seem to be the reason why 64-bit binaries end up being more compact than 32-bit ones. <em>On Intel x86</em>, that is. You see: Intel x86’s instruction set is so versatile that the compiler and the ABI can play tricks to hide the cost of 64-bit pointers.</p><p>Is that true of more RISC-y 64-bit architectures though? I installed the PowerPC 32-bit and 64-bit toolchains and ran the same test. And guess what? The PowerPC 64-bit binary was indeed larger than the 32-bit one, so <em>maybe</em> it’s true. Unfortunately, running a broader comparison than this is difficult: there is no full operating system I can find that ships both builds any longer, and ARM images can’t easily be compared.</p><h1>It’s all about the data</h1><p>OK, fine, we’ve settled that 64-bit <em>code</em> isn’t necessarily larger than 32-bit code, at least on Intel, and thus any adverse impact on the L1 instruction cache is probably negligible. But… what about <em>data density</em>?</p><p>Pointers don’t only exist in instructions or as jump targets. They also exist within the most modest of data types: lists, trees, graphs… all contain pointers in them. And in those, unless the programmer explicitly plays complex <a href=\"https://v8.dev/blog/pointer-compression\">tricks to compress pointers</a>, we’ll usually end up with larger data structures by simply jumping to LP64. The same applies to the innocent-looking <code>long</code> type by the way, which appears throughout codebases and also grows with this model.</p><p>And <em>this</em>—a decrease in data density—is where the real performance penalty comes from: it’s not so much about the code size but about the data size.</p><p>Let’s take a look. I wrote a simple program that creates a linked list of integers with 10 million nodes and then iterates over them in sequence. Each node is 8 bytes in 32-bit mode (4 bytes for the <code>int</code> and 4 bytes for the <code>next</code> pointer), whereas it is 16 bytes in 64-bit mode (4 bytes for the <code>int</code>, <em>4 bytes of padding</em>, and 8 bytes for the <code>next</code> pointer). I then compiled that program in 32-bit and 64-bit mode, measured it, and ran it:</p><pre><code><code>$ gcc -o list64 list.c
$ i686-linux-gnu-gcc-14 -o list32 list.c
$ objdump -h list32 | grep text
13 .text         000001f6  00001070  00001070  00001070  2**4
$ objdump -h list64 | grep text
14 .text         000001b0  0000000000001060  0000000000001060  00001060  2**4
$ hyperfine --warmup 1 ./list32 ./list64
Benchmark 1: ./list32
Time (mean ± σ):     394.2 ms ±   2.1 ms    [User: 311.4 ms, System: 83.1 ms]
Range (min … max):   392.1 ms … 398.2 ms    10 runs
Benchmark 2: ./list64
Time (mean ± σ):     502.4 ms ±   4.5 ms    [User: 334.9 ms, System: 167.8 ms]
Range (min … max):   494.9 ms … 509.5 ms    10 runs
Summary
./list32 ran
1.27 ± 0.01 times faster than ./list64
$ █</code></code></pre><p>As before with the hello-world comparison, this simple microbenchmark’s 32-bit code continues to be slightly larger than its 64-bit counterpart (1F6h bytes vs 1B0h). However, its runtime is <em>27% faster</em>, and it is no wonder because the doubling of the linked list node size implies doubling the memory usage and thus the halving of cache hits. We can confirm the impact of this using the <code>perf</code> tool:</p><pre><code><code>$ perf stat -B -e cache-misses ./list32 2>&1 | grep cpu_core
2,400,339      cpu_core/cache-misses:u/      (99.33%)
$ perf stat -B -e cache-misses ./list64 2>&1 | grep cpu_core
4,687,156      cpu_core/cache-misses:u/      (99.34%)
$ █</code></code></pre><p>The 64-bit build of this microbenchmark incurs almost double the cache misses than the 32-bit build.</p><p>Of course, this is just a microbenchmark, and tweaking it slightly will make it show very different results and make it say whatever we want. I tried to add jitter to the memory allocations so that the nodes didn’t end up as consecutive in memory, and then the 64-bit version executed faster. I suspect this is due to the memory allocator having a harder time handling memory when the address space is limited.</p><p>The impact on real world applications is harder to quantify. It is difficult to find the same program built in 32-bit and 64-bit mode and to run it on the same kernel. It is even more difficult to find one such program where the difference matters. But at the end of the day, the differences exist, and I bet they are more meaningful than we might think in terms of bloat—but I did not intend to write a research paper here, so I’ll leave that investigation to someone else… or another day.</p><h1>The x32 ABI</h1><p>There is one last thing to discuss before we depart. While we find ourselves using the LP64 programming model on x86-64 processors, remember that this was a choice and there were and are other options on the table.</p><p>Consider this: we could have made the operating system kernel leverage 64 bits to gain access to a humongous address space, but we could have kept the user-space programming model as it was before—that is, we could have kept ILP32. And we could have gone even further and optimized the calling conventions to reduce the binary code size by leveraging the additional general-purpose registers that x86-64 provides.</p><p>And in fact, this exists and is known as <a href=\"https://en.wikipedia.org/wiki/X32_ABI\">x32</a>.</p><p>We can install the x32 toolchain and see that it effectively works as we’d imagine:</p><pre><code><code>$ gcc -o hello64 hello.c
$ x86_64-linux-gnux32-gcc-14 -o hellox32 hello.c
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ objdump --disassemble=main hellox32
...
00401126 <main>:
401126:       55                      push   %rbp
401127:       89 e5                   mov    %esp,%ebp
401129:       b8 04 20 40 00          mov    $0x402004,%eax
40112e:       89 c0                   mov    %eax,%eax
401130:       48 89 c7                mov    %rax,%rdi
401133:       e8 f8 fe ff ff          call   401030 <puts@plt>
401138:       b8 00 00 00 00          mov    $0x0,%eax
40113d:       5d                      pop    %rbp
40113e:       c3                      ret
...
$ █</code></code></pre><p>Now, the <code>main</code> method of our hello-world program is really similar between the 64-bit and 32-bit builds, but pay close attention to the x32 version: it uses the same calling conventions as x86-64, but it contains a mixture of 32-bit and 64-bit registers, delivering a more compact binary size.</p><p>Unfortunately:</p><pre><code><code>$ ./hellox32
zsh: exec format error: ./hellox32
$ █</code></code></pre><p>We can’t run the resulting binary. x32 is an ABI that impacts the kernel interface too, so these binaries cannot be executed on a regular x86-64 kernel. Sadly, and as far as I can tell, x32 is pretty much abandonware today. Gentoo claims to support it but there are no official builds of any distribution I can find that are built in x32 mode.</p><div><hr></div><p>In the end, even though LP64 <a href=\"https://unix.org/version2/whatsnew/lp64_wp.html\">wasn’t the obvious choice</a> for x86-64, it’s the compilation mode that won and stuck.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Phew, that was a lot! And you know what? Writing this took a really long time too. Subscribe now to show your support!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "0.0" "image/jpeg") nil "bc35243967f8a38d514d67102526c05d") (30 (26620 53367 792325 825000) "https://blogsystem5.substack.com/p/make-help" "Self-documenting Makefiles" "Julio Merino" "Fri, 10 Jan 2025 17:02:01 +0000" "<p>Make, as arcane as a build tool can be, may still be a good first fit for certain scenarios. “Heresy!”, you say, as you hear a so-called “Bazel expert” utter these words.</p><p>The specific problem I’m facing is that I need to glue together <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">the NetBSD build system</a>, <a href=\"https://jmmv.dev/2013/11/patch-management-with-quilt.html\">a quilt patch set</a>, EndBASIC’s Cargo-based Rust build, and a couple of QEMU invocations to produce a Frankenstein disk image for a Raspberry Pi. And the thing is: Make allows doing this sort of stitching with relative ease. Sure, Make is not the best option because the overall build performance is “meh” and because incremental builds are almost-impossible to get right… but adopting Bazel for this project would be an almost-infinite time sink.</p><p>Anyway. When using Make in this manner, you often end up with what’s essentially a “command dispatcher” and, over time, the number of commands grows and it’s hard to make sense of which one to use for what. Sure, you can write a <code>README.md</code> with instructions, but I guarantee you that the text will get out of sync faster than you can read this article. There is a better way, though.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" width=\"1068\" height=\"850\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/99723364-983d-414c-b099-6fe054113db9_1068x850.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":850,\"width\":1068,\"resizeWidth\":null,\"bytes\":110230,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Sample output of the make help command that we will implement in this article.</figcaption></figure></div><p>What if we could provide a <code>make help</code> command that showed an overview of the project’s “build interface”? And what if we could embed such information inside the <code>Makefile</code>s themselves, close to the entities that they document? This idea is neither new nor mine, and it has been written about before by different people. However, I bet that most of you haven’t heard about it before so it’s worth for me to repeat it. And I think that my solution is a bit more comprehensive than others I’ve found. So here you go.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Targets</strong></h1><p>As I mentioned in the introduction, Make is often used as a command dispatcher: with very little code, you can write what essentially are multiple shell scripts with automatic chaining, all wrapped in one single interface. It’s all pretty terrible, but people are used to this pattern due to Make’s ubiquity and somehow expect it when they face a Make-based project.</p><p>To implement this command dispatcher idea, each user-facing action is exposed via a <em>target</em>. These targets tend to be marked as “phony”—i.e. they are targets that produce no outputs of their own. Take a look at this <code>Makefile</code>:</p><pre><code><code>.PHONY: build
build: target/debug/program
target/debug/program: src/main.rs src/lib.rs
	cargo build

.PHONY: test
test: build
	cargo test</code></code></pre><p>In the snippet above, the <code>target/debug/program</code> target represents a built <em>file</em>. This target depends on a list of sources and specifies what command to run to generate the output when it is missing or out of date (according to file modification times, <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html#file-modification-times\">yikes</a>). When you type <code>make target/debug/program</code>, you expect the file <code>target/debug/program</code> to exist on disk after the command completes.</p><p>But the snippet also shows two phony targets: <code>build</code> and <code>test</code>. When you type <code>make build</code> or <code>make test</code>, you do not expect neither a <code>build</code> nor a <code>test</code> file to be created, no. What you expect is that the project is built and tested. And for this, Make evaluates the dependencies of the phony targets (if any are specified, as is the case for <code>build</code>) and then unconditionally executes any commands in the phony targets (as is the case for <code>test</code>).</p><p>With this in mind, the first thing we want to do in our <code>make help</code> command is to document these “special” targets that represent user-facing actions. To do this, we’ll leverage one not-well-known aspect of Make’s syntax: the list of dependencies of a target is <em>cumulative</em> across multiple target definitions of the same name. Basically, these target definitions are equivalent:</p><pre><code><code># All dependencies in one line.
target/debug/program: src/main.rs src/lib.rs
# Dependencies spread over multiple lines.
target/debug/program: src/main.rs
target/debug/program: src/lib.rs</code></code></pre><p>Knowing this, we can add “extra” lines for a target and use one of those to document the target so that we do not end up with super-long lines. For example, we can do:</p><pre><code><code>target/debug/program: # Builds the program.
target/debug/program: src/main.rs src/lib.rs</code></code></pre><p>And then we are just one <code>grep</code> away from extracting the targets and their documentation:</p><pre><code><code>sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>OK fine. It’s a bit more complicated than just <code>grep</code> because we have to reformat the lines a bit and we need to create a nicely formatted table. Also, I know the <code>sed</code> syntax is awful, but I really don’t want to call into Perl or Python as other guides tell you just for this silly string manipulation. There are native Unix tools that can help us here, and they are much lighter-weight.</p><h1><strong>Variables</strong></h1><p>All other “self-documenting <code>Makefile</code>” tutorials I found out there focus exclusively on documenting targets. But <code>Makefile</code>s often expose another dimension of their API, and this is the collection of user-settable configuration variables that they accept.</p><p>Many <code>Makefile</code>s do things like:</p><pre><code><code>CFLAGS ?= -O2</code></code></pre><p>… to indicate that <code>CFLAGS</code> is set to <code>-O2</code>. But note: the <code>?=</code> operator invites users to override the variable’s value if they choose to. For example, if the user wanted to build the project in debug mode, they could probably do the following and get the code to build without optimizations and with debug symbols:</p><pre><code><code>$ make CFLAGS=\"-O0 -g\" build</code></code></pre><p>Given that these variables are user-facing, we should document them as well as part of the <code>make help</code> output.</p><p>To document variables, we don’t have the luxury of splitting their definition into multiple lines like we did with targets to prevent super-long lines. That said, we can still add comments at the end of the line, like shown below, and those comments won't be part of the variable's default value. It is important, however, to not leave any space between the default value and the comment, or else the spaces become part of the variable's value.</p><pre><code><code>DEVELOPER ?= 0# Set to 1 to enable developer builds.</code></code></pre><p>Like with targets, we are also just one <code>grep</code> away from extracting the variables and their documentation:</p><pre><code><code>sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>Again, more complicated than just a <code>grep</code>, but you get the idea.</p><h1><strong>Putting it all together</strong></h1><p>Alright. So now we know how to extract a table documenting targets and a table documenting variables, but these two lists may still be too obscure on their own. Which targets are important? Which variables might the user want to look into first?</p><p>To address this deficiency, we can preface those tables with some prose that explains, at a very high level, what to do when interacting with the project for the first time. To implement this, we can write the instructions in a separate file (like a <code>README.md</code>) next to the <code>Makefile</code>, and then have our <code>make help</code> command print out the text file’s contents.</p><p>And so without further ado, here is how we can tie everything together:</p><pre><code><code>.PHONY: help
help: # Shows interactive help.
	@cat README.md
	@echo
	@echo \"make variables:\"
	@echo
	@sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort
	@echo
	@echo \"make targets:\"
	@echo
	@sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>If you copy/paste this text, beware that there are embedded tabs in it. The ones at the beginning of the line are obvious, but the ones in the <code>[ ]</code> character classes are not. The latter are supposed to be <code>[ <tab>]</code>.</p><p>Now, have fun with this, but please don’t use Make for new projects if you can avoid it!</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "0.0" "image/jpeg") nil "9db2bf389780088355e57d18e63bd799") (29 (26620 53367 782565 147000) "https://blogsystem5.substack.com/p/dos-memory-models" "Revisiting the DOS memory models" "Julio Merino" "Mon, 30 Sep 2024 15:02:25 +0000" "<p>At the beginning of the year, I wrote a <a href=\"https://blogsystem5.substack.com/p/from-0-to-1-mb-in-dos\">bunch</a> <a href=\"https://blogsystem5.substack.com/p/beyond-the-1-mb-barrier-in-dos\">of</a> <a href=\"https://blogsystem5.substack.com/p/running-gnu-on-dos-with-djgpp\">articles</a> on the various tricks DOS played to overcome the tight memory limits of x86’s real mode. There was one question that came up and remained unanswered: what were the various “models” that the compilers of the day offered? Take a look at Borland Turbo C++’s code generation menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":140059,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Borland Turbo C++ showing its Code Generation menu, which displays the list of models we cover in this article.</figcaption></figure></div><p>Tiny, small, medium, compact, large, huge… What did these options mean? What were their effects? And, more importantly… is any of that legacy relevant today in the world of 64-bit machines and gigabytes of RAM? To answer those questions, we must start with a brief review of the 8086 architecture and the binary formats supported by DOS.</p><h1>8086 segmentation</h1><p>In the 8086 architecture, which is the architecture that DOS targeted, memory references are composed of two parts: a <strong>2-byte segment</strong> “identifier” and a <strong>2-byte offset</strong> within the segment. These pairs are often expressed as <code>segment:offset</code>.</p><p>Segments are contiguous 64KB chunks of memory and are identified by their base address. To be able to address the full 1MB of memory that the 8086 supports, segments are offset from each other by 16 bytes. As you can deduce from this, segments overlap, which means that a specific physical memory position can be referenced by many segment/offset pairs.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" width=\"1456\" height=\"590\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":590,\"width\":1456,\"resizeWidth\":null,\"bytes\":64437,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of two consecutive 8086 segments and how a single physical memory address can be expressed as different segment/offset pairs.</figcaption></figure></div><p>As an example, the segmented address <code>B800h:0032h</code> corresponds to the physical address <code>B8032h</code> computed via <code>B800h * 10h + 0032h</code>. While this pair is human-readable, that’s not how the machine-level instructions encode it. Instead, instructions rely on <strong>segment registers</strong> to specify the segment to access, and the 8086 supports four of these: CS (code segment), DS (data segment), ES (extra data segment), and SS (stack segment). Knowing this, accessing this sample memory position requires first loading <code>B800h</code> into <code>DS</code> and then referencing <code>DS:0032h</code>.</p><p>One of the reasons instructions rely on segment registers instead of segment identifiers on every memory access is efficiency: encoding the segment register to use requires only 2 bits (we have 4 segment registers in total) vs. the 2 bytes that would be necessary to store the segment base. More on this later.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">More means “the next article” because there is a lot of ground to cover to explain how this connects to today’s 64-bit world. Subscribe to Blog System/5 to not miss it!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>COM files</h1><p><a href=\"https://en.wikipedia.org/wiki/COM_file\">COM files</a> are the most trivial executable format you can think of: they contain raw machine code that can be placed at pretty much any memory location and executed without any sort of post-processing. There are no relocations, no shared libraries, no nothing to worry about: you can just blit the binary into memory and run it.</p><p>The way this works is by leveraging the 8086 segmented architecture: the COM image is loaded into <em>any</em> segment and always at offset 100h within that segment. All memory addresses within the COM image must be relative to this offset (which explains the <code>ORG 100h</code> you might have seen in the past), but the image doesn’t need to know which segment it is loaded into: the loader (DOS in our case, but COM files come from CP/M actually) sets CS, DS, ES, and SS to the exact same segment and transfers control to <code>CS:100h</code>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" width=\"1456\" height=\"809\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":809,\"width\":1456,\"resizeWidth\":null,\"bytes\":160575,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">At the top, representation of a COM file as it is stored on disk. At the bottom, an explanation of how DOS proceeds to load this COM file into two different segments.</figcaption></figure></div><p>Magic! COM files are essentially PIE (<a href=\"https://en.wikipedia.org/wiki/Position-independent_code\">Position Independent Executables</a>) without requiring any sort of MMU or fancy memory management by the kernel.</p><p>Unfortunately, not everything is rosy. The problem with COM files is that they are limited in size: because they are loaded into one segment and segments are 64KB-long at most, the largest a COM file can be is 64KB (minus the 256 bytes reserved for the PSP at the front). This includes code <em>and</em> data, and 64KB isn’t much of either. Obviously, when the COM program is running, it has free reign over the processor and can access any memory outside of its single segment by resetting CS, DS, ES, and/or SS, but all memory management is left to the programmer.</p><h1>EXE files</h1><p>To resolve the limitations of COM files in DOS, Microsoft came up with a different executable format for DOS: the <a href=\"https://en.wikipedia.org/wiki/DOS_MZ_executable\">EXE file</a>, also known as an MZ executable.</p><p>Compared to COM files, EXE files have some internal structure and are not bound by the 64KB limit: they can contain larger code and data blocks in them. But… how is that possible given that 8086 segments are still 64KB-long at most? The answer is simple: EXE files contain <em>multiple</em> segments and spread code and data over them.</p><p>To support multiple segments at runtime, EXE files contain relocation information in their header. Conceptually, relocations tell the loader which positions in the binary image contain “incomplete” pointers that need to be fixed up with the segment base addresses of the segments after they are loaded in memory. DOS, acting as the loader, is responsible for doing this patching.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" width=\"1456\" height=\"451\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":451,\"width\":1456,\"resizeWidth\":null,\"bytes\":107229,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an EXE file and the content of one of its code segments. Within the code, we can see a near pointer and two far pointers that will require patching at runtime to point to the other segments in the binary.</figcaption></figure></div><p>How many segments go into the EXE though? Well, it depends, because not all programs have the same needs. Some programs are tiny overall and could fit in a COM file. Other programs contain large portions of data but little code. Another set of programs contain a lot of code and data. Etc.</p><p>So then the question becomes: how can the one-size-fits-all EXE format support these options in an efficient manner? This is where memory models become important, but to talk about those, we must do another detour through pointer types.</p><h1>Pointer types</h1><p><a href=\"https://en.wikipedia.org/wiki/Locality_of_reference\">The locality principle</a> says that “a processor tends to access the same set of memory locations repetitively over a short period of time”. This is easy to reason about: code normally runs almost-sequentially and data is often packed in consecutive chunks of memory like arrays or structs.</p><p>Because of this, expressing <em>all</em> memory addresses as 4-byte <code>segment:offset</code> pairs would be wasteful, and this is where 8086’s segmentation plays in our favor again. We can first load a segment register with the base address of “all of our data” and then all we need to do is record addresses as offsets within that segment. The fewer times we have to reload segment registers, the better because the less information we have to carry around in every instruction and in every memory reference.</p><p>But we can’t just always use offsets within a single segment because we may be dealing with more than one segment. And offsets come in various sizes so using a unique size for them all would be wasteful too. Which means memory addresses, or <em>pointers</em>, need to have different shapes and forms, each best suited for a specific use case.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":32700,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of two short pointers: one addressing a higher memory address (possibly a forward jump to skip a conditional branch) and one addressing a lower memory address (probably a backwards jump to return to the beginning of a loop).</figcaption></figure></div><p><strong>Short pointers</strong> take just 1 byte and express a <em>relative</em> address from the instruction being executed. These are specially useful in jump instructions to keep their binary representation compact: jumps appear in every conditional or loop, and in many cases, conditional branches and loop bodies are so short that minimizing the amount of code required to express these branch points is worthwhile.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":28003,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of a near pointer.</figcaption></figure></div><p><strong>Near pointers</strong> can reference addresses within the 64KB segment implied “by context” and are 2-byte long. For example, an instruction like <code>JMP 12829h</code> does not usually need to carry information about the segment this address references because code jumps are almost-always within the same CS of the code issuing the jump. Similarly, an instruction like <code>MOV AX, [5610h]</code> assumes that the given address references the currently-selected DS so that it doesn’t have to express the segment every time. The offset encoded by the near pointer can be relative or absolute.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" width=\"1456\" height=\"485\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":485,\"width\":1456,\"resizeWidth\":null,\"bytes\":48837,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of a far pointer referencing an address in another segment.</figcaption></figure></div><p><strong>Far pointers</strong> can reference any memory address by encoding a segment and an offset. They are 4-byte long. When used in pointer arithmetic, the segment stays fixed and only the offset varies. This is relevant, for example, when iterating over arrays as we can load the base address into DS or ES just once and then manipulate the offset within the segment. However, this means that such iteration has a maximum range of 64KB.</p><p><strong>Huge pointers</strong> are like far pointers in that they are also 4-byte long and can reference any memory address, but they eliminate the 64KB limitations around pointer arithmetic. They do so by recomputing the segment and offset portions on every memory access (remember that segments are overlapping so we can come up with multiple segment/offset pairs for any physical address). As you can imagine, this requires extra code on every memory access and thus huge pointers impose a noticeable tax on run time.</p><h1>Memory models</h1><p>And now that we know about 8086 segmentation, EXE files, and pointer types… we can finally tie all of these concepts together to demystify the memory models we used to see in old compilers for DOS.</p><p>Here is the breakdown:</p><ul><li><p><strong>Tiny</strong>: This is the memory model of COM images. The whole program fits in one 64KB segment and all segment registers are set to this one segment at startup. This means that all pointers within the program are short or near because they always reference this same 64KB segment.</p></li><li><p><strong>Small</strong>: Uses near pointers everywhere, but the data and stack segments are different from the code segment. This means that these programs have 64KB for code and 64KB for data.</p></li><li><p><strong>Compact</strong>: Uses short pointers for the code but far pointers for the data. This means that these programs can use the full 1 MB memory space for data and, as such, it was particularly useful for games where the code would be as tight as possible while being able to load and reference all assets in memory.</p></li><li><p><strong>Medium</strong>: The opposite from compact. Uses far pointers for code and short pointers for data. This model is weird because, if you had a program with a lot of code, it was probably the kind of program that handled a lot of data too.</p></li><li><p><strong>Large</strong>: Uses far pointers everywhere so both code and data can reference the full 1 MB address space. However, because of what far pointers are, all memory <em>offsets</em> are 64 KB at most which means data structures and arrays are limited in size.</p></li><li><p><strong>Huge</strong>: Uses huge pointers everywhere. This overcomes the limitations of the large model by emitting code to compute the absolute addresses of every memory access and allows structs and arrays that span over 64 KB of memory. Obviously, this comes at a cost: the program code is now larger and the runtime cost is much bigger.</p></li></ul><p>And that’s it!</p><p>It is worth highlighting that these models were all <em>conventions</em> that a vintage C compiler used to emit code. If you were writing assembly by hand, you could mix-and-match pointer types to do whatever you wanted given that these concepts had no special meaning to the OS.</p><h1>Evolving to today’s world</h1><p>Everything I have told you about until now is legacy stuff that you could easily dismiss as useless knowledge. Or could you?</p><p>One thing I did <em>not</em> touch upon is the concept of <strong>code density</strong> and how it relates to performance. The way we choose to express pointers in the code has a direct impact on code density, so when we evolve computing from 16-bit machines like the 8086 to contemporary 64-bit machines, pointer representations grow by <em>a lot</em> and we face some hard choices.</p><p>But to explain all of this and answer the performance questions, you’ll have to wait for the next article. So subscribe now to not miss out on that one!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "0.0" "image/jpeg") nil "7738f783fd9ee27d7ed8f77657b2b9c4") (28 (26620 53367 776002 64000) "https://blogsystem5.substack.com/p/20-years-of-blogging" "20 years of blogging" "Julio Merino" "Sat, 22 Jun 2024 16:01:01 +0000" "<p><a href=\"https://blogsystem5.substack.com/\">Blog System/5</a> hasn’t always been called this way and it hasn’t been my first experience with blogging either. In fact, today marks the 20th anniversary of this publication in its various incarnations so it’s time for a bit of reflection.</p><p>Just to set context for when 20 years ago was: Windows XP was almost 3 years old, Ubuntu had just debuted, Apple computers were still PowerPC-based, Half Life 2 was about to launch, and Slashdot was the place to be instead of the yet-to-be-created Hacker News. As for myself, I was still in college, had copious amounts of free time, and was a really active contributor to NetBSD.</p><p>So let’s start with a trip down memory lane before getting into the retrospective and the analysis of how <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">my Substack experiment</a>, which started late last year, has turned out. Beware that because this is an introspection post, all of the generalizations that follow are backed by feelings, not hard data, so take them with a grain of salt.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Before continuing, take a moment and consider subscribing. It’s completely free but knowing that you care is what makes this publication exist!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>History: Episode one</h1><p>Looking back at <a href=\"https://jmmv.dev/2004/06/welcome-to-my-new-journal.html\">my very first post from June 22nd, 2004</a>—oh wow, my English was <em>bad</em>—I had an earlier experiment of a blog a few months prior that didn’t last more than three entries. But the newer iteration, started during college finals of course, did stick. I originally chose the LiveJournal platform because it had more features than Blogger, and thus “jmmv’s weblog” was born. Why “weblog” and not “blog”? Because the “blog” term wasn’t yet the popular one.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":140932,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of the \"jmmv's weblog\" site on LiveJournal via the Wayback Machine. <a href=\"https://web.archive.org/web/20041126220647/http://www.livejournal.com:80/users/jmmv/\">Scraped on November 26th, 2004.</a></figcaption></figure></div><p>My choice of LiveJournal didn’t last very long though. I migrated to Blogger on <a href=\"https://jmmv.dev/2005/10/blog-migrated-to-blogger-welcome.html\">October 22nd, 2005</a> because it had improved significantly by then and it was growing in popularity. As part of that transition, I renamed the blog to “The Julipedia”—a nickname that a friend gave me because I usually had answers to all of his Linux-related questions. And yes, Wikipedia was a pretty new thing back then too, having just launched in 2001 and still being mocked as “the thing that will never compete with real encyclopaedias”. Ha, ha.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/dc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":170754,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of \"The Julipedia\" site on Blogger via the Wayback Machine. <a href=\"https://web.archive.org/web/20060412020801/http://julipedia.blogspot.com/\">Scraped on April 12th, 2006.</a></figcaption></figure></div><p>Blogger was just fine for a long time… until Google+ messed things up in 2011 or so. During that era, Google was shoehorning their social platform everywhere, and part of that process was optionally injecting the commenting system of Google+ into Blogger. I took the bait and adopted the new commenting experience—which, in other words, meant that I killed engagement overnight.</p><p>In any case, I continued to hold onto Blogger until about 2015. At that point, Medium was the new hot thing and, having grown disillusioned with Blogger’s staleness—the platform didn’t receive any love because all development and product resources had gone into the dwindling Google+—<a href=\"https://jmmv.dev/2015/05/hello-medium.html\">I gave it a try</a>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":90465,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of my Medium publication via the Wayback Machine. <a href=\"https://web.archive.org/web/20160701041554/https://medium.com/@jmmv\">Scraped on July 1st, 2016.</a></figcaption></figure></div><p>Medium was great: its UI was <em>neat</em> and their value proposition was that their network would help me increase the reach of my articles while offering a delightful publishing experience. But things went downhill pretty quickly too: the desire to monetize Medium made it gain aggressive subscription popups and paywalls everywhere, and it started filling up with “Top N things to XYZ” spam. AI-generated garbage? Not yet, but close. Yikes SEO.</p><h1>History: Episode two</h1><p>My Medium experiment <a href=\"https://jmmv.dev/2016/01/medium-experiment-wrapup.html\">didn’t last very long</a>. I published 8 posts over the course of 5 months but I knew I had to move elsewhere. Part of this move involved exporting those 8 posts and reimporting them into Blogger, which was easier said than done. Medium offered an “export” feature indeed, which sold me in the first place to try it out, but the <em>content</em> of the export was <em>unusable</em>. It took a lot of effort to clean up the tainted HTML that the platform produced to reimport it anywhere else. And this is when it hit me: I was not in control of my content, which was validated by seeing that Blogger’s export suffered from the same issues.</p><p>Which drove me to static hosting. <a href=\"https://jmmv.dev/2016/05/homepage-v3.html\">I extended the trivial homepage I already had</a> on the web with a blog section, built with Jekyll first and <a href=\"https://jmmv.dev/2018/02/from-jekyll-to-hugo.html\">then with Hugo</a>, and managed my blog in there for about 8 years. I dabbled with going back to a CMS a few times because the authoring experience in Markdown+Git+Hugo isn’t particularly… amenable to posting. But every time I prototyped an alternative, I ended up hitting the same roadblocks around content ownership. I wanted to own the originals in a future-proof format.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":113718,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of my static blog via the Wayback Machine. <a href=\"https://web.archive.org/web/20161224052720/http://julio.meroh.net/\">Scraped on December 24th, 2016.</a></figcaption></figure></div><p>But wait… you are reading this in Substack, aren’t you? “WTH!” you must be thinking. How can I reconcile what I just said with publishing on this platform? Well… over the 8 years of static hosting, it was almost impossible for me to grow my blog’s readership. I tried various things to grow a subscribers base, but nothing worked. And Substack seemed to be the new cool kid on the block where various folks I follow post content, so I had to try it out. This experiment is <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">what brought you Blog System/5 in the first place</a>. And you know what? It has been pretty cool.</p><p>The key difference between the Substack experiment and the Medium experiment is that I’m authoring the content in Markdown first, using the exact same platform I had previously set up for my static blog. Only when the posts are ready to publish, I literally copy/paste them into Substack and then set up a redirect in my static blog to point to Substack. It’s painful indeed, but I feel at peace because I can pull the rug at any time and be back in my happy static blog.</p><h1>Evolution: Writing approach</h1><p>Anyhow, enough talk about the history of the blog. Let’s talk about how its content has changed form over the years and <em>why</em> it has had to change. And to talk about content changes, we must talk about the evolution of audience behaviors: if you care about being read at all, you must consider who you are writing for.</p><p>With that in mind, the obvious question is: do people care about blogs these days? I’d say no, not really. Proof of this is when you hear people say “so and so wrote a blog” (cringe) when they actually mean “a blog <em>post</em>”. The concept of a blog as a personal publication seems to have been lost in favor of individual posts. I’m sure you can think of some recent popular articles that came your way, but, question: can you remember <em>where</em> you read them or <em>who</em> the author was? I bet not.</p><p>As a consequence, the type of content for a long-running blog like this one has had to evolve. Take a moment to skim <a href=\"https://jmmv.dev/archive.html\">through the archives</a> and look for patterns. You might notice that, back when I started blogging, my usual article was about 350 words long and not very polished. This was pretty common in the blogosphere: most blogs had similar short articles, often just describing the author’s “daily doings”.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":23243,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Median words per post by year for all articles that I've written in this blog and other publications.</figcaption></figure></div><p>Fast-forward to today and you can clearly see a change in the shape of the articles you read here and elsewhere: they are <em>much</em> longer now, even if attention spans are infinitesimally small. One reason is that we used to use blogs like a social network, to publish our “daily doings” for our committed followers to see. Contrast that to today: there is almost zero chance anyone will come across a bunch of short articles frequently enough for them to become an avid reader. The other reason, closely related to this one, is that it’s easier for long-form posts to “go viral”—and while you might not care about reach, some of us do.</p><p>Writing longer-form posts has had a direct inverse consequence on the frequency of the posts though, for obvious reasons:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":22058,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Total number of posts per year in this blog, but also including occasional articles in other publications.</figcaption></figure></div><p>Having to dedicate many, <em>many</em>, <em><strong>many</strong></em> hours to every long-form post necessarily means that the frequency of the articles has to decrease. For this blog, you can clearly see that I started strong with a post about every two or three days and now I consider myself lucky if I am able to average two posts per month per year. I also have much less free time available, so whenever I write an article, I want it to be of higher quality than before.</p><p>Fewer articles is not a bad metric per se though. Investing time to write long-form prose is beneficial. Long articles require much more work to put together indeed, but I find that spending such time helps me understand each topic in a better way. Furthermore, one only gets better at writing by, surprise, writing: if you skim through the oldest articles, you’ll notice that they were, ehem, mediocre—yet I made the conscious decision to blog and to do so in English. As a result, I think that my contemporary copy is pretty decent, and this has helped me immensely in my professional environment. I couldn’t have gotten here without going through this long journey.</p><p>The other big difference in how the content has evolved is the presence of pictures:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":26460,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Evolution of the number of posts that include images over time.</figcaption></figure></div><p>In the past, I rarely included pictures in any article: these were not necessary because the articles were shorter and because resharing articles in social media didn’t require pictures to fight for the small chance of being seen. These days, however, you must have pictures in order to make articles stand out when they are shared. And just due to the nature of the longer text, it’s useful to include pictures, diagrams or code snippets to break the wall of text and make the copy easier to digest. Shout out to <a href=\"https://draw.io/\">draw.io</a>, which has been awesome to create diagrams in some recent posts.</p><h1>Evolution: Consumption and audience</h1><p>Shifting gears a little bit, blogs were the true decentralized platform. Any individual could easily start a blog in the service of their choice, possibly self-hosting it if they didn’t want to use a commercial service, and anyone could trivially subscribe to those blogs via one of many RSS aggregators. And, yes, I know, this is true today as well: you can <em>still</em> create a blog and you can <em>still</em> subscribe to (most) blogs via RSS; however, the way blogs are “consumed” has changed.</p><p>One thing that was useful in the past were the so-called “Planets”: websites that acted as curated aggregators of blogs by topic. Some of these still exist, such as <a href=\"https://planet.kde.org\">Planet KDE</a> or <a href=\"http://fedoraplanet.org/\">Planet Fedora</a>, but they don’t <em>feel</em> like they used to. The longer posts and the (ab)use of images has made Planets unwieldy: their front pages are extremely long and contain lots of irregularly-formatted pictures, offering little content cohesion. Years ago, because articles were shorter, more fit in one page, and because Planets were popular, authors often replied to each other’s <s>controversial</s> interesting thoughts by posting on <em>their</em> platform and seeing their articles bubble up through the Planets. Much like a social media timeline these days but without a central authority.</p><p>So, without RSS aggregators or Planets, how do people find blogs now and <em>stay engaged</em>? Well… they don’t for the most part? Organic traffic is pretty much useless at building any kind of following: people come in, read the very few words they were looking for, and vanish right away. Gathering traffic from self-promotion in social media is almost a futile experiment. So the best bet is to have articles turn into “one-off hits” on sites like Hacker News. But even then, the majority of the traffic from those sources ends up being noise as well because it doesn’t lead to conversions into frequent readers. Getting content seen by a reasonable number of people is a fight with every single post.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" width=\"1071\" height=\"515\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":515,\"width\":1071,\"resizeWidth\":null,\"bytes\":89738,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Traffic to my blog during the second half of 2022 as captured by <a href=\"https://endtracker.azurewebsites.net/\">my own analytics platform</a>. I selected this period to avoid conflating the data with the creation of Blog System/5 and to avoid a humongous traffic spike driven by the <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">Fast machines, slow machines</a> post that made the other lines impossible to read. Note how there is no growth: the peaks are driven purely by Hacker News and the like.</figcaption></figure></div><p>What am I basing this on? Well, for starters, my blog has had email subscriptions for more than 10 years, first powered by FeedBurner and then by <a href=\"https://jmmv.dev/2023/06/in-house-email-subscriptions.html\">my own mechanism</a>. In that period of time, I only saw the subscribers count rise to about 170, which feels pretty pathetic to be honest. I resisted the urge to add “on-your-face” subscription popups, but the lack of those, the fact that some people are “invisible” because of RSS aggregators, and the fact that readers had to subscribe to the blog via obscure platforms… well, there have few incentives to opt into potential email spam.</p><p>Now compare this past multi-year effort of a self-hosted blog with custom email subscriptions to what I’ve experienced on Substack since the launch of Blog System/5:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" width=\"742\" height=\"453\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":453,\"width\":742,\"resizeWidth\":null,\"bytes\":20197,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Subscribers growth during the first 6 months of Blog System/5's existence. I pretty much paused publishing in March to focus on other side projects and thus haven't seen any major growth since.</figcaption></figure></div><p>I created Blog System/5 in late October 2023 and by March 2024 I had already amassed 700+ subscribers. It’s also true that I was lucky to have a few articles spread through Hacker News and other sites, and that I put a lot more effort in crafting these than what I wrote in the past, but still: using a platform that people know, that is focused on writing, and in which <em>readers already have accounts</em> helps with growth. Yes, I’m sure there is a lot of fake accounts in there given that the typical “open count” for any article hovers around 50%, but that feels impressive regardless compared to what I was able to achieve in the past.</p><h1>Evolution: Monetization</h1><p>And before parting, let’s talk about the taboo topic, should we? Every hobby has to become a side hustle these days, right, but God forbid you try to charge for it.</p><p>I have to confess that I’ve dabbled with monetizing my writing and done some experiments. These included: <a href=\"https://jmmv.dev/2009/06/trying-adsense.html\">enabling Google AdSense</a> back when I used Blogger and then <a href=\"https://jmmv.dev/2010/05/ads-gone.html\">running away from it</a>; writing paid-for <a href=\"https://jmmv.dev/2019/10/onlamp-articles.html\">articles for OnLamp</a>, which weren’t really part of this blog originally but were written in the same “spirit”; enabling optional paid subscriptions in Substack, which has generated a handful of leads; and using Amazon affiliate links for certain product-focused articles, which has also generated some sales.</p><p>None of these have generated any meaningful amount of income, but that doesn’t mean it isn’t exciting to see pennies flow in! In any case, I still struggle with the thought of pursuing monetization. It’d feel great to be paid for the effort I put in writing, but in the grand scheme of things, I would not be able to make it my primary income—and I’d probably not want it to be either—without putting in <em>a ton more</em> effort. Plus I like my content to reach as far as possible, which paywalls would prevent.</p><p>Does that mean I will <em>never</em> try to more aggressively monetize this type of content? Never say never, but I have no plans for now. That said, I will still gladly take and infinitely appreciate any donations you might send; don’t be shy!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><h1>From blogging to… newslettering?</h1><p>Why do I keep writing a blog after 20 years? Because I enjoy the <em>process</em> and the reward of seeing a complete piece be appreciated by many. I know, “views” are a vanity metric, but they do translate into tangible real-world benefits. I’m convinced that I had the chance to land a Google internship in 2008 <em>because</em> of what I wrote in my blog; I’m also pretty certain that my recent job changes have been aided by my writing; and during the last few months, I’ve met some folks I hadn’t seen for a long time and several have exclaimed “hey, I enjoy your blog!” which, let’s be honest, is flattering to hear.</p><p>Are blogs truly dead? The answer sounds like “yes”. But what if I asked you if newsletters are truly dead? The answer sounds like “of course not”, right? And, to me, these two look like essentially the same thing. Maybe the differences lie in the fact that blogs <em>used to</em> be made of much shorter posts and used to be part of a larger community, whereas newsletters focus on longer pieces distributed primarily via email… but considering how blogging itself has evolved for some (including me), the two are identical.</p><p>Which brings me to the final thought of the day: is “Blog System/5” the same as the “jmmv’s weblog” that launched 20 years ago? No, not really. They are quite different beasts at this point, but they still come from the same—even if older—person, they still scratch the same itch, and they are still my main window to showcase ideas and projects to the outside world. So, to me, they are indeed the same.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "0.0" "image/jpeg") nil "7eff027ce8d9c6f265d76dac6fd39d8b") (27 (26619 29094 972477 225000) "https://blogsystem5.substack.com/p/bazel-at-snowflake-two-years-in" "Bazel at Snowflake two years in" "Julio Merino" "Sat, 15 Mar 2025 01:00:58 +0000" "<p>Two and a half years ago, I <a href=\"https://jmmv.dev/2022/10/bye-microsoft-hi-snowflake.html\">joined Snowflake</a> to help their mission of migrating to Bazel. I spent the first year of this period as an Individual Contributor (IC) diving deep into the migration tasks, and then I took over the Tech Lead (TL) role of the team to see the project through completion.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":792369,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>This week, we publicly announced that we completed our migration to Bazel for the largest part of our codebase and we provided details on our journey. I did not publish that article here for obvious reasons, so… today’s entry is going to be a light one: all I want to do is point you at our announcement as well as the various <em>other</em> related articles that came before it.</p><p>Don’t despair though: those articles, including the announcement, are all full of technical details—just like the kind of content you expect to receive from Blog System/5. So, even if this piece is light, you have enough reading material for the weekend via the links below.</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\">“Addressing Bazel OOMs”</a></strong><br><em>March 16th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\" width=\"1456\" height=\"972\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":972,\"width\":1456,\"resizeWidth\":null,\"bytes\":1420523,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\",\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"></picture><div></div></div></a></figure></div><p>This was the very first article that we in the Engineering Systems organization—previously known as Developer Productivity Engineering—wrote publicly about our work. Me writing it was no coincidence as I was the one advocating for more openness about the cool stuff we were doing. Yes, I missed blogging about Bazel <a href=\"https://jmmv.dev/tags/bazel/index.html\">as I had done in the years prior</a>.</p><p>In this article about Out-Of-Memory (OOM) conditions, I covered the very interesting problem of trying to fit Bazel builds into limited laptop resources. This was déjà-vu for me: back when I was in the Blaze team at Google, I owned the same problem of making Blaze, a tool that had grown assuming massive workstations, run decently on machines with limited resources.</p><p>The problems were technically challenging and worth talking about, hence this article. In it, I covered three issues: preventing Bazel from spawning too many memory-hungry compilers and linkers at once; making nested builds behave nicely; and tuning Bazel to drive a large number of remote tasks with limited memory resources.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\">“Analyzing OOMs in IntelliJ with Bazel”</a></strong><br><em>October 6th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\" width=\"1300\" height=\"550\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":550,\"width\":1300,\"resizeWidth\":null,\"bytes\":143457,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>Our saga dealing with OOMs was arduous and long, which you can tell by the time gap between the previous article and this one.</p><p>In this piece, I looked at how IntelliJ itself was running into memory limits, which resulted in the IDE and its container VM freezing during normal operation. The result of this work was careful tuning of the Bazel project settings to make it fit within reasonable limits, but the interesting part—and the one described here—was the process to arrive to those findings.</p><p>Not too long after I wrote this, we pivoted away from constrained laptop builds to cloud-based workstations, which made all OOM conditions vanish at the expense of using much more RAM (maybe <em>too much</em> RAM, but alas… it’s cheap). Stay tuned for an upcoming article (not from me this time!) on this topic.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\">“Build farm visualizations”</a></strong><br><em>October 20th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\" width=\"1456\" height=\"561\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":561,\"width\":1456,\"resizeWidth\":null,\"bytes\":895757,\"alt\":\"\",\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/build-farm-visualizations.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>As part of our migration to Bazel, we didn’t just convert our build from one tool to another. We also decided to deploy our own remote execution cluster from the get go based on <a href=\"https://github.com/buildbarn\">Buildbarn</a> which… gave us its own set of problems. Buildbarn’s architecture is straightforward in paper, but there are a ton of knobs to control how it runs. Making it scale to the huge volume of traffic we experience was not an easy feat.</p><p>One specific problem we faced was overall poor performance of our cluster, which was eventually root-caused to our remote execution workers using slow local storage volumes. This issue had escaped us for a while, and it wasn’t until I wrote a tool to <em>visualize</em> the cluster behavior that it didn’t become obvious. From there, the solution was easy.</p><p>Wanna know more? We are hosting a 1-day conference <em>next week</em> on Buildbarn specifically. <a href=\"https://docs.google.com/forms/d/e/1FAIpQLSeG4We59b6labcH77JOiblk7F3MRi8LH6SbjIrFTNCBYXeJnA/viewform\">See the schedule and sign up</a> if you can make it!</p><div><hr></div><p><strong><a href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\">“Fast and Reliable Builds at Snowflake with Bazel”</a></strong><br><em>March 13th, 2025</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\" width=\"1200\" height=\"514\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":514,\"width\":1200,\"resizeWidth\":null,\"bytes\":172503,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>And finally, the crown jewel. This is the official article published just yesterday where I present the 2-year journey of our migration. In it, I explain the challanges that we faced with our C++ and Java codebases specifically, the choices behind our use of remote execution, and the path we took to production. I conclude with a glimpse on what lies ahead of us.</p><div><hr></div><p>That’s all for today. I promised it would be short :)</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "0.0" "image/jpeg") nil "6ad51dd52492b022c36189e3f8e0ab11") (26 (26619 29094 971283 563000) "https://blogsystem5.substack.com/p/hardware-autoconfiguration" "Hardware discovery: ACPI & Device Tree" "Julio Merino" "Sat, 01 Mar 2025 00:10:54 +0000" "<p>If you grew up in the PC scene during the 1980s or early 1990s, you know how painful it was to get hardware to work. And if you did not witness that (lucky you) here is how it went: every piece of hardware in your PC—say a sound card or a network card—had physical switches or jumpers in it. These switches configured the card’s I/O address space, interrupts, and DMA ports, and you had to be careful to select values that did not overlap with other cards.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" width=\"663\" height=\"448\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":448,\"width\":663,\"resizeWidth\":null,\"bytes\":89630,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Portion of a Sound Blaster Pro ISA card focusing on the jumpers to configure its I/O settings.</figcaption></figure></div><p>But that wasn’t all. Once you had configured the physical switches, you had to tell the operating system and/or software <em>which</em> specific cards you had and how you had configured them. Remember <code>SET BLASTER=A220 I5 D1 H5</code>? This DOS environment variable told programs which specific Sound Blaster you had installed and which I/O settings you had selected via its jumpers.</p><p>Not really fun. It was common to have hardware conflicts that yielded random lock-ups, and thus <a href=\"https://wiki.osdev.org/ISA\">ISA “Plug and Play”</a>, or PnP for short, was born in the early 1990s—a protocol for the legacy ISA bus to enumerate its devices and to configure their settings via software. Fast-forward to today’s scene where we just attach devices to external USB connectors and things “magically work”.</p><p>But how? How does the kernel know which physical devices exist and how does it know which of the many device drivers it contains can handle each device? Enter the world of hardware discovery.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If this sounds interesting, please consider subscribing to Blog System/5! It’s completely free but you can also choose to donate to keep me writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Hardware topology</strong></h1><p>When you learn about the <a href=\"https://en.wikipedia.org/wiki/Von_Neumann_architecture\">Von Neumann architecture</a> in school, you are typically told that there is a CPU, a chunk of memory, and… “I/O devices”. The CPU and memory portions are where all the focus is put and the I/O devices portion is always “left to the reader”. However, there is <em>a lot</em> of stuff happening in that nebulous cloud.</p><p>The first question that arises is: what’s in that I/O cloud? Well, take a look:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" width=\"785\" height=\"576\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":576,\"width\":785,\"resizeWidth\":null,\"bytes\":93266,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The Windows 2000 Device Manager showing the devices by their connection, not by their type. I've chosen to show you this configuration of a virtual machine instead of what a current Windows 11 system shows because the older view is simpler to digest.</figcaption></figure></div><p>Whoa, that’s a lot of stuff, but we can classify the items in the “nebulous cloud of I/O devices” into two categories:</p><ul><li><p>The devices themselves, obviously.</p></li><li><p>The busses that connect those devices to the CPU.</p></li></ul><p>Both are important: you might have a fancy keyboard with extra keys that requires a special driver, and this keyboard might come in PS/2 and USB versions. The driver for the keyboard may be the same for each version, but the “glue” that attaches this keyboard to either bus is different, and the way the kernel can tell whether the keyboard is attached to one port or another also differs.</p><p>So how does the kernel know how to find hardware without tons of repeated code for every bus, you ask? It does so via its knowledge of the hardware topology. Just above, I showed you Windows’ view of this, but for the rest of this article, I’ll use the BSD internals (and NetBSD specifically) because that’s what I know best. Don’t let that put you off though: all kernels have to do something similar and the differences among them are likely not meaningful.</p><p>Here is a little snippet of the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/amd64/conf/GENERIC\">default NetBSD kernel configuration file for the amd64 platform</a>. This snippet lays out the topology of serial ports in the PC and the busses in which they may appear:</p><pre><code><code>pci*    at mainbus? bus ?
pcib*   at pci? dev ? function ?
puc*    at pci? dev ? function ?
com*    at puc? port ?
isa0    at mainbus?
isa0    at pcib?
com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3
acpi0   at mainbus0
com*    at acpi?</code></code></pre><p>Daunting if you have never seen anything like this, I know, but let me translate this to a diagram:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" width=\"1456\" height=\"922\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/e1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":922,\"width\":1456,\"resizeWidth\":null,\"bytes\":85835,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how the com device is expected to appear under various busses according to the kernel configuration file.</figcaption></figure></div><p>Much clearer in picture form, right? What this chunk of configuration does is tell the kernel the places where the <code>com</code> driver can find serial ports. We have a chunk that says that <code>com0</code> and <code>com1</code> can appear on the ISA bus at <em>specific</em> I/O addresses and interrupts, and in turn that the ISA bus may be a directly-addressable physical bus (<code>isa0 at mainbus?</code>) and/or an ISA bus exposed via a PCI bridge (<code>isa0 at pcib?</code>). Then, we have additional entries telling us that the serial ports can also be configured via ACPI (<code>com* at acpi?</code>), and that the serial ports may exist on expansion cards (<code>com* at puc?</code>) providing communication ports via the PCI bus (<code>puc* at pci?</code>).</p><p>The problem is: the kernel configuration tells us <em>what may exist</em>, not <em>what actually exists</em> on a machine. In a sense, the configuration file “wires” the code of the device drivers like <code>com</code> so that they can find devices that appear under the <code>isa</code>, <code>pci</code>, or <code>acpi</code> busses. But the kernel must still, at runtime, check and see where the devices actually are. How does that happen?</p><h1><strong>Hardware auto-configuration</strong></h1><p>To answer the question of how the kernel discovers which hardware is present and where it is, let’s dissect NetBSD’s <a href=\"https://man.netbsd.org/autoconf.9\">autoconf(9)</a> manual page:</p><blockquote><p>Autoconfiguration is the process of matching hardware devices with an appropriate device driver. In its most basic form, autoconfiguration consists of the recursive process of finding and attaching all devices on a bus, including other busses.</p></blockquote><p>From this paragraph, we can extract the following: the kernel contains a collection of device drivers (like the <code>com</code> presented earlier). Device drivers are just code that knows how to interact with specific devices, but the “location” of these devices in the hardware topology may vary (the “bindings” to <code>isa</code>, <code>puc</code>, and <code>acpi</code> in the earlier example). Moving on:</p><blockquote><p>The autoconfiguration framework supports direct configuration where the bus driver can determine the devices present. The autoconfiguration framework also supports indirect configuration where the drivers must probe the bus looking for the presence of a device. Direct configuration is preferred since it can find hardware regardless of the presence of proper drivers.</p></blockquote><p>Direct and indirect configuration. Hmm. This sounds like the PnP story, and it kinda does. See, pay close attention to these two lines from the earlier snippet:</p><pre><code><code>com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3</code></code></pre><p>These are the BSD equivalent of the <code>SET BLASTER=A220 I5 D1 H5</code> command for DOS I mentioned in the introduction: they tell the kernel which precise addresses and interrupts to use for the two standard PC serial ports <em>if an ISA bus is present</em>.</p><p>But what about <code>com* at puc?</code> and <code>com* at acpi?</code>? These lines are neat because they do <em>not</em> tell us, in advance, where to find the serial ports: we expect the kernel to discover those details at runtime so that we don’t have to recompile the kernel when the hardware changes. But even if these two look similar, they are quite different: the <code>com* at puc?</code> is an indirect configuration entry: the <code>puc</code> driver will have to probe the PCI bus for the presence of a communications card and, if one exists, tell the <code>com</code> driver that it can attach to it. On the other hand, the <code>com* at acpi?</code> entry is direct: the kernel will read the ACPI configuration (a static table) to know where the ports are and then use those details to configure the <code>com</code> driver.</p><p>Alright, so this raises <em>another</em> question. What <em>is</em> ACPI?</p><h1><strong>ACPI</strong></h1><p>ACPI, despite being declared with <code>acpi0 at mainbus0</code> in a form similar to <code>isa0 at mainbus?</code>, is <em>not</em> a bus: ACPI does not physically connect devices to one another. To understand what ACPI does, we can start by realizing that it stands for <a href=\"https://en.wikipedia.org/wiki/ACPI\">Advanced Configuration and Power Interface</a> and then, quoting the Wikipedia article:</p><blockquote><p>Advanced Configuration and Power Interface (ACPI) is an open standard that operating systems can use to discover and configure computer hardware components, to perform power management (e.g. putting unused hardware components to sleep), auto configuration (e.g. Plug and Play and hot swapping), and status monitoring.</p></blockquote><p>ACPI is about configuration, and the kernel uses the ACPI tables, present in any modern PC, to find where devices are. To illustrate how this works, let’s look at the <code>com* at acpi?</code> line. This line says that the serial port can be configured via ACPI if ACPI happens to have an entry for it. And you know, we can peek into the ACPI tables of a running machine to see what that might be:</p><pre><code><code># acpidump -dt | grep -A15 COM1
Device (COM1)
{
Name (_HID, EisaId (\"PNP0501\") /* 16550A-compatible COM Serial Port */)  // _HID: Hardware ID
Name (_UID, One)  // _UID: Unique ID
Name (_CRS, ResourceTemplate ()  // _CRS: Current Resource Settings
{
IO (Decode16,
0x03F8,             // Range Minimum
0x03F8,             // Range Maximum
0x01,               // Alignment
0x08,               // Length
)
IRQNoFlags ()
{4}
})
}
# █</code></code></pre><p><em>(Pro-tip: you can use </em><code>acpidump</code><em> to extract the Windows license key bound to your machine, if any. I’ve needed to do this in the past to install Windows in a VM after replacing the host OS with FreeBSD.)</em></p><p>Voila. The ACPI tables provided by the system tell us a similar story to what the explicit <code>com0 at isa?</code> entry did (and no surprise here because this is a legacy device): there is a serial port at base address 0x3f8 that uses interrupt 4. But also, this table tells us the hardware identifier for this entry: <code>PNP0501</code>. Grepping through the NetBSD kernel code base for this identifier, we land on the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/dev/acpi/com_acpi.c#L60\">dev/acpi/com_acpi.c</a> file:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
// ...
/* 16550A-compatible COM port */
{ .compat = \"PNP0501\", .value = COM_TYPE_NORMAL },
// ...
};</code></code></pre><p><em>(Another pro-tip: master <a href=\"https://github.com/BurntSushi/ripgrep\">ripgrep</a>. Knowing how to find a needle in the haystack of a large code base will grant you super-powers among your coworkers. Being able to pinpoint where specifically to start an investigation based on a “random-looking” string is invaluable.)</em></p><p>Aha! This <code>com_acpi.c</code> file provides the necessary glue to direct the generic serial port <code>com</code> driver to the hardware via whatever the ACPI tables prescribe. From here, the kernel can proceed to <em>attach</em> the driver to the device and connect the dots between the user-space <code>/dev/ttyS0</code> interface to the physical serial port.</p><h1><strong>Device Tree</strong></h1><p>In the world of embedded devices powered by SOCs—\"<a href=\"https://en.wikipedia.org/wiki/System_on_a_chip\">System on a Chip</a>\", a term that describes single chips that provide all functions to build a computer, ranging from the CPU to sound and network cards—we don’t have ACPI tables. What we used to have instead was explicit code <em>for every board/chip combination</em> that knew how to address the hardware in each SOC. Linux used to be a mess of half-baked and abandoned forks, each supporting a different board without hopes of unification into mainline due to the lack of generic interfaces.</p><p>The <a href=\"https://www.devicetree.org/\">Device Tree</a> specification fixed this issue for the most part for architectures like aarch64. With Device Tree, each hardware or OS vendor provides a static table that describes the layout of a board’s hardware separately from the code of the kernel. Then, the kernel peeks into this table to know which devices exist and where they are in the machine layout, much like it does with ACPI.</p><p>A big difference with ACPI, however, is that the kernel cannot query the Device Tree from the hardware because… well, the Device Tree is external to the hardware. The kernel expects the Device Tree to “exist in memory” either because the kernel image <em>embeds</em> the Device Tree for the target board or because the boot loader loads the Device Tree from disk and passes it to the kernel.</p><p>Once the kernel has the Device Tree though, the hardware discovery process is similar to the one in ACPI: the kernel scans the Device Tree and looks for drivers that can attach to device nodes based on hardware identifiers. From the perspective of the kernel configuration, things look very similar between amd64 and aarch64. See this snippet from the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/evbarm/conf/GENERIC64\">generic kernel of the evbarm port</a>:</p><pre><code><code>armfdt0     at root
simplebus*  at fdt? pass 0
com*        at fdt? pass 4</code></code></pre><p>This configuration snippet tells the aarch64 kernel that a <code>com</code> device may appear on <code>fdt</code>, which stands for “Flat Device Tree”. In turn, <code>armfdt0 at root</code> says that there is a specific driver named <code>armfdt0</code> that provides access to the <code>fdt</code> loaded by the boot loader on an ARM machine.</p><p>We can inspect the Device Tree from the command line as the Device Tree is exposed via the same interface that OpenFirmware used due to its historical roots. For example, to fetch the portion of the Device Tree for the serial port on an aarch64 machine:</p><pre><code><code># ofctl serial1
[Caching 121 nodes and 781 properties]
clocks                  0000000e 00000000 ........ ........   ........
compatible              6272636d 2c62636d 32383335 2d617578   \"brcm,bcm2835-aux
0010:       2d756172 7400.... ........ ........   -uart\"
interrupts              00000001 0000001d ........ ........   ........
name                    73657269 616c00.. ........ ........   \"serial\"
phandle                 0000004c ........ ........ ........   ...L
pinctrl-0               0000000f ........ ........ ........   ....
pinctrl-names           64656661 756c7400 ........ ........   default.
reg                     7e215040 00000040 ........ ........   ~!P@...@
status                  6f6b6179 00...... ........ ........   okay.
# █</code></code></pre><p>A binary dump. OK, fine, we can intuit <em>something</em> out of this, but it isn’t particularly clear. The problem here is that we are looking at the binary encoding of the Device Tree (the DTB). But the DTB is built from a set of corresponding source files (one or more DTS files), and if we look at the common <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/external/gpl2/dts/dist/arch/arm/boot/dts/bcm283x.dtsi#L385\">DTS for Broadcom 283x boards</a>, we find the following more-readable content:</p><pre><code><code>/ {
aliases {
/* ... */
serial1 = \"/soc/serial@7e215040\";
};
soc {
/* ... */
serial@7e215040 {
compatible = \"brcm,bcm2835-aux-uart\";
reg = <0x7e215040 0x40>;
interrupts = <0x01 0x1d>;
clocks = <0x0e 0x00>;
status = \"okay\";
pinctrl-names = \"default\";
pinctrl-0 = <0x0f>;
phandle = <0x4c>;
};
};
};</code></code></pre><p>The detail to highlight here is the <code>brcm,bcm2835-aux-uart</code> identifier. If we search for this in the code base with the ripgrep super-powers you gained earlier, we find the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/arch/arm/broadcom/bcm2835_com.c#L54\">arch/arm/broadcom/bcm2835_com.c</a> file, which contains:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
{ .compat = \"brcm,bcm2835-aux-uart\" },
DEVICE_COMPAT_EOL
};</code></code></pre><p>Once again: we found the glue that connects a generic <code>com</code> driver to a specific hardware device.</p><h1><strong>Loading DTBs at boot time</strong></h1><p>Let’s dig a bit further though. I mentioned earlier that the boot loader is responsible for loading the Device Tree into memory and passing it to the kernel. How is that done? Well, it really depends on the specific machine you are dealing with. In here, I’m just going to <em>very briefly</em> touch upon how the Raspberry Pi does it because that’s the specific non-PC hardware I have access to. And for this, I’ll take you through the investigative journey I took.</p><p>The specific problem I faced was that NetBSD was <em>not</em> able to discover the SPI bus even when I had enabled the right SPI driver in the kernel for my Raspberry Pi 3B. By that point, I was aware that DTBs existed and I suspected that something might be wrong with them, so my first instinct was to check and see what the DTB had to say about the SPI.</p><p>Digging through the FAT partition of the disk image I was using, I found the <code>dtb/broadcom/bcm2837-rpi-3-b.dtb</code> file—the DTB for my specific board. The way the Raspberry Pi boot loader finds this file is by looking for a file matching the board’s own name (<code>bcm2837-rpi-3-b.dtb</code>) in the location specified by the <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html#os_prefix\">os_prefix configuration property</a> in the <code>config.txt</code> placed at the root of the FAT partition.</p><p>Once I found that file and after learning about the <code>dtc</code> tool (the Device Tree Compiler) which transforms DTS files into DTBs and vice versa, I could decompile the DTS:</p><pre><code><code>$ dtc -I dtb -O dts bcm2837-rpi-3-b.dtb -o bcm2837-rpi-3-b.dts
... various warnings ...
$ █</code></code></pre><p>Then, peeking into the decompiled DTS file, I found:</p><pre><code><code>spi@7e204000 {
compatible = \"brcm,bcm2835-spi\";
reg = <0x7e204000 0x200>;
interrupts = <0x02 0x16>;
clocks = <0x06 0x14>;
#address-cells = <0x01>;
#size-cells = <0x00>;
status = \"disabled\";
dmas = <0x0b 0x06 0x0b 0x07>;
dma-names = \"tx\\0rx\";
phandle = <0x49>;
};</code></code></pre><p>I verified that the SPI kernel driver recognized the <code>brcm,bcm2835-spi</code> identifier just as we did earlier on for the serial port. And it did match, so I was puzzled for a moment.</p><p>But then I noticed the innocuous <code>status = \"disabled\"</code> line. Aha! The SPI device was disabled by default. I modified that line with <code>status = \"okay\"</code> following what other entries in the DTS did, recompiled the DTS into the DTB:</p><pre><code><code>$ dtc -I dts -O dtb bcm2837-rpi-3-b.dts -o bcm2837-rpi-3-b.dtb
... various warnings ...
$ █</code></code></pre><p>… rebooted the board and… voila!</p><pre><code><code># dmesg | grep spi
[     1.000003] bcmspi0 at simplebus1: SPI
[     1.000003] bcmspi0: interrupting on icu irq 54
[     1.000003] spi0 at bcmspi0: SPI bus
# █</code></code></pre><p>The kernel successfully attached the SPI driver and the SPI bus started working, which in turn led to a multi-hour debugging session to make the EndBASIC ST7735S driver work—but in the end it did.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"6c85b644-99b2-41ff-bdfd-3baee6e94460\",\"duration\":null}\"></div><p>Yes, there are nicer ways to do what I did here because the DTBs are provided by upstream and you should not be modifying them. What you should do instead is create a DTB overlay, which is a separate small DTB that “patches” the upstream DTB, and then tell the boot loader to process it via the <code>dtoverlay</code> stanza in the <code>config.txt</code> file. Details left to you, reader. Just beware that the Raspberry Pi boot loader is picky about file paths and <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html\">the documentation is your friend</a> here.</p><h1><strong>How do ACPI and Device Tree differ?</strong></h1><p>Based on everything I told you about here, ACPI and Device Tree look oddly similar—and that’s because they are! From the perspective of <em>describing</em> hardware to the kernel, the two technologies are equivalent, but they differ for historical reasons. ACPI has its roots in APM, a PC technology, whereas Device Tree is based on <a href=\"https://en.wikipedia.org/wiki/Open_Firmware\">OpenFirmware</a>, a technology that originated at Sun Microsystems for its SPARC machines and that was later used by Apple on their PowerPC-based Macs.</p><p>One difference between the two, though, is that ACPI does more than just describe hardware. ACPI provides a bunch of hardware-specific routines in a bytecode that the operating system can call into to manipulate the hardware. This is often maligned because ACPI introduces non-free and opaque blobs in the interaction between the operating system kernel and the hardware, but <a href=\"https://mjg59.dreamwidth.org/68350.html\">Matthew Garret has a great essay on why ACPI is necessary</a> and why it is better than all other alternatives, possibly including Device Tree.</p><p>In any case, that’s all for today. I found this exercise of dealing with the Device Tree pretty fun and I thought I could share something interesting with you all. I intentionally omitted many details because the topic of hardware configuration is vast and tricky, but you can continue building your knowledge from the bits above and from the fabulous <a href=\"https://wiki.osdev.org/\">OSDev wiki</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">And as always, if any of this was interesting, subscribe to Blog System/5 now. You’ll receive more content like this and you’ll support my future writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "0.0" "image/jpeg") nil "39d53fc38751be384a6e20598abc3bf7") (25 (26619 29094 956392 522000) "https://blogsystem5.substack.com/p/windows-nt-vs-unix-design" "Windows NT vs. Unix: A design comparison" "Julio Merino" "Mon, 09 Sep 2024 15:30:16 +0000" "<p>Over the years, I’ve repeatedly heard that Windows NT is a very advanced operating system and, being a Unix person myself, it has bothered me to not know <em>why</em>. I’ve been meaning to answer this question for years and I can do so now, which means I want to present you my findings.</p><p>My desire to know about NT’s internals started in 2006 when I applied to the Google Summer of Code program to develop Boost.Process. I needed such a library for ATF, but I also saw the project as a chance to learn something about the Win32 API. This journey then continued in 2020 with me <a href=\"https://jmmv.dev/2020/10/bye-google-hi-microsoft.html\">choosing to join Microsoft</a> after a long stint at Google and me buying the <a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals</a> 5th edition book in 2021 (which I never fully read due to its incredible detail and length). None of these made me learn what I wanted though: the ways in which NT fundamentally differs from Unix, if at all.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":1049872,\"alt\":\"\",\"title\":\"\",\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Then, at the end of 2023, the <a href=\"https://blogsystem5.substack.com/p/windows-nt-peeking-into-the-cradle\">Showstopper</a> book sparked this curiosity once again. And soon, a new thought came to mind: the Windows Internals 5th edition book was too obtuse but… what about the first edition? Surely it must have been easier to digest because the system was much simpler back in the early 1990s. So lo and behold, I searched for this edition, found it under the title <a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT</a>, read it cover to cover, and took notes to evaluate NT vs. Unix.</p><p>Which brings me to this article—a collection of thoughts comparing the design of NT (July 1993) against contemporary Unix systems such as 4.4BSD (June 1994) or Linux 1.0 (March 1994). Beware that, due to my background, the text is written from the point of view of a Unix “expert” and an NT “clueless”, so it focuses on describing the things that NT does differently.</p><h1>Mission</h1><p><a href=\"https://en.wikipedia.org/wiki/Unix\">Unix</a>’s history is long—much longer than NT’s. Unix’s development started in 1969 and its primary goal was to be a convenient platform for programmers. Unix was inspired by <a href=\"https://en.wikipedia.org/wiki/Multics\">Multics</a>, but compared to that other system, Unix focused on simplicity which is a trait that let it triumph over Multics. Portability and multitasking were not original goals of the Unix design though: these features were retrofitted in the many “forks” and reinventions of Unix years later.</p><p>On Microsoft’s side, the first release of MS-DOS launched in August 1981 and the first release of “legacy Windows” (the DOS-based editions) launched in November 1985. While MS-DOS was a widespread success, it wasn’t until <a href=\"https://en.wikipedia.org/wiki/Windows_3.0\">Windows 3.0</a> in May 1990 that Windows started to really matter. Windows NT was conceived in 1989 and saw the light with the NT 3.1 release in July 1993.</p><p>This timeline gave Microsoft an edge: the design of NT started 20 years after Unix’s, and Microsoft already had a large user base thanks to MS-DOS and legacy Windows. The team at Microsoft designing NT had the hindsight of these developments, previous experience developing other operating systems, and access to more modern technology, so they could “shoot for the moon” with the creation of NT.</p><p>In particular, NT started with the following design goals as part of its mission, which are in stark contrast to Unix’s:</p><ol><li><p>portability,</p></li><li><p>support for multiprocessing systems (SMP), and</p></li><li><p>compatibility with DOS, legacy Windows, OS/2, and POSIX.</p></li></ol><p>These were not goals to scoff at and meant that NT started with solid design principles from the get go. In other words: these features were all present from day one and not bolted on at a later stage like they were in many Unixes.</p><h1>The kernel</h1><p>Now that we know some of these design goals and constraints, let’s take a look at the specifics of how they are implemented.</p><p>Unix is, with few exceptions like <a href=\"https://www.minix3.org/\">Minix</a> or <a href=\"https://www.gnu.org/software/hurd/\">GNU Hurd</a>, implemented as a monolithic kernel that exposes a collection of system calls to interact with the facilities offered by the operating system. NT, on the other hand, is a hybrid between a monolithic kernel and a microkernel: the privileged component, known as the <em>executive</em>, presents itself as a collection of modular components to user-space <em>subsystems</em>. The user-space subsystems are special processes which “translate” the APIs that the applications consume (be it POSIX, OS/2, etc.) into executive system calls.</p><p>One important piece of the NT executive is the Hardware Abstraction Layer (HAL), a module that provides abstract primitives to access the machine’s hardware and that serves as the foundation for the rest of the kernel. This layer is the key that allows NT to run on various architectures, including i386, Alpha, and PowerPC. To put the importance of the HAL in perspective, contemporary Unixes were coupled to a specific architecture: yes, Unix-the-concept was portable because there existed many different variants for different machines, but the implementation was not. SunOS originally only supported the Motorola 68000; 386BSD was the first port of BSD to the Intel architecture; IRIX was the Unix variant for Silicon Graphic’s MIPS-based workstations; and so on. This explains why NetBSD’s main focus on portability via a minimal shim over the hardware was so interesting at the time: other operating systems, except NT, did <em>not</em> have this internal clean design, and NT had come years before.</p><p>Another important piece of the NT executive is its support for multiprocessing systems and its preemptive kernel. The kernel has various interrupt levels (<a href=\"https://en.wikipedia.org/wiki/Spl_(Unix)\">SPLs</a> in BSD terminology) to determine what can interrupt what else (e.g. a clock interrupt has higher priority than a disk interrupt) but, more importantly, the kernel threads can be preempted by other kernel threads. This is “of course” what every high-performance Unix system does today, but it’s not how many Unixes started: those systems started with a kernel that didn’t support preemption nor multiprocessing; then they added support for user-space multiprocessing; and then they added kernel preemption. The latter is the hardest step of all and explains the <a href=\"https://en.wikipedia.org/wiki/FreeBSD_version_history#FreeBSD_5\">FreeBSD 5.0</a> saga fiasco. So it is interesting to see that NT started with the right foundations from its inception.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you are enjoying this article, please subscribe to Blog System/5! Your recurrent interest is what makes this publication work.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Objects</h1><p>NT is an object-oriented kernel. You might think that Unix is too: after all, processes are defined by a struct and file system implementations deal with vnodes (“virtual nodes”, not to be confused with inodes which are a file system-specific implementation detail). But that’s not quite the same as what NT does: NT forces all of these different objects to have a common representation in the system.</p><p>You can rightfully be skeptical about this because… how can you offer a meaningful abstraction over such disparate things as processes and file handles? You can’t, really, but NT forced all of these to inherit from a common object type and, surprisingly, this results in some nice properties:</p><ul><li><p><strong>Centralized access control:</strong> Objects are exclusively created by the <em>object manager</em>, which means there is a single place in the code to enforce policy. This is powerful because the semantics for, say, permission checks, can be defined in just one location and applied uniformly throughout the system. NetBSD concluded this was a good idea too, but it wasn’t until 2001 that it gained its <a href=\"https://man.netbsd.org/NetBSD-9.3/kauth.9\">Kernel Authorization (kauth)</a> framework.</p></li><li><p><strong>Common identity:</strong> Objects have identities and they are all represented in a single tree. This means that there is a unique namespace for all objects, no matter if we are talking about processes, file handles, or pipes. The objects in the tree are addressable via names (paths) and different portions of the tree can be owned by different subsystems. For example, a portion of the tree can represent a mounted file system, and thus traversing that subtree’s root node will cause the file system to resolve the remainder of the path. This is akin to the VFS layer of a Unix system, with the difference that the VFS is exclusively about file systems whereas the object tree is about <em>every single kernel object</em>. It’s true that Unix has attempted to shoehorn other types of non-file objects into the file system via <code>/proc/</code>, <code>/sys/</code>, and the like—but these feel like afterthoughts compared to what NT offers.</p></li><li><p><strong>Unified event handling:</strong> All object types have a <em>signaled</em> state, whose semantics are specific to each object type. For example, a process object enters the signaled state when the process exits, and a file handle object enters the signaled state when an I/O request completes. This makes it trivial to write event-driven code (ehem, async code) in userspace, as a single wait-style system call can await for a group of objects to change their state—no matter what type they are. Try to wait for I/O and process completion on a Unix system at once; it’s painful.</p></li></ul><p>Objects are an NT-specific construct though, and they don’t generalize well to all of the APIs that NT intended to support. An example of this is the POSIX subsystem: POSIX doesn’t have the same concept of objects as NT does, yet NT has to offer some sort of compatibility with POSIX applications. For this reason, while the POSIX subsystem allocates objects from the executive, this subsystem must keep its own bookkeeping to represent the corresponding POSIX entities and performs the logical translation between the two on the fly. The Win32 subsystem, on the other hand, just hands objects to clients without an intermediary.</p><h1>Processes</h1><p>Processes are a common entity in both NT and Unix but they aren’t quite the same. In Unix, processes are represented in a tree, which means that each process has a parent and a process can have zero or more children. In NT, however, there is no such relationship: processes can “inherit” resources from their creators—any type of object, basically—but they are standalone entities after they are created.</p><p>What wasn’t common back when NT was designed were threads: Mach was the first Unix-like kernel to integrate threads in 1985, which means that other Unixes adopted this concept later on and had to retrofit it into their existing designs. For example, Linux chose to represent threads as processes, each with its own PID, in its 2.0 release in June 1996; and NetBSD didn’t get threads, represented as separate entities from processes, until its 2.0 release in 2004. Contrary to Unix, NT chose to support threads from the very beginning, knowing that they were a necessity for high-performance computing on SMP machines.</p><p>NT doesn’t have signals in the traditional Unix sense. What it does have, however, are <em>alerts</em>, and these can be kernel mode and user mode. User mode alerts must be waited for as any other object and kernel mode alerts are invisible to processes. The POSIX subsystem uses kernel mode alerts to emulate signals. Note that signals have often been called a wart in Unix because of the way they interfere with process execution: handling signals correctly is a really difficult endeavor, so it sounds like NT’s alternative is more elegant.</p><p>An interesting recent development in NT-land has been the introduction of <a href=\"https://www.microsoft.com/en-us/research/project/drawbridge/\">picoprocesses</a>. Up until this feature was added, processes in NT were quite heavyweight: new processes would get a bunch of the NT runtime libraries mapped in their address space at startup time. In a picoprocess, the process has minimal ties to the Windows architecture, and this is used to implement Linux-compatible processes in WSL 1. In a way, picoprocesses are closer to Unix processes than native Windows processes, but they are not used for much anymore—even if they have only existed since August 2016—because of the move to WSL 2.</p><p>Lastly, as much as we like to bash Windows for security problems, NT started with an advanced security design for early Internet standards given that the system works, basically, as a capability-based system. The first user process that starts after logon gets an access token from the kernel representing the privileges of the user session, and the process and its subprocesses must supply this token to the kernel to assert their privileges. This is different from Unix where processes just have identifiers and the kernel needs to keep track of what each process can do in the process table.</p><h1>Compatibility</h1><p>As mentioned in the introduction, a major goal of NT was to be compatible with applications written for legacy Windows, DOS, OS/2 and POSIX. One reason for this was technical, as this forced the system to have an elegant design; the other reason was political, as NT was a joint development with IBM and NT <em>had</em> to support OS/2 applications even if, in the end, NT ended up <em>being</em> Windows.</p><p>This need for compatibility forced NT’s design to be significantly different than Unix’s. In Unix, user-space applications talk to the kernel directly via its system call interface, and this interface <em>is</em> the Unix interface. Oftentimes, <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">but not always</a>, the C library provides the glue to call the kernel and applications never issue system calls themselves—but that’s a minor detail.</p><p>Contrast this to NT where applications do <em>not</em> talk to the executive (the kernel) directly. Instead, each application talks to one specific protected <em>subsystem</em>, and these subsystems are the ones that implement the APIs of the various operating systems that NT wanted to be compatible with. These subsystems are implemented as user-space servers (they are not inside the NT “microkernel”). Support for Windows applications comes from the Win32 server, which is special because it’s the only one that’s directly visible by users: it controls console programs and DOS terminals, and it has certain privileges for performance reasons.</p><p>Compared to traditional Unix, NT’s design is very different because the BSDs and Linux have a monolithic kernel. These kernels expose a system call interface that userspace applications leverage to interact directly with the system. The BSDs, however, have offered support to run alternate <em>binaries</em> for a long time, all within the monolithic kernel: the way this works is by exposing different system call tables to userspace depending on the binary that’s being run, and then translating those “foreign” system calls to whatever the kernel understands. Linux has limited support for this as well via <em><a href=\"https://man7.org/linux/man-pages/man2/personality.2.html\">personalities</a></em>.</p><p>Even though the BSD approach is quite different from how NT handles supporting other systems, WSL 1 is extremely similar and is not a subsystem in the literal terms that subsystems were originally defined. In WSL 1, the NT kernel marks Linux processes as picoprocesses and, from there on, exposes a different system call interface to them. Within the NT kernel, those Linux-specific system calls are translated into NT operations and served within the same kernel—just like BSD’s Linux compatibility does. The only problem is that, NT not being Unix, its “emulation” of Linux is tricky and much slower than what BSD can offer. It’s a pity that <a href=\"https://jmmv.dev/2020/11/wsl-lost-potential.html\">WSL 2 lost the essence of this design</a> and went with a full-on VM design…</p><p>To finish this section, two more interesting details: a goal of NT’s design was to allow seamless I/O redirection between subsystems, all from a single shell; and subsystems are exposed to applications via <em>ports</em> which are, of course, NT objects and are similar to how Mach allows processes and servers to communicate.</p><h1>Virtual memory</h1><p>NT, just as Unix, relies on a Memory Management Unit (MMU) with pagination to offer protection across processes and to offer virtual memory. Paging in user-space processes is a common mechanism to give them a larger address space than the amount of physical memory on a machine. But one thing that put NT ahead of contemporary Unix systems is that the kernel itself can be paged out to disk too. Obviously not the whole kernel—if it all were pageable, you’d run into the situation where a resolving kernel page fault requires code from a file system driver that was paged out—but large portions of it are. This is not particularly interesting these days because kernels are small compared to the typical installed memory on a machine, but it certainly made a big difference in the past where every byte was precious.</p><p>Additionally, while we take the way virtual memory and paging works these days for granted, this was a big area of research back when NT was designed. Older Unix implementations had separate memory caches for the file system and virtual memory, and it wasn’t until 1987 that <a href=\"https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=a36b01c8fd5071f64b981dd3ffc66a6bce56736d\">SunOS implemented a unified virtual memory architecture</a> to reduce the overheads of this old design.</p><p>In contrast, NT started with a unified memory architecture from the beginning. You’d say that this was easy to do because they had the hindsight of the inefficiencies found in Unix and could see the solution that SunOS had implemented before the design of NT started. But regardless, this made NT “more advanced” that many alternate operating systems back then, and it has to be noted that other systems like NetBSD didn’t catch up until 2002 with the implementation of the <a href=\"https://www.usenix.org/legacy/publications/library/proceedings/usenix2000/freenix/full_papers/silvers/silvers.pdf\">Unified Buffer Cache (UBC)</a> in NetBSD 1.6.</p><p>An interesting difference between NT and Unix is how they manage and represent shared memory. In NT, shared memory sections are (surprise) objects and are thus subject to the exact same access validation checks as any other object. Furthermore, they are addressable in the same manner as any other object because they are part of the single object tree. Contrast this to Unix where this feature is bolted on: shared memory objects have a <a href=\"https://man7.org/linux/man-pages/man3/shm_open.3.html\">different namespace</a>, a different API to every other entity, and thus typical permissions don’t apply to them.</p><h1>I/O subsystem</h1><p>Early versions of Unix only supported one file system. For example, it wasn’t until 4.3BSD in 1990 that the BSDs gained the Virtual File System (VFS) abstraction to support more than just UFS. NT, on the other hand, started with a design that allowed multiple file systems.</p><p>In order to support multiple file systems, the kernel has to expose their namespaces in some way. Unix combines the file systems under a single file hierarchy via mount points: the VFS layer provides the mechanisms to identify which nodes correspond to the root of a file system and redirects requests to those file system drivers when traversing a path. NT has a similar design even if, from the standard user interface, file systems appear as disjoint drives: internally, the executive represents file systems as objects in the object tree, and each object is responsible for parsing the remainder of a path. Those file system objects are remapped as DOS drives so that userspace can access them. And, guess what? The DOS drives are also objects under a separate subtree that redirects I/O to the file systems they reference.</p><p>In file system terms, NT ended up shipping with NTFS. NTFS was a really advanced file system for its time even if we like to bash on it for its poor performance (a <a href=\"https://www.youtube.com/watch?v=qbKGw8MQ0i8\">misguided claim</a>). The I/O subsystem of NT, in combination with NTFS, brought 64-bit addressing, journaling, and even Unicode file names. Linux didn’t get 64-bit file support until the late 1990s and didn’t get journaling until ext3 launched in 2001. <a href=\"https://www.usenix.org/conference/1999-usenix-annual-technical-conference/soft-updates-technique-eliminating-most\">Soft updates</a>, an alternate fault tolerance mechanism, didn’t appear in FreeBSD until 1998. And Unix represents <a href=\"https://blogsystem5.substack.com/p/strings-encodings-nuls-and-bazel\">filenames as nul-terminated byte arrays</a>, not Unicode.</p><p>Other features that NT included at launch were disk stripping and mirroring—what we know today as RAID— and device hot plugging. These features were not a novelty given that SunOS did include RAID support since the early 1990s, but what’s interesting is that these were all accounted for as part of the original design.</p><p>At a higher level, <em>the</em> thing that makes the I/O subsystem of NT much more advanced than Unix’s is the fact that its interface is asynchronous in nature and has been like that since the very beginning. To put this in perspective, FreeBSD didn’t see support for <a href=\"https://man7.org/linux/man-pages/man7/aio.7.html\">aio(7)</a> until FreeBSD 3.0 in 1998, and Linux didn’t see this either until Linux 2.5 in 2002. And even if support for asynchronous I/O has existed in Unix systems for more than 20 years now, it’s still not widespread: few people know of these APIs, the vast majority of applications don’t use them, and their performance is poor. Linux’s <a href=\"https://en.wikipedia.org/wiki/Io_uring\">io_uring</a> is a relatively recent addition that improves asynchronous I/O, but it has been a significant source of security vulnerabilities and is not in widespread use.</p><h1>Networking</h1><p>The Internet is everywhere today, but when NT was designed, that was not the case. Looking back at the Microsoft ecosystem, DOS 3.1 (1987) included the foundations for file sharing in the FAT file system, yet the “OS” itself did not provide any networking features: a separate product called Microsoft Networks (MS-NET) did. Windows 3.0 (1990) included support for NetBIOS, which allowed primitive printer and file sharing on local networks, but support for TCP/IP was nowhere to be seen.</p><p>In contrast, Unix <em>was</em> the Internet: all foundational Internet protocols were written for and with it. During the design of NT, it was therefore critical to account for good network support, and indeed NT did launch with networking features. As a result, NT did support both Internet protocols and the traditional LAN protocols used in pre-existing Microsoft environments, which put it ahead of Unix in corporate environments.</p><p>An an example, take NT’s network domains. In Unix, network administrators typically synchronized user accounts across machines by hand; they’d maybe use the X.500 directory protocol (1988) and Kerberos (1980s) for user authentication, which systems like SunOS implemented, but these technologies weren’t particularly simple. Instead, NT offered <em>domains</em> from the get go, which integrated directory and authentication features, and it seems to me that these “won the day” in corporate networks because they were much easier to set up and were built into the system.</p><p>The goal of synchronized user accounts is to share resources across machines, primarily files, and when doing so, the way to represent permissions matters. For the longest time, Unix only offered the simplistic read/write/execute permission sets for each file. NT, on the other hand, came with advanced ACLs from the get go—something that’s still a sore spot on Unix. Even though Linux and the BSDs now have ACLs too, their interfaces are inconsistent across systems and they feel like an alien add-on to the design of the system. On NT, ACLs work at the object level, which means they apply consistently throughout all kernel features.</p><p>And speaking of sharing files, we must talk about networked file systems. In Unix, the de facto file system was NFS, whereas on NT it was SMB. SMB was inherited from MS-NET and LAN Manager and is implemented in the kernel via a component called the <em>redirector</em>. In essence, the redirector is “just” one more file system, like NFS is on Unix, that traps file operations and sends them over the network, which brings us to comparing RPC systems.</p><p>Even though protobuf and gRPC may seem like novel ideas due to their widespread use, they are based on old ideas. On Unix, we had Sun RPC from the early 1980s, primarily to support NFS. Similarly, NT shipped with built-in RPC support via its own DSL—known as MIDL to specify interface definitions and to generate code for remote procedures—and its own facility to implement RPC clients and servers.</p><p>Moving down the stack, Unix systems have never been big on supporting arbitrary drivers: remember that Unix systems were typically coupled to specific machines and vendors. NT, on the other hand, intended to be an OS for “any” machine and was sold by a software company, so supporting drivers written by others was critical. As a result, NT came with the Network Driver Interface Specification (NDIS), an abstraction to support network card drivers with ease. To this day, manufacturer-supplied drivers are just not a thing on Linux, which leads to interesting contraptions like the <a href=\"https://ndiswrapper.sourceforge.net/wiki/index.php/Main_Page\">ndiswrapper</a>, a very popular shim in the early 2000s to be able to reuse Windows drivers for WiFi cards on Linux.</p><p>Finally, another difference between NT and Unix lies in their implementation of named pipes. Named pipes are a local construct in Unix: they offer a mechanism for two processes on the same machine to talk to each other with a persistent file name on disk. NT has this same functionality, but its named pipes can operate over the network. By placing a named pipe on a shared file system, two applications on different computers can communicate with each other without having to worry about the networking details.</p><h1>User-space</h1><p>We are getting close to the end, I promise. There are just a few user-space topics to briefly touch on:</p><ul><li><p><strong>Configuration:</strong> NT centralized system and application configuration under a database known as the <em>registry</em>, freeing itself from the old <code>CONFIG.SYS</code>, <code>AUTOEXEC.BAT</code> and the myriad INI files that legacy Windows used. This made some people very angry, but in the end, a unified configuration interface is beneficial to everyone: applications are easier to write because there is a single foundation to support, and users have an easier time tuning their system because there is just one place to look at.</p><p>Unix, on the other hand, is still plagued by dozens of DSLs and inconsistent file locations. Each program that supports a configuration file has its own made-up syntax, and knowing which locations the program reads is difficult and not always well-documented. The Linux ecosystem has pushed for a more NT-like approach via XDG and dconf (previously GConf) but… it’s an uphill battle: while desktop components use these technologies exclusively, the foundational components of the system may never adopt them, leaving an inconsistent mess behind.</p></li><li><p><strong>Internationalization:</strong> Microsoft, being the large company that was already shipping Windows 3.x across the world, understood that localization was important and made NT support such feature from the very beginning. Contrast this to Unix where UTF support didn’t start to show up until the late 1990s, and supporting different languages came via the optional <code>gettext</code> add-on.</p></li><li><p><strong>The C language:</strong> One thing Unix systems like FreeBSD and NetBSD have fantasized about for a while is coming up with their own dialect of C to <a href=\"https://cs.rochester.edu/u/jzhou41/papers/freebsd_checkedc.pdf\">implement the kernel in a safer manner</a>. This has never gone anywhere except, maybe, for Linux relying on GCC-only extensions. Microsoft, on the other hand, had the privilege of owning a C compiler, so they did do this with NT, which is written in Microsoft C. As an example, NT relies on Structured Exception Handling (SEH), a feature that adds try/except clauses to handle software and hardware exceptions. I wouldn’t say this is a big plus, but it’s indeed a difference.</p></li></ul><h1>Conclusion</h1><p>NT was groundbreaking technology when it launched. As I presented above, many of the features we take for granted today in systems design were present in NT since its inception, whereas almost all other Unix systems had to gain those features slowly over time. As a result, such features don’t always integrate seamlessly with Unix philosophies.</p><p>Today, however, it’s not clear to me that NT is truly “more advanced” than, say, Linux or FreeBSD. It is true that NT had more solid design principles at the onset and more features that its contemporary operating systems, but nowadays… the differences are blurry. Yes, NT is advanced, but not significantly more so than modern Unixes.</p><p>What I find disappointing is that, even though NT has all these solid design principles in place… bloat in the UI doesn’t let the design shine through. The sluggishness of the OS even on super-powerful machines is <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">painful to witness</a> and might even lead to the demise of this OS.</p><p>I’ll leave you with the books used to write this article in case you want to go through my learning journey. I had to skip over tons of interesting details, as you can imagine, so these are worth a read:</p><ul><li><p><a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT, 1st edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-4-4-Operating-System/dp/0201549794?crid=289Z6M1NYSR8L&dib=eyJ2IjoiMSJ9.4h3ssrq_vTu9MaMquFvEbw.YxrfgRofVfFKstV74Q_LR-XOseMUlCrcvkehHW6y5Yc&dib_tag=se&keywords=design+and+implementation+of+4.4bsd&qid=1725808321&sprefix=design+and+implementation+of+4.4bsd%2Caps%2C158&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=a0d6cc7fb69bc72b4649609390255bff&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the BSD 4.4 operating system</a>.</p></li></ul><p>And if you want to <em>continue</em> my journey and truly dive deep into how each piece of <em>modern</em> NT and Unix works, the newer editions are a must read:</p><ul><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 1, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-2-7th/dp/0135462401?pd_rd_w=nmV0o&content-id=amzn1.sym.3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_p=3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_r=FHEDS8GZCH0T6TA52GQD&pd_rd_wg=VUb9D&pd_rd_r=9f324aa8-7d91-4b6f-8c48-a8f09f1e8717&pd_rd_i=0135462401&psc=1&linkCode=ll1&tag=blogsystem5-20&linkId=a174f72e73013533f3ee8ca3f2cedd1c&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 2, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-FreeBSD-Operating-System/dp/0321968972?crid=23A95KGH3XOCE&dib=eyJ2IjoiMSJ9.WhRSQ2C6OFnyaT9IERCxYyLspyOoCkFSreJbs2Nia7zcYcNs68qdHuNBiIvERx987eDwl_H7YrMkTIj1575PGQ.orMCRh-1sVoQgFKgV2RtSiAxU3OA5fYRt6oAI3SV-p0&dib_tag=se&keywords=the+design+and+implementation+of+freebsd&qid=1725850081&s=books&sprefix=the+design+and+implementation+of+freebsd%2Cstripbooks%2C136&sr=1-1&linkCode=ll1&tag=blogsystem5-20&linkId=ac0d39d3f598c50cd1d9dc650d2b4dd7&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the FreeBSD operating system, 2nd edition</a>.</p></li></ul><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for making it this far. Don’t forget to subscribe to Blog System/5 to receive new posts and support my work!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "0.0" "image/jpeg") nil "58347eb72fd9bd56e40dbe3d11126f1c") (24 (26618 8216 365603 182000) "https://blogsystem5.substack.com/p/ioctls-rust" "ioctls from Rust" "Julio Merino" "Thu, 13 Feb 2025 17:01:31 +0000" "<p>In Unix-like systems, “everything is a file and a file is defined as a byte stream you can <code>open</code>, <code>read</code> from, <code>write</code> to, and ultimately <code>close</code>”… right? <em>Right?</em> Well, not quite. It’s better to say <em>file descriptors</em> provide access to almost every system that the kernel provides, but not that they can all be manipulated with the same quartet of system calls, nor that they all behave as byte streams.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":440615,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Because you see: network connections are manipulated via file descriptors indeed, but you don’t <code>open</code> them: you <code>bind</code>, <code>listen</code>/<code>accept</code> and/or <code>connect</code> to them. And then you don’t <code>read</code> from and <code>write</code> to network connections: you somehow <code>send</code> to and <code>recv</code> from them. Device drivers are similar: yes, hardware devices are represented as “virtual files” in the <code>/dev</code> hierarchy and many support <code>read</code> and <code>write</code>… but these two system calls are not sufficient to access the breath of functionality that the hardware drivers provide. No, you need <code>ioctl</code>.</p><p><code>ioctl</code> is the poster child of the system call that breaks Unix’s “everything is a file” paradigm. <code>ioctl</code> is the API that allows out-of-band communication with the kernel side of an open file descriptor. To see cool examples, <a href=\"https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11\">refer back to my previous article</a> where I demonstrated how to drive graphics from the console without X11: in that post, we had to <code>open</code> the console device, but then we had to use <code>ioctl</code> to obtain the properties of the framebuffer, and then we had to <code>mmap</code> the device’s content for direct access: no <code>read</code>s nor <code>write</code>s involved.</p><p>All the code I showed you in that earlier post was written in C to keep the graphics article to-the-point, but the code I’m really working on is part of EndBASIC, and thus it is all Rust. And the thing is, <code>ioctl</code>s are not easy to issue from Rust. In fact, after 7 years of Rust-ing, it’s the first time I’ve had to reach for <code>unsafe</code> code blocks, and there was no good documentation on how to deal with <code>ioctl</code>. So this posts aims to fix that by presenting what ways there are to call <code>ioctl</code>s from Rust… and, of course, diving a bit deeper into what <code>ioctl</code>s actually <em>are</em>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Our target</strong></h1><p>For all examples below, I’ll be using a relatively simple <code>ioctl</code> from NetBSD’s <a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> driver. This API is available via the console device file, typically <code>/dev/ttyE0</code>, and is named <code>WSDISPLAYIO_GINFO</code>. Here is what the manual page has to say:</p><pre><code><code>The following ioctl(2) calls are provided by the wsdisplay driver or by
devices which use it.  Their definitions are found in
<dev/wscons/wsconsio.h>.
...
WSDISPLAYIO_GINFO (struct wsdisplay_fbinfo)
Retrieve basic information about a framebuffer display.
The returned structure is as follows:

struct wsdisplay_fbinfo {
u_int   height;
u_int   width;
u_int   depth;
u_int   cmsize;
};

The height and width members are counted in pixels.  The
depth member indicates the number of bits per pixel, and
cmsize indicates the number of color map entries accessible
through WSDISPLAYIO_GETCMAP and WSDISPLAYIO_PUTCMAP.  This
call is likely to be unavailable on text-only displays.</code></code></pre><p>Calling this API from a C program would be trivial and look like this:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <ioctl.h>
// ... open `/dev/ttyE0` as fd ...
struct wsdisplay_fbinfo fbi;
if (ioctl(fd, WSDISPLAYIO_GINFO, &fbi) == -1) {
// Handle error.
}
// fbi now contains the data returned by the kernel.</code></code></pre><p>The reason I’m picking <code>WSDISPLAYIO_GINFO</code> specifically to talk about <code>ioctl</code>s in this article is three-fold:</p><ul><li><p>it returns a small structure with <a href=\"https://blogsystem5.substack.com/p/x86-64-programming-models\">platform-dependent integers</a>, so the sample code in the article will be relatively short;</p></li><li><p>it relies on platform-specific integer types, so we’ll have to account for that in Rust; and</p></li><li><p>it is “rare enough” (we are talking about NetBSD after all) that it is not going to be supported by any of the common Rust crates like libc or nix, so we’ll have to do extra work to call it.</p></li></ul><h1><strong>What is an ioctl anyway?</strong></h1><p>The manual page helpfully provides us a copy of the data structure returned by the <code>ioctl</code>, and the BSD manual pages are typically <em>awesome</em>, but it’s worth double-checking that the code snippet actually matches the code it documents. Peeking into <code>/usr/include/dev/wscons/wsconsio.h</code> as the manual page directs us, we find:</p><pre><code><code>/* Basic display information.  Not applicable to all display types. */
struct wsdisplay_fbinfo {
u_int   height;             /* height in pixels */
u_int   width;              /* width in pixels */
u_int   depth;              /* bits per pixel */
u_int   cmsize;             /* color map size (entries) */
};
#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>OK, great, the <code>wsdisplay_fbinfo</code> structure perfectly aligns with the manual page contents. But what’s more interesting is the <code>#define</code>, which says that <code>WSDISPLAYIO_GINFO</code> is:</p><ul><li><p>an ioctl that <em>reads</em> from the kernel (<code>_IOR</code>),</p></li><li><p>that invokes function number 65 from the <code>W</code> class (which probably stands for “the <em>W</em>scons device driver”), and</p></li><li><p>that places the returned data into a structure of type <code>wsdisplay_fbinfo</code> (not to be confused with <code>wsdisplayio_fbinfo</code>).</p></li></ul><p>In a way, this is just like any other function or system call, except that it’s not defined as such and is instead funneled through a single API. <code>ioctl</code> is, therefore, “just” a grab bag of arbitrary functionality, and what can be invoked on a given file descriptor depends on what the file descriptor represents.</p><p>The reasons for this design are historical and, of course, there could have been other options.</p><p>For example: you know how regular files have an internal structure, right? The vast majority of file formats out there contain a header, which then specifies various sections within the file, which then contain data. The same could have been done with device drivers: their virtual files could have predefined some internal format such that, e.g. the <code>wsdisplay_fbinfo</code> structure always appeared at offset 0x1000 of the virtual file. <code>read</code> and <code>write</code> would have been sufficient for this design, albeit you’d almost-certainly wanted to combine it with <code>mmap</code> for more efficient access.</p><p>Or another example: device drivers could have used an RPC-like mechanism where each write to the file descriptor is a “message” that requests a specific function, and that the kernel responds to with an answer. <code>read</code> and <code>write</code> would have been sufficient for this design.</p><p>Or yet another example: the requests to the device driver could have been intermixed with the data, such that if the data contained a specific sequence, the kernel would invoke a function instead of processing data. Sounds crazy, right? But that’s what pseudo-terminals do: all those <a href=\"https://en.wikipedia.org/wiki/ANSI_escape_code\">control sequences</a> to change colors and the like are telling the terminal driver to do something special.</p><p>In any case, these are all alternate designs and… I’m sure they all live in some form or another in current systems. There is no consistency in how <code>/dev</code> pseudo-files expose their behavior, and <code>ioctl</code>s are just one of the options we have to deal with. So without further ado, let’s look at three different ways of calling these services from Rust.</p><h1><strong>Option 1: nix</strong></h1><p>The first option to call an <code>ioctl</code> from Rust is to leverage the neat <a href=\"https://docs.rs/nix/\">nix crate</a>, which provides idiomatic access to Unix primitives. This crate is not to be confused with NixOS, with which it has no relation.</p><p>To use nix to invoke <code>ioctl</code>s, we need to do two things.</p><p>First, we need to define the data structure used by the <code>ioctl</code>. In C, we would just <code>#include <dev/wscons/wsconsio.h></code>, but in Rust we don’t have access to the C-style headers. Instead, we have to do extra work to define the same memory layout of the C <code>wsdisplay_fbinfo</code> structure, but in Rust:</p><pre><code><code>use std::ffi::c_uint;
#[repr(C)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}</code></code></pre><p>It is <em>very important</em> to declare the structure as having a C representation so that its memory layout matches what the C compiler produces for the same structure. The kernel expects C semantics in its system call boundary, and we must adhere to that. Additionally, we must ensure that the types of each field match the C definitions. Rust only has fixed-size integer types like <code>i16</code> and <code>u32</code>, but C provides platform-dependent integer types like <code>int</code> or <code>unsigned long</code> and these are sometimes used in public kernel interfaces (a mistake, if you ask me). Fear not, though: the <code>std::ffi</code> module provides aliases for those C types.</p><p>And second, we have to do something unique to the nix crate: we have to define a wrapper function for the <code>ioctl</code> so that we can invoke the <code>ioctl</code> as if it were any other function. nix makes this very easy by providing macros that mimic the syntax of the C <code>#define</code> we saw earlier on:</p><pre><code><code>use nix::ioctl_read;
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);</code></code></pre><p>And with that, we are ready to put everything together in a fully-fledged program:</p><pre><code><code>use std::ffi::c_uint;
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
use nix::fcntl;
use nix::ioctl_read;
use nix::sys::stat;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);
fn main() -> io::Result<()> {
let mut oflag = fcntl::OFlag::empty();
oflag.insert(fcntl::OFlag::O_RDWR);
oflag.insert(fcntl::OFlag::O_NONBLOCK);
oflag.insert(fcntl::OFlag::O_EXCL);
let fd = {
let raw =
fcntl::open(\"/dev/ttyE0\", oflag, stat::Mode::empty())?;
unsafe { OwnedFd::from_raw_fd(raw) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
wsdisplayio_ginfo(fd.as_raw_fd(), &mut fbi).unwrap();
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>There is one surprising detail in this code though: if we went through the hassle of defining a wrapper function for <code>WSDISPLAYIO_GINFO</code> via the idiomatic nix crate, and idiomatic nix usage doesn’t require <code>unsafe</code> blocks… why did we have to wrap the call to <code>wsdisplayio_ginfo</code> in an <code>unsafe</code> block? The reason may be that <code>ioctl</code> can do <em>whatever</em> to the running process and Rust needs to be over-conservative.</p><p>In any case, the above is clean and it works. But… using nix comes with a cost:</p><pre><code><code>$ cargo build
Compiling libc v0.2.169
Compiling cfg_aliases v0.2.1
Compiling bitflags v2.8.0
Compiling cfg-if v1.0.0
Compiling nix v0.29.0
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/os/homepage/static/src/ioctls-rust/nix)
Finished `dev` profile [unoptimized + debuginfo] target(s) in 1.71s
$ █</code></code></pre><p>We have pulled 5 crates into the project just to open a file and invoke an <code>ioctl</code>. Not a huge deal in this day and age but… this contributes to the perception that the Rust ecosystem is a mess of bloated dependencies. Can we do differently?</p><h1><strong>Option 2: libc</strong></h1><p>What if we bypassed nix altogether and invoked libc directly? After all, we can see that nix <em>depends on</em> libc anyway, so we might as well use it at the expense of losing nix’s idiomatic representation of Unix’s interfaces.</p><p>Sure, we can do that: we can invoke the <code>libc::ioctl</code> function directly, which has this prototype:</p><pre><code><code>pub fn ioctl(fd: c_int, request: Ioctl, ...) -> c_int;</code></code></pre><p>Alright then: we need a file descriptor as the first argument, which we have. And then we need an <code>Ioctl</code> as the second argument, which we… wait, what is this <code>Ioctl</code> type? If we look for its definition in the libc source code, we find that <code>Ioctl</code> is an alias for an integer type (<code>unsigned long</code> or <code>int</code> depending on the platform), and this matches the C definition of <code>ioctl</code>. OK, nothing special.</p><p>But then… what do we pass in this second argument? If we were writing C, we would use the <code>WSDISPLAY_GINFO</code> constant, but we don’t have that in Rust because we don’t get access to the C header files. So what <em>is</em> <code>WSDISPLAY_GINFO</code>? Remember that we previously saw that it is defined as such:</p><pre><code><code>#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>… which doesn’t help us much at this point. But we can chase the definition of <code>_IOR</code>, end up in <code>/usr/include/sys/ioccom.h</code>, and see:</p><pre><code><code>#define _IOC(inout, group, num, len) \\
((inout) | (((len) & IOCPARM_MASK) << IOCPARM_SHIFT) | \\
((group) << IOCGROUP_SHIFT) | (num))
#define _IOR(g,n,t)     _IOC(IOC_OUT,   (g), (n), sizeof(t))</code></code></pre><p>Ugh. We are combining the various arguments to <code>_IOR</code> into a number. This is hard to decipher by just reading the code, so we can ask the compiler to tell us the actual value of the constant instead:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <stdio.h>
int main(void) {
printf(\"%x\\n\", WSDISPLAYIO_GINFO);
}</code></code></pre><p>And if we run the program, we get that <code>WSDISPLAYIO_GINFO</code> is <code>0x40105741</code>. Knowing that, it’s <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">an SMOP</a> to call the <code>ioctl</code> using the <a href=\"https://docs.rs/libc/\">libc crate</a> alone:</p><pre><code><code>use std::ffi::{c_char, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
const WSDISPLAYIO_GINFO: u64 = 0x40105741;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
let result = libc::ioctl(
fd.as_raw_fd(),
WSDISPLAYIO_GINFO,
&mut fbi as *mut WsDisplayFbInfo,
);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>As you can see from this code snippet, we <em>also</em> have to define the <code>WsdisplayFbInfo</code> structure to match the kernel’s, so avoiding nix didn’t really make things simpler for us—and in fact, it made them uglier because now we have to deal with libc’s oddities like raw C strings, global <code>errno</code> values, and an opaque constant for the <code>ioctl</code> number. Not great.</p><h1><strong>Option 3: FFI</strong></h1><p>Which makes one wonder… can we avoid replicating the C interfaces in Rust and instead leverage the system-provided header files? Yes we can. Instead of trying to invoke the <code>ioctl</code>s from Rust, we can invoke them via some custom C glue code. Rust is going to call into the system-provided libc <em>anyway</em> when we invoke a system call, so we might as well switch to C a bit “earlier”.</p><p>The idea in this case, as in any other computing problem, is to add a layer of abstraction: instead of dealing with the kernel-defined data structures from Rust, we define <em>our own</em> structures and APIs to detach the Rust world from the C world. Here, look:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <sys/ioctl.h>
struct my_ginfo {
unsigned int height;
unsigned int width;
unsigned int depth;
};
int get_ginfo(int fd, struct my_ginfo* gi) {
struct wsdisplay_fbinfo fbi;
int result = ioctl(fd, WSDISPLAYIO_GINFO, &fbi);
if (result == -1) {
return result;
}
gi->height = fbi.height;
gi->width = fbi.width;
gi->depth = fbi.depth;
return 0;
}</code></code></pre><p>We start by declaring our own version of <code>wsdisplay_ginfo</code>, which I’ve called <code>my_ginfo</code>, that only includes the few fields we want to propagate to Rust. Yes, in this example the indirection is utterly pointless because we go from 4 to 3 fields so we haven’t made our lives easier, but there are <code>ioctl</code>s that return larger structures from which we might only need a few values. Then we define a trivial function to wrap the <code>ioctl</code> and transform its return value into our own structure.</p><p>Then, we go to Rust, re-define our <code>my_ginfo</code> structure as <code>MyGinfo</code> (both of which we fully control so we can easily verify that they match) and we call the wrapping function:</p><pre><code><code>use std::ffi::{c_char, c_int, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct MyGInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
}
extern \"C\" {
fn get_ginfo(fd: c_int, gi: *mut MyGInfo) -> c_int;
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut gi: MyGInfo;
unsafe {
gi = mem::zeroed();
let result = get_ginfo(fd.as_raw_fd(), &mut gi as *mut MyGInfo);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"my_ginfo: {:?}\", gi);
Ok(())
}</code></code></pre><p>The trick now is to link the C code with the Rust code together, and for that, we create a <code>build.rs</code> script. In here, we leverage the <a href=\"https://docs.rs/cc/\">cc crate</a> to put things together, which is an extra dependency that is only used at build time:</p><pre><code><code>fn main() {
println!(\"cargo::rerun-if-changed=src/ffi.c\");
cc::Build::new().file(\"src/ffi.c\").compile(\"ffi\");
}</code></code></pre><p>And with that, we are done.</p><h1><strong>Which option wins?</strong></h1><p>Well, let’s see:</p><pre><code><code>$ cargo build --release
...
Compiling ioctls-rust-ffi v0.1.0 (/home/jmmv/ioctls-rust/ffi)
Compiling ioctls-rust-libc v0.1.0 (/home/jmmv/ioctls-rust/libc)
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/ioctls-rust/nix)
Finished `release` profile [optimized] target(s) in 1.89s
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 464K Feb 12 08:04 target/release/ioctls-rust-nix
$ strip -s target/release/ioctls-rust-*
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 358K Feb 12 08:05 target/release/ioctls-rust-nix
$ █</code></code></pre><p>From a binary size perspective, there are no meaningful differences. As expected, the usage of the nix crate results in slightly more code than the other alternatives because nix has to do extra work to translate global <code>errno</code> values into Rust <code>Result</code> types and the like. But the libc and FFI alternatives seem identical.</p><p>At runtime, however, we should expect the FFI option to perform a teeny tiny bit worse (though good luck measuring that) than the libc option because we have to convert between the kernel structure and our own structure in the happy path… all for dubious benefit.</p><p>All in all, I’ll take option 1. I do not like the fact of having to manually replicate the kernel structures in my own code so, if I had the time, I’d try to upstream the definitions to the well-tested libc crate or write another reusable crate with just those. But, barring that, the idiomatic nix interfaces make calling Unix primitives a breeze.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "0.0" "image/jpeg") nil "d4d71a5e92145ec7f4f885166b7e7a43") (23 (26618 8216 348237 834000) "https://blogsystem5.substack.com/p/endbasic-0-11" "EndBASIC 0.11 is here" "Julio Merino" "Sat, 20 Jul 2024 14:01:40 +0000" "<p>Dear readers,</p><p>I hope you don’t mind me reposting an exciting EndBASIC release announcement here. There are at least two good reasons for me to do this, but before covering those, look at this glorious welcome window:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" width=\"880\" height=\"660\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":660,\"width\":880,\"resizeWidth\":null,\"bytes\":94233,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false,\"align\":null}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The EndBASIC online interpreter loading a trivial program to welcome you all.</figcaption></figure></div><p>So what are those two reasons you ask? Well…</p><p>The first is that EndBASIC is very much in context for the topic of this blog (right?) and my work on it is a source of ideas for future articles. The backlog has grown quite long so… stay tuned.</p><p>The second is that my free time is really limited and I tend to hyperfocus on individual topics for months in a row. Sometimes I’m in “blog-only mode” like at the beginning of this year when Blog System/5 received lots of attention. Other times I’m in “code-only mode” like during the past five months where I devoted all my time to EndBASIC. And as a consequence, this publication suffered. But I’m still here, and with this release out of the way, this blog should receive more attention throughout the rest of the sumer.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Did you know that subscribing to Blog System/5 is completely free? There are paid options as well though, and any donations go towards supporting my writing <em>and</em> these open source projects.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Without further ado, let’s get into the content of the announcement. You can find the <a href=\"https://www.endbasic.dev/2024/07/endbasic-0.11.html\">original copy in the EndBASIC blog</a>.</p><div><hr></div><p>After a year-and-a-half long hiatus, I am pleased to announce that EndBASIC 0.11.0 is now available! 🥳</p><p>This release marks a significant milestone because it addresses <em><strong>the</strong></em> top feature request from you all, namely the ability to define custom functions and subroutines. But it also includes other goodies such as support for an LCD console, a shiny new disassembler, and a faster execution engine.</p><p>There is a lot to talk about, but before we get to that, here are the must-visit links:</p><ul><li><p><strong><a href=\"https://repl.endbasic.dev/\">Launch the online interpreter</a></strong></p></li><li><p><strong><a href=\"https://github.com/endbasic/endbasic/releases/tag/endbasic-0.11.0\">Read the release notes</a></strong></p></li><li><p><strong><a href=\"https://repl.endbasic.dev/?run=jmmv/life.bas\">Launch a Conway’s Game of Life demo</a></strong></p></li></ul><p>Without further ado, let’s take a peek into the major changes.</p><h1>User-defined functions and subroutines</h1><p>As I mentioned earlier, EndBASIC 0.11 addresses the top feature request of all times: support for user-defined functions and subroutines. <a href=\"https://www.endbasic.dev/2022/12/endbasic-0.10.html\">EndBASIC 0.10</a> addressed some of the pain by adding <code>GOTO</code> and <code>GOSUB</code> but there was still a need for structured callables with parameter passing and local variables.</p><p>Something like the following is finally possible:</p><pre><code><code>DIM SHARED sum_calls AS INTEGER
FUNCTION sum(a, b)
sum = a + b
sum_calls = sum_calls + 1
END FUNCTION
SUB print_sum(prefix AS STRING, a, b)
PRINT prefix; sum(a, b)
END SUB
print_sum \"The sum of 5+7 is:\", 5, 7
print_sum \"The sum of 1+2 is:\", 1, 2
PRINT \"sum has been called\"; sum_calls; \"times\"</code></code></pre><p>Easy peasy, right? Indeed it is! But getting here required redoing a <em>huge</em> portion of the compiler and VM internals.</p><p>One major piece to resolve this puzzle was to implement a declarative arguments parser for the callables. Up until now, every builtin command and function carried hand-crafted code to parse its arguments. This was not a great design choice due to large amounts of code duplication and the risk of inconsistencies between commands and documentation, but it was the simplest way to get something off the ground a few years back.</p><p>I had been meaning to resolve this long-standing “to-do” but, the thing is, <a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">BASIC makes it </a><em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">really</a></em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\"> difficult</a> to come up with a generic arguments parser: every command has its own ad-hoc syntax. I needed a solution though, and after having implemented many commands in the previous 10 releases of EndBASIC, I landed on a handful of generic-enough constructs to serve my purposes… for now.</p><p>With this new release, every command and function specifies the structure of its arguments in a declarative fashion. The compiler then uses the generic parser to translate the arguments into call stack values based on what each callable defines. Then, at runtime, every callable just pops typed values off the call stack assuming that they are correctly parsed. Runtime execution of callables is now more efficient than before.</p><p>But there was another obstacle to resolve to support user-defined functions, and this was converting the expression evaluator to bytecode.</p><h1>Bytecode-based expression evaluation</h1><p>EndBASIC 0.10 shifted the virtual machine from an AST processor to a bytecode evaluator in order to support <code>GOTO</code> and <code>GOSUB</code>. However, the bytecode was really just a trivial lowering of the AST: expressions remained as AST nodes in the bytecode. This was fine for that release, but in order to support calling user-defined functions from within expressions, the expression evaluator needed a way to shift execution from builtin code to interpreted code and viceversa. As other languages call it, addressing “<a href=\"https://blog.bazel.build/2017/03/07/java-sandwich.html\">the sandwich problem</a>”.</p><p>The way to resolve this was to modify the compiler to emit bytecode for expression evaluation as well, thus turning the bytecode into “real bytecode” not polluted by AST elements. This was easy enough to prototype, but performance obviously suffered: what was previously handled in native code now required executing tens of bytecode instructions.</p><p>I had to do significant follow-up work to shift most of the type-checking that happened at runtime to the compiler, thus freeing the VM from complex conditional logic during execution. And the efforts paid off. As a benchmark, I stripped down the Game of Life demo of its UI and made it run 500 iterations on a 200x200 board. EndBASIC 0.10 needs 25 seconds to process this while 0.11 only needs 15 seconds. That’s a 40% improvement, and the optimization work is far from done.</p><p>And after doing all of this, I could not resist adding a disassembler. This is just a gimmick right now because the only thing you can do with the disassembled code is peek into the inner workings of the VM, but hey, that’s didactic on its own so it tracks well with the vision for EndBASIC.</p><p>Here, witness:</p><pre><code><code>Ready
LIST
a = 3
PRINT 5.2 + a
Ready
DISASM
0000    PUSH%       3                           # 1:5
0001    SETV        A
0002    PUSH#       5.2                         # 2:7
0003    LOAD%       A                           # 2:13
0004    %TO#
0005    ADD#                                    # 2:11
0006    PUSH%       2                           # 2:7
0007    CALLB       PRINT, 2                    # 2:1
Ready
█</code></code></pre><h1>LCD console</h1><p>The other big change in EndBASIC has to do with a new backend for its console.</p><p>Two years ago, when I was <a href=\"https://www.endbasic.dev/2021/02/endbasic-0.6.html\">adding GPIO support to EndBASIC</a>, I bought a little LCD for my Raspberry Pi and I envisioned using it to display the EndBASIC console. I did not get to it at the time but, this year, having spent too much time exclusively on Blog System/5, I needed to get back to coding. Working on a driver for the LCD is what sparked my interest to hack EndBASIC again and is what ended up triggering the chain of events that brought you 0.11 today.</p><p>I won’t bore you too much with the details about this because I already published a <a href=\"https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an\">separate blog post</a> that goes into the full story. To recap, let me just show you how this looks like in action:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"ed030d16-5773-4427-ba0e-fc628a219262\",\"duration\":null}\"></div><p><em>EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.</em></p><h1>Known issues</h1><p>There is one big issue that has come up last minute, and it is that the graphics console does <em>not</em> work on macOS anymore. My understanding is that my SDL driver violates fundamental assumptions of macOS (and possibly Windows as well) by driving the SDL interactions from a <em>secondary</em> thread. I suspect something has changed in macOS that makes this break. I’m not sure if my theory is true though, but even proving the theory is not trivial at all—so I have chosen to ship 0.11 “as is” even if this is broken because 0.10 and earlier are broken too. If you happen to use macOS, I’m sorry, you’ll have to fall back to the web interpreter.</p><p>Also, retrofitting bytecode execution into the AST-based evaluator has not been easy and, as a result, the code has accrued significant technical debt. Many things can still be simplified in the codebase and those would yield much faster runtime execution. But once again, I have had to draw a line and call the current implementation “good enough” in order to ship. Rewrites are never a good idea, but I’m at a point where a rewrite of the VM (<em>not</em> anything else!) from scratch would be beneficial.</p><p>And to be honest: I need a little break. I have spent all of my free time during the last 5 months on EndBASIC and I have neglected other things I want to do. In particular, Blog System/5 has suffered quite a bit and there are a bunch of topics I want to blog about. So I have had to force the 0.11 release in order to breathe for a little bit. But don’t worry: I’ll be back for more.</p><p>In any case, EndBASIC 0.11 should be the best EndBASIC to date. Go forth and play!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://repl.endbasic.dev/\",\"text\":\"Launch online interpreter\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://repl.endbasic.dev/\"><span>Launch online interpreter</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "0.0" "image/jpeg") nil "c68537426feeac86f98bb490953f1316") (22 (26593 44719 965880 976000) "https://blogsystem5.substack.com/p/bazel-next-generation" "The next generation of Bazel builds" "Julio Merino" "Mon, 24 Mar 2025 15:03:25 +0000" "<p>Today marks the 10th anniversary of <a href=\"https://blog.engflow.com/2024/10/01/birth-of-the-bazel/\">Bazel’s public announcement</a> so this is the perfect moment to reflect on what the next generation of build systems in the Bazel ecosystem may look like.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/b2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":525451,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159682182?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>I write this with the inspiration that comes from attending <a href=\"https://www.linkedin.com/feed/update/urn:li:activity:7295871444343734272/\">the first ever conference on Buildbarn</a>, one of the many remote execution systems for Bazel. In the conference, Ed Schouten, the creator of <a href=\"https://github.com/buildbarn\">Buildbarn</a>, presented Bonanza: a skunkworks reimagination of Bazel for truly large builds.</p><p>In this article, I want to dive into what Bonanza is and what similar projects to “replace Bazel” have existed. To get there though, we need to start first with a critique of the current implementation of Bazel.</p><h1><strong>Problems scaling up</strong></h1><p>The predecessor to Bazel, Blaze, is a build system designed at Google for Google’s monorepo scale. Blaze grew over the years assuming:</p><ul><li><p>that every engineer had a beefy workstation under their desk;</p></li><li><p>that remote execution was expected to be used by default;</p></li><li><p>that the remote execution cluster was reachable through a fast and low latency network; and</p></li><li><p>that each office had physical hardware hosting a local cache of remote build artifacts.</p></li></ul><p>These assumptions allowed Blaze to “scale up” to the very large codebase that Google builds, but they came with some downsides.</p><p>One consequence of these assumptions is that the Bazel process—confusingly named the “Bazel server”—that runs on your machine is very resource hungry. The reason is that this process has to scan the source tree to understand the dependency graph and has to coordinate thousands of RPCs against a remote cluster—two operations that aren’t cheap. What’s worse is that the Bazel server process is stateful: at start up, Bazel goes through the expensive steps of computing the analysis graph from disk and, to prevent redoing this work in every build, Bazel keeps this graph in its in-memory “analysis cache”.</p><p><a href=\"https://bazel.build/advanced/performance/iteration-speed\">The analysis cache is fragile.</a> The Bazel server process may auto-restart, and certain flags used to control the build cause the cache to be discarded. These are not rare flags, no: these include basic flags like <code>-c</code> to change the compilation mode from debug to release, among many others. Cache discards are very intrusive to user workflows because an iterative build that would have taken a second now takes maybe thirty, for example.</p><p>This user experience degradation makes Bazel’s front-page claim of being fast hard to believe. Bazel is really fast at running gigantic builds from scratch and it is really efficient when executing incremental builds. But the problem is that “truly incremental builds” are a rarity, so you end up paying the re-analysis cost many more times than is necessary. If you run Bazel in a CI environment, you know that these costs are far from negligible because every single Bazel process invocation on a fresh CI node can take <em>minutes</em> to “warm up”.</p><h1><strong>Problems scaling down</strong></h1><p>There is also the other side of the coin, which is that Bazel does not scale <em>down</em> very well. This was one of my <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">original critiques</a> when Bazel went open source in 2015: at that time, I really wished for a declarative build system like Bazel to replace the mess that was and is Make plus the GNU Autotools, but the fact that Bazel was written in Java meant that it would never do this (mostly for non-technical reasons).</p><p>Regardless, <a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">I </a><em><a href=\"http://localhost:1313/2016/01/joining-blaze-team.html\">did</a></em><a href=\"https://jmmv.dev/2016/01/joining-blaze-team.html\"> join the Blaze team</a> after that, and I spent most of my time coercing Blaze and Bazel to run nicely on “small” laptop computers. I succeded in some areas, but it was a losing battle: Java had certain deficiencies that prevent implementing <em>lean</em> software. <a href=\"https://wiki.openjdk.org/display/loom/Main\">Project Loom</a> and <a href=\"https://en.wikipedia.org/wiki/Project_Valhalla_(Java_language)\">Project Valhalla</a> promise to bring the necessary features to Java, but these features aren’t quite there yet—and even when they are, retrofitting these into Bazel will be a very hard feat.</p><p>In any case. Bazel works, and it works nicely for many use cases, but it lives in this limbo state where it isn’t awesome for very large builds and it isn’t awesome for very small builds either. So, let’s look at the former: how do we make Bazel awesome for humongous builds? By lifting it in its entirety to the cloud.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Enjoying this article? If so, please subscribe to Blog System/5 to show your support. It’s free and you’ll appreciate future content!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Enter Bonanza</strong></h1><p>Bonanza is Ed’s playground for a new build system: a build system that takes remote execution to the limit. Where Bazel is only capable of shipping individual build actions to the cloud, Bonanza uses the cloud for <em>everything</em>, including external dependency handling, build graph construction and iteration, and more.</p><p>To understand what Bonanza brings to the table in the context of hugely scalable builds, let’s distill the salient points that Ed highlighted in his <a href=\"https://docs.google.com/presentation/d/1uh6CxvvziQunw55e_bs1Juz3jfaiE-QJVs2DCfeMeTw/edit#slide=id.g339c289dd60_1_29\">“Bonanza in a nutshell”</a> slide from his conference presentation (recording coming soon):</p><ul><li><p><strong>Bonanza can only execute build actions remotely.</strong> There is no support for local execution, which makes the build driver (the process that runs on your machine) simpler and eliminates all sorts of inconsistencies that show up when mixing local and remote execution. Bazel’s <a href=\"https://jmmv.dev/2019/12/bazel-strategies.html\">execution strategies</a> tend to enforce hermeticity, but they don’t always succeed because of sandboxing limitations.</p></li><li><p><strong>Bonanza performs analysis remotely.</strong> When traditional Bazel is configured to execute all actions remotely, the Bazel server process is essentially a driver that constructs and walks a graph of nodes. This <em>in-memory</em> graph is known as <a href=\"https://bazel.build/reference/skyframe\">Skyframe</a> and is used to represent <em>and execute</em> a Bazel build. Bonanza lifts the same graph theory from the Bazel server process, puts it into a remote cluster, and relies on a distributed persistent cache to store the graph’s nodes. The consequence of storing the graph in a distributed storage system is that, all of a sudden, <em>all</em> builds become incremental. There is no more “cold build” effect like the one you see with Bazel when you lose the analysis cache.</p></li><li><p><strong>Bonanza runs repo rules remotely.</strong> Repo rules are what Bazel uses to interact with out-of-tree dependencies, and they can do things like download Git repositories, toolchain binaries, or detect what compiler exists in the system. What you should know is that Blaze <em>did not</em> and <em>does not</em> have repo rules nor support for workspaces because Google uses a strict monorepo. Both the repo rules and the workspace were bolted-on additions to Blaze when it was open-sourced as Bazel, and it shows: these features do not integrate cleanly with the rest of Bazel’s build model, and they have been clunky for years. Bonanza fixes these issues with a cleaner design.</p></li><li><p><strong>Bonanza encrypts data in transit and at rest.</strong> Bonanza brings to life some of the features discussed for the Remote Execution v3 protocol, which never saw the light of day, and encryption is one of them. By encrypting all data that flows through the system, Bonanza can enforce provenance guarantees if you control the action executors. This is important because it allows security-conscious companies to easily trust using <a href=\"https://bazel.build/community/remote-execution-services\">remote build service providers</a>.</p></li><li><p><strong>Bonanza only supports rules written in Starlark.</strong> When Bazel launched, it included support for <a href=\"https://github.com/bazelbuild/starlark\">Starlark</a>: a new extensibility language with which to write build logic in. Unfortunately, for historical reasons, Bazel’s core still included Java-native implementations of the most important and complex rules: namely, C++, Java and protobuf. Google has been chasing the dream of externalizing all rule implementations into Starlark for the last 10 years, and only in Bazel 8 they <em>mostly</em> have achieved this goal. Bonanza starts with a clean design that requires build logic to be written in Starlark, and it pushes this to the limit: <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/builtins_core/exports.bzl\">almost everything</a>, including <a href=\"https://github.com/buildbarn/bonanza/blob/472f8e9917e8ce64c21e365e178b5bb2941865bc/starlark/bazel_tools/command_line_option/BUILD.bazel\">flags</a>, is Starlark.</p></li><li><p><strong>Bonanza aims to be Bazel compatible.</strong> Of the modern build systems that use a functional evaluation model like Bazel, only Bazel has been able to grow a significant community around it. This means that the ecosystem of tools and rules, as well as critical features like good IDE support, is thriving in Bazel whereas this cannot be said of other systems. Bonanza makes the right choice of being Bazel compatible so that it can reuse this huge ecosystem. Anyone willing to evaluate Bonanza will be able to do so with relative ease.</p></li></ul><p>When you combine all of these points, you have a build system where the client process on your development machine or on CI is thin: all the client has to do is upload the project state to the remote execution cluster, which in the common case will involve <em>just</em> uploading modified source files. From there, the remote cluster computes the delta of what you uploaded versus any previously-built artifacts and reevaluates the minimum set of graph nodes to produce the desired results.</p><p>Are your hopes up yet? Hopefully so! But beware that Bonanza is <em>just</em> a proof of concept for now. The <a href=\"https://github.com/buildbarn/bonanza\">current implementation</a> shows that all of the ideas above are feasible and it can fully evaluate the complex <a href=\"https://github.com/buildbarn/bb-storage\">bb-storage project</a> from scratch—but it doesn’t yet provide the necessary features to <em>execute</em> the build. Ed appreciates PRs though!</p><h1><strong>Meanwhile, at Google</strong></h1><p>My time at Google is now long behind as I left almost five years ago, but back then there were two distinct efforts that attempted to tackle the scalability issues described in this article. (I can’t name names because they were never public, but if you probe ChatGPT to see if it knows about these efforts, it somehow knows specific details.)</p><p>One such effort was to make Blaze “scale up” to handle even larger builds by treating them all as incremental. The idea was to persist the analysis graph in a distributed storage system so that Blaze would never have to recompute it from scratch. This design still kept a relatively fat Blaze process on the client machine, but it is quite similar to what Bonanza does. Google had advantages over Bonanza in terms of simplicity because, as I mentioned earlier, Blaze works in a pure monorepo and does <em>not</em> have to worry about repo rules.</p><p>The other such effort was to make Blaze “scale down” by exploring a rewrite in Go. This rewrite was carefully crafted to optimize memory layouts, avoiding unnecessary pointer chasing (which was impossible to avoid in Java). The results of this experiment proved that Blaze could be made to analyze large portions of Google’s build graph in just a fraction of the time, without any sort of analysis caching or significant startup penalties. Unfortunately, this rewrite was way ahead of its time: the important rulesets required to build Google’s codebase were still implemented inside of Blaze as Java code, so this experimental build system couldn’t do anything useful outside of Go builds.</p><h1><strong>Meanwhile, at Meta</strong></h1><p>My knowledge of Meta’s build system is limited, but almost two years ago, Meta released <a href=\"https://buck2.build/\">Buck 2</a>, a complete reimplementation of their original Bazel-inspired build system. This reimplementation <a href=\"https://buck2.build/docs/about/why/\">checked most of the boxes</a> for what I thought a “Bazel done right” would look like:</p><ul><li><p><strong>Buck 2 is written in a real systems language (Rust).</strong> As explained earlier, I had originally criticised Java’s choice as one of Bazel’s weaknesses. It turns out Meta realized this same thing because Buck 1 had also been written in Java and they chose to go the risky full-rewrite route to fix it. (To be fair, you need to understand that Java had been a reasonable choice back then: when both Blaze and Buck 1 were originally designed, C++11—possibly the only reasonable edition of C++—didn’t even exist.)</p></li><li><p><strong>Buck 2 is completely language agnostic.</strong> Its core build engine does not have any knowledge of the languages it can build, and all language support is provided via Starlark extensions. This stems from learning about earlier design mistakes of both Blaze and Buck 1. Meta chose to address this as part of the Rust rewrite, whereas Google has been addressing it incrementally.</p></li><li><p><strong>Buck 2 has first-class support for virtual file systems</strong>. These are a necessity when supporting very large codebases and when integrating with remote build systems, but are also completely optional. Blaze also had support for these, but not Bazel.</p></li></ul><p>At launch, I was excited and eager to give Buck 2 a try, but then the disappointment came in: as much as it walks and quacks like Bazel due to its use of Starlark… the API that Buck 2 exports to define rules is <em>not compatible</em> with Bazel’s. This means that Buck 2 cannot be used in existing Bazel codebases, so the ability to evaluate its merits in a real codebase is… insurmountable. In my mind, this made Buck 2 dead on arrival, and it’s yet to be seen if Meta will be able to grow a significant public ecosystem around it.</p><p>In any case, I do not have any experience with Buck 2 because of the previous, so I cannot speak to its ability to scale either up or down. And this is why I wrote this section: to highlight that being Bazel-compatible is critical in this day and age if you want to have a chance at replacing a modern system like Bazel. Bonanza <em>is</em> Bazel-compatible so it has a chance of demonstrating its value with ease.</p><h1><strong>What lies ahead</strong></h1><p>If you ask me, it seems impossible to come up with a single build system that can satisfy the wishes of tiny open-source projects that long for a lean and clean build system and that can satisfy the versatility and scale requirements of vast corporate codebases.</p><p>Bazel-the-implementation tries to appeal to both and falls short, yet Bazel-the-ecosystem provides the lingua franca of what those implementations need to support.</p><p>My personal belief is that <em>we need two build systems</em> that speak the same protocol (Starlark and Bazel’s build API) so that users can interchangeably choose whichever one works best for their use case:</p><ul><li><p>On the one hand, we need a massively scalable build system that does all of the work in the cloud. This is to support building monorepos, to support super-efficient CI runs, and to support “headless” builds like those offered by hosted VSCode instances. Bonanza seems to have the right ideas and the right people behind it to fulfill this niche.</p></li><li><p>On the other hand, we need a tiny build system that does all of the work locally and that can be used by the myriad of open-source projects that the industry relies on. This system has to be written in Rust (oops, I said it) with minimal dependencies and be kept lean and fast so that IDEs can communicate with it quickly. This is a niche that is not fulfilled by anyone right now and that my mind keeps coming to; it’d be fun to create this project given <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my last failed attempt</a>.</p></li></ul><p>The time for these next-generation Bazel-compatible build systems is <em>now</em>. Google has spent the last 10 years Starlark-ifying Bazel, making the core execution engine replaceable. We are reaching a point where the vast majority of the build logic can be written in Starlark as Bonanza proves, and thus we should be able to have different build <em>tools</em> that implement the same build <em>system</em> for different use cases.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb2fe6a75-3b5d-4896-8e41-e7bc64961dd7_2048x2048.jpeg" "0.0" "image/jpeg") nil "78b0d3f7041d17bd5c977a0cb2010400") (21 (26581 14064 672957 764000) "https://blogsystem5.substack.com/p/bazel-at-snowflake-two-years-in" "Bazel at Snowflake two years in" "Julio Merino" "Sat, 15 Mar 2025 01:00:58 +0000" "<p>Two and a half years ago, I <a href=\"https://jmmv.dev/2022/10/bye-microsoft-hi-snowflake.html\">joined Snowflake</a> to help their mission of migrating to Bazel. I spent the first year of this period as an Individual Contributor (IC) diving deep into the migration tasks, and then I took over the Tech Lead (TL) role of the team to see the project through completion.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":792369,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>This week, we publicly announced that we completed our migration to Bazel for the largest part of our codebase and we provided details on our journey. I did not publish that article here for obvious reasons, so… today’s entry is going to be a light one: all I want to do is point you at our announcement as well as the various <em>other</em> related articles that came before it.</p><p>Don’t despair though: those articles, including the announcement, are all full of technical details—just like the kind of content you expect to receive from Blog System/5. So, even if this piece is light, you have enough reading material for the weekend via the links below.</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\">“Addressing Bazel OOMs”</a></strong><br><em>March 16th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\" width=\"1456\" height=\"972\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":972,\"width\":1456,\"resizeWidth\":null,\"bytes\":1420523,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":\"https://jmmv.dev/2023/03/addressing-bazel-ooms.html\",\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5b72b8bd-c93c-488a-8cf0-94ebe2ab53c9_4800x3203.jpeg 1456w\" sizes=\"100vw\"></picture><div></div></div></a></figure></div><p>This was the very first article that we in the Engineering Systems organization—previously known as Developer Productivity Engineering—wrote publicly about our work. Me writing it was no coincidence as I was the one advocating for more openness about the cool stuff we were doing. Yes, I missed blogging about Bazel <a href=\"https://jmmv.dev/tags/bazel/index.html\">as I had done in the years prior</a>.</p><p>In this article about Out-Of-Memory (OOM) conditions, I covered the very interesting problem of trying to fit Bazel builds into limited laptop resources. This was déjà-vu for me: back when I was in the Blaze team at Google, I owned the same problem of making Blaze, a tool that had grown assuming massive workstations, run decently on machines with limited resources.</p><p>The problems were technically challenging and worth talking about, hence this article. In it, I covered three issues: preventing Bazel from spawning too many memory-hungry compilers and linkers at once; making nested builds behave nicely; and tuning Bazel to drive a large number of remote tasks with limited memory resources.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\">“Analyzing OOMs in IntelliJ with Bazel”</a></strong><br><em>October 6th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\" width=\"1300\" height=\"550\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":550,\"width\":1300,\"resizeWidth\":null,\"bytes\":143457,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5cf42257-4902-49d9-a795-43be9e6bf5cb_1300x550.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>Our saga dealing with OOMs was arduous and long, which you can tell by the time gap between the previous article and this one.</p><p>In this piece, I looked at how IntelliJ itself was running into memory limits, which resulted in the IDE and its container VM freezing during normal operation. The result of this work was careful tuning of the Bazel project settings to make it fit within reasonable limits, but the interesting part—and the one described here—was the process to arrive to those findings.</p><p>Not too long after I wrote this, we pivoted away from constrained laptop builds to cloud-based workstations, which made all OOM conditions vanish at the expense of using much more RAM (maybe <em>too much</em> RAM, but alas… it’s cheap). Stay tuned for an upcoming article (not from me this time!) on this topic.</p><div><hr></div><p><strong><a href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\">“Build farm visualizations”</a></strong><br><em>October 20th, 2023</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://jmmv.dev/2023/10/build-farm-visualizations.html\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\" width=\"1456\" height=\"561\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":561,\"width\":1456,\"resizeWidth\":null,\"bytes\":895757,\"alt\":\"\",\"title\":null,\"type\":\"image/png\",\"href\":\"https://jmmv.dev/2023/10/build-farm-visualizations.html\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc27e030c-8d56-42d4-99b5-7b162f80e8bb_3586x1382.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>As part of our migration to Bazel, we didn’t just convert our build from one tool to another. We also decided to deploy our own remote execution cluster from the get go based on <a href=\"https://github.com/buildbarn\">Buildbarn</a> which… gave us its own set of problems. Buildbarn’s architecture is straightforward in paper, but there are a ton of knobs to control how it runs. Making it scale to the huge volume of traffic we experience was not an easy feat.</p><p>One specific problem we faced was overall poor performance of our cluster, which was eventually root-caused to our remote execution workers using slow local storage volumes. This issue had escaped us for a while, and it wasn’t until I wrote a tool to <em>visualize</em> the cluster behavior that it didn’t become obvious. From there, the solution was easy.</p><p>Wanna know more? We are hosting a 1-day conference <em>next week</em> on Buildbarn specifically. <a href=\"https://docs.google.com/forms/d/e/1FAIpQLSeG4We59b6labcH77JOiblk7F3MRi8LH6SbjIrFTNCBYXeJnA/viewform\">See the schedule and sign up</a> if you can make it!</p><div><hr></div><p><strong><a href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\">“Fast and Reliable Builds at Snowflake with Bazel”</a></strong><br><em>March 13th, 2025</em></p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\" width=\"1200\" height=\"514\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":514,\"width\":1200,\"resizeWidth\":null,\"bytes\":172503,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":\"https://www.snowflake.com/en/engineering-blog/fast-reliable-builds-snowflake-bazel/\",\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/159102965?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F930ed02b-9ca3-42c7-94bb-ca89f0373b6d_1200x514.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a></figure></div><p>And finally, the crown jewel. This is the official article published just yesterday where I present the 2-year journey of our migration. In it, I explain the challanges that we faced with our C++ and Java codebases specifically, the choices behind our use of remote execution, and the path we took to production. I conclude with a glimpse on what lies ahead of us.</p><div><hr></div><p>That’s all for today. I promised it would be short :)</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f9611ac-1f26-4bb6-bacb-8f0abe557c19_1920x1440.jpeg" "0.0" "image/jpeg") nil "758966ba7b1d99723ef5a98a0553bdf1") (20 (26569 31003 326234 564000) "https://blogsystem5.substack.com/p/hardware-autoconfiguration" "Hardware discovery: ACPI & Device Tree" "Julio Merino" "Sat, 01 Mar 2025 00:10:54 +0000" "<p>If you grew up in the PC scene during the 1980s or early 1990s, you know how painful it was to get hardware to work. And if you did not witness that (lucky you) here is how it went: every piece of hardware in your PC—say a sound card or a network card—had physical switches or jumpers in it. These switches configured the card’s I/O address space, interrupts, and DMA ports, and you had to be careful to select values that did not overlap with other cards.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\" width=\"663\" height=\"448\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":448,\"width\":663,\"resizeWidth\":null,\"bytes\":89630,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Portion of a Sound Blaster Pro ISA card focusing on the jumpers to configure its I/O settings.</figcaption></figure></div><p>But that wasn’t all. Once you had configured the physical switches, you had to tell the operating system and/or software <em>which</em> specific cards you had and how you had configured them. Remember <code>SET BLASTER=A220 I5 D1 H5</code>? This DOS environment variable told programs which specific Sound Blaster you had installed and which I/O settings you had selected via its jumpers.</p><p>Not really fun. It was common to have hardware conflicts that yielded random lock-ups, and thus <a href=\"https://wiki.osdev.org/ISA\">ISA “Plug and Play”</a>, or PnP for short, was born in the early 1990s—a protocol for the legacy ISA bus to enumerate its devices and to configure their settings via software. Fast-forward to today’s scene where we just attach devices to external USB connectors and things “magically work”.</p><p>But how? How does the kernel know which physical devices exist and how does it know which of the many device drivers it contains can handle each device? Enter the world of hardware discovery.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If this sounds interesting, please consider subscribing to Blog System/5! It’s completely free but you can also choose to donate to keep me writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Hardware topology</strong></h1><p>When you learn about the <a href=\"https://en.wikipedia.org/wiki/Von_Neumann_architecture\">Von Neumann architecture</a> in school, you are typically told that there is a CPU, a chunk of memory, and… “I/O devices”. The CPU and memory portions are where all the focus is put and the I/O devices portion is always “left to the reader”. However, there is <em>a lot</em> of stuff happening in that nebulous cloud.</p><p>The first question that arises is: what’s in that I/O cloud? Well, take a look:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\" width=\"785\" height=\"576\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":576,\"width\":785,\"resizeWidth\":null,\"bytes\":93266,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55d3aabb-015f-4ae3-a399-15fe965d124a_785x576.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The Windows 2000 Device Manager showing the devices by their connection, not by their type. I've chosen to show you this configuration of a virtual machine instead of what a current Windows 11 system shows because the older view is simpler to digest.</figcaption></figure></div><p>Whoa, that’s a lot of stuff, but we can classify the items in the “nebulous cloud of I/O devices” into two categories:</p><ul><li><p>The devices themselves, obviously.</p></li><li><p>The busses that connect those devices to the CPU.</p></li></ul><p>Both are important: you might have a fancy keyboard with extra keys that requires a special driver, and this keyboard might come in PS/2 and USB versions. The driver for the keyboard may be the same for each version, but the “glue” that attaches this keyboard to either bus is different, and the way the kernel can tell whether the keyboard is attached to one port or another also differs.</p><p>So how does the kernel know how to find hardware without tons of repeated code for every bus, you ask? It does so via its knowledge of the hardware topology. Just above, I showed you Windows’ view of this, but for the rest of this article, I’ll use the BSD internals (and NetBSD specifically) because that’s what I know best. Don’t let that put you off though: all kernels have to do something similar and the differences among them are likely not meaningful.</p><p>Here is a little snippet of the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/amd64/conf/GENERIC\">default NetBSD kernel configuration file for the amd64 platform</a>. This snippet lays out the topology of serial ports in the PC and the busses in which they may appear:</p><pre><code><code>pci*    at mainbus? bus ?
pcib*   at pci? dev ? function ?
puc*    at pci? dev ? function ?
com*    at puc? port ?
isa0    at mainbus?
isa0    at pcib?
com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3
acpi0   at mainbus0
com*    at acpi?</code></code></pre><p>Daunting if you have never seen anything like this, I know, but let me translate this to a diagram:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\" width=\"1456\" height=\"922\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/e1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":922,\"width\":1456,\"resizeWidth\":null,\"bytes\":85835,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":\"https://blogsystem5.substack.com/i/158141927?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png\",\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe1b3cdc5-42bd-48ac-ae78-dd4a65fbf9d0_1800x1140.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how the com device is expected to appear under various busses according to the kernel configuration file.</figcaption></figure></div><p>Much clearer in picture form, right? What this chunk of configuration does is tell the kernel the places where the <code>com</code> driver can find serial ports. We have a chunk that says that <code>com0</code> and <code>com1</code> can appear on the ISA bus at <em>specific</em> I/O addresses and interrupts, and in turn that the ISA bus may be a directly-addressable physical bus (<code>isa0 at mainbus?</code>) and/or an ISA bus exposed via a PCI bridge (<code>isa0 at pcib?</code>). Then, we have additional entries telling us that the serial ports can also be configured via ACPI (<code>com* at acpi?</code>), and that the serial ports may exist on expansion cards (<code>com* at puc?</code>) providing communication ports via the PCI bus (<code>puc* at pci?</code>).</p><p>The problem is: the kernel configuration tells us <em>what may exist</em>, not <em>what actually exists</em> on a machine. In a sense, the configuration file “wires” the code of the device drivers like <code>com</code> so that they can find devices that appear under the <code>isa</code>, <code>pci</code>, or <code>acpi</code> busses. But the kernel must still, at runtime, check and see where the devices actually are. How does that happen?</p><h1><strong>Hardware auto-configuration</strong></h1><p>To answer the question of how the kernel discovers which hardware is present and where it is, let’s dissect NetBSD’s <a href=\"https://man.netbsd.org/autoconf.9\">autoconf(9)</a> manual page:</p><blockquote><p>Autoconfiguration is the process of matching hardware devices with an appropriate device driver. In its most basic form, autoconfiguration consists of the recursive process of finding and attaching all devices on a bus, including other busses.</p></blockquote><p>From this paragraph, we can extract the following: the kernel contains a collection of device drivers (like the <code>com</code> presented earlier). Device drivers are just code that knows how to interact with specific devices, but the “location” of these devices in the hardware topology may vary (the “bindings” to <code>isa</code>, <code>puc</code>, and <code>acpi</code> in the earlier example). Moving on:</p><blockquote><p>The autoconfiguration framework supports direct configuration where the bus driver can determine the devices present. The autoconfiguration framework also supports indirect configuration where the drivers must probe the bus looking for the presence of a device. Direct configuration is preferred since it can find hardware regardless of the presence of proper drivers.</p></blockquote><p>Direct and indirect configuration. Hmm. This sounds like the PnP story, and it kinda does. See, pay close attention to these two lines from the earlier snippet:</p><pre><code><code>com0    at isa? port 0x3f8 irq 4
com1    at isa? port 0x2f8 irq 3</code></code></pre><p>These are the BSD equivalent of the <code>SET BLASTER=A220 I5 D1 H5</code> command for DOS I mentioned in the introduction: they tell the kernel which precise addresses and interrupts to use for the two standard PC serial ports <em>if an ISA bus is present</em>.</p><p>But what about <code>com* at puc?</code> and <code>com* at acpi?</code>? These lines are neat because they do <em>not</em> tell us, in advance, where to find the serial ports: we expect the kernel to discover those details at runtime so that we don’t have to recompile the kernel when the hardware changes. But even if these two look similar, they are quite different: the <code>com* at puc?</code> is an indirect configuration entry: the <code>puc</code> driver will have to probe the PCI bus for the presence of a communications card and, if one exists, tell the <code>com</code> driver that it can attach to it. On the other hand, the <code>com* at acpi?</code> entry is direct: the kernel will read the ACPI configuration (a static table) to know where the ports are and then use those details to configure the <code>com</code> driver.</p><p>Alright, so this raises <em>another</em> question. What <em>is</em> ACPI?</p><h1><strong>ACPI</strong></h1><p>ACPI, despite being declared with <code>acpi0 at mainbus0</code> in a form similar to <code>isa0 at mainbus?</code>, is <em>not</em> a bus: ACPI does not physically connect devices to one another. To understand what ACPI does, we can start by realizing that it stands for <a href=\"https://en.wikipedia.org/wiki/ACPI\">Advanced Configuration and Power Interface</a> and then, quoting the Wikipedia article:</p><blockquote><p>Advanced Configuration and Power Interface (ACPI) is an open standard that operating systems can use to discover and configure computer hardware components, to perform power management (e.g. putting unused hardware components to sleep), auto configuration (e.g. Plug and Play and hot swapping), and status monitoring.</p></blockquote><p>ACPI is about configuration, and the kernel uses the ACPI tables, present in any modern PC, to find where devices are. To illustrate how this works, let’s look at the <code>com* at acpi?</code> line. This line says that the serial port can be configured via ACPI if ACPI happens to have an entry for it. And you know, we can peek into the ACPI tables of a running machine to see what that might be:</p><pre><code><code># acpidump -dt | grep -A15 COM1
Device (COM1)
{
Name (_HID, EisaId (\"PNP0501\") /* 16550A-compatible COM Serial Port */)  // _HID: Hardware ID
Name (_UID, One)  // _UID: Unique ID
Name (_CRS, ResourceTemplate ()  // _CRS: Current Resource Settings
{
IO (Decode16,
0x03F8,             // Range Minimum
0x03F8,             // Range Maximum
0x01,               // Alignment
0x08,               // Length
)
IRQNoFlags ()
{4}
})
}
# █</code></code></pre><p><em>(Pro-tip: you can use </em><code>acpidump</code><em> to extract the Windows license key bound to your machine, if any. I’ve needed to do this in the past to install Windows in a VM after replacing the host OS with FreeBSD.)</em></p><p>Voila. The ACPI tables provided by the system tell us a similar story to what the explicit <code>com0 at isa?</code> entry did (and no surprise here because this is a legacy device): there is a serial port at base address 0x3f8 that uses interrupt 4. But also, this table tells us the hardware identifier for this entry: <code>PNP0501</code>. Grepping through the NetBSD kernel code base for this identifier, we land on the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/dev/acpi/com_acpi.c#L60\">dev/acpi/com_acpi.c</a> file:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
// ...
/* 16550A-compatible COM port */
{ .compat = \"PNP0501\", .value = COM_TYPE_NORMAL },
// ...
};</code></code></pre><p><em>(Another pro-tip: master <a href=\"https://github.com/BurntSushi/ripgrep\">ripgrep</a>. Knowing how to find a needle in the haystack of a large code base will grant you super-powers among your coworkers. Being able to pinpoint where specifically to start an investigation based on a “random-looking” string is invaluable.)</em></p><p>Aha! This <code>com_acpi.c</code> file provides the necessary glue to direct the generic serial port <code>com</code> driver to the hardware via whatever the ACPI tables prescribe. From here, the kernel can proceed to <em>attach</em> the driver to the device and connect the dots between the user-space <code>/dev/ttyS0</code> interface to the physical serial port.</p><h1><strong>Device Tree</strong></h1><p>In the world of embedded devices powered by SOCs—\"<a href=\"https://en.wikipedia.org/wiki/System_on_a_chip\">System on a Chip</a>\", a term that describes single chips that provide all functions to build a computer, ranging from the CPU to sound and network cards—we don’t have ACPI tables. What we used to have instead was explicit code <em>for every board/chip combination</em> that knew how to address the hardware in each SOC. Linux used to be a mess of half-baked and abandoned forks, each supporting a different board without hopes of unification into mainline due to the lack of generic interfaces.</p><p>The <a href=\"https://www.devicetree.org/\">Device Tree</a> specification fixed this issue for the most part for architectures like aarch64. With Device Tree, each hardware or OS vendor provides a static table that describes the layout of a board’s hardware separately from the code of the kernel. Then, the kernel peeks into this table to know which devices exist and where they are in the machine layout, much like it does with ACPI.</p><p>A big difference with ACPI, however, is that the kernel cannot query the Device Tree from the hardware because… well, the Device Tree is external to the hardware. The kernel expects the Device Tree to “exist in memory” either because the kernel image <em>embeds</em> the Device Tree for the target board or because the boot loader loads the Device Tree from disk and passes it to the kernel.</p><p>Once the kernel has the Device Tree though, the hardware discovery process is similar to the one in ACPI: the kernel scans the Device Tree and looks for drivers that can attach to device nodes based on hardware identifiers. From the perspective of the kernel configuration, things look very similar between amd64 and aarch64. See this snippet from the <a href=\"https://github.com/NetBSD/src/blob/a6998e32a89571344dc476036a4af47672d183f0/sys/arch/evbarm/conf/GENERIC64\">generic kernel of the evbarm port</a>:</p><pre><code><code>armfdt0     at root
simplebus*  at fdt? pass 0
com*        at fdt? pass 4</code></code></pre><p>This configuration snippet tells the aarch64 kernel that a <code>com</code> device may appear on <code>fdt</code>, which stands for “Flat Device Tree”. In turn, <code>armfdt0 at root</code> says that there is a specific driver named <code>armfdt0</code> that provides access to the <code>fdt</code> loaded by the boot loader on an ARM machine.</p><p>We can inspect the Device Tree from the command line as the Device Tree is exposed via the same interface that OpenFirmware used due to its historical roots. For example, to fetch the portion of the Device Tree for the serial port on an aarch64 machine:</p><pre><code><code># ofctl serial1
[Caching 121 nodes and 781 properties]
clocks                  0000000e 00000000 ........ ........   ........
compatible              6272636d 2c62636d 32383335 2d617578   \"brcm,bcm2835-aux
0010:       2d756172 7400.... ........ ........   -uart\"
interrupts              00000001 0000001d ........ ........   ........
name                    73657269 616c00.. ........ ........   \"serial\"
phandle                 0000004c ........ ........ ........   ...L
pinctrl-0               0000000f ........ ........ ........   ....
pinctrl-names           64656661 756c7400 ........ ........   default.
reg                     7e215040 00000040 ........ ........   ~!P@...@
status                  6f6b6179 00...... ........ ........   okay.
# █</code></code></pre><p>A binary dump. OK, fine, we can intuit <em>something</em> out of this, but it isn’t particularly clear. The problem here is that we are looking at the binary encoding of the Device Tree (the DTB). But the DTB is built from a set of corresponding source files (one or more DTS files), and if we look at the common <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/external/gpl2/dts/dist/arch/arm/boot/dts/bcm283x.dtsi#L385\">DTS for Broadcom 283x boards</a>, we find the following more-readable content:</p><pre><code><code>/ {
aliases {
/* ... */
serial1 = \"/soc/serial@7e215040\";
};
soc {
/* ... */
serial@7e215040 {
compatible = \"brcm,bcm2835-aux-uart\";
reg = <0x7e215040 0x40>;
interrupts = <0x01 0x1d>;
clocks = <0x0e 0x00>;
status = \"okay\";
pinctrl-names = \"default\";
pinctrl-0 = <0x0f>;
phandle = <0x4c>;
};
};
};</code></code></pre><p>The detail to highlight here is the <code>brcm,bcm2835-aux-uart</code> identifier. If we search for this in the code base with the ripgrep super-powers you gained earlier, we find the <a href=\"https://github.com/NetBSD/src/blob/caa9bad5633244c08bb86b00eab45f3d92882415/sys/arch/arm/broadcom/bcm2835_com.c#L54\">arch/arm/broadcom/bcm2835_com.c</a> file, which contains:</p><pre><code><code>static const struct device_compatible_entry compat_data[] = {
{ .compat = \"brcm,bcm2835-aux-uart\" },
DEVICE_COMPAT_EOL
};</code></code></pre><p>Once again: we found the glue that connects a generic <code>com</code> driver to a specific hardware device.</p><h1><strong>Loading DTBs at boot time</strong></h1><p>Let’s dig a bit further though. I mentioned earlier that the boot loader is responsible for loading the Device Tree into memory and passing it to the kernel. How is that done? Well, it really depends on the specific machine you are dealing with. In here, I’m just going to <em>very briefly</em> touch upon how the Raspberry Pi does it because that’s the specific non-PC hardware I have access to. And for this, I’ll take you through the investigative journey I took.</p><p>The specific problem I faced was that NetBSD was <em>not</em> able to discover the SPI bus even when I had enabled the right SPI driver in the kernel for my Raspberry Pi 3B. By that point, I was aware that DTBs existed and I suspected that something might be wrong with them, so my first instinct was to check and see what the DTB had to say about the SPI.</p><p>Digging through the FAT partition of the disk image I was using, I found the <code>dtb/broadcom/bcm2837-rpi-3-b.dtb</code> file—the DTB for my specific board. The way the Raspberry Pi boot loader finds this file is by looking for a file matching the board’s own name (<code>bcm2837-rpi-3-b.dtb</code>) in the location specified by the <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html#os_prefix\">os_prefix configuration property</a> in the <code>config.txt</code> placed at the root of the FAT partition.</p><p>Once I found that file and after learning about the <code>dtc</code> tool (the Device Tree Compiler) which transforms DTS files into DTBs and vice versa, I could decompile the DTS:</p><pre><code><code>$ dtc -I dtb -O dts bcm2837-rpi-3-b.dtb -o bcm2837-rpi-3-b.dts
... various warnings ...
$ █</code></code></pre><p>Then, peeking into the decompiled DTS file, I found:</p><pre><code><code>spi@7e204000 {
compatible = \"brcm,bcm2835-spi\";
reg = <0x7e204000 0x200>;
interrupts = <0x02 0x16>;
clocks = <0x06 0x14>;
#address-cells = <0x01>;
#size-cells = <0x00>;
status = \"disabled\";
dmas = <0x0b 0x06 0x0b 0x07>;
dma-names = \"tx\\0rx\";
phandle = <0x49>;
};</code></code></pre><p>I verified that the SPI kernel driver recognized the <code>brcm,bcm2835-spi</code> identifier just as we did earlier on for the serial port. And it did match, so I was puzzled for a moment.</p><p>But then I noticed the innocuous <code>status = \"disabled\"</code> line. Aha! The SPI device was disabled by default. I modified that line with <code>status = \"okay\"</code> following what other entries in the DTS did, recompiled the DTS into the DTB:</p><pre><code><code>$ dtc -I dts -O dtb bcm2837-rpi-3-b.dts -o bcm2837-rpi-3-b.dtb
... various warnings ...
$ █</code></code></pre><p>… rebooted the board and… voila!</p><pre><code><code># dmesg | grep spi
[     1.000003] bcmspi0 at simplebus1: SPI
[     1.000003] bcmspi0: interrupting on icu irq 54
[     1.000003] spi0 at bcmspi0: SPI bus
# █</code></code></pre><p>The kernel successfully attached the SPI driver and the SPI bus started working, which in turn led to a multi-hour debugging session to make the EndBASIC ST7735S driver work—but in the end it did.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"6c85b644-99b2-41ff-bdfd-3baee6e94460\",\"duration\":null}\"></div><p>Yes, there are nicer ways to do what I did here because the DTBs are provided by upstream and you should not be modifying them. What you should do instead is create a DTB overlay, which is a separate small DTB that “patches” the upstream DTB, and then tell the boot loader to process it via the <code>dtoverlay</code> stanza in the <code>config.txt</code> file. Details left to you, reader. Just beware that the Raspberry Pi boot loader is picky about file paths and <a href=\"https://www.raspberrypi.com/documentation/computers/config_txt.html\">the documentation is your friend</a> here.</p><h1><strong>How do ACPI and Device Tree differ?</strong></h1><p>Based on everything I told you about here, ACPI and Device Tree look oddly similar—and that’s because they are! From the perspective of <em>describing</em> hardware to the kernel, the two technologies are equivalent, but they differ for historical reasons. ACPI has its roots in APM, a PC technology, whereas Device Tree is based on <a href=\"https://en.wikipedia.org/wiki/Open_Firmware\">OpenFirmware</a>, a technology that originated at Sun Microsystems for its SPARC machines and that was later used by Apple on their PowerPC-based Macs.</p><p>One difference between the two, though, is that ACPI does more than just describe hardware. ACPI provides a bunch of hardware-specific routines in a bytecode that the operating system can call into to manipulate the hardware. This is often maligned because ACPI introduces non-free and opaque blobs in the interaction between the operating system kernel and the hardware, but <a href=\"https://mjg59.dreamwidth.org/68350.html\">Matthew Garret has a great essay on why ACPI is necessary</a> and why it is better than all other alternatives, possibly including Device Tree.</p><p>In any case, that’s all for today. I found this exercise of dealing with the Device Tree pretty fun and I thought I could share something interesting with you all. I intentionally omitted many details because the topic of hardware configuration is vast and tricky, but you can continue building your knowledge from the bits above and from the fabulous <a href=\"https://wiki.osdev.org/\">OSDev wiki</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">And as always, if any of this was interesting, subscribe to Blog System/5 now. You’ll receive more content like this and you’ll support my future writing!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8be96ecf-b34a-4bb2-9fc7-c3958957c7b3_663x448.jpeg" "0.0" "image/jpeg") nil "479a1b9a5c7ab590001ac38b1d2a02b5") (19 (26569 31003 324226 78000) "https://blogsystem5.substack.com/p/ioctls-rust" "ioctls from Rust" "Julio Merino" "Thu, 13 Feb 2025 17:01:31 +0000" "<p>In Unix-like systems, “everything is a file and a file is defined as a byte stream you can <code>open</code>, <code>read</code> from, <code>write</code> to, and ultimately <code>close</code>”… right? <em>Right?</em> Well, not quite. It’s better to say <em>file descriptors</em> provide access to almost every system that the kernel provides, but not that they can all be manipulated with the same quartet of system calls, nor that they all behave as byte streams.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":440615,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Because you see: network connections are manipulated via file descriptors indeed, but you don’t <code>open</code> them: you <code>bind</code>, <code>listen</code>/<code>accept</code> and/or <code>connect</code> to them. And then you don’t <code>read</code> from and <code>write</code> to network connections: you somehow <code>send</code> to and <code>recv</code> from them. Device drivers are similar: yes, hardware devices are represented as “virtual files” in the <code>/dev</code> hierarchy and many support <code>read</code> and <code>write</code>… but these two system calls are not sufficient to access the breath of functionality that the hardware drivers provide. No, you need <code>ioctl</code>.</p><p><code>ioctl</code> is the poster child of the system call that breaks Unix’s “everything is a file” paradigm. <code>ioctl</code> is the API that allows out-of-band communication with the kernel side of an open file descriptor. To see cool examples, <a href=\"https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11\">refer back to my previous article</a> where I demonstrated how to drive graphics from the console without X11: in that post, we had to <code>open</code> the console device, but then we had to use <code>ioctl</code> to obtain the properties of the framebuffer, and then we had to <code>mmap</code> the device’s content for direct access: no <code>read</code>s nor <code>write</code>s involved.</p><p>All the code I showed you in that earlier post was written in C to keep the graphics article to-the-point, but the code I’m really working on is part of EndBASIC, and thus it is all Rust. And the thing is, <code>ioctl</code>s are not easy to issue from Rust. In fact, after 7 years of Rust-ing, it’s the first time I’ve had to reach for <code>unsafe</code> code blocks, and there was no good documentation on how to deal with <code>ioctl</code>. So this posts aims to fix that by presenting what ways there are to call <code>ioctl</code>s from Rust… and, of course, diving a bit deeper into what <code>ioctl</code>s actually <em>are</em>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Our target</strong></h1><p>For all examples below, I’ll be using a relatively simple <code>ioctl</code> from NetBSD’s <a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> driver. This API is available via the console device file, typically <code>/dev/ttyE0</code>, and is named <code>WSDISPLAYIO_GINFO</code>. Here is what the manual page has to say:</p><pre><code><code>The following ioctl(2) calls are provided by the wsdisplay driver or by
devices which use it.  Their definitions are found in
<dev/wscons/wsconsio.h>.
...
WSDISPLAYIO_GINFO (struct wsdisplay_fbinfo)
Retrieve basic information about a framebuffer display.
The returned structure is as follows:

struct wsdisplay_fbinfo {
u_int   height;
u_int   width;
u_int   depth;
u_int   cmsize;
};

The height and width members are counted in pixels.  The
depth member indicates the number of bits per pixel, and
cmsize indicates the number of color map entries accessible
through WSDISPLAYIO_GETCMAP and WSDISPLAYIO_PUTCMAP.  This
call is likely to be unavailable on text-only displays.</code></code></pre><p>Calling this API from a C program would be trivial and look like this:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <ioctl.h>
// ... open `/dev/ttyE0` as fd ...
struct wsdisplay_fbinfo fbi;
if (ioctl(fd, WSDISPLAYIO_GINFO, &fbi) == -1) {
// Handle error.
}
// fbi now contains the data returned by the kernel.</code></code></pre><p>The reason I’m picking <code>WSDISPLAYIO_GINFO</code> specifically to talk about <code>ioctl</code>s in this article is three-fold:</p><ul><li><p>it returns a small structure with <a href=\"https://blogsystem5.substack.com/p/x86-64-programming-models\">platform-dependent integers</a>, so the sample code in the article will be relatively short;</p></li><li><p>it relies on platform-specific integer types, so we’ll have to account for that in Rust; and</p></li><li><p>it is “rare enough” (we are talking about NetBSD after all) that it is not going to be supported by any of the common Rust crates like libc or nix, so we’ll have to do extra work to call it.</p></li></ul><h1><strong>What is an ioctl anyway?</strong></h1><p>The manual page helpfully provides us a copy of the data structure returned by the <code>ioctl</code>, and the BSD manual pages are typically <em>awesome</em>, but it’s worth double-checking that the code snippet actually matches the code it documents. Peeking into <code>/usr/include/dev/wscons/wsconsio.h</code> as the manual page directs us, we find:</p><pre><code><code>/* Basic display information.  Not applicable to all display types. */
struct wsdisplay_fbinfo {
u_int   height;             /* height in pixels */
u_int   width;              /* width in pixels */
u_int   depth;              /* bits per pixel */
u_int   cmsize;             /* color map size (entries) */
};
#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>OK, great, the <code>wsdisplay_fbinfo</code> structure perfectly aligns with the manual page contents. But what’s more interesting is the <code>#define</code>, which says that <code>WSDISPLAYIO_GINFO</code> is:</p><ul><li><p>an ioctl that <em>reads</em> from the kernel (<code>_IOR</code>),</p></li><li><p>that invokes function number 65 from the <code>W</code> class (which probably stands for “the <em>W</em>scons device driver”), and</p></li><li><p>that places the returned data into a structure of type <code>wsdisplay_fbinfo</code> (not to be confused with <code>wsdisplayio_fbinfo</code>).</p></li></ul><p>In a way, this is just like any other function or system call, except that it’s not defined as such and is instead funneled through a single API. <code>ioctl</code> is, therefore, “just” a grab bag of arbitrary functionality, and what can be invoked on a given file descriptor depends on what the file descriptor represents.</p><p>The reasons for this design are historical and, of course, there could have been other options.</p><p>For example: you know how regular files have an internal structure, right? The vast majority of file formats out there contain a header, which then specifies various sections within the file, which then contain data. The same could have been done with device drivers: their virtual files could have predefined some internal format such that, e.g. the <code>wsdisplay_fbinfo</code> structure always appeared at offset 0x1000 of the virtual file. <code>read</code> and <code>write</code> would have been sufficient for this design, albeit you’d almost-certainly wanted to combine it with <code>mmap</code> for more efficient access.</p><p>Or another example: device drivers could have used an RPC-like mechanism where each write to the file descriptor is a “message” that requests a specific function, and that the kernel responds to with an answer. <code>read</code> and <code>write</code> would have been sufficient for this design.</p><p>Or yet another example: the requests to the device driver could have been intermixed with the data, such that if the data contained a specific sequence, the kernel would invoke a function instead of processing data. Sounds crazy, right? But that’s what pseudo-terminals do: all those <a href=\"https://en.wikipedia.org/wiki/ANSI_escape_code\">control sequences</a> to change colors and the like are telling the terminal driver to do something special.</p><p>In any case, these are all alternate designs and… I’m sure they all live in some form or another in current systems. There is no consistency in how <code>/dev</code> pseudo-files expose their behavior, and <code>ioctl</code>s are just one of the options we have to deal with. So without further ado, let’s look at three different ways of calling these services from Rust.</p><h1><strong>Option 1: nix</strong></h1><p>The first option to call an <code>ioctl</code> from Rust is to leverage the neat <a href=\"https://docs.rs/nix/\">nix crate</a>, which provides idiomatic access to Unix primitives. This crate is not to be confused with NixOS, with which it has no relation.</p><p>To use nix to invoke <code>ioctl</code>s, we need to do two things.</p><p>First, we need to define the data structure used by the <code>ioctl</code>. In C, we would just <code>#include <dev/wscons/wsconsio.h></code>, but in Rust we don’t have access to the C-style headers. Instead, we have to do extra work to define the same memory layout of the C <code>wsdisplay_fbinfo</code> structure, but in Rust:</p><pre><code><code>use std::ffi::c_uint;
#[repr(C)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}</code></code></pre><p>It is <em>very important</em> to declare the structure as having a C representation so that its memory layout matches what the C compiler produces for the same structure. The kernel expects C semantics in its system call boundary, and we must adhere to that. Additionally, we must ensure that the types of each field match the C definitions. Rust only has fixed-size integer types like <code>i16</code> and <code>u32</code>, but C provides platform-dependent integer types like <code>int</code> or <code>unsigned long</code> and these are sometimes used in public kernel interfaces (a mistake, if you ask me). Fear not, though: the <code>std::ffi</code> module provides aliases for those C types.</p><p>And second, we have to do something unique to the nix crate: we have to define a wrapper function for the <code>ioctl</code> so that we can invoke the <code>ioctl</code> as if it were any other function. nix makes this very easy by providing macros that mimic the syntax of the C <code>#define</code> we saw earlier on:</p><pre><code><code>use nix::ioctl_read;
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);</code></code></pre><p>And with that, we are ready to put everything together in a fully-fledged program:</p><pre><code><code>use std::ffi::c_uint;
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
use nix::fcntl;
use nix::ioctl_read;
use nix::sys::stat;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
ioctl_read!(wsdisplayio_ginfo, b'W', 65, WsDisplayFbInfo);
fn main() -> io::Result<()> {
let mut oflag = fcntl::OFlag::empty();
oflag.insert(fcntl::OFlag::O_RDWR);
oflag.insert(fcntl::OFlag::O_NONBLOCK);
oflag.insert(fcntl::OFlag::O_EXCL);
let fd = {
let raw =
fcntl::open(\"/dev/ttyE0\", oflag, stat::Mode::empty())?;
unsafe { OwnedFd::from_raw_fd(raw) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
wsdisplayio_ginfo(fd.as_raw_fd(), &mut fbi).unwrap();
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>There is one surprising detail in this code though: if we went through the hassle of defining a wrapper function for <code>WSDISPLAYIO_GINFO</code> via the idiomatic nix crate, and idiomatic nix usage doesn’t require <code>unsafe</code> blocks… why did we have to wrap the call to <code>wsdisplayio_ginfo</code> in an <code>unsafe</code> block? The reason may be that <code>ioctl</code> can do <em>whatever</em> to the running process and Rust needs to be over-conservative.</p><p>In any case, the above is clean and it works. But… using nix comes with a cost:</p><pre><code><code>$ cargo build
Compiling libc v0.2.169
Compiling cfg_aliases v0.2.1
Compiling bitflags v2.8.0
Compiling cfg-if v1.0.0
Compiling nix v0.29.0
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/os/homepage/static/src/ioctls-rust/nix)
Finished `dev` profile [unoptimized + debuginfo] target(s) in 1.71s
$ █</code></code></pre><p>We have pulled 5 crates into the project just to open a file and invoke an <code>ioctl</code>. Not a huge deal in this day and age but… this contributes to the perception that the Rust ecosystem is a mess of bloated dependencies. Can we do differently?</p><h1><strong>Option 2: libc</strong></h1><p>What if we bypassed nix altogether and invoked libc directly? After all, we can see that nix <em>depends on</em> libc anyway, so we might as well use it at the expense of losing nix’s idiomatic representation of Unix’s interfaces.</p><p>Sure, we can do that: we can invoke the <code>libc::ioctl</code> function directly, which has this prototype:</p><pre><code><code>pub fn ioctl(fd: c_int, request: Ioctl, ...) -> c_int;</code></code></pre><p>Alright then: we need a file descriptor as the first argument, which we have. And then we need an <code>Ioctl</code> as the second argument, which we… wait, what is this <code>Ioctl</code> type? If we look for its definition in the libc source code, we find that <code>Ioctl</code> is an alias for an integer type (<code>unsigned long</code> or <code>int</code> depending on the platform), and this matches the C definition of <code>ioctl</code>. OK, nothing special.</p><p>But then… what do we pass in this second argument? If we were writing C, we would use the <code>WSDISPLAY_GINFO</code> constant, but we don’t have that in Rust because we don’t get access to the C header files. So what <em>is</em> <code>WSDISPLAY_GINFO</code>? Remember that we previously saw that it is defined as such:</p><pre><code><code>#define WSDISPLAYIO_GINFO _IOR('W', 65, struct wsdisplay_fbinfo)</code></code></pre><p>… which doesn’t help us much at this point. But we can chase the definition of <code>_IOR</code>, end up in <code>/usr/include/sys/ioccom.h</code>, and see:</p><pre><code><code>#define _IOC(inout, group, num, len) \\
((inout) | (((len) & IOCPARM_MASK) << IOCPARM_SHIFT) | \\
((group) << IOCGROUP_SHIFT) | (num))
#define _IOR(g,n,t)     _IOC(IOC_OUT,   (g), (n), sizeof(t))</code></code></pre><p>Ugh. We are combining the various arguments to <code>_IOR</code> into a number. This is hard to decipher by just reading the code, so we can ask the compiler to tell us the actual value of the constant instead:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <stdio.h>
int main(void) {
printf(\"%x\\n\", WSDISPLAYIO_GINFO);
}</code></code></pre><p>And if we run the program, we get that <code>WSDISPLAYIO_GINFO</code> is <code>0x40105741</code>. Knowing that, it’s <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">an SMOP</a> to call the <code>ioctl</code> using the <a href=\"https://docs.rs/libc/\">libc crate</a> alone:</p><pre><code><code>use std::ffi::{c_char, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
const WSDISPLAYIO_GINFO: u64 = 0x40105741;
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct WsDisplayFbInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
cmsize: c_uint,
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut fbi: WsDisplayFbInfo;
unsafe {
fbi = mem::zeroed();
let result = libc::ioctl(
fd.as_raw_fd(),
WSDISPLAYIO_GINFO,
&mut fbi as *mut WsDisplayFbInfo,
);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"fbinfo: {:?}\", fbi);
Ok(())
}</code></code></pre><p>As you can see from this code snippet, we <em>also</em> have to define the <code>WsdisplayFbInfo</code> structure to match the kernel’s, so avoiding nix didn’t really make things simpler for us—and in fact, it made them uglier because now we have to deal with libc’s oddities like raw C strings, global <code>errno</code> values, and an opaque constant for the <code>ioctl</code> number. Not great.</p><h1><strong>Option 3: FFI</strong></h1><p>Which makes one wonder… can we avoid replicating the C interfaces in Rust and instead leverage the system-provided header files? Yes we can. Instead of trying to invoke the <code>ioctl</code>s from Rust, we can invoke them via some custom C glue code. Rust is going to call into the system-provided libc <em>anyway</em> when we invoke a system call, so we might as well switch to C a bit “earlier”.</p><p>The idea in this case, as in any other computing problem, is to add a layer of abstraction: instead of dealing with the kernel-defined data structures from Rust, we define <em>our own</em> structures and APIs to detach the Rust world from the C world. Here, look:</p><pre><code><code>#include <dev/wscons/wsconsio.h>
#include <sys/ioctl.h>
struct my_ginfo {
unsigned int height;
unsigned int width;
unsigned int depth;
};
int get_ginfo(int fd, struct my_ginfo* gi) {
struct wsdisplay_fbinfo fbi;
int result = ioctl(fd, WSDISPLAYIO_GINFO, &fbi);
if (result == -1) {
return result;
}
gi->height = fbi.height;
gi->width = fbi.width;
gi->depth = fbi.depth;
return 0;
}</code></code></pre><p>We start by declaring our own version of <code>wsdisplay_ginfo</code>, which I’ve called <code>my_ginfo</code>, that only includes the few fields we want to propagate to Rust. Yes, in this example the indirection is utterly pointless because we go from 4 to 3 fields so we haven’t made our lives easier, but there are <code>ioctl</code>s that return larger structures from which we might only need a few values. Then we define a trivial function to wrap the <code>ioctl</code> and transform its return value into our own structure.</p><p>Then, we go to Rust, re-define our <code>my_ginfo</code> structure as <code>MyGinfo</code> (both of which we fully control so we can easily verify that they match) and we call the wrapping function:</p><pre><code><code>use std::ffi::{c_char, c_int, c_uint};
use std::io;
use std::mem;
use std::os::fd::{AsRawFd, FromRawFd, OwnedFd};
#[repr(C)]
#[derive(Debug)]
#[allow(unused)]
struct MyGInfo {
height: c_uint,
width: c_uint,
depth: c_uint,
}
extern \"C\" {
fn get_ginfo(fd: c_int, gi: *mut MyGInfo) -> c_int;
}
fn main() -> io::Result<()> {
let fd = {
let result = unsafe {
libc::open(
\"/dev/ttyE0\\0\".as_ptr() as *const c_char,
libc::O_RDWR | libc::O_NONBLOCK | libc::O_EXCL,
0,
)
};
if result == -1 {
return Err(io::Error::last_os_error());
}
unsafe { OwnedFd::from_raw_fd(result) }
};
let mut gi: MyGInfo;
unsafe {
gi = mem::zeroed();
let result = get_ginfo(fd.as_raw_fd(), &mut gi as *mut MyGInfo);
if result == -1 {
return Err(io::Error::last_os_error());
}
}
eprintln!(\"my_ginfo: {:?}\", gi);
Ok(())
}</code></code></pre><p>The trick now is to link the C code with the Rust code together, and for that, we create a <code>build.rs</code> script. In here, we leverage the <a href=\"https://docs.rs/cc/\">cc crate</a> to put things together, which is an extra dependency that is only used at build time:</p><pre><code><code>fn main() {
println!(\"cargo::rerun-if-changed=src/ffi.c\");
cc::Build::new().file(\"src/ffi.c\").compile(\"ffi\");
}</code></code></pre><p>And with that, we are done.</p><h1><strong>Which option wins?</strong></h1><p>Well, let’s see:</p><pre><code><code>$ cargo build --release
...
Compiling ioctls-rust-ffi v0.1.0 (/home/jmmv/ioctls-rust/ffi)
Compiling ioctls-rust-libc v0.1.0 (/home/jmmv/ioctls-rust/libc)
Compiling ioctls-rust-nix v0.1.0 (/home/jmmv/ioctls-rust/nix)
Finished `release` profile [optimized] target(s) in 1.89s
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 455K Feb 12 08:04 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 464K Feb 12 08:04 target/release/ioctls-rust-nix
$ strip -s target/release/ioctls-rust-*
$ ls -lh target/release/ioctls-rust-* | grep -v \\\\.d
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-ffi
-rwxr-xr-x 2 jmmv jmmv 353K Feb 12 08:05 target/release/ioctls-rust-libc
-rwxr-xr-x 2 jmmv jmmv 358K Feb 12 08:05 target/release/ioctls-rust-nix
$ █</code></code></pre><p>From a binary size perspective, there are no meaningful differences. As expected, the usage of the nix crate results in slightly more code than the other alternatives because nix has to do extra work to translate global <code>errno</code> values into Rust <code>Result</code> types and the like. But the libc and FFI alternatives seem identical.</p><p>At runtime, however, we should expect the FFI option to perform a teeny tiny bit worse (though good luck measuring that) than the libc option because we have to convert between the kernel structure and our own structure in the happy path… all for dubious benefit.</p><p>All in all, I’ll take option 1. I do not like the fact of having to manually replicate the kernel structures in my own code so, if I had the time, I’d try to upstream the definitions to the well-tested libc crate or write another reusable crate with just those. But, barring that, the idiomatic nix interfaces make calling Unix primitives a breeze.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54f032d8-46c5-4b5f-aaed-901e39d7abf6_2048x2048.jpeg" "0.0" "image/jpeg") nil "459e9f10380dea1333de20c02c25a922") (18 (26569 31003 275720 822000) "https://blogsystem5.substack.com/p/netbsd-graphics-wo-x11" "Hands-on graphics without X11" "Julio Merino" "Fri, 17 Jan 2025 17:45:51 +0000" "<p>Look at these two consoles:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\" width=\"1200\" height=\"508.65671641791045\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f756707-3087-454a-8737-62a4768f7d30_1340x568.png\",\"srcNoWatermark\":null,\"fullscreen\":false,\"imageSize\":\"large\",\"height\":568,\"width\":1340,\"resizeWidth\":1200,\"bytes\":25232,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-large\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f756707-3087-454a-8737-62a4768f7d30_1340x568.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Side-by-side comparison of the NetBSD console right after boot vs. the EndBASIC console.</figcaption></figure></div><p>Same colors, (almost) same font, same… everything? Other than for the actual text they display, they look identical, don’t they? But the one on the right can do things that the one on the left cannot. Witness this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1de4af8-dba8-4d87-913c-c5b14e11ea92\",\"duration\":null}\"></div><p>A square? OK, meh, we had those in the DOS days with <a href=\"https://en.wikipedia.org/wiki/Box-drawing_characters\">box-drawing characters</a>. But a circle?! That’s only possible because the console on the right is a hybrid console that supports mixing the usual textual grid of a terminal with overlapping graphics.</p><p>Now, if you have been following the development of <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, this is not surprising. The defining characteristic of the EndBASIC console is that it’s hybrid as the video shows. What’s newsworthy, however, is that the EndBASIC console can now run directly on a framebuffer exposed by the kernel. No X11 nor Wayland in the picture (pun intended).</p><p>But how? The answer lies in NetBSD’s flexible wscons framework, and this article dives into what it takes to render graphics on a standard Unix system. I’ve found this exercise exciting because, in the old days, graphics were trivial (<a href=\"https://en.wikipedia.org/wiki/Mode_13h\">mode 13h</a>, anyone?) and, for many years now, computers use framebuffer-backed textual consoles. The kernel is obviously rendering “graphics” by drawing individual letters; so why can’t you, a user of the system, do so too?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Your subscription to Blog System/5 fuels me to write comprehensive articles like this, and this one was particularly painful to put together. Click the button for more goodies. It’s free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>wscons overview</strong></h1><p><a href=\"https://man.netbsd.org/wscons.4\">wscons(4)</a>, or Workstation Console in its full form, is NetBSD’s framework to access the physical console attached to a computer.</p><p>wscons abstracts the details of the hardware display and input devices so that the kernel and the user-space configuration tools can treat them all uniformly across the tens of platforms that NetBSD supports. If you use <a href=\"https://man.netbsd.org/wsconsctl.8\">wsconsctl(8)</a> on a modern amd64 laptop to control its display, you use wsconsctl on an ancient vax box to control its display too.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\" width=\"1456\" height=\"1001\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1001,\"width\":1456,\"resizeWidth\":null,\"bytes\":436643,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd299c81e-fc5b-4d9e-b25d-469e9ac1dd7f_1920x1320.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Layered architecture of wsdisplay and its backing devices.</figcaption></figure></div><p>The output architecture of wscons is composed of multiple devices, layered like this:</p><ol><li><p><a href=\"https://man.netbsd.org/wsdisplay.4\">wsdisplay(4)</a> sits at the top of the stack and implements the console in hardware-independent terms. The functionality at this level includes handling of VT100-like sequences, cursor positioning logic, text wrapping, scrolling decisions, etc.</p></li><li><p>Under wsdisplay sit the drivers that know how to access specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/vga.4\">vga(4)</a>, which does not do graphics at all; <a href=\"https://man.netbsd.org/genfb.4\">genfb(4)</a>, which is a generic framebuffer driver that talks to the “native” framebuffer of the system (e.g. the one configured by the EFI); and <a href=\"https://man.netbsd.org/radeonfb.4\">radeonfb(4)</a>, which implements an accelerated console on AMD cards. These drivers know how to initialize and interact with the hardware.</p></li><li><p>Under the graphical drivers sits <a href=\"https://man.netbsd.org/vcons.4\">vcons(4)</a>, the driver that implements one or more graphical consoles in terms of a grid of pixels. vcons is parameterized on “raster operations” (rasops), a set of virtual methods to perform low-level operations. An example is the <code>moverows</code> method, which is used by wsdisplay to implement scrolling in the most efficient way provided by the hardware. vcons provides default (inefficient) implementations of these methods, but the upper drivers like radeonfb can provide hardware-accelerated specializations when instantiating vcons. vcons also interacts with <a href=\"https://man.netbsd.org/wsfont.4\">wsfont(4)</a> to render text to the console.</p></li></ol><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png\" width=\"1456\" height=\"637\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8368000-8d05-4451-beec-27f355c41828_1920x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":637,\"width\":1456,\"resizeWidth\":null,\"bytes\":76696,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8368000-8d05-4451-beec-27f355c41828_1920x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Layered architecture of wskbd and its backing devices, including the optional wsmux wrapper.</figcaption></figure></div><p>The input architecture of wscons is similar in terms of layering of devices, albeit somewhat simpler:</p><ol><li><p><a href=\"https://man.netbsd.org/wsmux.4\">wsmux(4)</a> is an optional component that multiplexes multiple input devices under a single virtual device for event extraction.</p></li><li><p><a href=\"https://man.netbsd.org/wsbkd.4\">wskbd(4)</a> sits at the top of the stack (not accounting for wsmux) and implements generic keyboard handling. The functionality at this level includes translating keycodes to layouts, handling key input repetition, and more. wskbd exposes a stream of wsevents to user-space so that user-space can process state changes (e.g. key presses).</p></li><li><p>Under wskbd sit the device drivers that know how to deal with specific hardware devices. These include, among others: <a href=\"https://man.netbsd.org/ukbd.4\">ukbd(4)</a> for USB keyboard input and <a href=\"https://man.netbsd.org/pckbd.4\">pckbd(4)</a> for PC/AT keyboard input. These drivers wait for hardware input, generate events, and provide a map of keycodes to key symbols to the upper layer so that wskbd can operate in generic terms.</p></li></ol><p>The input architecture can handle other types of devices like mice and touch panels (both via <a href=\"https://man.netbsd.org/wsmouse.4\">wsmouse(4)</a>), but I’m not going to cover those here. Just know that they sit under wsmux at the equivalent level of wskbd and produce a set of wsevents in the exact same manner as wskbd.</p><h1><strong>Querying framebuffer properties</strong></h1><p>As you can sense from the overview, the whole architecture under wsdisplay is geared towards video devices… if it wasn’t for the vga driver: in the common case, wsdisplay is backed by a graphical framebuffer managed by vcons for text rendering, yet the user only sees a textual console. But if the kernel has direct access to the framebuffer, so should user-space too.</p><p>The details on how to do this click if you read through the operations described in the wsdisplay manual page. In particular, you may notice the <code>WSDISPLAYIO_GET_FBINFO</code> call which retrieves extended information about, you guessed it, a framebuffer display.</p><p>Let’s try it: I wrote a trivial program to open the display device (named <code>/dev/ttyE0</code> for reasons that escape me), call this function, and store the results in an <code>fbinfo</code> structure:</p><pre><code>// wsdisplay-fbinfo.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-fbinfo.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
close(fd);
exit(EXIT_SUCCESS);
}</code></pre><p>Hmm, but this program does not have any visible output, right? The code just queries the framebuffer information and does nothing with it. The reason is that the content of the <code>wsdisplayio_fbinfo</code> structure is large and I didn’t want to pretty-print it myself. I thought it’d be fun to show you how to use GDB to inspect large data structures and how to script the process. Here, look:</p><pre><code>gdb -q \\
-ex 'set print pretty on' \\
-ex 'break exit' \\
-ex 'run' \\
-ex 'frame 1' \\
-ex 'print fbinfo' \\
-ex 'cont' \\
-ex 'quit' \\
./wsdisplay-fbinfo</code></pre><p>This call to GDB starts the sample program shown above and automates various GDB commands to set a breakpoint, step through the program, and pretty-print the <code>fbinfo</code> structure right before exiting. When we execute this command as root (which is important to get access to the <code>/dev/ttyE0</code> device), we get this:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\" width=\"1013\" height=\"872\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":872,\"width\":1013,\"resizeWidth\":null,\"bytes\":96166,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f0fed0f-d812-40d7-bf1a-5ad061a15d38_1013x872.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Content of the fbinfo structure as grabbed by the sample wsdisplay-fbinfo program and printed by GDB.</figcaption></figure></div><p>Neat. We get sensible stuff from the kernel! <code>fbi_width</code> is 640 and <code>fbi_height</code> is 480, which matches the 640x480 resolution I have configured in my test VM.</p><h1><strong>Drawing to the framebuffer</strong></h1><p>But note these other fields in the structure printed above:</p><pre><code>struct wsdisplayio_fbinfo {
uint64_t fbi_fbsize;
uint64_t fbi_fboffset;
// ... more fields ...
}</code></pre><p>The <code>fbi_fbsize</code> and <code>fbi_fboffset</code> fields are <em>begging</em> us to use <code>mmap</code> to memory-map the area of the device starting at <code>fbi_fboffset</code> and spanning <code>fbi_fbsize</code> bytes. Presumably we can write to the framebuffer if we do this, but beforehand, we have to switch the console to “framebuffer mode” by using the <code>WSDISPLAYIO_SMODE</code> (“set mode”) call. This call accepts an integer to indicate which mode to set:</p><ul><li><p><code>WSDISPLAYIO_MODE_EMUL</code>: Set the display to emulating (text) mode. This is the default operation mode of wsdisplay and configures the console to “emulate” a text terminal.</p></li><li><p><code>WSDISPLAYIO_MODE_MAPPED</code>: Set the display to mapped (graphics) mode. This allows access to the framebuffer and allows the <code>mmap</code> operation to succeed.</p></li><li><p><code>WSDISPLAYIO_MODE_DUMBFB</code>: Set the display to mapped (framebuffer) mode. This is similar to <code>WSDISPLAYIO_MODE_MAPPED</code> and, for our purposes in the demo below, works the same. I haven’t found a concise description of how these two differ, but from my reading of the code, the “mapped” mode offers access to the framebuffer as well as device-specific control registers, whereas “dumb framebuffer” just exposes the framebuffer memory.</p></li></ul><p>In any case. Once we know that we have to switch the console device to a graphical mode before mapping the framebuffer, and having access to the pixel format described in the <code>fbinfo</code> structure… drawing something fun is just a few byte manipulation operations away:</p><pre><code>// wsdisplay-draw.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wsdisplay-draw.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
// Open the main wsdisplay device.
int fd = open(\"/dev/ttyE0\", O_RDWR | O_NONBLOCK | O_EXCL);
if (fd == -1)
err(1, \"open failed\");
// Query information about the framebuffer.
struct wsdisplayio_fbinfo fbinfo;
if (ioctl(fd, WSDISPLAYIO_GET_FBINFO, &fbinfo) == -1)
err(1, \"ioctl failed\");
// Ensure the framebuffer aligns with the expectations of our demo
// code below.
if (fbinfo.fbi_bitsperpixel != 32)
errx(1, \"bitsperpixel not supported by this demo\");
if (fbinfo.fbi_pixeltype != WSFB_RGB)
errx(1, \"pixeltype not supported by this demo\");
// Configure the wsdisplay to enter \"dumb framebuffer\" mode.
unsigned int mode = WSDISPLAYIO_MODE_DUMBFB;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1)
err(1, \"ioctl failed\");
// Map the framebuffer memory.  Must come after the SMODE ioctl.
uint32_t *ptr = (uint32_t*)mmap(
0, fbinfo.fbi_fbsize, PROT_READ | PROT_WRITE, MAP_SHARED,
fd, fbinfo.fbi_fboffset);
if (ptr == MAP_FAILED)
err(1, \"mmap failed\");
// Fill the screen multiple times with pixels of different
// colors to render a simple animation.
size_t pixels = fbinfo.fbi_fbsize / sizeof(uint32_t);
int off = 0;
for (int i = 0; i < 100; i++) {
int r = off; int g = off; int b = off;
for (size_t i = 0; i < pixels; i++) {
r = (r + 1) % 255; g = (g + 2) % 255; b = (b + 3) % 255;
ptr[i] = 0
| (r << fbinfo.fbi_subtype.fbi_rgbmasks.red_offset)
| (g << fbinfo.fbi_subtype.fbi_rgbmasks.green_offset)
| (b << fbinfo.fbi_subtype.fbi_rgbmasks.blue_offset);
}
off += 10;
usleep(1);
}
// Configure the wsdisplay to enter \"console emulation\" mode.
// In other words: return to the console.
mode = WSDISPLAYIO_MODE_EMUL;
if (ioctl(fd, WSDISPLAYIO_SMODE, &mode) == -1) {
err(1, \"ioctl failed\");
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run this:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"26c68357-8900-4c06-a98e-3456d2792a08\",\"duration\":null}\"></div><p>Voila. We’ve got graphics without paying the X11 startup tax. Switching from the console to graphics is instantaneous, like in the good old mode 13h days.</p><h1><strong>Handling keyboard input</strong></h1><p>Rendering graphics is just half of the puzzle when writing an interactive application though. The other half is handling input. And, for that, we have to turn to the wskbd device.</p><p>After we switch the console to mapped mode, keystrokes don’t go to <code>stdin</code> anymore. We have to write code to explicitly read from an attached keyboard, and we can do this via the <code>/dev/wskbd0</code> device representing the first attached keyboard.</p><p>Once we open the keyboard device for reading, wscons sends us its own representation of events known as wsevents. We can write a trivial program to read one key press:</p><pre><code>// wskbd-trivial.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-trivial.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Wait for one key down press only.
for (;;) {
struct wscons_event ev;
int ret = read(fd, &ev, sizeof(ev));
if (ret == -1)
err(1, \"read failed\");
if (ev.type == WSCONS_EVENT_KEY_DOWN) {
printf(\"value: %d, char '%c'\\n\", ev.value, (char)ev.value);
break;
}
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>But… if we try to run it and press a key, say <code>k</code>, we might get:</p><pre><code># ./wskbd-trivial
value: 37, char '%'
# █</code></pre><p>Huh. We pressed <code>k</code> but the character we got is <code>%</code>. Not what we expected! Well, as it turns out, the “value” that wsevents report for key presses (37 in this case) is the raw keycode of the key. This is hardware-specific and needs to be translated to an actual symbol via a keymap.</p><p>One feature of wskbd is that it exposes the keymap as configured in the kernel so there is a single source of truth for the machine. We can query a portion of it with another program:</p><pre><code>// wskbd-map.c
// https://jmmv.dev/src/netbsd-graphics-wo-x11/wskbd-map.c
#include <sys/param.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <dev/wscons/wsconsio.h>
#include <dev/wscons/wsksymdef.h>
#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
int main(int argc, char** argv) {
// Open the main wskbd device.
int fd = open(\"/dev/wskbd0\", O_RDONLY);
if (fd == -1)
err(1, \"open failed\");
// Allocate space for the biggest possible keymap.
struct wscons_keymap map[WSKBDIO_MAXMAPLEN];
memset(map, 0, sizeof(struct wscons_keymap) * WSKBDIO_MAXMAPLEN);
// Get the keymap from the device.
struct wskbd_map_data data;
data.maplen = WSKBDIO_MAXMAPLEN;
data.map = map;
if (ioctl(fd, WSKBDIO_GETMAP, &data) == -1)
err(1, \"ioctl failed\");
// Dump keymap entries.
printf(\"Keymap length: %u entries\\n\", data.maplen);
for (size_t i = 0; i < data.maplen; i++) {
// Skip printing entries that are not for letters.
if (map[i].command != KS_voidSymbol)
continue;
char normal = map[i].group1[0];
char shifted = map[i].group1[1];
if (normal < 'a' || normal > 'z')
continue;
printf(\"Keycode %zd: '%c', '%c'\\n\", i, normal, shifted);
}
close(fd);
return EXIT_SUCCESS;
}</code></pre><p>And if we run it, we might get:</p><pre><code># ./wskbd-map
Keymap length: 222 entries
Keycode 16: 'q', 'Q'
Keycode 17: 'w', 'W'
Keycode 18: 'e', 'E'
Keycode 19: 'r', 'R'
Keycode 20: 't', 'T'
Keycode 21: 'y', 'Y'
Keycode 22: 'u', 'U'
Keycode 23: 'i', 'I'
Keycode 24: 'o', 'O'
Keycode 25: 'p', 'P'
Keycode 30: 'a', 'A'
Keycode 31: 's', 'S'
Keycode 32: 'd', 'D'
Keycode 33: 'f', 'F'
Keycode 34: 'g', 'G'
Keycode 35: 'h', 'H'
Keycode 36: 'j', 'J'
Keycode 37: 'k', 'K'
Keycode 38: 'l', 'L'
Keycode 44: 'z', 'Z'
Keycode 45: 'x', 'X'
Keycode 46: 'c', 'C'
Keycode 47: 'v', 'V'
Keycode 48: 'b', 'B'
Keycode 49: 'n', 'N'
Keycode 50: 'm', 'M'
# █</code></pre><p>This dump is telling us how keycodes map to symbols, both in “normal” and in shifted form. If we look up keycode 37, we indeed find the letter <code>k</code>. With this, it’s just an <a href=\"https://en.wikipedia.org/wiki/Small_matter_of_programming\">SMOP</a> to come up with a program that parses the keymap as exposed by wskbd and converts keycodes to something useful.</p><p>This is all good and dandy, but what happens if the keyboard is not connected when you try to open <code>/dev/wskbd0</code>? (Spoiler: the <code>open</code> call fails.) Or what happens if your computer has more than one keyboard attached? (Spoiler: you can only read events from one.) This is where wsmux comes to the rescue—a device driver that multiplexes multiple input devices into one.</p><p>By default, the system reserves <code>/dev/wsmux0</code> as the multiplexer for all attached mice and <code>/dev/wsmux1</code> as the multiplexer for all attached keyboards. We can define our own too via the <a href=\"https://man.netbsd.org/wsmuxctl.8\">wsmuxctl(8)</a> command line utility.</p><p>wsmux then supports “hot plugging”. You can then open a <code>/dev/wsmuxN</code> device even when there is no physical hardware attached, and whenever a peripheral is connected, it automatically becomes part of the mux. So, if we modify the program above to open <code>/dev/wsmux1</code> instead of <code>/dev/wskbd0</code>, the program will be resilient to missing keyboards and it’ll recognize multiple keyboards. Easy peasy!</p><h1><strong>What will you build?</strong></h1><p>You are now equipped with the basics to write graphical applications on a NetBSD system (and maybe OpenBSD too) without running X11. I know NetBSD may not be your jam, but it is a good choice for embedded projects due to its console architecture and other features like <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">its build system</a>.</p><p>If the code above still seems mysterious, you can read the source code for the <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-video-wsfb/\">xf86-video-wsfb</a> and <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/xsrc/external/mit/xf86-input-ws/\">xf86-input-ws</a> drivers for X.org. The code is easy enough to read, although it is longer because it has to support all the bells and whistles of wsdisplay and wskbd. (I took shortcuts above by making various assumptions on pixel formats and the like.)</p><p>And, guess what, I am indeed working on an embedded project! A little dev box that can boot straight into EndBASIC with super-fast boot times and for which I couldn’t afford the X11 startup penalty.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"d3e4a900-0eb8-4548-91af-41244b377297\",\"duration\":null}\"></div><p>Stay tuned. In the meantime, what will <em>YOU</em> build? For those of us in the U.S., there is a 3-day weekend ahead and this can be a good distraction. Have fun!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you enjoyed this walk-through, don’t hesitate to subscribe to Blog System/5. It’s free and you’ll receive more articles like this one.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "1638466a-7d2e-43a6-933d-537e93757760_642x557.png" "0.0" "image/jpeg") nil "5f51d766eba6b92ef05043e5cfd2b287") (17 (26569 31003 273742 267000) "https://blogsystem5.substack.com/p/make-help" "Self-documenting Makefiles" "Julio Merino" "Fri, 10 Jan 2025 17:02:01 +0000" "<p>Make, as arcane as a build tool can be, may still be a good first fit for certain scenarios. “Heresy!”, you say, as you hear a so-called “Bazel expert” utter these words.</p><p>The specific problem I’m facing is that I need to glue together <a href=\"https://jmmv.dev/2024/12/netbsd-build-system.html\">the NetBSD build system</a>, <a href=\"https://jmmv.dev/2013/11/patch-management-with-quilt.html\">a quilt patch set</a>, EndBASIC’s Cargo-based Rust build, and a couple of QEMU invocations to produce a Frankenstein disk image for a Raspberry Pi. And the thing is: Make allows doing this sort of stitching with relative ease. Sure, Make is not the best option because the overall build performance is “meh” and because incremental builds are almost-impossible to get right… but adopting Bazel for this project would be an almost-infinite time sink.</p><p>Anyway. When using Make in this manner, you often end up with what’s essentially a “command dispatcher” and, over time, the number of commands grows and it’s hard to make sense of which one to use for what. Sure, you can write a <code>README.md</code> with instructions, but I guarantee you that the text will get out of sync faster than you can read this article. There is a better way, though.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png\" width=\"1068\" height=\"850\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/99723364-983d-414c-b099-6fe054113db9_1068x850.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":850,\"width\":1068,\"resizeWidth\":null,\"bytes\":110230,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Sample output of the make help command that we will implement in this article.</figcaption></figure></div><p>What if we could provide a <code>make help</code> command that showed an overview of the project’s “build interface”? And what if we could embed such information inside the <code>Makefile</code>s themselves, close to the entities that they document? This idea is neither new nor mine, and it has been written about before by different people. However, I bet that most of you haven’t heard about it before so it’s worth for me to repeat it. And I think that my solution is a bit more comprehensive than others I’ve found. So here you go.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>Targets</strong></h1><p>As I mentioned in the introduction, Make is often used as a command dispatcher: with very little code, you can write what essentially are multiple shell scripts with automatic chaining, all wrapped in one single interface. It’s all pretty terrible, but people are used to this pattern due to Make’s ubiquity and somehow expect it when they face a Make-based project.</p><p>To implement this command dispatcher idea, each user-facing action is exposed via a <em>target</em>. These targets tend to be marked as “phony”—i.e. they are targets that produce no outputs of their own. Take a look at this <code>Makefile</code>:</p><pre><code><code>.PHONY: build
build: target/debug/program
target/debug/program: src/main.rs src/lib.rs
	cargo build

.PHONY: test
test: build
	cargo test</code></code></pre><p>In the snippet above, the <code>target/debug/program</code> target represents a built <em>file</em>. This target depends on a list of sources and specifies what command to run to generate the output when it is missing or out of date (according to file modification times, <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html#file-modification-times\">yikes</a>). When you type <code>make target/debug/program</code>, you expect the file <code>target/debug/program</code> to exist on disk after the command completes.</p><p>But the snippet also shows two phony targets: <code>build</code> and <code>test</code>. When you type <code>make build</code> or <code>make test</code>, you do not expect neither a <code>build</code> nor a <code>test</code> file to be created, no. What you expect is that the project is built and tested. And for this, Make evaluates the dependencies of the phony targets (if any are specified, as is the case for <code>build</code>) and then unconditionally executes any commands in the phony targets (as is the case for <code>test</code>).</p><p>With this in mind, the first thing we want to do in our <code>make help</code> command is to document these “special” targets that represent user-facing actions. To do this, we’ll leverage one not-well-known aspect of Make’s syntax: the list of dependencies of a target is <em>cumulative</em> across multiple target definitions of the same name. Basically, these target definitions are equivalent:</p><pre><code><code># All dependencies in one line.
target/debug/program: src/main.rs src/lib.rs
# Dependencies spread over multiple lines.
target/debug/program: src/main.rs
target/debug/program: src/lib.rs</code></code></pre><p>Knowing this, we can add “extra” lines for a target and use one of those to document the target so that we do not end up with super-long lines. For example, we can do:</p><pre><code><code>target/debug/program: # Builds the program.
target/debug/program: src/main.rs src/lib.rs</code></code></pre><p>And then we are just one <code>grep</code> away from extracting the targets and their documentation:</p><pre><code><code>sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>OK fine. It’s a bit more complicated than just <code>grep</code> because we have to reformat the lines a bit and we need to create a nicely formatted table. Also, I know the <code>sed</code> syntax is awful, but I really don’t want to call into Perl or Python as other guides tell you just for this silly string manipulation. There are native Unix tools that can help us here, and they are much lighter-weight.</p><h1><strong>Variables</strong></h1><p>All other “self-documenting <code>Makefile</code>” tutorials I found out there focus exclusively on documenting targets. But <code>Makefile</code>s often expose another dimension of their API, and this is the collection of user-settable configuration variables that they accept.</p><p>Many <code>Makefile</code>s do things like:</p><pre><code><code>CFLAGS ?= -O2</code></code></pre><p>… to indicate that <code>CFLAGS</code> is set to <code>-O2</code>. But note: the <code>?=</code> operator invites users to override the variable’s value if they choose to. For example, if the user wanted to build the project in debug mode, they could probably do the following and get the code to build without optimizations and with debug symbols:</p><pre><code><code>$ make CFLAGS=\"-O0 -g\" build</code></code></pre><p>Given that these variables are user-facing, we should document them as well as part of the <code>make help</code> output.</p><p>To document variables, we don’t have the luxury of splitting their definition into multiple lines like we did with targets to prevent super-long lines. That said, we can still add comments at the end of the line, like shown below, and those comments won't be part of the variable's default value. It is important, however, to not leave any space between the default value and the comment, or else the spaces become part of the variable's value.</p><pre><code><code>DEVELOPER ?= 0# Set to 1 to enable developer builds.</code></code></pre><p>Like with targets, we are also just one <code>grep</code> away from extracting the variables and their documentation:</p><pre><code><code>sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>Again, more complicated than just a <code>grep</code>, but you get the idea.</p><h1><strong>Putting it all together</strong></h1><p>Alright. So now we know how to extract a table documenting targets and a table documenting variables, but these two lists may still be too obscure on their own. Which targets are important? Which variables might the user want to look into first?</p><p>To address this deficiency, we can preface those tables with some prose that explains, at a very high level, what to do when interacting with the project for the first time. To implement this, we can write the instructions in a separate file (like a <code>README.md</code>) next to the <code>Makefile</code>, and then have our <code>make help</code> command print out the text file’s contents.</p><p>And so without further ado, here is how we can tie everything together:</p><pre><code><code>.PHONY: help
help: # Shows interactive help.
	@cat README.md
	@echo
	@echo \"make variables:\"
	@echo
	@sed -e 's/^\\([^ 	]\\+\\)[ 	]*?=[^#]\\+#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort
	@echo
	@echo \"make targets:\"
	@echo
	@sed -e's/^\\([^: 	]\\+\\):.*#\\(.*\\)$$/\\1 \\2/p;d' Makefile | column -t -l 2 | sort</code></code></pre><p>If you copy/paste this text, beware that there are embedded tabs in it. The ones at the beginning of the line are obvious, but the ones in the <code>[ ]</code> character classes are not. The latter are supposed to be <code>[ <tab>]</code>.</p><p>Now, have fun with this, but please don’t use Make for new projects if you can avoid it!</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F99723364-983d-414c-b099-6fe054113db9_1068x850.png" "0.0" "image/jpeg") nil "32bb6ce420f2c012237a39b7834ef301") (16 (26569 31003 272824 914000) "https://blogsystem5.substack.com/p/netbsd-build-system" "Revisiting the NetBSD build system" "Julio Merino" "Sat, 28 Dec 2024 08:01:16 +0000" "<p>I recently picked up an embedded project in which I needed to build a highly customized full system image with minimal boot times. As I explored my options, I came to the conclusion that NetBSD, the often-forgotten BSD variant, was the best viable choice for my project.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":403124,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>One reason for this choice is NetBSD’s build system. Once you look and get past the fact that it feels frozen in time since 2002, you realize it is still one of the most advanced build systems you can find for an OS. And it shows: the NetBSD build system allows you to build the full OS from scratch, on pretty much any host POSIX platform, while targeting any hardware architecture supported by NetBSD. All without root privileges.</p><p>Another reason for this choice is that NetBSD was my daily workhorse for many years and I’m quite familiar with its internals, which is useful knowledge to quickly achieve the goals I have in mind. In fact, I was a NetBSD Developer with capital D: I had commit access to the project from about 2002 through 2012 or so, and I have just revived my account in service of this project. <code>jmmv@</code> is back!</p><p>So, strap onto your seats and let’s see how today’s NetBSD build system looks like and what makes it special. I’ll add my own critique at the end, because it ain’t perfect, but overall it continues to deliver on its design goals set in the late 1990s.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The basics</strong></h1><p>The NetBSD build system is powerful and featureful, but it’s also arcane as it’s based on a combination of the BSD variant of make and shell scripts. Just peek through the files under <a href=\"https://cvsweb.netbsd.org/bsdweb.cgi/src/share/mk\">src/share/mk/</a>, the directory that contains the bulk of the infrastructure, to see what I mean.</p><p>As a user of the build system, however, you rarely interact with make directly. Instead, you use the <code>build.sh</code> script located at the top of the source tree. This script provides a user-friendly interface to most operations you may want to do, and abstracts away the intricacies of the targets that coordinate the build of the system and the configuration that controls it.</p><p>The structure of the command is to pass high-level “goals” to <code>build.sh</code> as arguments, which indicate the operations to perform. In its most simple form, all you need to do to build a full system distribution targeting the architecture of the host is:</p><pre><code><code>./build.sh tools release</code></code></pre><p>But hey, I promised you can trivially cross-build too, right? Sure, let’s compile the system for a Raspberry Pi with a 64-bit chip, produce the USB image that we can write to an SD card, and do everything as an unprivileged user:</p><pre><code><code>./build.sh -U -a aarch64 -m evbarm tools release disk-image</code></code></pre><p>That’s it, really. That’s all it takes.</p><p>We must dig deeper though, so let’s look at some of those “goals” to see what <code>tools</code> means and understand how a release is put together without root privileges.</p><h1><strong>The toolchain</strong></h1><p>The very first step of any <code>build.sh</code> invocation is to generate the toolchain used to build the rest of the system. This is true of any build, including those that target the host machine, because this ensures that the build is independent of the host’s state. In particular, this avoids the situation where you might have to upgrade certain components before building, which was/is common in other BSDs.</p><p>And you have seen this prerequisite step in the previous section, by the way: all sample <code>build.sh</code> invocations I showed you included <code>tools</code> as the first goal. Now, you don’t <em>have</em> to provide <code>tools</code> to <em>every</em> invocation of the script: as soon as you have built a toolchain, you can reuse it in subsequent invocations.</p><p>Building a toolchain with <code>build.sh</code> is incredibly handy on its own, as you can produce cross-build toolchains and use them for other purposes outside of building NetBSD itself. Zig’s build system has often been praised for this reason, but NetBSD’s has nothing to envy. For example, if we do this:</p><pre><code><code>./build.sh -a aarch64 -m evbarm -T ~/tools tools</code></code></pre><p>We end up with a cross-build C and C++ toolchain under <code>~/tools/</code> that targets NetBSD running on ARM 64 bits. And what goes into the toolchain, you ask?</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":95814,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd9038932-8a48-4c79-a06f-11a0eb933a7e_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Directory listing of tools as produced by the command above and its bin subdirectory.</figcaption></figure></div><p>In this listing, you can see a bunch of binaries prefixed with <code>aarch64--netbsd-</code>. These are all part of the C and C++ toolchain. The rest of the tools, prefixed with <code>nb</code>, are NetBSD-specific tools required during the build. These are programs that are part of a normal NetBSD installation and would be available without the <code>nb</code> prefix if we were building on a NetBSD host, but remember, the build system supports <em>any</em> POSIX host OS. Take <code>nbsed</code> as an example: yes, all POSIX hosts provide a <code>sed</code> tool, but its syntax varies among systems so the NetBSD build system isolates itself from those differences by compiling <code>sed</code> as a host tool and using that throughout.</p><p>One special tool from this listing is <code>nbmake-evbarm</code>. This is not the binary for make (which is itself stored as <code>nbmake</code>). This is a shell script that captures all settings provided to <code>build.sh</code> and then invokes <code>nbmake</code> with those, and this script is useful when you want to manually rebuild portions of the tree. Not something you would want to use as an “end user” of the build, but something you definitely will want to use as a NetBSD developer.</p><h1><strong>Build structure</strong></h1><p>Let’s explore the source tree a bit, which is the prime example of a monorepo in an open source project:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\" width=\"914\" height=\"718\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":718,\"width\":914,\"resizeWidth\":null,\"bytes\":77279,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0841390a-a69b-4f6b-b464-cec8df3c9ef9_914x718.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Directory listing of the source tree, its bin and bin/ls subdirectories, and the content of bin/ls/Makefile.</figcaption></figure></div><p>In this picture, you can see first the content of the top-level directory of the source tree. It all looks pretty simple: there are various subdirectories, such as <code>bin</code>, <code>lib</code>, or <code>usr.bin</code>, that roughly track the structure of the installed system; there is the <code>build.sh</code> script that I previously described; and there is a <code>Makefile</code> as well. Looking into one subdirectory, like <code>bin</code>, we see another <code>Makefile</code> and many more subdirectories, one per tool installed onto <code>/bin/</code>.</p><p>Knowing this directory-based structure, we can use the <code>nbmake-evbarm</code> wrapper script I mentioned earlier to operate on just a portion of the monorepo. Focusing on the <code>ls</code> example shown in the screenshot, we could build and upgrade this piece of the system on its own by doing:</p><pre><code><code>$ cd ~/src/bin/ls
$ ~/tools/bin/nbmake-evbarm all
... console noise ...
$ sudo ~/tools/bin/nbmake-evbarm install
... console noise ...
$ █</code></code></pre><p>Another extra detail to highlight from the screenshot is that NetBSD’s <code>Makefile</code>s are mostly declarative. Each <code>Makefile</code> defines a bunch of variables to specify what is being built and, at the end, includes one of the many <code>bsd.*.mk</code> files that pull in the build logic. Among these, we have <code>bsd.prog.mk</code> to build one program, <code>bsd.lib.mk</code> to build one static/shared library, and <code>bsd.subdir.mk</code> to recurse into subdirectories. Importantly, the general design is to build just <em>one</em> item per directory—although I myself broke this rule when I added <code>bsd.tests.mk</code> to build tests because splitting them into subdirectories would have added too much noise to the tree.</p><p>This declarative design is interesting because it maps well to the foundations of modern build systems like Bazel. In fact, the design of the NetBSD build system is what fueled my interest in build systems, influenced the design of <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">my own Buildtool</a>, and made me like <s>Bazel</s> Blaze as soon as I first saw it in 2008.</p><h1><strong>The destdir</strong></h1><p>In order to produce the structure of the final installation, the build system uses the “destdir” concept. A destdir is a staging location where built files are installed, but paths to this staging location are <em>not</em> used within the artifacts produced by the build. This idea <a href=\"https://www.gnu.org/software/automake/manual/html_node/DESTDIR.html\">exists in other build systems such as GNU Automake</a> and is pretty much a necessity to build multiple pieces of software together before installing them or to package software without root privileges.</p><p>Imagine that you want to build a library, say <code>libm</code> (the math library), and a tool that uses it, say <code>bc</code> (the calculator). <code>libm</code> typically goes into <code>/lib/</code> so we cannot just build and install it in place: for one, we may “break” the existing system if the new version happens to be backwards-incompatible; for another, we may be targeting a different architecture so we cannot just replace <code>/lib/libm.so</code> with an incompatible version.</p><p>The destdir comes to the rescue. We first build <code>libm</code> as if it would be installed into <code>/lib/</code>. However, during <em>installation</em>, we prefix all file copy operations with the destdir. In this way, we build a separate “system root”, say <code>/tmp/destdir/lib/</code>, that contains the newly-built <code>libm.so</code>. After that, we build <code>bc</code> and point it to the <code>libm</code> that’s in <code>/tmp/destdir/lib/</code>, but… we have a problem: we can’t allow the <code>/tmp/destdir/</code> path to appear anywhere inside the <code>bc</code> binary because this directory is transient. To fix this, we must separate build paths from runtime paths during the build: when we build <code>bc</code>, we tell the linker to look for libraries under <code>/tmp/destdir/lib/</code> via the <code>-L</code> flag, and we also tell the linker that, at <em>runtime</em>, libraries will be available in <code>/lib/</code> via the <code>--rpath</code> flag (which stands for runtime path).</p><p>As you can imagine, the NetBSD build system heavily relies on this idea and, after a <code>distribution</code> build (implied by the <code>release</code> goal I showed earlier):</p><pre><code><code>./build.sh -D /tmp/testdir/ distribution</code></code></pre><p>we end up with a destdir that contains all system files laid out exactly as they need to be installed.</p><p>In fact, if you run the build as root and target the host system (where the host is NetBSD), the destdir can serve as the target of a chroot. So, if you do:</p><pre><code><code>chroot /tmp/destdir</code></code></pre><p>you essentially can enter the freshly-built system. This may or may not work, however: the newly-built binaries might require new kernel features, which is likely true if you are building a more modern NetBSD release from an older release or if you are tracking NetBSD-current. And this obviously won’t work if you are cross-building.</p><h1><strong>Distribution media</strong></h1><p>The destdir serves as a staging area but it does not represent the final artifacts of the build. To put the destdir to use, we either have to “copy” the staging area onto the host to perform an in-place upgrade, or we need to build distribution media.</p><p>The former case of an in-place upgrade is tricky because it requires issuing manual post-installation steps, so I’m not going to describe it here. But the latter case of producing distribution media is trivial. For example, we can do:</p><pre><code><code>./build.sh release</code></code></pre><p>to produce the release “sets” for the system from the contents of the destdir, or we can do:</p><pre><code><code>./build.sh iso-image install-image live-image</code></code></pre><p>to create various types of installation media (a bootable CD, a bootable USB image, a live system image…) from the contents of the destdir as well.</p><p>The release sets are an interesting thing to discuss because they form the core of a NetBSD distribution. You see: NetBSD ships as a collection of tarballs, and installing NetBSD amounts to simply unpacking those tarballs onto a file system and performing a few post-installation configuration steps.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\" width=\"833\" height=\"730\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":730,\"width\":833,\"resizeWidth\":null,\"bytes\":139363,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30d5a3d3-40de-43be-bbde-1ec72852752a_833x730.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Content of the binary/sets directory of the NetBSD/amd64 distribution.</figcaption></figure></div><p>Now, the way these tarballs are produced from the destdir is by leveraging <code>mtree</code>, a really cool tool that is not known in Linux land. The purpose of this tool is to compare a textual “golden” representation of a directory against the actual contents of the directory, and highlight where they might differ.</p><p>BSD systems use <code>mtree</code> to describe how the installed system looks like and, as you can imagine, NetBSD is no exception. The NetBSD build system uses <code>mtree</code> files to ensure the destdir contents match expectations, and also uses the <code>mtree</code> “manifests” to “bucketize” the files from the destdir into the individual release sets. You can find these golden manifests in the <code>src/distrib/sets/lists/</code> directory.</p><h1><strong>Unprivileged builds</strong></h1><p>These <code>mtree</code> files are also critical for another very important feature: namely, the ability to build the whole NetBSD system as an unprivileged user. This, to me, is one of the most impressive features of this build system: you can produce the full build, including disk images, without ever running <code>sudo</code> or using weird intercept tools like Debian’s <code>fakeroot</code>.</p><p>Here is how this works. When building in unprivileged mode (enabled via the <code>-U</code> flag to <code>build.sh</code>), the build system produces a <code>METALOG</code> file under the destdir. This file looks like this:</p><pre><code><code>$ grep '^\\./sbin' ~/destdir/METALOG | head -n 5
./sbin type=dir uname=root gname=wheel mode=0755
./sbin/amrctl type=file uname=root gname=wheel mode=0555 size=72120 time=1735119460.0 sha256=d6f474441dc98648a4e8ec633dd76fc3349c85a0af9830ce8eb6566e94291fdb
./sbin/apmlabel type=file uname=root gname=wheel mode=0555 size=72360 time=1735119460.0 sha256=731cf433328bd14c6d3f322ef60fa92eb9eaa2725baa0cb52253b50743d9d324
./sbin/atactl type=file uname=root gname=wheel mode=0555 size=73512 time=1735119461.0 sha256=74a15335c8715513ac50f615a8e906319df79f76dad601bc688ae214b3e41673
./sbin/badsect type=file uname=root gname=wheel mode=0555 size=72328 time=1735119461.0 sha256=76e34649bf100fe490befb2a4ec58455a7710a665dd59bcbbd8c672a6086bde8
$ █</code></code></pre><p>Every line of this file maps a file system entry (a directory, a file, a device…) stored in the destdir to its properties, including ownership information and permissions. These entries are generated from metadata encoded in the <code>Makefile</code>s whenever the build system places a new file under the destdir via the <code>install</code> command (another nice tool often unknown to Linux users). The <code>METALOG</code> is the key that allows building media images without root privileges.</p><p>If you think about it, media images are simply files with an internal structure that represents disk partitions, file systems, and metadata. Because they are simply files, there is no need to have root access nor to make the host’s <code>passwd</code> file contain all users represented by entries in these file systems. Traditionally, OS builds have needed root because it’s easier to leverage the kernel’s virtual devices and file system implementations, but there is not inherent reason for that to be the only choice. All the work can be done in user space, and that’s precisely what NetBSD does.</p><p>Now, go back and revisit the screenshot above that showed the toolchain contents. You’ll notice tools like <code>nbmakefs</code> (the tool to format a file system) and <code>nbgpt</code> (the tool to create a GPT partitioning scheme). These tools are part of the toolchain because they are needed to generate installation media, and these tools know how to read the <code>METALOG</code> in order to embed the right permissions and special file modes into the built images. All without ever becoming root.</p><h1><strong>sysbuild</strong></h1><p>Now, as simple and powerful as <code>build.sh</code> might be, I find it cumbersome for day to day use if you want to customize any of its default settings. It is not uncommon to end up running <code>build.sh</code> with invocations like:</p><pre><code><code>./build.sh -O ../obj -T ../tools -U -u -V MKDEBUG=no -V MKGCC=no distribution</code></code></pre><p>which the official documentation describes as “golden invocations” and I have no desire to type or even remember.</p><p>This is what drove me to <a href=\"https://jmmv.dev/software/sysbuild.html\">write sysbuild</a>: a layer of abstraction over <code>build.sh</code> <em>and</em> <code>cvs</code> that coordinates updating the source tree and building it. The tool even integrates with <code>cron</code> trivially, providing a mechanism to keep NetBSD-current installations up-to-date.</p><p>sysbuild is driven by configuration “profiles” which allow you to customize the paths and settings of a build in just one place and then puts them to use with a trivial command. For example, with a configuration file like the following stored in <code>~/.sysbuild/rpi.conf</code>:</p><pre><code><code>BUILD_ROOT=\"${HOME}/netbsd\"
BUILD_TARGETS=\"tools sets disk-image\"
CVSROOT=:ext:anoncvs@cvs.NetBSD.org:/cvsroot
MACHINES=amd64
RELEASEDIR=\"${BUILD_ROOT}/release\"
SRCDIR=\"${BUILD_ROOT}/src\"
UPDATE_SOURCES=no</code></code></pre><p>We can simply run:</p><pre><code><code>sysbuild -c rpi build</code></code></pre><p>to update the NetBSD source tree to the latest version, ensure that the tools are up-to-date, and produce the USB disk images for a Raspberry Pi.</p><h1><strong>Deficiencies</strong></h1><p>Not everything about the NetBSD build system is rosy though.</p><p><em>The</em> thing that differentiates a good build system from a “meh” one for me personally is the behavior of incremental builds and, in particular, two aspects of these:</p><ul><li><p>First, incremental builds need to do minimal work, especially when there is “nothing to do”. The NetBSD build system is a recursive make one (which comes with its own <a href=\"https://accu.org/journals/overload/14/71/miller_2004/\">set of problems</a>), so it does <em>not</em> do minimal work. On my 72-core machine, it takes about 3 minutes to run through a <code>build.sh release</code> invocation that does nothing. This is OK for end users looking to upgrade their running machine, but it is painful because it makes iterating on system changes difficult. As a developer, you end up needing to know how to surgically rebuild individual subdirectories using the <code>nbmake-<arch></code> wrappers I described earlier, and manually track dependencies across those.</p></li><li><p>Second, incremental builds must <a href=\"https://jmmv.dev/2020/12/google-no-clean-builds.html\">always deliver correct results</a> <em>without</em> having to do a <code>make clean</code> in between. But that’s generally not true for make-based build systems—and NetBSD’s is no exception. Generally, an incremental build after a <code>git pull</code> (sorry, a <code>cvs update</code>) will work fine, but sometimes it won’t. And if you start playing with build-time switches (things like <code>MKDEBUG</code>), then you are out of luck and must resort to a <code>make clean</code> to “switch configurations”.</p></li></ul><p>And there are other problems. Running a parallel build on a system with many cores sometimes leads to spurious build failures because the interdependencies between components are not always precisely specified (it’s <em>really</em> difficult to be correct with make). And the build is inefficient: of those 3 minutes I mentioned earlier, you can see that <em>most of the time</em> is wasted by make recursing through directories and discovering there is nothing to do, whereas other times, make “chokes” on way too many C++ compiles at once that lead to out of memory situations.</p><p>It has been <a href=\"https://jmmv.dev/2015/04/on-bazel-and-open-source.html\">my dream since the publication of Bazel</a> as open source to have a Bazel-based build of NetBSD. I think Bazel is the perfect build system for such a project because it’d deliver correct and efficient incremental builds to NetBSD’s monorepo, and it would save tons of resources when running on many-core machines. Except for the fact that it’s written in Java, so it’d be a really odd choice for such project. Maybe Buck 2 would be suitable. Anyway, one can only dream…</p><h1><strong>But why?</strong></h1><p>Why I’m looking at this at all again, after years of not touching NetBSD? I said it in the opening: I’m working on a new embedded project for which NetBSD is the greatest fit. I could tell you what it is about but it’s easier to just show you:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"091ac30d-6b0b-46d9-af1b-df099485a01b\",\"duration\":null}\"></div><p>OK, fine, in words: I am building a minimal system that boots straight into EndBASIC with quick build times and low overhead. You’ll have to wait a bit more to get your hands on this though, as I’m still ironing out various details and want to end up providing a pre-built “box” with the right hardware and software combination.</p><p>I’m also becoming <em>super</em> tempted to migrate NetBSD’s build to Bazel to make my own life easier in this journey. This is a monumental task… but I’m not sure that it’d be crazy to tackle the minimum subset of NetBSD that I need for this minimal disk image and port only those portions to Bazel. The results might impress some and then want to help the effort. Right?</p><p>In the meantime, I encourage you to read through the comprehensive <a href=\"https://www.netbsd.org/docs/guide/en/part-compile.html\">Building the system</a> portion of <a href=\"https://www.netbsd.org/docs/guide/en/index.html\">The NetBSD guide</a>, and to play with building a NetBSD image straight from your Linux machine. You may like it.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1e15e170-38e1-4f8f-9e95-6e7c3fbee869_2048x2048.jpeg" "0.0" "image/jpeg") nil "7087d767d8562d5358926379edd5537f") (15 (26569 31003 270640 785000) "https://blogsystem5.substack.com/p/synology-ds923-vs-freebsd" "Synology DS923+ vs. FreeBSD w/ZFS" "Julio Merino" "Fri, 13 Dec 2024 17:10:52 +0000" "<p>My interest in storage is longstanding—I loved playing with different file systems in my early Unix days and then I worked on Google’s and Microsoft’s distributed storage solutions—and, about four years ago, I started running a home-grown NAS leveraging FreeBSD and its excellent ZFS support. I first hosted the server on a PowerMac G5 and then upgraded it to an overkill 72-core ThinkStation that I snapped second-hand for a great price.</p><p>But as stable and low maintenance as FreeBSD is, running day-to-day services myself is not my idea of “fun”. This drove me to replace this machine’s routing functionality with a dedicated pfSense box a year ago and, for similar reasons, I have been curious about dedicated NAS solutions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":251556,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b8cc1dc-0e8f-404c-b962-ee5b5012718d_1200x1200.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Synology DS923+ on top of its shipping box right after unboxing it.</figcaption></figure></div><p>I was pretty close to buying a second-hand NAS from the work classifieds channel when a Synology marketing person (hi Kyle!) contacted me to offer a partnership: they’d ship me <a href=\"https://sy.to/hekgh\">one of their devices</a> for free in exchange for me publishing a few articles about it. Given my interest to drive-test one of these appliances without committing to buying one (they ain’t cheap and I wasn’t convinced I wanted to get rid of my FreeBSD-based solution), I was game.</p><p>And you guessed right: this article is one of those I promised to write but, before you stop reading, the answer is no. This post is <em>not</em> sponsored by Synology and has not been reviewed nor approved by them. The content here, including any opinions, are purely my own. And what I want do do here is compare how the Synology appliance stacks against my home-built FreeBSD server.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1><strong>The hardware</strong></h1><p>Here are the two contenders in my comparison:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\" width=\"1200\" height=\"1200\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1200,\"width\":1200,\"resizeWidth\":null,\"bytes\":329916,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Synology D923+ next to my ThinkStation P710 on top of a dusty LackRack in the garage.</figcaption></figure></div><ul><li><p><strong>My home-built NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3DaBQze\">ThinkStation P710</a> equipped with 2x Intel Xeon E5-2697 v4 processors (18c/36t) at 2.30GHz, 64GB of RAM, 2x <a href=\"https://amzn.to/3ZvimN7\">Seagate 4TB Enterprise Capacity 7200 RPM</a> drives and a <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB.</p></li><li><p><strong>Operating system:</strong> FreeBSD 14.</p></li><li><p><strong>Storage configuration:</strong> ZFS with the two HDD drives in mirror mode and with the SSD set up as the L2ARC plus ZIL log for the drive pool.</p></li></ul></li><li><p><strong>The Synology NAS:</strong></p><ul><li><p><strong>Hardware:</strong> <a href=\"https://amzn.to/3ZL7sUI\">Synology DS923+</a> equipped with 3x <a href=\"https://amzn.to/4g73s6S\">Synology Plus Series 4TB 5400 RPM</a> drives and the same <a href=\"https://amzn.to/49zx3DE\">Samsung 970 EVO Plus SSD</a> 500GB that I moved from one machine to the other. The box is equipped with a 4-core AMD Ryzen Embedded R1600 and 4GB of RAM.</p></li><li><p><strong>Operating system:</strong> Synology’s own DiskStation Manager (DSM).</p></li><li><p><strong>Storage configuration:</strong> btrfs with the three HDD drives set up in RAID 5 mode and with the SSD set up to act as the cache for the drive pool.</p></li></ul></li></ul><p>The two configurations are quite different—after all, I am comparing a workstation machine with lots of spare CPU and RAM to a dedicated machine specifically crafted for file sharing—so it’s going to be difficult to be “fair” in any comparison. In any case, here are a few things to contrast:</p><ul><li><p><strong>IOPS:</strong> The P710 runs with 2 7200 RPM drives in mirror mode whereas the DS923+ runs with 3 5400 RPM drives in RAID 5 mode. The number of total IOPS from each is going to differ but… for all purposes, the 1Gbit NIC that each machine has is the limiting factor in performance so I haven’t bothered to run any performance tests. Both can saturate the network, so there is that.</p></li><li><p><strong>Quality:</strong> Both the P710 and the DS923+ are impressive machines—maybe not PowerMac G5 impressive levels, but pretty, pretty close. I love the ThinkStation’s outer design and the interior shows great cable management and airflow. As for the NAS, I love the lightweight and small form factor that allows placing it pretty much anywhere. Both are tool-less enclosures.</p></li><li><p><strong>Noise:</strong> When idle, both machines are equally quiet. The ThinkStation gets really, really loud under heavy load though, and it is also uncomfortably loud even at idle when the room temperature is warm (around or over 25C). The DS923+, however, seems quiet throughout. The Synology Plus Series HDDs are also quieter than the ones I had in the ThinkStation, and that’s partly because they are slower 5400 RPM drives. In any case, these two machines stay in my garage so I don’t care about their noise.</p></li><li><p><strong>Power consumption:</strong> I unfortunately do not own a tool to measure it, but it’d be neat to compare how these two stack up. I’m sure I’ve thrown money away by keeping the ThinkStation online 24x7 and having those drives never rest (ZFS doesn’t let them spin down) but it’s hard to care about it because my power bill is dominated by heating almost year-round.</p></li></ul><h1><strong>FreeBSD and ZFS</strong></h1><p>FreeBSD is my current favorite system for servers. FreeBSD remains close to its Unix roots and maintains rational and orthogonal tooling (unlike Linux), is quick and trivial to maintain (I could run through the 13 to 14 upgrade in… 15 minutes?), and bundles modern technology like ZFS and bhyve (unlike NetBSD, sadly, which used to be my BSD of choice).</p><p>It is true that FreeBSD gave me some headaches when I ran it on the PowerMac G5, but that’s expected due to the machine being 20 years old and <a href=\"https://www.freebsd.org/platforms/ppc/\">FreeBSD’s PowerPC support</a> being a Tier 2 platform. The thing is that I never intended to run a NAS on the G5; it just so happened to be the only machine I had available for it. In any case, I have had <em>zero</em> problems on the ThinkStation. Mind you: when I bought this machine, both Windows and Fedora experienced occasional freezes with their default installations (before pulling upgrades from the network) and FreeBSD never has shown any signs of instability.</p><p>As for ZFS, it is hard to convey the feeling of “power” you experience when you type <code>zpool</code> and <code>zfs</code> commands and see the machine coordinate multiple disks to offer you a dependable storage solution. Creating file systems on a pool, creating raw volumes for VMs or iSCSI targets, taking snapshots, replicating snapshots over the network or to backup USB drives, scrubbing the drives to verify data integrity… all are trivial commands away.</p><p>ZFS feels slow though. I grew up thinking of file systems as contiguous portions of a disk and tinkering with their partitioning scheme to keep groups of data unfragmented for speedy access. Due to the way ZFS operates, however, none of this archaic knowledge applies (and to be honest, I do not know how ZFS works in detail internally). That said, a hard drive’s seek time is around 10ms and has been like that for decades, which combined with the fact that we are now spoiled by having SSDs everywhere, exacerbates how slow an HDD-based solution feels no matter the file system.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\" width=\"1440\" height=\"800\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":800,\"width\":1440,\"resizeWidth\":null,\"bytes\":45551,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F54b6ec9a-bc96-44f4-94e7-c223419e3c77_1440x800.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Did I just mention disk fragmentation? Yeah I did, and I could not resist including this screenshot of MS-DOS 6.22's DEFRAG.EXE here. Just because.</figcaption></figure></div><p>Regarding network connectivity, FreeBSD offers all sorts of networked file systems and services. The base system provides NFSv3, NFSv4, FTP, and iSCSI targets. The ports (packages) system offers whatever else you may need, including SMB, DLNA, and even ancient protocols like AppleTalk or distributed protocols like Ceph. All configuration is done by hand over SSH in the traditional Unix way of editing configuration files—aka messing around with different, inconsistent text formats.</p><h1><strong>Synology’s DSM and btrfs</strong></h1><p>The DS923+ runs Synology’s own operating system: the <a href=\"https://www.synology.com/en-us/dsm\">DiskStation Manager (DSM)</a>. The DSM is a headless-first system designed to be accessed over the network, which is no surprise. What <em>is</em> surprising is the choice of the interface: while most networked devices offer some sort of a web-based tabbed UI, the DSM offers a desktop environment—with overlapping windows no less. This feels like a gimmick to me, and a quite neat one, but overkill nonetheless.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":384169,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3b4b1b72-a1fb-4b49-9c05-6b9c237b6c44_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The DSM desktop with the Control Panel and the File Station apps open to demonstrate the appearance of the web-based windowing system.</figcaption></figure></div><p>If we peek under the covers, which we can do by logging into the machine over SSH, we find that the DSM is a Linux system. No surprises here after seeing that its choice of file system is btrfs. But what kind of Linux is it? A weird one, let me tell you. Luckily, you do not have to interact with it at all if you don’t want to, but hey, I’m curious so I did look.</p><p>The DSM seems to be some sort of Debian derivative based on the fact that <code>dpkg</code> is installed, but otherwise I cannot find any other obvious remains of what might have been a Debian installation; even <code>dpkg -l</code> shows nothing. What I can tell is that the btrfs file systems are mounted under <code>/volume1</code> and, in there, we can find one directory per shared folder that we create in the UI. We can also find various directories prefixed with <code>@</code>, which is a… weird choice for Unix file names, and I understand are managed by the DSM. These include things like <code>@appdata</code> or <code>@userpreference</code>, which carry strong Windows vibes.</p><p>Considering that the DS923+ is almost a PC and runs Linux, I did look to see if it was possible to run FreeBSD instead. It turns out some people have tried this, and FreeBSD does run, but it lacks drivers to control power to the drives so it cannot actually leverage the storage devices. From what I understood, the DS923+ seems to have dedicated hardware to control power the drive pool, and this hardware logic is controlled via GPIO.</p><p>Which got me even more curious: if the DSM explicitly controls power to the drive pool, how does it boot and how does it remain responsive even after shutting down the drives? I guessed that the device comes with a tiny drive to hold the DSM and boots off of it, and upon inspecting the <code>dmesg</code> and looking for non-obvious stuff, I found this:</p><pre><code><code>sd 7:0:0:0: Attached scsi generic sg3 type 0
sd 7:0:0:0: [synoboot] 245760 512-byte logical blocks: (126 MB/120 MiB)
sd 7:0:0:0: [synoboot] Write Protect is off
sd 7:0:0:0: [synoboot] Mode Sense: 23 00 00 00
sd 7:0:0:0: [synoboot] No Caching mode page found
sd 7:0:0:0: [synoboot] Assuming drive cache: write through
sd 7:0:0:0: [synoboot] Attached SCSI disk</code></code></pre><p>Ah-ha. A small 120MB (flash?) drive that acts as the system device. However… this separation of system vs. drive pool comes with a price: the drive pool often shuts off, and powering it back on is <em>slow</em> (10–15 seconds are not unusual). When you try to reach the NAS over the network and the pool is off, it can feel as if the NAS is unreachable / down, which has already confused me a few times and caused me to started diagnosing network issues. Quite annoying to be honest, but obviously this can be configured in the <em>Hardware & Power</em> menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":413086,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa1f20cad-5f57-4d48-aeeb-0ca5a7ea5832_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The list of available options under the Hardware & Power menu.</figcaption></figure></div><p>Regarding network connectivity, the DSM offers multiple networked file systems and services out of the box, namely: SMB, NFS v3, NFS v4, AFP, FTP, and rsync. I’m actually surprised to see AFP, AppleTalk’s “replacement”, in the default set of supported file systems in this day and age, but there it is. Additionally, the DSM provides its own package management system to install a limited set of additional services and utilities, which I used to add DLNA support.</p><h1><strong>Seeding the NAS</strong></h1><p>Anyhow, let’s change topics and talk about the DS923+ itself.</p><p>The first thing I had to do after getting the device was to seed it with data. I needed to copy about 1TB of photos and documents from the FreeBSD machine to the DS923+, which is not a lot, but is large enough that different copy mechanisms can make a huge difference in the time the copy takes. In particular, the choice of <em>protocol</em> matters for a quick copy: both SMB and NFS are OK with large files, but transferring many small files with them is painful. Fortunately, the DSM allows rsync over SSH and I used that to do the initial seeding.</p><p>Now, using rsync came with two “problems”. The first is that I had to know the <em>path</em> to the shared folders in the file system to specify the rsync targets. This is not clearly exposed through the UI, so I had to rely on SSH to log into the machine and figure out that the shared folders are at <code>/volume1/<shared_folder>/</code> as I briefly mentioned in the previous section.</p><p>Which led to the second problem or, rather, surprise: even though I had set up 2FA for the user accounts I created in the DSM UI, 2FA was meaningless when accessing the machine over SSH. I understand why that may be, but then I question what the point of enabling 2FA really is if one can gain access to the machine without it. The same is true of SMB by the way: you just need an account’s password, not the 2FA. So, unless you disable all networked file systems and only allow web access to the NAS, all the 2FA does is give you a false sense of security.</p><h1><strong>Peace of mind</strong></h1><p>When comparing my custom FreeBSD server to the newer DS923+, the main difference I can notice is an increase in “peace of mind”. Yes, FreeBSD is very stable and ZFS is great… but I wasn’t running the ThinkStation as a dedicated NAS: I was mixing the machine’s NAS responsibilities with those of a host for development tasks. I always felt uncomfortable about the health of the system and I wasn’t convinced that my maintenance was “good enough” to safeguard my data.</p><p>As you can imagine, being uncomfortable about your data is not something you want to feel: trust is <em>The Thing</em> you most want in a storage solution, and there are a few things that stand out during the setup of the system that gave me warm feelings on this topic.</p><p>The first and obvious one is that the DSM offers to encrypt the pool right from the beginning, which is something you should always do in this day and age: encryption is cheap in CPU terms, the data you own is precious, and the devices that store it tend to be small and light so they are at risk of theft. But beware: the key is stored on the device to allow auto-mounting by default, which means a knowledgeable thief could still gain access. Thus, this level of encryption is only useful to facilitate the disposal of drives. That said, you can configure additional encryption on each shared folder if you want per-user password-protected encryption.</p><p>The second thing is that, nowhere in the setup process I was asked to create a Synology account for the NAS to be fully functional. You might think that this is a given, but seeing the state of other hardware or software products these days… it’s not. So this sent a very welcome message. I ended up needing to create an account for certain features that required it, but these were completely optional.</p><p>The third thing, which is actually one of those features that required creating a Synology account, is the ability to send email notifications for system alerts. Email-based alerts are terrible in large organizations (and of course the DSM offers better alternatives, like ActiveInsight), but for my personal use case, emails are perfect and make a huge difference with my previous FreeBSD setup. I can rest assured that I’ll be told about anything unusual with the DS932+ in a way that I will notice. With my custom build, I had certain monitoring features in place like weekly disk scrubs and periodic online backups… but no way to properly notify me of problems with either: if anything went wrong, I would not have known on time, and that was very unsettling.</p><p>The fourth and final thing is that the DSM has been built throughout the years by people that deal with storage all the time, and it’s fair to assume that they know a thing or two about running a NAS. I have reasonable confidence that the configuration of the system and the storage pool is going to be “correct” over time, particularly across upgrades, whereas I was never quite sure of it with my manual FreeBSD setup. One such example is with the NFS configuration: setting up the NFSv4 server in the DSM was pretty much knob-free—so <a href=\"https://blogsystem5.substack.com/p/demystifying-secure-nfs\">when things didn’t work with the clients</a>, I could assume that the issue was almost certainly with the clients themselves.</p><h1><strong>Additional apps</strong></h1><p>As I mentioned earlier, the DS923+ is pretty much a PC with Linux in a tiny box, so in principle it can host any kind of software you like. The way this works is via DSM’s own “marketplace” where you can find new services to add to the machine.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/a06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":365681,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa06715e8-b944-48d1-9457-4c3cedd7dc9d_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The DSM desktop showing the Package Center application.</figcaption></figure></div><p>I did add the optional DLNA service so that I could play videos from my Xbox, and also toyed with with the Domain Server (and later gave up due to the sheer complexity of setting up a domain just for home use). But there are other interesting optional features. For example, you can create virtual machines on the DS923+ which, despite the limited CPU and RAM of the machine, can come in handy from time to time. I suppose with a more powerful box from Synology, the story here would be quite different.</p><p>One thing to highlight is that these extra pieces of software are <em>curated</em>: you aren’t just installing an extra service to the underlying Linux machine. You are installing an extension to the DSM, which comes with new configuration panels in the UI and full integration with the system. You never have to know that Linux is there if you don’t want to.</p><h1><strong>Backup solutions</strong></h1><p>Having a dedicated NAS with a storage pool that protects against corruption is great, but a singly-homed box like this is still subject to massive data loss due to ransomware, physical damage caused by fire or flooding, and correlated disk failures. Backups are critically important.</p><p>With the FreeBSD setup, my backup strategy involved using <code>zfs send</code> and <code>zfs receive</code> to back up snapshots into two USB drives: one kept in a fire safe and one kept offsite. This worked but I had to figure out the syntax of these commands over and over again, which didn’t make me feel confident about these actions. I did also back up irreplaceable data to a OneDrive account using <code>rclone</code>, which was good but… manual and ad-hoc as well. Needless to say, while the backups existed, they were often stale and they were a pain to manage.</p><p>Backing up a NAS is difficult though. For one, a NAS is designed to store <em>lots</em> of data, which means the backup targets have to be large capacity-wise too. And for another, given the DS923+ reduced physical size, it is likely to end up placed in a location that isn’t super convenient to access, which will make attaching temporary USB drives and the like an annoying experience.</p><p>For now, what I have tried is the optional <em>Cloud Sync</em> package that allows replicating to many cloud services, including OneDrive. And it’s a joy to use. I could trivially install the package, log into my Microsoft account, and configure the two specific folders I care about backing up. I could even respect the previous file layout of my OneDrive account so I did not have to re-upload anything. And the tool supports encryption too, which you may want if you really don’t like those cloud providers from training their AI systems with your data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\" width=\"1430\" height=\"795\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":795,\"width\":1430,\"resizeWidth\":null,\"bytes\":779628,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5c418a61-b658-4502-919f-2abb4a1b07ae_1430x795.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Sample configuration of cloud syncing to OneDrive.</figcaption></figure></div><p>There is more though. Synology offers a variety of products for remote and physical backup. The one that does interest me the most is <a href=\"https://www.synology.com/en-global/dsm/feature/snapshot_replication\">Snapshot Replication</a>, which provides something similar to what I was doing with <code>zfs send</code> and <code>zfs receive</code>, but unfortunately requires a second Synology system offsite that I don’t have. The other solutions are <a href=\"https://sy.to/hf5yf\">Active Backup for Business</a> and <a href=\"https://sy.to/tntsi\">Hyper Backup</a>, which I still would like to evaluate but haven’t had a chance to look into.</p><h1><strong>Future</strong></h1><p>To conclude this brief review and comparison, let me say that I’m happy with the DS923+ experience so far. I don’t think I <em>need</em> it because my FreeBSD solution worked well enough, but considering that I like to use the ThinkStation as the host for my VMs and as my primary development machine—aka, a fun toy—I feel more at peace with a dedicated appliance that stores my precious data.</p><p>For more details, you can visit Synology’s product pages for the <a href=\"https://sy.to/hekgh\">DS923+</a> and the <a href=\"https://sy.to/drkom\">Plus Series HDDs</a>. And if you want to roll your own FreeBSD-based solution, <a href=\"https://docs.freebsd.org/en/books/handbook/zfs/\">Chapter 22 of the FreeBSD handbook on ZFS</a> is a good place to start.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf14379b-2b84-4794-9505-4927135861d6_1200x1200.jpeg" "0.0" "image/jpeg") nil "804fa8c27425156e9ddcc3e4edeefb21") (14 (26569 31003 267861 191000) "https://blogsystem5.substack.com/p/demystifying-secure-nfs" "Demystifying secure NFS" "Julio Merino" "Mon, 04 Nov 2024 00:00:13 +0000" "<p>I recently got a <a href=\"https://sy.to/hekgh\">Synology DS923+</a> for evaluation purposes which led me to setting up NFSv4 with Kerberos. I had done this about a year ago with FreeBSD as the host, and going through this process once again reminded me of how painful it is to secure an NFS connection.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":232646,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>You see, Samba is much easier to set up, but because NFS is the native file sharing protocol of Unix systems, I felt compelled to use it instead. However, if you opt for NFSv3 (the “easy default”), you are left with a system that has zero security: traffic travels unencrypted and unsigned, and the server trusts the client when the client asserts who is who. Madness for today’s standards. Yet, when you look around, people say “oh, but NFSv3 is fine if you trust the network!” But seriously, who trusts the network in this day and age?</p><p>You have to turn to NFSv4 <em>and</em> combine it with Kerberos for a secure file sharing option. And let me tell you: the experience of setting these up and getting things to work is horrible, and the documentation out there is terrible. Most documents are operating-system specific so they only tell you what works when a specific server and a specific client talk to each other. Other documents just <em>assume</em>, and thus omit, various important details of the configuration.</p><p>So. This article is my recollection of “lab notes” on how to set this whole thing up along with the necessary background to understand NFSv4 and Kerberos. My specific setup involes the Synology DS923+ as the NFSv4 server; Fedora, Debian, and FreeBSD clients; and the supporting KDC on a pfSense (or FreeBSD) box.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">An upcoming article will compare the Synology NAS against my home-built FreeBSD-based NAS. Subscribe now to get it!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>NFSv3’s insecurity</h1><p>NFSv3, or usually just NFS, is a protocol from the 1980s—and it shows. In broad terms, NFSv3 exposes the <em>inodes</em> of the underlying file system to the network. This became clear to me when I implemented <a href=\"https://jmmv.dev/software/tmpfs.html\">tmpfs for NetBSD</a> in 2005 and realized that a subset of the APIs I had to support were in service of NFS. This was… a mind-blowing realization. <em>“Why would tmpfs, a memory file system, need NFS-specific glue?”</em>, I thought, and then I learned the bad stuff.</p><p>Anyhow. Now that you know that NFSv3 exposes inodes, you may understand why sharing a directory over NFSv3 is an all-or-nothing option for <em>the whole file system</em>. Even if you can configure <code>mountd</code> to export a single directory via <code>/etc/exports</code>, malicious clients can craft NFS RPCs that reference inodes outside of the shared directory. Which means… they get free access to the whole file system and explains why system administrators used to put NFS-exported shares in separate partitions, mounted under <code>/export/</code>, in an attempt to isolate access to subsets of data.</p><p>To make things worse, NFSv3 has no concept of security. A client can simply assert that a request comes from UID 1000 and the server will <em>trust</em> that the client is really operating on behalf of the server’s UID 1000. Which means: a malicious client can pretend to be <em>any</em> user that exists on the server and gain access to <em>any</em> file in the exported file system. Which then explains why the <code>maproot</code> option exists as an attempt to avoid impersonating root… but only root. Crazy talk.</p><p>All in all, NFSv3 may still be OK if you really trust the network, if you compartmentalize the exported file system, and if you are sharing inconsequential stuff. But can <em>you</em> trust the network? Maybe you can if you are using a P2P link, but otherwise… it is really, really risky and I do not want to do that.</p><h1>How is NFSv4 better?</h1><p>NFSv4, despite having the same NFS name as NFSv3, is a completely different protocol. Here are two main differences:</p><ul><li><p><strong>NFSv4 operates on the basis of usernames, not UIDs.</strong> Each request to the server contains a username and the server is responsible for translating that username to a local UID while verifying access permissions.</p></li><li><p><strong>NFSv4 operates at the path level, not the inode level.</strong> Each request to the server contains the path of the file to operate on and thus the server can apply access control based on those.</p></li></ul><p>Take these two differences together and NFSv4 can implement secure access to file systems. Because the server sees usernames and paths, the server can first verify that a user is who they claim to be. And because the server can authenticate users, it can then authorize accesses at the path level.</p><p>That said, if all you have is NFSv4, you only get the <code>AUTH_SYS</code> security level, which is… the same as having no security at all. In this mode, the server trusts the client and assumes that user X on the client maps exactly to user X on the server, which is almost the same as NFSv3 did.</p><p>The real security features of NFSv4 come into play when it’s paired with Kerberos. When Kerberos is in the picture, you get to choose from the following security levels for each network share:</p><ul><li><p><code>krb5</code>: Requires requests to be authenticated by Kerberos, which is good to ensure only trusted users access what they should but offers zero “on-the-wire” security. Traffic flows unsigned and unencrypted, so an attacker could tamper with the data and slurp it before it reaches the client.</p></li><li><p><code>krb5i</code>: Builds on <code>krb5</code> to offer integrity checks on all data. Basically, all packets on the network are signed but not encrypted. This prevents spoofing packets but does not secure the data against prying eyes.</p></li><li><p><code>krb5p</code>: Builds on <code>krb5</code> to offer encrypted data on the wire. This prevents tampering with the network traffic and also avoids anyone from seeing what’s being transferred.</p></li></ul><p>Sounds good? Yeah, but unfortunately, Kerberos and its ecosystem are… complicated.</p><h1>Kerberos 101</h1><p>Kerberos is an authentication broker. Its goal is to detach authentication decisions between a client machine and a service running on a second machine, and move that responsibility to a third machine—the Kerberos Domain Controller (KDC). Consequently, the KDC is a trusted entity between the two machines that try to communicate with each other.</p><p>All the machines that interact with the KDC form a <em>realm</em> (AKA a <em>domain</em>, but not a DNS domain). Each machine needs an <code>/etc/krb5.conf</code> file that describes which realms the machine belongs to and who the KDC for each realm is.</p><p>The actors that exist within the realm are the <em>principals</em>. The KDC maintains the authoritative list of principals and their authentication keys (passwords). These principals represent:</p><ul><li><p><strong>Users</strong>, which have names of the form <code><username>@REALM</code>. There has to be one of these principals for every person (or role) that interacts with the system.</p></li><li><p><strong>Machines</strong>, which have names of the form <code>host/<machine>.<domain>@REALM</code>. There has to be one of these principals for every server, and, depending on the service, the clients may need one too as is the case for NFSv4.</p></li><li><p><strong>Services</strong>, which have names of the form <code><service>/<machine>.<domain>@REALM</code>. Some services like NFSv4 require one of these, in which case <code><service></code> is <code>nfs</code>, but others like SSH do not.</p></li></ul><p>Let’s say Alice wants to log into the Kerberos-protected SSH service running on SshServer from a client called LinuxLaptop, all within the <code>EXAMPLE.ORG</code> Kerberos realm.</p><p><em>(Beware that the description below is not 100% accurate. My goal is for you to understand the main concepts so that you can operate a Kerberos realm.)</em></p><p>First, Alice needs to obtain a Ticket-Granting-Ticket (TGT) if she doesn’t have a valid one yet. This ticket is issued by the KDC after authenticating Alice with her password, and allows Alice to later obtain service-specific tickets without having to provide her password again. For this flow:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/df16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":128347,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf16ba6a-28ac-4b42-bedb-42652a9aa644_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Steps involved in obtaining a TGT from the KDC for a user on a client machine.</figcaption></figure></div><ol><li><p>Alice issues a login request to the KDC from the client LinuxLaptop by typing <code>kinit</code> (or using other tools such as a PAM module). This request carries Alice’s password.</p></li><li><p>The KDC validates Alice’s authenticity by checking her password against the KDC’s database and issues a TGT. The TGT is encrypted with the KDC’s key and includes an assertion of who Alice is and how long the ticket is valid for.</p></li><li><p>The client LinuxLaptop stores the TGT on disk. Alice can issue <code>klist</code> to see the ticket:</p></li></ol><pre><code><code>linux-laptop$ klist
Credentials cache: FILE:/tmp/krb5cc_1001
Principal: alice@EXAMPLE.ORG
Issued                Expires               Principal
Oct 26 09:04:57 2024  Oct 26 19:05:01 2024  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG
linux-laptop$ █</code></code></pre><p>The TGT, however, is not sufficient to access a service. When Alice wants to access the Kerberos-protected SSH service running on the SshServer machine, Alice needs a ticket that’s specific to that service. For this flow:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/b64419dd-efb9-429d-b300-854bc955a717_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":146323,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb64419dd-efb9-429d-b300-854bc955a717_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Steps involved in obtaining a service-specific ticket from the KDC for a user on a client machine.</figcaption></figure></div><ol><li><p>Alice sends a request to the Ticket-Granting-Service (KDS) and asks for a ticket to SshServer. This request carries the TGT.</p></li><li><p>The TGS (which lives in the KDC) verifies who the TGT belongs to and verifies that it’s still valid. If so, the TGS generates a ticket for the service. This ticket is encrypted with the service’s secret key and includes details on who Alice is and how long the ticket is valid for.</p></li><li><p>The client LinuxLaptop stores the service ticket on disk. As before, Alice can issue <code>klist</code> to see the ticket:</p></li></ol><pre><code><code>linux-laptop$ klist
Credentials cache: FILE:/tmp/krb5cc_1001
Principal: alice@EXAMPLE.ORG
Issued                Expires               Principal
Oct 26 09:04:57 2024  Oct 26 19:05:01 2024  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG
Oct 26 09:05:11 2024  Oct 26 19:05:01 2024  host/ssh-server.example.org@EXAMPLE.ORG
linux-laptop$ █</code></code></pre><p>At this point, all prerequisite Kerberos flows have taken place. Alice can now initiate the connection to the SSH service:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\" width=\"1456\" height=\"827\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":827,\"width\":1456,\"resizeWidth\":null,\"bytes\":151288,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8c18a1ee-0314-4261-8408-ae7ac1b4abc4_2223x1263.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Accessing a remote SSH server using a Kerberos ticket without password authentication.</figcaption></figure></div><ol><li><p>Alice sends the login request from the LinuxLaptop client to the SshServer server and presents the service/host-specific ticket that was granted to her earlier on.</p></li><li><p>The SshServer server decrypts the ticket with its own key, extracts details of who the request is from, and verifies that they are correct. This happens <em>without talking to the KDC</em> and is only possible because SshServer trusts the KDC via a pre-shared key.</p></li><li><p>The SSH service on SshServer decides if Alice has SSH access as requested and, if so, grants such access.</p></li></ol><p>Note these very important details:</p><ul><li><p><strong>The KDC is only involved in the ticket issuance process.</strong> Once the client has a service ticket, all interactions between the client and the server happen <em>without</em> talking to the KDC. This is essential to not make the KDC a bottleneck in the communication.</p></li><li><p><strong>Each host/service and the KDC have unique shared keys that are known by both the host/service and the KDC.</strong> These shared keys are created when registering the host or service principals and are copied to the corresponding machines as part of their initial setup. These keys live in machine-specific <code>/etc/krb5.keytab</code> files.</p></li><li><p><strong>Kerberos does authentication only, not authorization.</strong> The decision to grant Alice access to the SSH service in Think is made by the service itself, not Kerberos, after asserting that Alice is truly Alice.</p></li></ul><p>As you can imagine, the KDC must be protected with the utmost security measures. If an attacker can compromise the KDC’s locally-stored database, they will get access to all shared keys so they can impersonate any user against any Kerberos-protected service in the network. That’s why attackers try to breach into an Active Directory (AD) service as soon as they infiltrate a Microsoft network because… AD <em>is</em> a KDC.</p><h1>Setting up the KDC</h1><p>Enough theory. Let’s get our hands dirty and follow the necessary steps to set up a KDC.</p><p>The KDC’s needs are really modest. Per the discussion above, the KDC isn’t in the hot data path of any service so the number of requests it receives are limited. Those requests are not particularly complex to serve either: at most, there is some CPU time to process cryptographic material but no I/O involved, so for a small network, any machine will do.</p><p>In my particular case, I set up the KDC in my little pfSense box as it is guaranteed to be almost-always online. This is probably not the best of ideas security-wise, but… it’s sufficient for my paranoia levels. Note that most of the steps below will work similarly on a FreeBSD box, but if you are attempting that, please go read <a href=\"https://docs.freebsd.org/en/books/handbook/security/#kerberos5\">FreeBSD’s official docs on the topic</a> instead. Those docs are one of the few decent guides on Kerberos out there.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":359967,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e366115-edb8-4244-83f9-b9351f089f56_1600x1200.jpeg 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The pfSense little box that I run the KDC on.</figcaption></figure></div><p>Here are the actors that will appear throughout the rest of this article. I’m using the real names of my setup here because, once again, these are my lab notes:</p><ul><li><p><code>MEROH.NET</code>: The name of the Kerberos realm.</p></li><li><p><code>jmmv</code>: The user on the client machine wanting access to the NFSv4 share. The UID is irrelevant.</p></li><li><p><code>router.meroh.net</code>: The pfSense box running the KDC.</p></li><li><p><code>nas.meroh.net</code>: The Synology DS923+ NAS acting as the NFSv4 server.</p></li><li><p><code>think.meroh.net</code>: A FreeBSD machine that will act as a Kerberized SSH server for testing purposes and an NFSv4 client. (It’s a ThinkStation, hence its name.)</p></li><li><p><code>x1nano.meroh.net</code>: A Linux machine that will act as an NFSv4 client. While in reality this is running Fedora, I’ll use this hostname interchangeably for Fedora and Debian.</p></li></ul><p>Knowing all actors, we can set up the KDC. The first step is to create the <code>krb5.conf</code> for the KDC which tells the system which realm the machine belongs to. You’ll have to open up SSH access to the machine via the web interface to perform these steps.</p><p>Here is the minimum content you need:</p><pre><code><code>[libdefaults]
default_realm = MEROH.NET
[realms]
MEROH.NET = {
kdc = router.meroh.net
admin_server = router.meroh.net
}
[domain_realm]
.meroh.net = MEROH.NET</code></code></pre><p>With that, you should be able to start the <code>kdc</code> service, which is responsible for the KDC. All documentation you find out there will tell you to also start <code>kadmind</code>, but if you don’t plan to do administer the KDC from another machine (why would you?), then you don’t need this service.</p><p>pfSense’s configuration is weird because of the read-only nature of its root partition, so to do this, you have to edit the <code>/cf/conf/config.xml</code> file stored in NVRAM and add this line right before the closing <code></system></code> tag:</p><pre><code><code><shellcmd>service kdc start</shellcmd></code></code></pre><p>If you were to set this up on a FreeBSD host instead of pfSense, you would modify <code>/etc/rc.conf</code> instead and add:</p><pre><code><code>kdc_enable=YES</code></code></pre><p>Then, from the root shell on either case:</p><pre><code><code>kdc# service kdc start
kdc# █</code></code></pre><p>It is now a good time to ensure that every machine involved in the realm has a DNS record and that reverse DNS lookups work. Failure to do this will cause problems later on when attempting to mount the NFSv4 shares, and clearing those errors won’t be trivial because of caching at various levels.</p><h1>Creating principals</h1><p>Once the KDC is running, we must create principals for the hosts, the NFSv4 service, and the users that will be part of the realm. The client host and service principals aren’t always necessary though: SSH doesn’t require them, but NFSv4 does.</p><p>To create the principals, we need access the KDC’s administrative console. Given that the KDC isn’t configured yet, we can only gain such access by running <code>kadmin -l</code> on the KDC machine directly (the pfSense shell), which bypasses the networked <code>kadmind</code> service that we did not start.</p><p>Start <code>kadmin -l</code> and initialize the realm:</p><pre><code><code>kdc# kadmin -l
kadmin> init MEROH.NET
... answer questions with defaults ...
kadmin> █</code></code></pre><p>Next, create principals for the <em>users</em> that will be part of the realm:</p><pre><code><code>kadmin> add jmmv
... answer questions with defaults ...
... but enter the desired user password ...
kadmin> █</code></code></pre><p>Then, create principals for the <em>hosts</em> (server and clients, but not the KDC) and the NFSv4 <em>service</em>:</p><pre><code><code>kadmin> add --random-key host/think.meroh.net
... answer questions with defaults ...
kadmin> add --random-key host/x1nano.meroh.net
... answer questions with defaults ...
kadmin> add --random-key host/nas.meroh.net
... answer questions with defaults ...
kadmin> add --random-key nfs/nas.meroh.net
... answer questions with defaults ...
kadmin> █</code></code></pre><p>And finally, extract the host and service credentials into the machine-specific keytab files. Note that, for the servers, we extract both the host and any service principals they need, but for the client, we just extract the host principal. We do not export any user principals:</p><pre><code><code>kadmin> ext_keytab --keytab=think.keytab host/think.meroh.net
kadmin> ext_keytab --keytab=x1nano.keytab host/x1nano.meroh.net
kadmin> ext_keytab --keytab=nas.keytab host/nas.meroh.net nfs/nas.meroh.net
kadmin> █</code></code></pre><p>You now need to copy each extracted keytab file to the corresponding machine and name it <code>/etc/krb5.keytab</code>. (We’ll do this later on the Synology NAS via its web interface.) This file is what contains the shared key between the KDC and the host and is what allows the host to verify the authenticity of KDC tickets without having to contact the KDC. Make sure to protect it with <code>chmod 400 /etc/krb5.keytab</code> so that nobody other than root can read it.</p><p>If <code>scp</code> is unsuitable or hard to use from the KDC to the client machines (as is my case because I restrict SSH access to the KDC to one specific machine), you can use the <code>base64</code> command to print out a textual representation of the keytab and use the local clipboard to carry it to a shell session on the destination machine.</p><h1>Initial client setup</h1><p>At this point, the realm should be functional but we need to make the clients become part of the realm. We also need to install all necessary tools, like <code>kinit</code>, which aren’t present by default on some systems:</p><ul><li><p>On Debian:</p><ul><li><p>Run <code>apt install krb5-user nfs-common</code>.</p></li><li><p>Follow the prompts that the <code>krb5-user</code> installer shows to configure the realm and the address of the KDC. This will auto-create <code>/etc/krb5.conf</code> with the right contents so you don’t have to do anything else.</p></li></ul></li><li><p>On Fedora:</p><ul><li><p>Run <code>dnf install krb5-workstation</code>.</p></li><li><p>Edit the system-provided <code>/etc/krb5.conf</code> file to register the realm and its settings. Use the file content shown above for the KDC as the template, or simply replace all placeholders for <code>example.org</code> and <code>EXAMPLE.ORG</code> with the name of your DNS domain and realm.</p></li></ul></li><li><p>On FreeBSD:</p><ul><li><p>Create the <code>/etc/krb5.conf</code> file from scratch in the same way we did for the KDC.</p></li></ul></li></ul><p>All set! But… do you trust that you did the right thing everywhere? We could go straight into NFSv4, but due to the many pitfalls in its setup, I’d suggest you verify your configuration using a simpler service like SSH.</p><p>To do this, modify the SSH server’s (aka <code>think</code>’s configuration) <code>/etc/ssh/sshd_config</code> file and add <code>GSSAPIAuthentication yes</code> so that it can leverage Kerberos for authentication. Restart the SSH service and give it a go: run <code>kinit</code> on the client (<code>x1nano</code>) and then see how <code>ssh think</code> works without typing a password anymore.</p><p>But… <code>GSSAPIAuthentication</code>? What’s up with the cryptic name?</p><p>GSS-API stands for <em>Generic Security Services API</em> and is the interface that programs use to communicate with the Kerberos implementation on the machine. GSS-API is not always enabled by default for a service, and the way you enable it is service-dependent. As you saw above, all we had to do for SSH was modify the <code>sshd_config</code> file… but for other services, you may need to take extra steps on the server and/or the client.</p><p>And, guess what, NFSv4 is weird on this topic. Not only we need service-specific principals for NFS, but we also need the <code>gssd</code> <em>daemon</em> to be running on the server <em>and</em> the client machines. This is because NFSv4 is typically implemented inside the kernel, but not Kerberos, so the kernel needs a mechanism to “call into” Kerberos. And the kernel needs to do this to map kernel-level UIDs (a Unix kernel doesn’t know anything about <em>usernames</em>) to Kerberos principals and vice-versa—and that’s precisely what <code>gssd</code> offers. So:</p><ul><li><p>On the Synology NAS:</p><ul><li><p>Do nothing. The system handles <code>gssd</code> by itself.</p></li></ul></li><li><p>On Linux:</p><ul><li><p>You shouldn’t have to do anything if you correctly created the prerequisite <code>/etc/krb5.keytab</code> early enough, but make sure the service is running with <code>systemctl status rpc-gssd.service</code> (and know that this command only shows useful diagnostic logs when run as root).</p></li><li><p>Run <code>systemctl start rpc-gssd.service</code> if the service isn’t running.</p></li></ul></li><li><p>On FreeBSD:</p><ul><li><p>Add <code>gssd_enable=YES</code> to <code>/etc/rc.conf</code>.</p></li><li><p>Run <code>service gssd start</code>.</p></li></ul></li></ul><h1>Exporting NFSv4 services</h1><p>It’s time to deal with NFSv4, so let’s start by configuring the server on the NAS.</p><p>The Synology Disk Station Manager (DSM) interface—the web UI for the NAS—is… interesting. As you might expect, it is a web-based interface but… it pretends to be a desktop environment in the browser, which I find overkill and unnecessary. But it’s rather cool in its own way.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\" width=\"728\" height=\"455\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/d1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png\",\"srcNoWatermark\":null,\"fullscreen\":false,\"imageSize\":\"normal\",\"height\":910,\"width\":1456,\"resizeWidth\":728,\"bytes\":1000728,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd1356fec-5402-45d7-a353-2c9c4ad5036d_1936x1210.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Navigating the Synology DSM menus to configure the NFS file service with Kerberos.</figcaption></figure></div><p>The first step is to enable the NFS service. Roughly follow these steps, which are illustrated in the picture just above:</p><ul><li><p>Open the <strong>File Services</strong> tab of the <strong>Control Panel</strong>.</p></li><li><p>In the <strong>NFS</strong> tab, set NFSv4 as the <strong>Minimum NFS protocol</strong>.</p></li><li><p>Click on <strong>Advanced Settings</strong> and, in the panel that opens, enter the Kerberos realm under the <strong>NFSv4 domain</strong> option.</p></li><li><p>Click on <strong>Kerberos Settings</strong> and, in the panel that opens, select <strong>Import</strong> and then upload the keytab file that we generated earlier on for the NAS. This should populate the <code>host</code> and <code>nfs</code> principals in the list.</p></li><li><p>Finish and save all settings.</p></li></ul><p>That should be all to enable NFSv4 file serving.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\" width=\"1456\" height=\"910\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":910,\"width\":1456,\"resizeWidth\":null,\"bytes\":1307597,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0f65845b-85ed-4813-9cc2-14388f1777a2_1936x1210.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Navigating the Synology DSM menus to configure the properties of a single shared folder over NFS.</figcaption></figure></div><p>Then, we need to expose shared folders over NFSv4, and we have to do this for every folder we want to share. Assuming you want to share the <code>homes</code> folder as shown in the picture just above:</p><ul><li><p>Open the <strong>Shared Folder</strong> tab of the <strong>Control Panel</strong>.</p></li><li><p>Select the folder you want to share (in our case, <code>homes</code>), and click <strong>Edit</strong>.</p></li><li><p>In the <strong>NFS Permissions</strong> tab, click either <strong>Create</strong> or <strong>Edit</strong> to enter the permissions for every host client that should have access to the share.</p></li><li><p>Fill the NFS rule details. In particular, enter the hostname of the client machine, enable the <strong>Allow connections from non-privileged ports</strong> option, and select the <strong>Security</strong> level you desire.</p></li></ul><p>In my case, I want <code>krb5p</code> and <code>krb5p</code> only so that’s the only option I enable. But your risk profile and performance needs may be different, so experiment and see what works best for you.</p><h1>Mounting NFSv4 from Linux</h1><p>Now that the server is ready and we have dealt with the GSS-API prerequisites, we can start mounting NFSv4 on the clients.</p><p>On Linux, things are pretty simple. We can mount the file system with:</p><pre><code><code>x1nano# sudo mount nas:/volume1/homes /shared
x1nano# █</code></code></pre><p>Or persist the entry in <code>/etc/fstab</code> if we want to:</p><pre><code><code>nas:/volume1/homes /shared nfs sec=krb5p 0 0</code></code></pre><p>And then we should be able to list its contents <em>assuming we’ve got a valid TGT for the current user</em> (run <code>kinit</code> if it doesn’t work):</p><pre><code><code>x1nano$ ls -l /shared
total 0K
drwxrwxrwx 1 nobody users 0 Sep 27 21:11 admin
drwxrwxrwx 1 jmmv   users 0 Nov  2 20:41 jmmv
drwxrwxrwx 1 nobody users 0 Oct  8 16:59 manager
x1nano$ █</code></code></pre><p>Easy peasy, right? But wait… why do all directories have <code>777</code> permissions?</p><p>This is rather unfortunate and I’m not sure why the Synology does this. Logging onto the DS923+ via SSH, I inspected the shared directory and realized that it has various ACLs in place to control access to the directories, but somehow, the traditional Unix permissions are all <code>777</code> indeed. Not great.</p><p>I used <code>chmod</code> to fix the permissions for all directories to <code>755</code> and things seem to be OK, but that doesn’t give me a lot of comfort because I do not know if the DSM will ever undo my changes or if I might have broken something.</p><p>There might be one more problem though, which I did not encounter on Debian clients but that showed up later in Fedora and FreeBSD clients:</p><pre><code><code>x1nano$ ls -l /shared
total 0K
drwxr-xr-x 1 nobody nogroup 0 Sep 27 21:11 admin
drwxr-xr-x 1 nobody nogroup 0 Nov  2 20:41 jmmv
drwxr-xr-x 1 nobody nogroup 0 Oct  8 16:59 manager
x1nano$ █</code></code></pre><p>Note how all entries are owned by <code>nobody:nogroup</code> which is… not correct. Yet the right permissions are in effect: accessing the <code>jmmv</code> directory is only possible by the <code>jmmv</code> user as expected. Which means that the user mapping between Kerberos principals and local users is working correctly on the server… but not on the client, where <code>stat</code> isn’t returning the right information.</p><p>I do not yet know why this issue happens, especially because I see no material differences between my Fedora and Debian configurations.</p><h1>Mounting NFSv4 from FreeBSD</h1><p>We now have the Linux clients running just fine so it is time to pivot to FreeBSD. If we try a similar “trivial” mount command, we get an error:</p><pre><code><code>think# mount -t nfs nas:/volume1/homes /shared
mount_nfs: nmount: /shared: Permission denied
think# █</code></code></pre><p>The error is pretty… unspecific. It took me quite a bit of trial and error to realize that I <em>had</em> to specify <code>-t nfsv4</code> for it to attempt a NFSv4 connection and not NFSv3 (unlike Linux, whose <code>mount</code> command attempts the highest possible version first and then falls back to older versions):</p><pre><code><code>think# mount -t nfs -o nfsv4 nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
think# █</code></code></pre><p>OK, progress. Now this complains that the security flavor we request is wrong. Maybe we just need to be explicit and also pass <code>sec=krb5p</code> as an argument:</p><pre><code><code>think# mount -t nfs -o nfsv4,sec=krb5p nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
think# █</code></code></pre><p>Wait, what? The mount operation still fails? This was more puzzling and also took a fair bit of research to figure out because logs on the client and on the server were just insufficient to see the problem.</p><p>The reason for the failure is that we are trying to mount the share as root but… we don’t have a principal for this user so root cannot obtain an NFSv4 service ticket to contact the NAS. So… do we need to create a principal for <code>root</code>? No! We do not need to provide user credentials when mounting an NFSv4 share (unlike what you might be used to with Windows shares).</p><p>What Kerberized NFSv4 needs during the mount operation is a host ticket: the NFSv4 server checks if the client <em>machine</em> is allowed to access the server and, if so, exposes the file system to it. This is done using the client’s host principal. Once the file system is mounted, however, all operations against the share carry the ticket of the <em>user</em> requesting the operation.</p><p>Knowing this, we need to “help” FreeBSD and tell it that it must use the host’s principal when mounting the share. Why this isn’t the default, I don’t know, particularly because non-root users are not allowed to mount file systems in the default configuration. Anyhow. The <code>gssname=host</code> option rescues us:</p><pre><code><code>think# mount -t nfs -o nfsv4,sec=krb5p,gssname=host nas:/volume1/homes /shared
think# █</code></code></pre><p>Which finally allows the mount operation to succeed. We should persist all this knowledge into an <code>/etc/fstab</code> entry like this one:</p><pre><code><code>nas:/volume1/homes /shared nfs rw,nfsv4,gssname=host,sec=krb5p 0 0</code></code></pre><h1>Verifying encryption</h1><p>Color me skeptical, but everything I described above seems convoluted and fragile, so I did not trust that my setup was sound. Consequently, I wanted to verify that the traffic on the network was actually encrypted.</p><p>To verify this, I installed Wireshark and ran a traffic capture against the NAS with <code>host nas</code> as the filter. Then, from the client, I created a text file on the shared folder and then read it. Inspecting the captured packets confirmed that the traffic is indeed flowing in encrypted form. I could not find the raw file content anywhere in the whole trace (but I could when using anything other than <code>krb5p</code>).</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\" width=\"1456\" height=\"960\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":960,\"width\":1456,\"resizeWidth\":null,\"bytes\":459416,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F997efe31-f588-4896-8874-c8ad272fc97c_1460x963.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Content of an NFS reply packet with Kerberos-based encryption. The packet contents are not plain text.</figcaption></figure></div><p>And, as a final test, I tried to mount the network share <em>without</em> <code>krb5p</code> and confirmed that this was not possible:</p><pre><code><code># mount -t nfs -o nfsv4,gssname=host,sec=krb5i nas:/volume1/homes /shared
mount_nfs: nmount: /shared, wrong security flavor
# █</code></code></pre><p>All good! I think…</p><h1>Open questions</h1><p>That’s about it. But I still have a bunch of unanswered questions from this setup:</p><ul><li><p>Kerberos claims to be an authentication system only, not an authorization system. However, the protocol I described above separates the TGT from the TGS, and this separation makes it sound like Kerberos could also implement authorization policies. Why doesn’t it do these?</p></li><li><p>The fact that Fedora and FreeBSD show <code>nobody</code> for file ownership even when they seems to do the right thing when talking to the NFSv4 server sound like a bug either in the code or in my configuration. Which is it?</p></li><li><p>Having to type <code>kinit</code> after logging into the machine is annoying. I remember that, back at Google when we used Kerberos and NFS—those are long gone days—the right tickets would be granted after logging in or unlocking a workstation. This must have been done with the Kerberos PAM modules… but I haven’t gotten them to do this yet and I’m not sure why.</p></li><li><p>The fact that the shared directories created by the Synology NAS have 777 permissions seems wrong. Why is it doing that? And does anything break if you manually tighten these permissions?</p></li><li><p>And the most important question of all: <strong>is this all worth it?</strong> I’m tempted to just use password-protected Samba shares and call it a day. I still don't trust that the setup is correct, and I still encounter occasional problems here and there.</p></li></ul><p>If you happen to have answers to any of the above or have further thoughts, please drop a note in the comments section. And…</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you want to see how the DS923+ compares to my home-built FreeBSD NAS with ZFS, subscribe for a future post on that!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Credit and disclaimers: the <a href=\"https://sy.to/hekgh\">DS923+</a> and <a href=\"https://sy.to/drkom\">the 3 drives</a> it contains that I used for throughout this article were provided to me for free by Synology for evaluation purposes in exchange for blogging about the NAS. The content in this article is <em>not</em> endorsed has <em>not</em> been reviewed by them.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F40d6885b-2fe4-4002-a444-a083894b44da_1600x1200.jpeg" "0.0" "image/jpeg") nil "8a064bdcf8d17eeaaec3fe8a4495becf") (13 (26569 31003 264433 163000) "https://blogsystem5.substack.com/p/bazelcon-2024-recap" "BazelCon 2024 recap" "Julio Merino" "Tue, 22 Oct 2024 15:01:01 +0000" "<p>Just like that, BazelCon 2024 came and went. And just like that, Blog System/5 is about to turn 1 year old as the very first post of this newsletter was the <a href=\"https://blogsystem5.substack.com/p/bazelcon-2023-et-al-trip-report\">recap of BazelCon 2023</a>. Since then, this newsletter has amassed 1200+ subscribers and I have surpassed <a href=\"https://blogsystem5.substack.com/p/20-years-of-blogging\">20 years of blogging</a>—so, thank you for your support, everyone!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\" width=\"1456\" height=\"1048\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1048,\"width\":1456,\"resizeWidth\":null,\"bytes\":362903,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>To celebrate this milestone, it’s obviously time to summarize the two events of last week: BazelCon 2024 and the adjacent Build Meetup. There is <em>A LOT</em> of ground to cover. I could probably write a separate article for each of the sections below, but folks coming for a summary of the conference will want to see everything in one place… so you get this massive piece instead.</p><p>Overall, this is a 40-minute read… but let’s face it: getting 3 days worth of content in less than an hour sounds like a good deal, doesn’t it? Feel free to pick and choose sections though; each stands on its own and each paragraph represents a thought I captured from some presentation or discussion.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">No LLMs were involved in this work, thus you can only imagine how much effort it went into putting this together. So, subscribe to support Blog System/5 and… enjoy!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Schedule and logistics</h1><p>BazelCon 2024 was hosted at the Computer History Museum in Mountain View, CA, on October 14th and 15h. The conference had a <a href=\"https://bazelcon2024.sched.com/\">single track of talks</a> and an overlapping track of BoF sessions. I attended most of the talks but just one BoF—the IDE one. The conference was followed by evening socials hosted by BuildBuddy and JetBrains/EngFlow.</p><p>The Build Meetup followed BazelCon 2024 on October 16th, and this time around it was cohosted by Meta and EngFlow in Menlo Park, CA. The meetup had three tracks: one for Bazel, one for Buck 2, and one for remote execution. I helped facilitate the Bazel track, including taking notes for the afternoon unconference (notes at the very end), and gave a 15-minute talk on Bazel at Snowflake. Facilitating the track was fun, but unfortunately this made me miss the Buck track and I’m still wanting to learn more about it.</p><p>The notes I gathered from the talks and discussions are grouped in the following topics:</p><ul><li><p>Community and adoption</p></li><li><p>Remote Execution</p></li><li><p>IDE support</p></li><li><p>Inner loop development</p></li><li><p>Toolchains</p></li><li><p>Sandboxing</p></li><li><p>Monorepo issues</p></li><li><p>blzmod and external dependencies</p></li><li><p>Secure and auditable builds</p></li><li><p>Symbolic macros</p></li><li><p>Queries</p></li><li><p>Linting</p></li><li><p>Testing</p></li><li><p>Missing tooling around Bazel</p></li><li><p>The end</p></li></ul><h1>Community and adoption</h1><p>The conference opened with the usual briefing and SOTU, which included information on the conference itself and the latest news in the Bazel project. These were followed by talks that touched upon the community and current adoption trends, and these are the thoughts I gathered:</p><ul><li><p><strong>Conference ownership:</strong> This was the first BazelCon <em>not</em> run by Google. The conference is now owned by the Linux Foundation and Google was a sponsor at the same level of BuildBuddy and EngFlow. The Linux Foundation has run the conference excellently thanks to the dedicated team of professionals that they have for the task.</p></li><li><p><strong>Conference history:</strong> Looking back, you should know that the Bazel team was (and still is) distributed across two sites: Google NYC and Google Munich. To mitigate the difficulties that arise from geographical distribution, the team held internal-only summits every 6 months. It wasn’t until 2017 that this internal conference became BazelCon and, after that, the team alternated between an internal event and an external event. Last year, BazelCon had 250 attendees with a waitlist that contained 200 extra folks, and this is the second year that the program committee contains non-Google folks (myself included).</p></li><li><p><strong>Google’s investment in Bazel:</strong> Does this shift to the Linux Foundation change <a href=\"https://bazel.build/contribute/policy\">Bazel’s governance</a> to make it more community-driven? Not yet, but it’s a step in that direction! Google still owns Bazel and continues to invest in it because they can leverage contributions from strong non-Google engineers and because Google maintains a bunch of open-source projects that rely on Bazel. But Google also wants to have a more open community to guarantee that Bazel continues to thrive even if company-internal priorities change.</p></li><li><p><strong>The <a href=\"https://github.com/bazel-contrib\">bazel-contrib organization</a>:</strong> To support these changes, a few folks have created a new GitHub organization and have gotten Google to donate many repos to this new org. The organization creators have a desire to start a new foundation to support and direct these projects and are looking for about 5 companies to join.</p></li><li><p><strong>Bazel adoption stickiness:</strong> The REBELs research group at the <a href=\"https://rebels.cs.uwaterloo.ca/\">Univesity of Waterloo</a> conducted a study over <a href=\"https://is.gd/WorldOfCode/\">35,000 significant GitHub projects</a> to see why, from the 1.5% of projects that adopted Bazel, 11% of those abandoned the migration at roughly the 2-year mark.</p><ul><li><p><strong>Abandonment reasons:</strong> The reasons cited for abandoning Bazel were varied, but can be summarized as encountering technical challenges, issues with team coordination and onboarding, and seeing community trends (like Kubernetes deciding to move off of Bazel).</p></li><li><p><strong>If not Bazel, then what?:</strong> These projects primarily decided to move to language-specific tools, especially for languages with strong native tooling like Go and Swift. However, a significant proportion also decided to move back to “inferior” tools like CMake or even GNU Make. These projects acknowledged that these tools are less feature rich and don’t support integration with other languages, but they are conventional and easier to understand by the community.</p></li><li><p><strong>If Bazel, then why?:</strong> On the plus side, for the cases where Bazel stuck, we can find the reasons we expect: dependency management, faster builds, and even the influence of other projects shine as reasons for making Bazel a good choice.</p></li></ul></li><li><p><strong>Adoption suggestions:</strong> The CTO of Ergatta spoke on how his small company has been able to successfully leverage Bazel without massive investments in infrastructure. His suggestions were to keep things simple (e.g. by using the GCS-backed cache despite its flaws, or by doing the trivial <code>bazel test ...</code> on CI); to expedite solutions even if not perfect (e.g. by wrapping foreign builds in Bazel); to look for champions and leverage them for adoption; to focus on “good enough” results; to write documentation for your successors; and, surprisingly, to do frequent and incremental changes to workflows instead of big-bang “improvements”.</p></li></ul><h1>Remote Execution</h1><p>As you know, remote execution is Bazel’s raison d’etre. Consequently, the SOTU covered various updates on this topic and many talks included related thoughts:</p><ul><li><p><strong>SOTU updates:</strong> The remote output service is now available and bb-clientd offers an implementation. The execution log is now 100x smaller than before and only has a 3% runtime overhead, which is useful to debug cache hits. Upcoming changes include concurrent uploads to the cache in the background without blocking action completion, GCing of local caches (disk cache, install cache, etc.), and BwoB improvements to decrease incremental build times when Skymeld is in use.</p></li><li><p><strong>Remote persistent workers:</strong> AirBnB observed 2x slower builds when not using remote persistent workers. They use dedicated pools for Java and Kotlin and route all actions into these pools, and reminded us that tagging targets comes with pitfalls because targets can spawn multiple actions and just one of them needs the worker.</p></li><li><p><strong>Queuing control:</strong> Remote execution environments typically have different worker pools to support different build environments or to optimize cost. But note: the goal shouldn’t always be to tolerate all possible load all the time: it is reasonable to put limits on the worker pools like AirBnB does so that you can dedicate a pool for interactive builds and prioritize low latency, but also create a separate pool for CI builds where you put hard caps and tolerate queuing.</p></li><li><p><strong>Target size matters:</strong> Dealing with tons of individual small files is costly. In some cases, you may be better off tarring them up and declaring a single input to an action and making the action unpack the tar during execution. This came up during the talk on high performance builds for web monorepos, and I found this interesting because this goes in the opposite direction of tree artifacts which have often been problematic.</p></li><li><p><strong>Action deduplication:</strong> Any remote execution service worth its money can coalesce in-flight actions to save on cost. This shines in CI with builds that have long-running actions, and Canva reports that they see 500k dedups per day on about 3 webpack builds. One consideration is that flaky test passes/failures are amplified by action coalescing: without this feature, flakes will show up as random failures over time, whereas with this feature, failures will be clustered. Extracting a signal around flakiness becomes harder.</p></li><li><p><strong>Determinism checks:</strong> While not necessarily an issue with remote execution, having remote execution exacerbates the problem of non-deterministic actions in a build. Spend the time to set up a CI job to <a href=\"https://www.youtube.com/watch?v=XItY0LmdiFA\">look for non-determinism</a> and alert on it. Specific problems that often arise are timestamps in JARs (<code>rules_antrl</code> is impacted), absolute paths (<code>rules_kotlin</code> is impacted), or diagnostics information (Scala <code>sdeps</code> file is problematic).</p></li><li><p><strong>Postmortems and learnings:</strong> Ulf Adams gave a talk reflecting on four different incidents that EngFlow’s remote execution service suffered. Personally, seeing companies introspect their failures makes <em>me</em> trust them <em>more</em> than not, but YMMV. In any case, I do not necessarily want to go over the incidents per se, but I do want to go over the recommendations:</p><ul><li><p><strong>Avoid RPC cycles and set timeouts:</strong> The call graph between services must not have cycles, which is hard to enforce because these may show up organically over time. Also make sure to have timeouts on all RPCs, although the RE protocol makes this difficult because it has long-running RPCs.</p></li><li><p><strong>Make sure <a href=\"https://grpc.io/docs/guides/flow-control/\">flow control</a> is configured:</strong> This is a feature of gRPC that allows a server to keep memory consumption in check and is achieved by “slowing down” incoming traffic (thus “controlling the flow”). When proxying traffic in a server, special care must be taken to connect the flow control logic of the input and output streams of the proxy. Otherwise, a slow client can have ripple effects through the system and cause OOMs.</p></li><li><p><strong>Auto-scaling is tricky to get right:</strong> From a cost-savings perspective, you want to downsize servers as quickly as possible and increase them slowly. But if you do this and there is queuing, it’s possible that auto-scaling will make queuing worse.</p></li><li><p><strong>Guardrails build trust:</strong> You might say that user-induced problems are not service problems: after all, if, for example, they cause compile actions to time out after 20 minutes, it’s “their fault” for doing the wrong thing. However, if this happens, there obviously is something wrong—and it’d be nice for the service provider to notice and have prevention features in place just like your water provider can detect leaks. (And yet… AWS <em>still</em> doesn’t have a way to put a limit on spend.)</p></li></ul></li></ul><h1>IDE support</h1><p>If you have had to support any developers converting from “legacy” build systems to Bazel, you may have realized that… the IDE features they are used to don’t quite work after the migration. Things have gotten better in the IDE space for Bazel but aren’t great yet. Fortunately, there are a few news that give hope:</p><ul><li><p><strong><a href=\"https://jb.gg/new-bazel-plugin\">New JetBrains plugin for IntelliJ</a>:</strong> Released to the marketplace during the conference, this new plugin provides tighter integration between IntelliJ and Bazel through the BSP abstraction layer. This new plugin can represent the Bazel build graph in the IDE, offers syntax highlighting for <code>bazelrc</code> files (and, feature request: could offer docs on hover), supports inserting breakpoints in Starlark evaluation, implements “fast build” correctly, and optimizes the sync process. There are some gaps compared to the old plugin, but I’m super-excited by what’s coming because the old Google-owned plugin is… underwhelming. See the <a href=\"https://jb.gg/new-bazel-feature\">feature list</a> and the <a href=\"https://jb.gg/new-bazel-roadmap\">roadmap</a> for more details.</p></li><li><p><strong>Build Server Protocol (BSP):</strong> The BSP is a new protocol that aims to achieve the same thing that the Language Server Protocol (LSP) did: namely, solve the M:N problem between IDEs and build systems. The idea is to have an intermediate abstraction for the build system so that M IDEs can talk to N build systems by means of an intermediary process that converts the BSP to build actions. The BSP is still young though and, right now, it’s pretty rigid because it has deep knowledge of the languages it supports. In particular, there is no support for custom rules yet, so get involved if you want to see this happen.</p></li><li><p><strong>Old plugin for JetBrains:</strong> The old plugin will be fully supported until mid-2025 (although I predict they’ll have to backpedal on this and extend this date). This plugin has many shortcomings because it originates from Android Studio and contains assumptions about Android and about Google’s own infrastructure. That said, there is a new feature called “query sync” that optimizes the sync process massively… at the expense of having to manually “enable analyze” for any files where deep IDE integration is desired. The problem is: you <em>have</em> to enable analysis to get insights on generated files, and generated files tend to be everywhere thanks to protobuf, so… you’ll likely find yourself “enabling analyze” all the time. Shrug.</p></li><li><p><strong>Good IDE support is critical:</strong> Having a good IDE experience is crucial for developers, but the irony is that the people that often work on build migrations or the IDE are <em>experts</em> and know how to tolerate imperfect IDE support. This is not the case for most developers, particularly those that must get up to speed… so keep that in mind. Running user interviews, surveys, etc. is a necessity to understand what people truly perceive as problems.</p></li><li><p><strong>Compilation database:</strong> JetBrains is not the only contender in the IDE space. There are many more (wink, wink, Emacs) and BSP will make offering a Bazel experience within them possible. Until that’s ready, though, you may need to manually deal with a “compilation database”, especially if you want to integrate with VSCode. A compilation database is, simply put, a JSON file that contains the commands to compile each and every translation unit in a project. There are various options to generate one of these with Bazel, all with different trade-offs:</p><ul><li><p><strong>Intercept builds:</strong> Use <code>bear</code> as a wrapper to run the full clean build. This works with some build systems, but unfortunately, Bazel’s client/server model doesn’t allow <code>bear</code> to intercept the actions it spawns.</p></li><li><p><strong>Extra actions:</strong> Add a “listener” extra action that listens for <code>CppCompile</code>. This also requires a full clean build and is deprecated by aspects, but is the approach that <code>kythe</code> uses.</p></li><li><p><strong>Action graph query:</strong> Does not require a full build, just a warmed up analysis cache. However, this does not support tree artifacts. Examples: <code>bazel-compile-commands-extractor</code>, <code>bazel-compile-commands</code> (two forks).</p></li><li><p><strong>Aspect:</strong> Does not require a full build, but the generated commands may not be identical to the ones that are actually used. For example: if you have a code generator that produces a tree artifact and then is fed as an input to a <code>cc_library</code>, then the tree artifact is represented as a <code>CppCompileActionTemplate</code> that is only expanded to a specific command line at runtime.</p></li></ul></li><li><p><strong>Non-blocking queries:</strong> The Bazel server has a global lock that prevents it from running more than one command at a time. This is a problem because the IDE needs to issue Bazel queries all the time, but those queries conflict with other user actions like builds and tests. There are various solutions to this problem, which we discussed in the unconference:</p><ul><li><p><strong>Separate output bases:</strong> This <em>works</em> but it’s heavy-handed because you end up with two full separate builds and two separate Bazel server processes.</p></li><li><p><strong>Simpler tools:</strong> Many operations on build files do not require the full weight of Bazel. Google has implemented simpler tools that operate on those precisely to bypass the overhead of calling ito Bazel. These tools include <code>buildifier</code>, <code>buildozer</code>, or the “fast builds” feature of the IntelliJ plugin.</p></li><li><p><strong>Parallel Skyframe evaluation:</strong> Skyframe’s inherent design is to be purely functional, so in principle it should be possible to perform multiple operations on the graph in parallel. Unfortunately, there is a lot of mutable state outside of Skyframe in Bazel and, while theoretically possible, fixing this is <em>a lot</em> of work.</p></li><li><p><strong>Implementing a depserver:</strong> Instead of running a separate Bazel on the same machine to answer queries, you could push this responsibility to an external service. Such a service is easy to build (you can imagine running <code>bazel query ...</code> on each commit) but the problem arises when you want to issue queries against this service from modified source trees.</p></li></ul></li></ul><h1>Inner loop development</h1><p>Bazel is <em>the</em> tool that glues together the <em>inner loop</em> of the development process. As a reminder, the inner loop refers to the the edit, build, and test cycle, and Bazel has tentacles on these three stages. Various talks gave thoughts on this topic:</p><ul><li><p><strong>Avoid Bazel in the inner loop:</strong> AirBnB reported that they noticed significant overhead and lack of incrementality in certain operations when trying to hook up Bazel into the IDE. They have the equivalent of “fast builds” in their own IDE plugin and have reduced incremental builds from 30 seconds to 1 second. This is a <em>big deal</em> for interactive builds. Personally, I think that having to side-step Bazel is ridiculous: Bazel is designed to be optimal and has perfect knowledge of the state of the world, yet it’s too slow for quick operations.</p></li><li><p><strong>Integrate with native tooling:</strong> Bazel works across many ecosystems, but as such, it’s friend to none. For example: Go developers want to work with the (super-fast) Go tooling so, if it’s feasible, it’s interesting to allow using such tooling directly. The folks at LinkedIn created a rule that generates an <code>.envrc</code> file to expose the native Go tools and relies on <a href=\"https://direnv.net/\">direnv</a> to make this work transparently for users.</p></li><li><p><strong>macOS as a client is common:</strong> Even for shops where all software runs on Linux, developers tend to have Macs and want to work locally. You may or may not agree, but if you <em>have</em> to support inner-loop development on the Mac, there are various things to consider. One is that cross-platform caching for machine-independent actions like Java may not work, doubling cache requirements; for this, you may consider using “universal binaries” (aka shell scripts that wrap multiple binaries and choose the right one at runtime). And you should really set up non-determinism checks.</p></li><li><p><strong>No build files:</strong> To my dismay, tons of people seem to really want to <em>not</em> have build files. This makes me sad because manually-curated build files serve as <em>documentation</em> for the <em>conceptual architecture</em> of a project and allow, at PR review time, to see changes to the interactions between components. You might say that <code>#include</code>s or package <code>import</code>s in the source are sufficient for this—but they really aren’t: they are too fine-grained and “innocent-looking”. I think I’ll need to write a follow-up article on this point.</p></li></ul><h1>Toolchains</h1><p>Bazel supports targeting multiple architectures and systems, and at the core of this support lie toolchains. There were various talks that touched on them:</p><ul><li><p><strong>Toolchains 101:</strong> In Bazel, rules convert providers to action templates, and toolchains help convert those templates to actions by replacing two things in the templates: the paths to the tools required by the action, and the arguments to pass to those tools. Simple, right? But defining toolchains has always been a black art.</p></li><li><p><strong>Simplified toolchains:</strong> Google brings a new way to define toolchains that’s much easier than the original one. The new mechanism relies on build rules: a toolchain rule declares a toolchain, and the toolchain depends on a “tool map” rule, which is a flat map of tool names (strategically specified as labels for typo- and type-checking, not flat strings) to binaries (also specified as labels). These tools are also connected to argument rules that define the sequence of arguments to apply to each tool. The support for “features” in core Bazel can potentially be removed in favor of this.</p></li><li><p><strong>Default toolchain no more:</strong> Following on the previous, Google said that there is a desire to remove the concept of a default C++ toolchain in favor of explicitly defining a hermetic toolchain like almost all other rules do. This was met with cheering from the audience.</p></li><li><p><strong>Debugging:</strong> It’s funny how, despite the complexity of toolchains and how we should make things easier for users… <code>--toolchain_resolution_debug</code>’s help claims that the flag is only for experts. <a href=\"https://github.com/bazelbuild/bazel/pull/19926\">PR 19926</a> made the debugging messages much clearer, but you should still understand the toolchain resolution algorithm to make sense of issues, and the talk on “Creating C++ toolchains easily” explained that.</p></li><li><p><strong>Universal binaries:</strong> Bazel doesn’t like sharing artifacts across different architectures. This is generally the right thing to do but, for platform-agnostic languages like Java, this has the potential of doubling remote execution and caching costs. There is an <a href=\"https://github.com/bazelbuild/bazel/discussions/18378\">ongoing discussion upstream</a> on what to do with this issue and various partial implementations in the code (like the <code>--experimental_platform_in_output_dir</code> flag), but no great solution yet. In the meantime, the alternative is to implement “universal binaries”. The idea is to create a shell script that wraps a binary tool built for various systems and selects, at runtime, which one to run.</p></li><li><p><strong>C++ shows up everywhere:</strong> Even if your build doesn’t seem to require C++ anywhere, the requirement to have this toolchain installed shows up pretty much everywhere because of… protobuf. bzlmod has the potential to fix this because the protobuf bzlmod packages ship with prebuilt binaries.</p></li></ul><h1>Sandboxing</h1><p>In order to offer reproducible builds, Bazel offers sandboxing features at the action level to ensure that actions can only do what they are supposed to do. I used to work in this space while on the Bazel team, so all talks on this topic were really interesting. Here are the notes:</p><ul><li><p><strong>macOS sandboxing is slow:</strong> Ah, the issue that never dies and that came up again in the unconference. While it might be true that macOS handles symlinks poorly, I’m still not convinced that there is anything that makes macOS sandboxing inherently slow. Yes, it will be less sandbox-y than what you get on Linux, but performance-wise it should be OK. All of my testing years ago didn’t show <code>sandbox-exec</code> as a performance bottleneck, and the sandbox doesn’t kill Bazel’s own build performance so… something <em>else</em> is at play here. Which brings us to the next point.</p></li><li><p><strong>Persistent state:</strong> Some compilers like Objective C’s build a module cache as they run. This cache is intended to be shared across invocations of the compiler. However, when the sandbox is in effect, sharing of this cache becomes impossible, which in turn makes builds incredibly slow. It may <em>seem</em> as if the sandbox itself is slow, but the real problem here is the lack of state sharing across actions and I suspect this is why people remain convinced that macOS sandboxing is slow. And, by the way, this impacts more than just Objective C.</p></li><li><p><strong>Sandboxing scenarios:</strong> Is it really necessary to sandbox <em>all</em> rules? <code>genrule</code>s, sure, but if we can reason about the behavior of specific rules, we can probably disable sandboxing for them and remain correct, which would decrease build-time overheads. (Remember that the sandbox was never about security.)</p></li><li><p><strong>File monitoring:</strong> An alternative to sandboxing is to monitor the activity of build actions and validate, post-build, that they didn’t access things they were not supposed to. This is much faster than sandboxing as it avoids the need to construct on-disk sandboxes… but fails when tools decide to read directories. So… this approach isn’t really feasible. JavaScript tooling loves to expand globs.</p></li><li><p><strong>Hermetic sandboxing:</strong> The traditional Bazel sandbox does not restrict reading system-wide paths so it cannot guarantee that an action doesn’t access certain system headers or arbitrary tools in <code>/bin</code>. There is a “new” hermetic sandbox for Linux that fixes these issues—but, obviously, is hard to put in practice. See <code>--experimental_use_hermetic_linux_sandbox</code>.</p></li><li><p><strong>Base POSIX system:</strong> With a hermetic sandbox, it becomes very tempting to model the host system’s base libraries and tools (bash and the like) as a toolchain. <a href=\"https://github.com/tweag/rules_sh\">rules_sh</a> from Tweag can help here.</p></li><li><p><strong>Local remote execution:</strong> A different mechanism to achieve sandboxing would be to use remote execution against a local service. This service could run on a VM or similar and offer a mechanism to cross-compile against weird architectures. This wouldn’t be quite the same as the Docker strategy.</p></li><li><p><strong>Separation of responsibilities:</strong> Somebody mentioned that it’d be neat to separate the sandboxing logic into its own thing that isn’t in Bazel’s core. I agree. The <code>linux-sandbox</code> binary that Bazel contains is somewhat akin to this, and I previously implemented something similar in <a href=\"https://github.com/jmmv/sandboxctl\">sandboxctl</a> (for very different reasons). In any case, this would need to be multi-platform and written in a decent, safe language (<em>cough</em> Rust <em>cough</em>).</p></li></ul><h1>Monorepo issues</h1><p>With scale come problems, and large monorepos tend to exacerbate issues that have always existed in small repos but that go unnoticed otherwise. Here are some of the issues that talks mentioned:</p><ul><li><p><strong>Glob handling:</strong> Globs are expensive to handle in Bazel, especially when running on networked file systems. Globs are parsed and then expressed as a DAG of functions within Skyframe. Right now, due to limitations in Java’s concurrency model, globs are evaluated twice, but Java 21’s green threads may alleviate this. Related, I was chatting about this with one of the Buck 2 authors and he said that they take a very different approach and don’t find the issues that Google described: basically, they traverse the file system once and then apply the glob as an in-memory only operation.</p></li><li><p><strong>Monolithic targets:</strong> Any large piece of code that has grown without a build system that enforces boundaries across components will grow at least one component that has thousands of source files in it with cyclic dependencies among them. These are harmful to the organization as they tend to reflect the “broken windows” culture of the team. Tinder explained how they tackle this problem, with basically boils down to: ensuring there are tests, ensuring that leadership is onboard with the cleanup, creating automation to extract files from the monolith (most of the work is repetitive), and then creating visualization tools to graph the problem and identify subsets of files that can be easily extracted.</p></li><li><p><strong>Gradual rollout of library updates:</strong> During the unconference, we discussed how to deal with version upgrades of a single library in a world that favors the “One version policy”.</p><ul><li><p><strong>Prerequisites:</strong> We agreed that, to succeed at upgrading a library, it’s critical to have tests in place and leverage tooling like <code>buildifier</code> to perform the upgrades automatically where possible.</p></li><li><p><strong>Big bang upgrade:</strong> One approach to the problem is to do the version upgrade in one go. This is sometimes really hard to do, and can also be risky because any problem anywhere in the repo would imply a rollback for everyone.</p></li><li><p><strong>Treat it as an exception:</strong> Another approach is to get an exception from the “One version policy” and temporarily allow two versions of the library in the repo. You can leverage the <code>alias</code> rule to introduce an indirection to the version in use, and then slowly migrate packages. This can work but diamond conflicting dependencies can be a real problem.</p></li><li><p><strong>Parallel build:</strong> Yet another approach is to create a parallel build and test infrastructure for the new version. Maybe use a build flag to select the version to use; maybe duplicate the targets and rename them. The goal with this approach is to keep the “new version” on the side until it all works, and then submit a trivial “3-line PR” that flips the default. For this scenario, “project files” would be useful to group the new set of targets and automatically set the right configuration for them; Buck 2 has something similar in its <code>PACKAGE</code> construct.</p></li><li><p><strong>Different package names:</strong> And another approach is to do what Java tends to do, which is to <em>rename</em> the libraries on major version upgrades so that they do not conflict at all. This is something that the upstream library maintainers have to do, not you. The problem with this approach is that semantic version is not always accurate and upstream maintainers tend to do breaking changes during minor version upgrades without realizing it.</p></li></ul></li><li><p><strong>git pain:</strong> Bazel and large monorepos go hand in hand, but Git—the most popular version control system—doesn’t like large repos very much: some operations scale with the size of the history (<code>git clone</code>) while others scale with the size of the repo (<code>git status</code>) instead of scaling with the size of the change.</p><ul><li><p><strong>Mitigation tools:</strong> There are various options that can mitigate the problem, including the <a href=\"https://git-scm.com/docs/git-fsmonitor--daemon\">FSMonitor</a>, the “untracked cache”, keeping <code>.gitignore</code> small, and using sparse checkouts.</p></li><li><p><strong>Materializing a portion of the tree:</strong> Uber previously tried using a Bazel query to find all files required for a build and then using the result of the query to just check those files out from Git. While this can work, it led to confusing error messages when there were missing files. And also, this poses the question: where do you run the query given that the query needs access to the full repo?</p></li><li><p><strong>git archives:</strong> Git is a very chatty protocol. Mark Zeren from Broadcom reports that, while Perforce can easily saturate the network, Git can rarely do so on a similar repo. The slowdown is even visible when using the loopback network interface. Prebuilding <code>git-archive</code>s periodically and using those to build the initial state of a Git clone can significantly improve performance. He mentioned that it’d be good to build a service to automate this, and offered help in doing so.</p></li><li><p><strong>Delegating file accesses:</strong> There is an open feature request in <a href=\"https://github.com/bazelbuild/bazel/issues/16380\">#16380</a> asking for a way to delegate file accesses to another tool. This, to me, sounds like FUSE. Someone brought up that FUSE doesn’t work well on macOS anymore and that NFS can be used as an alternative, and Meta’s EdenFS or Buildbarn’s bb-clientd’s do that just fine. Another option is to implement a custom VFS instance within Bazel to directly talk to a remote file system.</p></li></ul></li><li><p><strong>Resource consumption:</strong> Bazel’s memory usage is… troublesome. First, because Bazel uses a lot of memory, and second because of the JVM’s heap limits. Newer Bazel versions were able to reduce <em>retained</em> heap memory by 95% after a build and 25-30% overall during a build… but that’s not very useful because <em>peak</em> memory consumption is what matters in many cases. The team is looking at various alternate solutions to tackle this problem:</p><ul><li><p><strong>Skyfocus:</strong> Bazel 8 contains a new feature called Skyfocus, in experimental state. The idea is to perform GC based on a user-defined working set. This is useful in large monorepos where users want to only work on a small portion of the tree, but there are questions about the usability aspects and UX of this solution.</p></li><li><p><strong>Skeletal analysis:</strong> The goal of this work is to try to change the evaluation model to reduce peak memory by 20%. The idea is to trade memory usage for wall time, which means this will be useful for CI but could be harmful for interactive builds.</p></li><li><p><strong>(Remote) Analysis caching:</strong> The loss of the Bazel analysis cache across reconfigurations or server restarts has always been a problem and a major usability annoyance, so this is finally being looked at. The goal is to be able to cache configured targets, aspects, action execution results, and other Bazel-internal state, possibly storing this information in the “standard” remote cache by using a special key. This could also help with a ~70% heap and runtime reduction for analysis phases from cold start, and it could be used to prune entire subgraphs during the execution phase. This would be a massive improvement for IDE interactions, as IDEs primarily rely on analysis-time operations only.</p></li><li><p><strong>Distributed analysis:</strong> The idea is to shard analysis across Bazel workers. This sounds… OK for gigantic monorepos like Google’s but I’m not sure I see the use case outside of that environment. Still in very early stages of discussion.</p></li></ul></li></ul><h1>blzmod and external dependencies</h1><p>The <code>WORKSPACE</code> in Bazel has always been a wart: Google did <em>not</em> have this feature in Blaze but the need to support out-of-tree third-party dependencies became glaringly obvious when they open-sourced Bazel. The <code>WORKSPACE</code> was then bolted on and we have been suffering from its deficiencies for years. bzlmod promises to fix them all, and of course there were talks (and a BoF) on it:</p><ul><li><p><strong>SOTU dependency updates:</strong> bzlmod now provides a vendor mode to download all dependencies of a target or all targets, which is very useful for CI/CD offline builds (e.g. to exercise disaster recovery). <code>MODULE.bazel</code> now has include support and <code>use_repo_rule</code> for easier migration. The lock file format has been revamped to minimize merge conflicts. The <code>WORKSPACE</code> is disabled by default in Bazel 8 and won’t be available in Bazel 9. As for future plans, the repo cache will be shared across workspaces and will include the results of evaluation, not just downloads.</p></li><li><p><strong>SOTU rule updates:</strong> The Python, Android, Java, and shell rules have all moved to Starlark. Protobuf and Android support have moved as well, and this comes with new things like “mobile install v3”. The goal for next year is to complete the Starlarkification effort (with possible new extension points to call into Bazel from the Build API).</p></li><li><p><strong>SOTU Starlark and the Build API:</strong> All struct providers are gone; aspects can propagate to target toolchains; and there are now dormant dependencies for tests. As for upcoming changes: symbolic macros in Bazel 8 (more later); rule finalizers; and types for Starlark (which are compatible with Python 3 but <em>not</em> with Buck).</p></li><li><p><strong>Handling internal artifacts:</strong> It is common for vendors to provide binary blobs that don’t integrate with Bazel. Azul’s JDK is an example. For these, it is interesting to consume them into the build via a workspace repository, but the question then becomes how to do this with bzlmod. The answer is to “layer multiple registries”: you’d have a company-internal registry that exposes these binaries, and then fall back to the BCR for everything else.</p></li><li><p><strong>Disabling the BCR:</strong> For companies that want to have tight control on what they access during the build, it’s perfectly possible to bypass the BCR, either by pointing Bazel to an internal registry or by vendoring sources. The <code>bazel vendor</code> subcommand, which I didn’t know about, can come in handy.</p></li><li><p><strong>Missing packages:</strong> There are some glaring omissions from the BCR right now, which include googleapis, gRPC, and <code>rules_scala</code>. The maintainers of the former are not very cooperative, but progress is being made. As for gRPC, there is a desire to avoid pulling in support for all languages all the time, which makes this technically harder.</p></li></ul><h1>Secure and auditable builds</h1><p>Maintaining the integrity of the software provenance chain is difficult and “recent” events like the <a href=\"https://en.wikipedia.org/wiki/XZ_Utils_backdoor\">XZ Utils Backdoor</a> have shown the criticality of, at least, having an audit trail of what goes into software builds. This is where SBOM and other techniques come into play, and Bazel-based builds are perfectly positioned to provide these assurances:</p><ul><li><p><strong>SBOMs:</strong> There are many different formats to produce a <a href=\"https://www.ntia.gov/page/software-bill-materials\">Software bill of materials (SBOM)</a>, and a few of them like CycloneDX and SPDX are standardized. It’s important that these files are “merge-able” so that, when you import a third-party dependency, you can assemble their own SBOM.</p></li><li><p><strong>Types of targets:</strong> It’s tricky to generate the SBOM, and not all rules to generate one did or do the right thing. For example: do all deps belong in the SBOM? What about deps that say <code>neverlink=1</code>? What about build-time only deps like compilers?</p></li><li><p><strong>Rules:</strong> Bazel has had a <code>licenses</code> package-level function for a long time, but it is insufficient to generate an SBOM. The newer <a href=\"https://github.com/bazelbuild/rules_license\">rules_license</a> offers a much more complete solution to tracking licenses and generating SBOMs.</p></li><li><p><strong>Build assurance:</strong> Other than declaring licenses, it’s important to be able to verify <em>where</em> builds came from. <a href=\"https://slsa.dev/\">SLSA</a> defines various levels that capture different requirements. At the very least, you should target SLSA 2, which requires builds to be produced from trusted environments and to prevent arbitrary users from tampering with those builds (e.g. only allowing uploads to the Action Cache by CI). SLSA 3 is even more strict but RE doesn’t yet provide a mechanism to implement it; there are some talks to support it in V3 and maybe backport it to V2, but no concrete plans yet.</p></li></ul><h1>Symbolic macros</h1><p>Macros are problematic: they tend to cause targets to require public visibility; they tend to pollute the list of available targets in a package (the output of <code>bazel query</code> is unusable); and they have the potential of bloating the build graph massively. There was a full talk from Google on a new feature that’ll make these less of an issue:</p><ul><li><p><strong>New feature:</strong> Bazel 8 ships with <em>symbolic macros</em>, which are first-class citizens of the build graph. Symbolic macros are declared similarly to rules: instead of specifying <code>rule()</code>, you specify <code>macro()</code> and provide a set of attributes and an implementation function. The names of the targets and outputs that these macros produce are constrained to a set of well-defined patterns.</p></li><li><p><strong>Limitations:</strong> One known deficiency is that <code>**kwargs</code> doesn’t work as it used to because there is no way to specify this in an attribute list. The way to mitigate this and make it easier to wrap rules will be attribute inheritance. Similarly, while symbolic macros can lead to lazy expansion, this is not yet implemented. Both of these limitations will be addressed later in the 8.x series.</p></li><li><p><strong>Epilogs:</strong> Legacy macros used to call <code>native.existing_rules()</code> and lead to the “epilog macro” idiom that can be found in large monorepos. These macros are expected to appear at the end of a build file… but there is no way to enforce this. With symbolic macros, this idiom is now a supported feature via the <code>finalizer=True</code> attribute, which then makes these macros be expanded <em>after</em> the full build file has been processed irrespective of any other targets.</p></li><li><p><strong>Downsides:</strong> Symbolic macros were well-received by conference attendees but have received some pushback inside of Google. The reason is that, because these macros will allow lazy evaluation, it’s possible that they’ll encourage even larger packages that only become problematic in some (critical) scenarios.</p></li><li><p><strong>Legacy macros:</strong> There are no plans to remove legacy macros right now—and even if there were, it’d take years to eliminate them due to the need to remain backwards-compatible for multiple releases.</p></li></ul><h1>Queries</h1><p>For people coming from other build systems, the ability to query a build graph may sound like an alien concept. But Bazel has first-class features to do just this, and they can come in handy when writing automation to modify the source tree or to select tests for execution.</p><p>There was a full 30-minute talk dedicated to queries. I do not intend to repeat everything that was said because everything is in <a href=\"https://bazel.build/query/language\">the query documentation</a>… but I did learn a bunch of stuff:</p><ul><li><p><strong>Target provenance:</strong> <code>bazel query --output=build ...</code> shows “fictitious” attributes like <code>generator_{name,function,location}</code> which indicate what produced a target. Useful to understand what macros and globs are doing. These attributes can also be used in filters.</p></li><li><p><strong>Variables:</strong> Queries can have variables in them to avoid repeating complex parts. For example: <code>let v = foo/... in allpaths($v, //common) intersect $v</code>.</p></li><li><p><strong>Removing implicit dependencies:</strong> These often pollute query results with noise and can be removed with <code>--noimplicit_deps</code>. Arguably, this flag should be the default.</p></li><li><p><strong>Graphing:</strong> It is possible to generate a Graphviz file by using <code>--output=graph</code> and then graphing it with <code>dot -Tsvg -o graph.svg</code>. It is important to filter the query or otherwise the resulting graph is overwhelming—aka useless.</p></li><li><p><strong>Running code on the graph:</strong> The <code>cquery</code> command supports <code>--output=starlark --starlark:expr=...</code> which allows running a piece of Starlark code on every target selected by the query. The current target is bound to the <code>target</code> variable. This is useful to, for example, query transitive runtime JARs. And because Starlark is almost Python, you can explore the API by using the <code>dir</code> function with expressions like <code>dir(target)</code> or <code>dir(target.actions)</code>.</p></li><li><p><strong>Action queries:</strong> The <code>aquery</code> command is a different beast from the other queries and allows inspecting the action graph. Something like <code>bazel aquery 'mnemonic(CppCompiler, //...)'</code> shows all inputs, outputs, and command lines for every action. This can be particularly useful to understand toolchain configuration changes.</p></li><li><p><strong>Filtering by file:</strong> The <code>outputs</code> and <code>inputs</code> filters can be used to filter actions by paths: e.g. you can find actions that produce a particular file with <code>outputs(\".*path/to/h\", deps(//...)))</code>. (Beware that the path filter is an anchored regexp.)</p></li><li><p><strong>Performance:</strong> Running many queries in a loop doesn’t scale. Consider building a bigger query if possible and then do post-processing (the opposite advice of when talking to a database server), or using an aspect to dump all info in a single run.</p></li></ul><h1>Linting</h1><p>Back at Google, Jin and I hosted an intern circa 2017 to work on “autolint”: an innovative tool that was supposed to automate running arbitrary lint checks on arbitrary codebases. The project never materialized… but Aspect.dev just announced <a href=\"https://github.com/aspect-build/rules_lint\">rules_lint</a> which basically does the same thing and integrates with Bazel neatly.</p><p>To summarize the talk, <code>rules_lint</code> provides two disjoint features in one:</p><ul><li><p><strong>Formatting:</strong> The goal of formatting is to change a codebase to adhere to predefined standards and stop the bitchering about white space. A quote from the talk I liked was “because while your code might be art… it isn’t ASCII art”.</p><ul><li><p><strong>Broad support:</strong> Supporting formatters is easy, and there are formatters for almost all languages, so a goal here is to try to support as many as possible.</p></li><li><p><strong>Speed:</strong> Formatting must be deterministic and fast so that it can be hooked into the IDE and/or in pre-commit hooks.</p></li><li><p><strong>Not part of the build graph:</strong> It’s tempting to try to hook formatting as an action, but formatting requires unconstrained access to the workspace to modify source files, and many source files that you’d like to lint don’t necessarily have build rules (e.g. Markdown documentation).</p></li><li><p><strong>Implementation:</strong> Formatting relies on <code>rules_multitool</code> which automates the process of downloading a bunch of tools and <code>rules_multirun</code> which allows running multiple tools in parallel.</p></li><li><p><strong>Git blame:</strong> When applying formatting changes, don’t forget to register the commits that did so in <code>.git-blame-ignore-revs</code>. This will prevent your name from showing up in <code>git blame</code> operations as the author of all files.</p></li></ul></li><li><p><strong>Linting:</strong> The goal of linting is to detect potential problems in the code, but the constraints are different: the problems aren’t always conclusive, the solutions aren’t always unique nor safe to apply automatically, and analyzing a file may require analyzing more than one at once.</p><ul><li><p><strong>Speed:</strong> Linting is slow because it often requires using tools akin to compilers. As such, it should never be added to pre-commit hooks and should instead be plumbed through in CI.</p></li><li><p><strong>Implementation:</strong> The desire is to have a uniform interface for linting all languages and don’t want to have extra rules nor modify build files. The obvious answer to this is to use an aspect which then augments existing rules with reports and patches to fix up the source tree. Validation actions were not an option because using them requires modifying the rulesets, and a premise of this work was to <em>not</em> do that.</p></li><li><p><strong>Interface:</strong> Invoking an aspect and handling the resulting patch files is complicated, so Aspect.dev has augmented the Bazel client (the CLI) with an additional <code>lint</code> subcommand that automates this process. Interesting, and I suppose this could be turned into a pluggable mechanism by making Bazel look for <code>bazel-<command></code> binaries at a well-known location (like the <code>git</code> dispatcher does). This reminded me of Twitter’s <a href=\"https://v1.pantsbuild.org/\">Pants</a> build system, which is much more than just for building.</p></li></ul></li></ul><h1>Testing</h1><p>Bazel is often sold as a “build tool” but its secret sauce is that it really is a “test tool”. The true benefits of using Bazel come from realizing that not all tests have to run all the time, and that their results can be safely cached. Various talks touched upon how to do testing effectively:</p><ul><li><p><strong>Profiling data:</strong> Collecting profiling details of tests <em>by default</em>, and exposing these details as test outputs, is very useful because developers can then use this information to understand how to optimize long tests on their own. AirBnB reported that they do this.</p></li><li><p><strong>Test granularity:</strong> We like to think that each test deserves its own test target… but that’s not necessarily how users think or how they interact with tests. Many times, developers end up running certain groups of tests in unison, and if they always do that, combining those tests under a single target will save build and execution time at the expense of a less “pure” dependency graph.</p></li><li><p><strong>Tests in the build:</strong> In certain scenarios, users would like to depend on test outputs as part of the build process. One example that Luminar Technologies provided was the need to generate a detailed report of test results and code coverage for industry compliance reasons. The report generation should be an action that depends on the test outputs, but that’s not doable. As a compromise, they made the tests run as part of the build by replacing <code>cc_test</code> with a macro that spawns a non-test action with a custom runner (but only on CI).</p></li><li><p><strong>Smoke tests:</strong> Related to the previous and during the unconference, Luminar Technologies also brought up the desire to gate parts of the build and test process on “smoke tests”. In other words: once issuing the build/test operation, if we detect that a simple test fails, we shouldn’t continue the build or run any of the more expensive tests. The audience seemed to agree that this belonged into a separate tool. Ulf reminded us that there should still be a flag called <code>--test_keep_going</code>, which can be set to false to stop execution as soon as one test fails.</p></li><li><p><strong>Test selection:</strong> When folks adopt Bazel, their initial approach to CI is to simply do <code>bazel test ...</code> in a job. This works well… until it doesn’t, because even in the presence of test caching, processing the whole monorepo becomes expensive. Uber explains how even an <code>rdeps</code> query becomes expensive and they’ve had to find other solutions. A key insight is that 71% of changes to their monorepo only change source files and only 15% change at least one build file. This means that the majority of changes do not modify the build graph structure significantly, so there is room for reusing state from previous builds (e.g. keeping the Bazel server alive) to compute newly-affected targets.</p></li><li><p><strong>Flaky test granularity:</strong> Bazel detects flakes at the test target level… but a test target can contain tens or hundreds of individual test cases. Which means that if a single test case is flaky and we conclude that its target is flaky, subsequent builds could skip lots of valid test cases. By implementing custom flaky test case detection via <code>junit.xml</code> report files, Uber was able to surface 3500 additional tests that would have been skipped by the naive target-based approach and could re-add those to the build.</p></li><li><p><strong>Profile-guided test execution:</strong> In large test invocations, it’s common for one test to be the long pole. If by lack of luck this test ends up running last, it ends dragging the critical path of the test run and lengthening the p99 of test executions. It’d be nice if Bazel supported “profile-guided execution” so that such long poles could be scheduled earlier. Jin reported that this has been looked at but one problem is that there hasn’t been a good place to store this information across invocations. Ulf mentioned that when we have async action execution (which Java 21 makes possible), we should be able to improve action scheduling and implement this.</p></li><li><p><strong>Actions per test:</strong> One interesting detail that Ulf shared is that test targets generate three actions, possibly more: one to execute the test itself, another to generate the <code>junit.xml</code> file if the test failed to do so, and another to perform coverage post-processing. If retries, sharding, or <code>--runs_per_test</code> are involved, there can be even more actions. So, if it becomes necessary, there is precedent to add more actions to perform other types of post-processing.</p></li><li><p><strong>CI runners:</strong> A topic that came up during the unconference was that starting Bazel on CI runners is very painful because of the need to download repos, repopulate the local disk cache, and rebuild the analysis graph. The general advice is to prevent discarding CI runners across builds, but that’s not always possible (e.g. security might not like to share runners across different jobs). For Kubernetes, stateful sets provide a mechanism to preserve the disk cache even during auto-scaling.</p></li></ul><h1>Missing tooling around Bazel</h1><p>A fun topic that arose in the unconference was: “what support tools do you wish Google had open sourced when they published Bazel, or that the community had built?” There were many ideas from the audience:</p><ul><li><p><strong>Scripting language for use in genrules:</strong> Writing genrules that work across systems is difficult because they invoke the shell, and the tools that are often called do not always support the same syntax (<a href=\"https://jmmv.dev/2021/08/useless-use-of-gnu.html\">thanks GNU</a>). It’d be nice to have a language that allowed writing genrules in a platform-agnostic way. WASM was brought up as well as having a Starlark interpreter with file system access.</p></li><li><p><strong>Affected target determination:</strong> The goal of this tool would be to answer the question of which targets are impacted by a change to the source tree. <a href=\"https://github.com/Tinder/bazel-diff\">bazel-diff</a> more or less does this. An <code>rdeps</code> query sounds like the right solution, but in practice it is tricky because changes to a toolchain aren’t visible in a query; they do show up in <code>cquery</code> though, but then you have to be aware of all possible configurations to do the determination correctly.</p></li><li><p><strong>Build queuing:</strong> The goal here is to have a service that can queue entire builds and not just actions. This might exist in some CI systems already.</p></li><li><p><strong>Unifying bazelisk with bazel:</strong> Users are confused with the fact that <code>sudo apt install bazel</code> is available but generally does the wrong thing, and that it’d be good if <code>bazelisk</code>’s features existed within Bazel. I explained that we built something similar to <code>bazelisk</code> at Snowflake but for arbitrary tools as a way to hijack command line executions and redirect them to checked-in tools; maybe we should open-source it.</p></li><li><p><strong>buildozer for bzl files:</strong> Automating edits to <code>bzl</code> files would be handy, although this is a hard problem. Maybe it could be scoped down to e.g. automatically clean up old repository rules that aren’t referenced.</p></li><li><p><strong>Java library to programmatically edit build and </strong><code>bzl</code><strong> files:</strong>. The current Starlark library isn’t useful because it’s not standalone and it doesn’t preserve the original file structure. A workaround is to extract the AST from Python because these files remain syntactically valid from Python’s perspective.</p></li><li><p><strong>Documentation website for all the rules:</strong> The BCR could fulfill this, but it currently does not have links to documentation.</p></li></ul><h1>The end</h1><p>And finally, here are the few leftover toughts that I did not know how to fit in any of the sections above:</p><ul><li><p><strong>Nix:</strong> There were many talks about Nix on the original submissions, but only a couple made it to the final schedule. The folks at Modus Crate described how they use <code>rules_nixpkgs</code> to build external dependencies and how they stage those in an NFS-shared <code>/nix/store/</code> tree. Because Bazel invokes Nix and stages the dependencies during its external repository phase, the execution phase and the remote workers can assume that the Nix packages are in the right locations and things just work.</p></li><li><p><strong>RPM integration:</strong> In a similar spirit to using Nix to install packages and/or build containers, we also have <a href=\"https://github.com/rmohr/bazeldnf\">bazeldnf</a>. This ruleset provides the <code>rpm</code> repository rule to import RPM packages and the <code>rpmtree</code> build rule to combine one or more RPM into a tarball that can later be fed to other rules like <code>container_layer</code>. In this context, you might also be interested in the <a href=\"https://github.com/NixOS/patchelf\">patchelf</a> ruleset.</p></li><li><p><strong>Migrations:</strong> Migration talks are getting old, but there were some good insights from MongoDB’s talk. One such insight was that, as in any software rewrite, the “old” build system doesn’t stay still during a migration, and the set of features to migrate grows over time. Another such insight was that, if you can couple the new build system to the old one (by making one rely on the other for increasing portions of the code), you can minimize the time in which new features get added to the old build and not the new one. The downside is that you’ll be building throwaway work, but overall it will pay off.</p></li><li><p><strong>My talk about Snowflake:</strong> I gave a 15-minute “migration” talk about what we are doing with Bazel at Snowflake. Because of what I said just above, I skipped over all of the migration topics and instead focused on explaining 5 different technical challenges that we faced and how we fixed them. I was met with lots of questions after the talk, which was really nice, but which means that we owe a full migration post when we are done (very soon now!).</p></li></ul><p>I hear you want the raw notes? Are you sure? I really don’t recommend that you look… but if you must, here they are: <a href=\"https://jmmv.dev/notes/2024-10-14-bazelcon.md\">BazelCon day 1 notes</a>, <a href=\"https://jmmv.dev/notes/2024-10-15-bazelcon.md\">BazelCon day 2 notes</a>, and the <a href=\"https://jmmv.dev/notes/2024-10-16-build-meetup.md\">Build Meetup’s notes</a>.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">I hope that you enjoyed this 4o-minute long summary of 3 long conference days. The way to “pay back” is, simply, to hit subscribe! And yes, it’s free.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7faba93e-6453-4937-a7ff-79d12789902d_1456x1048.jpeg" "0.0" "image/jpeg") nil "42e1d28facc9fa38d11662f214e97000") (12 (26569 31003 260988 430000) "https://blogsystem5.substack.com/p/x86-64-programming-models" "The costs of the i386 to x86-64 upgrade" "Julio Merino" "Mon, 07 Oct 2024 16:03:08 +0000" "<p>If you read my previous article on <a href=\"https://blogsystem5.substack.com/p/dos-memory-models\">DOS memory models</a>, you may have dismissed everything I wrote as “legacy cruft from the 1990s that nobody cares about any longer”. After all, computers have evolved from sporting 8-bit processors to 64-bit processors and, on the way, the amount of memory that these computers can leverage has grown orders of magnitude: the 8086, a 16-bit machine with a 20-bit address space, could only use 1MB of memory while today’s 64-bit machines can theoretically access 16EB.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":992004,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>All of this growth has been in service of ever-growing programs. But… even if programs are now more sophisticated than they were before, do they all <em>really</em> require access to a 64-bit address space? Has the growth from 8 to 64 bits been a net positive in performance terms?</p><p>Let’s try to answer those questions to find some very surprising answers. But first, some theory.</p><h1>Code density</h1><p>An often overlooked property of machine code is <em>code density</em>, a loose metric that quantifies how many instructions are required to execute a given “action”. I double-quote action because an “action” in this context is a subjective operation that captures a programmer-defined outcome.</p><p>Suppose, for example, that you want to increment the value of a variable that resides in main memory, like so:</p><pre><code><code>static int a;
// ...
a = a + 1;</code></code></pre><p>On a processor with an ISA that provides complex instructions and addressing modes, you can potentially do so in just one machine instruction:</p><pre><code><code>; Take the 32-bit quantity at the address indicated by the
; 00001234h immediate, increment it by one, and store it in the
; same memory location.
add dword [1234h], 1</code></code></pre><p>In contrast, on a processor with an ISA that strictly separates memory accesses from other operations, you’d need more steps:</p><pre><code><code>li  r8, 1234h   ; Load the address of the variable into r8.
lm  r1, r8      ; Load the content of the address into r1.
li  r2, 1       ; Load the immediate value 1 into r2.
add r3, r1, r2  ; r3 = r1 + r2
sm  r8, r3      ; Store the result in r3 into the address in r8.</code></code></pre><p>Which ISA is better, you ask? Well, as usual, there are pros and cons to each approach:</p><ul><li><p>The former type of ISA offers a denser representation of the operation so it can fit more instructions in less memory. But, because of the semantic complexity of each individual instruction, the processor has to do more work to execute them (possibly requiring more transistors and drawing more power). This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Complex_instruction_set_computer\">CISC</a>.</p></li><li><p>The latter type of ISA offers a much more verbose representation of the operation but the instructions that the processor executes are simpler and can likely be executed faster. This type of ISA is usually known as <a href=\"https://en.wikipedia.org/wiki/Reduced_instruction_set_computer\">RISC</a>.</p></li></ul><p>This is the eternal debate between CISC and RISC but note that the distinction between the two is not crystal clear: some RISC architectures support <em>more</em> instructions that CISC architectures, and contemporary Intel processors translate their CISC-style instructions into internal RISC-style <a href=\"https://en.wikipedia.org/wiki/Intel_microcode\">micro-operations</a> immediately after decoding the former.</p><h1>It’s the bytes that matter</h1><p>Code density is not about instruction <em>count</em> though. Code density is about the <em>aggregate size</em>, in bytes, of the instructions required to accomplish a specific outcome.</p><p>In the example I presented above, the single CISC-style <code>mov</code> x86 instruction is encoded using anywhere from 2 to 8 bytes depending on its arguments, whereas the fictitious RISC-style instructions typically take 4 bytes each. Therefore, the CISC-style snippet would take 8 bytes total whereas the RISC-style snippet would take 20 bytes total, while achieving the same conceptual result.</p><p>Is that increase in encoded bytes bad? Not necessarily because “bad” is subjective and we are talking about trade-offs here, but it’s definitely an important consideration due to its impact in various dimensions:</p><ul><li><p><strong>Memory usage</strong>: Larger programs take more memory. You might say that memory is plentiful these days, and that’s true, but it wasn’t always the case: when computers could only address 1 MB of RAM or less, the size of a program’s binary mattered a lot. Furthermore, even today, memory <em>bandwidth</em> is limited, and this is an often-overlooked property of a system.</p></li><li><p><strong>Disk space</strong>: Larger programs take more disk space. You might say that disk space is plentiful these days too and that program code takes a tiny proportion of the overall disk: most space goes towards storing media anyway. And that’s true, but I/O bandwidth is not as unlimited as disk space, and loading these programs from disk isn’t cheap. Have you noticed how utterly slow is it to open an Electron-based app?</p></li><li><p><strong>L1 thrashing</strong>: Larger or more instructions mean that you can fit fewer of them in the L1 instruction cache. Proper utilization of this cache is critical to achieve reasonable levels of computing performance, and even though main memory size can now be measured in terabytes, the L1 cache is still measured in kilobytes.</p></li></ul><p>We could beat the dead horse over CISC vs. RISC further but that’s not what I want to focus on. What I want to focus on is one very specific dimension of the instruction encoding that affects code density in all cases. And that’s the <em>size of the addresses</em> (pointers) required to reference program code or data.</p><p>Simply put, the larger the size of the addresses in the program’s code, the lower the code density. The lower the code density, the more memory and disk space we need. And the more memory code takes, the more L1 thrashing we will see.</p><p>So, for good performance, we probably want to optimize the way we represent addresses in the code and take advantage of surrounding context. For example: if we have a tight loop like this:</p><pre><code><code>static int a;
...
for (int i = 0; i < 100; i++) {
a = a + 1;
}</code></code></pre><p>The corresponding assembly code may be similar to this:</p><pre><code><code>        mov ecx, 0             ; i = 0.
repeat: cmp ecx, 100           ; i < 100?
je  out                ; If i == 100, jump to out.
add dword [01234h], 1  ; Increment a.
add ecx, 1             ; i++.
jmp repeat             ; Jump back to repeat.
out:</code></code></pre><p>Now the questions are:</p><ul><li><p>Given that <code>repeat</code> and <code>out</code> are labels for memory addresses, how do we encode the <code>je</code> (jump if equal) and <code>jmp</code> (unconditional jump) instructions as bytes? On a 32-bit machine, do we encode the full 32-bit addresses (4 bytes each) in each instruction, or do we use 1-byte relative short pointers because the jump targets are within a 127-byte distance on either side of the jump instruction?</p></li><li><p>How do we represent the address of the <code>a</code> variable? Do we express it as an absolute address or as a relative one? Do we store <code>1234h</code> as a 32-bit quantity or do we use fewer bytes because this specific number is small?</p></li><li><p>How big should <code>int</code> be? The <code>dword</code> above implies 32 bits but… that’s just an assumption I made when writing the snippet. <code>int</code> could have been 16 bits, or 64 bits, or anything else you can imagine (which is a design mistake in C, if you ask me).</p></li></ul><p>The answers to the questions above are <em>choices</em>: we can decide whichever encoding we want for code and data addresses, and these choices have consequences on code density. This was true many years ago during the DOS days, which is why we had short, near, and far pointer types, and <a href=\"https://web.eece.maine.edu/~vweaver/papers/iccd09/iccd09_density.pdf\">is still true today</a> as we shall see.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Are you finding this interesting? If so, subscribe to Blog System/5 to receive more goodness in your inbox. It’s free, but paid donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The switch to 32 bits</h1><p>It is no secret that programming 16-bit machines was limiting, and we can identify at least two reasons to back this claim.</p><p>First, 16-bit machines usually had limited address spaces. It’s important to understand that a processor’s native register size has no direct connection to the size of the addresses the processor can reference. In theory, these machines could have leveraged larger chunks of memory and, in fact, the 16-bit 8086 proved this to be true with its 20-bit address space. But the point is that, <em>in the era</em> of 16-bit machines, 1 MB of RAM was considered “a lot” and so machines didn’t have much memory.</p><p>Second, 16-bit machines can only operate on 16-bit quantities at a time, and 16 bits only allow representing integers with limited ranges: a signed number between -32K and +32K isn’t… particularly large. Like before, it’s important to clarify that the processor’s native register size does not impose restrictions on the size of the numbers the processor can manipulate, but it does add limitations on how <em>fast</em> it can do so: operating 32-bit numbers on 16-bit machines requires at least twice the number of instructions for each operation.</p><p>So, when 32-bit processors entered the scene, it was pretty much a no-brainer that programs had to become 32-bit by default: all memory addresses and default integer types grew to 32 bits. This allowed programmers to not worry about memory limits for a while: 32 bits can address 4GB of memory, which was a huge amount back then and should <em>still</em> be huge if it wasn’t due to bloated software. Also, this upgrade allowed programmers to efficiently manipulate integers with large-enough ranges for most operations.</p><p>In technical mumbo-jumbo, what happened here was that C adopted the ILP32 programming model: integers (I), longs (L), and pointers (P) all became 32 bits, whereas chars and shorts remained 8-bit and 16-bit respectively.</p><p>It didn’t have to be this way though: if we look at the model for 16-bit programming, shorts and integers were 16-bit whereas longs were 32-bit, so why did integers change size but longs remained the same as integers? I do not have an answer for this, but if longs had become 64 bits back then, maybe we wouldn’t be in the situation today where <a href=\"https://en.wikipedia.org/wiki/Year_2038_problem\">2038 will bring mayhem to Unix systems</a>.</p><h1>Evolving towards x86-64</h1><p>4GB of RAM were a lot when 32-bit processors launched but slowly became insufficient as software kept growing. To support those needs, there were crutches like <a href=\"https://en.wikipedia.org/wiki/Physical_Address_Extension\">Intel’s PAE</a>, which allowed manipulating up to 64GB of RAM on 32-bit machines without changing the programming model, but they were just that: hacks.</p><p>The thing is: it’s not only software that grew. It’s the <em>kinds of things</em> that people wanted to do with software that changed: people wanted to edit high-resolution photos and video as well as play more-realistic games, and writing code to achieve those goals on a limited 4GB address space was possible but not <em>convenient</em>. With 64-bit processors, <code>mmap</code>ing huge files made those programs easier to write, and using native 64-bit integers made them faster too. So 64-bit machines became mainstream sometime around the introduction of the Athlon 64 processor and the Power Mac G5, both in 2003.</p><p>So what happened to the programming model? ILP32 was a no-brainer for 32-bit machines, but were LP64 or ILP64 no-brainers for 64-bit machines? These 64-bit models were definitely tempting because they allowed the programmer to leverage the machine’s resources freely. Larger pointers allowed addressing “unlimited” memory transparently, and a larger long type naturally bumped file offsets (<code>ino_t</code>), timestamps (<code>time_t</code>), array lengths (<code>size_t</code>), and more to 64 bits as well. Without a lot of work from programmers, programs could “just do more” by simply recompiling them.</p><p>But there was a downside to that choice. According to the theory I presented earlier, LP64 would make programs bigger and would decrease code density when compared to ILP32. And lower code density could lead to L1 instruction cache thrashing, which is an important consideration to this day because a modern Intel Core i7-14700K from 2023 has just 80 KB of L1 cache and an Apple Silicon M3 from 2023 has less than 200KB. (These numbers are… <em>not big</em> when you stack them up against the multi-GB binaries that comprise modern programs, are they?)</p><p>We now know that LP64 was the preferred choice and that it became the default programming model for 64-bit operating systems, which means we can compare its impact against ILP32. So what are the consequences? Let’s take a look.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\" width=\"1363\" height=\"844\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":844,\"width\":1363,\"resizeWidth\":null,\"bytes\":37898,\"alt\":\"Comparison of ISO image sizes for various operating systems\",\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"Comparison of ISO image sizes for various operating systems\" title=\"Comparison of ISO image sizes for various operating systems\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6fda7a33-31e0-4cca-ba1c-dda557984d47_1363x844.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Wait, what? The FreeBSD x86-64 installation image is definitely larger than the i386 one… but all other images are <em>smaller</em>? What’s going on here? This contradicts everything I said above!</p><h1>Down the rabbit hole</h1><p>I was genuinely surprised by this and I had to dig a bit. Cracking open the FreeBSD bootonly image revealed some differences in the kernel (slightly bigger binaries, but different sets of modules) which made it difficult to compare the two. But looking into the Debian netinst images, I did find that almost all i386 binaries were larger than their x86-64 counterparts.</p><p>To try to understand why that was, the first thing I did was compile a simple hello-world program on my x86-64 Debian VM, targeting both 64-bit and 32-bit binaries:</p><pre><code><code>$ gcc-14 -o hello64 hello.c
$ i686-linux-gnu-gcc-14 -o hello32 hello.c
$ file hello32 hello64
hello32: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, not stripped
hello64: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=f1bf851d7f1d56ae5d50eb136793066f67607e06, for GNU/Linux 3.2.0, not stripped
$ ls -l hello32 hello64
-rwxrwxr-x 1 jmmv jmmv 15040 Oct  4 17:45 hello32
-rwxrwxr-x 1 jmmv jmmv 15952 Oct  4 17:45 hello64
$ █</code></code></pre><p>Based on this, it <em>looks</em> as if 32-bit binaries are indeed smaller than 64-bit binaries. But a “hello world” program is trivial and not worth 15kb of code: those 15kb shown above are definitely <em>not</em> code. They are probably mostly ELF overhead. Indeed, if we look at just the text portion of the binaries:</p><pre><code><code>$ objdump -h hello32 | grep text
14 .text         00000169  00001060  00001060  00001060  2**4
$ objdump -h hello64 | grep text
14 .text         00000103  0000000000001050  0000000000001050  00001050  2**4
$ █</code></code></pre><p>… we find that <code>hello32</code>’s text is 169h bytes whereas <code>hello64</code>’s text is 103h bytes. And if we disassemble the two:</p><pre><code><code>$ objdump --disassemble=main hello32
...
00001189 <main>:
1189:       8d 4c 24 04             lea    0x4(%esp),%ecx
118d:       83 e4 f0                and    $0xfffffff0,%esp
1190:       ff 71 fc                push   -0x4(%ecx)
1193:       55                      push   %ebp
1194:       89 e5                   mov    %esp,%ebp
1196:       53                      push   %ebx
1197:       51                      push   %ecx
1198:       e8 28 00 00 00          call   11c5 <__x86.get_pc_thunk.ax>
119d:       05 57 2e 00 00          add    $0x2e57,%eax
11a2:       83 ec 0c                sub    $0xc,%esp
11a5:       8d 90 14 e0 ff ff       lea    -0x1fec(%eax),%edx
11ab:       52                      push   %edx
11ac:       89 c3                   mov    %eax,%ebx
11ae:       e8 8d fe ff ff          call   1040 <puts@plt>
11b3:       83 c4 10                add    $0x10,%esp
11b6:       b8 00 00 00 00          mov    $0x0,%eax
11bb:       8d 65 f8                lea    -0x8(%ebp),%esp
11be:       59                      pop    %ecx
11bf:       5b                      pop    %ebx
11c0:       5d                      pop    %ebp
11c1:       8d 61 fc                lea    -0x4(%ecx),%esp
11c4:       c3                      ret
...
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ █</code></code></pre><p>We observe massive differences in the machine code generated for the trivial <code>main</code> function. The 64-bit code is definitely <em>smaller</em> than the 32-bit code, contrary to my expectations. But the code is also <em>very</em> different; so different, in fact, that ILP32 vs. LP64 doesn’t explain it.</p><p>The first difference we can observe is around calling conventions. The i386 architecture has a limited number of registers, favors passing arguments via the stack, and only 3 registers can be clobbered within a function. x86-64, on the other hand, prefers passing arguments through registers as much as possible and defines 7 registers as volatile.</p><p>The second difference is that we don’t see 64-bit addresses anywhere in the code above. Jump addresses are encoded using near pointers, and data addresses are specified as offsets over a 64-bit base previously stored in a register. I found it smart that those addresses are relative to the program counter (the RIP register).</p><p>There may be more differences, but these two alone seem to be the reason why 64-bit binaries end up being more compact than 32-bit ones. <em>On Intel x86</em>, that is. You see: Intel x86’s instruction set is so versatile that the compiler and the ABI can play tricks to hide the cost of 64-bit pointers.</p><p>Is that true of more RISC-y 64-bit architectures though? I installed the PowerPC 32-bit and 64-bit toolchains and ran the same test. And guess what? The PowerPC 64-bit binary was indeed larger than the 32-bit one, so <em>maybe</em> it’s true. Unfortunately, running a broader comparison than this is difficult: there is no full operating system I can find that ships both builds any longer, and ARM images can’t easily be compared.</p><h1>It’s all about the data</h1><p>OK, fine, we’ve settled that 64-bit <em>code</em> isn’t necessarily larger than 32-bit code, at least on Intel, and thus any adverse impact on the L1 instruction cache is probably negligible. But… what about <em>data density</em>?</p><p>Pointers don’t only exist in instructions or as jump targets. They also exist within the most modest of data types: lists, trees, graphs… all contain pointers in them. And in those, unless the programmer explicitly plays complex <a href=\"https://v8.dev/blog/pointer-compression\">tricks to compress pointers</a>, we’ll usually end up with larger data structures by simply jumping to LP64. The same applies to the innocent-looking <code>long</code> type by the way, which appears throughout codebases and also grows with this model.</p><p>And <em>this</em>—a decrease in data density—is where the real performance penalty comes from: it’s not so much about the code size but about the data size.</p><p>Let’s take a look. I wrote a simple program that creates a linked list of integers with 10 million nodes and then iterates over them in sequence. Each node is 8 bytes in 32-bit mode (4 bytes for the <code>int</code> and 4 bytes for the <code>next</code> pointer), whereas it is 16 bytes in 64-bit mode (4 bytes for the <code>int</code>, <em>4 bytes of padding</em>, and 8 bytes for the <code>next</code> pointer). I then compiled that program in 32-bit and 64-bit mode, measured it, and ran it:</p><pre><code><code>$ gcc -o list64 list.c
$ i686-linux-gnu-gcc-14 -o list32 list.c
$ objdump -h list32 | grep text
13 .text         000001f6  00001070  00001070  00001070  2**4
$ objdump -h list64 | grep text
14 .text         000001b0  0000000000001060  0000000000001060  00001060  2**4
$ hyperfine --warmup 1 ./list32 ./list64
Benchmark 1: ./list32
Time (mean ± σ):     394.2 ms ±   2.1 ms    [User: 311.4 ms, System: 83.1 ms]
Range (min … max):   392.1 ms … 398.2 ms    10 runs
Benchmark 2: ./list64
Time (mean ± σ):     502.4 ms ±   4.5 ms    [User: 334.9 ms, System: 167.8 ms]
Range (min … max):   494.9 ms … 509.5 ms    10 runs
Summary
./list32 ran
1.27 ± 0.01 times faster than ./list64
$ █</code></code></pre><p>As before with the hello-world comparison, this simple microbenchmark’s 32-bit code continues to be slightly larger than its 64-bit counterpart (1F6h bytes vs 1B0h). However, its runtime is <em>27% faster</em>, and it is no wonder because the doubling of the linked list node size implies doubling the memory usage and thus the halving of cache hits. We can confirm the impact of this using the <code>perf</code> tool:</p><pre><code><code>$ perf stat -B -e cache-misses ./list32 2>&1 | grep cpu_core
2,400,339      cpu_core/cache-misses:u/      (99.33%)
$ perf stat -B -e cache-misses ./list64 2>&1 | grep cpu_core
4,687,156      cpu_core/cache-misses:u/      (99.34%)
$ █</code></code></pre><p>The 64-bit build of this microbenchmark incurs almost double the cache misses than the 32-bit build.</p><p>Of course, this is just a microbenchmark, and tweaking it slightly will make it show very different results and make it say whatever we want. I tried to add jitter to the memory allocations so that the nodes didn’t end up as consecutive in memory, and then the 64-bit version executed faster. I suspect this is due to the memory allocator having a harder time handling memory when the address space is limited.</p><p>The impact on real world applications is harder to quantify. It is difficult to find the same program built in 32-bit and 64-bit mode and to run it on the same kernel. It is even more difficult to find one such program where the difference matters. But at the end of the day, the differences exist, and I bet they are more meaningful than we might think in terms of bloat—but I did not intend to write a research paper here, so I’ll leave that investigation to someone else… or another day.</p><h1>The x32 ABI</h1><p>There is one last thing to discuss before we depart. While we find ourselves using the LP64 programming model on x86-64 processors, remember that this was a choice and there were and are other options on the table.</p><p>Consider this: we could have made the operating system kernel leverage 64 bits to gain access to a humongous address space, but we could have kept the user-space programming model as it was before—that is, we could have kept ILP32. And we could have gone even further and optimized the calling conventions to reduce the binary code size by leveraging the additional general-purpose registers that x86-64 provides.</p><p>And in fact, this exists and is known as <a href=\"https://en.wikipedia.org/wiki/X32_ABI\">x32</a>.</p><p>We can install the x32 toolchain and see that it effectively works as we’d imagine:</p><pre><code><code>$ gcc -o hello64 hello.c
$ x86_64-linux-gnux32-gcc-14 -o hellox32 hello.c
$ objdump --disassemble=main hello64
...
0000000000001139 <main>:
1139:       55                      push   %rbp
113a:       48 89 e5                mov    %rsp,%rbp
113d:       48 8d 05 c0 0e 00 00    lea    0xec0(%rip),%rax        # 2004 <_IO_stdin_used+0x4>
1144:       48 89 c7                mov    %rax,%rdi
1147:       e8 e4 fe ff ff          call   1030 <puts@plt>
114c:       b8 00 00 00 00          mov    $0x0,%eax
1151:       5d                      pop    %rbp
1152:       c3                      ret
...
$ objdump --disassemble=main hellox32
...
00401126 <main>:
401126:       55                      push   %rbp
401127:       89 e5                   mov    %esp,%ebp
401129:       b8 04 20 40 00          mov    $0x402004,%eax
40112e:       89 c0                   mov    %eax,%eax
401130:       48 89 c7                mov    %rax,%rdi
401133:       e8 f8 fe ff ff          call   401030 <puts@plt>
401138:       b8 00 00 00 00          mov    $0x0,%eax
40113d:       5d                      pop    %rbp
40113e:       c3                      ret
...
$ █</code></code></pre><p>Now, the <code>main</code> method of our hello-world program is really similar between the 64-bit and 32-bit builds, but pay close attention to the x32 version: it uses the same calling conventions as x86-64, but it contains a mixture of 32-bit and 64-bit registers, delivering a more compact binary size.</p><p>Unfortunately:</p><pre><code><code>$ ./hellox32
zsh: exec format error: ./hellox32
$ █</code></code></pre><p>We can’t run the resulting binary. x32 is an ABI that impacts the kernel interface too, so these binaries cannot be executed on a regular x86-64 kernel. Sadly, and as far as I can tell, x32 is pretty much abandonware today. Gentoo claims to support it but there are no official builds of any distribution I can find that are built in x32 mode.</p><div><hr></div><p>In the end, even though LP64 <a href=\"https://unix.org/version2/whatsnew/lp64_wp.html\">wasn’t the obvious choice</a> for x86-64, it’s the compilation mode that won and stuck.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Phew, that was a lot! And you know what? Writing this took a really long time too. Subscribe now to show your support!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F7ea4b5bd-f26f-418d-96d3-0d3936356eed_2048x2048.jpeg" "0.0" "image/jpeg") nil "8a4dc5b8014ff235cb8824b0e98e709b") (11 (26569 31003 258766 382000) "https://blogsystem5.substack.com/p/dos-memory-models" "Revisiting the DOS memory models" "Julio Merino" "Mon, 30 Sep 2024 15:02:25 +0000" "<p>At the beginning of the year, I wrote a <a href=\"https://blogsystem5.substack.com/p/from-0-to-1-mb-in-dos\">bunch</a> <a href=\"https://blogsystem5.substack.com/p/beyond-the-1-mb-barrier-in-dos\">of</a> <a href=\"https://blogsystem5.substack.com/p/running-gnu-on-dos-with-djgpp\">articles</a> on the various tricks DOS played to overcome the tight memory limits of x86’s real mode. There was one question that came up and remained unanswered: what were the various “models” that the compilers of the day offered? Take a look at Borland Turbo C++’s code generation menu:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":140059,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Borland Turbo C++ showing its Code Generation menu, which displays the list of models we cover in this article.</figcaption></figure></div><p>Tiny, small, medium, compact, large, huge… What did these options mean? What were their effects? And, more importantly… is any of that legacy relevant today in the world of 64-bit machines and gigabytes of RAM? To answer those questions, we must start with a brief review of the 8086 architecture and the binary formats supported by DOS.</p><h1>8086 segmentation</h1><p>In the 8086 architecture, which is the architecture that DOS targeted, memory references are composed of two parts: a <strong>2-byte segment</strong> “identifier” and a <strong>2-byte offset</strong> within the segment. These pairs are often expressed as <code>segment:offset</code>.</p><p>Segments are contiguous 64KB chunks of memory and are identified by their base address. To be able to address the full 1MB of memory that the 8086 supports, segments are offset from each other by 16 bytes. As you can deduce from this, segments overlap, which means that a specific physical memory position can be referenced by many segment/offset pairs.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\" width=\"1456\" height=\"590\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":590,\"width\":1456,\"resizeWidth\":null,\"bytes\":64437,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ad9400d-9813-4b87-b69f-dc0ed449aa46_2370x960.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of two consecutive 8086 segments and how a single physical memory address can be expressed as different segment/offset pairs.</figcaption></figure></div><p>As an example, the segmented address <code>B800h:0032h</code> corresponds to the physical address <code>B8032h</code> computed via <code>B800h * 10h + 0032h</code>. While this pair is human-readable, that’s not how the machine-level instructions encode it. Instead, instructions rely on <strong>segment registers</strong> to specify the segment to access, and the 8086 supports four of these: CS (code segment), DS (data segment), ES (extra data segment), and SS (stack segment). Knowing this, accessing this sample memory position requires first loading <code>B800h</code> into <code>DS</code> and then referencing <code>DS:0032h</code>.</p><p>One of the reasons instructions rely on segment registers instead of segment identifiers on every memory access is efficiency: encoding the segment register to use requires only 2 bits (we have 4 segment registers in total) vs. the 2 bytes that would be necessary to store the segment base. More on this later.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">More means “the next article” because there is a lot of ground to cover to explain how this connects to today’s 64-bit world. Subscribe to Blog System/5 to not miss it!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>COM files</h1><p><a href=\"https://en.wikipedia.org/wiki/COM_file\">COM files</a> are the most trivial executable format you can think of: they contain raw machine code that can be placed at pretty much any memory location and executed without any sort of post-processing. There are no relocations, no shared libraries, no nothing to worry about: you can just blit the binary into memory and run it.</p><p>The way this works is by leveraging the 8086 segmented architecture: the COM image is loaded into <em>any</em> segment and always at offset 100h within that segment. All memory addresses within the COM image must be relative to this offset (which explains the <code>ORG 100h</code> you might have seen in the past), but the image doesn’t need to know which segment it is loaded into: the loader (DOS in our case, but COM files come from CP/M actually) sets CS, DS, ES, and SS to the exact same segment and transfers control to <code>CS:100h</code>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\" width=\"1456\" height=\"809\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":809,\"width\":1456,\"resizeWidth\":null,\"bytes\":160575,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F52197e20-826c-4098-81fb-cf77218daf70_2160x1200.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">At the top, representation of a COM file as it is stored on disk. At the bottom, an explanation of how DOS proceeds to load this COM file into two different segments.</figcaption></figure></div><p>Magic! COM files are essentially PIE (<a href=\"https://en.wikipedia.org/wiki/Position-independent_code\">Position Independent Executables</a>) without requiring any sort of MMU or fancy memory management by the kernel.</p><p>Unfortunately, not everything is rosy. The problem with COM files is that they are limited in size: because they are loaded into one segment and segments are 64KB-long at most, the largest a COM file can be is 64KB (minus the 256 bytes reserved for the PSP at the front). This includes code <em>and</em> data, and 64KB isn’t much of either. Obviously, when the COM program is running, it has free reign over the processor and can access any memory outside of its single segment by resetting CS, DS, ES, and/or SS, but all memory management is left to the programmer.</p><h1>EXE files</h1><p>To resolve the limitations of COM files in DOS, Microsoft came up with a different executable format for DOS: the <a href=\"https://en.wikipedia.org/wiki/DOS_MZ_executable\">EXE file</a>, also known as an MZ executable.</p><p>Compared to COM files, EXE files have some internal structure and are not bound by the 64KB limit: they can contain larger code and data blocks in them. But… how is that possible given that 8086 segments are still 64KB-long at most? The answer is simple: EXE files contain <em>multiple</em> segments and spread code and data over them.</p><p>To support multiple segments at runtime, EXE files contain relocation information in their header. Conceptually, relocations tell the loader which positions in the binary image contain “incomplete” pointers that need to be fixed up with the segment base addresses of the segments after they are loaded in memory. DOS, acting as the loader, is responsible for doing this patching.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\" width=\"1456\" height=\"451\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":451,\"width\":1456,\"resizeWidth\":null,\"bytes\":107229,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8baf9777-a52c-4956-8c39-a5cdec8dbf74_2520x780.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an EXE file and the content of one of its code segments. Within the code, we can see a near pointer and two far pointers that will require patching at runtime to point to the other segments in the binary.</figcaption></figure></div><p>How many segments go into the EXE though? Well, it depends, because not all programs have the same needs. Some programs are tiny overall and could fit in a COM file. Other programs contain large portions of data but little code. Another set of programs contain a lot of code and data. Etc.</p><p>So then the question becomes: how can the one-size-fits-all EXE format support these options in an efficient manner? This is where memory models become important, but to talk about those, we must do another detour through pointer types.</p><h1>Pointer types</h1><p><a href=\"https://en.wikipedia.org/wiki/Locality_of_reference\">The locality principle</a> says that “a processor tends to access the same set of memory locations repetitively over a short period of time”. This is easy to reason about: code normally runs almost-sequentially and data is often packed in consecutive chunks of memory like arrays or structs.</p><p>Because of this, expressing <em>all</em> memory addresses as 4-byte <code>segment:offset</code> pairs would be wasteful, and this is where 8086’s segmentation plays in our favor again. We can first load a segment register with the base address of “all of our data” and then all we need to do is record addresses as offsets within that segment. The fewer times we have to reload segment registers, the better because the less information we have to carry around in every instruction and in every memory reference.</p><p>But we can’t just always use offsets within a single segment because we may be dealing with more than one segment. And offsets come in various sizes so using a unique size for them all would be wasteful too. Which means memory addresses, or <em>pointers</em>, need to have different shapes and forms, each best suited for a specific use case.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":32700,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2b866b64-fd31-43d2-8ded-4708610e92c0_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of two short pointers: one addressing a higher memory address (possibly a forward jump to skip a conditional branch) and one addressing a lower memory address (probably a backwards jump to return to the beginning of a loop).</figcaption></figure></div><p><strong>Short pointers</strong> take just 1 byte and express a <em>relative</em> address from the instruction being executed. These are specially useful in jump instructions to keep their binary representation compact: jumps appear in every conditional or loop, and in many cases, conditional branches and loop bodies are so short that minimizing the amount of code required to express these branch points is worthwhile.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\" width=\"1456\" height=\"324\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/cb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":324,\"width\":1456,\"resizeWidth\":null,\"bytes\":28003,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcb98b4f6-9c2d-4de9-ad94-aa8a9d0684e4_2160x480.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div></div></div></a><figcaption class=\"image-caption\">Representation of a near pointer.</figcaption></figure></div><p><strong>Near pointers</strong> can reference addresses within the 64KB segment implied “by context” and are 2-byte long. For example, an instruction like <code>JMP 12829h</code> does not usually need to carry information about the segment this address references because code jumps are almost-always within the same CS of the code issuing the jump. Similarly, an instruction like <code>MOV AX, [5610h]</code> assumes that the given address references the currently-selected DS so that it doesn’t have to express the segment every time. The offset encoded by the near pointer can be relative or absolute.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\" width=\"1456\" height=\"485\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":485,\"width\":1456,\"resizeWidth\":null,\"bytes\":48837,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F078820e8-d869-4ea8-8bee-01d44e65c572_2160x720.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of a far pointer referencing an address in another segment.</figcaption></figure></div><p><strong>Far pointers</strong> can reference any memory address by encoding a segment and an offset. They are 4-byte long. When used in pointer arithmetic, the segment stays fixed and only the offset varies. This is relevant, for example, when iterating over arrays as we can load the base address into DS or ES just once and then manipulate the offset within the segment. However, this means that such iteration has a maximum range of 64KB.</p><p><strong>Huge pointers</strong> are like far pointers in that they are also 4-byte long and can reference any memory address, but they eliminate the 64KB limitations around pointer arithmetic. They do so by recomputing the segment and offset portions on every memory access (remember that segments are overlapping so we can come up with multiple segment/offset pairs for any physical address). As you can imagine, this requires extra code on every memory access and thus huge pointers impose a noticeable tax on run time.</p><h1>Memory models</h1><p>And now that we know about 8086 segmentation, EXE files, and pointer types… we can finally tie all of these concepts together to demystify the memory models we used to see in old compilers for DOS.</p><p>Here is the breakdown:</p><ul><li><p><strong>Tiny</strong>: This is the memory model of COM images. The whole program fits in one 64KB segment and all segment registers are set to this one segment at startup. This means that all pointers within the program are short or near because they always reference this same 64KB segment.</p></li><li><p><strong>Small</strong>: Uses near pointers everywhere, but the data and stack segments are different from the code segment. This means that these programs have 64KB for code and 64KB for data.</p></li><li><p><strong>Compact</strong>: Uses short pointers for the code but far pointers for the data. This means that these programs can use the full 1 MB memory space for data and, as such, it was particularly useful for games where the code would be as tight as possible while being able to load and reference all assets in memory.</p></li><li><p><strong>Medium</strong>: The opposite from compact. Uses far pointers for code and short pointers for data. This model is weird because, if you had a program with a lot of code, it was probably the kind of program that handled a lot of data too.</p></li><li><p><strong>Large</strong>: Uses far pointers everywhere so both code and data can reference the full 1 MB address space. However, because of what far pointers are, all memory <em>offsets</em> are 64 KB at most which means data structures and arrays are limited in size.</p></li><li><p><strong>Huge</strong>: Uses huge pointers everywhere. This overcomes the limitations of the large model by emitting code to compute the absolute addresses of every memory access and allows structs and arrays that span over 64 KB of memory. Obviously, this comes at a cost: the program code is now larger and the runtime cost is much bigger.</p></li></ul><p>And that’s it!</p><p>It is worth highlighting that these models were all <em>conventions</em> that a vintage C compiler used to emit code. If you were writing assembly by hand, you could mix-and-match pointer types to do whatever you wanted given that these concepts had no special meaning to the OS.</p><h1>Evolving to today’s world</h1><p>Everything I have told you about until now is legacy stuff that you could easily dismiss as useless knowledge. Or could you?</p><p>One thing I did <em>not</em> touch upon is the concept of <strong>code density</strong> and how it relates to performance. The way we choose to express pointers in the code has a direct impact on code density, so when we evolve computing from 16-bit machines like the 8086 to contemporary 64-bit machines, pointer representations grow by <em>a lot</em> and we face some hard choices.</p><p>But to explain all of this and answer the performance questions, you’ll have to wait for the next article. So subscribe now to not miss out on that one!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F19dc46c5-0bc9-4e74-889e-2d27b0e2c294_2132x1599.png" "0.0" "image/jpeg") nil "1a765210403a172e9c4c5bbe82de2ff5") (10 (26569 31003 256712 703000) "https://blogsystem5.substack.com/p/windows-nt-vs-unix-design" "Windows NT vs. Unix: A design comparison" "Julio Merino" "Mon, 09 Sep 2024 15:30:16 +0000" "<p>Over the years, I’ve repeatedly heard that Windows NT is a very advanced operating system and, being a Unix person myself, it has bothered me to not know <em>why</em>. I’ve been meaning to answer this question for years and I can do so now, which means I want to present you my findings.</p><p>My desire to know about NT’s internals started in 2006 when I applied to the Google Summer of Code program to develop Boost.Process. I needed such a library for ATF, but I also saw the project as a chance to learn something about the Win32 API. This journey then continued in 2020 with me <a href=\"https://jmmv.dev/2020/10/bye-google-hi-microsoft.html\">choosing to join Microsoft</a> after a long stint at Google and me buying the <a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals</a> 5th edition book in 2021 (which I never fully read due to its incredible detail and length). None of these made me learn what I wanted though: the ways in which NT fundamentally differs from Unix, if at all.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\" width=\"1456\" height=\"1092\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1092,\"width\":1456,\"resizeWidth\":null,\"bytes\":1049872,\"alt\":\"\",\"title\":\"\",\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Then, at the end of 2023, the <a href=\"https://blogsystem5.substack.com/p/windows-nt-peeking-into-the-cradle\">Showstopper</a> book sparked this curiosity once again. And soon, a new thought came to mind: the Windows Internals 5th edition book was too obtuse but… what about the first edition? Surely it must have been easier to digest because the system was much simpler back in the early 1990s. So lo and behold, I searched for this edition, found it under the title <a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT</a>, read it cover to cover, and took notes to evaluate NT vs. Unix.</p><p>Which brings me to this article—a collection of thoughts comparing the design of NT (July 1993) against contemporary Unix systems such as 4.4BSD (June 1994) or Linux 1.0 (March 1994). Beware that, due to my background, the text is written from the point of view of a Unix “expert” and an NT “clueless”, so it focuses on describing the things that NT does differently.</p><h1>Mission</h1><p><a href=\"https://en.wikipedia.org/wiki/Unix\">Unix</a>’s history is long—much longer than NT’s. Unix’s development started in 1969 and its primary goal was to be a convenient platform for programmers. Unix was inspired by <a href=\"https://en.wikipedia.org/wiki/Multics\">Multics</a>, but compared to that other system, Unix focused on simplicity which is a trait that let it triumph over Multics. Portability and multitasking were not original goals of the Unix design though: these features were retrofitted in the many “forks” and reinventions of Unix years later.</p><p>On Microsoft’s side, the first release of MS-DOS launched in August 1981 and the first release of “legacy Windows” (the DOS-based editions) launched in November 1985. While MS-DOS was a widespread success, it wasn’t until <a href=\"https://en.wikipedia.org/wiki/Windows_3.0\">Windows 3.0</a> in May 1990 that Windows started to really matter. Windows NT was conceived in 1989 and saw the light with the NT 3.1 release in July 1993.</p><p>This timeline gave Microsoft an edge: the design of NT started 20 years after Unix’s, and Microsoft already had a large user base thanks to MS-DOS and legacy Windows. The team at Microsoft designing NT had the hindsight of these developments, previous experience developing other operating systems, and access to more modern technology, so they could “shoot for the moon” with the creation of NT.</p><p>In particular, NT started with the following design goals as part of its mission, which are in stark contrast to Unix’s:</p><ol><li><p>portability,</p></li><li><p>support for multiprocessing systems (SMP), and</p></li><li><p>compatibility with DOS, legacy Windows, OS/2, and POSIX.</p></li></ol><p>These were not goals to scoff at and meant that NT started with solid design principles from the get go. In other words: these features were all present from day one and not bolted on at a later stage like they were in many Unixes.</p><h1>The kernel</h1><p>Now that we know some of these design goals and constraints, let’s take a look at the specifics of how they are implemented.</p><p>Unix is, with few exceptions like <a href=\"https://www.minix3.org/\">Minix</a> or <a href=\"https://www.gnu.org/software/hurd/\">GNU Hurd</a>, implemented as a monolithic kernel that exposes a collection of system calls to interact with the facilities offered by the operating system. NT, on the other hand, is a hybrid between a monolithic kernel and a microkernel: the privileged component, known as the <em>executive</em>, presents itself as a collection of modular components to user-space <em>subsystems</em>. The user-space subsystems are special processes which “translate” the APIs that the applications consume (be it POSIX, OS/2, etc.) into executive system calls.</p><p>One important piece of the NT executive is the Hardware Abstraction Layer (HAL), a module that provides abstract primitives to access the machine’s hardware and that serves as the foundation for the rest of the kernel. This layer is the key that allows NT to run on various architectures, including i386, Alpha, and PowerPC. To put the importance of the HAL in perspective, contemporary Unixes were coupled to a specific architecture: yes, Unix-the-concept was portable because there existed many different variants for different machines, but the implementation was not. SunOS originally only supported the Motorola 68000; 386BSD was the first port of BSD to the Intel architecture; IRIX was the Unix variant for Silicon Graphic’s MIPS-based workstations; and so on. This explains why NetBSD’s main focus on portability via a minimal shim over the hardware was so interesting at the time: other operating systems, except NT, did <em>not</em> have this internal clean design, and NT had come years before.</p><p>Another important piece of the NT executive is its support for multiprocessing systems and its preemptive kernel. The kernel has various interrupt levels (<a href=\"https://en.wikipedia.org/wiki/Spl_(Unix)\">SPLs</a> in BSD terminology) to determine what can interrupt what else (e.g. a clock interrupt has higher priority than a disk interrupt) but, more importantly, the kernel threads can be preempted by other kernel threads. This is “of course” what every high-performance Unix system does today, but it’s not how many Unixes started: those systems started with a kernel that didn’t support preemption nor multiprocessing; then they added support for user-space multiprocessing; and then they added kernel preemption. The latter is the hardest step of all and explains the <a href=\"https://en.wikipedia.org/wiki/FreeBSD_version_history#FreeBSD_5\">FreeBSD 5.0</a> saga fiasco. So it is interesting to see that NT started with the right foundations from its inception.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you are enjoying this article, please subscribe to Blog System/5! Your recurrent interest is what makes this publication work.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Objects</h1><p>NT is an object-oriented kernel. You might think that Unix is too: after all, processes are defined by a struct and file system implementations deal with vnodes (“virtual nodes”, not to be confused with inodes which are a file system-specific implementation detail). But that’s not quite the same as what NT does: NT forces all of these different objects to have a common representation in the system.</p><p>You can rightfully be skeptical about this because… how can you offer a meaningful abstraction over such disparate things as processes and file handles? You can’t, really, but NT forced all of these to inherit from a common object type and, surprisingly, this results in some nice properties:</p><ul><li><p><strong>Centralized access control:</strong> Objects are exclusively created by the <em>object manager</em>, which means there is a single place in the code to enforce policy. This is powerful because the semantics for, say, permission checks, can be defined in just one location and applied uniformly throughout the system. NetBSD concluded this was a good idea too, but it wasn’t until 2001 that it gained its <a href=\"https://man.netbsd.org/NetBSD-9.3/kauth.9\">Kernel Authorization (kauth)</a> framework.</p></li><li><p><strong>Common identity:</strong> Objects have identities and they are all represented in a single tree. This means that there is a unique namespace for all objects, no matter if we are talking about processes, file handles, or pipes. The objects in the tree are addressable via names (paths) and different portions of the tree can be owned by different subsystems. For example, a portion of the tree can represent a mounted file system, and thus traversing that subtree’s root node will cause the file system to resolve the remainder of the path. This is akin to the VFS layer of a Unix system, with the difference that the VFS is exclusively about file systems whereas the object tree is about <em>every single kernel object</em>. It’s true that Unix has attempted to shoehorn other types of non-file objects into the file system via <code>/proc/</code>, <code>/sys/</code>, and the like—but these feel like afterthoughts compared to what NT offers.</p></li><li><p><strong>Unified event handling:</strong> All object types have a <em>signaled</em> state, whose semantics are specific to each object type. For example, a process object enters the signaled state when the process exits, and a file handle object enters the signaled state when an I/O request completes. This makes it trivial to write event-driven code (ehem, async code) in userspace, as a single wait-style system call can await for a group of objects to change their state—no matter what type they are. Try to wait for I/O and process completion on a Unix system at once; it’s painful.</p></li></ul><p>Objects are an NT-specific construct though, and they don’t generalize well to all of the APIs that NT intended to support. An example of this is the POSIX subsystem: POSIX doesn’t have the same concept of objects as NT does, yet NT has to offer some sort of compatibility with POSIX applications. For this reason, while the POSIX subsystem allocates objects from the executive, this subsystem must keep its own bookkeeping to represent the corresponding POSIX entities and performs the logical translation between the two on the fly. The Win32 subsystem, on the other hand, just hands objects to clients without an intermediary.</p><h1>Processes</h1><p>Processes are a common entity in both NT and Unix but they aren’t quite the same. In Unix, processes are represented in a tree, which means that each process has a parent and a process can have zero or more children. In NT, however, there is no such relationship: processes can “inherit” resources from their creators—any type of object, basically—but they are standalone entities after they are created.</p><p>What wasn’t common back when NT was designed were threads: Mach was the first Unix-like kernel to integrate threads in 1985, which means that other Unixes adopted this concept later on and had to retrofit it into their existing designs. For example, Linux chose to represent threads as processes, each with its own PID, in its 2.0 release in June 1996; and NetBSD didn’t get threads, represented as separate entities from processes, until its 2.0 release in 2004. Contrary to Unix, NT chose to support threads from the very beginning, knowing that they were a necessity for high-performance computing on SMP machines.</p><p>NT doesn’t have signals in the traditional Unix sense. What it does have, however, are <em>alerts</em>, and these can be kernel mode and user mode. User mode alerts must be waited for as any other object and kernel mode alerts are invisible to processes. The POSIX subsystem uses kernel mode alerts to emulate signals. Note that signals have often been called a wart in Unix because of the way they interfere with process execution: handling signals correctly is a really difficult endeavor, so it sounds like NT’s alternative is more elegant.</p><p>An interesting recent development in NT-land has been the introduction of <a href=\"https://www.microsoft.com/en-us/research/project/drawbridge/\">picoprocesses</a>. Up until this feature was added, processes in NT were quite heavyweight: new processes would get a bunch of the NT runtime libraries mapped in their address space at startup time. In a picoprocess, the process has minimal ties to the Windows architecture, and this is used to implement Linux-compatible processes in WSL 1. In a way, picoprocesses are closer to Unix processes than native Windows processes, but they are not used for much anymore—even if they have only existed since August 2016—because of the move to WSL 2.</p><p>Lastly, as much as we like to bash Windows for security problems, NT started with an advanced security design for early Internet standards given that the system works, basically, as a capability-based system. The first user process that starts after logon gets an access token from the kernel representing the privileges of the user session, and the process and its subprocesses must supply this token to the kernel to assert their privileges. This is different from Unix where processes just have identifiers and the kernel needs to keep track of what each process can do in the process table.</p><h1>Compatibility</h1><p>As mentioned in the introduction, a major goal of NT was to be compatible with applications written for legacy Windows, DOS, OS/2 and POSIX. One reason for this was technical, as this forced the system to have an elegant design; the other reason was political, as NT was a joint development with IBM and NT <em>had</em> to support OS/2 applications even if, in the end, NT ended up <em>being</em> Windows.</p><p>This need for compatibility forced NT’s design to be significantly different than Unix’s. In Unix, user-space applications talk to the kernel directly via its system call interface, and this interface <em>is</em> the Unix interface. Oftentimes, <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">but not always</a>, the C library provides the glue to call the kernel and applications never issue system calls themselves—but that’s a minor detail.</p><p>Contrast this to NT where applications do <em>not</em> talk to the executive (the kernel) directly. Instead, each application talks to one specific protected <em>subsystem</em>, and these subsystems are the ones that implement the APIs of the various operating systems that NT wanted to be compatible with. These subsystems are implemented as user-space servers (they are not inside the NT “microkernel”). Support for Windows applications comes from the Win32 server, which is special because it’s the only one that’s directly visible by users: it controls console programs and DOS terminals, and it has certain privileges for performance reasons.</p><p>Compared to traditional Unix, NT’s design is very different because the BSDs and Linux have a monolithic kernel. These kernels expose a system call interface that userspace applications leverage to interact directly with the system. The BSDs, however, have offered support to run alternate <em>binaries</em> for a long time, all within the monolithic kernel: the way this works is by exposing different system call tables to userspace depending on the binary that’s being run, and then translating those “foreign” system calls to whatever the kernel understands. Linux has limited support for this as well via <em><a href=\"https://man7.org/linux/man-pages/man2/personality.2.html\">personalities</a></em>.</p><p>Even though the BSD approach is quite different from how NT handles supporting other systems, WSL 1 is extremely similar and is not a subsystem in the literal terms that subsystems were originally defined. In WSL 1, the NT kernel marks Linux processes as picoprocesses and, from there on, exposes a different system call interface to them. Within the NT kernel, those Linux-specific system calls are translated into NT operations and served within the same kernel—just like BSD’s Linux compatibility does. The only problem is that, NT not being Unix, its “emulation” of Linux is tricky and much slower than what BSD can offer. It’s a pity that <a href=\"https://jmmv.dev/2020/11/wsl-lost-potential.html\">WSL 2 lost the essence of this design</a> and went with a full-on VM design…</p><p>To finish this section, two more interesting details: a goal of NT’s design was to allow seamless I/O redirection between subsystems, all from a single shell; and subsystems are exposed to applications via <em>ports</em> which are, of course, NT objects and are similar to how Mach allows processes and servers to communicate.</p><h1>Virtual memory</h1><p>NT, just as Unix, relies on a Memory Management Unit (MMU) with pagination to offer protection across processes and to offer virtual memory. Paging in user-space processes is a common mechanism to give them a larger address space than the amount of physical memory on a machine. But one thing that put NT ahead of contemporary Unix systems is that the kernel itself can be paged out to disk too. Obviously not the whole kernel—if it all were pageable, you’d run into the situation where a resolving kernel page fault requires code from a file system driver that was paged out—but large portions of it are. This is not particularly interesting these days because kernels are small compared to the typical installed memory on a machine, but it certainly made a big difference in the past where every byte was precious.</p><p>Additionally, while we take the way virtual memory and paging works these days for granted, this was a big area of research back when NT was designed. Older Unix implementations had separate memory caches for the file system and virtual memory, and it wasn’t until 1987 that <a href=\"https://citeseerx.ist.psu.edu/document?repid=rep1&type=pdf&doi=a36b01c8fd5071f64b981dd3ffc66a6bce56736d\">SunOS implemented a unified virtual memory architecture</a> to reduce the overheads of this old design.</p><p>In contrast, NT started with a unified memory architecture from the beginning. You’d say that this was easy to do because they had the hindsight of the inefficiencies found in Unix and could see the solution that SunOS had implemented before the design of NT started. But regardless, this made NT “more advanced” that many alternate operating systems back then, and it has to be noted that other systems like NetBSD didn’t catch up until 2002 with the implementation of the <a href=\"https://www.usenix.org/legacy/publications/library/proceedings/usenix2000/freenix/full_papers/silvers/silvers.pdf\">Unified Buffer Cache (UBC)</a> in NetBSD 1.6.</p><p>An interesting difference between NT and Unix is how they manage and represent shared memory. In NT, shared memory sections are (surprise) objects and are thus subject to the exact same access validation checks as any other object. Furthermore, they are addressable in the same manner as any other object because they are part of the single object tree. Contrast this to Unix where this feature is bolted on: shared memory objects have a <a href=\"https://man7.org/linux/man-pages/man3/shm_open.3.html\">different namespace</a>, a different API to every other entity, and thus typical permissions don’t apply to them.</p><h1>I/O subsystem</h1><p>Early versions of Unix only supported one file system. For example, it wasn’t until 4.3BSD in 1990 that the BSDs gained the Virtual File System (VFS) abstraction to support more than just UFS. NT, on the other hand, started with a design that allowed multiple file systems.</p><p>In order to support multiple file systems, the kernel has to expose their namespaces in some way. Unix combines the file systems under a single file hierarchy via mount points: the VFS layer provides the mechanisms to identify which nodes correspond to the root of a file system and redirects requests to those file system drivers when traversing a path. NT has a similar design even if, from the standard user interface, file systems appear as disjoint drives: internally, the executive represents file systems as objects in the object tree, and each object is responsible for parsing the remainder of a path. Those file system objects are remapped as DOS drives so that userspace can access them. And, guess what? The DOS drives are also objects under a separate subtree that redirects I/O to the file systems they reference.</p><p>In file system terms, NT ended up shipping with NTFS. NTFS was a really advanced file system for its time even if we like to bash on it for its poor performance (a <a href=\"https://www.youtube.com/watch?v=qbKGw8MQ0i8\">misguided claim</a>). The I/O subsystem of NT, in combination with NTFS, brought 64-bit addressing, journaling, and even Unicode file names. Linux didn’t get 64-bit file support until the late 1990s and didn’t get journaling until ext3 launched in 2001. <a href=\"https://www.usenix.org/conference/1999-usenix-annual-technical-conference/soft-updates-technique-eliminating-most\">Soft updates</a>, an alternate fault tolerance mechanism, didn’t appear in FreeBSD until 1998. And Unix represents <a href=\"https://blogsystem5.substack.com/p/strings-encodings-nuls-and-bazel\">filenames as nul-terminated byte arrays</a>, not Unicode.</p><p>Other features that NT included at launch were disk stripping and mirroring—what we know today as RAID— and device hot plugging. These features were not a novelty given that SunOS did include RAID support since the early 1990s, but what’s interesting is that these were all accounted for as part of the original design.</p><p>At a higher level, <em>the</em> thing that makes the I/O subsystem of NT much more advanced than Unix’s is the fact that its interface is asynchronous in nature and has been like that since the very beginning. To put this in perspective, FreeBSD didn’t see support for <a href=\"https://man7.org/linux/man-pages/man7/aio.7.html\">aio(7)</a> until FreeBSD 3.0 in 1998, and Linux didn’t see this either until Linux 2.5 in 2002. And even if support for asynchronous I/O has existed in Unix systems for more than 20 years now, it’s still not widespread: few people know of these APIs, the vast majority of applications don’t use them, and their performance is poor. Linux’s <a href=\"https://en.wikipedia.org/wiki/Io_uring\">io_uring</a> is a relatively recent addition that improves asynchronous I/O, but it has been a significant source of security vulnerabilities and is not in widespread use.</p><h1>Networking</h1><p>The Internet is everywhere today, but when NT was designed, that was not the case. Looking back at the Microsoft ecosystem, DOS 3.1 (1987) included the foundations for file sharing in the FAT file system, yet the “OS” itself did not provide any networking features: a separate product called Microsoft Networks (MS-NET) did. Windows 3.0 (1990) included support for NetBIOS, which allowed primitive printer and file sharing on local networks, but support for TCP/IP was nowhere to be seen.</p><p>In contrast, Unix <em>was</em> the Internet: all foundational Internet protocols were written for and with it. During the design of NT, it was therefore critical to account for good network support, and indeed NT did launch with networking features. As a result, NT did support both Internet protocols and the traditional LAN protocols used in pre-existing Microsoft environments, which put it ahead of Unix in corporate environments.</p><p>An an example, take NT’s network domains. In Unix, network administrators typically synchronized user accounts across machines by hand; they’d maybe use the X.500 directory protocol (1988) and Kerberos (1980s) for user authentication, which systems like SunOS implemented, but these technologies weren’t particularly simple. Instead, NT offered <em>domains</em> from the get go, which integrated directory and authentication features, and it seems to me that these “won the day” in corporate networks because they were much easier to set up and were built into the system.</p><p>The goal of synchronized user accounts is to share resources across machines, primarily files, and when doing so, the way to represent permissions matters. For the longest time, Unix only offered the simplistic read/write/execute permission sets for each file. NT, on the other hand, came with advanced ACLs from the get go—something that’s still a sore spot on Unix. Even though Linux and the BSDs now have ACLs too, their interfaces are inconsistent across systems and they feel like an alien add-on to the design of the system. On NT, ACLs work at the object level, which means they apply consistently throughout all kernel features.</p><p>And speaking of sharing files, we must talk about networked file systems. In Unix, the de facto file system was NFS, whereas on NT it was SMB. SMB was inherited from MS-NET and LAN Manager and is implemented in the kernel via a component called the <em>redirector</em>. In essence, the redirector is “just” one more file system, like NFS is on Unix, that traps file operations and sends them over the network, which brings us to comparing RPC systems.</p><p>Even though protobuf and gRPC may seem like novel ideas due to their widespread use, they are based on old ideas. On Unix, we had Sun RPC from the early 1980s, primarily to support NFS. Similarly, NT shipped with built-in RPC support via its own DSL—known as MIDL to specify interface definitions and to generate code for remote procedures—and its own facility to implement RPC clients and servers.</p><p>Moving down the stack, Unix systems have never been big on supporting arbitrary drivers: remember that Unix systems were typically coupled to specific machines and vendors. NT, on the other hand, intended to be an OS for “any” machine and was sold by a software company, so supporting drivers written by others was critical. As a result, NT came with the Network Driver Interface Specification (NDIS), an abstraction to support network card drivers with ease. To this day, manufacturer-supplied drivers are just not a thing on Linux, which leads to interesting contraptions like the <a href=\"https://ndiswrapper.sourceforge.net/wiki/index.php/Main_Page\">ndiswrapper</a>, a very popular shim in the early 2000s to be able to reuse Windows drivers for WiFi cards on Linux.</p><p>Finally, another difference between NT and Unix lies in their implementation of named pipes. Named pipes are a local construct in Unix: they offer a mechanism for two processes on the same machine to talk to each other with a persistent file name on disk. NT has this same functionality, but its named pipes can operate over the network. By placing a named pipe on a shared file system, two applications on different computers can communicate with each other without having to worry about the networking details.</p><h1>User-space</h1><p>We are getting close to the end, I promise. There are just a few user-space topics to briefly touch on:</p><ul><li><p><strong>Configuration:</strong> NT centralized system and application configuration under a database known as the <em>registry</em>, freeing itself from the old <code>CONFIG.SYS</code>, <code>AUTOEXEC.BAT</code> and the myriad INI files that legacy Windows used. This made some people very angry, but in the end, a unified configuration interface is beneficial to everyone: applications are easier to write because there is a single foundation to support, and users have an easier time tuning their system because there is just one place to look at.</p><p>Unix, on the other hand, is still plagued by dozens of DSLs and inconsistent file locations. Each program that supports a configuration file has its own made-up syntax, and knowing which locations the program reads is difficult and not always well-documented. The Linux ecosystem has pushed for a more NT-like approach via XDG and dconf (previously GConf) but… it’s an uphill battle: while desktop components use these technologies exclusively, the foundational components of the system may never adopt them, leaving an inconsistent mess behind.</p></li><li><p><strong>Internationalization:</strong> Microsoft, being the large company that was already shipping Windows 3.x across the world, understood that localization was important and made NT support such feature from the very beginning. Contrast this to Unix where UTF support didn’t start to show up until the late 1990s, and supporting different languages came via the optional <code>gettext</code> add-on.</p></li><li><p><strong>The C language:</strong> One thing Unix systems like FreeBSD and NetBSD have fantasized about for a while is coming up with their own dialect of C to <a href=\"https://cs.rochester.edu/u/jzhou41/papers/freebsd_checkedc.pdf\">implement the kernel in a safer manner</a>. This has never gone anywhere except, maybe, for Linux relying on GCC-only extensions. Microsoft, on the other hand, had the privilege of owning a C compiler, so they did do this with NT, which is written in Microsoft C. As an example, NT relies on Structured Exception Handling (SEH), a feature that adds try/except clauses to handle software and hardware exceptions. I wouldn’t say this is a big plus, but it’s indeed a difference.</p></li></ul><h1>Conclusion</h1><p>NT was groundbreaking technology when it launched. As I presented above, many of the features we take for granted today in systems design were present in NT since its inception, whereas almost all other Unix systems had to gain those features slowly over time. As a result, such features don’t always integrate seamlessly with Unix philosophies.</p><p>Today, however, it’s not clear to me that NT is truly “more advanced” than, say, Linux or FreeBSD. It is true that NT had more solid design principles at the onset and more features that its contemporary operating systems, but nowadays… the differences are blurry. Yes, NT is advanced, but not significantly more so than modern Unixes.</p><p>What I find disappointing is that, even though NT has all these solid design principles in place… bloat in the UI doesn’t let the design shine through. The sluggishness of the OS even on super-powerful machines is <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">painful to witness</a> and might even lead to the demise of this OS.</p><p>I’ll leave you with the books used to write this article in case you want to go through my learning journey. I had to skip over tons of interesting details, as you can imagine, so these are worth a read:</p><ul><li><p><a href=\"https://www.amazon.com/Inside-Windows-NT-Helen-Custer/dp/155615481X?crid=1DW4GVN0DXZR4&dib=eyJ2IjoiMSJ9.T5IY8OXVnanYLCjv3cX4UA18lTT67S00r-GHOWD5mzHAUtLk4np5tyXDZB6t25N5JGVVo4y_Yi-4Fv6TrXMJ_rs_BjLK_hTqetPsJAsHRsaw6ZbhMH07OitAfS2LpgEmdUNfdU8KoIM8BEJHof4aPIJMHkemWy0IFcaXoyQ9TLMcgLdTlMVF5Yqen-dG6NZeJ03UYK9NJXzHMgt4noQO1UmhxTMA2xw2Bhi-GDbZT4k.vGalnM5AX1xcE149fGsl5IjcbdD3yE0gw0F7_RojBV4&dib_tag=se&keywords=inside+windows+nt&qid=1725808269&sprefix=inside+windows+nt%2Caps%2C160&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=3f47c0d7cea553fed13057b16d417b6c&language=en_US&ref_=as_li_ss_tl\">Inside Windows NT, 1st edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-4-4-Operating-System/dp/0201549794?crid=289Z6M1NYSR8L&dib=eyJ2IjoiMSJ9.4h3ssrq_vTu9MaMquFvEbw.YxrfgRofVfFKstV74Q_LR-XOseMUlCrcvkehHW6y5Yc&dib_tag=se&keywords=design+and+implementation+of+4.4bsd&qid=1725808321&sprefix=design+and+implementation+of+4.4bsd%2Caps%2C158&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=a0d6cc7fb69bc72b4649609390255bff&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the BSD 4.4 operating system</a>.</p></li></ul><p>And if you want to <em>continue</em> my journey and truly dive deep into how each piece of <em>modern</em> NT and Unix works, the newer editions are a must read:</p><ul><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-architecture-management/dp/0735684189?crid=2F7UR8S48RP6O&dib=eyJ2IjoiMSJ9.p9cBb_-Q8GjuK0z0kDLKG6xoExPM_2QWt_jn0PlqVBSWYNyqRp2Cd7MHXFeQ4EiRACaX_Y_9xzECC0YpECzSl5kCBD3u1KUPduAgmnO732G9aqw1aLdQszw8LIXBOE1cYvOf3KYQmQ5vdFV6i4eFOttVvIa2XerkHVGiPd1OzTk32tEOchCbnUqpzW3QqCG7AjEmmKHFGuo5T2_UQDUERaSVRa26oAZHYuePCzDrwbY.bcHnZQWFYjmL64ZRnMieVsUH5JVx-T-WY88kj8V-uno&dib_tag=se&keywords=windows+internals&qid=1725808358&sprefix=windows+internals%2Caps%2C155&sr=8-1&linkCode=ll1&tag=blogsystem5-20&linkId=08d00ee830fe99b6e648add99e1b64c5&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 1, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Windows-Internals-Part-2-7th/dp/0135462401?pd_rd_w=nmV0o&content-id=amzn1.sym.3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_p=3858a394-39a9-4946-90e6-86a3153d2546&pf_rd_r=FHEDS8GZCH0T6TA52GQD&pd_rd_wg=VUb9D&pd_rd_r=9f324aa8-7d91-4b6f-8c48-a8f09f1e8717&pd_rd_i=0135462401&psc=1&linkCode=ll1&tag=blogsystem5-20&linkId=a174f72e73013533f3ee8ca3f2cedd1c&language=en_US&ref_=as_li_ss_tl\">Windows Internals, part 2, 7th edition</a>.</p></li><li><p><a href=\"https://www.amazon.com/Design-Implementation-FreeBSD-Operating-System/dp/0321968972?crid=23A95KGH3XOCE&dib=eyJ2IjoiMSJ9.WhRSQ2C6OFnyaT9IERCxYyLspyOoCkFSreJbs2Nia7zcYcNs68qdHuNBiIvERx987eDwl_H7YrMkTIj1575PGQ.orMCRh-1sVoQgFKgV2RtSiAxU3OA5fYRt6oAI3SV-p0&dib_tag=se&keywords=the+design+and+implementation+of+freebsd&qid=1725850081&s=books&sprefix=the+design+and+implementation+of+freebsd%2Cstripbooks%2C136&sr=1-1&linkCode=ll1&tag=blogsystem5-20&linkId=ac0d39d3f598c50cd1d9dc650d2b4dd7&language=en_US&ref_=as_li_ss_tl\">The Design and Implementation of the FreeBSD operating system, 2nd edition</a>.</p></li></ul><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for making it this far. Don’t forget to subscribe to Blog System/5 to receive new posts and support my work!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F897547e7-c69c-4d33-9e56-ccdbe2391e03_1920x1440.jpeg" "0.0" "image/jpeg") nil "2403d3c002045f22d1e845d1a3fa542e") (9 (26569 31003 254465 507000) "https://blogsystem5.substack.com/p/glibc-versions-runtime" "Picking glibc versions at runtime" "Julio Merino" "Sun, 11 Aug 2024 08:15:13 +0000" "<p>In a recent work discussion, I came across an argument that didn’t sound quite right. The claim was that we needed to set up containers in our developer machines in order to run tests against a modern glibc. The justifications were that using <code>LD_LIBRARY_PATH</code> to load a different glibc didn’t work and statically linking glibc wasn’t possible either.</p><p>But… running a program against a version of glibc that’s different from the one installed on the system seems like a pretty standard requirement, doesn’t it? Consider this: how do the developers of glibc test their changes? glibc has existed for much longer than containers have. And before containers existed, they surely weren’t testing glibc changes by installing modified versions of the library over the system-wide one and YOLOing it.</p><p>So. What options do we really have? To answer this question, we need to look at how dynamic binaries work and what glibc is.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Static binaries</h1><p>Static binaries are binaries whose program code is all contained in one executable. Such binaries can access system services via system calls—or else their utility would be minimal because they wouldn’t be able to interact with the OS—but their binary code is, in a sense, “complete”: what you see in the executable is exactly what gets laid out in memory for execution.</p><p>Here is how a sample static binary looks like. This is for a “hello world” program written in Go, which was the easiest thing to put together because Go is designed to bypass the C library <a href=\"https://utcc.utoronto.ca/~cks/space/blog/programming/Go116OpenBSDUsesLibc\">almost everywhere</a>:</p><pre><code><code>$ file hello_go
hello_go: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=2H_kXH_UFAOR5K6ibAke/aj_2VBvakhN2KujNxtMN/K5TtKP8HHiX65VdbA19s/KxdoZHQEiOxCEbwRE346, with debug_info, not stripped
$ █</code></code></pre><p>In the above, note that <code>file</code> claims that our sample <code>hello_go</code> program is <em>statically linked</em>.</p><p>When we ask the shell to run this <code>hello_go</code> binary, the shell forks a new process and uses the <code>exec(2)</code> family of system calls to replace the running image of the process with the content of <code>hello_go</code>. And because <code>hello_go</code> is statically linked, the text segment of the binary is loaded verbatim into the process.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\" width=\"761\" height=\"261\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/edd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":261,\"width\":761,\"resizeWidth\":null,\"bytes\":9791,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fedd08ae6-6f3b-4f3a-a26a-ce1a8f480a9d_761x261.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how a static binary is directly mapped into a process when executed.</figcaption></figure></div><h1>Dynamic binaries</h1><p>Let’s compare the above to a dynamically-linked binary by looking at the same “hello world” program written in C and linked against glibc:</p><pre><code><code>$ file hello_c
hello_c: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=feeb95b014ef8151780e23fc7ca15de0599f05df, for GNU/Linux 3.2.0, not stripped
$ █</code></code></pre><p>Note that <code>file</code> now claims that our sample <code>hello_c</code> program is <em>dynamically linked</em> and, indeed, if we look at its libraries—quick reminder: <a href=\"https://jmmv.dev/2023/07/ldd-untrusted-binaries.html\">don’t use ldd on untrusted executables</a>!—we see that glibc (<code>libc.so.6</code>) is there:</p><pre><code><code>$ ldd hello_c
linux-vdso.so.1 (0x00007f54f25aa000)
libc.so.6 => /lib64/libc.so.6 (0x00007f54f239b000)
/lib64/ld-linux-x86-64.so.2 (0x00007f54f25ac000)
$ █</code></code></pre><p>But wait a second. There is more than just <code>libc.so.6</code> in the output of <code>ldd</code>. In particular, there is this other <code>/lib64/ld-linux-x86-64.so.2</code> “library” and, if you pay close attention to the earlier output of <code>file</code>, you’ll note that it claims that this is an <em>interpreter</em>. Why is there an “interpreter” if we are running machine code?! Did they lie to us when they said C was a compiled language?</p><p>Not so fast, no. “Interpreter” in this case should be read as “loader”, but the “interpreter” word comes from the nomenclature of the ELF headers stored in the program:</p><pre><code><code>$ readelf -l hello_c
Elf file type is EXEC (Executable file)
Entry point 0x401040
There are 13 program headers, starting at offset 64
Program Headers:
Type           Offset             VirtAddr           PhysAddr
FileSiz            MemSiz              Flags  Align
...
INTERP         0x0000000000000318 0x0000000000400318 0x0000000000400318
0x000000000000001c 0x000000000000001c  R      0x1
[Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
...
$ █</code></code></pre><p>To understand what this interpreter thing is all about, we need to look at what a dynamically-linked executable is. In essence, the program code in the binary is not <em>complete</em>: the code contains “gaps” in it that need to be filled with references to portions of code supplied by other libraries before it can begin executing. We can peek into what these “gaps” are:</p><pre><code><code>$ readelf -r hello_c
Relocation section '.rela.dyn' at offset 0x4c0 contains 2 entries:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000403fd8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 __libc_start_main@GLIBC_2.34 + 0
000000403fe0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0
Relocation section '.rela.plt' at offset 0x4f0 contains 1 entry:
Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000404000  000200000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0
$ █</code></code></pre><p><code>readelf</code> tells us that the <code>hello_c</code> binary has three different “relocations”: in other words, it has three different “gaps” that need to be patched at runtime with the address of the code that supplies those symbols. The program <em>cannot run</em> without those being filled in first. So if it cannot begin executing before those references are resolved, how does the program run?</p><p>You might think that the kernel is somehow responsible for dealing with dynamic libraries, but that’s not the case. Dynamic libraries are a user-space concept and this is precisely where the interpreter comes into play.</p><p>When we ask the kernel to <code>exec(2)</code> a dynamically-linked ELF binary, the kernel loads the <em>interpreter</em> into the process image, <em>not</em> the code of the binary, and passes the path of the binary to the interpreter.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\" width=\"761\" height=\"521\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c0e21a8a-45cc-49de-a64c-65c340120023_761x521.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":521,\"width\":761,\"resizeWidth\":null,\"bytes\":36593,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of how a dynamic binary is loaded into memory with the help of the dynamic linker, along with glibc and the fixup of a relocation.</figcaption></figure></div><p>The interpreter, <a href=\"https://man7.org/linux/man-pages/man8/ld.so.8.html\">ld-linux.so</a> in our case, is then in charge of setting up the remaining of the process by loading all required shared libraries into the process and then resolving relocations (“filling the gaps”) among them. In particular, the dynamic linker is the one that loads glibc into the process.</p><p>We can see that this is the case by asking the dynamic linker to print its own file accesses by setting <code>LD_DEBUG=files</code>:</p><pre><code><code>$ LD_DEBUG=files /lib64/ld-linux-x86-64.so.2 ./hello_c
75369:     file=./hello_c [0];  generating link map
75369:       dynamic: 0x0000000000403e08  base: 0x0000000000000000   size: 0x0000000000004010
75369:         entry: 0x0000000000401040  phdr: 0x0000000000400040  phnum:                 13
75369:
75369:
75369:     file=libc.so.6 [0];  needed by ./hello_c [0]
75369:     file=libc.so.6 [0];  generating link map
75369:       dynamic: 0x00007f9aad868960  base: 0x00007f9aad682000   size: 0x00000000001f0b70
75369:         entry: 0x00007f9aad6ac260  phdr: 0x00007f9aad682040  phnum:                 14
75369:
75369:
75369:     calling init: /lib64/ld-linux-x86-64.so.2
75369:
75369:
75369:     calling init: /lib64/libc.so.6
75369:
75369:
75369:     initialize program: ./hello_c
75369:
75369:
75369:     transferring control: ./hello_c
75369:
Hello, world!
75369:
75369:     calling fini:  [0]
75369:
75369:
75369:     calling fini: /lib64/libc.so.6 [0]
75369:
75369:
75369:     calling fini: /lib64/ld-linux-x86-64.so.2 [0]
75369:
$ █</code></code></pre><p>As a final note, see how I chose to invoke the dynamic linker <em>explicitly</em>—just as the kernel would do when asked to launch a dynamically-linked binary—instead of directly running <code>hello_c</code>.</p><h1>Playing with glibc</h1><p>OK, now that we know how a dynamically-linked ELF executable is loaded into memory, let’s play with glibc.</p><p>First, we download glibc, build and install it into a temporary directory like <code>/tmp/sysroot/</code>:</p><pre><code><code>$ git clone https://sourceware.org/git/glibc.git
$ cd glibc
glibc$ git checkout release/2.40/master
glibc$ mkdir build
glibc/build$ ../configure --prefix=/tmp/sysroot
glibc/build$ make -j $(nproc)
glibc/build$ make -j $(nproc) install
glibc/build$ █</code></code></pre><p>With that done, we should be able to use the new glibc. But…</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib ./hello_c
Floating point exception (core dumped)
$ █</code></code></pre><p>Kaboom.</p><p>Indeed, as my coworker claimed, it doesn’t seem to be possible to load a different glibc at runtime than the one provided by the system. (YMMV. I got this to work on another system.) Looking at the stack trace of the core dump, we see:</p><pre><code><code>Stack trace of thread 75841:
#0  0x00007f227d93903b n/a (/tmp/sysroot/lib/libc.so.6 + 0x15403b)
#1  0x00007f227d9f19f6 _dl_sysdep_start (ld-linux-x86-64.so.2 + 0x1c9f6)
#2  0x00007f227d9f335e _dl_start_final (ld-linux-x86-64.so.2 + 0x1e35e)
#3  0x00007f227d9f2048 _start (ld-linux-x86-64.so.2 + 0x1d048)</code></code></pre><p>Our process is crashing within glibc as soon as it is loaded by <code>ld-linux.so</code>. The details of the crash are not interesting for our purposes, but can we do anything about them?</p><h1>Playing with the dynamic linker</h1><p>What’s more interesting is to peek into what’s shipped by glibc. We can do this by looking under the <code>/tmp/sysroot/</code> hierarchy that we generated earlier and finding:</p><pre><code><code>$ ls /tmp/sysroot/lib/
...
ld-linux-x86-64.so.2
...
libc.so
libc.so.6
...
$ █</code></code></pre><p>There is <em>a ton</em> more stuff in there. But what’s important to notice is that <em>the dynamic linker ships with glibc</em>. The two are closely coupled, and using one without the other can lead to the kinds of crashes shown earlier.</p><p>And remember: as we saw above, it is possible to manually launch the dynamic linker. So if we do the following:</p><pre><code><code>$ LD_LIBRARY_PATH=/tmp/sysroot/lib /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We don’t get a crash anymore. What’s even better is that we also <em>seem</em> to get what we expect without even setting <code>LD_LIBRARY_PATH</code>:</p><pre><code><code>$ /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
Hello, world!
$ █</code></code></pre><p>We should confirm that the previous invocation of <code>hello_c</code> is actually using our own glibc version and not the system-supplied one. To do that, we can <code>strace</code> the dynamic linker; it’s just a program after all:</p><pre><code><code>$ strace /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Indeed, <code>hello_c</code> did use the newly-built glibc by “just” asking the newly-built dynamic loader to execute the binary.</p><p>To summarize, glibc ships both the <code>ld-linux.so</code> dynamic linker and the <code>libc.so.6</code> shared library. The two are closely coupled. Running a binary against the C library without also using a matching dynamic linker can lead to crashes. But running a binary directly with a specific dynamic linker ensures that the binary picks up the matching C library.</p><h1>Putting this to use</h1><p>Alright, now that we know that it is actually possible to run a binary against a version of glibc that’s <em>not</em> the one provided by the system, we can try to solve the original problem we faced: running tests against a modern glibc.</p><p>One possibility is to modify the commands used to run the tests to prefix them by <code>.../lib/ld-linux-x86-64.so.2</code>. This could work but I posit is difficult to integrate with a test execution environment because we don’t necessarily control the commands that end up executing the test binaries.</p><p>Another possibility is to modify the way the tests programs are being built by supplying additional linker arguments—say, via the traditional <code>LDFLAGS</code>—to point the linker at a different interpreter with the <code>--Wl,--dynamic-linker</code> flag:</p><pre><code><code>$ cc -o hello_c -Wl,--dynamic-linker=/tmp/sysroot/lib/ld-linux-x86-64.so.2 hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Better. Now the built binary “knows” which glibc to use without us having to specify it explicitly every time we attempt to launch the program.</p><p>What if we aren’t <em>building</em> the binaries? What if we are just reusing a binary that already exists? <code>patchelf</code> to the rescue:</p><pre><code><code>$ cc -o hello_c hello.c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/lib64/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ patchelf --set-interpreter /tmp/sysroot/lib/ld-linux-x86-64.so.2 ./hello_c
$ strace ./hello_c 2>&1 | grep libc.so
openat(AT_FDCWD, \"/tmp/sysroot/lib/libc.so.6\", O_RDONLY|O_CLOEXEC) = 3
$ █</code></code></pre><p>Voila. We have modified an existing executable to use whichever glibc we desire.</p><h1>Versioning glibc</h1><p>But hold on a second. Can we use <em>whichever</em> glibc really? Is it actually true that glibc versions are completely interchangeable? Unfortunately not.</p><p>A binary built against an old version of glibc is guaranteed to run against a newer version of glibc without recompilation. But the counterpart is not true: a binary built against a new glibc may not run against an older glibc.</p><p>This poses a problem: how can we upgrade glibc across separate production and development environments? If we upgrade production first, binaries built in development environments will continue to work properly but developers may not be able to reproduce bugs found in production. And if we upgrade development environments first, the binaries they produce may be incompatible with production, leading to random crashes later on.</p><p>Here is an idea I’ve seen work in the past: let’s extend the sysroot concept presented above and version it!</p><p>We start with <code>/usr/sysroot/v1/</code> which contains the first version of the core system libraries we have to support. All binaries that we build for production deployment are explicitly linked against the <code>ld-linux.so</code> of this directory, so they are always validated against <code>v1</code> of the sysroot. <code>v1</code> remains immutable, which means new builds of the binaries will continue to work as tested in the past.</p><p>Whenever we want to upgrade glibc, we create a <em>new</em> sysroot, <code>/usr/sysroot/v2/</code>. This new <code>v2</code> is deployed to all environments (development and production) that may need to use the new glibc. This deployment step is risk-free because nothing is yet dependent on <code>v2</code>. After that, we proceed to rebuild all binaries that we want to test and run, this time pointing at the <code>ld-linux.so</code> within <code>v2</code>. Deploying these new binaries causes them to use the new version.</p><p>As long as the <code>/usr/sysroot/</code> subdirectories remain immutable and synchronized across all environments in which binaries run, we are guaranteed to always get a deterministic version of glibc for a given binary.</p><p>That’s just a design sketch though. It may or it may not work for you. As I mentioned earlier, I’ve seen this work well in a large corporate environment before, but it introduces some extra complexity that you need to take care of.</p><div><hr></div><p>What’s the moral of the story? Containers are, usually, not the best solution to a systems problem. While they might be coerced to deliver the desired results, they come with a heavy cost. Unix has been around for a long time and there exist alternate solutions to problems that don’t require full replicas of a functioning system. A ton of the bloat we face today in development tools and deployments comes from the abuse of heavyweight containers. So, every time you think “containers!”, pause to explore alternatives—you may find cheaper, more portable, and simpler solutions.</p><p>If you want to learn more about this and related topics, I’d recommend grabbing a copy of the classic <a href=\"https://www.amazon.com/Linkers-Kaufmann-Software-Engineering-Programming/dp/1558604960?&linkCode=ll1&tag=blogsystem5-20&linkId=421e6bc20c93925de6766b135a24239a&language=en_US&ref_=as_li_ss_tl\">“Linkers and Loaders” book</a>. It’s old, but it’s still very relevant.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0e21a8a-45cc-49de-a64c-65c340120023_761x521.png" "0.0" "image/jpeg") nil "c3e6d50d38fa4fa6cee95678c96365e8") (8 (26569 31003 252945 760000) "https://blogsystem5.substack.com/p/kyua-graduates" "Kyua graduates" "Julio Merino" "Fri, 02 Aug 2024 15:45:08 +0000" "<p>After years of inactivity, the Kyua project has graduated as an open source citizen and has <a href=\"https://github.com/freebsd/kyua/\">a new home</a> under the FreeBSD umbrella!</p><p>But uh… wait, what is Kyua and why is this exciting? To resolve confusion and celebrate this milestone, I’d like to revisit what Kyua is, how it came to be, why I stopped working on it for a while, why that was a problem for FreeBSD—and, indirectly, NetBSD—and how Kyua being free software has helped keep it alive.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":367311,\"alt\":\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\",\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" title=\"Image of a large green checkbox with a smiling face made with googly eyes and wearning a graduation hat. Generated by Google Gemini.\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><h1>The birth of ATF</h1><p>Let’s begin by talking about Kyua’s predecessor: the Automated Testing Framework (ATF).</p><p>In 2005, I was <a href=\"https://jmmv.dev/2005/06/soc-accepted.html\">one of the lucky pioneers</a> of the Google Summer of Code (GSoC) program. During that summer, I wrote <a href=\"http://web.archive.org/web/20071214080206/http://netbsd-soc.sourceforge.net/projects/tmpfs/\">the tmpfs file system for NetBSD</a> and my development process went something like this on an iBook G3:</p><ol><li><p>Modify the kernel.</p></li><li><p>Build and install the updated kernel.</p></li><li><p>Reboot the laptop.</p></li><li><p><strong>Mount the file system.</strong></p></li><li><p><strong>Manually validate new functionality and bug fixes.</strong></p></li><li><p>Witness the machine crash.</p></li><li><p>Force-reboot.</p></li><li><p>Rinse and repeat.</p></li></ol><p>Needless to say, this was a painful process. Using kernel modules lowered the pain a tiny little when the changes I made didn’t crash but, in general, they <em>did</em> crash. Documentation was scarce and I didn’t know what I was doing!</p><p>In an attempt to make the validation step less painful and to ensure that each change I made was a “net positive” instead of regressing functionality, I got what-I-think-was my first real exposure to automated testing. I <em>had</em> to automate steps 4 and 5 in the flow above, and so I wrote ad-hoc scripts to do so.</p><p>My GSoC mentors, Luke Mewburn and Bill Studenmund, pointed me at the <code>src/tests</code> directory of the NetBSD source tree which contained a bunch of tests for the system. Some of these were for user space tools and others exercised portions of the kernel. The existing machinery could probably be reused to automate my manual regression testing steps, so I had to try to integrate with it.</p><p><em>Machinery</em> is… a strong word given how rudimentary <code>src/tests</code> was. The main issue with this infrastructure was that the tests didn’t have a real runner: they were all small programs with unique command-line interfaces glued together by a collection of <code>Makefile</code>s. There was no guarantee that these tests built nor that running a <code>make test</code> would run them all because many tests were known to be broken. And what’s worse: some of the existing tests <em>crashed</em> the kernel due to known bugs.</p><p>I started envisioning the need for a principled test framework and wanted to create one, but I needed the time to do so and school didn’t give me much of that. So, in 2006, I applied once again to GSoC but, while I got in, I chose to take a detour and help write the beginnings of the Boost.Process library. The reason for this choice was primarily to learn Win32 internals but a good side-effect was that I got to experience a more advanced test framework.</p><p>And then, in 2007, I wanted to create this automation project as my bachelor’s degree graduation project… but I couldn’t find a professor that would back the idea. (A pity because I believe it would have been a great fit for the operating systems group.) So I did what I knew how to do: I applied and got into GSoC once again—this time <a href=\"http://web.archive.org/web/20071225031924/http://netbsd-soc.sourceforge.net/projects/atf/\">to develop a testing framework for NetBSD</a>.</p><p>The idea was to create libraries to write tests with a unified CLI interface in either C, C++, or shell, and then provide a unified runner that would execute these tests in an isolated manner <em>and</em> without access to the source tree. And thus the <em>Automated Testing Framework (ATF)</em> was born.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Being sponsored to work on open source projects by GSoC was truly inspiring. Those times are long gone, but you can now support me by subscribing and choosing a paid option!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>Problems with ATF</h1><p>ATF was fine for a while. We got a large portion of the old tests in NetBSD resurrected, fixed, and hooked into the ATF infrastructure. A major contribution was Andreas Gustafsson’s <a href=\"https://www.gson.org/netbsd/anita/\">Anita</a>: an automation system to create a VM, install NetBSD on it via the interactive installer, and run the whole battery of tests inside of it.</p><p>Anita and ATF were the beginnings of something akin to a CI system for a full operating system in the open source world. As far as I know, Linux did <em>not</em> have anything similar—and it <em>couldn’t</em> have had anything similar due to the distributed nature of its development—nor did the other BSDs. Windows <em>did</em> have this, of course, as I could glance from the many articles in <a href=\"https://devblogs.microsoft.com/oldnewthing/\">The Old New Thing</a> describing backwards compatibility testing.</p><p>This was great but, over time, ATF showed signs of suboptimal design. It had at least two problems that were really hard to fix, namely:</p><ul><li><p>Its design (remember running <code>atf-run | atf-report</code>?) prevented the execution of tests in parallel, and concurrent test execution is crucial for performance. The Anita test runs took just too long for a good CI turnaround.</p></li><li><p>ATF expected tests to be written using the <code>atf-c</code>, <code>atf-c++</code>, and <code>atf-sh</code> libraries—but developers wanted to implement and reuse tests without porting them to these libraries. In particular, people wanted to create simpler test programs and wanted to support programs that emitted the more-widespread <a href=\"https://testanything.org/\">Test Anything Protocol (TAP)</a> popularized by Perl test harnesses.</p></li></ul><p>Aside from these problems, ATF also lacked a critical feature that Anita had to supply on its own: a data store to track historical test reports and an interface to browse through them. This feature was a necessity for a CI system so, ideally, it had to live within ATF to not be stuck inside a web server. (“Web apps everywhere” was not a thing pre-2010.) To compound the problem, I got an internship at Google in 2008 and joined full-time in 2009, which let me experience <a href=\"https://bazel.build/\">Blaze</a> and its ecosystem for test results tracking and reporting first-hand—and I wanted those features for NetBSD.</p><p>I concluded, <a href=\"https://www.joelonsoftware.com/2000/04/06/things-you-should-never-do-part-i/\">maybe wrongly</a>, that ATF needed a rewrite.</p><h1>Kyua arrives</h1><p>So, in 2010, I set to create a brand new execution engine. At that point, the target was to rewrite just the portion of ATF that executed tests: that is, the <code>atf-run | atf-report</code> pipeline. I did not want to recreate the ATF <em>libraries</em>. The idea was to:</p><ul><li><p>Create a generic test runner that could integrate multiple test protocols, with the ATF-based tests being the first use case. The unwritten goal was to let the ATF libraries dwindle at some point in the future in favor of better libraries (like <a href=\"https://github.com/google/googletest\">GoogleTest</a> for C++ tests or my own <a href=\"https://jmmv.dev/2023/10/unit-testing-with-shtk.html\">shtk for shell tests</a>).</p></li><li><p>Support a “tests database” to store the results of all test executions. This database was going to allow generating reports in multiple formats and permit running queries to look at historical trends.</p></li><li><p>Support parallel test execution via a more modular runner design. (If you know the history behind Kyua, you’ll notice that this feature only appeared very late in the game. It was a mistake to delay it and I’m not sure why I did that.)</p></li></ul><p>Thus, in November of 2010, Kyua was born as a “testing framework for infrastructure software”. It took some work to get to the point where Kyua could run most of the NetBSD test suite unmodified, but by July 2011, I reached this milestone and launched Kyua 0.1.</p><p>Which led to frustration: ATF was deeply ingrained in NetBSD and Kyua wasn’t well-received for various reasons. One was that Kyua was a larger C++ project than ATF and C++ was (and still is) frowned upon in that community. Another was the fact that Kyua’s reports were harder to manage and required significantly more disk space, and Andreas wasn’t ready to bubble up his CI hardware costs. There were other concerns, all pretty reasonable.</p><p>I kept working on Kyua to try to resolve most of the concerns raised and I believe I addressed all of those that could be addressed. Unfortunately, this took time, and I had grown demotivated to pursue another “sell” of the project. But then…</p><h1>Kyua meets FreeBSD</h1><p>The FreeBSD community had been paying attention. They needed to improve their CI story as well, and they did have much more interest in building a test suite due to the needs of a few corporate-backed projects. I’m not exactly sure who I talked to other than Enji Cooper, George N. Neville, and Ed Maste, but by 2013, I had <a href=\"https://jmmv.dev/2013/11/joining-freebsd-committer-ranks.html\">gotten a FreeBSD commit bit</a> and I was set to integrate Kyua—not ATF!—into FreeBSD.</p><p>One thing I remember was how the FreeBSD project offered me three dedicated beast machines in a colo so that I could set them up for CI runs. This felt very different from the NetBSD approach: FreeBSD had resources—understandably so, as NetBSD has always been underrated—and they were ready to invest them into the shiny-new thing. I took the bait and worked on that for a while. (Fun fact: I used a PowerMac G5 for this work.)</p><p>By December of 2013, I shipped <a href=\"https://jmmv.dev/2013/12/introducing-freebsd-test-suite.html\">the initial CI system</a> for FreeBSD. This was a really exciting moment because all efforts I had put behind Kyua finally paid off: Kyua was <em>the</em> driver for what I think is the most important operating system project in the open source community outside the Linux monoculture.</p><p>The future of the project was tainted though: I was still employed by Google… which made me keep experiencing Blaze and its ecosystem day after day. You see: Blaze is often touted as a <em>build</em> system, but its secret sauce lies in it being a <em>test</em> system. Blaze is a test runner that knows how to precisely build and run <em>the minimum set of tests impacted by a code change</em>. And this matters.</p><p>Precise test selection doesn’t make a big difference for the run-off-the-mill projects you see in GitHub, but for monorepo-style projects—and the BSDs are such projects—this becomes a requirement to run a CI system with quick turnaround times. By this point, I saw Kyua as a “local maximum” because I did not see how to make this possible in combination with the native BSDs’ build systems.</p><h1>Stagnation</h1><p>No matter what I secretly thought, FreeBSD was bought into ATF and Kyua, and they—Enji in particular—had larger plans for the system. The FreeBSD developers really wanted to integrate TAP-style tests, needed to set up a full CI system with many more configurations and architectures than I had set up, and needed better reporting capabilities for failures.</p><p>The problem was that I owned the critical software pieces of this infrastructure, and this was a problem for various reasons: I was too busy with work and two little kids; I had stopped using any BSD on a daily basis; I did not see a bright future for Kyua as it was designed nor implemented; and to make things worse, contributing to Kyua required signing the Google CLA because I still worked for Google (which never made any sense to me but I didn’t have a say in the matter).</p><p>So, for years, Kyua went pretty much unmaintained. FreeBSD kept building local patches and occasionally sent PRs to my upstream project, but I dreaded dealing with them. Maintaining open source projects is stressful if only because of this guilt that you end up with when you don’t have the time to deal with contributions in a timely manner. The more time the situation lasts, the worse it gets.</p><p>It took until 2020 to convince myself that ATF and Kyua needed attention and that I was not fit to support them. I had to let go off these projects and I needed to clear my mind <a href=\"https://www.endbasic.dev/2020/04/hello-endbasic.html\">for other cool stuff</a>. So… I emailed the FreeBSD project owners and offered them to take ownership. If they forked the project and owned it, any FreeBSD committer could easily gain access to the project to do what was best for FreeBSD. And if they owned the fork, they wouldn’t have to worry about the CLA part of the situation because I wouldn’t be involved any longer.</p><p>Things didn’t make the progress I desired though. The FreeBSD project owners had concerns about officially forking these projects into FreeBSD because it cloud give the wrong impression and alienate other consumers like NetBSD. Kyua and ATF were not FreeBSD-only projects so it was probably better for them to stand alone. The discussions died off and stayed like that…</p><h1>Rebirth</h1><p>… until the end of 2023 when Li-Wen Hsu resurrected the email thread I had started. Kyua had become a critical piece of the FreeBSD quality infrastructure and it being almost-abandoned was starting to be problematic. He asked if we could move forward with the project ownership transfer idea—and I was at the ready.</p><p>And so that’s what happened!</p><p>On January 17th, 2024, the right buttons were pushed and… <a href=\"https://github.com/freebsd/kyua/\">Kyua</a> (along with <a href=\"https://github.com/freebsd/atf/\">ATF</a> and <a href=\"https://github.com/freebsd/lutok/\">Lutok</a>) all became owned by the <a href=\"https://github.com/freebsd/\">FreeBSD GitHub organization</a>. Since then, I’ve seen a flurry of PRs reviewed and merged into the project, which makes me happy, really, because the people that care now have the chance to do what’s best for the project.</p><p>Plus, you know what? Even if Kyua has some “design flaws” because it was not designed to be exactly like Blaze, it does have some <em>other</em> interesting ideas that make it a good-enough fit for FreeBSD. In particular, one design principle behind ATF and Kyua was to allow running a test suite <em>without</em> having access to the source code.</p><p>Actually, I think this was a killer idea in the original design of ATF. The motivation for “running tests without the source” was to allow installing a system from scratch and then let <em>the end user</em> run the tests to verify that the system worked correctly <em>on their specific software/hardware combination</em>. The BSDs have limited resources and cannot do the sorts of testing that e.g. Microsoft does with Windows so, by pushing the tests “to the edge”, users could fill that gap.</p><p>And to illustrate this novel-at-the-time idea, let’s take a tour.</p><h1>Kyua in FreeBSD 14</h1><p>Kyua is part of the FreeBSD base system and, as such, it is installed under <code>/usr/bin/kyua</code> and is available out of the box.</p><p>Similarly, the test suite is available under <code>/usr/tests</code> if you choose to unpack <code>tests.txz</code> during the system installation. Peeking under it, we find:</p><pre><code><code>/usr/tests$ ls -F
Kyuafile     conftest.py  lib/         sys/
README       etc/         libexec/     usr.bin/
__init__.py  examples/    local@       usr.sbin/
atf_python/  games/       sbin/
bin/         gnu/         secure/
cddl/        include/     share/
/usr/tests$ █</code></code></pre><p>We can use <code>kyua list</code> to see what kind of test coverage we have. This command prints one test case name per line in its default output format, so we can easily count how many tests there are:</p><pre><code><code>/usr/tests$ kyua list | wc -l
8246
/usr/tests$ █</code></code></pre><p>8000+ tests. Not bad! Let’s peek into a tiny sample by focusing on the tests for <code>dd(1)</code>:</p><pre><code><code>/usr/tests$ kyua list bin/dd
bin/dd/dd2_test:max_seek
bin/dd/dd2_test:seek_overflow
bin/dd/dd2_test:sigint_open
bin/dd/dd2_test:sigint_read
bin/dd/dd_test:io
bin/dd/dd_test:length
bin/dd/dd_test:seek
/usr/tests$ █</code></code></pre><p>And let’s run those!</p><pre><code><code>/usr/tests$ time kyua -v parallelism=$(nproc) test bin/dd
bin/dd/dd2_test:seek_overflow  ->  passed  [0.042s]
bin/dd/dd2_test:max_seek  ->  skipped: tmpfs can't create arbitrarily large sparse files  [0.044s]
bin/dd/dd_test:length  ->  skipped: fdescfs is not mounted on /dev/fd  [0.024s]
bin/dd/dd_test:seek  ->  passed  [0.048s]
bin/dd/dd_test:io  ->  passed  [0.071s]
bin/dd/dd2_test:sigint_read  ->  passed  [3.077s]
bin/dd/dd2_test:sigint_open  ->  passed  [3.079s]
Results file id is usr_tests.20240728-161942-793100
Results saved to /home/jmmv/.kyua/store/results.usr_tests.20240728-161942-793100.db
7/7 passed (0 failed)
kyua -v parallelism=$(nproc) test bin/dd  0.17s user 0.33s system 15% cpu 3.198 total
/usr/tests$ █</code></code></pre><p>Easy peasy. We can run tests for any part of the system right from the <code>/usr/tests</code> hierarchy without having had to build anything nor needing access to the source tree. As mentioned earlier, you can use this feature to validate that FreeBSD works on your specific machine given that device drivers are of varying quality (something that’s true on <em>any</em> operating system) and may result in different behavior. And you can use this feature to validate that the system <em>continues to work</em> as you perform upgrades over time.</p><p>Outside of your machine, though, we can also look at the CI system based on Jenkins. For that, head to <a href=\"https://ci.freebsd.org/\">https://ci.freebsd.org/</a> and peek around. Notice the tens of different jobs configured to build and test FreeBSD under various architectures, releases, and build settings.</p><p>As an example, look at the recent <a href=\"https://ci.freebsd.org/job/FreeBSD-main-amd64-test/25361/testReport/\">run 25361 of FreeBSD-main-amd64-test</a>, and notice how we can inspect the same test results we saw on the command line. Do so by clicking on <code>bin.dd</code> and finding the results for the same tests we ran earlier. This showcases Kyua’s ability to generate a <code>junit.xml</code> test report—an output format that was precisely written to integrate with Jenkins for the FreeBSD CI system.</p><div><hr></div><p>And that’s it.</p><p>The morale of the story is two-fold. First, free software can remain alive and kicking even if the original authors lose interest. And second… do you see how powerful it is to have a CI system for <em>a whole OS</em>? This is something Linux can only dream of because of its inherent distributed development nature. Yes, there is the <a href=\"https://github.com/linux-test-project/ltp\">Linux Test Project</a>, but because Linux is “just a kernel”, this is what this project can test. There is nothing that can validate that the kernel works in combination with all other pieces that form a Linux distribution in a uniform and cohesive manner.</p><p>In any case, congrats grads. Kyua has a bright future ahead.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F046aae7a-faff-47b0-83a3-d1afdd0e7728_1536x1536.jpeg" "0.0" "image/jpeg") nil "2e1527e2fe24ba5fa7ba46771343889e") (7 (26569 31003 251537 72000) "https://blogsystem5.substack.com/p/crowdstrike-and-rust" "Rust doesn't solve the CrowdStrike outage" "Julio Merino" "Tue, 23 Jul 2024 14:10:43 +0000" "<p>Look, I like Rust. I really, really do, and I agree with the premise that memory-unsafe languages like C++ should not be used anymore. But claiming that Rust would have <em>prevented</em> the massive outage that the world went through last Friday is misleading and actively harmful to Rust’s evangelism.</p><p>Having CrowdStrike written in Rust would have <em>minimized</em> the chances of the outage happening, but not resolved the root cause that allowed the outage to happen in the first place. Thus, it irks me to see various folks blanket-claiming that Rust is the answer. It’s not, and pushing this agenda hurts Rust’s adoption more than it helps: C++ experts can understand the root cause and see that this claim is misleading, causing further divide in the systems programming world.</p><p>So, why won’t Rust help? Let me try to answer that question, but while we are at it, let’s also delve deeper into the causes of the outage. In a way, let me put my SRE hat on and write my own version of the postmortem.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":343660,\"alt\":\"\",\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" title=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><h1>The outage</h1><p>Here is what <a href=\"https://www.crowdstrike.com/blog/falcon-update-for-windows-hosts-technical-details/\">CrowdStrike’s official “postmortem”</a> has to say about the problem that the industry faced:</p><blockquote><p>On July 19, 2024 at 04:09 UTC, as part of ongoing operations, CrowdStrike released a sensor configuration update to Windows systems. Sensor configuration updates are an ongoing part of the protection mechanisms of the Falcon platform. This configuration update triggered a logic error resulting in a system crash and blue screen (BSOD) on impacted systems.</p><p>The sensor configuration update that caused the system crash was remediated on Friday, July 19, 2024 05:27 UTC.</p></blockquote><p>Paraphrasing:</p><ol><li><p>CrowdStrike (the company) pushed a configuration change.</p></li><li><p>The change tickled a latent bug in “the Falcon platform” (the product).</p></li><li><p>This bug in Falcon resulted in a crash that brought down Windows.</p></li></ol><p>The first two points are not too strange: configuration changes are “business as usual” for any online system and having changes tickle bugs in code is unfortunately common. In fact, the majority of the outages (citation needed) are caused by human-initiated configuration changes.</p><p>Obviously, we should ask why the bug existed and how it could be remediated in order to increase the robustness of the product. But we must also question the third point: why was the bug able to bring down the whole machine? And, much more importantly, why did this bug bring down <em>so many systems</em> across the world?</p><h1>The memory bug</h1><p>Let’s start with the first question: what was the nature of the bug in Falcon?</p><p>Easy: there was a logic bug in the “Channel Files” (aka configuration files) parser that, given some invalid input, made the code try to access an invalid memory position. The details are really not interesting: this could be have been a null pointer dereference, a general protection fault, or whatever. The point is: the crash was triggered by an invalid memory access issue.</p><p>And this is where some Rust enthusiasts will zero in and say “Ah-HAH! We got you, fools. If the code had been written in Rust, this bug would not have existed!” And, you know what, that’s literally true: this specific bug would not have happened.</p><p>But so what? Avoiding this specific type of error would just have delayed this outage until another time when a different class of error that Rust doesn’t protect against happened. (This is the exact same argument I raised in a <a href=\"https://jmmv.dev/2018/07/forbidden-assertions-fallacy.html\">critique of forbidding assertions in Go</a> back in 2018 by the way.) Focusing on the memory bug is missing the forest for the trees because of the nature of what Falcon is.</p><p>OK so, what is Falcon?</p><h1>The kernel crash</h1><p>Falcon is “malware… but for the good guys”. Oops, I mean: Falcon is an endpoint security system. Falcon is a product typically installed on corporate machines so that the security team can detect and mitigate threats in real time (while monitoring the actions of their employees). There <em>is</em> some value in this: most cyberattacks (citation needed again) start by compromising corporate machines, often via social engineering practices.</p><p>This type of product must have control over the machine. It must be able to intercept all user file and network operations to scan their content. And it must be tamper-proof so that “savvy” corporate users don’t disable it when they read sketchy online instructions to fix their broken WiFi in an attempt to (<em>shudder</em>) not have to create IT tickets.</p><p>How can you <em>implement</em> a product like Falcon? The easiest approach, and the approach that Windows encourages, is to write a kernel module. It easily follows that Falcon is a kernel module and, as such, it runs in kernel space. This means that any mess up in Falcon’s code can damage the running kernel and, in turn, bring the whole system down.</p><p>And when I say “any mess up”, I really mean it. The kernel is not only brought down by memory errors, and you don’t have to “crash the kernel” to make a machine unusable. Think of a deadlock preventing the kernel from making forward progress. Think of a logic error in the <code>open(2)</code> system call handler preventing user space from opening any file later on. Think of mistakenly mapping file system code as pageable when it should never be paged out. Think of writing an unbounded recursive algorithm that exhausts the kernel’s stack. Think of… an innocent buggy <code>unwrap()</code> call if the code actually used Rust.</p><p>There are just too many ways to destroy the kernel’s stability, which is why claiming that Rust would have prevented this incident irks me. Rust’s memory-safety only addresses one type of crash. It is true, though, that the focus on correctness in the Rust ecosystem via strong types could minimize the chances of other types of logic bugs. But… as much as we want to reach perfection, we must accept that bugs happen, and asserting that Rust is <em>the only answer</em> to the problem is as negligent as sticking to C++.</p><p>And, you know, there are many more C++ developers that work in kernel space than Rust developers know kernel internals (oops, another citation need). So, naturally, a large portion of C++ developers can smell the rubbish in this claim. Which is unfortunate because this increases animosity between the two communities, which goes against the goal of converting folks to safe languages. Rust folks <em>know</em> that Rust can definitely help make the situation better, but C++ folks cannot get bought into it because the arguments they hear don’t resonate with them.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">If you are enjoying this article, consider subscribing to Blog System/5. It’s completely free, but paid subscriptions help support my writing and my open source software.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>From kernel space to user space</h1><p>There have <em>also</em> been other claims saying that this would not have happened at all if Falcon was <em>not</em> running in the kernel. OK, that’s a better take, but… it is not crystal-clear that this alone would help either.</p><p>As I mentioned earlier, Falcon needs to be as tamper-proof as possible to prevent malware from interfering with it and compromised users from trying to disable it. And if malware or humans were able to easily do that, then the product would be as useless as nothing.</p><p>Now, the Windows kernel could definitely forbid kernel modules for anything similar to Falcon. Instead, the kernel could expose a bunch of APIs so that user space applications could hook into them to expose similar functionality. And you know what? Microsoft <em><a href=\"https://news.microsoft.com/2009/12/16/microsoft-statement-on-european-commission-decision/\">did</a></em><a href=\"https://news.microsoft.com/2009/12/16/microsoft-statement-on-european-commission-decision/\"> try to move Windows in that direction</a>, but the antivirus mob threatened to sue on antitrust grounds and the whole thing went nowhere. So we are stuck with a less secure system because antivirus companies need to be able to sell their obnoxious products.</p><p>But let’s step aside from that dumpster fire for a moment. Even if Falcon ran in user space and communicated with the kernel via controlled APIs… would that be sufficient to prevent a system malfunction? Note that these APIs would need to be tamper-proof too. Imagine if, say, you wanted this user space driver to validate every binary before it’s executed by the kernel. If you make the kernel <em>require</em> an answer from the user space driver on every execution, and such driver is faulty, the system won’t be able to execute any program anymore. And if you make it <em>optional</em> for the kernel to communicate with the driver so that the kernel can tolerate a crashing driver, then you open up a path for malware to try to crash the driver first and then infiltrate the system.</p><p>Thus it is not obvious that “just moving to user space” is the answer here either. Oh, by the way, Apple has been moving macOS in the direction of disallowing kernel modules for years and providing alternative APIs to implement things like file systems and antivirus-type software without kernel privileges. They also have this kind of security daemon running in user space in the default system which validates process executions, and <a href=\"https://jmmv.dev/2017/10/fighting-execs-sandboxfs-macos.html\">drove me crazy a while back</a>.</p><h1>The bug is in the deployment</h1><p>If we must accept that bugs exist, that memory-related bugs are not the only ones that can kill a system, and that moving the driver to user space isn’t an obvious fix either… are we doomed? Is there nothing we could do to prevent this from happening?</p><p>The above are all things that could (and should!) be done to reduce the chances of a misbehavior happening, but we must accept that the code bug was just <em>the specific trigger this time around</em> and a different trigger could have had similarly nefarious consequences. The root cause behind the outage lies in the <em>process</em> to get the configuration change shipped to the world.</p><p>Now, SRE 101 (or DevOps or whatever you want to call it) says that configuration changes must be staged for slow and controlled deployment, and validated at every step. Those changes should first be validated in a very small scale before being pushed to the world later on, and every push should be incremental.</p><p>I find it quite hard to believe that CrowdStrike has nothing to validate deployments given the criticality of Falcon and the massive impact that a bug can have (and has had). Maybe they don’t have any process whatsoever as the external evidence seems to suggest, which would be incredibly negligent, <s>but let’s give them the benefit of the doubt</s>. (<strong>Update July 24th:</strong> According to CrowdStrike’s <a href=\"https://www.crowdstrike.com/falcon-content-update-remediation-and-guidance-hub/\">updated postmortem</a>, they actually <em>do not</em> have any sort of testing nor canarying. So it is indeed incredibly negligent.)</p><p>Part of why I say this is due to new information from Microsoft with an assessment of how many machines were impacted by the outage. Here is <a href=\"https://blogs.microsoft.com/blog/2024/07/20/helping-our-customers-through-the-crowdstrike-outage/\">what Microsoft has to say</a>:</p><blockquote><p>While software updates may occasionally cause disturbances, significant incidents like the CrowdStrike event are infrequent. We currently estimate that CrowdStrike’s update affected 8.5 million Windows devices, or less than one percent of all Windows machines. While the percentage was small, the broad economic and societal impacts reflect the use of CrowdStrike by enterprises that run many critical services.</p></blockquote><p>Read that: “less than 1% of the machines were impacted”. Does this mean that CrowdStrike <em>does</em> have a staged rollout in which they push configuration changes to just a subset of 1% of the machines worldwide? That doesn’t seem crazy actually and is in line with how many services are deployed, but if that’s their <em>first</em> step in the deployment process, it’s time to reevaluate their approach because this 1% of machines is way too many and has proven to be catastrophic. (This is leaving aside the question of whether 1% refers to the total number of Windows machines in the world or 1% of Windows machines with CrowdStrike on them.)</p><p>The question that remains answering, then, is what sort of testing happened between “the configuration change is done” to “let’s roll it out to 1% of the world”. <em>Did any testing happen at all?</em> That’s where it gets concerning and where we may not get any official information on the matter from CrowdStrike. (<strong>Update July 24th:</strong> We did get <a href=\"https://www.crowdstrike.com/falcon-content-update-remediation-and-guidance-hub/\">an update</a> and it confirms that they actually do not have any sort of rollout progressive deployment.)</p><p>So, yes, CrowdStrike’s deployment practices are definitely to blame for the incident. This outage <em>was a process problem</em>, not <em>a code/technology problem</em>.</p><h1>Downstream companies</h1><p>Before concluding, let’s shift away from CrowdStrike and look at the downstream companies impacted by this bad configuration push. Did you notice how many companies were absolving themselves from problems by pointing out that “due to a third-party IT incident” their service was down? OK, yes, that is literally true once again, but pointing fingers is not helpful.</p><p>The problem in this situation is the monoculture around CrowdStrike. Certain security certifications require “endpoint protection” as a line item and it seems perfectly plausible that most IT departments just deploy Falcon due to aggressive marketing from CrowdStrike’s part and call it a day without putting any more thought into it. It’s just not interesting to them to spend any extra time on the issue.</p><p>But this raises a problem: dependencies are always a liability, and when you choose to take a dependency on another vendor or another piece of code, you must own your choice. You must model how your own system will fail when the dependency fails, and then, if the risk warrants it, engineer a solution around the potential problem.</p><p>I do not know how Falcon works, so I cannot tell if CrowdStrike offered sufficient clarity on how upgrades work to customers or even if their product offers a way to control how the deployment of configuration changes happens within an organization. These are things that will have to be built so that the few customers that care can increase the reliability of their systems.</p><h1>Is there an attack vector?</h1><p>And finally, let’s talk about the last part of CrowdStrike’s official statement:</p><blockquote><p>This issue is not the result of or related to a cyberattack.</p></blockquote><p>Is that true? We may never know. It is unlikely that this <em>is</em> a cyberattack because crashing systems left and right doesn’t seem to serve a clear purpose. I guess you could claim that an attacker may have wanted to hide something <em>else</em> while the world was scrambling, and that might be possible, but… well, you can imagine all sorts of conspiracy theories.</p><p>What <em>is</em> interesting is this part of CrowdStrike’s official postmortem:</p><blockquote><p>Although Channel Files end with the SYS extension, <em>they are not kernel drivers</em>.</p></blockquote><p>Emphasis theirs. Funny, huh? They seem to be wanting to hide the fact that Falcon doesn’t run in the kernel. But it does. Knowing that these files are not drivers is not comforting: the kernel module is reacting to changes to these files and thus these files influence the behavior of the kernel. As a result, it seems plausible that malformed Channel Files could tamper with the kernel in ways that do not result in more subtle ways than just a blatant crash.</p><p>And <em>this</em> situation, my friend, is precisely where Rust would definitely help. Rust’s memory safety would minimize the chances that a malformed configuration file could exploit bugs like buffer overflows to escalate privileges within the kernel, resulting in much more subtle, but dangerous, attacks.</p><p>But that’s not what happened this time around.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F500912f5-08c4-47e0-b43e-834b4f262011_1536x1536.jpeg" "0.0" "image/jpeg") nil "2ccd6fc3bcb35a8754fc2e23ccf73bab") (6 (26569 31003 250314 672000) "https://blogsystem5.substack.com/p/endbasic-0-11" "EndBASIC 0.11 is here" "Julio Merino" "Sat, 20 Jul 2024 14:01:40 +0000" "<p>Dear readers,</p><p>I hope you don’t mind me reposting an exciting EndBASIC release announcement here. There are at least two good reasons for me to do this, but before covering those, look at this glorious welcome window:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\" width=\"880\" height=\"660\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":660,\"width\":880,\"resizeWidth\":null,\"bytes\":94233,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The EndBASIC online interpreter loading a trivial program to welcome you all.</figcaption></figure></div><p>So what are those two reasons you ask? Well…</p><p>The first is that EndBASIC is very much in context for the topic of this blog (right?) and my work on it is a source of ideas for future articles. The backlog has grown quite long so… stay tuned.</p><p>The second is that my free time is really limited and I tend to hyperfocus on individual topics for months in a row. Sometimes I’m in “blog-only mode” like at the beginning of this year when Blog System/5 received lots of attention. Other times I’m in “code-only mode” like during the past five months where I devoted all my time to EndBASIC. And as a consequence, this publication suffered. But I’m still here, and with this release out of the way, this blog should receive more attention throughout the rest of the sumer.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Did you know that subscribing to Blog System/5 is completely free? There are paid options as well though, and any donations go towards supporting my writing <em>and</em> these open source projects.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Without further ado, let’s get into the content of the announcement. You can find the <a href=\"https://www.endbasic.dev/2024/07/endbasic-0.11.html\">original copy in the EndBASIC blog</a>.</p><div><hr></div><p>After a year-and-a-half long hiatus, I am pleased to announce that EndBASIC 0.11.0 is now available! 🥳</p><p>This release marks a significant milestone because it addresses <em><strong>the</strong></em> top feature request from you all, namely the ability to define custom functions and subroutines. But it also includes other goodies such as support for an LCD console, a shiny new disassembler, and a faster execution engine.</p><p>There is a lot to talk about, but before we get to that, here are the must-visit links:</p><ul><li><p><strong><a href=\"https://repl.endbasic.dev/\">Launch the online interpreter</a></strong></p></li><li><p><strong><a href=\"https://github.com/endbasic/endbasic/releases/tag/endbasic-0.11.0\">Read the release notes</a></strong></p></li><li><p><strong><a href=\"https://repl.endbasic.dev/?run=jmmv/life.bas\">Launch a Conway’s Game of Life demo</a></strong></p></li></ul><p>Without further ado, let’s take a peek into the major changes.</p><h1>User-defined functions and subroutines</h1><p>As I mentioned earlier, EndBASIC 0.11 addresses the top feature request of all times: support for user-defined functions and subroutines. <a href=\"https://www.endbasic.dev/2022/12/endbasic-0.10.html\">EndBASIC 0.10</a> addressed some of the pain by adding <code>GOTO</code> and <code>GOSUB</code> but there was still a need for structured callables with parameter passing and local variables.</p><p>Something like the following is finally possible:</p><pre><code><code>DIM SHARED sum_calls AS INTEGER
FUNCTION sum(a, b)
sum = a + b
sum_calls = sum_calls + 1
END FUNCTION
SUB print_sum(prefix AS STRING, a, b)
PRINT prefix; sum(a, b)
END SUB
print_sum \"The sum of 5+7 is:\", 5, 7
print_sum \"The sum of 1+2 is:\", 1, 2
PRINT \"sum has been called\"; sum_calls; \"times\"</code></code></pre><p>Easy peasy, right? Indeed it is! But getting here required redoing a <em>huge</em> portion of the compiler and VM internals.</p><p>One major piece to resolve this puzzle was to implement a declarative arguments parser for the callables. Up until now, every builtin command and function carried hand-crafted code to parse its arguments. This was not a great design choice due to large amounts of code duplication and the risk of inconsistencies between commands and documentation, but it was the simplest way to get something off the ground a few years back.</p><p>I had been meaning to resolve this long-standing “to-do” but, the thing is, <a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">BASIC makes it </a><em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\">really</a></em><a href=\"https://www.endbasic.dev/2023/01/endbasic-parsing-difficulties.html\"> difficult</a> to come up with a generic arguments parser: every command has its own ad-hoc syntax. I needed a solution though, and after having implemented many commands in the previous 10 releases of EndBASIC, I landed on a handful of generic-enough constructs to serve my purposes… for now.</p><p>With this new release, every command and function specifies the structure of its arguments in a declarative fashion. The compiler then uses the generic parser to translate the arguments into call stack values based on what each callable defines. Then, at runtime, every callable just pops typed values off the call stack assuming that they are correctly parsed. Runtime execution of callables is now more efficient than before.</p><p>But there was another obstacle to resolve to support user-defined functions, and this was converting the expression evaluator to bytecode.</p><h1>Bytecode-based expression evaluation</h1><p>EndBASIC 0.10 shifted the virtual machine from an AST processor to a bytecode evaluator in order to support <code>GOTO</code> and <code>GOSUB</code>. However, the bytecode was really just a trivial lowering of the AST: expressions remained as AST nodes in the bytecode. This was fine for that release, but in order to support calling user-defined functions from within expressions, the expression evaluator needed a way to shift execution from builtin code to interpreted code and viceversa. As other languages call it, addressing “<a href=\"https://blog.bazel.build/2017/03/07/java-sandwich.html\">the sandwich problem</a>”.</p><p>The way to resolve this was to modify the compiler to emit bytecode for expression evaluation as well, thus turning the bytecode into “real bytecode” not polluted by AST elements. This was easy enough to prototype, but performance obviously suffered: what was previously handled in native code now required executing tens of bytecode instructions.</p><p>I had to do significant follow-up work to shift most of the type-checking that happened at runtime to the compiler, thus freeing the VM from complex conditional logic during execution. And the efforts paid off. As a benchmark, I stripped down the Game of Life demo of its UI and made it run 500 iterations on a 200x200 board. EndBASIC 0.10 needs 25 seconds to process this while 0.11 only needs 15 seconds. That’s a 40% improvement, and the optimization work is far from done.</p><p>And after doing all of this, I could not resist adding a disassembler. This is just a gimmick right now because the only thing you can do with the disassembled code is peek into the inner workings of the VM, but hey, that’s didactic on its own so it tracks well with the vision for EndBASIC.</p><p>Here, witness:</p><pre><code><code>Ready
LIST
a = 3
PRINT 5.2 + a
Ready
DISASM
0000    PUSH%       3                           # 1:5
0001    SETV        A
0002    PUSH#       5.2                         # 2:7
0003    LOAD%       A                           # 2:13
0004    %TO#
0005    ADD#                                    # 2:11
0006    PUSH%       2                           # 2:7
0007    CALLB       PRINT, 2                    # 2:1
Ready
█</code></code></pre><h1>LCD console</h1><p>The other big change in EndBASIC has to do with a new backend for its console.</p><p>Two years ago, when I was <a href=\"https://www.endbasic.dev/2021/02/endbasic-0.6.html\">adding GPIO support to EndBASIC</a>, I bought a little LCD for my Raspberry Pi and I envisioned using it to display the EndBASIC console. I did not get to it at the time but, this year, having spent too much time exclusively on Blog System/5, I needed to get back to coding. Working on a driver for the LCD is what sparked my interest to hack EndBASIC again and is what ended up triggering the chain of events that brought you 0.11 today.</p><p>I won’t bore you too much with the details about this because I already published a <a href=\"https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an\">separate blog post</a> that goes into the full story. To recap, let me just show you how this looks like in action:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"ed030d16-5773-4427-ba0e-fc628a219262\",\"duration\":null}\"></div><p><em>EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.</em></p><h1>Known issues</h1><p>There is one big issue that has come up last minute, and it is that the graphics console does <em>not</em> work on macOS anymore. My understanding is that my SDL driver violates fundamental assumptions of macOS (and possibly Windows as well) by driving the SDL interactions from a <em>secondary</em> thread. I suspect something has changed in macOS that makes this break. I’m not sure if my theory is true though, but even proving the theory is not trivial at all—so I have chosen to ship 0.11 “as is” even if this is broken because 0.10 and earlier are broken too. If you happen to use macOS, I’m sorry, you’ll have to fall back to the web interpreter.</p><p>Also, retrofitting bytecode execution into the AST-based evaluator has not been easy and, as a result, the code has accrued significant technical debt. Many things can still be simplified in the codebase and those would yield much faster runtime execution. But once again, I have had to draw a line and call the current implementation “good enough” in order to ship. Rewrites are never a good idea, but I’m at a point where a rewrite of the VM (<em>not</em> anything else!) from scratch would be beneficial.</p><p>And to be honest: I need a little break. I have spent all of my free time during the last 5 months on EndBASIC and I have neglected other things I want to do. In particular, Blog System/5 has suffered quite a bit and there are a bunch of topics I want to blog about. So I have had to force the 0.11 release in order to breathe for a little bit. But don’t worry: I’ll be back for more.</p><p>In any case, EndBASIC 0.11 should be the best EndBASIC to date. Go forth and play!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://repl.endbasic.dev/\",\"text\":\"Launch online interpreter\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://repl.endbasic.dev/\"><span>Launch online interpreter</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc7a165a3-24f6-4020-8827-db6bfb7f9c62_880x660.png" "0.0" "image/jpeg") nil "0804ffb92aacab0df242970efa63bd85") (5 (26569 31003 248968 824000) "https://blogsystem5.substack.com/p/20-years-of-blogging" "20 years of blogging" "Julio Merino" "Sat, 22 Jun 2024 16:01:01 +0000" "<p><a href=\"https://blogsystem5.substack.com/\">Blog System/5</a> hasn’t always been called this way and it hasn’t been my first experience with blogging either. In fact, today marks the 20th anniversary of this publication in its various incarnations so it’s time for a bit of reflection.</p><p>Just to set context for when 20 years ago was: Windows XP was almost 3 years old, Ubuntu had just debuted, Apple computers were still PowerPC-based, Half Life 2 was about to launch, and Slashdot was the place to be instead of the yet-to-be-created Hacker News. As for myself, I was still in college, had copious amounts of free time, and was a really active contributor to NetBSD.</p><p>So let’s start with a trip down memory lane before getting into the retrospective and the analysis of how <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">my Substack experiment</a>, which started late last year, has turned out. Beware that because this is an introspection post, all of the generalizations that follow are backed by feelings, not hard data, so take them with a grain of salt.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Before continuing, take a moment and consider subscribing. It’s completely free but knowing that you care is what makes this publication exist!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>History: Episode one</h1><p>Looking back at <a href=\"https://jmmv.dev/2004/06/welcome-to-my-new-journal.html\">my very first post from June 22nd, 2004</a>—oh wow, my English was <em>bad</em>—I had an earlier experiment of a blog a few months prior that didn’t last more than three entries. But the newer iteration, started during college finals of course, did stick. I originally chose the LiveJournal platform because it had more features than Blogger, and thus “jmmv’s weblog” was born. Why “weblog” and not “blog”? Because the “blog” term wasn’t yet the popular one.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":140932,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of the \"jmmv's weblog\" site on LiveJournal via the Wayback Machine. <a href=\"https://web.archive.org/web/20041126220647/http://www.livejournal.com:80/users/jmmv/\">Scraped on November 26th, 2004.</a></figcaption></figure></div><p>My choice of LiveJournal didn’t last very long though. I migrated to Blogger on <a href=\"https://jmmv.dev/2005/10/blog-migrated-to-blogger-welcome.html\">October 22nd, 2005</a> because it had improved significantly by then and it was growing in popularity. As part of that transition, I renamed the blog to “The Julipedia”—a nickname that a friend gave me because I usually had answers to all of his Linux-related questions. And yes, Wikipedia was a pretty new thing back then too, having just launched in 2001 and still being mocked as “the thing that will never compete with real encyclopaedias”. Ha, ha.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/dc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":170754,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdc4fca6d-3d8c-4a3a-ae45-344901069c13_1024x683.png 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of \"The Julipedia\" site on Blogger via the Wayback Machine. <a href=\"https://web.archive.org/web/20060412020801/http://julipedia.blogspot.com/\">Scraped on April 12th, 2006.</a></figcaption></figure></div><p>Blogger was just fine for a long time… until Google+ messed things up in 2011 or so. During that era, Google was shoehorning their social platform everywhere, and part of that process was optionally injecting the commenting system of Google+ into Blogger. I took the bait and adopted the new commenting experience—which, in other words, meant that I killed engagement overnight.</p><p>In any case, I continued to hold onto Blogger until about 2015. At that point, Medium was the new hot thing and, having grown disillusioned with Blogger’s staleness—the platform didn’t receive any love because all development and product resources had gone into the dwindling Google+—<a href=\"https://jmmv.dev/2015/05/hello-medium.html\">I gave it a try</a>.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":90465,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F583f49e0-9ca4-4024-a008-1719307fdf77_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of my Medium publication via the Wayback Machine. <a href=\"https://web.archive.org/web/20160701041554/https://medium.com/@jmmv\">Scraped on July 1st, 2016.</a></figcaption></figure></div><p>Medium was great: its UI was <em>neat</em> and their value proposition was that their network would help me increase the reach of my articles while offering a delightful publishing experience. But things went downhill pretty quickly too: the desire to monetize Medium made it gain aggressive subscription popups and paywalls everywhere, and it started filling up with “Top N things to XYZ” spam. AI-generated garbage? Not yet, but close. Yikes SEO.</p><h1>History: Episode two</h1><p>My Medium experiment <a href=\"https://jmmv.dev/2016/01/medium-experiment-wrapup.html\">didn’t last very long</a>. I published 8 posts over the course of 5 months but I knew I had to move elsewhere. Part of this move involved exporting those 8 posts and reimporting them into Blogger, which was easier said than done. Medium offered an “export” feature indeed, which sold me in the first place to try it out, but the <em>content</em> of the export was <em>unusable</em>. It took a lot of effort to clean up the tainted HTML that the platform produced to reimport it anywhere else. And this is when it hit me: I was not in control of my content, which was validated by seeing that Blogger’s export suffered from the same issues.</p><p>Which drove me to static hosting. <a href=\"https://jmmv.dev/2016/05/homepage-v3.html\">I extended the trivial homepage I already had</a> on the web with a blog section, built with Jekyll first and <a href=\"https://jmmv.dev/2018/02/from-jekyll-to-hugo.html\">then with Hugo</a>, and managed my blog in there for about 8 years. I dabbled with going back to a CMS a few times because the authoring experience in Markdown+Git+Hugo isn’t particularly… amenable to posting. But every time I prototyped an alternative, I ended up hitting the same roadblocks around content ownership. I wanted to own the originals in a future-proof format.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\" width=\"1024\" height=\"683\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":683,\"width\":1024,\"resizeWidth\":null,\"bytes\":113718,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff06ed49b-c771-454c-b25f-c6851ac69b86_1024x683.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Earliest image available of my static blog via the Wayback Machine. <a href=\"https://web.archive.org/web/20161224052720/http://julio.meroh.net/\">Scraped on December 24th, 2016.</a></figcaption></figure></div><p>But wait… you are reading this in Substack, aren’t you? “WTH!” you must be thinking. How can I reconcile what I just said with publishing on this platform? Well… over the 8 years of static hosting, it was almost impossible for me to grow my blog’s readership. I tried various things to grow a subscribers base, but nothing worked. And Substack seemed to be the new cool kid on the block where various folks I follow post content, so I had to try it out. This experiment is <a href=\"https://jmmv.dev/2023/10/hello-blog-system5.html\">what brought you Blog System/5 in the first place</a>. And you know what? It has been pretty cool.</p><p>The key difference between the Substack experiment and the Medium experiment is that I’m authoring the content in Markdown first, using the exact same platform I had previously set up for my static blog. Only when the posts are ready to publish, I literally copy/paste them into Substack and then set up a redirect in my static blog to point to Substack. It’s painful indeed, but I feel at peace because I can pull the rug at any time and be back in my happy static blog.</p><h1>Evolution: Writing approach</h1><p>Anyhow, enough talk about the history of the blog. Let’s talk about how its content has changed form over the years and <em>why</em> it has had to change. And to talk about content changes, we must talk about the evolution of audience behaviors: if you care about being read at all, you must consider who you are writing for.</p><p>With that in mind, the obvious question is: do people care about blogs these days? I’d say no, not really. Proof of this is when you hear people say “so and so wrote a blog” (cringe) when they actually mean “a blog <em>post</em>”. The concept of a blog as a personal publication seems to have been lost in favor of individual posts. I’m sure you can think of some recent popular articles that came your way, but, question: can you remember <em>where</em> you read them or <em>who</em> the author was? I bet not.</p><p>As a consequence, the type of content for a long-running blog like this one has had to evolve. Take a moment to skim <a href=\"https://jmmv.dev/archive.html\">through the archives</a> and look for patterns. You might notice that, back when I started blogging, my usual article was about 350 words long and not very polished. This was pretty common in the blogosphere: most blogs had similar short articles, often just describing the author’s “daily doings”.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":23243,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6399468b-d938-423d-88fe-c0cc8ad13bb0_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Median words per post by year for all articles that I've written in this blog and other publications.</figcaption></figure></div><p>Fast-forward to today and you can clearly see a change in the shape of the articles you read here and elsewhere: they are <em>much</em> longer now, even if attention spans are infinitesimally small. One reason is that we used to use blogs like a social network, to publish our “daily doings” for our committed followers to see. Contrast that to today: there is almost zero chance anyone will come across a bunch of short articles frequently enough for them to become an avid reader. The other reason, closely related to this one, is that it’s easier for long-form posts to “go viral”—and while you might not care about reach, some of us do.</p><p>Writing longer-form posts has had a direct inverse consequence on the frequency of the posts though, for obvious reasons:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/f772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":22058,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff772eab6-afe8-49d7-9aa0-446ee55478c3_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Total number of posts per year in this blog, but also including occasional articles in other publications.</figcaption></figure></div><p>Having to dedicate many, <em>many</em>, <em><strong>many</strong></em> hours to every long-form post necessarily means that the frequency of the articles has to decrease. For this blog, you can clearly see that I started strong with a post about every two or three days and now I consider myself lucky if I am able to average two posts per month per year. I also have much less free time available, so whenever I write an article, I want it to be of higher quality than before.</p><p>Fewer articles is not a bad metric per se though. Investing time to write long-form prose is beneficial. Long articles require much more work to put together indeed, but I find that spending such time helps me understand each topic in a better way. Furthermore, one only gets better at writing by, surprise, writing: if you skim through the oldest articles, you’ll notice that they were, ehem, mediocre—yet I made the conscious decision to blog and to do so in English. As a result, I think that my contemporary copy is pretty decent, and this has helped me immensely in my professional environment. I couldn’t have gotten here without going through this long journey.</p><p>The other big difference in how the content has evolved is the presence of pictures:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\" width=\"600\" height=\"371\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":371,\"width\":600,\"resizeWidth\":null,\"bytes\":26460,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F26989e22-23b3-4baf-9057-091a737b0e6d_600x371.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Evolution of the number of posts that include images over time.</figcaption></figure></div><p>In the past, I rarely included pictures in any article: these were not necessary because the articles were shorter and because resharing articles in social media didn’t require pictures to fight for the small chance of being seen. These days, however, you must have pictures in order to make articles stand out when they are shared. And just due to the nature of the longer text, it’s useful to include pictures, diagrams or code snippets to break the wall of text and make the copy easier to digest. Shout out to <a href=\"https://draw.io/\">draw.io</a>, which has been awesome to create diagrams in some recent posts.</p><h1>Evolution: Consumption and audience</h1><p>Shifting gears a little bit, blogs were the true decentralized platform. Any individual could easily start a blog in the service of their choice, possibly self-hosting it if they didn’t want to use a commercial service, and anyone could trivially subscribe to those blogs via one of many RSS aggregators. And, yes, I know, this is true today as well: you can <em>still</em> create a blog and you can <em>still</em> subscribe to (most) blogs via RSS; however, the way blogs are “consumed” has changed.</p><p>One thing that was useful in the past were the so-called “Planets”: websites that acted as curated aggregators of blogs by topic. Some of these still exist, such as <a href=\"https://planet.kde.org\">Planet KDE</a> or <a href=\"http://fedoraplanet.org/\">Planet Fedora</a>, but they don’t <em>feel</em> like they used to. The longer posts and the (ab)use of images has made Planets unwieldy: their front pages are extremely long and contain lots of irregularly-formatted pictures, offering little content cohesion. Years ago, because articles were shorter, more fit in one page, and because Planets were popular, authors often replied to each other’s <s>controversial</s> interesting thoughts by posting on <em>their</em> platform and seeing their articles bubble up through the Planets. Much like a social media timeline these days but without a central authority.</p><p>So, without RSS aggregators or Planets, how do people find blogs now and <em>stay engaged</em>? Well… they don’t for the most part? Organic traffic is pretty much useless at building any kind of following: people come in, read the very few words they were looking for, and vanish right away. Gathering traffic from self-promotion in social media is almost a futile experiment. So the best bet is to have articles turn into “one-off hits” on sites like Hacker News. But even then, the majority of the traffic from those sources ends up being noise as well because it doesn’t lead to conversions into frequent readers. Getting content seen by a reasonable number of people is a fight with every single post.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\" width=\"1071\" height=\"515\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":515,\"width\":1071,\"resizeWidth\":null,\"bytes\":89738,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F77edbfdd-8064-47aa-b6bc-4c79ff476270_1071x515.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Traffic to my blog during the second half of 2022 as captured by <a href=\"https://endtracker.azurewebsites.net/\">my own analytics platform</a>. I selected this period to avoid conflating the data with the creation of Blog System/5 and to avoid a humongous traffic spike driven by the <a href=\"https://jmmv.dev/2023/06/fast-machines-slow-machines.html\">Fast machines, slow machines</a> post that made the other lines impossible to read. Note how there is no growth: the peaks are driven purely by Hacker News and the like.</figcaption></figure></div><p>What am I basing this on? Well, for starters, my blog has had email subscriptions for more than 10 years, first powered by FeedBurner and then by <a href=\"https://jmmv.dev/2023/06/in-house-email-subscriptions.html\">my own mechanism</a>. In that period of time, I only saw the subscribers count rise to about 170, which feels pretty pathetic to be honest. I resisted the urge to add “on-your-face” subscription popups, but the lack of those, the fact that some people are “invisible” because of RSS aggregators, and the fact that readers had to subscribe to the blog via obscure platforms… well, there have few incentives to opt into potential email spam.</p><p>Now compare this past multi-year effort of a self-hosted blog with custom email subscriptions to what I’ve experienced on Substack since the launch of Blog System/5:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\" width=\"742\" height=\"453\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":453,\"width\":742,\"resizeWidth\":null,\"bytes\":20197,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F210c204a-e06c-4ce8-aa89-f3579d004471_742x453.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Subscribers growth during the first 6 months of Blog System/5's existence. I pretty much paused publishing in March to focus on other side projects and thus haven't seen any major growth since.</figcaption></figure></div><p>I created Blog System/5 in late October 2023 and by March 2024 I had already amassed 700+ subscribers. It’s also true that I was lucky to have a few articles spread through Hacker News and other sites, and that I put a lot more effort in crafting these than what I wrote in the past, but still: using a platform that people know, that is focused on writing, and in which <em>readers already have accounts</em> helps with growth. Yes, I’m sure there is a lot of fake accounts in there given that the typical “open count” for any article hovers around 50%, but that feels impressive regardless compared to what I was able to achieve in the past.</p><h1>Evolution: Monetization</h1><p>And before parting, let’s talk about the taboo topic, should we? Every hobby has to become a side hustle these days, right, but God forbid you try to charge for it.</p><p>I have to confess that I’ve dabbled with monetizing my writing and done some experiments. These included: <a href=\"https://jmmv.dev/2009/06/trying-adsense.html\">enabling Google AdSense</a> back when I used Blogger and then <a href=\"https://jmmv.dev/2010/05/ads-gone.html\">running away from it</a>; writing paid-for <a href=\"https://jmmv.dev/2019/10/onlamp-articles.html\">articles for OnLamp</a>, which weren’t really part of this blog originally but were written in the same “spirit”; enabling optional paid subscriptions in Substack, which has generated a handful of leads; and using Amazon affiliate links for certain product-focused articles, which has also generated some sales.</p><p>None of these have generated any meaningful amount of income, but that doesn’t mean it isn’t exciting to see pennies flow in! In any case, I still struggle with the thought of pursuing monetization. It’d feel great to be paid for the effort I put in writing, but in the grand scheme of things, I would not be able to make it my primary income—and I’d probably not want it to be either—without putting in <em>a ton more</em> effort. Plus I like my content to reach as far as possible, which paywalls would prevent.</p><p>Does that mean I will <em>never</em> try to more aggressively monetize this type of content? Never say never, but I have no plans for now. That said, I will still gladly take and infinitely appreciate any donations you might send; don’t be shy!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p><h1>From blogging to… newslettering?</h1><p>Why do I keep writing a blog after 20 years? Because I enjoy the <em>process</em> and the reward of seeing a complete piece be appreciated by many. I know, “views” are a vanity metric, but they do translate into tangible real-world benefits. I’m convinced that I had the chance to land a Google internship in 2008 <em>because</em> of what I wrote in my blog; I’m also pretty certain that my recent job changes have been aided by my writing; and during the last few months, I’ve met some folks I hadn’t seen for a long time and several have exclaimed “hey, I enjoy your blog!” which, let’s be honest, is flattering to hear.</p><p>Are blogs truly dead? The answer sounds like “yes”. But what if I asked you if newsletters are truly dead? The answer sounds like “of course not”, right? And, to me, these two look like essentially the same thing. Maybe the differences lie in the fact that blogs <em>used to</em> be made of much shorter posts and used to be part of a larger community, whereas newsletters focus on longer pieces distributed primarily via email… but considering how blogging itself has evolved for some (including me), the two are identical.</p><p>Which brings me to the final thought of the day: is “Blog System/5” the same as the “jmmv’s weblog” that launched 20 years ago? No, not really. They are quite different beasts at this point, but they still come from the same—even if older—person, they still scratch the same itch, and they are still my main window to showcase ideas and projects to the outside world. So, to me, they are indeed the same.</p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F04ef0612-0116-416a-9d75-6d6a2b497711_1024x683.png" "0.0" "image/jpeg") nil "53ab991d2ac8a6a0c13e73a49129d375") (4 (26569 31003 199327 538000) "https://blogsystem5.substack.com/p/porting-the-endbasic-console-to-an" "Porting the EndBASIC console to an LCD" "Julio Merino" "Fri, 26 Apr 2024 20:31:02 +0000" "<p>Hello again Blog System/5 and sorry for the radio silence for the last couple of months. I had been writing too much in here and neglecting my side projects so I <em>needed</em> to get back to them. And now that I’ve made significant progress on cool new features for <a href=\"https://www.endbasic.dev/\">EndBASIC</a>, it’s time to write about them a little!</p><p>One of the defining characteristics of EndBASIC is its hybrid console: what looks like a simple text terminal at first glance can actually render overlapping graphics and text <em>at the same time</em>. This is a feature that I believe is critical to simplify learning and it first appeared with <a href=\"https://jmmv.dev/2021/11/endbasic-0.8.html\">the 0.8 release</a> back in 2021.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\" width=\"852\" height=\"452\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":452,\"width\":852,\"resizeWidth\":null,\"bytes\":45704,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F2ecae1dc-576a-447f-907b-cef8ed43fe0d_852x452.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">EndBASIC's hybrid console running in the web browser, rendering text and overlapping graphics at once, all controlled from the built-in command prompt.</figcaption></figure></div><p>A few months before that, I had added support for simple GPIO manipulation in <a href=\"https://jmmv.dev/2021/02/endbasic-0.6.html\">the 0.6 release</a> and, around that same time, I impulse-bought a tiny LCD for the Raspberry Pi with the hope of making the console work on it. But life happened and I lost momentum on the project… until recently.</p><p>In this post, I’ll guide you through the process of porting the EndBASIC hybrid console to the ST7735s 1.44\" LCD shown below, which sports a resolution of 128x128 pixels, a D-pad, and 3 other buttons. I will cover the prerequisite work to make the port possible, dig into the GPIO and SPI interface of an LCD, outline the design for a fast rendering engine, and conclude with pointers for you to build your own “developer kit”. Let’s go!</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":838133,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F243b872e-2f2d-490b-9fda-6c63255e4cd0_1500x1500.jpeg 1456w\" sizes=\"100vw\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">The <a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">ST7735s 1.44\" LCD</a>. Photo from back when I first unboxed this little device... on February 7th, 2021.</figcaption></figure></div><h1>Previous implementation</h1><p>Even though I had plans to support graphics in the EndBASIC console from the very beginning, the first versions of the product did <em>not</em> support graphics. That fact didn’t prevent me from defining a <code>Console</code> abstraction anyway because I needed to support various operating systems and, more importantly, write <a href=\"https://jmmv.dev/2020/12/unit-testing-a-console-app.html\">unit tests for the console</a>. Such abstraction was a straightforward trait representing text-only operations, like this:</p><pre><code><code>trait Console {
fn clear(&mut self, how: ClearType) -> io::Result<()>;
fn color(&self) -> (Option<u8>, Option<u8>);
fn print(&mut self, text: &str) -> io::Result<()>;
// ... and more text operations ...
}</code></code></pre><p>Later on, when the time came to add graphics support, I extended the <code>Console</code> trait with additional rendering primitives, like this:</p><pre><code><code>trait Console {
// ... same as previous ...

fn draw_circle(&mut self, _center: PixelsXY, _radius: u16)
-> io::Result<()>
{
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}

fn draw_pixel(&mut self, _xy: PixelsXY) -> io::Result<()> {
Err(io::Error::new(io::ErrorKind::Other, \"No graphics support\"))
}
// ... and more graphics operations ...
}</code></code></pre><p>What constitutes a primitive or not depends on the graphics device. In the snippet above, it’s fairly easy to understand why <code>draw_pixel</code> exists. But why is <code>draw_circle</code> there? SDL2, for example, does not provide a circle drawing primitive and forces you to implement your own algorithm on top of individual pixel plotting. However, the HTML <code>canvas</code> element <em>does</em> provide such a primitive and thus it is important to expose access to it for performance reasons.</p><p>A reasonable design, right?</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to support my writing and my work in projects like EndBASIC. It’s free but donations are appreciated!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><p>Not quite. The problem is that mixing the textual and graphical operations under just one abstraction bundles two concepts together. Take, for example, the innocent-looking <code>print</code> function: writing text to the console requires knowing the current cursor position, writing text at that location, wrapping long lines, and then updating the cursor position and moving its glyph. This sequence of operations is given to us “for free” when the <code>Console</code> is backed by a terminal—the kernel or terminal emulator handle all details—but none of this exists when you stare at a blank graphical canvas.</p><p>As a result, the SDL2 and the HTML canvas console implementations had to supply their own code to represent a textual console on top of their backing graphical canvases. But due to tight timelines—I wanted to release graphics support <a href=\"https://vimeo.com/641791002\">in time for a conference</a>—I ended up with <em>a lot</em> of copy/pasted code between the two. Unfortunately, it wasn’t just copy/pasted code. Oh no. It was copy/pasted code with minor variations throughout. For example: SDL2 coordinates are <code>i32</code> whereas HTML canvas coordinates are <code>float</code>s.</p><p>This duplication with minor differences required unification before attempting to write a console driver for the LCD because I could not afford to introduce yet another duplicate of the same code.</p><h1>Past NetBSD experience to the rescue</h1><p>The first step to resolving this conundrum was to unify the implementation of the two graphical consoles as much as possible. Having worked on <a href=\"https://www.netbsd.org/docs/guide/en/chap-cons.html\">NetBSD’s wscons console framework</a> eons ago, I knew how this had to be done.</p><p>The idea was to separate the text console manipulation from the underlying graphics primitives. As you can imagine, the way to do this was via a new abstraction, <code>RasterOps</code>, providing direct access to the “raster operations” of the graphics device. Take a look:</p><pre><code><code>trait RasterOps {
fn draw_circle(&mut self, center: PixelsXY, radius: u16)
-> io::Result<()>;
fn draw_pixel(&mut self, xy: PixelsXY) -> io::Result<()>;
fn move_pixels(&mut self, x1y1: PixelsXY, x2y2: PixelsXY,
size: SizeInPixels) -> io::Result<()>;
fn write_text(&mut self, xy: PixelsXY, text: &str)
-> io::Result<()>;
// ... and more operations ...
}</code></code></pre><p>As you can see in this snippet, the earlier operations <code>draw_circle</code> and <code>draw_pixel</code> exist as raster operations because some devices may provide them as primitives. But we now see other functions like <code>move_pixels</code> and <code>write_text</code> (which differs from <code>print</code> because it writes text at a specific pixel location, not at the “current cursor position”) and these are meant to expose other primitives of the device.</p><p>Having done this, I added a new <code>GraphicsConsole</code> type that encapsulates the logic to implement a terminal backed by an arbitrary graphical display, and then relies on a specific implementation of the <code>RasterOps</code> trait to do the screen manipulation:</p><pre><code><code>impl<RO> Console for GraphicsConsole<RO>
where
RO: RasterOps,
{
// ... implement Console in terms of RasterOps ...
}</code></code></pre><p>Most details of this refactor are uninteresting at this point, except for the fact that it eliminated all of the tricky duplicate code between the SDL2 and HTML canvas variants. A side-effect was that these changes increased my confidence in the HTML canvas variant because most code was now unit-tested indirectly via the SDL2 implementation. Here is how the simplification looked like:</p><pre><code><code>$ wc -l {before,after}/sdl/src/host.rs {before,after}/web/src/canvas.rs
1245 before/sdl/src/host.rs
887 after/sdl/src/host.rs     # 358 fewer lines
760 before/web/src/canvas.rs
444 after/web/src/canvas.rs   # 320 fewer lines</code></code></pre><p>I was now ready to reuse the <code>GraphicsConsole</code> to quickly provide a new backend on top of the LCD.</p><h1>Playing with the C interface</h1><p>With the foundational abstractions in place, it was time to prove that my idea of rendering the EndBASIC console on the tiny LCD was <s>feasible</s> cool enough to pursue. But I knew absolutely nothing about the LCD so, before diving right into the “correct” implementation, I had to create a prototype to get used to its API.</p><p>Fortunately, I found an “SDK”—and I put it in quotes because SDK is quite an overstatement—for the LCD somewhere online. The SDK consists of a pair of C and Python libraries that provide basic graphics drawing primitives, text rendering, and access to the D-pad and the buttons. This was a “perfect” finding because the code was simple enough to understand, functional enough to build a prototype, and allowed me to skip reading through the data sheet.</p><p>So I chose to do the easiest thing: I folded the C library into EndBASIC using Rust’s C FFI and quickly implemented a <code>RasterOps</code> on it. With that, I could instantiate a <code>GraphicsConsole</code> backed by the LCD and demonstrate, in just a couple of hours before the crack of dawn, that the idea was feasible. And it was more than feasible: it was super-exciting! Here, witness the very first results:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"413e7dc0-ef87-4c65-acb9-ebe4475e2128\",\"duration\":null}\"></div><p><em>(Caption: First prototype of the EndBASIC console on the ST7735s LCD display, reusing the vendor-provided C library from Rust with lots of hacks.)</em></p><p>But performance was also awful. Using the C library was enough to show that this idea was cool and worth pursuing, but it was not the best path forward. On the one hand, the code in the C library was rather crappy and fragile to integrate into Rust via <code>build.rs</code>; and, on the other hand, I needed precise control of the hardware primitives to achieve good rendering performance levels.</p><h1>The LCD hardware interface</h1><p>Before diving into the solution, let’s take a quick peek at the hardware interface of the LCD. Note that this is just a very simplified picture of what the LCD offers and is derived from my reverse-engineering of the code in the SDK. I’m sure there is more to it, but I do not have the drive to go through the aforementioned data sheet.</p><p>The LCD is a matrix of pixels where each position contains an integer representing the color of the pixel. The representation of each color value depends on the selected pixel format, but what the SDK uses by default is RGB565: a 16-bit value decomposed into two 5-bit quantities for red and blue and one 6-bit quantity for green.</p><p>This is pretty standard stuff for a framebuffer-style device but the mechanism to write to the LCD is different. Unlike most framebuffer devices backed by video cards, the LCD matrix is not memory-mapped: we have to issue specific reads and writes via the GPIO and SPI busses. The GPIO bus is used to control hardware registers and the SPI bus is used to transfer large data sequences.</p><p>Simplifying, the LCD offers just two primitives. The first is a “set window” operation to define the window for rendering. This tells the LCD what rectangular region to update with new pixel values on the <em>subsequent</em> “set data” operation. Executing this operation requires a GPIO write to select the operation followed by an SPI write to set the window position and dimensions.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":37047,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88bfe275-2b1e-481d-8615-50d6e2c36f63_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set window\" operation.</figcaption></figure></div><p>The second is a “set data” primitive to set the contents of the previously-defined window. This primitive just sends a stream of pixel color values that will be written on the window, top-left to bottom-right. Executing this operation requires a GPIO write to select the operation followed by a “very large” SPI write to write the pixel data.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":35405,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F63afffa0-967b-49d1-b0d2-5e002f561a59_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of an LCD's \"set data\" operation.</figcaption></figure></div><p>By default, SPI writes on Linux are limited to 4KB in size and the full LCD content is 128x128 pixels * 2 bytes per pixel = 32KB, which means drawing the whole LCD requires 8 separate SPI writes. (It is possible to raise the default via a kernel setting, which I did too, but let’s ignore that for now.)</p><p>Understanding that the LCD hardware interface is as simple and constrained as this is super-important to devise an efficient higher-level API, which is what we are going to do next.</p><h1>Double-buffering</h1><p>Having figured out the native interface, I faced two problems.</p><p>The first one was performance. Issuing individual “set window” and “set data” commands works great to draw on large portions of the LCD, but sending these commands on a pixel basis as would be necessary to render letters or shapes like circles would be prohibitively slow.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"f1cb62fe-e6b1-40e8-86b6-43c2a43855db\",\"duration\":null}\"></div><p><em>(Caption: An EndBASIC demo program bouncing a bunch of rectangles on the screen running with the prototype console driver that relied on the C library without double-buffering or damage tracking.)</em></p><p>The second one was the inability to <em>read</em> the contents of the LCD. Certain operations of the console, like moving the cursor or entering/exiting the builtin editor, require saving portions of the screen aside for later restoration. The LCD does not offer an interface to read what it currently displays. (Actually I don’t know because I did not read the data sheet… but even if it does, the reads would involve slow SPI bus traffic which we should avoid.)</p><p>To address these two problems, I decided to implement double-buffering for the LCD: the console driver reserves a portion of main memory to track the content of the LCD and all operations that update the LCD first write to this buffer. This allows the code to decide <em>when</em> to send the buffer to the LCD, allowing it to compose complex patterns in memory—e.g. plotting letters pixel by pixel—before ever touching the GPIO and SPI busses. And this also allows trivially reading portions of the LCD.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\" width=\"760\" height=\"400\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":400,\"width\":760,\"resizeWidth\":null,\"bytes\":43655,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1f8ae93a-819e-4fab-9089-00c106aa3a7d_760x400.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Representation of the double-buffering and damage tracking techniques.</figcaption></figure></div><p>Which brings me to the next point. Part of this solution required adding damage tracking as well. Flushing the full in-memory buffer to the LCD is expensive—remember, with the default SPI configuration, we need to issue 8 separate writes to flush 32KB of data—and many times, like when moving the cursor around in the editor, this is not necessary. Therefore, it is important to keep track of the portion of the display that has been “damaged” by drawing operations and then only flush that portion of the buffer to the LCD. This maps perfectly well to the hardware primitives offered by the LCD.</p><p>With that in mind, and after a bit of iteration, I ended up splitting the implementation of the LCD <code>RasterOps</code> into two pieces. One is the <code>Lcd</code> trait, which exposes the basic “set window” and “set data” primitives of an LCD as a single <code>set_data</code> operation:</p><pre><code><code>trait Lcd {
fn set_data(&mut self, x1y1: LcdXY, x2y2: LcdXY, data: &[u8])
-> io::Result<()>;

// ... some more stuff ...
}</code></code></pre><p>The other is the <code>BufferedLcd</code> type, which implements the general idea of buffering and damage tracking on top of a generic <code>Lcd</code>:</p><pre><code><code>impl<L> RasterOps for BufferedLcd<L>
where
L: Lcd,
{
// ... implementation of RasterOps in terms of an Lcd ...
}</code></code></pre><p>This design keeps all of the complex logic in one place and, as was the case with the <code>Console</code> abstraction, allowed me to unit-test the tricky corner cases of the double-buffering and damage tracking by supplying a test-only <code>Lcd</code> implementation. This was critical during development because I wrote most of this code while I was on a trip without access to the device, and when I came back home, the “real thing” worked on the first try.</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"0ccbf21e-29b2-408b-925c-8bf44056a91b\",\"duration\":null}\"></div><p><em>(Caption: Same EndBASIC demo program as before but running with the improved console that implements double-buffering and damage tracking. No more flickering.)</em></p><p>Invest in Rust and exhaustive unit testing! They really are worth it to deliver working software quickly. But I digress…</p><h1>Font rendering</h1><p>The last interesting part of the puzzle was rendering text. You see: for the previous graphical consoles I wrote based on SDL2 and the HTML <code>canvas</code> element, I was able to use <a href=\"https://www.ibm.com/plex/\">a nice TTF font</a>. But with the LCD… well, the LCD has no builtin mechanism to render text and the very restrictive 128x128 resolution means that most fonts would render poorly at small sizes anyway.</p><p>To solve this problem, I had to implement my own text rendering code, which sounds scary at first but isn’t as hard as it sounds. One issue was coming up with the font data, but the SDK for the LCD came with a free reusable 5x8 font that I took over. Another issue was coming up with a mechanism to efficiently render the letters because plotting them pixel by pixel on the LCD would be unfeasible, but this was solved by the previous buffering and damage tracking techniques.</p><p>Having my own font rendering code is interesting. If you used a BASIC machine back in the 1980s, the computer-supplied manual would show you the glyphs used by the machine like this page demonstrates:</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\" width=\"600\" height=\"840\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":840,\"width\":600,\"resizeWidth\":null,\"bytes\":240982,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":true,\"topImage\":false,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6e1b5c4f-122e-40d9-8282-5c21babeac4b_600x840.png 1456w\" sizes=\"100vw\" loading=\"lazy\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a><figcaption class=\"image-caption\">Page 9 of Chapter 7 of the Amstrad CPC 6128 user manual showing the glyphs corresponding to characters 32–48.</figcaption></figure></div><p>In some machines like the Amstrad CPC 6128, you could use the <code>SYMBOL</code> command to define your own glyphs. And in some others, you could <code>POKE</code> the memory locations where the glyphs were stored to (re)define them. So I’m thinking that… maybe I should forget about the TTF font and instead expose a custom bitmap font in all EndBASIC consoles to allow for these neat tricks.</p><h1>Putting it all together</h1><p>And that’s all folks! Having gone through all the pieces involved in providing support for the LCD, we can now connect them all. Here is how the code on the <code>main</code> branch looks like with additional inline commentary:</p><pre><code><code>// Instantiate access to the GPIO bus, required to control the LCD and
// to read the status of the D-pad and buttons.
let mut gpio = Gpio::new().map_err(gpio_error_to_io_error)?;
// Build the struct used to interface with the LCD.
let lcd = ST7735SLcd::new(&mut gpio)?;
// Wrap the low-level LCD with the double-buffering and damage tracking
// features for high speed.
let lcd = BufferedLcd::new(lcd);
// Instantiate the input controller. I haven't covered this in the post
// because it's uninteresting.
let input = ST7735SInput::new(&mut gpio, signals_tx)?;
// Wrap the display and the buttons with the generic graphical console
// logic -- the same one used by the SDL2 and HTML canvas variants.
let inner = GraphicsConsole::new(input, lcd)?;</code></code></pre><p>Even though this looks complex, this composition of three different types keeps the responsibilities of each layer separate. The layers help make the logic simpler to understand, allow the possibility of supporting more LCDs with ease, and make unit-testing a reality. And thanks to Rust’s static dispatch, the overhead of the separate types is minimal.</p><p>Witness the finished result:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"67579827-636e-4903-9d43-307ffdba5dcb\",\"duration\":null}\"></div><p><em>(Caption: EndBASIC running the snake game on the Raspberry Pi with the ST7735s console, showing the final graphics support as well as interaction with the physical buttons.)</em></p><h1>Build your own Developer Kit</h1><p>Does the above sound cool? Do you want to play with it? Here are the parts you’ll need to build you own:</p><ul><li><p><strong><a href=\"https://www.amazon.com/ELEMENT-Element14-Raspberry-Pi-Motherboard/dp/B07BDR5PDW?&linkCode=ll1&tag=blogsystem5-20&linkId=cab45a45b3e43934d489486d416be7a0&language=en_US&ref_=as_li_ss_tl\">Raspberry Pi 3 B+</a>:</strong> I suppose a newer model will work but I don’t have one to try it out; let me know if it does! I also have my eyes on the <a href=\"https://www.amazon.com/gp/product/B074P6BNGZ?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=1f5bdad0f78d4512685cda89db5c6d87&language=en_US&ref_=as_li_ss_tl\">Libre Computer Board - Le Potato</a>, but if you go this route, know that it will <em>definitely</em> require extra work in EndBASIC to be functional. Hardware donations welcome if you want me to give it a try 😉.</p></li><li><p><strong><a href=\"https://www.amazon.com/CanaKit-Raspberry-Supply-Adapter-Listed/dp/B00MARDJZ4?&linkCode=ll1&tag=blogsystem5-20&linkId=ef82e298644b68298cd9bf5559b74aaa&language=en_US&ref_=as_li_ss_tl\">CanaKit 5V 2.5A Power Supply</a>:</strong> Yes, the Raspberry Pi is USB-powered but you need a lot of power for it to run properly—particularly if you are going to attach any USB devices like hard disks. Don’t skimp on the power supply. This is the one I have and works well.</p></li><li><p><strong><a href=\"https://www.amazon.com/PNY-Elite-microSDHC-Memory-P-SDU32GU185GW-GE/dp/B07R8GVGN9?th=1&linkCode=ll1&tag=blogsystem5-20&linkId=33a25c49f236d8bd6e8f2259a6c57148&language=en_US&ref_=as_li_ss_tl\">PNY 32GB microSD card</a>:</strong> Buy any microSD card you like. The SD bay is incredibly slow no matter what and 32GB should be plenty for experimentation.</p></li><li><p><strong><a href=\"https://www.amazon.com/gp/product/B077Z7DWW1?ie=UTF8&psc=1&linkCode=ll1&tag=&linkId=7a97236b22ca32377d308871eedde6fc&language=en_US&ref_=as_li_ss_tl\">waveshare 1.44inch LCD Display HAT 128x128</a>:</strong> The star product of this whole article! You may find other LCD hats and I’m sure they can be made to work, but they’ll require code changes. Hopefully the abstractions I implemented make it easy to support other hats, but I can’t tell yet. Again, hardware donations welcome if you want to keep me busy 😉.</p></li></ul><p>Once you have those pieces, get either Raspbian or Ubuntu, flash the image to the microSD, and boot the machine. After that, you have to build and run EndBASIC from unreleased sources until I release 0.11:</p><pre><code><code>$ cargo install --git=https://github.com/endbasic/endbasic.git --features=rpi
$ ~/.cargo/bin/endbasic --console=st7735s</code></code></pre><p>I know, I know, this is all quite convoluted. You have to manually go through the process of setting up Linux, then installing Rust, and then building EndBASIC from source. All of this is super-slow too.</p><p>Which means… what I want to do next is to build a complete “Developer Kit”, including a lightweight prebuilt SD image that gives you access to EndBASIC out of the box in just a few seconds. Right now I’m playing with downsizing a NetBSD/evbarm build so that the machine can boot quickly and, once I have that ready, I’ll have to port EndBASIC’s hardware-specific features to work on it. I don’t think I’ll postpone 0.11 until this is done, but we’ll see.</p><p>Interested in any of this? Please leave a note! And if you have tried the above at all with your own hardware, post your story too!</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Thanks for reading and please take a little moment to subscribe to Blog System/5.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substack-post-media.s3.amazonaws.com/public/images/b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "b77e068f-0409-43c7-b7bd-8f9cece5b9a5_4032x3024.jpeg" "0.0" "image/jpeg") nil "70085cf750085cf7b46e4b84984f6c7a") (3 (26569 31003 196978 743000) "https://blogsystem5.substack.com/p/how-new-type-helps-avoid-production" "How \"new type\" helps avoid production outages" "Julio Merino" "Sat, 09 Mar 2024 18:00:20 +0000" "<p>My <a href=\"https://blogsystem5.substack.com/p/links-january-2024-edition\">January links recap</a> included the <a href=\"https://experimentalworks.net/posts/2024-01-22-simple-phantom-types/\">“Phantom Types”</a> article by David Soria Parra. In it, the author briefly touches upon the “new type” idiom, its typical implementation in Rust, and then proceeds to propose a better alternative. But the question arises: why should you care?</p><p>To answer why this idiom is useful, I want to present you with a real production problem we faced in the Storage Infrastructure team at Google circa 2010. That issue made me a convert and I’ve kept it in mind when designing APIs since then.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\" width=\"1456\" height=\"1456\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/c8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1456,\"width\":1456,\"resizeWidth\":null,\"bytes\":552435,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><h1>What is “new type” anyway?</h1><p>The <a href=\"https://rust-unofficial.github.io/patterns/patterns/behavioural/newtype.html\">“new type” idiom</a> is a programming pattern whereby you define domain-specific types to wrap native types. Then, you use those types in your code and only “lower” them to their underlying types when passing the values to any external APIs.</p><p>More specifically, your public interfaces—but also private methods and functions—should never receive primitive types like integers or strings. A function like <code>allow_write(username: String, size: usize)</code> should not exist in your code base.</p><p>Instead, what you’d do is define two new types, <code>Username</code> and <code>Size</code>, that wrap the string and integer values. These types are trivial wrappers over the native types (e.g. <code>struct Username(String)</code> and <code>struct Size(usize)</code>) with the goal of making them zero-cost abstractions.</p><p>However, as David’s article describes, this simplistic way to implement the pattern lends itself to code duplication for every type. And, as you know, code duplication leads to slight inconsistencies over time, which may increase maintenance costs.</p><p>But this is not relevant now. “New type” is “new type” no matter how you implement it and no matter which language you choose. What I want to showcase here is <em>why</em> adopting this pattern helps at all. And, for that, it’s time to dive into the story.</p><h1>Quota management outage</h1><p>Back in the early days of the Storage Infrastructure at Google, we the SRE team managed tens of shared file system deployments (aka <em>cells</em>). Those file systems were multi-user and had support for quotas—like pretty much any file system worthy of consideration.</p><p>Storage quotas are typically expressed as two quantities: a <em>bytes quota</em>, which says how much disk space a user can use; and a <em>files quota</em>, which says how many files a user can store. Tracking byte usage limits disk usage and tracking file usage limits metadata overhead.</p><p>Now, even with the replicated and zonal system that Google had, it was convenient to <em>manage</em> user quotas in a centralized way. So that’s what we also had: the equivalent of a MySQL database tracking how much quota each user had allocated in which cell, world-wide.</p><p>So far so good. But how do you keep the decentralized storage cells decoupled from the quota database? Easy! Via a cron job that reads the quotas and pushes them to cluster-local “configuration” files so that each cell doesn’t need to know about the central database.</p><p>Of course, this cron job is code. And code has bugs. So here is what happened: there was some function somewhere that looked like this: <code>set_quota(user: String, bytes: usize, files: usize)</code>. And, for whatever reason, a caller invoked it as <code>set_quota(user, files, bytes)</code>.</p><p>Notice the problem? The caller swapped the arguments but the language did not flag this issue and… the tests didn’t catch it either! It’s unfortunately too common for people to write the same sentinel values (<code>set_quota(\"foo\", 100, 100)</code>) for different test arguments.</p><p>Soon after this change was checked in, the code rolled out to production and… of course, the moment it touched the first canary deployment, things went south. Users started receiving out of quota alerts even when they should have had, in theory, plenty of available quota.</p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Subscribe to Blog System/5 to not miss out on any future stories. It’s completely free!</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div><h1>The aftermath</h1><p>The fix to the above was trivial: swap the arguments in the problematic caller and call it a day. But that’s a naïve fix. It just corrects the immediate problem but does not minimize the chances of it happening again. That is: this change is a <em>mitigation</em>, not a <em>fix</em>.</p><p>In good SRE fashion, the team went a bit further to prevent this issue from ever recurring. They adopted the “new type” pattern, created two separate types—<code>BytesQuota</code> and <code>FilesQuota</code>—and plumbed them through the whole program. And note: Rust wasn’t really a thing in 2010.</p><p>Furthermore, the team contributed an entry to the <a href=\"https://testing.googleblog.com/2007/01/introducing-testing-on-toilet.html\">Testing on the Toilet blog</a>, describing the issue and how this same problem had <em>just</em> bitten a major financial company and had made them lose millions of dollars.</p><p>And that’s the simple story of the day. Please adopt the new type pattern! Future-you will be happy that you did when the compiler or language interpreter yells at you about something that’s obviously wrong.</p><p><em>(<a href=\"https://twitter.com/jmmv/status/1766522609314017598\">Originally published as a Twitter thread.</a>)</em></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc8b706f6-f435-469c-a6a0-e1d27e893730_1536x1536.jpeg" "0.0" "image/jpeg") nil "087b9d5370660485d2ddcb5c1bb7da44") (2 (26569 31003 196367 731000) "https://blogsystem5.substack.com/p/links-february-2024-edition" "Links: February 2024 edition" "Julio Merino" "Thu, 29 Feb 2024 16:01:03 +0000" "<p>Hi folks! Another month has passed so it’s time for a brief recap of the main news, articles, and projects that made the rounds during this period and are on topic for Blog System/5.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg\" width=\"1456\" height=\"1048\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":1048,\"width\":1456,\"resizeWidth\":null,\"bytes\":243606,\"alt\":null,\"title\":null,\"type\":\"image/jpeg\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>As usual, this is not just a list: every entry is accompanied by a short blurb detailing why I found the content interesting, which is meant to nudge you into reading it! Also, the list is ordered by when the links made it my way, not chronologically, and some items are <em>not</em> from this time period.</p><p>Let’s get to it.</p><h1>The links</h1><p><strong><a href=\"https://theretroweb.com/\">“The Retro Web”</a></strong></p><p>An impressive database of old hardware with tons of details about motherboards, processors, chipsets, hard disks… Even more impressive, but not unexpectedly, is that this is entirely maintained by volunteers. Be careful to not get lost.</p><div><hr></div><p><strong><a href=\"https://developers.redhat.com/blog/2021/01/05/building-red-hat-enterprise-linux-9-for-the-x86-64-v2-microarchitecture-level#\">“Building Red Hat Enterprise Linux 9 for the x86-64-v2 microarchitecture level”</a></strong><br><em>By Florian Weimer on January 5th, 2021</em></p><p>The <a href=\"https://news.ycombinator.com/item?id=39250609\">Hacker News thread</a> discussing the <a href=\"https://www.gentoo.org/news/2024/02/04/x86-64-v3.html\">“Gentoo x86-64-v3 binary packages available”</a> article made me wonder what exactly the <code>v3</code> suffix after the <code>x86-64</code> architecture name was about. Fortunately, a helpful reply from <code>dtech</code> pointed to this other article that explains where these version suffixes came from.</p><div><hr></div><p><strong><a href=\"https://www.abortretry.fail/p/the-berkley-software-distribution\">“The Berkley Software Distribution”</a></strong><br><em>By Bradford Morgan White on February 4th, 2024</em></p><p>Unix has a long story and, if you are interested in it at all, this is a great piece describing how BSD came to be. Most of the text is focused on the pre-FreeBSD and pre-NetBSD days though, so we are talking about some really old history here!</p><div><hr></div><p><strong><a href=\"https://blogsystem5.substack.com/p/beyond-the-1-mb-barrier-in-dos\">“Beyond the 1 MB barrier in DOS”</a></strong><br><em>By yours truly on February 7th, 2024</em></p><p>Last month, I gave you a detailed explanation of how DOS applications pulled <a href=\"https://blogsystem5.substack.com/p/from-0-to-1-mb-in-dos\">all sorts of tricks</a> to maximize the usage of the first MB of the 80286+ address space. In this one, I continue the exploration to see how some DOS apps (particularly games) broke free from those limitations and moved into external memory.</p><p>For a richer discussion, you can see the coverage in <a href=\"https://www.osnews.com/story/138541/beyond-the-1-mb-barrier-in-dos/\">OSNews</a> and <a href=\"https://hackaday.com/2024/02/09/breaking-through-the-1-mb-barrier-in-dos-with-unreal-mode-and-more/\">Hackaday</a> among the other usual places. That said, it looks like I pretty much drained the pool of people interested in this topic: the discussions are pretty quiet on this second post and the number of subscribers to Blog System/5 got a bump, but a small one.</p><div><hr></div><p><strong><a href=\"https://cep.dev/posts/every-infrastructure-decision-i-endorse-or-regret-after-4-years-running-infrastructure-at-a-startup/\">\"(Almost) Every infrastructure decision I endorse or regret after 4 years running infrastructure at a startup\"</a></strong><br><em>By Jack Lindamood on February 1st, 2024</em></p><p>Good reflections on the technical decisions made at a start up and how they turned up after four years. We need more of these sorts of introspective posts: many times, people in tech make decisions, stick around for a year or two, and then leave for <s>greener pastures</s> higher comp without witnessing the impact that their choices had long-term. I’ve seen this play out repeatedly and… I’m probably at fault too.</p><div><hr></div><p><strong><a href=\"https://spectrum.ieee.org/lean-software-development\">“A 2024 plea for lean software”</a></strong><br><em>By Bert Hubert on February 8th, 2024</em></p><p>It is easy to dunk on the bloat of modern software—and you <em>should</em> dunk on it because the current state of affairs is <em>terrible</em>—but this article takes an interesting look at the problem by focusing on security. Or, rather, lack thereof… because the massive amounts of code we have to run even for the simplest tasks leave us open to unpredictable security holes.</p><div><hr></div><p><strong><a href=\"https://ounapuu.ee/posts/2024/02/12/fosdem-2024/\">“FOSDEM 2024: my experience, some notes and tech tips”</a></strong><br><em>By Herman Õunapuu on February 12th, 2024</em></p><p>Very detailed trip report to FOSDEM from a first timer. It’s really long but it’ll make you feel like you missed out for not going. A lot of the advice in it <a href=\"https://jmmv.dev/2020/02/fosdem-navigation-101.html\">matches what I wrote</a> back in 2020 during my first (and only so far) time there as well.</p><div><hr></div><p><strong><a href=\"https://chimera-linux.org/\">“Chimera Linux”</a></strong></p><p>This Linux distribution sounds very appealing because it is very non-conformant—no glibc, GCC nor systemd—and leverages core system components from FreeBSD. A tweet from @unixterminal shows <a href=\"https://twitter.com/unixterminal/status/1756782019663606070\">how to set it up under WSL</a>, which means it’s super-easy to test-run it if you happen to be on Windows. I haven’t tried yet, but if you have some time, there goes an idea.</p><div><hr></div><p><strong><a href=\"https://antithesis.com/blog/is_something_bugging_you/\">“Is something bugging you?”</a></strong><br><em>By Will Wilson on February 13th, 2024</em></p><p>I’m a believer in automated and comprehensive testing. I often hear that you should <em>not</em> write tests for short-lived projects or during quick initial growth—and I think such advice is just plain wrong. Tests <em>do</em> slow you down at the very beginning of a greenfield project, but they pay dividends after just two weeks of full-time coding.</p><p>This article describes how the creators of FoundationDB reached the same conclusion because they developed and leveraged a solid infrastructure to run their software in a reproducible manner. They, in turn, turned this idea into a product—which means that the article is an ad, but it won’t feel like it. Promise.</p><div><hr></div><p><strong><a href=\"https://blog.jgc.org/2024/02/the-original-www-proposal-is-word-for.html\">“The original WWW proposal is a Word for Macintosh 4.0 file from 1990, can we open it?”</a></strong><br><em>By John Graham-Cumming on February 13th, 2024</em></p><p>An interesting story in trying to open an old document from 1990 and render it in its original format. Contemporary tools like LibreOffice or Word are still able to open it, but they don’t load diagrams properly.</p><p>This is why I <a href=\"https://jmmv.dev/2016/01/medium-experiment-wrapup.html\">made the choice</a> a long time ago to avoid Blogger and Medium and, even if you are now reading this in Substack, why I still author the originals in Markdown and store them in a Git repository.</p><div><hr></div><p><strong><a href=\"https://blogsystem5.substack.com/p/running-gnu-on-dos-with-djgpp\">“Running GNU on DOS with DJGPP”</a></strong><br><em>By yours truly on February 14th, 2024</em></p><p>Following up on the earlier two articles describing how DOS apps managed memory and dealt with the limitations of real mode, I was finally able to write about how DJGPP achieves those goals <em>and also</em> makes GNU programs run on DOS. If you picture DJGPP as the “WSL for DOS”… you aren’t too far off. Mind you, the article will show you bash running on DOS, but the content is primarily about the internals on how DJ achieved such feat.</p><div><hr></div><p><strong><a href=\"https://github.com/Speykious/cve-rs\">“cve-rs: Blazingly 🔥 fast 🚀 memory vulnerabilities, written in 100% safe Rust”</a></strong><br><em>By Speykious on February 15th, 2024</em></p><p>Big news everyone! Rust is finally able to replace C and C++ because, thanks to this little library, you can now implement memory vulnerabilities too! Don’t miss out on the new GLWTSPL license either, which you’ll have to assess for compatibility with your own before you can incorporate the code.</p><div><hr></div><p><strong><a href=\"https://blogsystem5.substack.com/p/to-c-or-not-to-c\">“To C or not to C”</a></strong><br><em>By yours truly on February 21st, 2024</em></p><p>An article disguised as a Twitter thread where I joined the ongoing <s>discussion</s> argument in the platform on whether knowing C is a prerequisite for being called a “good programmer”. Spoiler alert: it is <em>not</em>, but what C teaches you is very useful no matter what language you use.</p><div><hr></div><p><strong><a href=\"https://twitter.com/awesomekling/status/1761305126604550496\">“Ladybird browser can load VSCode”</a></strong><br><em>By Andreas Kling on February 24th, 2024</em></p><p>This is not an article but a mere comment from Andreas showing how the <a href=\"https://ladybird.dev/\">Ladybird</a> browser, a from-scratch implementation of the web, can now load VSCode. Most of it doesn’t work, but some does.</p><p>The reason I find this interesting is that it shows how much a small group of motivated developers can achieve in a short amount of time. “Nobody” believed that it was possible to implement a modern web browser from scratch in this day and age… and Ladybird is proving that wrong. Back in my time in the Bazel team, I always said that Bazel’s demise would be a motivated grad student with lots of free time creating a truly open and small build system written in a systems language. The reason I believe this is possible is that I almost had that going on years before Bazel even existed… but I lacked the expertise to push it forward. Check out <a href=\"https://jmmv.dev/2022/05/remembering-buildtool.html\">the Buildtool rememberance article</a> for context.</p><div><hr></div><p><strong><a href=\"https://freebsdfoundation.org/blog/the-january-february-2024-issue-of-the-freebsd-journal-is-here/\">“The January/February 2024 Issue of the FreeBSD Journal is Here!”</a></strong><br><em>On February 28th, 2024</em></p><p>This is fresh off the press so I haven’t had a chance to read through it yet (other than for the opening Foundation Letter). However, I still hold FreeBSD and NetBSD close to my heart and felt that this deserves a shout out. In particular because the content is now free and they dropped that weird web/mobile app they were using in favor of publishing directly as HTML and PDF.</p><p>Maybe someday I’ll have time to go back to contributing to the BSDs… but I do have some exciting news coming up about ATF and Kyua. Stay tuned.</p><h1>Parting words</h1><p>And that’s all for this month. I know the list is shorter this time around, in part because the noise around AI has eclipsed everything else and in part because I do want to focus on other projects. I’m happy to have picked up EndBASIC again and some goodies are coming up soon:</p><div class=\"native-video-embed\" data-component-name=\"VideoPlaceholder\" data-attrs=\"{\"mediaUploadId\":\"387e9749-acca-4a51-a9c4-4f79e857546e\",\"duration\":null}\"></div><p>(See <a href=\"https://twitter.com/jmmv/status/1762305223891267627\">original tweet</a> where I posted the video.)</p><p>But don’t worry. Anything that comes up from this work will definitely deserve some article in Blog System/5. So don’t forget to subscribe and have fun reading all of the above!</p><p class=\"button-wrapper\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe now\",\"action\":null,\"class\":null}\" data-component-name=\"ButtonCreateButton\"><a class=\"button primary\" href=\"https://blogsystem5.substack.com/subscribe?\"><span>Subscribe now</span></a></p>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4d497879-8ebb-4208-b029-91639ce53e03_1456x1048.jpeg" "0.0" "image/jpeg") nil "6b22c8f70bd2e4b1dd7a1000c883a845") (1 (26569 31003 195542 561000) "https://blogsystem5.substack.com/p/to-c-or-not-to-c" "To C or not to C" "Julio Merino" "Wed, 21 Feb 2024 14:01:55 +0000" "<p>Over the last few days, there has been this… debate over at Twitter sparked by a claim that you cannot be a good programmer without knowing C. You obviously can be one, but there is some nuance in what “knowing” C is truly about. Here is my take on the matter.</p><div class=\"captioned-image-container\"><figure><a class=\"image-link image2 is-viewable-img\" target=\"_blank\" href=\"https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png\" data-component-name=\"Image2ToDOM\"><div class=\"image2-inset\"><picture><source type=\"image/webp\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 1456w\" sizes=\"100vw\"><img src=\"https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png\" width=\"809\" height=\"582\" data-attrs=\"{\"src\":\"https://substack-post-media.s3.amazonaws.com/public/images/05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png\",\"srcNoWatermark\":null,\"fullscreen\":null,\"imageSize\":null,\"height\":582,\"width\":809,\"resizeWidth\":null,\"bytes\":326255,\"alt\":null,\"title\":null,\"type\":\"image/png\",\"href\":null,\"belowTheFold\":false,\"topImage\":true,\"internalRedirect\":null,\"isProcessing\":false}\" class=\"sizing-normal\" alt=\"\" srcset=\"https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png 1456w\" sizes=\"100vw\" fetchpriority=\"high\"></picture><div class=\"image-link-expand\"><div class=\"pencraft pc-display-flex pc-gap-8 pc-reset\"><div class=\"pencraft pc-reset icon-container restack-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-refresh-cw\"><path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"></path><path d=\"M21 3v5h-5\"></path><path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"></path><path d=\"M8 16H3v5\"></path></svg></div><div class=\"pencraft pc-reset icon-container view-image\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-maximize2\"><polyline points=\"15 3 21 3 21 9\"></polyline><polyline points=\"9 21 3 21 3 15\"></polyline><line x1=\"21\" x2=\"14\" y1=\"3\" y2=\"10\"></line><line x1=\"3\" x2=\"10\" y1=\"21\" y2=\"14\"></line></svg></div></div></div></div></a></figure></div><p>Let me repeat this first: of course you can be a perfectly good programmer without knowing C. Knowing <em>a language</em> doesn’t make or break a programmer, and there are great programmers out there that don’t touch C. <em>However</em>, knowing C says something about your <em>journey</em>.</p><p>If you know C well, it means you’ve dealt with pointers and managed memory by hand. It probably also means you know the difference between system calls and library calls. And it might also mean that you know about FFI. Let’s look at this trinity and why these are important.</p><div><hr></div><p><strong>🧠 First, memory.</strong> When learning C, you must deal with pointers, <code>malloc</code>, and <code>free</code>, and you must learn how these are put to use. You also may learn how to debug a segfault and probably use tools like Valgrind to find memory errors.</p><p>None of this is trivial. Saying that “a pointer is just a memory address; what’s difficult in that!?” misses the point (get it?). Knowing what a thing <em>is</em> is really different from knowing how to <em>use</em> that thing. I covered something similar back in <a href=\"https://jmmv.dev/2020/04/rust-into-trait.html\">my post about Rust’s Into trait</a>.</p><p>But more importantly, pointers and memory management are not a “C thing”. These concepts show up in pretty much <em>any</em> language. For example, both Java and Python differentiate primitive types from objects… and, guess what, object references are essentially pointers.</p><p>Without knowing pointers, it’s hard to reason about pass-by-value vs. pass-by-reference semantics. Without knowing memory management, you can’t easily tell whether your code makes a reasonable use of memory.</p><div><hr></div><p><strong>📣 Second, system calls vs. library functions.</strong> For example, how do <code>read</code> and <code>fread</code> differ? They are <em>not</em> the same thing and using them interchangeably can lead to performance problems. Reading bytes one by one with <code>read</code> is very inefficient but isn’t with <code>fread</code>.</p><p>When learning C, you often have to read manpages because they are the primary source of documentation for the C APIs. In doing so, you probably have noticed that certain manpages are in section 2 (system calls) and others are in section 3 (library functions).</p><p>Every language must issue system calls but not all languages expose them as clearly as C does. The distinction exists in higher level but it is more subtle. If you aren’t careful, you can introduce performance problems like the one in <a href=\"https://jmmv.dev/2019/03/optimizing-tree-deletions.html\">my post on deleting directory hierarchies</a>.</p><div><hr></div><p><strong>⚙️ Third, the Foreign Function Interface (FFI).</strong> Almost every language in your system has to end up calling into the C library to execute system calls. If you have learned C, you have probably also learned about stack frames and how a binary (ELF or whatnot) is put together.</p><p>This knowledge is useful because, as I said, every language—except for the stubborn Go—has to talk to C for certain operations. And this interface <a href=\"https://jmmv.dev/2023/12/strings-encodings-nuls-and-bazel.html\">isn’t always zero cost</a>. Knowing the costs helps write more efficient code.</p><div><hr></div><p>💡 So there they are. The three major topics that you are likely familiar with just by knowing C well. Of course you can be a good programmer without knowing these topics deeply, but being familiar with these will help you engineer better systems.</p><p>Paraphrasing Joel Spolksy’s article titled <a href=\"https://www.joelonsoftware.com/2005/12/29/the-perils-of-javaschools-2/\">“The perils of JavaSchools”</a> from 2005: there are only two types of programmers: those that know pointers (and recursion), and those that don’t.</p><p>This aligns with my experience after interviewing 100+ candidates: there is a stark contrast between those that don’t known anything about memory management and those that do. I couldn’t care less about what language you choose, but I want to see if you know how things work.</p><p>Because, remember: these three topics have nothing to do with C per se: they are concepts that apply to almost any language. For example, you also deal with memory in Rust via <code>Box</code>, but a <code>Box</code> is more opaque than explicit <code>malloc</code> and <code>free</code> calls.</p><p>So: don’t be worried if you don’t know C, but also don’t be afraid to learn it! Just, please, don’t use it to start any new project. Keep C to yourself as a learning exercise, or leverage it as a tool to deal with legacy codebases.</p><p><em>This was originally <a href=\"https://twitter.com/jmmv/status/1760298856506622386\">published as a Twitter thread</a> because that’s the context in which the discussion took place.</em></p><div class=\"subscription-widget-wrap-editor\" data-attrs=\"{\"url\":\"https://blogsystem5.substack.com/subscribe?\",\"text\":\"Subscribe\",\"language\":\"en\"}\" data-component-name=\"SubscribeWidgetToDOM\"><div class=\"subscription-widget show-subscribe\"><div class=\"preamble\"><p class=\"cta-caption\">Blog System/5 is a reader-supported publication. To receive new posts and support my work, consider becoming a subscriber or <a href=\"https://twitter.com/jmmv\">follow me on Twitter at @jmmv</a>.</p></div><form class=\"subscription-widget-subscribe\"><input type=\"email\" class=\"email-input\" name=\"email\" placeholder=\"Type your email…\" tabindex=\"-1\"><input type=\"submit\" class=\"button primary\" value=\"Subscribe\"><div class=\"fake-input-wrapper\"><div class=\"fake-input\"></div><div class=\"fake-button\"></div></div></form></div></div>" ("https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png" "https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F05b8fa7c-e7e6-4948-baac-8fe5af1b300d_809x582.png" "0.0" "image/jpeg") nil "9ef85e92e83ee82b5ba918add7c770d2")))